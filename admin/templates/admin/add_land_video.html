{% extends 'admin/base_admin.html' %}

{% block title %}افزودن کلیپ آگهی{% endblock %}

{% block content %}
<div class="min-h-[100vh] bg-gray-50 dark:bg-gray-900">

  <!-- هدر سبک دیوار -->
  <header class="sticky top-0 z-30 bg-white/95 dark:bg-gray-900/95 border-b border-gray-200 dark:border-gray-800 backdrop-blur">
    <div class="max-w-4xl mx-auto flex items-center justify-between h-14 px-3 sm:px-4">
      <a href="{{ url_for('admin.lands') }}"
         class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200"
         aria-label="بازگشت به لیست آگهی‌ها">
        <i class="fa-solid fa-arrow-right text-sm"></i>
      </a>
      <div class="flex flex-col items-center gap-0.5">
        <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">مرحله ۲ از ۲</span>
        <h1 class="text-sm font-bold text-gray-900 dark:text-white">افزودن کلیپ برای آگهی</h1>
      </div>
      <div class="w-9"></div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-3 sm:px-4 pt-4 pb-24">
    <!-- کارت خلاصه آگهی - شبیه دیوار -->
    <section class="mb-4">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-3 sm:p-4 flex gap-3">
        <div class="w-24 h-24 rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-800 shrink-0 flex items-center justify-center">
          {% set _imgs = land.images if land.images is iterable else ([land.images] if land.images else []) %}
          {% set _cover = (_imgs[0] if _imgs and _imgs|length > 0 else None) %}
          {% if _cover %}
            {% set _is_abs = '://' in (_cover|string) %}
            <img src="{{ _cover if _is_abs else (('/uploads/' + _cover) if not (_cover|string).startswith('/uploads/') else _cover) }}"
                 alt="تصویر {{ land.title or 'ملک' }}"
                 class="w-full h-full object-cover">
          {% else %}
            <i class="fa-regular fa-image text-gray-300 text-3xl"></i>
          {% endif %}
        </div>
        <div class="flex-1 flex flex-col justify-between">
          <div>
            <h2 class="text-sm font-semibold text-gray-900 dark:text-gray-100 line-clamp-2 mb-1">
              {{ land.title or 'بدون عنوان' }}
            </h2>
            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-[11px] text-gray-500 dark:text-gray-400">
              {% if land.location %}
              <span class="flex items-center gap-1">
                <i class="fa-solid fa-map-marker-alt text-[9px]"></i>
                {{ land.location }}
              </span>
              {% endif %}
              {% if land.size %}
              <span class="flex items-center gap-1">
                <i class="fa-solid fa-ruler-combined text-[9px]"></i>
                {{ land.size }} متر
              </span>
              {% endif %}
              {% if land.code %}
              <span class="flex items-center gap-1">
                <i class="fa-solid fa-hashtag text-[9px]"></i>
                کد {{ land.code }}
              </span>
              {% endif %}
            </div>
          </div>

          <p class="mt-2 text-[11px] text-gray-500 dark:text-gray-400">
            افزودن کلیپ به نمایش بهتر آگهی و جذب مشتری بیشتر کمک می‌کند. این مرحله اختیاری است.
          </p>
        </div>
      </div>
    </section>

    <!-- کارت آپلود کلیپ - استایل دیوار -->
    <section>
      <form id="mainVideoForm" method="POST" enctype="multipart/form-data" class="space-y-4">
        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}

        {% if land.video %}
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-3 sm:p-4 mb-3">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xs font-semibold text-gray-800 dark:text-gray-100">کلیپ فعلی آگهی</h2>
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-50 dark:bg-blue-900/40 text-[10px] text-blue-700 dark:text-blue-200">
              <i class="fa-solid fa-circle-play text-[9px]"></i> در حال نمایش
            </span>
          </div>
          <video controls class="w-full rounded-xl border border-gray-200 dark:border-gray-800 bg-black max-h-64">
            <source src="{{ url_for('static', filename=land.video) if land.video.startswith('uploads/') else land.video }}" type="video/mp4">
            مرورگر شما از پخش ویدیو پشتیبانی نمی‌کند.
          </video>
        </div>
        {% endif %}

        <div class="bg-white dark:bg-gray-900 border border-dashed border-blue-300 dark:border-blue-700 rounded-2xl p-5 sm:p-6 text-center">
          <div class="flex flex-col items-center gap-3">
            <div class="w-14 h-14 rounded-full bg-blue-50 dark:bg-blue-900/40 flex items-center justify-center text-blue-600 dark:text-blue-300">
              <i class="fa-solid fa-video text-lg"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-1">
                کلیپ آگهی را انتخاب کنید
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                حداکثر چند ده ثانیه، فرمت‌های پیشنهادی: MP4, WebM, MOV
              </p>
            </div>

            <label class="mt-2 inline-flex items-center justify-center px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white text-xs sm:text-sm font-semibold cursor-pointer">
              <i class="fa-solid fa-cloud-arrow-up ml-1"></i>
              انتخاب فایل ویدیو
              <input type="file" name="video" accept="video/*" class="hidden" onchange="previewVideo(event)">
            </label>

            <div id="video-preview-container" class="w-full mt-4 hidden">
              <video id="video-preview" controls class="w-full rounded-xl border border-gray-200 dark:border-gray-800 bg-black max-h-64"></video>
              <button type="button"
                      onclick="removeVideo()"
                      class="mt-2 inline-flex items-center gap-1 text-[11px] text-red-600 hover:text-red-700">
                <i class="fa-solid fa-times"></i>
                حذف کلیپ انتخاب‌شده
              </button>
            </div>
          </div>
        </div>
      </form>
    </section>
  </main>

  <!-- نوار اکشن پایین صفحه - ثابت مانند دیوار -->
  <footer class="fixed inset-x-0 bottom-0 z-30 bg-white/95 dark:bg-gray-900/95 border-t border-gray-200 dark:border-gray-800 backdrop-blur">
    <div class="max-w-4xl mx-auto px-3 sm:px-4 py-2.5 flex items-center justify-between gap-2">
      <form id="skipVideoForm" method="POST" class="flex-1" enctype="multipart/form-data">
        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}
        <input type="hidden" name="skip" value="1">
        <button type="submit"
                class="w-full text-[11px] sm:text-xs text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white text-left">
          بعداً کلیپ را اضافه می‌کنم
        </button>
      </form>

      <button type="submit"
              form="mainVideoForm"
              class="inline-flex items-center justify-center px-4 sm:px-5 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white text-xs sm:text-sm font-semibold">
        <i class="fa-solid fa-check ml-1"></i>
        ذخیره و ادامه
      </button>
    </div>
  </footer>
</div>
{% endblock %}

{% block scripts %}
<script>
  function previewVideo(event) {
    const file = event.target.files[0];
    const container = document.getElementById('video-preview-container');
    const preview = document.getElementById('video-preview');
    if (file) {
      const url = URL.createObjectURL(file);
      preview.src = url;
      container.classList.remove('hidden');
    }
  }

  function removeVideo() {
    const fileInput = document.querySelector('input[name="video"]');
    const container = document.getElementById('video-preview-container');
    const preview = document.getElementById('video-preview');
    if (fileInput) fileInput.value = '';
    if (preview) preview.src = '';
    if (container) container.classList.add('hidden');
  }
</script>
{% endblock %}

