{% extends 'admin/base_admin.html' %}

{% block head %}
  {{ super() }}
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <style>
    /* مخفی کردن هدر و فوتر در صفحه ثبت آگهی */
    header,
    nav[class*="fixed bottom-0"],
    aside[class*="fixed"],
    div[class*="lg:hidden h-16"] {
      display: none !important;
    }
    /* تنظیم padding برای main content */
    main {
      padding-top: 0 !important;
    }
    main > div {
      padding-top: 1rem !important;
    }
  </style>
{% endblock %}

{% block title %}افزودن آگهی اکسپرس{% endblock %}
{% block page_title %}افزودن آگهی اکسپرس{% endblock %}

{% block content %}
<div class="space-y-4">
  
  <!-- Stepper ساده - سبک دیوار -->
  <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-3">
    <div class="flex items-center justify-between text-xs">
      <div class="flex items-center gap-2">
        <span id="step1-indicator" class="w-6 h-6 grid place-items-center rounded-full bg-blue-600 text-white text-xs font-medium">1</span>
        <span class="hidden sm:inline text-gray-700 dark:text-gray-300">اطلاعات</span>
      </div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700 mx-2"></div>
      <div class="flex items-center gap-2">
        <span id="step2-indicator" class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs">2</span>
        <span class="hidden sm:inline text-gray-700 dark:text-gray-300">تصاویر</span>
      </div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700 mx-2"></div>
      <div class="flex items-center gap-2">
        <span id="step3-indicator" class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs">3</span>
        <span class="hidden sm:inline text-gray-700 dark:text-gray-300">مدارک</span>
      </div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700 mx-2"></div>
      <div class="flex items-center gap-2">
        <span id="step4-indicator" class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs">4</span>
        <span class="hidden sm:inline text-gray-700 dark:text-gray-300">بررسی</span>
      </div>
    </div>
  </div>

  <!-- فرم مرحله‌ای -->
  <form method="POST" enctype="multipart/form-data" action="{{ url_for('admin.add_express_listing') }}" class="space-y-4" id="expressForm" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <!-- مرحله 1: اطلاعات اصلی -->
    <div id="step1" class="step-content">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-4">
        <h2 class="text-base font-semibold text-gray-900 dark:text-white">
          اطلاعات اصلی
        </h2>
        
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              عنوان آگهی <span class="text-red-500">*</span>
            </label>
            <input type="text" name="title" required 
                   class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="مثال: زمین باغی 1000 متری">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              موقعیت <span class="text-red-500">*</span>
            </label>
            <input type="text" name="location" required 
                   class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="مثال: دشت اول، گرمابسرد">
          </div>

          <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-3">
            <div class="flex items-center justify-between mb-3">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                موقعیت دقیق (مختصات جغرافیایی)
              </label>
              <button type="button" id="getCurrentLocationBtn" 
                      class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium transition">
                <i class="fas fa-crosshairs"></i>
                موقعیت فعلی
              </button>
            </div>
            
            <!-- نقشه -->
            <div id="locationMap" class="w-full h-64 rounded-lg border border-gray-200 dark:border-gray-700 mb-3" style="z-index: 1;"></div>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">عرض جغرافیایی (Latitude)</label>
                <input type="number" step="0.000001" name="latitude" id="latitude"
                       class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="مثال: 35.6892">
              </div>
              <div>
                <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">طول جغرافیایی (Longitude)</label>
                <input type="number" step="0.000001" name="longitude" id="longitude"
                       class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="مثال: 51.3890">
              </div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
              روی نقشه کلیک کنید یا از دکمه "موقعیت فعلی" استفاده کنید
            </p>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                متراژ (متر) <span class="text-red-500">*</span>
              </label>
              <input type="text" name="size" required data-format-int
                     class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="1000">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                دسته‌بندی
              </label>
              <select name="category" 
                      class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">انتخاب کنید</option>
                <option value="زمین">زمین</option>
                <option value="باغ">باغ</option>
                <option value="ویلا">ویلا</option>
                <option value="آپارتمان">آپارتمان</option>
                <option value="تجاری">تجاری</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                قیمت کل (تومان) <span class="text-red-500">*</span>
              </label>
              <input type="text" name="price_total" required data-format-int
                     class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="2000000000">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                قیمت در متر (تومان)
                <span class="text-xs text-gray-500 dark:text-gray-400">(محاسبه خودکار)</span>
              </label>
              <input type="text" name="price_per_meter" id="price_per_meter" data-format-int readonly
                     class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200"
                     placeholder="--">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                درصد پورسانت (٪) <span class="text-red-500">*</span>
              </label>
              <input type="number" step="0.1" min="0" max="100" name="express_commission_pct" id="express_commission_pct" required
                     class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="1.5">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                مبلغ پورسانت (تومان)
              </label>
              <input type="text" id="express_commission_amount" readonly
                     class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200"
                     placeholder="--">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              توضیحات
            </label>
            <textarea name="description" rows="3" 
                      class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="توضیحات کامل..."></textarea>
          </div>

          <div class="flex items-center gap-2 pt-2">
            <input type="checkbox" name="auto_send_all_partners" value="1" id="auto_send" class="w-4 h-4" checked>
            <label for="auto_send" class="text-sm text-gray-700 dark:text-gray-300">ارسال خودکار برای تمامی همکاران</label>
          </div>
        </div>

        <div class="flex justify-end pt-2 border-t border-gray-200 dark:border-gray-700">
          <button type="button" onclick="nextStep()" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition focusable flex items-center gap-2">
            <span>ادامه</span>
            <i class="fa-solid fa-arrow-left text-xs"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- مرحله 2: تصاویر -->
    <div id="step2" class="step-content hidden">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-4">
        <h2 class="text-base font-semibold text-gray-900 dark:text-white">
          تصاویر ملک
        </h2>
        
        <div id="dropzone" role="button" tabindex="0"
             class="w-full h-24 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 flex flex-col items-center justify-center cursor-pointer hover:border-gray-400 dark:hover:border-gray-500 transition">
          <i class="fa-solid fa-cloud-arrow-up text-xl text-gray-400 dark:text-gray-500 mb-1"></i>
          <p class="text-xs font-medium text-gray-600 dark:text-gray-400">انتخاب تصاویر</p>
        </div>
        <input type="file" id="imagesInput" name="images" accept="image/*" multiple class="hidden">
        
        <div id="imagePreview" class="grid grid-cols-3 gap-2"></div>

        <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-800">
          <button type="button" onclick="prevStep()" 
                  class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
            <i class="fa-solid fa-arrow-right text-xs"></i>
            <span>قبلی</span>
          </button>
          <button type="button" onclick="nextStep()" 
                  class="px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
            <span>ادامه</span>
            <i class="fa-solid fa-arrow-left text-xs"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- مرحله 3: مدارک -->
    <div id="step3" class="step-content hidden">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-4">
        <h2 class="text-base font-semibold text-gray-900 dark:text-white">
          مدارک و تماس
        </h2>
        
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              سند ملک (PDF)
            </label>
            <input type="file" name="document_1" accept=".pdf,.jpg,.jpeg,.png" 
                   class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              مدارک اضافی (PDF)
            </label>
            <input type="file" name="document_2" accept=".pdf,.jpg,.jpeg,.png" 
                   class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              شماره تماس پشتیبانی <span class="text-red-500">*</span>
            </label>
            <input type="tel" name="vinor_contact" required 
                   class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   value="09121234567" placeholder="09121234567">
          </div>
        </div>

        <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700">
          <button type="button" onclick="prevStep()" 
                  class="px-4 py-2 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium transition focusable flex items-center gap-2">
            <i class="fa-solid fa-arrow-right text-xs"></i>
            <span>قبلی</span>
          </button>
          <button type="button" onclick="nextStep()" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition focusable flex items-center gap-2">
            <span>ادامه</span>
            <i class="fa-solid fa-arrow-left text-xs"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- مرحله 4: بررسی و انتشار -->
    <div id="step4" class="step-content hidden">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-4">
        <h2 class="text-base font-semibold text-gray-900 dark:text-white">
          بررسی نهایی
        </h2>
        
        <div class="space-y-3 text-sm">
          <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-3">
            <div class="font-medium mb-2">اطلاعات اصلی</div>
            <div class="space-y-1 text-gray-600 dark:text-gray-400">
              <div>عنوان: <span id="summaryTitle" class="font-medium text-gray-900 dark:text-white">-</span></div>
              <div>موقعیت: <span id="summaryLocation" class="font-medium text-gray-900 dark:text-white">-</span></div>
              <div>متراژ: <span id="summarySize" class="font-medium text-gray-900 dark:text-white">-</span> متر</div>
              <div>قیمت کل: <span id="summaryPrice" class="font-medium text-gray-900 dark:text-white">-</span></div>
              <div>قیمت در متر: <span id="summaryPricePerMeter" class="font-medium text-gray-900 dark:text-white">-</span></div>
              <div>درصد پورسانت: <span id="summaryCommissionPct" class="font-medium text-gray-900 dark:text-white">-</span></div>
              <div>مبلغ پورسانت: <span id="summaryCommissionAmount" class="font-medium text-gray-900 dark:text-white">-</span></div>
            </div>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-3">
            <div class="font-medium mb-2">تصاویر</div>
            <div id="summaryImages" class="text-gray-600 dark:text-gray-400">-</div>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-3">
            <div class="font-medium mb-2">مدارک</div>
            <div id="summaryDocuments" class="text-gray-600 dark:text-gray-400">-</div>
          </div>
        </div>

        <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700">
          <button type="button" onclick="prevStep()" 
                  class="px-4 py-2 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium transition focusable flex items-center gap-2">
            <i class="fa-solid fa-arrow-right text-xs"></i>
            <span>قبلی</span>
          </button>
          <button type="submit" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition focusable flex items-center gap-2">
            <i class="fa-solid fa-check text-xs"></i>
            <span>ثبت آگهی</span>
          </button>
        </div>
      </div>
    </div>

  </form>

</div>

<script>
let currentStep = 1;
const totalSteps = 4;
let selectedImages = [];

function showStep(step) {
  document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
  document.getElementById(`step${step}`).classList.remove('hidden');
  
  // Update indicators
  for (let i = 1; i <= 4; i++) {
    const indicator = document.getElementById(`step${i}-indicator`);
    if (i <= step) {
      indicator.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-400');
      indicator.classList.add('bg-blue-600', 'text-white');
    } else {
      indicator.classList.remove('bg-blue-600', 'text-white');
      indicator.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-400');
    }
  }
  
  currentStep = step;
  if (step === 4) updateSummary();
}

function nextStep() {
  if (currentStep < totalSteps) showStep(currentStep + 1);
}

function prevStep() {
  if (currentStep > 1) showStep(currentStep - 1);
}

// Image handling
document.getElementById('dropzone').addEventListener('click', () => {
  document.getElementById('imagesInput').click();
});

document.getElementById('imagesInput').addEventListener('change', (e) => {
  const files = Array.from(e.target.files);
  selectedImages = [...selectedImages, ...files].slice(0, 10);
  renderImagePreviews();
});

function renderImagePreviews() {
  const container = document.getElementById('imagePreview');
  container.innerHTML = '';
  
  selectedImages.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const div = document.createElement('div');
      div.className = 'relative group';
      div.innerHTML = `
        <img src="${e.target.result}" class="w-full h-20 object-cover rounded-lg">
        <button type="button" onclick="removeImage(${index})" 
                class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">
          ×
        </button>
      `;
      container.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}

function removeImage(index) {
  selectedImages.splice(index, 1);
  renderImagePreviews();
}

function updateSummary() {
  const form = document.getElementById('expressForm');
  
  document.getElementById('summaryTitle').textContent = document.querySelector('input[name="title"]')?.value.trim() || '-';
  document.getElementById('summaryLocation').textContent = document.querySelector('input[name="location"]')?.value.trim() || '-';
  
  // استخراج اعداد خام از فیلدها (از data-raw-value یا value)
  const sizeEl = document.querySelector('input[name="size"]');
  const priceEl = document.querySelector('input[name="price_total"]');
  const commissionPctEl = document.getElementById('express_commission_pct');
  
  // استخراج متراژ
  let sizeRaw = sizeEl?.dataset.rawValue || '';
  if (!sizeRaw || sizeRaw === '') {
    const sizeValue = sizeEl?.value || '';
    sizeRaw = sizeValue.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/[^\d]/g, '');
  }
  const sizeNum = parseInt(sizeRaw, 10) || 0;
  document.getElementById('summarySize').textContent = sizeNum > 0 ? sizeNum.toLocaleString('fa-IR') : '-';
  
  // استخراج قیمت کل
  let priceRaw = priceEl?.dataset.rawValue || '';
  if (!priceRaw || priceRaw === '') {
    const priceValue = priceEl?.value || '';
    priceRaw = priceValue.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/[^\d]/g, '');
  }
  const priceNum = parseInt(priceRaw, 10) || 0;
  document.getElementById('summaryPrice').textContent = priceNum > 0 ? priceNum.toLocaleString('fa-IR') + ' تومان' : '-';
  
  // محاسبه خودکار قیمت در متر
  let pricePerMeter = 0;
  if (sizeNum > 0 && priceNum > 0) {
    pricePerMeter = Math.round(priceNum / sizeNum);
  }
  const pricePerMeterInput = document.getElementById('price_per_meter');
  if (pricePerMeterInput) {
    // ذخیره مقدار خام در data attribute برای ارسال
    pricePerMeterInput.dataset.rawValue = pricePerMeter > 0 ? pricePerMeter.toString() : '';
    // نمایش فرمت شده به کاربر
    pricePerMeterInput.value = pricePerMeter > 0 ? pricePerMeter.toLocaleString('fa-IR') : '';
  }
  
  // نمایش در خلاصه
  const summaryPricePerMeter = document.getElementById('summaryPricePerMeter');
  if (summaryPricePerMeter) {
    summaryPricePerMeter.textContent = pricePerMeter > 0 ? pricePerMeter.toLocaleString('fa-IR') + ' تومان' : '-';
  }
  
  document.getElementById('summaryImages').textContent = selectedImages.length > 0 ? `${selectedImages.length} تصویر` : 'تصویری انتخاب نشده';
  
  const doc1 = document.querySelector('input[name="document_1"]')?.files?.[0];
  const doc2 = document.querySelector('input[name="document_2"]')?.files?.[0];
  const docs = [];
  if (doc1 && doc1.name) docs.push(doc1.name);
  if (doc2 && doc2.name) docs.push(doc2.name);
  document.getElementById('summaryDocuments').textContent = docs.length > 0 ? docs.join(', ') : 'مدرکی آپلود نشده';
  
  // محاسبه و نمایش پورسانت
  const pctValue = commissionPctEl?.value || '0';
  const pct = parseFloat(pctValue) || 0;
  let commissionAmount = 0;
  if (priceNum > 0 && pct > 0) {
    commissionAmount = Math.round(priceNum * (pct / 100));
  }
  
  // نمایش درصد پورسانت در خلاصه
  const summaryCommissionPct = document.getElementById('summaryCommissionPct');
  if (summaryCommissionPct) {
    summaryCommissionPct.textContent = pct > 0 ? pct + '%' : '-';
  }
  
  // نمایش مبلغ پورسانت در فیلد
  const amtInput = document.getElementById('express_commission_amount');
  if (amtInput) {
    amtInput.dataset.rawValue = commissionAmount > 0 ? commissionAmount.toString() : '';
    amtInput.value = commissionAmount > 0 ? commissionAmount.toLocaleString('fa-IR') : '';
  }
  
  // نمایش مبلغ پورسانت در خلاصه
  const summaryCommissionAmount = document.getElementById('summaryCommissionAmount');
  if (summaryCommissionAmount) {
    summaryCommissionAmount.textContent = commissionAmount > 0 ? commissionAmount.toLocaleString('fa-IR') + ' تومان' : '-';
  }
}

// Form validation
document.getElementById('expressForm').addEventListener('submit', (e) => {
  const title = document.querySelector('input[name="title"]').value.trim();
  const location = document.querySelector('input[name="location"]').value.trim();
  const sizeEl = document.querySelector('input[name="size"]');
  const priceEl = document.querySelector('input[name="price_total"]');
  
  // استخراج اعداد خام (اولویت با data-raw-value)
  let sizeRaw = sizeEl.dataset.rawValue;
  let priceRaw = priceEl.dataset.rawValue;
  
  // اگر data attribute وجود نداشت، از value استخراج کن
  if (!sizeRaw || sizeRaw === '') {
    const sizeValue = sizeEl.value || '';
    // تبدیل اعداد فارسی به انگلیسی
    sizeRaw = sizeValue.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/[^\d]/g, '');
  }
  if (!priceRaw || priceRaw === '') {
    const priceValue = priceEl.value || '';
    // تبدیل اعداد فارسی به انگلیسی
    priceRaw = priceValue.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/[^\d]/g, '');
  }
  
  // اعتبارسنجی
  if (!title || !location || !sizeRaw || !priceRaw) {
    e.preventDefault();
    alert('لطفاً فیلدهای اجباری را پر کنید');
    return;
  }
  
  const sizeNum = parseInt(sizeRaw, 10) || 0;
  const priceNum = parseInt(priceRaw, 10) || 0;
  
  if (sizeNum <= 0 || priceNum <= 0) {
    e.preventDefault();
    alert('متراژ و قیمت باید بیشتر از صفر باشند');
    return;
  }
  
  // قرار دادن اعداد خام قبل از ارسال (بدون فرمت)
  // مهم: باید مستقیماً value را تغییر دهیم تا در form submit شود
  sizeEl.value = sizeNum.toString();
  priceEl.value = priceNum.toString();
  
  // محاسبه نهایی قیمت در متر (قبل از ارسال)
  const pricePerMeterEl = document.getElementById('price_per_meter');
  if (pricePerMeterEl && sizeNum > 0 && priceNum > 0) {
    const ppm = Math.round(priceNum / sizeNum);
    pricePerMeterEl.value = ppm.toString();
    pricePerMeterEl.dataset.rawValue = ppm.toString();
  }
  
  // محاسبه نهایی مبلغ پورسانت (قبل از ارسال)
  const commissionPctEl = document.getElementById('express_commission_pct');
  const commissionAmountEl = document.getElementById('express_commission_amount');
  if (commissionPctEl && commissionAmountEl && priceNum > 0) {
    const pct = parseFloat(commissionPctEl.value || '0') || 0;
    if (pct > 0) {
      const amount = Math.round(priceNum * (pct / 100));
      commissionAmountEl.value = amount.toString();
      commissionAmountEl.dataset.rawValue = amount.toString();
    } else {
      commissionAmountEl.value = '';
      commissionAmountEl.dataset.rawValue = '';
    }
  }
});

// Initialize
showStep(1);

// نقشه تعاملی برای انتخاب موقعیت
let locationMap = null;
let locationMarker = null;

function initLocationMap() {
  // مختصات پیش‌فرض: تهران
  const defaultLat = 35.6892;
  const defaultLon = 51.3890;
  
  // بررسی اگر مختصات از قبل وجود دارد
  const latInput = document.getElementById('latitude');
  const lonInput = document.getElementById('longitude');
  let initialLat = defaultLat;
  let initialLon = defaultLon;
  
  if (latInput && latInput.value) {
    initialLat = parseFloat(latInput.value) || defaultLat;
  }
  if (lonInput && lonInput.value) {
    initialLon = parseFloat(lonInput.value) || defaultLon;
  }
  
  // ایجاد نقشه
  locationMap = L.map('locationMap').setView([initialLat, initialLon], 13);
  
  // افزودن لایه نقشه OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19
  }).addTo(locationMap);
  
  // افزودن مارکر اولیه
  if (latInput && latInput.value && lonInput && lonInput.value) {
    locationMarker = L.marker([initialLat, initialLon], {
      draggable: true
    }).addTo(locationMap);
  } else {
    locationMarker = L.marker([initialLat, initialLon], {
      draggable: true
    }).addTo(locationMap);
    updateCoordinates(initialLat, initialLon);
  }
  
  // رویداد کلیک روی نقشه
  locationMap.on('click', function(e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    
    if (locationMarker) {
      locationMarker.setLatLng([lat, lon]);
    } else {
      locationMarker = L.marker([lat, lon], {
        draggable: true
      }).addTo(locationMap);
    }
    
    updateCoordinates(lat, lon);
  });
  
  // رویداد drag مارکر
  locationMarker.on('dragend', function(e) {
    const lat = e.target.getLatLng().lat;
    const lon = e.target.getLatLng().lng;
    updateCoordinates(lat, lon);
  });
  
  // به‌روزرسانی مختصات هنگام تغییر دستی در فیلدها
  latInput?.addEventListener('change', function() {
    const lat = parseFloat(this.value);
    const lon = parseFloat(lonInput?.value) || initialLon;
    if (!isNaN(lat) && !isNaN(lon)) {
      if (locationMarker) {
        locationMarker.setLatLng([lat, lon]);
        locationMap.setView([lat, lon], locationMap.getZoom());
      }
    }
  });
  
  lonInput?.addEventListener('change', function() {
    const lat = parseFloat(latInput?.value) || initialLat;
    const lon = parseFloat(this.value);
    if (!isNaN(lat) && !isNaN(lon)) {
      if (locationMarker) {
        locationMarker.setLatLng([lat, lon]);
        locationMap.setView([lat, lon], locationMap.getZoom());
      }
    }
  });
}

function updateCoordinates(lat, lon) {
  const latInput = document.getElementById('latitude');
  const lonInput = document.getElementById('longitude');
  
  if (latInput) {
    latInput.value = lat.toFixed(6);
  }
  if (lonInput) {
    lonInput.value = lon.toFixed(6);
  }
}

// دریافت موقعیت فعلی دستگاه
document.getElementById('getCurrentLocationBtn')?.addEventListener('click', function() {
  const btn = this;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال دریافت...';
  
  if (!navigator.geolocation) {
    alert('مرورگر شما از دریافت موقعیت جغرافیایی پشتیبانی نمی‌کند.');
    btn.disabled = false;
    btn.innerHTML = originalText;
    return;
  }
  
  navigator.geolocation.getCurrentPosition(
    function(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      
      if (locationMap && locationMarker) {
        locationMarker.setLatLng([lat, lon]);
        locationMap.setView([lat, lon], 15);
        updateCoordinates(lat, lon);
      } else if (locationMap) {
        locationMarker = L.marker([lat, lon], {
          draggable: true
        }).addTo(locationMap);
        locationMap.setView([lat, lon], 15);
        updateCoordinates(lat, lon);
        
        locationMarker.on('dragend', function(e) {
          const lat = e.target.getLatLng().lat;
          const lon = e.target.getLatLng().lng;
          updateCoordinates(lat, lon);
        });
      }
      
      btn.disabled = false;
      btn.innerHTML = originalText;
    },
    function(error) {
      let errorMsg = 'خطا در دریافت موقعیت: ';
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMsg += 'دسترسی به موقعیت جغرافیایی رد شد.';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMsg += 'اطلاعات موقعیت در دسترس نیست.';
          break;
        case error.TIMEOUT:
          errorMsg += 'زمان دریافت موقعیت به پایان رسید.';
          break;
        default:
          errorMsg += 'خطای ناشناخته.';
          break;
      }
      alert(errorMsg);
      btn.disabled = false;
      btn.innerHTML = originalText;
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
});

// راه‌اندازی نقشه پس از بارگذاری صفحه
let mapInitialized = false;
function initMapIfNeeded() {
  if (!mapInitialized && document.getElementById('locationMap') && typeof L !== 'undefined') {
    initLocationMap();
    mapInitialized = true;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // کمی تاخیر برای اطمینان از بارگذاری کامل Leaflet
  setTimeout(initMapIfNeeded, 500);
});

// راه‌اندازی نقشه هنگام نمایش مرحله 1
const originalShowStep = showStep;
showStep = function(step) {
  originalShowStep(step);
  if (step === 1) {
    setTimeout(initMapIfNeeded, 100);
  }
};

// Real-time calculations - محاسبه لحظه‌ای قیمت در متر و پورسانت
function setupRealTimeCalculations() {
  const sizeEl = document.querySelector('input[name="size"]');
  const priceEl = document.querySelector('input[name="price_total"]');
  const commissionPctEl = document.getElementById('express_commission_pct');
  
  // محاسبه قیمت در متر و پورسانت هنگام تغییر متراژ
  sizeEl?.addEventListener('input', () => {
    setTimeout(updateSummary, 100); // کمی تاخیر برای اطمینان از به‌روزرسانی data-raw-value
  });
  
  // محاسبه قیمت در متر و پورسانت هنگام تغییر قیمت کل
  priceEl?.addEventListener('input', () => {
    setTimeout(updateSummary, 100);
  });
  
  // محاسبه پورسانت هنگام تغییر درصد
  commissionPctEl?.addEventListener('input', () => {
    updateSummary();
  });
  
  // محاسبه هنگام blur (خروج از فیلد)
  sizeEl?.addEventListener('blur', updateSummary);
  priceEl?.addEventListener('blur', updateSummary);
}

setupRealTimeCalculations();

// Number formatting - فقط برای نمایش، مقدار خام در data attribute
(function(){
  function formatInt(v){
    const digits = String(v||'').replace(/[^\d]/g,'');
    if (!digits) return '';
    const n = parseInt(digits,10);
    return isNaN(n) ? '' : n.toLocaleString('fa-IR');
  }
  
  function parseNumber(str) {
    if (!str) return 0;
    // تبدیل اعداد فارسی به انگلیسی
    const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
    const englishDigits = '0123456789';
    let cleaned = String(str);
    for (let i = 0; i < persianDigits.length; i++) {
      cleaned = cleaned.replace(new RegExp(persianDigits[i], 'g'), englishDigits[i]);
    }
    // حذف همه کاراکترهای غیر عددی
    cleaned = cleaned.replace(/[^\d]/g, '');
    return parseInt(cleaned, 10) || 0;
  }
  
  function hook(el){
    // فقط اجازه ورود اعداد (انگلیسی و فارسی) و کلیدهای کنترل
    el.addEventListener('keydown', (e) => {
      const key = e.key;
      const isDigit = /[0-9۰-۹]/.test(key);
      const isControl = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter'].includes(key);
      const isModifier = e.ctrlKey || e.metaKey || e.altKey;
      
      if (!isDigit && !isControl && !isModifier) {
        e.preventDefault();
      }
    });
    
    // در هنگام تایپ: فقط اعداد را نگه دار، فرمت نکن
    el.addEventListener('input', (e) => {
      const raw = el.value || '';
      const digits = raw.replace(/[^\d۰-۹]/g, '');
      // تبدیل اعداد فارسی به انگلیسی برای ذخیره
      const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
      const englishDigits = '0123456789';
      let cleaned = digits;
      for (let i = 0; i < persianDigits.length; i++) {
        cleaned = cleaned.replace(new RegExp(persianDigits[i], 'g'), englishDigits[i]);
      }
      
      // ذخیره مقدار خام
      el.dataset.rawValue = cleaned;
      
      // نمایش همان چیزی که کاربر تایپ کرده (بدون فرمت در حین تایپ)
      el.value = digits;
      
      updateSummary();
    });
    
    // فقط هنگام blur فرمت کن
    el.addEventListener('blur', () => {
      const num = parseNumber(el.value);
      el.dataset.rawValue = num.toString();
      if (num > 0) {
        el.value = formatInt(num.toString());
      } else {
        el.value = '';
        el.dataset.rawValue = '';
      }
      updateSummary();
    });
  }
  document.querySelectorAll('[data-format-int]').forEach(hook);
})();
</script>
{% endblock %}

