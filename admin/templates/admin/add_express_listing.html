{% extends 'admin/base_admin.html' %}

{% block head %}
  {{ super() }}
  <meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block title %}افزودن آگهی اکسپرس{% endblock %}
{% block page_title %}افزودن آگهی اکسپرس{% endblock %}

{% block content %}
<div class="space-y-4">
  
  <!-- Stepper ساده -->
  <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-3">
    <div class="flex items-center justify-between text-xs">
      <div class="flex items-center gap-2">
        <span id="step1-indicator" class="w-6 h-6 grid place-items-center rounded-full bg-violet-600 text-white text-xs font-medium">1</span>
        <span class="hidden sm:inline">اطلاعات</span>
      </div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700 mx-2"></div>
      <div class="flex items-center gap-2">
        <span id="step2-indicator" class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs">2</span>
        <span class="hidden sm:inline">تصاویر</span>
      </div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700 mx-2"></div>
      <div class="flex items-center gap-2">
        <span id="step3-indicator" class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs">3</span>
        <span class="hidden sm:inline">مدارک</span>
      </div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700 mx-2"></div>
      <div class="flex items-center gap-2">
        <span id="step4-indicator" class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs">4</span>
        <span class="hidden sm:inline">بررسی</span>
      </div>
    </div>
  </div>

  <!-- فرم مرحله‌ای -->
  <form method="POST" enctype="multipart/form-data" action="{{ url_for('admin.add_express_listing') }}" class="space-y-4" id="expressForm" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <!-- مرحله 1: اطلاعات اصلی -->
    <div id="step1" class="step-content">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-4 space-y-4">
        <h2 class="text-base font-semibold text-gray-900 dark:text-white flex items-center gap-2">
          <i class="fa-solid fa-info-circle text-violet-600"></i>
          اطلاعات اصلی
        </h2>
        
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              عنوان آگهی <span class="text-red-500">*</span>
            </label>
            <input type="text" name="title" required 
                   class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                   placeholder="مثال: زمین باغی 1000 متری">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              موقعیت <span class="text-red-500">*</span>
            </label>
            <input type="text" name="location" required 
                   class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                   placeholder="مثال: دشت اول، گرمابسرد">
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                متراژ (متر) <span class="text-red-500">*</span>
              </label>
              <input type="text" name="size" required data-format-int
                     class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                     placeholder="1000">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                دسته‌بندی
              </label>
              <select name="category" 
                      class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                <option value="">انتخاب کنید</option>
                <option value="زمین">زمین</option>
                <option value="باغ">باغ</option>
                <option value="ویلا">ویلا</option>
                <option value="آپارتمان">آپارتمان</option>
                <option value="تجاری">تجاری</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                قیمت کل (تومان) <span class="text-red-500">*</span>
              </label>
              <input type="text" name="price_total" required data-format-int
                     class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                     placeholder="2000000000">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                قیمت در متر (تومان)
                <span class="text-xs text-gray-500 dark:text-gray-400">(محاسبه خودکار)</span>
              </label>
              <input type="text" name="price_per_meter" id="price_per_meter" data-format-int readonly
                     class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200"
                     placeholder="--">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                درصد پورسانت (٪)
              </label>
              <input type="number" step="0.1" min="0" max="100" name="express_commission_pct" id="express_commission_pct"
                     class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                     placeholder="1.5">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                مبلغ پورسانت (تومان)
              </label>
              <input type="text" id="express_commission_amount" readonly
                     class="w-full border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200"
                     placeholder="--">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              توضیحات
            </label>
            <textarea name="description" rows="3" 
                      class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                      placeholder="توضیحات کامل..."></textarea>
          </div>

          <div class="flex items-center gap-2 pt-2">
            <input type="checkbox" name="auto_send_all_partners" value="1" id="auto_send" class="w-4 h-4">
            <label for="auto_send" class="text-sm text-gray-700 dark:text-gray-300">ارسال خودکار برای تمامی همکاران</label>
          </div>
        </div>

        <div class="flex justify-end pt-2 border-t border-gray-200 dark:border-gray-800">
          <button type="button" onclick="nextStep()" 
                  class="px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
            <span>ادامه</span>
            <i class="fa-solid fa-arrow-left text-xs"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- مرحله 2: تصاویر -->
    <div id="step2" class="step-content hidden">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-4 space-y-4">
        <h2 class="text-base font-semibold text-gray-900 dark:text-white flex items-center gap-2">
          <i class="fa-solid fa-images text-violet-600"></i>
          تصاویر ملک
        </h2>
        
        <div id="dropzone" role="button" tabindex="0"
             class="w-full h-24 border-2 border-dashed border-violet-300 dark:border-violet-700 rounded-lg bg-violet-50 dark:bg-violet-900/20 flex flex-col items-center justify-center cursor-pointer hover:bg-violet-100 dark:hover:bg-violet-900/30 transition">
          <i class="fa-solid fa-cloud-arrow-up text-xl text-violet-600 mb-1"></i>
          <p class="text-xs font-medium text-gray-700 dark:text-gray-300">انتخاب تصاویر</p>
        </div>
        <input type="file" id="imagesInput" name="images" accept="image/*" multiple class="hidden">
        
        <div id="imagePreview" class="grid grid-cols-3 gap-2"></div>

        <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-800">
          <button type="button" onclick="prevStep()" 
                  class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
            <i class="fa-solid fa-arrow-right text-xs"></i>
            <span>قبلی</span>
          </button>
          <button type="button" onclick="nextStep()" 
                  class="px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
            <span>ادامه</span>
            <i class="fa-solid fa-arrow-left text-xs"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- مرحله 3: مدارک -->
    <div id="step3" class="step-content hidden">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-4 space-y-4">
        <h2 class="text-base font-semibold text-gray-900 dark:text-white flex items-center gap-2">
          <i class="fa-solid fa-file-pdf text-violet-600"></i>
          مدارک و تماس
        </h2>
        
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              سند ملک (PDF)
            </label>
            <input type="file" name="document_1" accept=".pdf,.jpg,.jpeg,.png" 
                   class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-sm">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              مدارک اضافی (PDF)
            </label>
            <input type="file" name="document_2" accept=".pdf,.jpg,.jpeg,.png" 
                   class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-sm">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              شماره تماس پشتیبانی <span class="text-red-500">*</span>
            </label>
            <input type="tel" name="vinor_contact" required 
                   class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                   value="09121234567" placeholder="09121234567">
          </div>
        </div>

        <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-800">
          <button type="button" onclick="prevStep()" 
                  class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
            <i class="fa-solid fa-arrow-right text-xs"></i>
            <span>قبلی</span>
          </button>
          <button type="button" onclick="nextStep()" 
                  class="px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
            <span>ادامه</span>
            <i class="fa-solid fa-arrow-left text-xs"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- مرحله 4: بررسی و انتشار -->
    <div id="step4" class="step-content hidden">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-4 space-y-4">
        <h2 class="text-base font-semibold text-gray-900 dark:text-white flex items-center gap-2">
          <i class="fa-solid fa-check-circle text-violet-600"></i>
          بررسی نهایی
        </h2>
        
        <div class="space-y-3 text-sm">
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
            <div class="font-medium mb-2">اطلاعات اصلی</div>
            <div class="space-y-1 text-gray-600 dark:text-gray-400">
              <div>عنوان: <span id="summaryTitle" class="font-medium text-gray-900 dark:text-white">-</span></div>
              <div>موقعیت: <span id="summaryLocation" class="font-medium text-gray-900 dark:text-white">-</span></div>
              <div>متراژ: <span id="summarySize" class="font-medium text-gray-900 dark:text-white">-</span> متر</div>
              <div>قیمت کل: <span id="summaryPrice" class="font-medium text-gray-900 dark:text-white">-</span></div>
              <div>قیمت در متر: <span id="summaryPricePerMeter" class="font-medium text-gray-900 dark:text-white">-</span></div>
            </div>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
            <div class="font-medium mb-2">تصاویر</div>
            <div id="summaryImages" class="text-gray-600 dark:text-gray-400">-</div>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
            <div class="font-medium mb-2">مدارک</div>
            <div id="summaryDocuments" class="text-gray-600 dark:text-gray-400">-</div>
          </div>
        </div>

        <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-800">
          <button type="button" onclick="prevStep()" 
                  class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
            <i class="fa-solid fa-arrow-right text-xs"></i>
            <span>قبلی</span>
          </button>
          <button type="submit" 
                  class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
            <i class="fa-solid fa-check text-xs"></i>
            <span>ثبت آگهی</span>
          </button>
        </div>
      </div>
    </div>

  </form>

</div>

<script>
let currentStep = 1;
const totalSteps = 4;
let selectedImages = [];

function showStep(step) {
  document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
  document.getElementById(`step${step}`).classList.remove('hidden');
  
  // Update indicators
  for (let i = 1; i <= 4; i++) {
    const indicator = document.getElementById(`step${i}-indicator`);
    if (i <= step) {
      indicator.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-400');
      indicator.classList.add('bg-violet-600', 'text-white');
    } else {
      indicator.classList.remove('bg-violet-600', 'text-white');
      indicator.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-400');
    }
  }
  
  currentStep = step;
  if (step === 4) updateSummary();
}

function nextStep() {
  if (currentStep < totalSteps) showStep(currentStep + 1);
}

function prevStep() {
  if (currentStep > 1) showStep(currentStep - 1);
}

// Image handling
document.getElementById('dropzone').addEventListener('click', () => {
  document.getElementById('imagesInput').click();
});

document.getElementById('imagesInput').addEventListener('change', (e) => {
  const files = Array.from(e.target.files);
  selectedImages = [...selectedImages, ...files].slice(0, 10);
  renderImagePreviews();
});

function renderImagePreviews() {
  const container = document.getElementById('imagePreview');
  container.innerHTML = '';
  
  selectedImages.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const div = document.createElement('div');
      div.className = 'relative group';
      div.innerHTML = `
        <img src="${e.target.result}" class="w-full h-20 object-cover rounded-lg">
        <button type="button" onclick="removeImage(${index})" 
                class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">
          ×
        </button>
      `;
      container.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}

function removeImage(index) {
  selectedImages.splice(index, 1);
  renderImagePreviews();
}

function updateSummary() {
  const form = document.getElementById('expressForm');
  const formData = new FormData(form);
  
  document.getElementById('summaryTitle').textContent = formData.get('title') || '-';
  document.getElementById('summaryLocation').textContent = formData.get('location') || '-';
  
  // محاسبه و نمایش متراژ
  const sizeRaw = formData.get('size') || '0';
  const sizeNum = parseInt(sizeRaw.replace(/[^\d]/g, ''), 10) || 0;
  document.getElementById('summarySize').textContent = sizeNum > 0 ? sizeNum.toLocaleString('fa-IR') : '-';
  
  // محاسبه و نمایش قیمت کل
  const priceRaw = formData.get('price_total') || '0';
  const priceNum = parseInt(priceRaw.replace(/[^\d]/g, ''), 10) || 0;
  document.getElementById('summaryPrice').textContent = priceNum > 0 ? priceNum.toLocaleString('fa-IR') + ' تومان' : '-';
  
  // محاسبه خودکار قیمت در متر
  let pricePerMeter = 0;
  if (sizeNum > 0 && priceNum > 0) {
    pricePerMeter = Math.round(priceNum / sizeNum);
  }
  const pricePerMeterInput = document.getElementById('price_per_meter');
  if (pricePerMeterInput) {
    // ذخیره مقدار خام در data attribute برای ارسال
    pricePerMeterInput.dataset.rawValue = pricePerMeter > 0 ? pricePerMeter.toString() : '';
    // نمایش فرمت شده به کاربر
    pricePerMeterInput.value = pricePerMeter > 0 ? pricePerMeter.toLocaleString('fa-IR') : '';
  }
  
  // نمایش در خلاصه
  const summaryPricePerMeter = document.getElementById('summaryPricePerMeter');
  if (summaryPricePerMeter) {
    summaryPricePerMeter.textContent = pricePerMeter > 0 ? pricePerMeter.toLocaleString('fa-IR') + ' تومان' : '-';
  }
  
  document.getElementById('summaryImages').textContent = selectedImages.length > 0 ? `${selectedImages.length} تصویر` : 'تصویری انتخاب نشده';
  
  const doc1 = formData.get('document_1');
  const doc2 = formData.get('document_2');
  const docs = [];
  if (doc1 && doc1.name) docs.push(doc1.name);
  if (doc2 && doc2.name) docs.push(doc2.name);
  document.getElementById('summaryDocuments').textContent = docs.length > 0 ? docs.join(', ') : 'مدرکی آپلود نشده';
  
  // محاسبه پورسانت
  const pct = parseFloat(formData.get('express_commission_pct') || '0') || 0;
  const amount = Math.round(priceNum * (pct / 100));
  const amtInput = document.getElementById('express_commission_amount');
  if (amtInput) amtInput.value = amount > 0 ? amount.toLocaleString('fa-IR') : '';
}

// Form validation
document.getElementById('expressForm').addEventListener('submit', (e) => {
  const title = document.querySelector('input[name="title"]').value.trim();
  const location = document.querySelector('input[name="location"]').value.trim();
  const sizeEl = document.querySelector('input[name="size"]');
  const priceEl = document.querySelector('input[name="price_total"]');
  
  // استخراج اعداد خام (از data attribute یا value)
  let sizeRaw = sizeEl.dataset.rawValue || (sizeEl.value || '').replace(/[^\d]/g, '');
  let priceRaw = priceEl.dataset.rawValue || (priceEl.value || '').replace(/[^\d]/g, '');
  
  // اگر data attribute وجود نداشت، از value استخراج کن
  if (!sizeRaw) sizeRaw = (sizeEl.value || '').replace(/[^\d]/g, '');
  if (!priceRaw) priceRaw = (priceEl.value || '').replace(/[^\d]/g, '');
  
  // اعتبارسنجی
  if (!title || !location || !sizeRaw || !priceRaw) {
    e.preventDefault();
    alert('لطفاً فیلدهای اجباری را پر کنید');
    return;
  }
  
  const sizeNum = parseInt(sizeRaw, 10) || 0;
  const priceNum = parseInt(priceRaw, 10) || 0;
  
  if (sizeNum <= 0 || priceNum <= 0) {
    e.preventDefault();
    alert('متراژ و قیمت باید بیشتر از صفر باشند');
    return;
  }
  
  // قرار دادن اعداد خام قبل از ارسال (بدون فرمت)
  // مهم: باید مستقیماً value را تغییر دهیم تا در form submit شود
  sizeEl.value = sizeNum.toString();
  priceEl.value = priceNum.toString();
  
  // محاسبه نهایی قیمت در متر
  const pricePerMeterEl = document.getElementById('price_per_meter');
  if (pricePerMeterEl) {
    const ppm = Math.round(priceNum / sizeNum);
    // پاک کردن فرمت از price_per_meter اگر وجود دارد
    pricePerMeterEl.value = ppm > 0 ? ppm.toString() : '';
  }
  
  // اطمینان از اینکه همه اعداد خام هستند (بدون فرمت)
  // استفاده از requestSubmit برای اطمینان از ارسال مقادیر به‌روز شده
  const form = document.getElementById('expressForm');
  if (form) {
    // یک بار دیگر مقادیر را تنظیم می‌کنیم
    sizeEl.value = sizeNum.toString();
    priceEl.value = priceNum.toString();
    if (pricePerMeterEl) {
      const ppm = Math.round(priceNum / sizeNum);
      pricePerMeterEl.value = ppm > 0 ? ppm.toString() : '';
    }
  }
});

// Initialize
showStep(1);

// Real-time calculations
document.getElementById('express_commission_pct')?.addEventListener('input', updateSummary);
document.querySelector('input[name="price_total"]')?.addEventListener('input', updateSummary);
document.querySelector('input[name="size"]')?.addEventListener('input', updateSummary);

// Number formatting - فقط برای نمایش، مقدار خام در data attribute
(function(){
  function formatInt(v){
    const digits = String(v||'').replace(/[^\d]/g,'');
    if (!digits) return '';
    const n = parseInt(digits,10);
    return isNaN(n) ? '' : n.toLocaleString('fa-IR');
  }
  function hook(el){
    const onInput = ()=>{
      const digits = String(el.value||'').replace(/[^\d]/g,'');
      const num = parseInt(digits,10) || 0;
      // ذخیره مقدار خام در data attribute
      el.dataset.rawValue = num.toString();
      // نمایش فرمت شده به کاربر
      if (num > 0) {
        el.value = formatInt(num.toString());
      } else {
        el.value = '';
        el.dataset.rawValue = '';
      }
      updateSummary();
    };
    el.addEventListener('input', onInput);
    el.addEventListener('blur', onInput);
  }
  document.querySelectorAll('[data-format-int]').forEach(hook);
})();
</script>
{% endblock %}

