{% extends 'admin/base_admin.html' %}
{% block content %}
<div class="max-w-3xl mx-auto px-4 py-4">
  <h1 class="text-lg font-bold mb-4">ارسال پیام به همکاران</h1>

  {% if message %}
    <div class="mb-3 p-3 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 text-emerald-800 dark:text-emerald-200 border border-emerald-200 dark:border-emerald-800">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="mb-3 p-3 rounded-lg bg-rose-50 dark:bg-rose-900/20 text-rose-800 dark:text-rose-200 border border-rose-200 dark:border-rose-800">{{ error }}</div>
  {% endif %}

  <!-- اطلاعات همکاران - سبک دیوار -->
  <div class="mb-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm font-semibold text-gray-900 dark:text-white">تعداد همکاران تایید شده</div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">این پیام به همه همکاران تایید شده ارسال می‌شود</div>
      </div>
      <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ partners_count or 0 }}</div>
    </div>
  </div>
  
  <!-- وضعیت پوش - سبک دیوار -->
  {% if push_diag %}
  <div class="mb-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">وضعیت پوش</h3>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
      <div class="flex items-center justify-between py-2 border-b sm:border-b-0 sm:border-r border-gray-100 dark:border-gray-800 sm:pr-3">
        <span class="text-xs text-gray-600 dark:text-gray-400">کلید عمومی</span>
        <span class="text-sm font-medium">{{ '✅' if push_diag.has_public else '❌' }}</span>
      </div>
      <div class="flex items-center justify-between py-2 border-b sm:border-b-0 sm:border-r border-gray-100 dark:border-gray-800 sm:pr-3">
        <span class="text-xs text-gray-600 dark:text-gray-400">کلید خصوصی</span>
        <span class="text-sm font-medium">{{ '✅' if push_diag.has_private else '❌' }}</span>
      </div>
      <div class="flex items-center justify-between py-2">
        <span class="text-xs text-gray-600 dark:text-gray-400">تعداد مشترک</span>
        <span class="text-sm font-bold text-gray-900 dark:text-white">{{ push_diag.subs_count or 0 }}</span>
      </div>
    </div>
    {% if not push_diag.has_private %}
      <div class="mt-3 text-xs text-amber-700 dark:text-amber-300 p-2 bg-amber-50 dark:bg-amber-900/20 rounded">
        کلید خصوصی VAPID تنظیم نشده؛ ارسال Web Push انجام نمی‌شود.
      </div>
    {% elif (push_diag.subs_count or 0) == 0 %}
      <div class="mt-3 text-xs text-amber-700 dark:text-amber-300 p-2 bg-amber-50 dark:bg-amber-900/20 rounded">
        هنوز مشترکی ثبت نشده است؛ از صفحهٔ «تست اعلان پوش» برای عضویت یک مرورگر اقدام کنید.
      </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- بخش تست سیستم اعلان‌ها -->
  <div class="mb-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <h2 class="text-base font-semibold text-gray-900 dark:text-white mb-4">
      <i class="fa-solid fa-vial"></i> تست سیستم اعلان‌ها
    </h2>
    
    {% if test_message %}
      <div class="mb-3 p-3 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 text-emerald-800 dark:text-emerald-200 border border-emerald-200 dark:border-emerald-800">{{ test_message }}</div>
    {% endif %}
    {% if test_error %}
      <div class="mb-3 p-3 rounded-lg bg-rose-50 dark:bg-rose-900/20 text-rose-800 dark:text-rose-200 border border-rose-200 dark:border-rose-800">{{ test_error }}</div>
    {% endif %}

    <!-- آمار کلی -->
    {% if stats %}
    <div class="mb-4 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-3">
      <h3 class="text-xs font-semibold text-gray-900 dark:text-white mb-2">آمار کلی</h3>
      <div class="grid grid-cols-3 gap-3 text-xs">
        <div>
          <div class="text-gray-600 dark:text-gray-400 mb-1">کاربران</div>
          <div class="text-sm font-bold text-gray-900 dark:text-white">{{ stats.total_users or 0 }}</div>
        </div>
        <div>
          <div class="text-gray-600 dark:text-gray-400 mb-1">کل اعلان‌ها</div>
          <div class="text-sm font-bold text-gray-900 dark:text-white">{{ stats.total_notifications or 0 }}</div>
        </div>
        <div>
          <div class="text-gray-600 dark:text-gray-400 mb-1">خوانده نشده</div>
          <div class="text-sm font-bold text-gray-900 dark:text-white">{{ stats.total_unread or 0 }}</div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- فرم تست -->
    <form method="post" class="space-y-3">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="test_action" value="test">
      <div>
        <label class="block text-sm font-medium text-gray-900 dark:text-white mb-1">شماره تلفن تست</label>
        <input 
          type="text" 
          name="test_phone" 
          class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600" 
          placeholder="09123456789" 
          required
        >
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">شماره تلفنی که می‌خواهید برای آن اعلان تست ارسال شود</p>
      </div>
      <div>
        <button 
          type="submit" 
          class="px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm font-medium hover:border-gray-300 dark:hover:border-gray-600 transition-colors"
        >
          اجرای تست
        </button>
      </div>
    </form>

    <!-- نتیجه تست -->
    {% if test_result %}
    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
      <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">نتیجه تست</h3>
      <div class="space-y-2 text-xs">
        <div class="flex items-center justify-between py-1.5 border-b border-gray-100 dark:border-gray-800">
          <span class="text-gray-600 dark:text-gray-400">شماره خام</span>
          <span class="font-medium text-gray-900 dark:text-white">{{ test_result.phone_raw }}</span>
        </div>
        <div class="flex items-center justify-between py-1.5 border-b border-gray-100 dark:border-gray-800">
          <span class="text-gray-600 dark:text-gray-400">شماره normalize شده</span>
          <span class="font-medium text-gray-900 dark:text-white font-mono">{{ test_result.phone_normalized }}</span>
        </div>
        <div class="flex items-center justify-between py-1.5 border-b border-gray-100 dark:border-gray-800">
          <span class="text-gray-600 dark:text-gray-400">شناسه اعلان</span>
          <span class="font-medium text-gray-900 dark:text-white font-mono">{{ test_result.notification_added or 'نامشخص' }}</span>
        </div>
        <div class="flex items-center justify-between py-1.5">
          <span class="text-gray-600 dark:text-gray-400">تعداد اعلان‌های پیدا شده</span>
          <span class="font-bold text-gray-900 dark:text-white">{{ test_result.notifications_found }}</span>
        </div>
        
        {% if test_result.all_keys_in_storage %}
        <div class="pt-2 mt-2 border-t border-gray-200 dark:border-gray-700">
          <span class="text-xs font-medium text-gray-900 dark:text-white block mb-1">کلیدهای موجود در storage</span>
          <div class="p-2 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
            <div class="text-xs font-mono text-gray-700 dark:text-gray-300 break-all">
              {{ test_result.all_keys_in_storage|join(', ') }}
            </div>
          </div>
        </div>
        {% endif %}

        {% if test_result.notifications_list %}
        <div class="pt-2 mt-2 border-t border-gray-200 dark:border-gray-700">
          <span class="text-xs font-medium text-gray-900 dark:text-white block mb-2">اعلان‌های پیدا شده</span>
          <div class="space-y-2">
            {% for notif in test_result.notifications_list %}
            <div class="p-2 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
              <div class="space-y-1 text-xs">
                <div class="flex items-center justify-between">
                  <span class="text-gray-600 dark:text-gray-400">عنوان:</span>
                  <span class="font-medium text-gray-900 dark:text-white">{{ notif.title }}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-600 dark:text-gray-400">خوانده شده:</span>
                  <span class="font-medium {{ 'text-green-600 dark:text-green-400' if notif.is_read else 'text-red-600 dark:text-red-400' }}">
                    {{ 'بله' if notif.is_read else 'خیر' }}
                  </span>
                </div>
                <div class="text-gray-700 dark:text-gray-300 mt-1">{{ notif.body }}</div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- فرم ارسال - سبک دیوار -->
  <form method="post" class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div>
      <label class="block text-sm font-medium text-gray-900 dark:text-white mb-1">عنوان پیام</label>
      <input type="text" name="title" class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600" placeholder="مثلاً اطلاعیه مهم" required>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-900 dark:text-white mb-1">متن پیام</label>
      <textarea name="body" rows="4" class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600" placeholder="متن پیام برای همکاران" required></textarea>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-900 dark:text-white mb-1">نوع اعلان</label>
      <select name="type" class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600">
        <option value="info">اطلاعات</option>
        <option value="success">موفقیت</option>
        <option value="warning">هشدار</option>
        <option value="error">خطا</option>
        <option value="status">وضعیت</option>
      </select>
    </div>
    <div class="flex items-center gap-2 pt-2">
      <button type="submit" class="px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm font-medium hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
        ارسال به همکاران
      </button>
      <a href="{{ url_for('admin.dashboard') }}" class="px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
        انصراف
      </a>
    </div>
  </form>
</div>
{% endblock %}

