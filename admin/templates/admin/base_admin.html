<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark" x-data="{ darkMode: localStorage.getItem('theme') === 'dark', menuOpen: false }" :class="{ 'dark': darkMode }">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>{% block title %}پنل مدیریت | وینور{% endblock %}</title>
  <meta name="theme-color" content="#2563EB" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="{{ url_for('admin.admin_manifest') }}" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="وینور ادمین" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome/css/all.min.css') }}" onerror="this.parentNode.removeChild(this)">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800;900&display=swap" rel="stylesheet" />

  <style>
    html, body { font-family: 'Vazirmatn', sans-serif; }
    .focusable:focus { outline: 2px solid #2563EB; outline-offset: 2px; }
    [x-cloak] { display: none !important; }
  </style>

  {% block head %}{% endblock %}
</head>
<body class="bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

  <!-- Header - Divar Style -->
  <header class="sticky top-0 z-40 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950">
    <div class="px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button @click="menuOpen = !menuOpen" 
                onclick="event.preventDefault(); event.stopPropagation();"
                class="lg:hidden focusable p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"
                aria-label="باز کردن منو">
          <i class="fa-solid fa-bars text-lg text-gray-600 dark:text-gray-400"></i>
        </button>
        <h1 class="text-base font-semibold text-gray-900 dark:text-white">
          {% block page_title %}پنل همکاران{% endblock %}
        </h1>
      </div>
      <div class="flex items-center gap-2">
        <button @click="darkMode = !darkMode; localStorage.setItem('theme', darkMode ? 'dark' : 'light')" 
                class="focusable p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400">
          <i class="fa-solid" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Menu Overlay -->
  <div x-show="menuOpen" 
       @click="menuOpen = false" 
       x-transition:enter="transition-opacity duration-200"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition-opacity duration-150"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0"
       class="fixed inset-0 z-40 bg-black/40 lg:hidden" 
       x-cloak
       style="display: none;"></div>

  <!-- Sidebar - Mobile Drawer -->
  <aside x-show="menuOpen"
         @click.away="menuOpen = false"
         x-transition:enter="transition-transform duration-200"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition-transform duration-150"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="translate-x-full"
         class="fixed top-0 right-0 h-full w-72 bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 z-50 lg:hidden overflow-y-auto" 
         x-cloak
         style="display: none; transform: translateX(100%);">
    {% include 'admin/partials/sidebar.html' %}
  </aside>

  <!-- Desktop Sidebar -->
  <aside class="hidden lg:block fixed top-0 right-0 h-full w-64 bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 z-30 overflow-y-auto">
    {% include 'admin/partials/sidebar.html' %}
  </aside>

  <!-- Main Content -->
  <main class="flex-1 lg:pr-64">
    <div class="px-4 py-6 max-w-7xl mx-auto">
      
      <!-- Flash Messages - Divar Style -->
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          <div class="mb-6 space-y-2">
            {% for category, msg in messages %}
              <div class="text-sm rounded-lg px-4 py-3 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 flex items-start gap-2
                          {% if category in ['success', 'ok'] %}
                            text-green-700 dark:text-green-400
                          {% elif category in ['warning'] %}
                            text-amber-700 dark:text-amber-400
                          {% elif category in ['info'] %}
                            text-blue-700 dark:text-blue-400
                          {% else %}
                            text-red-700 dark:text-red-400
                          {% endif %}">
                <i class="fa-solid mt-0.5 flex-shrink-0
                          {% if category in ['success', 'ok'] %}fa-check-circle
                          {% elif category in ['warning'] %}fa-exclamation-triangle
                          {% elif category in ['info'] %}fa-info-circle
                          {% else %}fa-times-circle{% endif %}"></i>
                <span class="flex-1">{{ msg }}</span>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- Bottom Navigation - All Sizes (Divar Style) -->
  <nav class="fixed bottom-0 left-0 right-0 z-40 bg-white dark:bg-gray-950 border-t border-gray-200 dark:border-gray-800">
    <div class="grid grid-cols-5 gap-0 px-2 py-2">
      <a href="{{ url_for('admin.dashboard') }}" 
         class="flex flex-col items-center gap-1 p-2 rounded-lg focusable
                {% if request.endpoint == 'admin.dashboard' %}text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20{% else %}text-gray-600 dark:text-gray-400{% endif %}">
        <i class="fa-solid fa-gauge-high text-lg"></i>
        <span class="text-xs">داشبورد</span>
      </a>
      <a href="{{ url_for('admin.express_partners') }}" 
         class="flex flex-col items-center gap-1 p-2 rounded-lg focusable
                {% if request.endpoint == 'admin.express_partners' %}text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20{% else %}text-gray-600 dark:text-gray-400{% endif %}">
        <i class="fa-solid fa-users text-lg"></i>
        <span class="text-xs">همکاران</span>
      </a>
      <a href="{{ url_for('admin.add_express_listing') }}" 
         class="flex flex-col items-center gap-1 p-2 rounded-lg focusable
                {% if request.endpoint == 'admin.add_express_listing' %}text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20{% else %}text-gray-600 dark:text-gray-400{% endif %}">
        <i class="fa-solid fa-plus text-lg"></i>
        <span class="text-xs">ثبت آگهی</span>
      </a>
      <a href="{{ url_for('admin.express_listings') }}" 
         class="flex flex-col items-center gap-1 p-2 rounded-lg focusable
                {% if request.endpoint in ['admin.express_listings', 'admin.edit_express_listing'] %}text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20{% else %}text-gray-600 dark:text-gray-400{% endif %}">
        <i class="fa-solid fa-layer-group text-lg"></i>
        <span class="text-xs">آگهی‌ها</span>
      </a>
      <button @click="menuOpen = !menuOpen" 
              onclick="event.preventDefault(); event.stopPropagation();"
              class="flex flex-col items-center gap-1 p-2 rounded-lg focusable text-gray-600 dark:text-gray-400"
              aria-label="باز کردن منو">
        <i class="fa-solid fa-bars text-lg"></i>
        <span class="text-xs">منو</span>
      </button>
    </div>
  </nav>

  <!-- Spacer for bottom nav -->
  <div class="h-16"></div>

  {% block bottom_footer %}{% endblock %}

  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <!-- Fallback برای منو در موبایل (در صورت عدم لود شدن Alpine.js) -->
  <script>
    (function() {
      let menuOpen = false;
      let fallbackInitialized = false;
      
      function initMenuFallback() {
        if (fallbackInitialized) return;
        
        // اگر Alpine.js لود شده باشد، صبر کن تا initialize شود
        if (typeof Alpine !== 'undefined') {
          // Alpine.js موجود است، اما ممکن است هنوز initialize نشده باشد
          setTimeout(function() {
            // بررسی اینکه آیا Alpine.js واقعاً کار می‌کند
            const testElement = document.querySelector('[x-data*="menuOpen"]');
            if (testElement && Alpine && Alpine.$data && typeof Alpine.$data === 'function') {
              // Alpine.js کار می‌کند، fallback لازم نیست
              return;
            } else {
              // Alpine.js لود شده اما کار نمی‌کند، fallback را فعال کن
              setupFallback();
            }
          }, 1000);
        } else {
          // Alpine.js لود نشده، فوراً fallback را فعال کن
          setupFallback();
        }
      }
      
      function setupFallback() {
        if (fallbackInitialized) return;
        fallbackInitialized = true;
        console.warn('Alpine.js not working, using fallback menu');
        
        const menuOverlay = document.querySelector('[x-show="menuOpen"][class*="bg-black"]');
        const menuSidebar = document.querySelector('aside[x-show="menuOpen"]');
        
        function toggleMenu() {
          menuOpen = !menuOpen;
          if (menuOverlay) {
            menuOverlay.style.display = menuOpen ? 'block' : 'none';
            menuOverlay.style.opacity = menuOpen ? '0.4' : '0';
            menuOverlay.style.transition = 'opacity 0.2s';
          }
          if (menuSidebar) {
            menuSidebar.style.display = menuOpen ? 'block' : 'none';
            menuSidebar.style.transform = menuOpen ? 'translateX(0)' : 'translateX(100%)';
            menuSidebar.style.transition = 'transform 0.2s';
          }
          document.body.style.overflow = menuOpen ? 'hidden' : '';
        }
        
        // اضافه کردن event listener به دکمه‌ها
        document.querySelectorAll('button[onclick*="menuOpen"], button[aria-label*="منو"]').forEach(btn => {
          // حذف event listener قبلی
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
          
          newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleMenu();
          }, true);
        });
        
        // بستن منو با کلیک روی overlay
        if (menuOverlay) {
          menuOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleMenu();
          }, true);
        }
        
        // بستن منو با کلیک روی دکمه بستن
        const closeBtn = document.querySelector('button[onclick*="menuOpen = false"]');
        if (closeBtn) {
          closeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleMenu();
          }, true);
        }
        
        // بستن منو با کلیک روی لینک‌های منو
        const menuLinks = document.querySelectorAll('aside[x-show="menuOpen"] a');
        menuLinks.forEach(link => {
          link.addEventListener('click', function() {
            setTimeout(toggleMenu, 100);
          });
        });
      }
      
      // اجرا بعد از لود DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(initMenuFallback, 500);
        });
      } else {
        setTimeout(initMenuFallback, 500);
      }
      
      // اجرا بعد از لود کامل صفحه
      window.addEventListener('load', function() {
        setTimeout(initMenuFallback, 1000);
      });
    })();
  </script>

  <!-- PWA Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('{{ url_for("admin.admin_service_worker") }}', {
          scope: '/admin/'
        }).then((reg) => {
          console.log('Admin Service Worker registered:', reg.scope);
          
          // Check for updates
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker available, prompt user to refresh
                  if (confirm('نسخه جدید پنل ادمین آماده است. آیا می‌خواهید صفحه را تازه کنید؟')) {
                    window.location.reload();
                  }
                }
              });
            }
          });
        }).catch((err) => {
          console.error('Admin Service Worker registration failed:', err);
        });
      });
    }
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
