{% extends 'admin/base_admin.html' %}

{% block head %}
  {{ super() }}
  <style>
    /* مخفی کردن فوتر اصلی در صفحه لیست آگهی‌ها */
    nav[class*="fixed bottom-0"][class*="grid grid-cols-4"] {
      display: none !important;
    }
    /* حذف spacer فوتر اصلی */
    div[class*="lg:hidden h-16"]:not([class*="h-20"]) {
      display: none !important;
    }
  </style>
{% endblock %}

{% block content %}
<div class="space-y-6">

  <!-- هدر صفحه - سبک دیوار -->
  <div>
    <h1 class="text-lg font-semibold text-gray-900 dark:text-white">آگهی‌های اکسپرس</h1>
  </div>

  {% if lands and lands|length > 0 %}
    <!-- کارت‌های آگهی اکسپرس - سبک دیوار -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for land in lands %}
        {# نرمال‌سازی تصویر کاور #}
        {% set _imgs = [] %}
        {% if land.images %}
          {% if land.images is string %}
            {% set _imgs = [land.images] %}
          {% elif land.images is iterable %}
            {% set _imgs = land.images %}
          {% endif %}
        {% endif %}
        {% set cover = (_imgs[0] if _imgs and _imgs|length > 0 else None) %}

        <article class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
          
          <!-- تصویر کاور - سبک دیوار -->
          {% if cover %}
            <div class="relative aspect-[4/3] bg-gray-100 dark:bg-gray-800 overflow-hidden">
              {% if '://' in cover %}
                <img src="{{ cover }}" class="w-full h-full object-cover" alt="{{ land.title or 'عکس آگهی' }}">
              {% else %}
                {% set path = cover.lstrip('/') %}
                {% if path.startswith('uploads/') %}
                  <img src="/{{ path }}" class="w-full h-full object-cover" alt="{{ land.title or 'عکس آگهی' }}">
                {% else %}
                  <img src="/uploads/{{ path }}" class="w-full h-full object-cover" alt="{{ land.title or 'عکس آگهی' }}">
                {% endif %}
              {% endif %}
              
              <!-- برچسب وضعیت - سبک دیوار -->
              {% if land.express_status == 'sold' %}
              <div class="absolute top-2 left-2">
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-600 text-white">
                  <i class="fa-solid fa-check-double text-[10px] ml-1"></i>
                  فروخته شد
                </span>
              </div>
              {% else %}
              <div class="absolute top-2 left-2">
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-600 text-white">
                  <i class="fa-solid fa-star text-[10px] ml-1"></i>
                  اکسپرس
                </span>
              </div>
              {% endif %}
            </div>
          {% else %}
            <div class="aspect-[4/3] bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
              <i class="fa-solid fa-image text-3xl text-gray-300 dark:text-gray-700"></i>
            </div>
          {% endif %}

          <!-- محتوای کارت - سبک دیوار -->
          <div class="p-4 space-y-3">
            <!-- عنوان -->
            <h3 class="text-base font-semibold text-gray-900 dark:text-white line-clamp-2">
              {{ land.title or 'بدون عنوان' }}
            </h3>
            
            <!-- اطلاعات اصلی -->
            <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
              {% if land.location %}
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-location-dot text-xs"></i>
                <span class="truncate">{{ land.location }}</span>
              </div>
              {% endif %}
              
              {% if land.size %}
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-ruler-combined text-xs"></i>
                <span>{{ "{:,}".format(land.size | int) }} متر</span>
              </div>
              {% endif %}
              
              {% if land.category %}
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-tag text-xs"></i>
                <span>{{ land.category }}</span>
              </div>
              {% endif %}
            </div>

            <!-- قیمت - سبک دیوار -->
            <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
              <div class="flex items-center justify-between">
                <span class="text-xs text-gray-500 dark:text-gray-400">قیمت کل</span>
                <span class="text-base font-semibold text-gray-900 dark:text-white">
                  {{ "{:,}".format(land.price_total | int) if land.price_total else "نامشخص" }} تومان
                </span>
              </div>
              {% if land.price_per_meter %}
              <div class="flex items-center justify-between mt-1">
                <span class="text-xs text-gray-500 dark:text-gray-400">قیمت در متر</span>
                <span class="text-sm text-gray-700 dark:text-gray-300">
                  {{ "{:,}".format(land.price_per_meter | int) }} تومان
                </span>
              </div>
              {% endif %}
            </div>

            <!-- اطلاعات تماس - سبک دیوار -->
            {% if land.vinor_contact %}
            <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
              <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                <i class="fa-solid fa-phone text-xs"></i>
                <span>{{ land.vinor_contact }}</span>
              </div>
            </div>
            {% endif %}

            <!-- مدارک - سبک دیوار -->
            {% if land.express_documents and land.express_documents|length > 0 %}
            <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
              <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">مدارک تأییدشده:</div>
              <div class="flex flex-wrap gap-1">
                {% for doc in land.express_documents[:3] %}
                  <span class="inline-flex items-center gap-1 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 px-2 py-0.5 rounded text-xs">
                    <i class="fa-regular fa-file-pdf text-red-500 text-[10px]"></i>
                    {{ doc.split('_')[-1] if '_' in doc else doc }}
                  </span>
                {% endfor %}
                {% if land.express_documents|length > 3 %}
                  <span class="text-xs text-gray-500 dark:text-gray-400">+{{ land.express_documents|length - 3 }} بیشتر</span>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- دکمه‌های عملیات - سبک دیوار -->
            <div class="pt-2 border-t border-gray-200 dark:border-gray-700 space-y-2">
              <div class="grid grid-cols-2 gap-2">
                <a href="{{ url_for('admin.edit_express_listing', code=land.code) }}"
                   class="flex items-center justify-center gap-1.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 text-gray-700 dark:text-gray-300 text-sm px-3 py-2 rounded-lg transition focusable">
                  <i class="fa-regular fa-pen-to-square text-xs"></i>
                  ویرایش
                </a>
                
                <a href="{{ url_for('main.express_detail', code=land.code) }}" target="_blank"
                   class="flex items-center justify-center gap-1.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 text-gray-700 dark:text-gray-300 text-sm px-3 py-2 rounded-lg transition focusable">
                  <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i>
                  مشاهده
                </a>
              </div>
              
              <div class="grid grid-cols-2 gap-2">
                {% if land.express_status == 'sold' %}
                <form method="post" action="{{ url_for('admin.toggle_express_sold', code=land.code) }}" class="inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="w-full flex items-center justify-center gap-1.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 text-gray-700 dark:text-gray-300 text-sm px-3 py-2 rounded-lg transition focusable">
                    <i class="fa-solid fa-rotate-left text-xs"></i>
                    در انتظار فروش
                  </button>
                </form>
                {% else %}
                <form method="post" action="{{ url_for('admin.toggle_express_sold', code=land.code) }}" class="inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="w-full flex items-center justify-center gap-1.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 text-gray-700 dark:text-gray-300 text-sm px-3 py-2 rounded-lg transition focusable">
                    <i class="fa-solid fa-check-double text-xs"></i>
                    فروخته شد
                  </button>
                </form>
                {% endif %}
                
                <form method="post" action="{{ url_for('admin.delete_express_listing', code=land.code) }}" onsubmit="return confirm('آیا مطمئن هستید که می‌خواهید این آگهی را حذف کنید؟');" class="inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="w-full flex items-center justify-center gap-1.5 bg-white dark:bg-gray-900 border border-red-300 dark:border-red-700 hover:border-red-400 dark:hover:border-red-600 text-red-600 dark:text-red-400 text-sm px-3 py-2 rounded-lg transition focusable">
                    <i class="fa-solid fa-trash text-xs"></i>
                    حذف
                  </button>
                </form>
              </div>
            </div>

            <!-- اطلاعات اضافی - سبک دیوار -->
            <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
              <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                <span>کد: {{ land.code }}</span>
                <span class="jalali-dt" data-dt="{{ land.created_at or '' }}"></span>
              </div>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>

    <!-- صفحه‌بندی - سبک دیوار -->
    {% if pagination and pagination.pages > 1 %}
      <div class="flex justify-center">
        <nav class="flex items-center gap-2">
          {% if pagination.page > 1 %}
            <a href="?page={{ pagination.page - 1 }}" 
               class="px-3 py-2 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg hover:border-gray-300 dark:hover:border-gray-600 text-gray-700 dark:text-gray-300 text-sm transition focusable">
              قبلی
            </a>
          {% endif %}
          
          <span class="px-3 py-2 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white text-sm font-medium">
            {{ pagination.page }} از {{ pagination.pages }}
          </span>
          
          {% if pagination.page < pagination.pages %}
            <a href="?page={{ pagination.page + 1 }}" 
               class="px-3 py-2 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg hover:border-gray-300 dark:hover:border-gray-600 text-gray-700 dark:text-gray-300 text-sm transition focusable">
              بعدی
            </a>
          {% endif %}
        </nav>
      </div>
    {% endif %}

  {% else %}
    <!-- حالت خالی - سبک دیوار -->
    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-12 text-center">
      <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center mx-auto mb-4">
        <i class="fa-solid fa-star text-2xl text-gray-400 dark:text-gray-600"></i>
      </div>
      <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-2">هنوز آگهی اکسپرس ثبت نشده</h3>
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">برای شروع، اولین آگهی اکسپرس را ثبت کنید</p>
      <a href="{{ url_for('admin.add_express_listing') }}"
         class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-lg transition focusable">
        <i class="fa-solid fa-plus text-sm"></i>
        افزودن آگهی اکسپرس
      </a>
    </div>
  {% endif %}

</div>

{% block bottom_footer %}
<!-- فوتر ثبت آگهی - سبک دیوار -->
<nav class="fixed bottom-0 left-0 right-0 z-40 bg-white dark:bg-gray-950 border-t border-gray-200 dark:border-gray-800">
  <div class="px-4 py-3 max-w-7xl mx-auto">
    <a href="{{ url_for('admin.add_express_listing') }}"
       class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-3 rounded-lg transition focusable">
      <i class="fa-solid fa-plus text-base"></i>
      ثبت آگهی جدید
    </a>
  </div>
</nav>
<!-- Spacer for bottom footer -->
<div class="h-20"></div>
{% endblock %}

<script>
(function(){
  function fmt(dt){
    try{
      const d = new Date(String(dt||'').replace(' ','T'));
      if (isNaN(d)) return '';
      return d.toLocaleString('fa-IR', { timeZone: 'Asia/Tehran', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }catch(_){ return ''; }
  }
  document.querySelectorAll('.jalali-dt[data-dt]').forEach(el=>{
    const raw = el.getAttribute('data-dt')||'';
    el.textContent = fmt(raw) || '—';
  });
})();
</script>
{% endblock %}
