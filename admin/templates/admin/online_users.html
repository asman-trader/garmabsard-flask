{% extends 'admin/base_admin.html' %}

{% block page_title %}کاربران آنلاین{% endblock %}

{% block content %}
<div class="space-y-4">
  
  <!-- Header با دکمه بازگشت -->
  <div class="flex items-center gap-3 mb-4">
    <a href="{{ url_for('admin.dashboard') }}" 
       class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition focusable">
      <i class="fa-solid fa-arrow-right text-gray-600 dark:text-gray-400"></i>
    </a>
    <div class="flex-1">
      <h2 class="text-lg font-bold text-gray-900 dark:text-white">کاربران آنلاین</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400">{{ online_users_count or 0 }} کاربر فعال</p>
    </div>
  </div>

  <!-- لیست کاربران آنلاین -->
  {% if online_users and online_users|length > 0 %}
    <div class="space-y-2">
      {% for user in online_users %}
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-gray-300 dark:hover:border-gray-600 transition">
          <div class="flex items-center gap-3">
            <!-- آیکون کاربر با نشان آنلاین -->
            <div class="relative flex-shrink-0">
              <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                <i class="fa-solid fa-user text-green-600 dark:text-green-400 text-lg"></i>
              </div>
              <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white dark:border-gray-900"></div>
            </div>
            
            <!-- اطلاعات کاربر -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="font-semibold text-gray-900 dark:text-white">{{ user.username or 'کاربر' }}</h3>
                <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">
                  <i class="fa-solid fa-circle text-[6px] ml-1"></i>
                  آنلاین
                </span>
              </div>
              <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600 dark:text-gray-400">
                <span class="flex items-center gap-1.5">
                  <i class="fa-solid fa-network-wired text-xs"></i>
                  <span class="font-mono text-xs">{{ user.ip }}</span>
                </span>
                <span class="flex items-center gap-1.5">
                  <i class="fa-solid fa-clock text-xs"></i>
                  <span class="jalali-dt" data-dt="{{ user.last_activity }}"></span>
                </span>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-8 text-center">
      <i class="fa-solid fa-users-slash text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
      <p class="text-gray-600 dark:text-gray-400">هیچ کاربر آنلاینی وجود ندارد</p>
    </div>
  {% endif %}

</div>

<script>
  // تبدیل تاریخ به شمسی
  (function(){
    function fmt(dt){
      try{
        const d = new Date(String(dt||'').replace(' ','T'));
        if (isNaN(d.getTime())) return '';
        return d.toLocaleDateString('fa-IR', { 
          timeZone: 'Asia/Tehran', 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }catch(_){ return ''; }
    }
    document.querySelectorAll('.jalali-dt[data-dt]').forEach(el=>{
      const raw = el.getAttribute('data-dt')||'';
      const formatted = fmt(raw);
      el.textContent = formatted || '—';
    });
  })();
</script>
{% endblock %}

