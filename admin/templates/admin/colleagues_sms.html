{% extends 'admin/base_admin.html' %}
{% block content %}
<div class="max-w-6xl mx-auto px-4 py-4 space-y-6">
  <!-- هدر -->
  <div class="flex items-center justify-between">
    <h1 class="text-lg font-bold text-gray-900 dark:text-white">ارسال پیامک به همکاران</h1>
    <div class="flex gap-2">
      <a 
        href="{{ url_for('admin.sms_history') }}" 
        class="px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-600 transition-colors"
      >
        <i class="fa-solid fa-clock-rotate-left"></i> سابقه کامل
      </a>
    </div>
  </div>

  {% if message %}
    <div class="mb-3 p-3 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 text-emerald-800 dark:text-emerald-200 border border-emerald-200 dark:border-emerald-800">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="mb-3 p-3 rounded-lg bg-rose-50 dark:bg-rose-900/20 text-rose-800 dark:text-rose-200 border border-rose-200 dark:border-rose-800">{{ error }}</div>
  {% endif %}

  <!-- اطلاعات همکاران - سبک دیوار -->
  <div class="mb-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm font-semibold text-gray-900 dark:text-white">تعداد همکاران تایید شده</div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">این پیامک به همه همکاران تایید شده ارسال می‌شود</div>
      </div>
      <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ partners_count or 0 }}</div>
    </div>
  </div>

  <!-- لیست همکاران (پیش‌نمایش) -->
  {% if approved_partners and approved_partners|length > 0 %}
  <div class="mb-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">پیش‌نمایش همکاران ({{ approved_partners|length }} مورد اول)</h3>
    <div class="space-y-2 max-h-48 overflow-y-auto">
      {% for partner in approved_partners %}
      <div class="flex items-center justify-between py-2 px-3 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
        <span class="text-sm text-gray-900 dark:text-white">{{ partner.name }}</span>
        <span class="text-xs text-gray-500 dark:text-gray-400 font-mono">{{ partner.phone }}</span>
      </div>
      {% endfor %}
    </div>
    {% if partners_count > approved_partners|length %}
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">و {{ partners_count - approved_partners|length }} همکار دیگر...</p>
    {% endif %}
  </div>
  {% endif %}

  <!-- تب‌های ارسال -->
  <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
    <!-- هدر تب‌ها -->
    <div class="flex border-b border-gray-200 dark:border-gray-700">
      <button 
        type="button"
        onclick="switchMode('template')"
        id="tab-template"
        class="flex-1 px-4 py-3 text-sm font-medium transition-colors
               {% if send_mode == 'template' %}
                 bg-vinor-50 dark:bg-vinor-900/20 text-vinor-600 dark:text-vinor-400 border-b-2 border-vinor-600
               {% else %}
                 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800
               {% endif %}"
      >
        <i class="fa-solid fa-file-lines"></i> ارسال با قالب
      </button>
      <button 
        type="button"
        onclick="switchMode('direct')"
        id="tab-direct"
        class="flex-1 px-4 py-3 text-sm font-medium transition-colors
               {% if send_mode == 'direct' %}
                 bg-vinor-50 dark:bg-vinor-900/20 text-vinor-600 dark:text-vinor-400 border-b-2 border-vinor-600
               {% else %}
                 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800
               {% endif %}"
      >
        <i class="fa-solid fa-paper-plane"></i> ارسال مستقیم (API)
      </button>
    </div>

    <!-- محتوای تب ارسال با قالب -->
    <div id="content-template" class="{% if send_mode != 'template' %}hidden{% endif %} p-4 space-y-4">
      <form method="post" class="space-y-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="send_mode" value="template">
        
        <div>
          <label class="block text-sm font-medium text-gray-900 dark:text-white mb-1">
            شناسه قالب (Template ID) <span class="text-red-500">*</span>
          </label>
          <input 
            type="number" 
            name="template_id" 
            class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600" 
            placeholder="مثلاً 878451" 
            required
          >
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">شناسه قالب پیامک در پنل sms.ir</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-900 dark:text-white mb-1">
            متن پیام (اختیاری - در صورت نیاز به پارامتر از بخش زیر استفاده کنید)
          </label>
          <textarea 
            name="message_text" 
            rows="3" 
            class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600" 
            placeholder="متن پیام (در صورت نیاز به پارامتر، از بخش پارامترها استفاده کنید)"
          ></textarea>
        </div>

        <!-- پارامترهای قالب -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <div class="flex items-center justify-between mb-3">
            <label class="block text-sm font-medium text-gray-900 dark:text-white">
              پارامترهای قالب (اختیاری)
            </label>
            <button 
              type="button" 
              id="addParamBtn" 
              class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
            >
              + افزودن پارامتر
            </button>
          </div>
          <div id="paramsContainer" class="space-y-2">
            <!-- پارامترها به صورت داینامیک اضافه می‌شوند -->
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
            پارامترها باید مطابق با قالب تعریف شده در پنل sms.ir باشند. مثال: CODE، NAME، MESSAGE
          </p>
        </div>

        <div class="flex items-center gap-2 pt-2 border-t border-gray-200 dark:border-gray-700">
          <button 
            type="submit" 
            class="px-4 py-2 rounded-lg bg-vinor-600 text-white text-sm font-medium hover:bg-vinor-700 transition-colors"
          >
            ارسال پیامک به همکاران
          </button>
          <a 
            href="{{ url_for('admin.dashboard') }}" 
            class="px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-600 transition-colors"
          >
            انصراف
          </a>
        </div>
      </form>
    </div>

    <!-- محتوای تب ارسال مستقیم -->
    <div id="content-direct" class="{% if send_mode != 'direct' %}hidden{% endif %} p-4 space-y-4">
      <form method="post" class="space-y-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="send_mode" value="direct">
        
        <div>
          <label class="block text-sm font-medium text-gray-900 dark:text-white mb-1">
            متن پیامک <span class="text-red-500">*</span>
          </label>
          <textarea 
            name="direct_message" 
            rows="6" 
            class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600" 
            placeholder="متن پیامک که می‌خواهید به همکاران ارسال شود..."
            required
          ></textarea>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">متن پیامک به صورت مستقیم و بدون استفاده از قالب ارسال می‌شود</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-900 dark:text-white mb-1">
            شماره خط اختصاصی (اختیاری)
          </label>
          <input 
            type="text" 
            name="line_number" 
            value="300089930616"
            class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600" 
            placeholder="300089930616"
          >
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">شماره خط اختصاصی پیش‌فرض: 300089930616 (می‌توانید تغییر دهید)</p>
        </div>

        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
          <p class="text-xs text-blue-800 dark:text-blue-200">
            <i class="fa-solid fa-info-circle"></i> 
            <strong>نکته:</strong> در حالت ارسال مستقیم، پیامک بدون استفاده از قالب و به صورت مستقیم از API sms.ir ارسال می‌شود.
          </p>
        </div>

        <div class="flex items-center gap-2 pt-2 border-t border-gray-200 dark:border-gray-700">
          <button 
            type="submit" 
            class="px-4 py-2 rounded-lg bg-vinor-600 text-white text-sm font-medium hover:bg-vinor-700 transition-colors"
          >
            ارسال پیامک به همکاران
          </button>
          <a 
            href="{{ url_for('admin.dashboard') }}" 
            class="px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-600 transition-colors"
          >
            انصراف
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- سابقه ارسال‌ها -->
  <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-base font-semibold text-gray-900 dark:text-white">
        <i class="fa-solid fa-clock-rotate-left"></i> سابقه ارسال‌های اخیر
      </h2>
      {% if history_stats %}
      <div class="flex gap-4 text-sm">
        <span class="text-gray-600 dark:text-gray-400">
          کل: <span class="font-semibold text-gray-900 dark:text-white">{{ history_stats.total }}</span>
        </span>
        <span class="text-green-600 dark:text-green-400">
          موفق: <span class="font-semibold">{{ history_stats.sent }}</span>
        </span>
        <span class="text-red-600 dark:text-red-400">
          ناموفق: <span class="font-semibold">{{ history_stats.failed }}</span>
        </span>
      </div>
      {% endif %}
    </div>

    {% if history and history|length > 0 %}
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
          <tr>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 dark:text-gray-400">تاریخ</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 dark:text-gray-400">شماره</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 dark:text-gray-400">نام</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 dark:text-gray-400">قالب</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 dark:text-gray-400">وضعیت</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 dark:text-gray-400">جزئیات</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          {% for record in history %}
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
            <td class="px-3 py-2 text-gray-900 dark:text-white text-xs">
              {% if record.created_at %}
                {{ record.created_at[:16]|replace('T', ' ') }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="px-3 py-2 text-gray-900 dark:text-white font-mono text-xs">
              {{ record.mobile or '-' }}
            </td>
            <td class="px-3 py-2 text-gray-900 dark:text-white text-xs">
              {{ record.recipient_name or '-' }}
            </td>
            <td class="px-3 py-2 text-gray-900 dark:text-white text-xs">
              {% if record.template_id %}
                {{ record.template_id }}
              {% elif record.source == 'admin_colleagues_direct' %}
                <span class="text-blue-600 dark:text-blue-400">مستقیم</span>
              {% else %}
                -
              {% endif %}
            </td>
            <td class="px-3 py-2">
              {% if record.success %}
                <span class="px-2 py-0.5 rounded text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 font-medium">✓ موفق</span>
              {% else %}
                <span class="px-2 py-0.5 rounded text-xs bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 font-medium">✗ ناموفق</span>
              {% endif %}
            </td>
            <td class="px-3 py-2">
              <button 
                onclick="showDetails({{ loop.index0 }})"
                class="text-vinor-600 dark:text-vinor-400 hover:underline text-xs"
              >
                مشاهده
              </button>
              <div id="details-{{ loop.index0 }}" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">جزئیات ارسال</h3>
                    <button onclick="document.getElementById('details-{{ loop.index0 }}').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                      <i class="fa-solid fa-xmark"></i>
                    </button>
                  </div>
                  <div class="space-y-3 text-sm">
                    <div>
                      <span class="font-semibold text-gray-700 dark:text-gray-300">شماره موبایل:</span>
                      <span class="text-gray-900 dark:text-white font-mono">{{ record.mobile or '-' }}</span>
                    </div>
                    <div>
                      <span class="font-semibold text-gray-700 dark:text-gray-300">نام گیرنده:</span>
                      <span class="text-gray-900 dark:text-white">{{ record.recipient_name or '-' }}</span>
                    </div>
                    {% if record.template_id %}
                    <div>
                      <span class="font-semibold text-gray-700 dark:text-gray-300">شناسه قالب:</span>
                      <span class="text-gray-900 dark:text-white">{{ record.template_id }}</span>
                    </div>
                    <div>
                      <span class="font-semibold text-gray-700 dark:text-gray-300">پارامترها:</span>
                      <pre class="mt-1 p-2 bg-gray-50 dark:bg-gray-900 rounded text-xs overflow-x-auto">{{ (record.parameters or {})|tojson(indent=2) }}</pre>
                    </div>
                    {% elif record.message %}
                    <div>
                      <span class="font-semibold text-gray-700 dark:text-gray-300">متن پیامک:</span>
                      <div class="mt-1 p-2 bg-gray-50 dark:bg-gray-900 rounded text-sm text-gray-900 dark:text-white">{{ record.message }}</div>
                    </div>
                    {% endif %}
                    <div>
                      <span class="font-semibold text-gray-700 dark:text-gray-300">کد وضعیت:</span>
                      <span class="text-gray-900 dark:text-white">{{ record.status_code or '-' }}</span>
                    </div>
                    {% if record.error %}
                    <div>
                      <span class="font-semibold text-red-700 dark:text-red-300">خطا:</span>
                      <span class="text-red-600 dark:text-red-400">{{ record.error }}</span>
                    </div>
                    {% endif %}
                    <div>
                      <span class="font-semibold text-gray-700 dark:text-gray-300">پاسخ API:</span>
                      <pre class="mt-1 p-2 bg-gray-50 dark:bg-gray-900 rounded text-xs overflow-x-auto">{{ (record.response or {})|tojson(indent=2) }}</pre>
                    </div>
                    <div>
                      <span class="font-semibold text-gray-700 dark:text-gray-300">تاریخ:</span>
                      <span class="text-gray-900 dark:text-white">{{ record.created_at or '-' }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination برای سابقه -->
    {% if history_total_pages > 1 %}
    <div class="mt-4 flex items-center justify-between px-3 py-2 border-t border-gray-200 dark:border-gray-700">
      <div class="text-xs text-gray-600 dark:text-gray-400">
        صفحه {{ history_page }} از {{ history_total_pages }}
      </div>
      <div class="flex gap-2">
        {% if history_page > 1 %}
        <a 
          href="?history_page={{ history_page - 1 }}"
          class="px-2 py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 text-xs hover:border-gray-300 dark:hover:border-gray-600"
        >
          قبلی
        </a>
        {% endif %}
        {% if history_page < history_total_pages %}
        <a 
          href="?history_page={{ history_page + 1 }}"
          class="px-2 py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 text-xs hover:border-gray-300 dark:hover:border-gray-600"
        >
          بعدی
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% else %}
    <div class="text-center py-8 text-gray-500 dark:text-gray-400 text-sm">
      هنوز هیچ ارسالی ثبت نشده است
    </div>
    {% endif %}
  </div>
</div>

<script>
// مدیریت پارامترهای داینامیک
let paramIndex = 0;

document.getElementById('addParamBtn')?.addEventListener('click', function() {
  const container = document.getElementById('paramsContainer');
  const paramDiv = document.createElement('div');
  paramDiv.className = 'flex gap-2 items-center';
  paramDiv.innerHTML = `
    <input 
      type="text" 
      name="param_key[]" 
      placeholder="نام پارامتر (مثلاً CODE)" 
      class="flex-1 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600"
    >
    <input 
      type="text" 
      name="param_value[]" 
      placeholder="مقدار پارامتر" 
      class="flex-1 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-gray-300 dark:focus:ring-gray-600"
    >
    <button 
      type="button" 
      class="remove-param-btn px-2 py-1 rounded border border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 hover:bg-red-100 dark:hover:bg-red-900/30 text-sm"
    >
      حذف
    </button>
  `;
  container.appendChild(paramDiv);
  
  // اضافه کردن event listener برای دکمه حذف
  paramDiv.querySelector('.remove-param-btn')?.addEventListener('click', function() {
    paramDiv.remove();
  });
  
  paramIndex++;
});

// نمایش جزئیات
function showDetails(index) {
  document.getElementById('details-' + index).classList.remove('hidden');
}

// تغییر حالت ارسال
function switchMode(mode) {
  // تغییر تب‌ها
  document.getElementById('tab-template').classList.remove('bg-vinor-50', 'dark:bg-vinor-900/20', 'text-vinor-600', 'dark:text-vinor-400', 'border-b-2', 'border-vinor-600');
  document.getElementById('tab-template').classList.add('text-gray-600', 'dark:text-gray-400');
  document.getElementById('tab-direct').classList.remove('bg-vinor-50', 'dark:bg-vinor-900/20', 'text-vinor-600', 'dark:text-vinor-400', 'border-b-2', 'border-vinor-600');
  document.getElementById('tab-direct').classList.add('text-gray-600', 'dark:text-gray-400');
  
  if (mode === 'template') {
    document.getElementById('tab-template').classList.remove('text-gray-600', 'dark:text-gray-400');
    document.getElementById('tab-template').classList.add('bg-vinor-50', 'dark:bg-vinor-900/20', 'text-vinor-600', 'dark:text-vinor-400', 'border-b-2', 'border-vinor-600');
    document.getElementById('content-template').classList.remove('hidden');
    document.getElementById('content-direct').classList.add('hidden');
  } else {
    document.getElementById('tab-direct').classList.remove('text-gray-600', 'dark:text-gray-400');
    document.getElementById('tab-direct').classList.add('bg-vinor-50', 'dark:bg-vinor-900/20', 'text-vinor-600', 'dark:text-vinor-400', 'border-b-2', 'border-vinor-600');
    document.getElementById('content-template').classList.add('hidden');
    document.getElementById('content-direct').classList.remove('hidden');
  }
  
  // به‌روزرسانی URL بدون reload
  const url = new URL(window.location);
  url.searchParams.set('mode', mode);
  window.history.pushState({}, '', url);
}
</script>
{% endblock %}
