{% extends 'base.html' %}
{% set hide_header = True %}

{% block title %}ุชูุธูุงุช ุญุณุงุจ | ูููุฑ{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto bg-white dark:bg-gray-800 p-5 sm:p-6 rounded-xl shadow mt-4 sm:mt-8">

  <!-- ููุงุฑ ุจุงูุง ููุจุงู -->
  <div class="flex items-center justify-between mb-4">
    <button onclick="history.back()" class="text-sm text-gray-600 dark:text-gray-300 hover:underline">
      โ ุจุงุฒฺฏุดุช
    </button>
    <span class="text-sm font-bold text-green-700 dark:text-green-400">ูููุฑ</span>
  </div>

  <h1 class="text-xl sm:text-2xl font-bold mb-1 text-gray-900 dark:text-white">
    โ๏ธ ุชูุธูุงุช ุญุณุงุจ ฺฉุงุฑุจุฑ
  </h1>
  <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 mb-6">
    ุงุทูุงุนุงุช ูพุฑููุงูุ ุงุณุชุงู ู ุดูุฑ ุฏูุฎูุงู ุจุฑุง ุฌุณุชุฌู ุฑุง ุงูุฌุง ูุฑุงุด ฺฉูุฏ.
  </p>

  {% if user %}
  <form method="post" action="{{ url_for('main.settings') }}" class="space-y-6">

    <!-- ุดูุงุฑู ููุจุงู (ููุงุด) -->
    <div class="space-y-1">
      <label class="block text-sm text-gray-600 dark:text-gray-300">ุดูุงุฑู ููุจุงู (ุบุฑูุงุจู ุชุบุฑ)</label>
      <input type="text" value="{{ user.phone }}" disabled
             class="w-full border rounded-lg px-3 py-2 bg-gray-100 text-gray-500 dark:bg-slate-700 dark:text-gray-400 dark:border-slate-600" />
    </div>

    <!-- ูุงู -->
    <div class="space-y-1">
      <label for="first_name" class="block text-sm text-gray-600 dark:text-gray-300">ูุงู</label>
      <input id="first_name" type="text" name="first_name" value="{{ user.first_name or '' }}" required
             class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/50 dark:bg-slate-700 dark:border-slate-600 dark:text-white" />
    </div>

    <!-- ูุงู ุฎุงููุงุฏฺฏ -->
    <div class="space-y-1">
      <label for="last_name" class="block text-sm text-gray-600 dark:text-gray-300">ูุงู ุฎุงููุงุฏฺฏ</label>
      <input id="last_name" type="text" name="last_name" value="{{ user.last_name or '' }}"
             class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/50 dark:bg-slate-700 dark:border-slate-600 dark:text-white" />
    </div>

    <!-- ุจุฎุด: ูููุนุช ูพุดโูุฑุถ ุฌุณุชุฌู (ุงุณุชุงู/ุดูุฑ) -->
    <div class="pt-2">
      <h2 class="text-base font-semibold mb-2 text-gray-800 dark:text-gray-100">๐ ูููุนุช ูพุดโูุฑุถ ุฌุณุชุฌู</h2>

      <!-- ุงุณุชุงู -->
      <div class="space-y-1 mb-3">
        <label for="province-select" class="block text-sm text-gray-600 dark:text-gray-300">ุงุณุชุงู</label>
        <select name="province" id="province-select" required
                class="w-full border rounded-lg px-3 py-2 appearance-none bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white">
          <option value="">ุงูุชุฎุงุจ ฺฉูุฏโฆ</option>
          <option value="ุชูุฑุงู" {{ 'selected' if user.province == 'ุชูุฑุงู' else '' }}>ุชูุฑุงู</option>
          <option value="ุงูุจุฑุฒ" {{ 'selected' if user.province == 'ุงูุจุฑุฒ' else '' }}>ุงูุจุฑุฒ</option>
          <option value="ูุงุฒูุฏุฑุงู" {{ 'selected' if user.province == 'ูุงุฒูุฏุฑุงู' else '' }}>ูุงุฒูุฏุฑุงู</option>
          <!-- ุฏุฑ ุตูุฑุช ูุงุฒุ ุงุณุชุงูโูุง ุจุดุชุฑ ุฑุง ุงุฒ ุณุฑูุฑ ูพุฑ ฺฉูุฏ -->
        </select>
        <p class="text-[11px] text-gray-500 dark:text-gray-400">ุงุณุชุงู ฺฉู ุจุดุชุฑ ุฏุฑ ุขู ุฌุณุชุฌู ูโฺฉูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.</p>
      </div>

      <!-- ุดูุฑ -->
      <div class="space-y-1">
        <label for="city-select" class="block text-sm text-gray-600 dark:text-gray-300">ุดูุฑ</label>
        <div class="relative">
          <select name="city" id="city-select" required
                  class="w-full border rounded-lg px-3 py-2 appearance-none bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white">
            {% if user.city %}
              <option value="{{ user.city }}" selected>{{ user.city }}</option>
            {% else %}
              <option value="">ุงุจุชุฏุง ุงุณุชุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ</option>
            {% endif %}
          </select>
          <!-- ุขฺฉู ููุด ุณูุงุฑุด -->
          <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">โพ</span>
        </div>
        <p class="text-[11px] text-gray-500 dark:text-gray-400">ุงู ุดูุฑ ุจูโุนููุงู ูพุดโูุฑุถ ููุชุฑ ุฌุณุชุฌู ุฏุฑ ูููุฑ ุงุณุชูุงุฏู ูโุดูุฏ.</p>
      </div>
    </div>

    <!-- ุชุบุฑ ุฑูุฒ ุนุจูุฑ -->
    <div class="border-t dark:border-slate-700 pt-4">
      <label for="new_password" class="block text-sm mb-2 text-gray-600 dark:text-gray-300">ุชุบุฑ ุฑูุฒ ุนุจูุฑ (ุงุฎุชุงุฑ)</label>
      <input id="new_password" type="password" name="new_password" placeholder="ุฑูุฒ ุฌุฏุฏ"
             class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/50 dark:bg-slate-700 dark:border-slate-600 dark:text-white" />
      <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">ุฏุฑ ุตูุฑุช ุนุฏู ุชุบุฑุ ุงู ุจุฎุด ุฑุง ุฎุงู ุจฺฏุฐุงุฑุฏ.</p>
    </div>

    <!-- ุฐุฎุฑู -->
    <div class="pt-2">
      <button type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl shadow transition active:scale-[0.99]">
        ๐พ ุฐุฎุฑู ุชุบุฑุงุช
      </button>
    </div>
  </form>
  {% else %}
  <div class="text-red-600 mt-6">ุฎุทุง: ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ ุงูุช ูุดุฏ.</div>
  {% endif %}

  <!-- ููฺฉ ุจุงุฒฺฏุดุช ุจู ุฎุงูู -->
  <div class="mt-6">
    <a href="{{ url_for('main.index') }}"
       class="block text-center text-sm text-green-700 dark:text-green-400 hover:underline">
      โ ุจุงุฒฺฏุดุช ุจู ุตูุญู ุงุตู
    </a>
  </div>
</div>

<!-- JS: ุจุงุฑฺฏุฐุงุฑ ุดูุฑูุง ุจุฑ ุงุณุงุณ ุงุณุชุงู (Mobile-First ู ุณุจฺฉ) -->
<script>
  // ูุฌููุนู ูููููุ ุฏุฑ ุตูุฑุช ูุงุฒ ุงุฒ ุณุฑูุฑ ูพุฑ ฺฉูุฏ.
  const citiesByProvince = {
    'ุชูุฑุงู': ['ุชูุฑุงู', 'ุฏูุงููุฏ', 'ุฑูุฏูู', 'ุจูููู', 'ูพุฑุฏุณ', 'ูุฑูุฒฺฉูู', 'ูุฑุงูู', 'ุงุณูุงูโุดูุฑ'],
    'ุงูุจุฑุฒ': ['ฺฉุฑุฌ', 'ูุธุฑุขุจุงุฏ', 'ุทุงููุงู', 'ูุดุชฺฏุฑุฏ', 'ูุฑุฏุณ'],
    'ูุงุฒูุฏุฑุงู': ['ุณุงุฑ', 'ุขูู', 'ุจุงุจู', 'ฺุงููุณ', 'ููุดูุฑ', 'ุฑุงูุณุฑ']
  };

  const $province = document.getElementById('province-select');
  const $city = document.getElementById('city-select');

  function renderCityOptions(list) {
    $city.innerHTML = '';
    if (!list || list.length === 0) {
      $city.innerHTML = '<option value="">ุงุจุชุฏุง ุงุณุชุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ</option>';
      return;
    }
    for (const c of list) {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      $city.appendChild(opt);
    }
  }

  function onProvinceChange() {
    const pv = $province.value;
    const list = citiesByProvince[pv] || [];
    const current = '{{ user.city or "" }}';
    renderCityOptions(list);
    // ุงฺฏุฑ ุดูุฑ ูุนู ฺฉุงุฑุจุฑ ุฏุฑ ูุณุช ูุฌูุฏ ุฏุงุฑุฏุ ุงูุชุฎุงุจ ุดูุฏ
    if (current && list.includes(current)) {
      $city.value = current;
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    // ุงฺฏุฑ ุงุณุชุงู ุงุฒ ูุจู ุงูุชุฎุงุจ ุดุฏูุ ุดูุฑูุง ุฑุง ููุฏ ฺฉู
    if ($province && $province.value) {
      onProvinceChange();
    } else {
      renderCityOptions(null);
    }
    $province && $province.addEventListener('change', onProvinceChange);
  });
</script>
{% endblock %}
