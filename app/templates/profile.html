{% extends "base.html" %}
{% block title %}ناحیه کاربری | املاک آسمان گرمابسرد{% endblock %}

{% block content %}
{# ======================= Macros ======================= #}
{% macro StatCard(href, icon, label, value) -%}
  <a href="{{ href }}" class="group rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 shadow-sm hover:shadow-md transition">
    <div class="flex items-center justify-between">
      <div class="text-xs text-gray-500 dark:text-gray-400">{{ label }}</div>
      <i class="fas {{ icon }} text-gray-400 group-hover:text-green-600"></i>
    </div>
    <div class="mt-2 text-2xl font-bold text-gray-800 dark:text-gray-100">{{ value }}</div>
  </a>
{%- endmacro %}

{% macro TabBtn(name, icon, text, active=False) -%}
  <button class="tab-btn {{ 'active' if active else '' }}" data-tab="{{ name }}">
    <i class="fas {{ icon }} ml-2"></i>{{ text }}
  </button>
{%- endmacro %}

{% macro CardItem(land) -%}
  {% set img = (land.images[0] if land.images else None) if land.images is defined else None %}
  <a href="{{ url_for('main.land_detail', code=land.code) }}" class="block rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 overflow-hidden shadow-sm hover:shadow-md transition">
    <div class="w-full h-40 bg-gray-100 dark:bg-gray-800 overflow-hidden">
      {% if img %}
        <img src="{{ url_for('main.uploaded_file', filename=img) }}" alt="{{ land.title }}" class="w-full h-full object-cover" loading="lazy">
      {% else %}
        <div class="w-full h-full flex items-center justify-center text-gray-400"><i class="fas fa-image"></i></div>
      {% endif %}
    </div>
    <div class="p-3">
      <div class="font-semibold text-gray-800 dark:text-gray-100 line-clamp-1">{{ land.title|default('بدون عنوان', true) }}</div>
      <div class="mt-1 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-2">
        <span>{{ land.size|default('-', true) }} متر</span><span class="opacity-50">•</span><span>{{ land.location|default('—', true) }}</span>
      </div>
    </div>
  </a>
{%- endmacro %}

{% macro Empty(icon, text, cta_href=None, cta_text=None) -%}
  <div class="rounded-xl border border-dashed border-gray-300 dark:border-gray-700 p-6 text-center text-gray-600 dark:text-gray-300">
    <div class="text-2xl mb-2"><i class="fas {{ icon }}"></i></div>
    <div>{{ text }}</div>
    {% if cta_href and cta_text %}
      <a href="{{ cta_href }}" class="btn-primary inline-flex mt-3"><i class="fas fa-plus ml-1"></i>{{ cta_text }}</a>
    {% endif %}
  </div>
{%- endmacro %}

{# ======================= Header ======================= #}
<main class="max-w-6xl mx-auto px-3 sm:px-4 py-6">

  <section class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm p-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
          <i class="fas fa-user text-green-700 dark:text-green-300 text-xl"></i>
        </div>
        <div>
          <div class="text-base font-bold text-gray-800 dark:text-gray-100">
            {% if session.get('user_phone') %}{{ session['user_phone'] }}{% else %}مهمان{% endif %}
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">داشبورد شخصی شما</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a href="{{ url_for('main.settings') }}" class="btn-secondary hidden xs:inline-flex"><i class="fas fa-cog ml-1"></i> تنظیمات</a>
        {% if session.get('user_phone') %}
          <a href="{{ url_for('main.logout') }}" class="btn-danger hidden xs:inline-flex"><i class="fas fa-sign-out-alt ml-1"></i> خروج</a>
        {% else %}
          <a href="{{ url_for('main.send_otp') }}" class="btn-primary hidden xs:inline-flex"><i class="fas fa-sign-in-alt ml-1"></i> ورود</a>
        {% endif %}
      </div>
    </div>
  </section>

  {# ======================= Stats ======================= #}
  <section class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 my-4">
    {{ StatCard(url_for('main.my_lands'), 'fa-layer-group', 'آگهی‌های من', (my_lands|length)|default(0, true)) }}
    {{ StatCard(url_for('main.favorites'), 'fa-heart', 'علاقه‌مندی‌ها', (favorites|length)|default(0, true)) }}
    {{ StatCard(url_for('main.notifications'), 'fa-bell', 'اعلان‌های خوانده‌نشده', (notif_count)|default(0, true)) }}
    {{ StatCard(url_for('main.submit_ad'), 'fa-plus-circle', 'ثبت آگهی جدید', '+') }}
  </section>

  {# ======================= Tabs ======================= #}
  <section class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
    <nav class="flex overflow-x-auto gap-2 p-3 border-b border-gray-200 dark:border-gray-800">
      {{ TabBtn('overview', 'fa-gauge', 'نمای کلی', True) }}
      {{ TabBtn('myads', 'fa-list', 'آگهی‌های من') }}
      {{ TabBtn('favs', 'fa-heart', 'علاقه‌مندی‌ها') }}
      {{ TabBtn('notifs', 'fa-bell', 'اعلان‌ها') }}
      {{ TabBtn('profile', 'fa-user-edit', 'اطلاعات') }}
      {{ TabBtn('security', 'fa-shield-alt', 'امنیت') }}
      {{ TabBtn('support', 'fa-headset', 'پشتیبانی') }}
    </nav>

    <div class="p-4 sm:p-6 space-y-6">

      {# -------- Overview -------- #}
      <div class="tab-panel" id="tab-overview">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-4">
            <div class="font-bold text-gray-800 dark:text-gray-100 mb-2">وضعیت حساب</div>
            <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
              <li>شماره: <span class="font-semibold">{% if session.get('user_phone') %}{{ session['user_phone'] }}{% else %}—{% endif %}</span></li>
              <li>ورود: <span class="font-semibold">{% if session.get('user_phone') %}فعال{% else %}خارج از حساب{% endif %}</span></li>
              <li>اعلان‌های خوانده‌نشده: <span class="font-semibold">{{ (notif_count)|default(0, true) }}</span></li>
            </ul>
            <div class="mt-3 flex gap-2">
              <a href="{{ url_for('main.submit_ad') }}" class="btn-primary"><i class="fas fa-plus ml-1"></i> ثبت آگهی</a>
              <a href="{{ url_for('main.notifications') }}" class="btn-secondary"><i class="fas fa-bell ml-1"></i> اعلان‌ها</a>
            </div>
          </div>

          <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-4">
            <div class="font-bold text-gray-800 dark:text-gray-100 mb-2">میانبرها</div>
            <div class="grid grid-cols-2 gap-2">
              <a href="{{ url_for('main.my_lands') }}" class="quick-link"><i class="fas fa-layer-group"></i> آگهی‌ها</a>
              <a href="{{ url_for('main.favorites') }}" class="quick-link"><i class="fas fa-heart"></i> علاقه‌مندی‌ها</a>
              <a href="{{ url_for('main.settings') }}" class="quick-link"><i class="fas fa-cog"></i> تنظیمات</a>
              <a href="{{ url_for('main.index') }}" class="quick-link"><i class="fas fa-home"></i> خانه</a>
            </div>
          </div>
        </div>
      </div>

      {# -------- My Ads -------- #}
      <div class="tab-panel hidden" id="tab-myads">
        {% set ads = my_lands|default([], true) %}
        {% if ads|length == 0 %}
          {{ Empty('fa-layer-group', 'هنوز آگهی ثبت نکرده‌اید.', url_for('main.submit_ad'), 'ثبت آگهی') }}
        {% else %}
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for land in ads %}{{ CardItem(land) }}{% endfor %}
          </div>
        {% endif %}
      </div>

      {# -------- Favorites -------- #}
      <div class="tab-panel hidden" id="tab-favs">
        {% set favs = favorites|default([], true) %}
        {% if favs|length == 0 %}
          {{ Empty('fa-heart-broken', 'موردی در علاقه‌مندی‌ها ندارید.') }}
        {% else %}
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for land in favs %}{{ CardItem(land) }}{% endfor %}
          </div>
        {% endif %}
      </div>

      {# -------- Notifications -------- #}
      <div class="tab-panel hidden" id="tab-notifs">
        <div class="flex items-center justify-between mb-3">
          <div class="font-bold text-gray-800 dark:text-gray-100">آخرین اعلان‌ها</div>
          <a href="{{ url_for('main.notifications') }}" class="text-sm text-green-700 dark:text-green-300 hover:underline">مشاهده همه</a>
        </div>
        {% set notifs = items|default([], true) %}
        {% if notifs|length == 0 %}
          {{ Empty('fa-bell-slash', 'هنوز اعلانی ندارید.') }}
        {% else %}
          <div class="space-y-2">
            {% for n in notifs[:8] %}
              <div class="flex items-start gap-3 rounded-xl border p-3
                          {{ 'border-green-300 bg-green-50 dark:border-green-900 dark:bg-green-900/20' if not n.read else 'border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900' }}">
                <div class="w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center shrink-0">
                  <i class="fas fa-bell text-green-700 dark:text-green-300 text-sm"></i>
                </div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-800 dark:text-gray-100">{{ n.title or 'اعلان' }}</div>
                  {% if n.message %}<div class="text-sm text-gray-600 dark:text-gray-300 mt-0.5">{{ n.message }}</div>{% endif %}
                  {% if n.created_at %}<div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">{{ n.created_at }}</div>{% endif %}
                </div>
                {% if not n.read %}
                  <span class="text-[10px] px-2 py-0.5 rounded-full bg-red-500 text-white">جدید</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      {# -------- Profile (Basic Info) -------- #}
      <div class="tab-panel hidden" id="tab-profile">
        <form method="post" action="{{ url_for('main.settings') }}" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="form-label">نام</label>
            <input type="text" name="first_name" class="form-input" placeholder="نام" value="{{ user.first_name|default('', true) if user is defined }}">
          </div>
          <div>
            <label class="form-label">نام خانوادگی</label>
            <input type="text" name="last_name" class="form-input" placeholder="نام خانوادگی" value="{{ user.last_name|default('', true) if user is defined }}">
          </div>
          <div class="sm:col-span-2">
            <label class="form-label">شماره موبایل</label>
            <input type="text" class="form-input bg-gray-100 dark:bg-gray-800 cursor-not-allowed" value="{% if session.get('user_phone') %}{{ session['user_phone'] }}{% endif %}" readonly>
          </div>
          <div class="sm:col-span-2">
            <button class="btn-primary"><i class="fas fa-save ml-1"></i> ذخیره</button>
          </div>
        </form>
      </div>

      {# -------- Security -------- #}
      <div class="tab-panel hidden" id="tab-security">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-4">
            <div class="font-bold mb-2">ورود با کد پیامکی</div>
            <p class="text-sm text-gray-600 dark:text-gray-300">برای امنیت بیشتر از کد یکبارمصرف استفاده کنید.</p>
            <a href="{{ url_for('main.send_otp') }}" class="btn-secondary mt-3 inline-flex"><i class="fas fa-mobile-alt ml-1"></i> ورود مجدد</a>
          </div>
          <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-4">
            <div class="font-bold mb-2">نشست‌ها</div>
            <p class="text-sm text-gray-600 dark:text-gray-300">در صورت شک به دسترسی غیرمجاز از همه دستگاه‌ها خارج شوید.</p>
            <a href="{{ url_for('main.logout') }}" class="btn-danger inline-flex mt-3"><i class="fas fa-sign-out-alt ml-1"></i> خروج از همه</a>
          </div>
        </div>
      </div>

      {# -------- Support -------- #}
      <div class="tab-panel hidden" id="tab-support">
        <form method="post" action="{{ url_for('main.settings') }}" class="space-y-3 rounded-xl border border-gray-200 dark:border-gray-800 p-4">
          <div class="font-bold text-gray-800 dark:text-gray-100">درخواست پشتیبانی</div>
          <input type="text" name="subject" class="form-input" placeholder="موضوع">
          <textarea name="message" rows="4" class="form-input" placeholder="توضیحات..."></textarea>
          <button class="btn-primary"><i class="fas fa-paper-plane ml-1"></i> ارسال</button>
        </form>
      </div>

    </div>
  </section>
</main>

{# ======================= Styles ======================= #}
<style>
  .tab-btn{ @apply whitespace-nowrap rounded-lg px-3 py-2 text-sm border border-transparent text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800; }
  .tab-btn.active{ @apply bg-green-600 text-white hover:bg-green-700; }
  .btn-primary{ @apply px-3 py-2 rounded-lg bg-green-600 text-white text-sm hover:bg-green-700; }
  .btn-secondary{ @apply px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800; }
  .btn-danger{ @apply px-3 py-2 rounded-lg bg-red-600 text-white text-sm hover:bg-red-700; }
  .quick-link{ @apply flex items-center gap-2 rounded-lg border border-gray-200 dark:border-gray-700 px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800; }
  .form-label{ @apply block text-sm text-gray-600 dark:text-gray-300 mb-1; }
  .form-input{ @apply w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500; }
</style>

{# ======================= Tabs Script ======================= #}
<script>
  (function(){
    const btns=[...document.querySelectorAll('.tab-btn')];
    const panels=[...document.querySelectorAll('.tab-panel')];
    const storeKey='profile_active_tab';

    function show(name){
      btns.forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
      panels.forEach(p=>p.classList.toggle('hidden', p.id!=='tab-'+name));
      try{ sessionStorage.setItem(storeKey, name); }catch(e){}
    }

    btns.forEach(b=>b.addEventListener('click', ()=>show(b.dataset.tab)));
    let initial='overview';
    try{ const s=sessionStorage.getItem(storeKey); if(s) initial=s; }catch(e){}
    show(initial);
  })();
</script>
{% endblock %}
