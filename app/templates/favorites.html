{% extends "base.html" %}
{% set hide_header = True %}

{% block title %}Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ | ÙˆÛŒÙ†ÙˆØ±{% endblock %}

{% block content %}
<!-- Header: back + title + bell (optional) -->
<header class="fixed top-0 inset-x-0 z-30 bg-white dark:bg-gray-800 border-b dark:border-gray-700">
  <div class="max-w-7xl mx-auto px-3 sm:px-4 py-3 flex items-center justify-between">
    <button type="button" onclick="history.back()" class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª">
      <i class="fas fa-arrow-right"></i>
    </button>
    <h1 class="text-base sm:text-lg font-bold text-gray-900 dark:text-white">Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</h1>
    <button id="favBell" type="button" class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§">
      <i class="fas fa-bookmark"></i>
    </button>
  </div>
  <div class="px-3 sm:px-4 pb-3">
    <div class="flex items-center justify-end gap-2">
      <button id="refreshFavs" class="px-3 py-1.5 text-xs rounded-lg border dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-800">â†» Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      <button id="clearFavs" class="px-3 py-1.5 text-xs rounded-lg bg-rose-600 hover:bg-rose-700 text-white">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
    </div>
  </div>
</header>
<div class="h-20"></div>

<div class="max-w-7xl mx-auto px-3 sm:px-4 py-6">

  <div id="favoritesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>

  <div id="noFavorites" class="text-center text-gray-500 dark:text-gray-300 hidden mt-10">
    Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.
  </div>
</div>

<script>
  (function(){
    // optional: bell behavior similar to notifications page
    try{
      const bell = document.getElementById('favBell');
      bell?.addEventListener('click', async ()=>{
        if (!('Notification' in window)) return;
        const perm = (Notification.permission === 'default') ? await Notification.requestPermission() : Notification.permission;
        if (perm !== 'granted') return;
        if ('serviceWorker' in navigator){
          const reg = await navigator.serviceWorker.getRegistration('/') || await navigator.serviceWorker.register('/sw.js');
          if (reg && reg.pushManager){
            try{
              const r = await fetch('/api/push/config');
              const d = await r.json();
              const pk = d.publicKey || '';
              if (pk){
                const key = (b64)=>{const p='='.repeat((4-b64.length%4)%4);const s=(b64+p).replace(/-/g,'+').replace(/_/g,'/');const raw=atob(s);const out=new Uint8Array(raw.length);for(let i=0;i<raw.length;i++)out[i]=raw.charCodeAt(i);return out;};
                const sub = await reg.pushManager.getSubscription() || await reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey:key(pk)});
                await fetch('/api/push/subscribe', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(sub)});
              }
            }catch(_){ }
          }
        }
      });
    }catch(_){ }
    const KEY = 'favoriteLands';
    const container = document.getElementById('favoritesContainer');
    const emptyEl = document.getElementById('noFavorites');
    const btnClear = document.getElementById('clearFavs');
    const btnRefresh = document.getElementById('refreshFavs');

    const readFavs = () => { try { return (JSON.parse(localStorage.getItem(KEY) || '[]')||[]).map(String); } catch { return []; } };
    const writeFavs = (arr) => { try { localStorage.setItem(KEY, JSON.stringify(arr)); } catch {} };

    function cardTemplate(land){
      const firstImg = (land.images && land.images.length > 0) ? land.images[0] : null;
      const imgSrc = firstImg ? `/uploads/${String(firstImg).replace(/^\/+/, '')}` : null;
      const price = land.price_total ? (Number(land.price_total)||0).toLocaleString('fa-IR') : 'Ù†Ø§Ù…Ø´Ø®Øµ';
      const size = land.size ? (Number(land.size)||0).toLocaleString('fa-IR') : '?';
      const code = String(land.code||'');
      const el = document.createElement('div');
      el.className = 'land-card bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl shadow-sm overflow-hidden group transition';
      el.dataset.code = code;
      el.innerHTML = `
        <div class="relative">
          <a href="/land/${code}">
            ${imgSrc ? `<img src="${imgSrc}" alt="Ø²Ù…ÛŒÙ† ${land.title||''}" class="w-full h-60 object-cover transition duration-300 group-hover:scale-105" loading="lazy" />` : `<div class=\"w-full h-60 bg-gray-200 dark:bg-gray-700 grid place-items-center text-gray-500\">Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±</div>`}
          </a>
          <button type="button" class="absolute top-3 right-3 favorite-btn z-10" title="Ø­Ø°Ù Ø§Ø² Ø°Ø®ÛŒØ±Ù‡â€ŒÙ‡Ø§">
            <i class="fas fa-bookmark text-red-500 text-2xl drop-shadow-md"></i>
          </button>
        </div>
        <div class="p-4">
          <a href="/land/${code}"><h3 class="text-base font-bold text-gray-900 dark:text-white truncate">${land.title || 'Ø¹Ù†ÙˆØ§Ù† Ù†Ø¯Ø§Ø±Ø¯'}</h3></a>
          <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">ğŸ“ ${land.location || '?'} | ğŸ“ ${size} Ù…ØªØ±</p>
          <p class="text-base font-extrabold text-green-700 dark:text-green-400 mt-2">ğŸ’° ${price} ØªÙˆÙ…Ø§Ù†</p>
        </div>`;
      return el;
    }

    function render(list){
      const favCodes = readFavs();
      const items = list.filter(x => favCodes.includes(String(x.code)));
      container.innerHTML = '';
      if (!items.length){ emptyEl.classList.remove('hidden'); return; }
      emptyEl.classList.add('hidden');
      items.forEach(land => container.appendChild(cardTemplate(land)));

      // bind remove-from-favs on page
      container.querySelectorAll('.land-card').forEach(card => {
        const code = String(card.dataset.code||'');
        const btn = card.querySelector('.favorite-btn');
        btn?.addEventListener('click', (e)=>{
          e.preventDefault();
          const favs = readFavs();
          const idx = favs.indexOf(code);
          if (idx > -1) favs.splice(idx, 1);
          writeFavs(favs);
          card.remove();
          if (!container.children.length) emptyEl.classList.remove('hidden');
        });
      });
    }

    function getAllLands(){
      try {
        const cached = JSON.parse(localStorage.getItem('allLandsData') || '[]');
        if (Array.isArray(cached) && cached.length) return Promise.resolve(cached);
      } catch {}
      return fetch('/api/lands/approved', { credentials: 'same-origin' })
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(j => {
          const items = (j && j.ok && Array.isArray(j.items)) ? j.items : [];
          try { localStorage.setItem('allLandsData', JSON.stringify(items)); } catch {}
          return items;
        })
        .catch(()=>[]);
    }

    // actions
    btnClear?.addEventListener('click', ()=>{
      writeFavs([]);
      container.innerHTML = '';
      emptyEl.classList.remove('hidden');
    });
    btnRefresh?.addEventListener('click', async ()=> render(await getAllLands()));

    // boot
    getAllLands().then(render);
  })();
</script>
{% endblock %}
