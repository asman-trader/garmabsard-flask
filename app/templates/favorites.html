{% extends "base.html" %}

{% block title %}علاقه‌مندی‌ها | وینور{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-3 sm:px-4 py-6">
  <div class="flex items-center justify-between mb-5">
    <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 dark:text-white">ذخیره‌شده‌ها</h1>
    <div class="flex items-center gap-2">
      <button id="refreshFavs" class="px-3 py-2 text-sm rounded-lg border dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-800">↻ بروزرسانی</button>
      <button id="clearFavs" class="px-3 py-2 text-sm rounded-lg bg-rose-600 hover:bg-rose-700 text-white">حذف همه</button>
    </div>
  </div>

  <div id="favoritesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>

  <div id="noFavorites" class="text-center text-gray-500 dark:text-gray-300 hidden mt-10">
    هنوز آگهی‌ای ذخیره نکرده‌اید.
  </div>
</div>

<script>
  (function(){
    const KEY = 'favoriteLands';
    const container = document.getElementById('favoritesContainer');
    const emptyEl = document.getElementById('noFavorites');
    const btnClear = document.getElementById('clearFavs');
    const btnRefresh = document.getElementById('refreshFavs');

    const readFavs = () => { try { return (JSON.parse(localStorage.getItem(KEY) || '[]')||[]).map(String); } catch { return []; } };
    const writeFavs = (arr) => { try { localStorage.setItem(KEY, JSON.stringify(arr)); } catch {} };

    function cardTemplate(land){
      const firstImg = (land.images && land.images.length > 0) ? land.images[0] : null;
      const imgSrc = firstImg ? `/uploads/${String(firstImg).replace(/^\/+/, '')}` : null;
      const price = land.price_total ? (Number(land.price_total)||0).toLocaleString('fa-IR') : 'نامشخص';
      const size = land.size ? (Number(land.size)||0).toLocaleString('fa-IR') : '?';
      const code = String(land.code||'');
      const el = document.createElement('div');
      el.className = 'land-card bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl shadow-sm overflow-hidden group transition';
      el.dataset.code = code;
      el.innerHTML = `
        <div class="relative">
          <a href="/land/${code}">
            ${imgSrc ? `<img src="${imgSrc}" alt="زمین ${land.title||''}" class="w-full h-60 object-cover transition duration-300 group-hover:scale-105" loading="lazy" />` : `<div class=\"w-full h-60 bg-gray-200 dark:bg-gray-700 grid place-items-center text-gray-500\">بدون تصویر</div>`}
          </a>
          <button type="button" class="absolute top-3 right-3 favorite-btn z-10" title="حذف از ذخیره‌ها">
            <i class="fas fa-bookmark text-red-500 text-2xl drop-shadow-md"></i>
          </button>
        </div>
        <div class="p-4">
          <a href="/land/${code}"><h3 class="text-base font-bold text-gray-900 dark:text-white truncate">${land.title || 'عنوان ندارد'}</h3></a>
          <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">📍 ${land.location || '?'} | 📏 ${size} متر</p>
          <p class="text-base font-extrabold text-green-700 dark:text-green-400 mt-2">💰 ${price} تومان</p>
        </div>`;
      return el;
    }

    function render(list){
      const favCodes = readFavs();
      const items = list.filter(x => favCodes.includes(String(x.code)));
      container.innerHTML = '';
      if (!items.length){ emptyEl.classList.remove('hidden'); return; }
      emptyEl.classList.add('hidden');
      items.forEach(land => container.appendChild(cardTemplate(land)));

      // bind remove-from-favs on page
      container.querySelectorAll('.land-card').forEach(card => {
        const code = String(card.dataset.code||'');
        const btn = card.querySelector('.favorite-btn');
        btn?.addEventListener('click', (e)=>{
          e.preventDefault();
          const favs = readFavs();
          const idx = favs.indexOf(code);
          if (idx > -1) favs.splice(idx, 1);
          writeFavs(favs);
          card.remove();
          if (!container.children.length) emptyEl.classList.remove('hidden');
        });
      });
    }

    function getAllLands(){
      try {
        const cached = JSON.parse(localStorage.getItem('allLandsData') || '[]');
        if (Array.isArray(cached) && cached.length) return Promise.resolve(cached);
      } catch {}
      return fetch('/api/lands/approved', { credentials: 'same-origin' })
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(j => {
          const items = (j && j.ok && Array.isArray(j.items)) ? j.items : [];
          try { localStorage.setItem('allLandsData', JSON.stringify(items)); } catch {}
          return items;
        })
        .catch(()=>[]);
    }

    // actions
    btnClear?.addEventListener('click', ()=>{
      writeFavs([]);
      container.innerHTML = '';
      emptyEl.classList.remove('hidden');
    });
    btnRefresh?.addEventListener('click', async ()=> render(await getAllLands()));

    // boot
    getAllLands().then(render);
  })();
</script>
{% endblock %}
