{% extends "base.html" %}

{% block title %}Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ | Ø§Ù…Ù„Ø§Ú© Ø¢Ø³Ù…Ø§Ù† Ú¯Ø±Ù…Ø§Ø¨Ø³Ø±Ø¯{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">â¤ï¸ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ Ø´Ù…Ø§</h1>

  <div id="favoritesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´Ù† -->
  </div>

  <div id="noFavorites" class="text-center text-gray-500 dark:text-gray-300 hidden mt-10">
    Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ø±Ø¯ÛŒØ¯.
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const favoritesContainer = document.getElementById("favoritesContainer");
    const noFavorites = document.getElementById("noFavorites");

    // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§: Ø§Ø¨ØªØ¯Ø§ Ø§Ø² localStorageØŒ Ø¯Ø±ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯ Ø§Ø² API
    let allLands = [];
    try { allLands = JSON.parse(localStorage.getItem("allLandsData") || "[]"); } catch (e) { allLands = []; }
    const favoriteCodes = (JSON.parse(localStorage.getItem("favoriteLands") || "[]")).map(String); // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø±Ø´ØªÙ‡

    function render(list){
      const favoriteLands = list.filter(land => favoriteCodes.includes(String(land.code)));
      if (favoriteLands.length === 0) {
        noFavorites.classList.remove("hidden");
        return;
      }
      favoriteLands.forEach(land => {
        const card = document.createElement("div");
        card.className = "bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-sm hover:shadow-xl transition-transform hover:scale-[1.02] duration-300 overflow-hidden";

        const firstImg = (land.images && land.images.length > 0) ? land.images[0] : null;
        const imgSrc = firstImg ? `/uploads/${firstImg.replace(/^\/+/, '')}` : null;
        const imageHTML = imgSrc
          ? `<img src="${imgSrc}" class="w-full h-48 object-cover rounded-t-2xl" loading="lazy" alt="ØªØµÙˆÛŒØ± Ø²Ù…ÛŒÙ†">`
          : `<div class=\"w-full h-48 bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-400\">Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±</div>`;

        card.innerHTML = `
          <a href="/land/${land.code}">${imageHTML}</a>
          <div class="p-4">
            <a href="/land/${land.code}">
              <h3 class="text-lg font-bold text-green-700 dark:text-green-400 hover:underline truncate">${land.title || "Ø¹Ù†ÙˆØ§Ù† Ù†Ø¯Ø§Ø±Ø¯"}</h3>
            </a>
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
              ğŸ“ ${land.size ? (Number(land.size)||0).toLocaleString() : "?"} Ù…ØªØ± | ğŸ“ ${land.location || "?"}
            </p>
            <p class="text-sm text-gray-800 dark:text-gray-200 font-semibold mt-3">
              ğŸ’° ${land.price_total ? (Number(land.price_total)||0).toLocaleString() : "Ù†Ø§Ù…Ø´Ø®Øµ"} ØªÙˆÙ…Ø§Ù†
            </p>
          </div>
        `;
        favoritesContainer.appendChild(card);
      });
    }

    if (allLands.length > 0){
      render(allLands);
    } else {
      fetch('/api/lands/approved', { credentials: 'same-origin' })
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(j => {
          if (j && j.ok && Array.isArray(j.items)) {
            try { localStorage.setItem('allLandsData', JSON.stringify(j.items)); } catch(e) {}
            render(j.items);
          } else {
            noFavorites.classList.remove('hidden');
          }
        })
        .catch(()=> noFavorites.classList.remove('hidden'));
    }
  });
</script>
{% endblock %}
