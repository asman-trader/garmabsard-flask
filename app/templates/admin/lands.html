{% extends 'admin/base_admin.html' %}

{% block content %}
<div class="max-w-6xl mx-auto p-4 sm:p-6">

  <!-- Ù‡Ø¯Ø± ØµÙØ­Ù‡ + Ù…ÛŒØ§Ù†Ø¨Ø± Ø«Ø¨Øª -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-xl sm:text-2xl font-extrabold text-vinor-700 dark:text-vinor-600 flex items-center gap-2">
      <i class="fas fa-layer-group"></i>
      Ù„ÛŒØ³Øª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡
    </h1>
    <a href="{{ url_for('admin.add_land') }}"
       class="inline-flex items-center gap-2 bg-vinor-600 hover:bg-vinor-700 text-white text-sm sm:text-base px-3 sm:px-4 py-2 rounded-xl shadow transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-vinor-600">
      <i class="fas fa-plus-circle"></i>
      Ø«Ø¨Øª Ù…Ù„Ú© Ø¬Ø¯ÛŒØ¯
    </a>
  </div>

  <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… -->
  {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
      <div class="space-y-3 mb-5" role="status" aria-live="polite">
        {% for category, msg in messages %}
          <div class="text-sm rounded-xl px-3 py-2 border
                      {% if category in ['success', 'ok'] %}
                        bg-emerald-50 text-emerald-800 border-emerald-200 dark:bg-emerald-900/20 dark:text-emerald-200 dark:border-emerald-800/50
                      {% elif category in ['warning'] %}
                        bg-amber-50 text-amber-800 border-amber-200 dark:bg-amber-900/20 dark:text-amber-200 dark:border-amber-800/50
                      {% elif category in ['info'] %}
                        bg-blue-50 text-blue-800 border-blue-200 dark:bg-blue-900/20 dark:text-blue-200 dark:border-blue-800/50
                      {% else %}
                        bg-rose-50 text-rose-800 border-rose-200 dark:bg-rose-900/20 dark:text-rose-200 dark:border-rose-800/50
                      {% endif %}">
            {{ msg }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if lands and lands|length > 0 %}
    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ú¯Ù‡ÛŒ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
      {% for land in lands %}
        {# Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªØµÙˆÛŒØ± Ú©Ø§ÙˆØ± (string/iterable/URL) #}
        {% set _imgs = [] %}
        {% if land.images %}
          {% if land.images is string %}
            {% set _imgs = [land.images] %}
          {% elif land.images is iterable %}
            {% set _imgs = land.images %}
          {% endif %}
        {% endif %}
        {% set cover = (_imgs[0] if _imgs and _imgs|length > 0 else None) %}

        <article class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow hover:shadow-lg transition p-4 flex flex-col">
          <!-- ØªØµÙˆÛŒØ± Ù…Ù„Ú© -->
          {% if cover %}
            {% set _is_abs = '://' in cover %}
            <img
              src="{{ cover if _is_abs else (('/uploads/' + cover) if not cover.startswith('/uploads/') else cover) }}"
              alt="ØªØµÙˆÛŒØ± {{ land.title or 'Ù…Ù„Ú©' }}"
              loading="lazy"
              decoding="async"
              class="w-full h-40 object-cover rounded-xl mb-3">
          {% else %}
            <div class="w-full h-40 bg-gray-100 dark:bg-gray-700 rounded-xl mb-3 flex items-center justify-center text-gray-400">
              Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±
            </div>
          {% endif %}

          <!-- Ø¹Ù†ÙˆØ§Ù† + ÙˆØ¶Ø¹ÛŒØª -->
          <header class="flex items-start justify-between gap-3">
            <h2 class="text-base sm:text-lg font-bold text-gray-800 dark:text-gray-100 line-clamp-2">
              {{ land.title or 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†' }}
            </h2>

            {% if land.status %}
              {% set _st = (land.status|string) %}
              {% if _st == 'approved' %}
                <span class="shrink-0 inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">
                  <i class="fa-solid fa-circle-check"></i> ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡
                </span>
              {% elif _st == 'rejected' %}
                <span class="shrink-0 inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-200">
                  <i class="fa-solid fa-circle-xmark"></i> Ø±Ø¯ Ø´Ø¯Ù‡
                </span>
              {% else %}
                <span class="shrink-0 inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-200">
                  <i class="fa-solid fa-clock"></i> Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±
                </span>
              {% endif %}
            {% endif %}
          </header>

          {# Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡: Ø§Ø¨ØªØ¯Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙÛŒÙ„Ø¯ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ØŒ Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¨Ù„Øºâ€ŒÙ‡Ø§ Ø­Ø¯Ø³ Ø²Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ #}
          {% set _deal_code = land.deal_type or (land.extras.deal_type if land.extras is defined else '') %}
          {% set _extras = land.extras or {} %}
          {% set _dep = _extras.deposit %}
          {% set _rent = _extras.rent %}

          {% if _deal_code %}
            {% if _deal_code == 'sale' %}
              {% set _deal_label = 'ÙØ±ÙˆØ´' %}
            {% elif _deal_code == 'mortgage_full' %}
              {% set _deal_label = 'Ø±Ù‡Ù† Ú©Ø§Ù…Ù„' %}
            {% elif _deal_code == 'mortgage_rent' %}
              {% set _deal_label = 'Ø±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡' %}
            {% elif _deal_code == 'rent' %}
              {% set _deal_label = 'Ø§Ø¬Ø§Ø±Ù‡' %}
            {% else %}
              {% set _deal_label = 'ÙØ±ÙˆØ´' %}
            {% endif %}
          {% else %}
            {% if _rent %}
              {% if _dep %}
                {% set _deal_label = 'Ø±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡' %}
              {% else %}
                {% set _deal_label = 'Ø§Ø¬Ø§Ø±Ù‡' %}
              {% endif %}
            {% elif _dep and not land.price_total %}
              {% set _deal_label = 'Ø±Ù‡Ù† Ú©Ø§Ù…Ù„' %}
            {% else %}
              {% set _deal_label = 'ÙØ±ÙˆØ´' %}
            {% endif %}
          {% endif %}

          <!-- Ø¬Ø²Ø¦ÛŒØ§Øª -->
          <div class="mt-2 space-y-1.5 text-sm">
            {% if _deal_label %}
              <p class="text-gray-700 dark:text-gray-200 font-semibold">Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡: {{ _deal_label }}</p>
            {% endif %}
            {% if land.size %}
              <p class="text-gray-600 dark:text-gray-300">ğŸ“ Ù…ØªØ±Ø§Ú˜: {{ land.size }} Ù…ØªØ±</p>
            {% endif %}
            {% if land.location %}
              <p class="text-gray-600 dark:text-gray-300">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª: {{ land.location }}</p>
            {% endif %}
            {% if land.code %}
              <p class="text-xs text-gray-500 dark:text-gray-400">ğŸ†” Ú©Ø¯ Ù…Ù„Ú©: {{ land.code }}</p>
            {% endif %}
            {% if land.description %}
              <p class="text-gray-700 dark:text-gray-300 line-clamp-3 leading-6">ğŸ“ {{ land.description }}</p>
            {% endif %}
          </div>

          <!-- Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§ -->
          <div class="mt-4 grid grid-cols-2 gap-2">
            {% if land.code %}
              <a href="{{ url_for('admin.view_land', code=land.code) }}"
                 class="inline-flex items-center justify-center gap-1.5 bg-sky-600 hover:bg-sky-700 text-white text-sm py-2 rounded-lg transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500">
                <i class="fa-regular fa-eye"></i>
                Ù…Ø´Ø§Ù‡Ø¯Ù‡
              </a>
              <a href="{{ url_for('admin.edit_land', code=land.code) }}"
                 class="inline-flex items-center justify-center gap-1.5 bg-vinor-600 hover:bg-vinor-700 text-white text-sm py-2 rounded-lg transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-vinor-600">
                <i class="fas fa-edit"></i>
                ÙˆÛŒØ±Ø§ÛŒØ´
              </a>
              <form method="post" action="{{ url_for('admin.delete_land', code=land.code) }}" class="col-span-2"
                    onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¢Ú¯Ù‡ÛŒ Â«{{ land.title or 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†' }}Â» Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="w-full inline-flex items-center justify-center gap-1.5 bg-rose-600 hover:bg-rose-700 text-white text-sm py-2 rounded-lg transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-500">
                  <i class="fas fa-trash"></i>
                  Ø­Ø°Ù
                </button>
              </form>
            {% else %}
              {# fallback: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ù†Ø¯ÛŒØ³ Ø­Ù„Ù‚Ù‡ Ø§Ú¯Ø± code Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª #}
              <a href="{{ url_for('admin.view_land', land_id=loop.index0) }}"
                 class="inline-flex items-center justify-center gap-1.5 bg-sky-600 hover:bg-sky-700 text-white text-sm py-2 rounded-lg transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500">
                <i class="fa-regular fa-eye"></i>
                Ù…Ø´Ø§Ù‡Ø¯Ù‡
              </a>
              <a href="{{ url_for('admin.edit_land', land_id=loop.index0) }}"
                 class="inline-flex items-center justify-center gap-1.5 bg-vinor-600 hover:bg-vinor-700 text-white text-sm py-2 rounded-lg transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-vinor-600">
                <i class="fas fa-edit"></i>
                ÙˆÛŒØ±Ø§ÛŒØ´
              </a>
              <form method="post" action="{{ url_for('admin.delete_land', land_id=loop.index0) }}" class="col-span-2"
                    onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¢Ú¯Ù‡ÛŒ Â«{{ land.title or 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†' }}Â» Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="w-full inline-flex items-center justify-center gap-1.5 bg-rose-600 hover:bg-rose-700 text-white text-sm py-2 rounded-lg transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-500">
                  <i class="fas fa-trash"></i>
                  Ø­Ø°Ù
                </button>
              </form>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>

    <!-- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ -->
    {% if pagination and pagination.pages > 1 %}
      <nav class="mt-8 flex items-center justify-center gap-1 text-sm" aria-label="ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ">
        {% if pagination.page > 1 %}
          <a href="{{ url_for('admin.lands', page=pagination.page-1) }}"
             class="px-3 py-2 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-vinor-600">
            Ù‚Ø¨Ù„ÛŒ
          </a>
        {% endif %}
        {% for p in range(1, pagination.pages + 1) %}
          <a href="{{ url_for('admin.lands', page=p) }}"
             class="px-3 py-2 rounded-lg border
                    {% if p == pagination.page %}
                      bg-vinor-600 text-white border-vinor-600
                    {% else %}
                      bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700
                    {% endif %} focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-vinor-600">
            {{ p }}
          </a>
        {% endfor %}
        {% if pagination.page < pagination.pages %}
          <a href="{{ url_for('admin.lands', page=pagination.page+1) }}"
             class="px-3 py-2 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-vinor-600">
            Ø¨Ø¹Ø¯ÛŒ
          </a>
        {% endif %}
      </nav>
    {% endif %}

  {% else %}
    <!-- Ø®Ø§Ù„ÛŒ -->
    <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-300/70 dark:border-blue-700 text-blue-900 dark:text-blue-100 p-6 rounded-2xl text-center shadow">
      Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
      <div class="mt-4">
        <a href="{{ url_for('admin.add_land') }}"
           class="inline-flex items-center gap-2 bg-vinor-600 hover:bg-vinor-700 text-white px-4 py-2 rounded-xl transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-vinor-600">
          <i class="fas fa-plus-circle"></i>
          Ø«Ø¨Øª Ø§ÙˆÙ„ÛŒÙ† Ø¢Ú¯Ù‡ÛŒ
        </a>
      </div>
    </div>
  {% endif %}

  <!-- Ø¨Ø§Ø²Ú¯Ø´Øª -->
  <div class="mt-8 text-center">
    <a href="{{ url_for('admin.dashboard') }}" class="inline-flex items-center gap-2 text-vinor-700 dark:text-vinor-600 hover:underline decoration-dotted">
      <i class="fas fa-arrow-right"></i>
      Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    </a>
  </div>

</div>
{% endblock %}
