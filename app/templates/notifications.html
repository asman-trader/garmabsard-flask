<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>اعلان‌ها | وینور – بازار آنلاین ملک</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100">
  <main class="max-w-md mx-auto p-4 sm:p-6">
    <!-- هدر صفحه -->
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-lg font-bold">اعلان‌های من</h1>
      <button id="mark-all"
              class="text-sm px-3 py-1.5 rounded-lg bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700">
        علامت‌گذاری همه به‌عنوان خوانده‌شده
      </button>
    </header>

    <!-- لیست اعلان‌ها -->
    <ul class="space-y-3">
      {% if items and items|length %}
        {% for n in items %}
          <li class="p-3 rounded-2xl bg-white dark:bg-gray-800 shadow flex gap-3 items-start">
            <div class="w-9 h-9 rounded-xl flex items-center justify-center
              {% if n.type == 'success' %} bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-300
              {% elif n.type == 'warning' %} bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-300
              {% elif n.type == 'error' %} bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300
              {% elif n.type == 'status' %} bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300
              {% else %} bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-200{% endif %}">
              <i class="fa-solid
                {% if n.type=='success' %}fa-circle-check
                {% elif n.type=='warning' %}fa-triangle-exclamation
                {% elif n.type=='error' %}fa-circle-xmark
                {% elif n.type=='status' %}fa-bullhorn
                {% else %}fa-bell{% endif %}"></i>
            </div>

            <div class="flex-1">
              <div class="flex items-center justify-between gap-3">
                <h3 class="font-semibold text-sm line-clamp-2">{{ n.title }}</h3>
                <span class="text-[11px] text-gray-400 shrink-0">{{ n.created_at | time_ago }}</span>
                {# اگر لازم بود، می‌توانید از your_time_filter هم استفاده کنید: {{ n.created_at | your_time_filter }} #}
              </div>

              <p class="text-sm mt-1 leading-6">{{ n.body }}</p>

              <div class="mt-2 flex items-center gap-2">
                {% if n.action_url %}
                  <a href="{{ n.action_url }}"
                     class="text-xs px-2 py-1 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition">
                    مشاهده
                  </a>
                {% endif %}

                {% if not n.is_read %}
                  <button class="text-xs px-2 py-1 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 mark-read"
                          data-id="{{ n.id }}">
                    علامت‌گذاری به‌عنوان خوانده‌شده
                  </button>
                  <span class="text-[10px] text-red-500">● جدید</span>
                {% else %}
                  <span class="text-[10px] text-gray-400">خوانده‌شده</span>
                {% endif %}
              </div>
            </div>
          </li>
        {% endfor %}
      {% else %}
        <li class="p-6 rounded-2xl bg-white dark:bg-gray-800 text-center text-sm text-gray-500">
          فعلاً اعلانی ندارید.
        </li>
      {% endif %}
    </ul>
  </main>

  <script>
    // خواندن کوکی برای CSRF
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function postJSON(url, data){
      const csrf = getCookie("XSRF-TOKEN");
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          // سازگار با Flask-WTF CSRF
          "X-CSRFToken": csrf || "",
          "X-CSRF-Token": csrf || ""
        },
        body: JSON.stringify(data||{})
      });
      try { return await res.json(); } catch { return { ok: res.ok }; }
    }

    // علامت‌گذاری همه
    document.getElementById("mark-all")?.addEventListener("click", async ()=>{
      const res = await postJSON("{{ url_for('main.api_notifications_mark_all_read') }}");
      if(res.ok){ location.reload(); }
    });

    // علامت‌گذاری تکی
    document.querySelectorAll(".mark-read").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.id;
        const res = await postJSON("{{ url_for('main.api_notifications_mark_read') }}", {id});
        if(res.ok){ location.reload(); }
      });
    });
  </script>
</body>
</html>
