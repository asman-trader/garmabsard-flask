{% extends "base.html" %}
{% set hide_header = True %}

{% block title %}اعلان‌ها | وینور{% endblock %}

{% block content %}
  <main class="max-w-md mx-auto p-4 sm:p-6">

    <!-- لیست اعلان‌ها -->
    <ul class="space-y-3">
      {% if items and items|length %}
        {% for n in items %}
          {% set ntype = n.ntype or n.type %}
          {% set is_read = (n.is_read if n.is_read is not none else n.read) %}
          <li class="p-3 rounded-2xl bg-white dark:bg-gray-800 shadow flex gap-3 items-start">
            <div class="w-9 h-9 rounded-xl flex items-center justify-center
              {% if ntype == 'success' %} bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-300
              {% elif ntype == 'warning' %} bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-300
              {% elif ntype == 'error' %} bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300
              {% elif ntype == 'status' or ntype == 'info' %} bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300
              {% else %} bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-200{% endif %}">
              <i class="fa-solid
                {% if ntype=='success' %}fa-circle-check
                {% elif ntype=='warning' %}fa-triangle-exclamation
                {% elif ntype=='error' %}fa-circle-xmark
                {% elif ntype=='status' or ntype=='info' %}fa-bullhorn
                {% else %}fa-bell{% endif %}"></i>
            </div>

            <div class="flex-1">
              <div class="flex items-center justify-between gap-3">
                <h3 class="font-semibold text-sm line-clamp-2">{{ n.title }}</h3>
                <span class="text-[11px] text-gray-400 shrink-0">{{ n.created_at | time_ago }}</span>
              </div>

              <p class="text-sm mt-1 leading-6">{{ n.body }}</p>

              <div class="mt-2 flex items-center gap-2">
                {% if n.action_url %}
                  <a href="{{ n.action_url }}"
                     class="text-xs px-2 py-1 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition">
                    مشاهده
                  </a>
                {% endif %}

                <span class="text-[10px] text-gray-400">خوانده‌شده</span>
              </div>
            </div>
          </li>
        {% endfor %}
      {% else %}
        <li class="p-6 rounded-2xl bg-white dark:bg-gray-800 text-center text-sm text-gray-500">
          فعلاً اعلانی ندارید.
        </li>
      {% endif %}
    </ul>
  </main>

  <!-- صدای اعلان -->
  <audio id="notif-audio" preload="auto">
    <source src="{{ url_for('static', filename='sounds/notify.mp3') }}" type="audio/mpeg">
  </audio>

  <script id="notif-config" type="application/json">{{ {
    'mark_all_read_url': mark_all_read_url|default(''),
    'mark_one_read_url': mark_one_read_url|default(''),
    'unread_count_url':  unread_count_url|default(''),
    'vapid_public_key':  VAPID_PUBLIC_KEY|default('')
  }|tojson }}</script>

  <script>
    // ===== Config injected from server (parsed from JSON to avoid lint errors) =====
    const __cfgEl = document.getElementById('notif-config');
    const __cfg = __cfgEl ? JSON.parse(__cfgEl.textContent || '{}') : {};
    const MARK_ALL_READ_URL = __cfg.mark_all_read_url || '';
    const MARK_ONE_READ_URL = __cfg.mark_one_read_url || '';
    const UNREAD_COUNT_URL  = __cfg.unread_count_url  || '';
    const VAPID_PUBLIC_KEY  = window.VAPID_PUBLIC_KEY || __cfg.vapid_public_key || '';

    // ===== Utils =====
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    async function postJSON(url, data){
      const csrf = getCookie("XSRF-TOKEN") || getCookie("csrf_token");
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          ...(csrf ? {"X-CSRFToken": csrf, "X-CSRF-Token": csrf} : {})
        },
        body: JSON.stringify(data||{})
      });
      try { return await res.json(); } catch { return { ok: res.ok }; }
    }
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    // ===== Sound unlock on first interaction =====
    let soundEnabled = false;
    const audioEl = document.getElementById('notif-audio');
    function enableSoundOnce(){
      if (soundEnabled) return;
      audioEl.play().then(() => {
        audioEl.pause();
        soundEnabled = true;
        window.removeEventListener('pointerdown', enableSoundOnce, { once:true });
      }).catch(() => {});
    }
    enableSoundOnce();
    window.addEventListener('pointerdown', enableSoundOnce, { once:true });

    function playNotifySound(){
      if (!soundEnabled) return;
      audioEl.currentTime = 0;
      audioEl.play().catch(()=>{});
    }

    // ===== Service Worker =====
    async function ensureSW(){
      if (!('serviceWorker' in navigator)) return null;
      const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/', updateViaCache: 'none' });
      try { await reg.update(); } catch {}
      return reg;
    }

    // ===== Push =====
    let _publicKeyCache = VAPID_PUBLIC_KEY || '';
    let _publicKeyPromise = null;
    async function fetchPublicKey(){
      if (_publicKeyCache) return _publicKeyCache;
      if (_publicKeyPromise) return _publicKeyPromise;
      _publicKeyPromise = (async () => {
        try {
          const r = await fetch('/api/push/config', { cache: 'no-store' });
          const d = await r.json();
          _publicKeyCache = d.publicKey || '';
          return _publicKeyCache;
        } catch { _publicKeyCache = ''; return ''; }
        finally { _publicKeyPromise = null; }
      })();
      return _publicKeyPromise;
    }

    const NOTIF_DENIED_KEY = 'vinor_notif_denied_at';
    function shouldAskPermission(){
      if (!('Notification' in window)) return false;
      if (Notification.permission !== 'default') return false;
      const t = localStorage.getItem(NOTIF_DENIED_KEY);
      if (!t) return true;
      return (Date.now() - parseInt(t,10)) > 12*60*60*1000; // 12h
    }

    async function requestNotificationPermissionIfNeeded(){
      if (!('Notification' in window)) return 'denied';
      if (Notification.permission === 'granted') return 'granted';
      if (Notification.permission === 'denied') return 'denied';
      if (!shouldAskPermission()) return 'default';
      const p = await Notification.requestPermission();
      if (p === 'denied') localStorage.setItem(NOTIF_DENIED_KEY, String(Date.now()));
      return p;
    }

    const PUSH_LOCAL_FLAG = 'vinor_push_registered';
    async function ensurePushSubscription(reg){
      if (!reg || !('pushManager' in reg)) return null;
      let sub = await reg.pushManager.getSubscription();
      if (!sub) {
        const publicKey = await fetchPublicKey();
        if (!publicKey) return null;
        sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey)
        });
      }
      if (!localStorage.getItem(PUSH_LOCAL_FLAG)) {
        const res = await fetch('/api/push/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(sub)
        }).then(r=>r.json()).catch(()=>({}));
        if (res && res.ok) localStorage.setItem(PUSH_LOCAL_FLAG, '1');
      }
      return sub;
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (e)=>{
        if (e?.data?.type === 'PUSH_RECEIVED') playNotifySound();
      });
    }

    // ===== Auto flow (silent) =====
    (async ()=>{
      const perm = await requestNotificationPermissionIfNeeded();
      const reg  = await ensureSW();
      if (perm === 'granted' && reg) await ensurePushSubscription(reg);
    })();

    // خوانده‌شدن خودکار هنگام ورود به صفحه اعمال شده است (بدون دکمه)
  </script>
{% endblock %}

{# حذف میانبر/دکمه شناور ثبت آگهی #}
{% block floating_action %}{% endblock %}
