<!DOCTYPE html>
<html lang="fa" dir="rtl" itemscope itemtype="https://schema.org/CollectionPage">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  {# SEO Meta Tags #}
  <title>{{ seo.title if seo else 'فایل‌های اکسپرس وینور' }}</title>
  <meta name="description" content="{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور. مشاهده قیمت، موقعیت و جزئیات کامل فایل‌های معتبر برای خرید و فروش ملک.' }}">
  <meta name="keywords" content="{{ seo.keywords if seo else 'فایل اکسپرس, خرید ملک, فروش ملک, زمین, ویلایی, آپارتمان, وینور' }}">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <meta name="author" content="وینور اکسپرس | vinor.ir">
  <meta name="language" content="fa">
  <link rel="canonical" href="{{ seo.canonical if seo else request.url }}">
  
  {# Open Graph / Facebook #}
  <meta property="og:type" content="{{ seo.og_type if seo else 'website' }}">
  <meta property="og:url" content="{{ seo.canonical if seo else request.url }}">
  <meta property="og:title" content="{{ seo.title if seo else 'فایل‌های اکسپرس وینور' }}">
  <meta property="og:description" content="{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور' }}">
  <meta property="og:image" content="{{ seo.og_image if seo else request.url_root + 'static/icons/icon-512.png' }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:locale" content="fa_IR">
  <meta property="og:site_name" content="وینور اکسپرس | vinor.ir">
  
  {# Twitter Card #}
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ seo.title if seo else 'فایل‌های اکسپرس وینور' }}">
  <meta name="twitter:description" content="{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور' }}">
  <meta name="twitter:image" content="{{ seo.og_image if seo else request.url_root + 'static/icons/icon-512.png' }}">
  
  {# Favicon #}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjkM7yC4GdZ7+6puj8m0yP0A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: 'Vazirmatn', sans-serif; }
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    @media (max-width: 640px) {
      nav[class*="fixed"] {
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
    }
    /* Instagram-style grid */
    .instagram-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
    }
    @media (max-width: 640px) {
      .instagram-grid {
        gap: 1px;
      }
    }
    .instagram-item {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
      background: #000;
      cursor: pointer;
    }
    .instagram-item img,
    .instagram-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    .instagram-item:hover img,
    .instagram-item:hover video {
      transform: scale(1.05);
    }
    .instagram-item::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0);
      transition: background 0.2s ease;
    }
    .instagram-item:hover::after {
      background: rgba(0, 0, 0, 0.1);
    }
    .lazy-img {
      filter: blur(12px);
      transform: scale(1.05);
      background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
      transition: filter 0.25s ease, transform 0.25s ease, opacity 0.2s ease;
    }
    .dark .lazy-img {
      background: linear-gradient(90deg, #1f2937 0%, #111827 50%, #1f2937 100%);
    }
    .lazy-img.is-loaded {
      filter: blur(0);
      transform: scale(1);
      background: transparent;
    }
    .loading-spinner {
      display: none !important; /* مخفی کردن loading indicator - لودینگ در پس‌زمینه */
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .loading-spinner div {
      width: 2rem;
      height: 2rem;
      border: 3px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Pull to Refresh Indicator - مینیمال */
    #pullToRefreshIndicator {
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    #refreshIcon {
      transition: transform 0.2s ease;
    }
    #refreshIcon.spinning {
      animation: spin 0.6s linear infinite;
    }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen bg-white dark:bg-gray-900">
    <!-- Header - سبک دیوار (تمام‌عرض) -->
    <header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-100 dark:border-gray-800 w-full">
      <div class="w-full px-4 py-2.5 flex items-center gap-2">
        <!-- دکمه برگشت -->
        {% if show_back_button or session.get('user_phone') %}
        <a href="{{ url_for('express_partner.dashboard') }}" 
           class="w-9 h-9 flex-shrink-0 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 transition-colors"
           aria-label="بازگشت">
          <i class="fas fa-arrow-right text-sm"></i>
        </a>
        {% else %}
        <a href="{{ url_for('main.index') }}" 
           class="w-9 h-9 flex-shrink-0 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 transition-colors"
           aria-label="بازگشت">
          <i class="fas fa-arrow-right text-sm"></i>
        </a>
        {% endif %}
        <!-- باکس جستجو -->
        <form method="GET" action="{{ url_for('main.express_public_list') }}" class="flex-1 min-w-0" id="searchForm">
          <div class="relative w-full">
            <div class="flex items-center bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 focus-within:border-blue-500 dark:focus-within:border-blue-400 focus-within:shadow-sm transition-all">
              <input type="text"
                     name="q"
                     id="searchInput"
                     value="{{ search_query or '' }}"
                     placeholder="جستجو در فایل‌ها..."
                     autocomplete="off"
                     class="flex-1 bg-transparent border-0 outline-none text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 py-2.5 px-4 min-w-0">
              <div class="flex items-center gap-1 pr-2">
                {% if search_query %}
                <a href="{{ url_for('main.express_public_list') }}"
                   class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                   aria-label="پاک کردن جستجو">
                  <i class="fas fa-times text-xs"></i>
                </a>
                {% endif %}
                <button type="submit"
                        class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                        aria-label="جستجو">
                  <i class="fas fa-magnifying-glass text-sm"></i>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </header>

    <div class="max-w-6xl mx-auto pt-0 px-0 pb-16" id="exploreContainer">

      <!-- Pull to Refresh Indicator - مینیمال -->
      <div id="pullToRefreshIndicator" class="fixed top-2 left-1/2 transform -translate-x-1/2 z-40 pointer-events-none opacity-0 transition-all duration-200">
        <div id="refreshIcon" class="w-8 h-8 rounded-full bg-white dark:bg-gray-800 shadow-lg flex items-center justify-center border border-gray-200 dark:border-gray-700">
          <i class="fas fa-sync-alt text-blue-600 dark:text-blue-400 text-sm"></i>
        </div>
      </div>

      <!-- Grid اینستاگرام - 3 ستون -->
      <div id="instagramGrid" class="instagram-grid mb-4">
        {% for land in lands %}
          {% set img = (land.images[0] if land.images and land.images[0] else None) %}
          {% set video = land.video %}
          {% set thumb_src = land.image_thumb if land.image_thumb else None %}
          {% set full_src = land.image_full if land.image_full else None %}
          <a href="{{ url_for('main.express_detail', code=land.code) }}" 
             class="instagram-item"
             data-code="{{ land.code }}">
            {% if video %}
              {% if "://" in (video|string) %}
                {% set video_src = video %}
              {% elif (video|string).startswith('/uploads/') %}
                {% set video_src = video %}
              {% elif (video|string).startswith('uploads/') %}
                {% set video_src = '/uploads/' + (video|string)[8:] %}
              {% elif not (video|string).startswith('/') %}
                {% set video_src = '/uploads/' + (video|string) %}
              {% else %}
                {% set video_src = video %}
              {% endif %}
              <video class="w-full h-full object-cover" autoplay muted loop playsinline>
                <source src="{{ video_src }}" type="video/mp4">
                {% if img %}
                  {% if "://" in (img|string) %}
                    {% set img_src = img %}
                  {% elif (img|string).startswith('/uploads/') %}
                    {% set img_src = img %}
                  {% elif (img|string).startswith('uploads/') %}
                    {% set img_src = '/uploads/' + (img|string)[8:] %}
                  {% elif not (img|string).startswith('/') %}
                    {% set img_src = '/uploads/' + (img|string) %}
                  {% else %}
                    {% set img_src = img %}
                  {% endif %}
                  {% set thumb_src = thumb_src or img_src %}
                  {% set full_src = full_src or img_src %}
                  <img src="data:image/gif;base64,R0lGODlhAQABAAAAACw=" data-src="{{ thumb_src or img_src }}" data-full="{{ full_src or img_src }}" alt="{{ land.title or '' }}" loading="lazy" decoding="async" class="lazy-img">
                {% endif %}
              </video>
            {% elif img %}
              {% if "://" in (img|string) %}
                {% set img_src = img %}
              {% elif (img|string).startswith('/uploads/') %}
                {% set img_src = img %}
              {% elif (img|string).startswith('uploads/') %}
                {% set img_src = '/uploads/' + (img|string)[8:] %}
              {% elif not (img|string).startswith('/') %}
                {% set img_src = '/uploads/' + (img|string) %}
              {% else %}
                {% set img_src = img %}
              {% endif %}
              {% set thumb_src = thumb_src or img_src %}
              {% set full_src = full_src or img_src %}
              <img src="data:image/gif;base64,R0lGODlhAQABAAAAACw=" data-src="{{ thumb_src }}" data-full="{{ full_src }}" alt="{{ land.title or '' }}" loading="lazy" decoding="async" class="lazy-img">
            {% else %}
              <div class="w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                <i class="fas fa-image text-2xl text-gray-400 dark:text-gray-500"></i>
              </div>
            {% endif %}
          </a>
        {% endfor %}
      </div>


      <!-- Loading indicator برای infinite scroll -->
      <div id="loadingIndicator" class="loading-spinner hidden">
        <div></div>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="{% if lands and lands|length > 0 %}hidden{% endif %} bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-12 text-center mt-4 mx-3 sm:mx-4">
        <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center mx-auto mb-4">
          <i class="fa-solid fa-star text-2xl text-gray-400 dark:text-gray-600"></i>
        </div>
        <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-2">هنوز فایل اکسپرس ثبت نشده</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">به زودی فایل‌های جدید اضافه می‌شوند</p>
      </div>
    </div>
  </div>

  {# Structured Data (JSON-LD) - CollectionPage #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "فایل‌های اکسپرس وینور",
    "description": "{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور' }}",
    "url": "{{ seo.canonical if seo else request.url }}",
    "mainEntity": {
      "@type": "ItemList",
      "numberOfItems": {{ pagination.total if pagination else 0 }},
      "itemListElement": [
        {% for land in lands %}
        {
          "@type": "ListItem",
          "position": {{ loop.index }},
          "item": {
            "@type": "Product",
            "name": "{{ land.title or 'فایل اکسپرس' }}",
            "description": "{{ land.location or '' }} - {{ land.size or '' }} متر",
            "url": "{{ request.url_root }}express/{{ land.code }}",
            {% if land.price_total %}
            "offers": {
              "@type": "Offer",
              "price": "{{ land.price_total }}",
              "priceCurrency": "IRR"
            },
            {% endif %}
            {% if land.images and land.images|length > 0 %}
            {% set first_img = land.images[0] if land.images is iterable else land.images %}
            {% if "://" in (first_img|string) %}
            "image": "{{ first_img }}"
            {% elif (first_img|string).startswith('/uploads/') %}
            "image": "{{ request.url_root.rstrip('/') }}{{ first_img }}"
            {% else %}
            "image": "{{ request.url_root.rstrip('/') }}/uploads/{{ first_img }}"
            {% endif %}
            {% endif %}
          }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    },
    "publisher": {
      "@type": "Organization",
      "name": "وینور اکسپرس",
      "url": "{{ request.url_root.rstrip('/') }}"
    }
  }
  </script>

  <script>
    // فعال‌سازی تم تیره براساس تنظیم سیستم
    (function() {
      try {
        const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        if (mq && mq.matches) {
          document.documentElement.classList.add('dark');
        }
        if (mq) {
          mq.addEventListener('change', (e) => {
            if (e.matches) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          });
        }
      } catch (_) {}
    })();

    // Pull to Refresh - مینیمال و سریع (سبک اینستاگرام)
    (function() {
      const container = document.getElementById('exploreContainer');
      const grid = document.getElementById('instagramGrid');
      const pullIndicator = document.getElementById('pullToRefreshIndicator');
      const refreshIcon = document.getElementById('refreshIcon');
      
      if (!container || !pullIndicator || !grid) return;

      let startY = 0;
      let currentY = 0;
      let isPulling = false;
      let isRefreshing = false;
      const PULL_THRESHOLD = 60; // کاهش threshold برای رفرش سریع‌تر
      const MAX_PULL = 80; // کاهش max pull برای مینیمال بودن

      function handleTouchStart(e) {
        // فقط اگر در بالای صفحه هستیم
        if (window.scrollY > 5 || isRefreshing) return;
        
        startY = e.touches[0].clientY;
        isPulling = false;
      }

      function handleTouchMove(e) {
        if (window.scrollY > 5 || isRefreshing) return;
        
        currentY = e.touches[0].clientY;
        const pullDistance = currentY - startY;

        if (pullDistance > 0 && pullDistance < MAX_PULL) {
          isPulling = true;
          e.preventDefault();
          
          // نمایش indicator با انیمیشن smooth
          const progress = Math.min(pullDistance / PULL_THRESHOLD, 1);
          const opacity = progress;
          const scale = 0.8 + (progress * 0.2); // از 0.8 تا 1.0
          const rotation = progress * 180; // چرخش آیکون
          
          pullIndicator.style.opacity = opacity.toString();
          pullIndicator.style.transform = `translate(-50%, ${Math.min(pullDistance * 0.5, 40)}px)`;
          refreshIcon.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
          
          // اسکرول grid به پایین
          grid.style.transform = `translateY(${Math.min(pullDistance * 0.3, 30)}px)`;
          grid.style.transition = 'none';
          
          // شروع چرخش آیکون وقتی به threshold رسید
          if (pullDistance >= PULL_THRESHOLD) {
            refreshIcon.classList.add('spinning');
          } else {
            refreshIcon.classList.remove('spinning');
          }
        }
      }

      function handleTouchEnd(e) {
        if (!isPulling || isRefreshing) return;
        
        const pullDistance = currentY - startY;
        
        if (pullDistance >= PULL_THRESHOLD) {
          // شروع رفرش
          isRefreshing = true;
          refreshIcon.classList.add('spinning');
          
          // انیمیشن smooth برای grid
          grid.style.transition = 'transform 0.3s ease-out';
          grid.style.transform = 'translateY(0)';
          
          // رفرش سریع صفحه
          setTimeout(() => {
            window.location.reload();
          }, 200);
        } else {
          // بازگشت به حالت اولیه با انیمیشن
          resetPullIndicator();
        }
        
        isPulling = false;
        startY = 0;
        currentY = 0;
      }

      function resetPullIndicator() {
        pullIndicator.style.opacity = '0';
        pullIndicator.style.transform = 'translate(-50%, 0)';
        refreshIcon.style.transform = 'scale(0.8) rotate(0deg)';
        refreshIcon.classList.remove('spinning');
        grid.style.transition = 'transform 0.3s ease-out';
        grid.style.transform = 'translateY(0)';
      }

      // Event listeners
      document.addEventListener('touchstart', handleTouchStart, { passive: true });
      document.addEventListener('touchmove', handleTouchMove, { passive: false });
      document.addEventListener('touchend', handleTouchEnd, { passive: true });
    })();

    // Infinite Scroll - سبک اینستاگرام
    (function() {
      const grid = document.getElementById('instagramGrid');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const searchInput = document.getElementById('searchInput');
      const cardsList = document.getElementById('cardsList');
      const emptyState = document.getElementById('emptyState');
      
      if (!grid) return;

      let currentPage = 1;
      let isLoading = false;
      let hasMore = true;
      let searchQuery = '{{ search_query or '' }}';

      // تابع برای ساخت URL تصویر/ویدئو
      function getMediaUrl(media) {
        if (!media) return '';
        const mediaStr = String(media);
        if (mediaStr.includes('://')) return mediaStr;
        if (mediaStr.startsWith('/uploads/')) return mediaStr;
        if (mediaStr.startsWith('uploads/')) return '/uploads/' + mediaStr.substring(8);
        return '/uploads/' + mediaStr;
      }

      // تابع برای render کردن یک آیتم
      const PLACEHOLDER_PIXEL = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

      function renderItem(land) {
        const images = Array.isArray(land.images) ? land.images : (land.images ? [land.images] : []);
        const cover = images[0] || null;
        const video = land.video;
        const coverUrlRaw = cover ? getMediaUrl(cover) : '';
        const coverThumb = land.image_thumb || coverUrlRaw;
        const coverFull = land.image_full || land.image_raw || coverUrlRaw;
        const videoUrl = video ? getMediaUrl(video) : '';
        const title = land.title || '';

        let mediaHtml = '';
        if (videoUrl) {
          mediaHtml = `
            <video class="w-full h-full object-cover" autoplay muted loop playsinline>
              <source src="${videoUrl}" type="video/mp4">
              ${coverThumb ? `<img src="${PLACEHOLDER_PIXEL}" data-src="${coverThumb}" data-full="${coverFull}" alt="${title}" loading="lazy" decoding="async" class="lazy-img">` : ''}
            </video>
          `;
        } else if (coverThumb) {
          mediaHtml = `<img src="${PLACEHOLDER_PIXEL}" data-src="${coverThumb}" data-full="${coverFull}" alt="${title}" loading="lazy" decoding="async" class="lazy-img">`;
        } else {
          mediaHtml = `
            <div class="w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
              <i class="fas fa-image text-2xl text-gray-400 dark:text-gray-500"></i>
            </div>
          `;
        }

        return `
          <a href="/express/${land.code || ''}" 
             class="instagram-item"
             data-code="${land.code || ''}">
            ${mediaHtml}
          </a>
        `;
      }
      const renderGridItem = renderItem;
      const renderCardItem = renderItem;

      // Lazy loading: فقط آیتم‌های داخل viewport دانلود شوند
      const lazyObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            const src = img.getAttribute('data-src');
            if (src) {
              img.src = src;
              img.removeAttribute('data-src');
            }
            img.addEventListener('load', () => img.classList.add('is-loaded'), { once: true });
            img.addEventListener('error', () => img.classList.add('is-loaded'), { once: true });
            lazyObserver.unobserve(img);
          }
        });
      }, { rootMargin: '200px 0px', threshold: 0.01 });

      function bindLazyImages(scope = document) {
        const imgs = scope.querySelectorAll('img.lazy-img');
        imgs.forEach(img => {
          if (img.dataset.lazyBound === "1") return;
          img.dataset.lazyBound = "1";
          lazyObserver.observe(img);
        });
      }
      bindLazyImages(document);

      // تابع برای بارگذاری صفحه بعد
      async function loadNextPage() {
        if (isLoading || !hasMore) return;

        isLoading = true;
        // loadingIndicator.classList.remove('hidden'); // loading indicator همیشه مخفی است
        currentPage++;

        try {
          const url = `/api/express-list?page=${currentPage}&per_page=30${searchQuery ? '&q=' + encodeURIComponent(searchQuery) : ''}`;
          const response = await fetch(url);
          const data = await response.json();

          if (data.success && data.lands && data.lands.length > 0) {
            const gridItemsHtml = data.lands.map(renderGridItem).join('');
            grid.insertAdjacentHTML('beforeend', gridItemsHtml);
            bindLazyImages(grid);
            
            hasMore = data.pagination.has_next;
            // loadingIndicator.classList.add('hidden'); // loading indicator همیشه مخفی است
          } else {
            hasMore = false;
            // loadingIndicator.classList.add('hidden');
          }
        } catch (error) {
          console.error('Error loading next page:', error);
          hasMore = false;
          // loadingIndicator.classList.add('hidden');
        } finally {
          isLoading = false;
        }
      }

      // Intersection Observer برای infinite scroll
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && hasMore && !isLoading) {
            loadNextPage();
          }
        });
      }, {
        rootMargin: '200px'
      });

      // مشاهده loading indicator
      if (loadingIndicator) {
        observer.observe(loadingIndicator);
      }

      // جستجوی زنده
      if (searchInput) {
        let searchTimeout = null;

        function debounce(func, wait) {
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(searchTimeout);
              func(...args);
            };
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(later, wait);
          };
        }

        async function performSearch(query) {
          searchQuery = query;
          currentPage = 1;
          hasMore = true;
          isLoading = true;
          
          grid.innerHTML = '';
          if (cardsList) { cardsList.innerHTML = ''; }
          // loadingIndicator.classList.remove('hidden'); // loading indicator همیشه مخفی است
          emptyState.classList.add('hidden');

          try {
            const url = `/api/express-list?page=1&per_page=30${query ? '&q=' + encodeURIComponent(query) : ''}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.success && data.lands && data.lands.length > 0) {
              const gridItemsHtml = data.lands.map(renderGridItem).join('');
              const cardItemsHtml = data.lands.map(renderCardItem).join('');
              grid.innerHTML = gridItemsHtml;
              if (cardsList) { cardsList.innerHTML = cardItemsHtml; }
              bindLazyImages(grid);
              emptyState.classList.add('hidden');
              hasMore = data.pagination.has_next;
              // loadingIndicator.classList.add('hidden'); // loading indicator همیشه مخفی است
            } else {
              grid.innerHTML = '';
              if (cardsList) { cardsList.innerHTML = ''; }
              emptyState.classList.remove('hidden');
              // loadingIndicator.classList.add('hidden');
              hasMore = false;
            }
          } catch (error) {
            console.error('Search error:', error);
            grid.innerHTML = '';
            emptyState.classList.remove('hidden');
            // loadingIndicator.classList.add('hidden');
            hasMore = false;
          } finally {
            isLoading = false;
          }
        }

        searchInput.addEventListener('input', debounce(function(e) {
          const query = e.target.value.trim();
          if (query.length >= 2) {
            performSearch(query);
          } else if (query.length === 0) {
            window.location.href = '{{ url_for("main.express_public_list") }}';
          }
        }, 300));

        document.getElementById('searchForm')?.addEventListener('submit', function(e) {
          e.preventDefault();
          const query = searchInput.value.trim();
          if (query.length >= 2) {
            performSearch(query);
          }
        });
      }

      // Initialize - بررسی اینکه آیا صفحه بعدی وجود دارد
      {% if pagination and pagination.pages > pagination.page %}
        hasMore = true;
      {% else %}
        hasMore = false;
        loadingIndicator.classList.add('hidden');
      {% endif %}
    })();
  </script>

  {# Bottom Navigation – منوی اصلی اپ در صفحه اکسپلور #}
  {% set bottom_nav_active = 'explore' %}
  {% include 'partials/landing_bottom_nav.html' %}

</body>
</html>
