<!DOCTYPE html>
<html lang="fa" dir="rtl" itemscope itemtype="https://schema.org/CollectionPage">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  {# SEO Meta Tags #}
  <title>{{ seo.title if seo else 'فایل‌های اکسپرس وینور' }}</title>
  <meta name="description" content="{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور. مشاهده قیمت، موقعیت و جزئیات کامل فایل‌های معتبر برای خرید و فروش ملک.' }}">
  <meta name="keywords" content="{{ seo.keywords if seo else 'فایل اکسپرس, خرید ملک, فروش ملک, زمین, ویلایی, آپارتمان, وینور' }}">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <meta name="author" content="وینور | vinor.ir">
  <meta name="language" content="fa">
  <link rel="canonical" href="{{ seo.canonical if seo else request.url }}">
  
  {# Open Graph / Facebook #}
  <meta property="og:type" content="{{ seo.og_type if seo else 'website' }}">
  <meta property="og:url" content="{{ seo.canonical if seo else request.url }}">
  <meta property="og:title" content="{{ seo.title if seo else 'فایل‌های اکسپرس وینور' }}">
  <meta property="og:description" content="{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور' }}">
  <meta property="og:image" content="{{ seo.og_image if seo else request.url_root + 'static/icons/icon-512.png' }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:locale" content="fa_IR">
  <meta property="og:site_name" content="وینور | vinor.ir">
  
  {# Twitter Card #}
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ seo.title if seo else 'فایل‌های اکسپرس وینور' }}">
  <meta name="twitter:description" content="{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور' }}">
  <meta name="twitter:image" content="{{ seo.og_image if seo else request.url_root + 'static/icons/icon-512.png' }}">
  
  {# Favicon #}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjkM7yC4GdZ7+6puj8m0yP0A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: 'Vazirmatn', sans-serif; }
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    @media (max-width: 640px) {
      nav[class*="fixed"] {
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
    }
    #cardsTrack {
      min-height: calc(100vh - 150px);
    }
    @media (max-width: 640px) {
      #cardsTrack {
        min-height: calc(100vh - 130px);
      }
    }
    .express-card {
      transition: box-shadow .2s ease, border-color .2s ease;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .express-card:hover {
      transform: translateY(-1px);
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900 pb-16">
    <!-- Header - سبک دیوار (تمام‌عرض) -->
    <header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
      <div class="w-full px-4 h-14 flex items-center justify-center">
        <h1 class="text-sm font-bold text-gray-900 dark:text-white">
          اکسپلور
        </h1>
      </div>
    </header>

    <div class="max-w-6xl mx-auto pt-0 px-3 sm:px-4 pb-16">
      <!-- نوار جستجو - زیر هدر -->
      <div class="mt-2 mb-3">
        <form method="GET" action="{{ url_for('main.express_public_list') }}" class="w-full" id="searchForm">
          <div class="relative w-full">
            <div class="flex items-center bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 focus-within:border-blue-500 dark:focus-within:border-blue-400 focus-within:shadow-sm transition-all">
              <input type="text"
                     name="q"
                     id="searchInput"
                     value="{{ search_query or '' }}"
                     placeholder="جستجو در فایل‌ها..."
                     autocomplete="off"
                     class="flex-1 bg-transparent border-0 outline-none text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 py-2.5 px-4 min-w-0">
              <div class="flex items-center gap-1 pr-2">
                {% if search_query %}
                <a href="{{ url_for('main.express_public_list') }}"
                   class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                   aria-label="پاک کردن جستجو">
                  <i class="fas fa-times text-xs"></i>
                </a>
                {% endif %}
                <button type="submit"
                        class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                        aria-label="جستجو">
                  <i class="fas fa-magnifying-glass text-sm"></i>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      {% if lands and lands|length == 0 %}
        <div class="mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-8 text-center">
          <div class="flex flex-col items-center gap-3">
            <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
              <i class="fas fa-inbox text-2xl text-gray-400 dark:text-gray-500"></i>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">هنوز فایلی ثبت نشده</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">به زودی فایل‌های جدید اضافه می‌شوند.</p>
            </div>
          </div>
        </div>
      {% endif %}

      <div class="mt-2 -mx-3 relative">
        <button type="button" id="cardsPrev" class="hidden sm:flex absolute right-1 top-1/2 -translate-y-1/2 z-10 w-9 h-9 rounded-full bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 shadow items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700">
          <i class="fas fa-chevron-right"></i>
        </button>
        <button type="button" id="cardsNext" class="hidden sm:flex absolute left-1 top-1/2 -translate-y-1/2 z-10 w-9 h-9 rounded-full bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 shadow items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700">
          <i class="fas fa-chevron-left"></i>
        </button>

        <div id="cardsTrack" class="px-3 flex flex-col sm:flex-row sm:flex-nowrap items-stretch gap-4 pb-4 sm:overflow-x-auto sm:snap-x sm:snap-mandatory no-scrollbar">
        {% for land in lands %}
          <article class="snap-start shrink-0 w-full sm:w-[320px] group express-card relative bg-white dark:bg-gray-900 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md" data-href="{{ url_for('main.express_detail', code=land.code) }}" role="link" tabindex="0">
            {% set img = (land.images[0] if land.images and land.images[0] else None) %}
            
            <!-- Image/Video Section - دیوار استایل -->
            <div class="relative aspect-[4/3] bg-gray-100 dark:bg-gray-800 overflow-hidden">
              {% set video = land.video %}
              {% if video %}
                {% if "://" in (video|string) %}
                  {% set video_src = video %}
                {% elif (video|string).startswith('/uploads/') %}
                  {% set video_src = video %}
                {% elif (video|string).startswith('uploads/') %}
                  {% set video_src = '/uploads/' + (video|string)[8:] %}
                {% elif not (video|string).startswith('/') %}
                  {% set video_src = '/uploads/' + (video|string) %}
                {% else %}
                  {% set video_src = video %}
                {% endif %}
                <video class="w-full h-full object-cover" autoplay muted loop playsinline>
                  <source src="{{ video_src }}" type="video/mp4">
                  {% if img %}
                    {% if "://" in (img|string) %}
                      {% set img_src = img %}
                    {% elif (img|string).startswith('/uploads/') %}
                      {% set img_src = img %}
                    {% elif (img|string).startswith('uploads/') %}
                      {% set img_src = '/uploads/' + (img|string)[8:] %}
                    {% elif not (img|string).startswith('/') %}
                      {% set img_src = '/uploads/' + (img|string) %}
                    {% else %}
                      {% set img_src = img %}
                    {% endif %}
                    <img src="{{ img_src }}" alt="{{ land.title }}" class="w-full h-full object-cover">
                  {% endif %}
                </video>
              {% elif img %}
                {% if "://" in (img|string) %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('/uploads/') %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('uploads/') %}
                  {% set img_src = '/uploads/' + (img|string)[8:] %}
                {% elif not (img|string).startswith('/') %}
                  {% set img_src = '/uploads/' + (img|string) %}
                {% else %}
                  {% set img_src = img %}
                {% endif %}
                <img src="{{ img_src }}" alt="{{ land.title }}" class="w-full h-full object-cover">
              {% else %}
                <div class="w-full h-full grid place-items-center text-gray-300 dark:text-gray-600">
                  <i class="fas fa-image text-3xl"></i>
                </div>
              {% endif %}
              
              <!-- Express Badge -->
              <div class="absolute top-2 left-2">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-[11px] font-medium bg-blue-600 text-white">
                  <i class="fas fa-bolt text-[9px]"></i>
                  Express
                </span>
              </div>
            </div>

            <!-- Content Section - سبک دیوار -->
            <div class="p-3">
              <!-- Title -->
              <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-2 leading-snug min-h-[2.5rem]">
                {{ land.title or '—' }}
              </h3>

              <!-- Price - بزرگ و برجسته -->
              <div class="mb-2">
                <div class="text-lg font-bold text-gray-900 dark:text-white">
                  {{ "{:,}".format(land.price_total | int) if land.price_total else "نامشخص" }} تومان
                </div>
                {% if land.price_per_meter %}
                <div class="text-xs text-gray-600 dark:text-gray-400 mt-0.5">
                  {{ "{:,}".format(land.price_per_meter | int) }} تومان در متر
                </div>
                {% endif %}
              </div>

              <!-- Details - ساده و تمیز -->
              <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-600 dark:text-gray-400 mb-2">
                {% if land.size %}
                  <span class="flex items-center gap-1">
                    <i class="fas fa-ruler-combined text-[10px]"></i>
                    {{ land.size }} متر
                  </span>
                {% endif %}
                {% if land.location or land.city %}
                  <span class="flex items-center gap-1">
                    <i class="fas fa-map-marker-alt text-[10px]"></i>
                    {{ land.location or (land.city or '') }}
                  </span>
                {% endif %}
                {% if land.category %}
                  <span class="flex items-center gap-1">
                    <i class="fas fa-tag text-[10px]"></i>
                    {{ land.category }}
                  </span>
                {% endif %}
              </div>

              <!-- Footer - تاریخ -->
              <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-800">
                {% if land.created_at %}
                  <span class="text-[11px] text-gray-500 dark:text-gray-500">
                    <span class="jalali-dt" data-dt="{{ land.created_at }}"></span>
                  </span>
                {% else %}
                  <span></span>
                {% endif %}
              </div>
            </div>
          </article>
        {% endfor %}
        </div>
      </div>
    </div>
  </div>

  {# Structured Data (JSON-LD) - CollectionPage #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "فایل‌های اکسپرس وینور",
    "description": "{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور' }}",
    "url": "{{ seo.canonical if seo else request.url }}",
    "mainEntity": {
      "@type": "ItemList",
      "numberOfItems": {{ pagination.total if pagination else 0 }},
      "itemListElement": [
        {% for land in lands %}
        {
          "@type": "ListItem",
          "position": {{ loop.index }},
          "item": {
            "@type": "Product",
            "name": "{{ land.title or 'فایل اکسپرس' }}",
            "description": "{{ land.location or '' }} - {{ land.size or '' }} متر",
            "url": "{{ request.url_root }}express/{{ land.code }}",
            {% if land.price_total %}
            "offers": {
              "@type": "Offer",
              "price": "{{ land.price_total }}",
              "priceCurrency": "IRR"
            },
            {% endif %}
            {% if land.images and land.images|length > 0 %}
            {% set first_img = land.images[0] if land.images is iterable else land.images %}
            {% if "://" in (first_img|string) %}
            "image": "{{ first_img }}"
            {% elif (first_img|string).startswith('/uploads/') %}
            "image": "{{ request.url_root.rstrip('/') }}{{ first_img }}"
            {% else %}
            "image": "{{ request.url_root.rstrip('/') }}/uploads/{{ first_img }}"
            {% endif %}
            {% endif %}
          }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    },
    "publisher": {
      "@type": "Organization",
      "name": "وینور",
      "url": "{{ request.url_root.rstrip('/') }}"
    }
  }
  </script>

  <script>
    // فعال‌سازی تم تیره براساس تنظیم سیستم
    (function() {
      try {
        const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        if (mq && mq.matches) {
          document.documentElement.classList.add('dark');
        }
        if (mq) {
          mq.addEventListener('change', (e) => {
            if (e.matches) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          });
        }
      } catch (_) {}
    })();

    // Make entire cards clickable with keyboard support
    document.querySelectorAll('.express-card[data-href]').forEach((card) => {
      card.addEventListener('click', () => {
        const href = card.getAttribute('data-href');
        if (href) window.location.assign(href);
      });
      card.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          const href = card.getAttribute('data-href');
          if (href) window.location.assign(href);
        }
      });
    });

    // Horizontal scroll controls for cards
    (function(){
      const track = document.getElementById('cardsTrack');
      const prev = document.getElementById('cardsPrev');
      const next = document.getElementById('cardsNext');
      if (!track || !prev || !next) return;
      function scrollByAmount(dir){
        const delta = Math.round((track.clientWidth || 300) * 0.9);
        const rtl = document.dir === 'rtl' || document.documentElement.getAttribute('dir') === 'rtl';
        const sign = (dir === 'next') ? (rtl ? -1 : 1) : (rtl ? 1 : -1);
        track.scrollBy({ left: sign * delta, behavior: 'smooth' });
      }
      prev.addEventListener('click', ()=>scrollByAmount('prev'));
      next.addEventListener('click', ()=>scrollByAmount('next'));
    })();

    // Convert dates to Persian (Jalali) format
    (function(){
      function fmt(dt){
        try{
          const d = new Date(String(dt||'').replace(' ','T'));
          if (isNaN(d.getTime())) return '';
          return d.toLocaleDateString('fa-IR', {
            timeZone: 'Asia/Tehran',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
        }catch(_){ return ''; }
      }
      document.querySelectorAll('.jalali-dt[data-dt]').forEach(el=>{
        const raw = el.getAttribute('data-dt')||'';
        const formatted = fmt(raw);
        el.textContent = formatted || '—';
      });
    })();

    // Pull-to-refresh functionality
    (function(){
      let startY = 0;
      let currentY = 0;
      let isPulling = false;
      let pullThreshold = 80;
      let refreshElement = null;

      function createRefreshElement() {
        const el = document.createElement('div');
        el.id = 'pull-refresh-indicator';
        el.className = 'fixed top-0 left-0 right-0 z-[100] bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 transform -translate-y-full transition-transform duration-300';
        el.innerHTML = `
          <div class="flex items-center justify-center py-4">
            <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400">
              <div class="w-6 h-6 border-2 border-gray-300 dark:border-gray-600 border-t-emerald-500 rounded-full animate-spin"></div>
              <span class="text-sm font-medium">در حال بروزرسانی...</span>
            </div>
          </div>
        `;
        document.body.appendChild(el);
        return el;
      }

      function showRefreshIndicator(progress) {
        if (!refreshElement) {
          refreshElement = createRefreshElement();
        }
        const translateY = Math.min(progress * 0.5, pullThreshold);
        refreshElement.style.transform = `translateY(${translateY - pullThreshold}px)`;

        if (progress >= pullThreshold) {
          refreshElement.querySelector('.text-gray-600').className = 'flex items-center gap-3 text-emerald-600 dark:text-emerald-400';
          refreshElement.querySelector('span').textContent = 'رها کنید برای بروزرسانی';
        } else {
          refreshElement.querySelector('.text-gray-600').className = 'flex items-center gap-3 text-gray-600 dark:text-gray-400';
          refreshElement.querySelector('span').textContent = 'کشیده و رها کنید';
        }
      }

      function hideRefreshIndicator() {
        if (refreshElement) {
          refreshElement.style.transform = 'translateY(-100%)';
          setTimeout(() => {
            if (refreshElement) {
              refreshElement.remove();
              refreshElement = null;
            }
          }, 300);
        }
      }

      function triggerRefresh() {
        if (refreshElement) {
          refreshElement.querySelector('.text-emerald-600').className = 'flex items-center gap-3 text-emerald-600 dark:text-emerald-400';
          refreshElement.querySelector('span').textContent = 'در حال بروزرسانی...';
          refreshElement.style.transform = 'translateY(0)';
        }

        setTimeout(() => {
          window.location.reload();
        }, 1000);
      }

      document.addEventListener('touchstart', function(e) {
        if (window.scrollY === 0) {
          startY = e.touches[0].clientY;
          isPulling = true;
        }
      }, { passive: true });

      document.addEventListener('touchmove', function(e) {
        if (isPulling && startY > 0) {
          currentY = e.touches[0].clientY;
          const pullDistance = currentY - startY;

          if (pullDistance > 0) {
            e.preventDefault();
            showRefreshIndicator(pullDistance);
          }
        }
      }, { passive: false });

      document.addEventListener('touchend', function(e) {
        if (isPulling) {
          const pullDistance = currentY - startY;

          if (pullDistance >= pullThreshold) {
            triggerRefresh();
          } else {
            hideRefreshIndicator();
          }

          startY = 0;
          currentY = 0;
          isPulling = false;
        }
      });
    })();

    // جستجوی زنده
    (function() {
      const searchInput = document.getElementById('searchInput');
      const cardsTrack = document.getElementById('cardsTrack');
      const baseUrl = '{{ request.url_root.rstrip("/") }}';
      
      if (!searchInput || !cardsTrack) return;

      let searchTimeout = null;
      let isSearching = false;

      function debounce(func, wait) {
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(searchTimeout);
            func(...args);
          };
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(later, wait);
        };
      }

      function getImageUrl(img) {
        if (!img) return '';
        const imgStr = String(img);
        if (imgStr.includes('://')) return imgStr;
        if (imgStr.startsWith('/uploads/')) return imgStr;
        if (imgStr.startsWith('uploads/')) return '/uploads/' + imgStr.substring(8);
        return '/uploads/' + imgStr;
      }

      function renderLandCard(land) {
        const images = Array.isArray(land.images) ? land.images : (land.images ? [land.images] : []);
        const cover = images[0] || null;
        const coverUrl = cover ? getImageUrl(cover) : '';
        const video = land.video;
        const videoUrl = video ? getImageUrl(video) : '';
        
        const title = land.title || '—';
        const location = land.location || '';
        const size = land.size || '';
        const category = land.category || '';
        const priceTotal = land.price_total ? Number(land.price_total).toLocaleString('fa-IR') : 'نامشخص';
        const pricePerMeter = land.price_per_meter ? Number(land.price_per_meter).toLocaleString('fa-IR') : '';
        const detailUrl = baseUrl + '/express/' + (land.code || '');
        const created_at = land.created_at || '';

        return `
          <article class="snap-start shrink-0 w-full sm:w-[320px] group express-card relative bg-white dark:bg-gray-900 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md" data-href="${detailUrl}" role="link" tabindex="0">
            <div class="relative aspect-[4/3] bg-gray-100 dark:bg-gray-800 overflow-hidden">
              ${videoUrl ? `
                <video class="w-full h-full object-cover" autoplay muted loop playsinline>
                  <source src="${videoUrl}" type="video/mp4">
                  ${coverUrl ? `<img src="${coverUrl}" alt="${title}" class="w-full h-full object-cover">` : ''}
                </video>
              ` : coverUrl ? `
                <img src="${coverUrl}" alt="${title}" class="w-full h-full object-cover">
              ` : `
                <div class="w-full h-full grid place-items-center text-gray-300 dark:text-gray-600">
                  <i class="fas fa-image text-3xl"></i>
                </div>
              `}
              <div class="absolute top-2 left-2">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-[11px] font-medium bg-blue-600 text-white">
                  <i class="fas fa-bolt text-[9px]"></i>
                  Express
                </span>
              </div>
            </div>
            <div class="p-3">
              <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-2 leading-snug min-h-[2.5rem]">${title}</h3>
              <div class="mb-2">
                <div class="text-lg font-bold text-gray-900 dark:text-white">${priceTotal} تومان</div>
                ${pricePerMeter ? `<div class="text-xs text-gray-600 dark:text-gray-400 mt-0.5">${pricePerMeter} تومان در متر</div>` : ''}
              </div>
              <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-600 dark:text-gray-400 mb-2">
                ${size ? `<span class="flex items-center gap-1"><i class="fas fa-ruler-combined text-[10px]"></i>${size} متر</span>` : ''}
                ${location ? `<span class="flex items-center gap-1"><i class="fas fa-map-marker-alt text-[10px]"></i>${location}</span>` : ''}
                ${category ? `<span class="flex items-center gap-1"><i class="fas fa-tag text-[10px]"></i>${category}</span>` : ''}
              </div>
              <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-800">
                ${created_at ? `<span class="text-[11px] text-gray-500 dark:text-gray-500"><span class="jalali-dt" data-dt="${created_at}"></span></span>` : '<span></span>'}
              </div>
            </div>
          </article>
        `;
      }

      async function performSearch(query) {
        if (isSearching) return;
        
        isSearching = true;
        cardsTrack.innerHTML = '<div class="col-span-full flex justify-center py-8"><div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div>';

        try {
          const response = await fetch(`/api/express-search?q=${encodeURIComponent(query)}`);
          const data = await response.json();
          
          if (data.success && data.lands && data.lands.length > 0) {
            cardsTrack.innerHTML = data.lands.map(renderLandCard).join('');
            // Re-attach click handlers
            document.querySelectorAll('.express-card[data-href]').forEach((card) => {
              card.addEventListener('click', () => {
                const href = card.getAttribute('data-href');
                if (href) window.location.assign(href);
              });
            });
            // Convert dates
            document.querySelectorAll('.jalali-dt[data-dt]').forEach(el=>{
              const raw = el.getAttribute('data-dt')||'';
              try{
                const d = new Date(String(raw).replace(' ','T'));
                if (!isNaN(d.getTime())) {
                  el.textContent = d.toLocaleDateString('fa-IR', {
                    timeZone: 'Asia/Tehran',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                  });
                }
              }catch(_){ el.textContent = '—'; }
            });
          } else {
            cardsTrack.innerHTML = '';
            cardsTrack.innerHTML = `
              <div class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-8 text-center">
                <div class="flex flex-col items-center gap-3">
                  <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                    <i class="fas fa-search text-2xl text-gray-400 dark:text-gray-500"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">نتیجه‌ای یافت نشد</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">لطفاً کلمه جستجوی دیگری را امتحان کنید</p>
                  </div>
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error('Search error:', error);
          cardsTrack.innerHTML = '';
          cardsTrack.innerHTML = `
            <div class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-8 text-center">
              <div class="flex flex-col items-center gap-3">
                <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                  <i class="fas fa-exclamation-circle text-2xl text-gray-400 dark:text-gray-500"></i>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">خطا در جستجو</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">لطفاً دوباره تلاش کنید</p>
                </div>
              </div>
            </div>
          `;
        } finally {
          isSearching = false;
        }
      }

      searchInput.addEventListener('input', debounce(function(e) {
        const query = e.target.value.trim();
        if (query.length >= 2) {
          performSearch(query);
        } else if (query.length === 0) {
          window.location.href = '{{ url_for("main.express_public_list") }}';
        }
      }, 300));

      document.getElementById('searchForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (query.length >= 2) {
          performSearch(query);
        }
      });
    })();
  </script>

  <!-- فوتر ناوبری - سبک همکاران -->
  <nav class="fixed inset-x-0 bottom-0 z-50 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 safe-area-bottom">
    <div class="max-w-md mx-auto">
      <div class="grid grid-cols-4 gap-0">
        {% set current_path = request.path %}
        {% set nav_items = [
          {
            'key': 'home',
            'url': url_for('main.index'),
            'icon': 'fa-home',
            'label': 'خانه',
            'is_active': (current_path == '/' or current_path == url_for('main.index'))
          },
          {
            'key': 'explore',
            'url': url_for('main.express_public_list'),
            'icon': 'fa-magnifying-glass',
            'label': 'اکسپلور',
            'is_active': (current_path.startswith('/public') or current_path.startswith('/express/'))
          },
          {
            'key': 'partners',
            'url': url_for('main.partners'),
            'icon': 'fa-users',
            'label': 'همکاران',
            'is_active': (current_path == url_for('main.partners'))
          },
          {
            'key': 'help',
            'url': url_for('main.help'),
            'icon': 'fa-question-circle',
            'label': 'راهنما',
            'is_active': (current_path == url_for('main.help') or current_path.startswith('/help'))
          }
        ] %}
        {% for item in nav_items %}
          <a href="{{ item.url }}"
             class="flex flex-col items-center justify-center gap-1 py-2.5 px-2 transition-colors duration-150 {{ 'text-blue-600 dark:text-blue-400' if item.is_active else 'text-gray-600 dark:text-gray-400' }} hover:text-gray-900 dark:hover:text-gray-100"
             aria-current="{{ 'page' if item.is_active else 'false' }}">
            <i class="fas {{ item.icon }} text-lg"></i>
            <span class="text-[11px] font-medium leading-tight">{{ item.label }}</span>
          </a>
        {% endfor %}
      </div>
    </div>
  </nav>
</body>
</html>
