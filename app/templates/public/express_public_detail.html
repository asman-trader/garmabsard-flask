<!DOCTYPE html>
<html lang="fa" dir="rtl" itemscope itemtype="https://schema.org/Product">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  {# SEO Meta Tags #}
  <title>{{ seo.title if seo else (land.title or 'فایل اکسپرس') }}</title>
  <meta name="description" content="{{ seo.description if seo else (land.title or 'فایل اکسپرس') }}">
  <meta name="keywords" content="{{ seo.keywords if seo else 'فایل اکسپرس, خرید ملک, فروش ملک, وینور' }}">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <meta name="author" content="وینور اکسپرس | vinor.ir">
  <meta name="language" content="fa">
  <link rel="canonical" href="{{ seo.canonical if seo else request.url }}">
  
  {# Open Graph / Facebook #}
  <meta property="og:type" content="{{ seo.og_type if seo else 'product' }}">
  <meta property="og:url" content="{{ seo.canonical if seo else request.url }}">
  <meta property="og:title" content="{{ seo.title if seo else (land.title or 'فایل اکسپرس') }}">
  <meta property="og:description" content="{{ seo.description if seo else (land.title or 'فایل اکسپرس') }}">
  <meta property="og:image" content="{{ seo.og_image if seo else request.url_root + 'static/icons/icon-512.png' }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:locale" content="fa_IR">
  <meta property="og:site_name" content="وینور اکسپرس | vinor.ir">
  {% if seo and seo.price %}
  <meta property="product:price:amount" content="{{ seo.price }}">
  <meta property="product:price:currency" content="{{ seo.currency or 'IRR' }}">
  {% endif %}
  
  {# Twitter Card #}
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ seo.title if seo else (land.title or 'فایل اکسپرس') }}">
  <meta name="twitter:description" content="{{ seo.description if seo else (land.title or 'فایل اکسپرس') }}">
  <meta name="twitter:image" content="{{ seo.og_image if seo else request.url_root + 'static/icons/icon-512.png' }}">
  
  {# Favicon #}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjkM7yC4GdZ7+6puj8m0yP0A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: 'Vazirmatn', sans-serif; }
    .glass { backdrop-filter: blur(18px); background: rgba(255, 255, 255, 0.9); }
    .dark .glass { background: rgba(15, 23, 42, 0.9); }
    .progressive-img {
      filter: blur(12px);
      background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
      transition: filter 0.25s ease, opacity 0.2s ease;
    }
    .dark .progressive-img {
      background: linear-gradient(90deg, #1f2937 0%, #111827 50%, #1f2937 100%);
    }
    .progressive-img.is-loaded {
      filter: blur(0);
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  {% set images = land.images or [] %}
  {% set images_v2 = land.images_v2 or [] %}
  {% set video = land.video %}
  {% set has_video = video and video.strip() %}
  {% set total_items = (1 if has_video else 0) + images|length %}
  {% set primary_image = images[0] if images else None %}
  {% set primary_image_v2 = images_v2[0] if images_v2 else None %}

  <div class="min-h-screen bg-gray-50 dark:bg-gray-900 pb-20" data-current-code="{{ land.code }}" data-current-index="{{ current_index }}">
    <!-- هدر ثابت - سبک دیوار -->
    <header class="sticky top-0 z-30 bg-white/95 dark:bg-gray-900/95 border-b border-gray-200 dark:border-gray-800 backdrop-blur w-full">
      <div class="w-full px-3 sm:px-4 h-12 flex items-center justify-between gap-2">
        <button type="button"
                onclick="goToExplore()"
                class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200"
                aria-label="بازگشت">
          <i class="fas fa-arrow-right text-sm"></i>
        </button>
        <div class="flex flex-col items-center flex-1 min-w-0">
          <h1 class="text-sm font-bold text-gray-900 dark:text-gray-50 line-clamp-1 truncate max-w-full">{{ land.title or 'فایل' }}</h1>
        </div>
        <button type="button"
                class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 copy-public-link"
                data-url="{{ request.url }}"
                aria-label="کپی لینک">
          <i class="fas fa-share-nodes text-sm"></i>
        </button>
      </div>
    </header>

    {# Breadcrumbs Schema #}
    <nav aria-label="breadcrumb" class="sticky top-12 z-20 bg-white/95 dark:bg-gray-900/95 border-b border-gray-200 dark:border-gray-800 backdrop-blur w-full px-3 sm:px-4 py-2">
      <ol class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400 max-w-7xl mx-auto" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="{{ url_for('main.index') }}" itemprop="item" class="hover:text-gray-900 dark:hover:text-gray-100">
            <span itemprop="name">خانه</span>
          </a>
          <meta itemprop="position" content="1">
        </li>
        <li class="text-gray-400">/</li>
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="{{ url_for('main.express_public_list') }}" itemprop="item" class="hover:text-gray-900 dark:hover:text-gray-100">
            <span itemprop="name">فایل‌ها</span>
          </a>
          <meta itemprop="position" content="2">
        </li>
        <li class="text-gray-400">/</li>
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" class="text-gray-900 dark:text-gray-100">
          <span itemprop="name">{{ land.title or 'جزئیات فایل' }}</span>
          <meta itemprop="position" content="3">
        </li>
      </ol>
    </nav>

    <!-- گالری بالای صفحه - سبک دیوار (تمام‌عرض) -->
    <div class="relative mb-4 bg-black/5 dark:bg-black/20 w-full">
      <div class="w-full pt-0 pb-4">
        {% if has_video or primary_image %}
          {# uploads/* باید از /uploads/ سرو شود (نه /static/) #}
          {% if video and ("://" in (video|string)) %}
            {% set video_src = video %}
          {% elif video and (video|string).startswith('/uploads/') %}
            {% set video_src = video %}
          {% elif video and (video|string).startswith('uploads/') %}
            {% set video_src = '/uploads/' + (video|string)[8:] %}
          {% elif video and not (video|string).startswith('/') %}
            {# مسیرهای تاریخ‌محور مثل 2025/08/... هم از /uploads/ سرو می‌شوند #}
            {% set video_src = '/uploads/' + (video|string) %}
          {% else %}
            {% set video_src = video %}
          {% endif %}
          <div id="landGallery"
               class="aspect-[4/3] bg-gray-100 dark:bg-gray-900 relative overflow-hidden rounded-none sm:rounded-xl select-none"
               data-next-code="{{ next_land.code if next_land else '' }}"
               data-prev-code="{{ prev_land.code if prev_land else '' }}">

            <!-- Loading overlay -->
            <div id="landMediaLoading"
                 class="absolute inset-0 z-40 flex items-center justify-center bg-black/35 backdrop-blur-[1px] text-white transition-opacity duration-200 opacity-0 pointer-events-none"
                 aria-hidden="true">
              <div class="flex flex-col items-center gap-2">
                <div class="w-10 h-10 rounded-full border-2 border-white/40 border-t-white animate-spin"></div>
                <div class="text-xs font-medium drop-shadow">در حال بارگذاری…</div>
              </div>
            </div>
            
            {# اگر ویدیو وجود دارد، اولین اسلاید ویدیو است #}
            {% if has_video %}
            <video id="landVideo"
                   class="w-full h-full object-cover block"
                   controls
                   onclick="event.stopPropagation()">
              <source src="{{ video_src }}" type="video/mp4">
              مرورگر شما از پخش ویدیو پشتیبانی نمی‌کند.
            </video>
            {% endif %}

            {# تصویر اصلی (اگر ویدیو وجود دارد، دومین اسلاید است) #}
            {% if primary_image %}
              {% if "://" in (primary_image|string) %}
                {% set image_src = primary_image %}
              {% elif (primary_image|string).startswith('/uploads/') %}
                {% set image_src = primary_image %}
              {% elif (primary_image|string).startswith('uploads/') %}
                {% set image_src = '/uploads/' + (primary_image|string)[8:] %}
              {% elif not (primary_image|string).startswith('/') %}
                {% set image_src = '/uploads/' + (primary_image|string) %}
              {% else %}
                {% set image_src = primary_image %}
              {% endif %}
              {% set thumb_src = (primary_image_v2.thumb if primary_image_v2 else None) or image_src %}
              {% set full_src = (primary_image_v2.full if primary_image_v2 else None) or image_src %}
              <img id="landMainImage"
                   src="{{ thumb_src }}"
                   data-full="{{ full_src }}"
                   alt="{{ land.title or 'عکس فایل' }} - {{ land.location or '' }}"
                   itemprop="image"
                   class="w-full h-full object-cover cursor-pointer progressive-img {% if has_video %}hidden{% else %}block{% endif %}"
                   onclick="openLightbox(this.dataset.full || this.src)">
            {% endif %}

            {# دکمه‌های قبلی/بعدی فقط اگر بیش از یک آیتم وجود داشته باشد #}
            {% if total_items > 1 %}
            <button type="button"
                    id="landPrev"
                    class="absolute inset-y-0 right-0 w-12 flex items-center justify-center bg-gradient-to-l from-black/35 to-transparent text-white text-lg focus:outline-none active:scale-95 z-30">
              <i class="fas fa-chevron-right drop-shadow"></i>
            </button>
            <button type="button"
                    id="landNext"
                    class="absolute inset-y-0 left-0 w-12 flex items-center justify-center bg-gradient-to-r from-black/35 to-transparent text-white text-lg focus:outline-none active:scale-95 z-30">
              <i class="fas fa-chevron-left drop-shadow"></i>
            </button>

            <!-- نقطه‌های وضعیت اسلاید -->
            <div class="absolute bottom-2 inset-x-0 flex items-center justify-center gap-1.5 z-30">
              {% if has_video %}
              <span class="land-dot w-1.5 h-1.5 rounded-full bg-white/40 active"></span>
              {% endif %}
              {% for _ in images %}
              <span class="land-dot w-1.5 h-1.5 rounded-full bg-white/40 {% if not has_video and loop.first %}active{% endif %}"></span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        {% else %}
          <div class="aspect-[4/3] bg-gray-100 dark:bg-gray-900 flex items-center justify-center rounded-xl">
            <i class="fas fa-image text-4xl text-gray-300 dark:text-gray-700"></i>
          </div>
        {% endif %}
      </div>
      
      {% if land._assignment_status == 'in_transaction' %}
      <div class="absolute top-3 left-5">
        <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-[11px] font-semibold bg-orange-500 text-white shadow-sm">
          در حال معامله
        </span>
      </div>
      {% endif %}
    </div>

    <main class="max-w-4xl mx-auto px-3 sm:px-4 space-y-3">
      <!-- کارت عنوان و قیمت - دیوار استایل -->
      <section class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-3 sm:p-4 space-y-3">
        <div class="flex items-start justify-between gap-3">
          <h2 class="text-base sm:text-lg font-bold text-gray-900 dark:text-gray-50 leading-snug">
            {{ land.title or 'بدون عنوان' }}
          </h2>
        </div>

        <div class="flex flex-col gap-1">
          <div class="text-xl font-extrabold text-gray-900 dark:text-gray-50">
            {{ (land.price_total or 0)|toman }}
          </div>
          {% if land.price_per_meter %}
          <div class="text-xs text-gray-600 dark:text-gray-300">
            هر متر {{ (land.price_per_meter or 0)|toman }}
          </div>
          {% endif %}
        </div>

        <div class="flex flex-wrap items-center gap-2 text-xs text-gray-600 dark:text-gray-300">
          {% if land.location or land.city %}
          <span class="inline-flex items-center gap-1">
            <i class="fas fa-map-marker-alt text-[10px]"></i>
            {{ land.location or land.city }}
          </span>
          {% endif %}
          {% if land.size %}
          <span class="inline-flex items-center gap-1">
            <i class="fas fa-ruler-combined text-[10px]"></i>
            {{ land.size }} متر
          </span>
          {% endif %}
          {% if land.land_type or land.category %}
          <span class="inline-flex items-center gap-1">
            <i class="fas fa-tag text-[10px]"></i>
            {{ land.land_type or land.category }}
          </span>
          {% endif %}
        </div>
      </section>

      <!-- جزئیات فایل - سبک دیوار -->
      {% if land.payment_method or (land.payment_terms and land.payment_terms|length > 0) or land.rooms or land.floor or land.year_built or land.docs_status or land.features %}
      <section class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-3 sm:p-4 space-y-2">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-50 mb-3">جزئیات</h3>
        <div class="space-y-2">
          {% if land.payment_method %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">نحوه پرداخت</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.payment_method }}</span>
          </div>
          {% if land.payment_method == 'اقساطی' and land.payment_terms and land.payment_terms|length > 0 %}
          <div class="py-2">
            <span class="text-sm text-gray-600 dark:text-gray-400 block mb-2">جزئیات اقساط</span>
            <div class="space-y-2">
              {% for t in land.payment_terms %}
                <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2">
                  <span class="text-sm text-gray-700 dark:text-gray-300">{{ (t.months or 0) }} ماهه</span>
                  <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ (t.amount or 0)|toman }}</span>
                </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% endif %}
          {% if land.rooms %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">اتاق</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.rooms }}</span>
          </div>
          {% endif %}
          {% if land.floor %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">طبقه</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.floor }}</span>
          </div>
          {% endif %}
          {% if land.year_built %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">سال ساخت</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.year_built }}</span>
          </div>
          {% endif %}
          {% if land.docs_status %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">وضعیت سند</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.docs_status }}</span>
          </div>
          {% endif %}
          {% if land.features %}
          <div class="py-2">
            <span class="text-sm text-gray-600 dark:text-gray-400 block mb-2">ویژگی‌ها</span>
            <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line">{{ land.features }}</p>
          </div>
          {% endif %}
        </div>
      </section>
      {% endif %}

      <!-- توضیحات -->
      {% if land.description %}
      <section class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-3 sm:p-4 space-y-2">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-50">توضیحات</h3>
        <p class="text-sm text-gray-700 dark:text-gray-200 leading-relaxed whitespace-pre-line">
          {{ land.description }}
        </p>
      </section>
      {% endif %}

      <!-- مشاور معرفی‌شده / اطلاعات تماس -->
      {% if ref_partner %}
      <section class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-3 sm:p-4 space-y-3">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-300 grid place-items-center">
            <i class="fas fa-user-tie text-sm"></i>
          </div>
          <div>
            <p class="text-sm font-semibold text-gray-900 dark:text-gray-50">
              {{ ref_partner.get('name') or 'مشاور' }}
            </p>
            <p class="text-[11px] text-gray-500 dark:text-gray-400">
              {{ ref_partner.get('city') or 'مشاور منتخب' }}
            </p>
          </div>
        </div>

        {% if ref_partner.get('phone') %}
        <div class="grid grid-cols-2 gap-2 text-xs sm:text-sm">
          <a href="tel:{{ ref_partner.get('phone') }}"
             class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition">
            <i class="fas fa-phone"></i>
            تماس مستقیم
          </a>
          <a href="sms:{{ ref_partner.get('phone') }}"
             class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg border border-emerald-200 text-emerald-700 hover:bg-emerald-50 transition">
            <i class="fas fa-sms"></i>
            پیامک
          </a>
        </div>
        {% endif %}
      </section>
      {% endif %}

      <!-- بلوک لینک اختصاصی - سبک بلوک موقعیت -->
      <section>
        <button type="button"
                class="w-full bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-3 sm:p-4 flex items-center justify-between hover:border-gray-300 dark:hover:border-gray-600 transition-colors copy-public-link"
                data-url="{{ request.url }}">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-xl bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 grid place-items-center">
              <i class="fas fa-link text-sm"></i>
            </div>
            <div class="text-right">
              <div class="text-sm font-semibold text-gray-900 dark:text-gray-50">
                لینک اختصاصی این فایل
              </div>
              <div class="text-[11px] text-gray-500 dark:text-gray-400">
                برای اشتراک‌گذاری با مشتریان استفاده کنید
              </div>
            </div>
          </div>
          <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500 text-sm"></i>
        </button>
      </section>
    </main>

    <!-- نوار تماس ثابت پایین - سبک دیوار -->
    <div class="fixed inset-x-0 bottom-0 z-30 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800">
      <div class="max-w-4xl mx-auto px-4 py-3">
        <button type="button"
                onclick="openContactModal()"
                class="w-full flex items-center justify-center gap-2 px-4 py-3.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white text-sm font-bold shadow-sm transition-colors">
          <i class="fas fa-phone text-base"></i>
          <span>تماس</span>
        </button>
      </div>
    </div>

    <!-- مودال تماس - سبک مودال حذف یادداشت‌ها -->
    <div id="contactModal" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center">
      <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeContactModal()"></div>
      <div class="relative w-full sm:max-w-md mx-auto bg-white dark:bg-gray-900 rounded-t-2xl sm:rounded-2xl shadow-xl overflow-hidden transform transition-all">
        <div class="p-6 space-y-4">
          <div class="flex items-center justify-between mb-1">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">اطلاعات تماس</h3>
            <button type="button" onclick="closeContactModal()" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 grid place-items-center text-gray-500">
              <i class="fas fa-times text-lg"></i>
            </button>
          </div>

          {% if ref_partner and ref_partner.get('phone') %}
          <div class="space-y-4">
            <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
              <div class="h-12 w-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-300 grid place-items-center">
                <i class="fas fa-user-tie text-lg"></i>
              </div>
              <div>
                <p class="text-sm font-semibold text-gray-900 dark:text-gray-50">{{ ref_partner.get('name') or 'مشاور' }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ ref_partner.get('city') or 'مشاور منتخب' }}</p>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <a href="tel:{{ ref_partner.get('phone') }}"
                 class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold inline-flex items-center justify-center gap-2 transition">
                <i class="fas fa-phone"></i>
                تماس
              </a>
              <a href="sms:{{ ref_partner.get('phone') }}"
                 class="w-full py-3 rounded-xl border-2 border-emerald-200 dark:border-emerald-700 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 font-semibold inline-flex items-center justify-center gap-2 transition">
                <i class="fas fa-sms text-lg"></i>
                پیامک
              </a>
            </div>
          </div>
          {% else %}
          <div class="text-center py-6">
            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-info-circle text-2xl text-gray-400 dark:text-gray-600"></i>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400">اطلاعات تماس برای این فایل در دسترس نیست.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Lightbox برای تصاویر -->
  <div id="lightbox" class="fixed inset-0 z-50 bg-black/90 hidden items-center justify-center" onclick="closeLightbox()">
    <img id="lightboxImg" src="" alt="" class="max-w-full max-h-full object-contain" onclick="event.stopPropagation()">
    <button onclick="closeLightbox()" class="absolute top-4 left-4 text-white text-2xl hover:text-gray-300">×</button>
  </div>

  <script>
    // ذخیره کردن referrer اصلی در sessionStorage (قبل از هر navigation)
    // این referrer حتی وقتی با replace بین فایل‌ها جابجا می‌شویم حفظ می‌شود
    (function() {
      const referer = document.referrer || '';
      const currentPath = window.location.pathname;
      
      // اگر از صفحه اکسپلور آمده‌ایم و هنوز referrer ذخیره نشده، ذخیره کن
      if (referer && (referer.includes('/public') || referer.includes('/express/partner/explore'))) {
        const savedReferer = sessionStorage.getItem('express_detail_referer');
        if (!savedReferer) {
          sessionStorage.setItem('express_detail_referer', referer);
        }
      }
      // اگر referrer ذخیره شده وجود دارد و از فایل دیگری آمده‌ایم (با replace),
      // referrer ذخیره شده را حفظ کن (نادیده نگیر)
    })();

    // تابع برای بازگشت به صفحه اکسپلور
    function goToExplore() {
      // بررسی referrer ذخیره شده در sessionStorage
      const savedReferer = sessionStorage.getItem('express_detail_referer') || '';
      const isFromPartnerExplore = savedReferer.includes('/express/partner/explore');
      
      // پاک کردن referrer ذخیره شده
      sessionStorage.removeItem('express_detail_referer');
      
      // اگر از صفحه اکسپلور همکاران آمده، به همان صفحه برگرد
      if (isFromPartnerExplore) {
        window.location.href = '/express/partner/explore';
      } else {
        // در غیر این صورت به صفحه اکسپلور عمومی برو
        window.location.href = '{{ url_for("main.express_public_list") }}';
      }
    }

    // فعال‌سازی تم تیره براساس تنظیم سیستم (مانند دیوار)
    (function() {
      try {
        const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        if (mq && mq.matches) {
          document.documentElement.classList.add('dark');
        }
        if (mq) {
          mq.addEventListener('change', (e) => {
            if (e.matches) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          });
        }
      } catch (_) {}
    })();

    // Lightbox
    function openLightbox(src) {
      const lb = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      if (lb && img) {
        img.src = src;
        lb.classList.remove('hidden');
        lb.classList.add('flex');
      }
    }
    function closeLightbox() {
      const lb = document.getElementById('lightbox');
      if (lb) {
        lb.classList.add('hidden');
        lb.classList.remove('flex');
      }
    }

    // کپی لینک
    document.querySelectorAll('.copy-public-link').forEach(function(btn) {
      btn.addEventListener('click', async function () {
        const url = btn.dataset.url || window.location.href;
        try {
          await navigator.clipboard.writeText(url);
          const icon = btn.querySelector('i');
          if (icon) {
            icon.className = 'fas fa-check text-emerald-600';
            setTimeout(() => {
              icon.className = 'fas fa-share-nodes text-sm';
            }, 2000);
          }
        } catch (error) {
          console.error(error);
          alert('امکان کپی لینک وجود ندارد');
        }
      }, { passive: true });
    });

    // مودال تماس
    let __contactModalOpen = false;
    function __disableScroll() {
      document.documentElement.classList.add('overflow-hidden');
      document.body.classList.add('overflow-hidden');
    }
    function __enableScroll() {
      document.documentElement.classList.remove('overflow-hidden');
      document.body.classList.remove('overflow-hidden');
    }
    function openContactModal() {
      const modal = document.getElementById('contactModal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        __disableScroll();
        // اضافه کردن state به history تا با Back فقط مودال بسته شود
        if (location.hash !== '#contact') {
          try { history.pushState({ contactModal: true }, '', '#contact'); } catch (_) {}
        }
        __contactModalOpen = true;
      }
    }

    function closeContactModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('contactModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        __enableScroll();
        // اگر state مودال در history وجود دارد، با Back همان state حذف می‌شود
        if (location.hash === '#contact') {
          try { history.back(); } catch (_) {}
        }
        __contactModalOpen = false;
      }
    }

    // بستن مودال با کلید ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeContactModal();
      }
    });

    // مدیریت دکمه Back/Forward برای مودال تماس
    window.addEventListener('popstate', function() {
      const modal = document.getElementById('contactModal');
      const isVisible = modal && !modal.classList.contains('hidden');
      // اگر modal باز است ولی hash برداشته شد، مودال را ببند
      if (isVisible && location.hash !== '#contact') {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
        __contactModalOpen = false;
        return;
      }
      // اگر به state با hash=#contact رفتیم، مودال را باز نگه داریم
      if (!isVisible && location.hash === '#contact') {
        openContactModal();
      }
    });

    // اگر لینک با hash=#contact باز شد، مودال را نمایش بده
    if (location.hash === '#contact') {
      // تا آماده شدن DOM کمی صبر کن
      window.addEventListener('load', function() {
        openContactModal();
      });
    }

    // اسلایدر تصاویر بالای صفحه به سبک دیوار
    (function(){
      const galleryEl = document.getElementById('landGallery');
      if (!galleryEl) return;
      const mainImg = document.getElementById('landMainImage');
      const mainVideo = document.getElementById('landVideo');
      const loadingEl = document.getElementById('landMediaLoading');
      const hasVideo = !!mainVideo;
      
      const images = [
        {% for img in images_v2 %}
          {"thumb": "{{ img.thumb }}", "full": "{{ img.full or img.raw }}"}{% if not loop.last %},{% endif %}
        {% endfor %}
      ];
      
      {% if video %}
      const videoSrc = "{% if '://' in (video|string) %}{{ video }}{% elif (video|string).startswith('/uploads/') %}{{ video }}{% elif (video|string).startswith('uploads/') %}/uploads/{{ (video|string)[8:] }}{% elif video and not (video|string).startswith('/') %}/uploads/{{ video }}{% else %}{{ video }}{% endif %}";
      {% else %}
      const videoSrc = null;
      {% endif %}
      
      const totalItems = (hasVideo ? 1 : 0) + images.length;
      if (totalItems <= 1) return;

      let currentIndex = 0;
      const dots = Array.from(document.querySelectorAll('.land-dot'));
      const prevBtn = document.getElementById('landPrev');
      const nextBtn = document.getElementById('landNext');
      let loadingFallbackTimer = null;

      function setLoading(isLoading) {
        if (!loadingEl) return;
        if (loadingFallbackTimer) {
          clearTimeout(loadingFallbackTimer);
          loadingFallbackTimer = null;
        }
        if (isLoading) {
          loadingEl.classList.remove('opacity-0', 'pointer-events-none');
          loadingEl.classList.add('opacity-100');
          loadingEl.setAttribute('aria-hidden', 'false');
          loadingFallbackTimer = setTimeout(() => {
            setLoading(false);
          }, 5000);
        } else {
          loadingEl.classList.add('opacity-0', 'pointer-events-none');
          loadingEl.classList.remove('opacity-100');
          loadingEl.setAttribute('aria-hidden', 'true');
        }
      }

      function waitForImageLoad() {
        if (!mainImg) return setLoading(false);
        if (mainImg.complete && mainImg.naturalWidth > 0) {
          return setLoading(false);
        }
        const done = () => setLoading(false);
        mainImg.addEventListener('load', done, { once: true });
        mainImg.addEventListener('error', done, { once: true });
      }

      function waitForVideoLoad() {
        if (!mainVideo) return setLoading(false);
        if (mainVideo.readyState >= 2) {
          return setLoading(false);
        }
        const done = () => setLoading(false);
        mainVideo.addEventListener('loadeddata', done, { once: true });
        mainVideo.addEventListener('canplay', done, { once: true });
        mainVideo.addEventListener('error', done, { once: true });
      }

      function updateDots() {
        if (!dots.length) return;
        dots.forEach((d, idx) => {
          if (idx === currentIndex) {
            d.classList.remove('bg-white/40');
            d.classList.add('bg-white');
            d.classList.add('active');
          } else {
            d.classList.remove('bg-white');
            d.classList.remove('active');
            d.classList.add('bg-white/40');
          }
        });
      }

      function showItem(idx) {
        currentIndex = (idx + totalItems) % totalItems;
        setLoading(true);
        
        if (hasVideo && currentIndex === 0) {
          if (mainVideo) {
            mainVideo.classList.remove('hidden');
            mainVideo.classList.add('block');
          }
          if (mainImg) {
            mainImg.classList.add('hidden');
            mainImg.classList.remove('block');
          }
          waitForVideoLoad();
        } else {
          const imgIndex = hasVideo ? currentIndex - 1 : currentIndex;
          const imgObj = images[imgIndex];
          if (mainImg && imgObj) {
            const thumb = imgObj.thumb || imgObj.full || imgObj.raw || imgObj;
            const full = imgObj.full || imgObj.raw || thumb;
            mainImg.classList.remove('is-loaded');
            mainImg.src = thumb;
            mainImg.dataset.full = full;
            // Progressive upgrade به full
            if (full && full !== thumb) {
              const hi = new Image();
              hi.decoding = 'async';
              hi.src = full;
              hi.addEventListener('load', () => {
                mainImg.src = full;
                mainImg.classList.add('is-loaded');
              }, { once: true });
              hi.addEventListener('error', () => mainImg.classList.add('is-loaded'), { once: true });
            } else {
              mainImg.addEventListener('load', () => mainImg.classList.add('is-loaded'), { once: true });
            }
            mainImg.classList.remove('hidden');
            mainImg.classList.add('block');
          }
          if (mainVideo) {
            mainVideo.classList.add('hidden');
            mainVideo.classList.remove('block');
            mainVideo.pause();
          }
          waitForImageLoad();
        }
        updateDots();
      }

      prevBtn && prevBtn.addEventListener('click', function(e){
        e.preventDefault();
        showItem(currentIndex - 1);
      }, { passive: false });
      nextBtn && nextBtn.addEventListener('click', function(e){
        e.preventDefault();
        showItem(currentIndex + 1);
      }, { passive: false });

      let touchStartX = null;
      let touchEndX = null;
      let isPointerDown = false;
      const SWIPE_THRESHOLD = 40;

      function handleSwipe(dx) {
        if (Math.abs(dx) <= SWIPE_THRESHOLD) return;
        if (dx < 0) {
          showItem(currentIndex + 1);
        } else {
          showItem(currentIndex - 1);
        }
      }

      function bindSwipeListeners(el) {
        if (!el) return;
        el.addEventListener('touchstart', function(e){
          const t = e.touches && e.touches[0];
          if (!t) return;
          touchStartX = t.clientX;
          touchEndX = null;
        }, { passive: true });
        el.addEventListener('touchmove', function(e){
          const t = e.touches && e.touches[0];
          if (!t || touchStartX === null) return;
          touchEndX = t.clientX;
        }, { passive: true });
        el.addEventListener('touchend', function(e){
          if (touchStartX === null) return;
          const t = (e.changedTouches && e.changedTouches[0]) || null;
          const endX = (touchEndX !== null) ? touchEndX : (t ? t.clientX : null);
          if (endX === null) return;
          const dx = endX - touchStartX;
          handleSwipe(dx);
          touchStartX = null;
          touchEndX = null;
        }, { passive: true });
        el.addEventListener('pointerdown', function(e){
          if (e.pointerType === 'mouse' && e.button !== 0) return;
          isPointerDown = true;
          touchStartX = e.clientX;
          touchEndX = null;
          try { el.setPointerCapture(e.pointerId); } catch(_) {}
        });
        el.addEventListener('pointermove', function(e){
          if (!isPointerDown || touchStartX === null) return;
          touchEndX = e.clientX;
        });
        el.addEventListener('pointerup', function(e){
          if (!isPointerDown || touchStartX === null) return;
          isPointerDown = false;
          const endX = (touchEndX !== null) ? touchEndX : e.clientX;
          const dx = endX - touchStartX;
          handleSwipe(dx);
          touchStartX = null;
          touchEndX = null;
          try { el.releasePointerCapture(e.pointerId); } catch(_) {}
        });
        el.addEventListener('pointercancel', function(){
          isPointerDown = false;
          touchStartX = null;
          touchEndX = null;
        });
      }

      bindSwipeListeners(galleryEl);
      bindSwipeListeners(mainImg);
      bindSwipeListeners(mainVideo);

      updateDots();
      setLoading(true);
      if (hasVideo && currentIndex === 0) {
        waitForVideoLoad();
      } else {
        waitForImageLoad();
      }

      // Progressive upgrade تصویر اولیه به full
      if (mainImg) {
        const fullSrc = mainImg.dataset.full || '';
        if (fullSrc && fullSrc !== mainImg.src) {
          const hi = new Image();
          hi.decoding = 'async';
          hi.src = fullSrc;
          hi.addEventListener('load', () => {
            mainImg.src = fullSrc;
            mainImg.classList.add('is-loaded');
          }, { once: true });
          hi.addEventListener('error', () => mainImg.classList.add('is-loaded'), { once: true });
        } else {
          if (mainImg.complete) {
            mainImg.classList.add('is-loaded');
          } else {
            mainImg.addEventListener('load', () => mainImg.classList.add('is-loaded'), { once: true });
          }
        }
      }
    })();

    // Infinite Scroll - اسکرول بی‌نهایت بین فایل‌ها (حلقه‌ای - نامحدود)
    (function() {
      const galleryEl = document.getElementById('landGallery');
      const container = document.querySelector('.min-h-screen');
      if (!galleryEl || !container) return;

      const nextCode = galleryEl.getAttribute('data-next-code');
      const prevCode = galleryEl.getAttribute('data-prev-code');
      const allLands = {{ all_lands | tojson if all_lands else '[]' }};
      const currentIndex = {{ current_index if current_index is defined else -1 }};
      const currentCode = '{{ land.code }}';

      let verticalTouchStartY = null;
      let verticalTouchEndY = null;
      let scrollPositionAtStart = null;
      const VERTICAL_SWIPE_THRESHOLD = 100;
      const SCROLL_THRESHOLD = 50; // حد آستانه برای تشخیص انتهای/ابتدای صفحه

      // تابع برای چک کردن اینکه آیا به انتهای صفحه رسیده‌ایم
      function isAtBottom() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        return (scrollTop + windowHeight >= documentHeight - SCROLL_THRESHOLD);
      }

      // تابع برای چک کردن اینکه آیا در ابتدای صفحه هستیم
      function isAtTop() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        return scrollTop <= SCROLL_THRESHOLD;
      }

      // تابع برای پیدا کردن فایل بعدی (حلقه‌ای)
      function getNextCode() {
        if (nextCode) return nextCode;
        if (allLands.length === 0 || currentIndex < 0) return null;
        const nextIndex = (currentIndex + 1) % allLands.length;
        return allLands[nextIndex]?.code || null;
      }

      // تابع برای پیدا کردن فایل قبلی (حلقه‌ای)
      function getPrevCode() {
        if (prevCode) return prevCode;
        if (allLands.length === 0 || currentIndex < 0) return null;
        const prevIndex = (currentIndex - 1 + allLands.length) % allLands.length;
        return allLands[prevIndex]?.code || null;
      }

      // Swipe عمودی برای تغییر فایل - فقط بعد از رسیدن به انتهای/ابتدای صفحه
      function handleVerticalSwipe(dy, wasAtBottom, wasAtTop) {
        if (Math.abs(dy) < VERTICAL_SWIPE_THRESHOLD) return;
        
        if (dy < 0) {
          // Swipe به بالا = فایل بعدی
          // فقط اگر به انتهای صفحه رسیده بودیم و دوباره swipe به بالا کردیم
          if (wasAtBottom) {
            const next = getNextCode();
            if (next) {
              // استفاده از replace برای جلوگیری از اضافه شدن به history
              // تا دکمه back همیشه به اکسپلور برگردد
              window.location.replace('/express/' + next);
            }
          }
        } else if (dy > 0) {
          // Swipe به پایین = فایل قبلی
          // فقط اگر در ابتدای صفحه بودیم و swipe به پایین کردیم
          if (wasAtTop) {
            const prev = getPrevCode();
            if (prev) {
              // استفاده از replace برای جلوگیری از اضافه شدن به history
              window.location.replace('/express/' + prev);
            }
          }
        }
      }

      // Event listeners برای swipe عمودی
      container.addEventListener('touchstart', function(e) {
        verticalTouchStartY = e.touches[0].clientY;
        // ذخیره موقعیت اسکرول در شروع touch
        scrollPositionAtStart = {
          scrollTop: window.scrollY || document.documentElement.scrollTop,
          isAtBottom: isAtBottom(),
          isAtTop: isAtTop()
        };
      }, { passive: true });

      container.addEventListener('touchmove', function(e) {
        verticalTouchEndY = e.touches[0].clientY;
      }, { passive: true });

      container.addEventListener('touchend', function(e) {
        if (verticalTouchStartY !== null && verticalTouchEndY !== null && scrollPositionAtStart) {
          const dy = verticalTouchEndY - verticalTouchStartY;
          handleVerticalSwipe(dy, scrollPositionAtStart.isAtBottom, scrollPositionAtStart.isAtTop);
        }
        verticalTouchStartY = null;
        verticalTouchEndY = null;
        scrollPositionAtStart = null;
      }, { passive: true });

      // Keyboard navigation - فقط بعد از رسیدن به انتهای/ابتدای صفحه
      document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowUp') {
          // فقط اگر به انتهای صفحه رسیده‌ایم
          if (isAtBottom()) {
            const next = getNextCode();
            if (next) {
              e.preventDefault();
              // استفاده از replace برای جلوگیری از اضافه شدن به history
              window.location.replace('/express/' + next);
            }
          }
        } else if (e.key === 'ArrowDown') {
          // فقط اگر در ابتدای صفحه هستیم
          if (isAtTop()) {
            const prev = getPrevCode();
            if (prev) {
              e.preventDefault();
              // استفاده از replace برای جلوگیری از اضافه شدن به history
              window.location.replace('/express/' + prev);
            }
          }
        }
      });

      // Intersection Observer برای auto-load فایل بعدی (حلقه‌ای)
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const next = getNextCode();
            if (next) {
              // وقتی به انتهای صفحه رسید، فایل بعدی را preload کن
              const link = document.createElement('link');
              link.rel = 'prefetch';
              link.href = '/express/' + next;
              document.head.appendChild(link);
            }
          }
        });
      }, {
        rootMargin: '200px'
      });

      // مشاهده انتهای صفحه
      const footer = document.querySelector('.fixed.inset-x-0.bottom-0');
      if (footer) {
        observer.observe(footer);
      }
    })();
  </script>

  {# Structured Data (JSON-LD) - Product Schema #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": "{{ land.title or 'فایل اکسپرس' }}",
    "description": "{{ seo.description if seo else (land.title or 'فایل اکسپرس') }}",
    "url": "{{ seo.canonical if seo else request.url }}",
    {% if land.images and land.images|length > 0 %}
    "image": [
      {% for img in (land.images if land.images is iterable else [land.images]) %}
      {% if "://" in (img|string) %}
      "{{ img }}"{% if not loop.last %},{% endif %}
      {% elif (img|string).startswith('/uploads/') %}
      "{{ request.url_root.rstrip('/') }}{{ img }}"{% if not loop.last %},{% endif %}
      {% else %}
      "{{ request.url_root.rstrip('/') }}/uploads/{{ img }}"{% if not loop.last %},{% endif %}
      {% endif %}
      {% endfor %}
    ],
    {% endif %}
    {% if land.price_total %}
    "offers": {
      "@type": "Offer",
      "price": "{{ land.price_total }}",
      "priceCurrency": "IRR",
      "availability": "https://schema.org/InStock",
      "url": "{{ seo.canonical if seo else request.url }}"
    },
    {% endif %}
    "brand": {
      "@type": "Organization",
      "name": "وینور اکسپرس",
      "url": "{{ request.url_root.rstrip('/') }}"
    },
    "category": "{{ land.category or 'املاک' }}",
    {% if land.location %}
    "areaServed": {
      "@type": "City",
      "name": "{{ land.location }}"
    },
    {% endif %}
    "seller": {
      "@type": "Organization",
      "name": "وینور اکسپرس",
      "url": "{{ request.url_root.rstrip('/') }}"
    }
  }
  </script>

  {# RealEstate Schema (Additional) #}
  {% if land.size or land.location %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "RealEstateAgent",
    "name": "وینور",
    "url": "{{ request.url_root.rstrip('/') }}",
    "address": {
      "@type": "PostalAddress",
      "addressCountry": "IR"
    }
  }
  </script>
  {% endif %}
</body>
</html>
