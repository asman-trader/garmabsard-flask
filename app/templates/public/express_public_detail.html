<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ land.title or 'فایل اکسپرس' }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjkM7yC4GdZ7+6puj8m0yP0A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: 'Vazirmatn', sans-serif; background: #f8fafc; color: #1f2933; }
    .glass { backdrop-filter: blur(18px); background: rgba(255, 255, 255, 0.82); }
    .dark .glass { background: rgba(15, 23, 42, 0.82); }
  </style>
</head>
<body class="bg-slate-50">
  {% set images = land.images or [] %}
  {% set primary_image = images[0] if images else None %}
  {% if primary_image and primary_image.startswith('uploads/') %}
    {% set hero_image = url_for('main.uploaded_file', filename=primary_image) %}
  {% else %}
    {% set hero_image = primary_image %}
  {% endif %}

  <div class="relative isolate">
    <div class="absolute inset-x-0 top-0 h-80 bg-gradient-to-br from-[#7C3AED] via-[#6D28D9] to-[#4C1D95] opacity-90"></div>
    <header class="relative max-w-6xl mx-auto px-4 pt-6 flex items-center justify-between text-white">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-11 w-11 items-center justify-center rounded-2xl bg-white/20 text-xl shadow-lg">
          <i class="fas fa-bolt"></i>
        </span>
        <div>
          <p class="text-xs uppercase tracking-widest text-white/80">Express Listing</p>
          <h1 class="text-lg sm:text-xl font-extrabold">{{ land.title or 'فایل اکسپرس' }}</h1>
        </div>
      </div>
      {% if ref_partner %}
      <div class="glass hidden sm:flex items-center gap-3 px-4 py-2 rounded-2xl text-sm text-slate-800 shadow-lg">
        <span class="h-10 w-10 rounded-xl bg-[#7C3AED]/10 text-[#7C3AED] grid place-items-center font-bold">
          <i class="fas fa-user-tie"></i>
        </span>
        <div class="leading-tight">
          <div class="font-bold">{{ ref_partner.get('name') or 'مشاور اکسپرس' }}</div>
          <div class="text-xs text-gray-500">{{ ref_partner.get('city') or 'مشاور منتخب اکسپرس' }}</div>
        </div>
      </div>
      {% endif %}
    </header>

    <main class="relative max-w-5xl mx-auto px-4 pb-24">
      <section class="mt-8 grid lg:grid-cols-5 gap-6">
        <div class="lg:col-span-3 space-y-4">
          <div class="overflow-hidden rounded-3xl shadow-2xl border border-white/30 bg-white">
            {% if hero_image %}
              <img src="{{ hero_image }}" alt="{{ land.title }}" class="w-full h-[320px] sm:h-[420px] object-cover">
            {% else %}
              <div class="h-[320px] sm:h-[420px] grid place-items-center bg-gradient-to-br from-slate-100 to-slate-200 text-slate-400">
                <i class="fas fa-image text-5xl"></i>
              </div>
            {% endif %}
          </div>
          {% if images|length > 1 %}
          <div class="grid grid-cols-4 gap-3">
            {% for img in images[1:5] %}
              {% if img.startswith('uploads/') %}
                {% set thumb = url_for('main.uploaded_file', filename=img) %}
              {% else %}
                {% set thumb = img %}
              {% endif %}
              <img src="{{ thumb }}" alt="{{ land.title }}" class="h-20 w-full rounded-xl object-cover border border-white shadow">
            {% endfor %}
          </div>
          {% endif %}

          {% if land.description %}
          <section class="bg-white rounded-3xl shadow border border-slate-100 p-6 space-y-3">
            <h2 class="text-lg font-extrabold text-slate-900">شرح فایل</h2>
            <p class="text-slate-600 leading-7 whitespace-pre-line">{{ land.description }}</p>
          </section>
          {% endif %}
        </div>

        <aside class="lg:col-span-2 space-y-4">
          <div class="glass rounded-3xl border border-white/40 shadow-xl p-6 space-y-4">
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-xs uppercase tracking-widest text-white/70">قیمت پیشنهادی</p>
                <p class="mt-2 text-3xl font-black">{{ (land.price_total or 0)|toman }}</p>
                {% if land.price_per_meter %}
                  <p class="text-sm text-white/80 mt-1">هر متر {{ (land.price_per_meter or 0)|toman }}</p>
                {% endif %}
              </div>
              {% if land._assignment_status == 'in_transaction' %}
                <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold bg-amber-400/90 text-amber-900 shadow">
                  <i class="fas fa-handshake"></i>
                  در حال معامله
                </span>
              {% endif %}
            </div>

            <div class="grid grid-cols-2 gap-2 text-sm">
              {% if land.size %}
              <div class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-white/10 text-white">
                <i class="fas fa-ruler-combined"></i>
                <span>{{ land.size }} متر</span>
              </div>
              {% endif %}
              {% if land.land_type or land.category %}
              <div class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-white/10 text-white">
                <i class="fas fa-layer-group"></i>
                <span>{{ land.land_type or land.category }}</span>
              </div>
              {% endif %}
              {% if land.city or land.location %}
              <div class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-white/10 text-white">
                <i class="fas fa-location-dot"></i>
                <span>{{ land.location or land.city }}</span>
              </div>
              {% endif %}
              {% if land.docs_status %}
              <div class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-white/10 text-white">
                <i class="fas fa-file-signature"></i>
                <span>{{ land.docs_status }}</span>
              </div>
              {% endif %}
            </div>
          </div>

          {% if ref_partner %}
          <section class="bg-white rounded-3xl shadow border border-slate-100 p-6 space-y-3">
            <h3 class="text-base font-extrabold text-slate-900">مشاور معرفی‌شده</h3>
            <div class="flex items-center gap-3">
              <div class="h-12 w-12 rounded-2xl bg-[#7C3AED]/10 text-[#7C3AED] grid place-items-center font-bold text-lg">
                <i class="fas fa-user-tie"></i>
              </div>
              <div>
                <p class="font-bold text-slate-800">{{ ref_partner.get('name') or 'مشاور اکسپرس' }}</p>
                <p class="text-xs text-slate-500">{{ ref_partner.get('city') or 'مشاور منتخب اکسپرس' }}</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm">
              {% if ref_partner.get('phone') %}
              <a href="tel:{{ ref_partner.get('phone') }}" class="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white transition">
                <i class="fas fa-phone"></i>
                تماس مستقیم
              </a>
              <a href="https://wa.me/{{ ref_partner.get('phone') }}" target="_blank" rel="noopener" class="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-xl bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition">
                <i class="fab fa-whatsapp"></i>
                پیام در واتساپ
              </a>
              {% endif %}
              <button type="button" class="copy-public-link inline-flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-slate-200 hover:border-slate-300 text-slate-700 transition" data-url="{{ request.url }}">
                <i class="fas fa-link"></i>
                کپی لینک اختصاصی
              </button>
            </div>
          </section>
          {% endif %}

          {% if land.features %}
          <section class="bg-white rounded-3xl shadow border border-slate-100 p-6">
            <h3 class="text-base font-extrabold text-slate-900 mb-3">ویژگی‌ها</h3>
            <p class="text-sm text-slate-600 whitespace-pre-line">{{ land.features }}</p>
          </section>
          {% endif %}
        </aside>
      </section>
    </main>
  </div>

  <div class="fixed bottom-5 inset-x-0 flex justify-center px-4 z-40">
    <div class="glass max-w-lg w-full flex items-center justify-between rounded-3xl px-5 py-3 shadow-lg border border-white/50">
      <span class="text-sm text-slate-700">آمادهٔ هماهنگی برای بازدید هستید؟</span>
      {% if ref_partner and ref_partner.get('phone') %}
      <a href="tel:{{ ref_partner.get('phone') }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-[#7C3AED] hover:bg-[#6D28D9] text-white text-sm font-bold transition">
        <i class="fas fa-phone"></i>
        تماس با مشاور
      </a>
      {% else %}
      <a href="mailto:info@express.com" class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-[#7C3AED] hover:bg-[#6D28D9] text-white text-sm font-bold transition">
        <i class="fas fa-envelope"></i>
        ارسال پیام
      </a>
      {% endif %}
    </div>
  </div>

  <script>
    document.querySelectorAll('.copy-public-link').forEach(function(btn) {
      btn.addEventListener('click', async function () {
        const url = btn.dataset.url || window.location.href;
        try {
          await navigator.clipboard.writeText(url);
          btn.textContent = 'لینک کپی شد';
          setTimeout(() => { btn.textContent = 'کپی لینک اختصاصی'; }, 2000);
        } catch (error) {
          console.error(error);
          alert('امکان کپی لینک وجود ندارد');
        }
      }, { passive: true });
    });
  </script>
</body>
</html>
