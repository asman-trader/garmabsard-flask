<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  {# SEO Meta Tags #}
  <title>{{ seo.title if seo else 'فایل‌های اکسپرس وینور' }}</title>
  <meta name="description" content="{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور' }}">
  <meta name="keywords" content="{{ seo.keywords if seo else 'فایل اکسپرس, خرید ملک, فروش ملک, وینور' }}">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="{{ seo.canonical if seo else request.url }}">
  
  {# Open Graph #}
  <meta property="og:type" content="{{ seo.og_type if seo else 'website' }}">
  <meta property="og:url" content="{{ seo.canonical if seo else request.url }}">
  <meta property="og:title" content="{{ seo.title if seo else 'فایل‌های اکسپرس وینور' }}">
  <meta property="og:description" content="{{ seo.description if seo else 'لیست کامل فایل‌های اکسپرس وینور' }}">
  <meta property="og:image" content="{{ seo.og_image if seo else request.url_root + 'static/icons/icon-512.png' }}">
  
  {# Favicon #}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjkM7yC4GdZ7+6puj8m0yP0A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: 'Vazirmatn', sans-serif; }
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    #cardsTrack {
      min-height: calc(100vh - 150px);
    }
    @media (max-width: 640px) {
      #cardsTrack {
        min-height: calc(100vh - 130px);
      }
      nav[class*="fixed"] {
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
    }
    .express-card {
      transition: box-shadow .2s ease, border-color .2s ease;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .express-card:hover {
      transform: translateY(-1px);
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900 pb-16">
    <div class="max-w-6xl mx-auto pt-0 px-0 pb-16">

      {% if lands and lands|length == 0 %}
        <div class="mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-8 text-center mx-3 sm:mx-4">
          <div class="flex flex-col items-center gap-3">
            <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
              <i class="fas fa-inbox text-2xl text-gray-400 dark:text-gray-500"></i>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">هنوز فایلی ثبت نشده</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">به زودی فایل‌های جدید اضافه می‌شوند.</p>
            </div>
          </div>
        </div>
      {% endif %}

      <div class="mt-2 -mx-3 relative">
        <button type="button" id="cardsPrev" class="hidden sm:flex absolute right-1 top-1/2 -translate-y-1/2 z-10 w-9 h-9 rounded-full bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 shadow items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700">
          <i class="fas fa-chevron-right"></i>
        </button>
        <button type="button" id="cardsNext" class="hidden sm:flex absolute left-1 top-1/2 -translate-y-1/2 z-10 w-9 h-9 rounded-full bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 shadow items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700">
          <i class="fas fa-chevron-left"></i>
        </button>

        <div id="cardsTrack" class="px-3 flex flex-col sm:flex-row sm:flex-nowrap items-stretch gap-4 pb-4 sm:overflow-x-auto sm:snap-x sm:snap-mandatory no-scrollbar">
        {% for land in lands %}
          <article class="snap-start shrink-0 w-full sm:w-[320px] group express-card relative bg-white dark:bg-gray-900 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md" 
                   onclick="window.location.href='{{ url_for('main.express_detail', code=land.code) }}'"
                   role="link" tabindex="0">
            {% set img = (land.images[0] if land.images and land.images[0] else None) %}
            
            <!-- Image/Video Section - دیوار استایل -->
            <div class="relative aspect-[4/3] bg-gray-100 dark:bg-gray-800 overflow-hidden">
              {% set video = land.video %}
              {% if video %}
                {% if "://" in (video|string) %}
                  {% set video_src = video %}
                {% elif (video|string).startswith('/uploads/') %}
                  {% set video_src = video %}
                {% elif (video|string).startswith('uploads/') %}
                  {% set video_src = '/uploads/' + (video|string)[8:] %}
                {% elif not (video|string).startswith('/') %}
                  {% set video_src = '/uploads/' + (video|string) %}
                {% else %}
                  {% set video_src = video %}
                {% endif %}
                <video class="w-full h-full object-cover" autoplay muted loop playsinline>
                  <source src="{{ video_src }}" type="video/mp4">
                  {% if img %}
                    {% if "://" in (img|string) %}
                      {% set img_src = img %}
                    {% elif (img|string).startswith('/uploads/') %}
                      {% set img_src = img %}
                    {% elif (img|string).startswith('uploads/') %}
                      {% set img_src = '/uploads/' + (img|string)[8:] %}
                    {% elif not (img|string).startswith('/') %}
                      {% set img_src = '/uploads/' + (img|string) %}
                    {% else %}
                      {% set img_src = img %}
                    {% endif %}
                    <img src="{{ img_src }}" alt="{{ land.title }}" class="w-full h-full object-cover">
                  {% endif %}
                </video>
              {% elif img %}
                {% if "://" in (img|string) %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('/uploads/') %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('uploads/') %}
                  {% set img_src = '/uploads/' + (img|string)[8:] %}
                {% elif not (img|string).startswith('/') %}
                  {% set img_src = '/uploads/' + (img|string) %}
                {% else %}
                  {% set img_src = img %}
                {% endif %}
                <img src="{{ img_src }}" alt="{{ land.title }}" class="w-full h-full object-cover">
              {% else %}
                <div class="w-full h-full grid place-items-center text-gray-300 dark:text-gray-600">
                  <i class="fas fa-image text-3xl"></i>
                </div>
              {% endif %}
            </div>

            <!-- Content Section - سبک دیوار -->
            <div class="p-3">
              <!-- Title -->
              <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-2 leading-snug min-h-[2.5rem]">
                {{ land.title or '—' }}
              </h3>

              <!-- Price - بزرگ و برجسته -->
              {% if land.price_total %}
              <div class="mb-2">
                <div class="text-lg font-bold text-gray-900 dark:text-white">
                  {{ "{:,}".format(land.price_total) }} تومان
                </div>
              </div>
              {% endif %}

              <!-- Details - ساده و تمیز -->
              <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-600 dark:text-gray-400 mb-2">
                {% if land.size %}
                  <span class="flex items-center gap-1">
                    <i class="fas fa-ruler-combined text-[10px]"></i>
                    {{ land.size }} متر
                  </span>
                {% endif %}
                {% if land.location or land.city %}
                  <span class="flex items-center gap-1">
                    <i class="fas fa-map-marker-alt text-[10px]"></i>
                    {{ land.location or (land.city or '') }}
                  </span>
                {% endif %}
                {% if land.category %}
                  <span class="flex items-center gap-1">
                    <i class="fas fa-tag text-[10px]"></i>
                    {{ land.category }}
                  </span>
                {% endif %}
              </div>

              <!-- Footer - تاریخ -->
              {% if land.created_at %}
              <div class="text-[10px] text-gray-500 dark:text-gray-400 mt-2 pt-2 border-t border-gray-100 dark:border-gray-800">
                <span class="jalali-dt" data-dt="{{ land.created_at }}"></span>
              </div>
              {% endif %}
            </div>
          </article>
        {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <script>
    // فعال‌سازی تم تیره براساس تنظیم سیستم
    (function() {
      try {
        const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        if (mq && mq.matches) {
          document.documentElement.classList.add('dark');
        }
        if (mq) {
          mq.addEventListener('change', (e) => {
            if (e.matches) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          });
        }
      } catch (_) {}
    })();

    // Horizontal scroll controls for cards
    (function(){
      const track = document.getElementById('cardsTrack');
      const prev = document.getElementById('cardsPrev');
      const next = document.getElementById('cardsNext');
      if (!track || !prev || !next) return;
      function scrollByAmount(dir){
        const delta = Math.round((track.clientWidth || 300) * 0.9);
        const rtl = document.dir === 'rtl' || document.documentElement.getAttribute('dir') === 'rtl';
        const sign = (dir === 'next') ? (rtl ? -1 : 1) : (rtl ? 1 : -1);
        track.scrollBy({ left: sign * delta, behavior: 'smooth' });
      }
      prev.addEventListener('click', ()=>scrollByAmount('prev'));
      next.addEventListener('click', ()=>scrollByAmount('next'));
    })();

    // Convert dates to Persian (Jalali) format
    (function(){
      function fmt(dt){
        try{
          const d = new Date(String(dt||'').replace(' ','T'));
          if (isNaN(d.getTime())) return '';
          return d.toLocaleDateString('fa-IR', {
            timeZone: 'Asia/Tehran',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
        }catch(_){ return ''; }
      }
      document.querySelectorAll('.jalali-dt[data-dt]').forEach(el=>{
        const raw = el.getAttribute('data-dt')||'';
        const formatted = fmt(raw);
        el.textContent = formatted || '—';
      });
    })();
  </script>

  <!-- فوتر ناوبری - سبک دیوار -->
  <nav class="fixed inset-x-0 bottom-0 z-50 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 safe-area-bottom">
    <div class="max-w-md mx-auto">
      <div class="grid grid-cols-4 gap-0">
        {% set current_path = request.path %}
        {% set nav_items = [
          {
            'key': 'home',
            'url': url_for('main.index'),
            'icon': 'fa-home',
            'label': 'خانه',
            'is_active': (current_path == '/' or current_path == url_for('main.index'))
          },
          {
            'key': 'explore',
            'url': url_for('main.express_public_list'),
            'icon': 'fa-magnifying-glass',
            'label': 'اکسپلور',
            'is_active': (current_path.startswith('/public') or current_path.startswith('/express/'))
          },
          {
            'key': 'partners',
            'url': url_for('main.partners'),
            'icon': 'fa-users',
            'label': 'همکاران',
            'is_active': (current_path == url_for('main.partners'))
          },
          {
            'key': 'help',
            'url': url_for('main.help'),
            'icon': 'fa-question-circle',
            'label': 'راهنما',
            'is_active': (current_path == url_for('main.help') or current_path.startswith('/help'))
          }
        ] %}
        {% for item in nav_items %}
          <a href="{{ item.url }}"
             class="flex flex-col items-center justify-center gap-0.5 py-3 px-2 transition-all duration-200 {{ 'text-gray-900 dark:text-white' if item.is_active else 'text-gray-500 dark:text-gray-400' }} hover:text-gray-900 dark:hover:text-white active:scale-95"
             aria-current="{{ 'page' if item.is_active else 'false' }}">
            <i class="fas {{ item.icon }} {{ 'text-xl' if item.is_active else 'text-lg' }} transition-all duration-200"></i>
            <span class="text-[10px] font-medium leading-tight mt-0.5">{{ item.label }}</span>
          </a>
        {% endfor %}
      </div>
    </div>
  </nav>
</body>
</html>
