{% extends "base.html" %}
{% set hide_header = True %}
{% block title %}Ø¬Ø³ØªØ¬Ùˆ | ÙˆÛŒÙ†ÙˆØ±{% endblock %}

{% block content %}

<header class="fixed top-0 inset-x-0 z-30 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800">
  <div class="max-w-6xl mx-auto px-3 py-2 flex items-center gap-2">
    <button type="button" onclick="history.back()" class="w-10 h-10 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª">
      <i class="fas fa-arrow-right"></i>
    </button>

    <a href="{{ url_for('main.city_select_multi') }}" class="h-10 px-3 rounded-full border border-gray-300 dark:border-gray-700 dark:bg-gray-800 text-gray-700 dark:text-gray-100 text-xs sm:text-sm flex items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-700" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±">
      <i class="fas fa-map-marker-alt text-emerald-600"></i>
      <span id="cityLabel">Ú©Ù„ Ø§ÛŒØ±Ø§Ù†</span>
    </a>

    <form id="searchForm" method="get" action="{{ url_for('main.search_page') }}" class="flex-1">
      <div class="relative">
        <input id="q" name="q" type="search" value="{{ request.args.get('q','') }}" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ù…ÙˆÙ‚Ø¹ÛŒØªØŒ Ø¹Ù†ÙˆØ§Ù†ØŒ Ú©Ø¯ Ø¢Ú¯Ù‡ÛŒ..."
               class="w-full h-10 rounded-full border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white pl-9 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-600">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input type="hidden" id="cityHidden" name="city" value="{{ request.args.get('city','') }}">
      </div>
    </form>

    <button type="button" id="menuToggle" class="sm:hidden w-10 h-10 grid place-items-center rounded-full border border-gray-300 dark:border-gray-700 dark:bg-gray-800" aria-label="Ù…Ù†Ùˆ">
      <i class="fas fa-bars"></i>
    </button>
  </div>
</header>

<div class="h-14"></div>

<main class="max-w-6xl mx-auto px-3 pb-24 pt-3">
  {% set list_ = lands or [] %}
  {% if list_|length == 0 %}
    <div class="grid place-items-center py-16 text-center text-gray-500 dark:text-gray-300">
      <div>
        <div class="text-4xl mb-2">ğŸ”</div>
        <div class="text-sm">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ ÛŒØ§ Ø´Ù‡Ø± Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.</div>
      </div>
    </div>
  {% else %}
    <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for land in list_ %}
        {% set images = land.get('images') or [] %}
        {% set img = images[0] if images else None %}
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl shadow-sm overflow-hidden land-card group" data-code="{{ land.code }}">
          <div class="relative">
            <a href="{{ url_for('main.land_detail', code=land.code) }}">
              {% if img %}
              <img src="{{ url_for('main.uploaded_file', filename=img) }}" alt="{{ land.title }}" class="w-full h-64 sm:h-60 object-cover group-hover:scale-105 transition" />
              {% else %}
              <div class="w-full h-64 sm:h-60 bg-gray-200 dark:bg-gray-800 grid place-items-center text-gray-500">
                <i class="fas fa-seedling text-2xl text-emerald-600/70"></i>
              </div>
              {% endif %}
            </a>
            <button type="button" class="absolute top-3 right-3 favorite-btn z-10" data-code="{{ land.code }}" title="Ø°Ø®ÛŒØ±Ù‡ Ø¢Ú¯Ù‡ÛŒ">
              <i class="fas fa-bookmark text-white text-2xl drop-shadow-md"></i>
            </button>
          </div>
          <div class="p-4">
            <a href="{{ url_for('main.land_detail', code=land.code) }}" class="block">
              <h3 class="text-base font-bold text-gray-900 dark:text-white truncate">{{ land.title }}</h3>
            </a>
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">ğŸ“ {{ land.location or '?' }} | ğŸ“ {{ "{:,}".format(land.size | int) if land.size else "?" }} Ù…ØªØ±</p>
            <p class="text-base font-extrabold text-emerald-700 dark:text-emerald-400 mt-2">ğŸ’° {{ "{:,}".format(land.price_total | int) if land.price_total else "Ù†Ø§Ù…Ø´Ø®Øµ" }} ØªÙˆÙ…Ø§Ù†</p>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</main>

<!-- Lands JSON for client features -->
<script id="lands-json" type="application/json">{{ (lands or []) | tojson }}</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // City label from storage
    (function(){
      const label = document.getElementById('cityLabel');
      const hidden = document.getElementById('cityHidden');
      if (!label || !hidden) return;
      let display = 'Ú©Ù„ Ø§ÛŒØ±Ø§Ù†', hiddenVal = '';
      try{
        const obj = JSON.parse(localStorage.getItem('vinor_city_obj')||'null');
        const raw = localStorage.getItem('vinor_city')||'';
        if (obj && typeof obj==='object'){
          if (Array.isArray(obj.cities) && obj.cities.length>1){ display = obj.cities.length+' Ø´Ù‡Ø±'; hiddenVal = obj.cities.join(','); }
          else if (Array.isArray(obj.cities) && obj.cities.length===1){ display=obj.cities[0]; hiddenVal=obj.cities[0]; }
          else if (obj.province && obj.city){ display=obj.city; hiddenVal=obj.city; }
          else if (obj.province && !obj.city){ display=obj.province; hiddenVal=obj.province; }
          else if (raw){ display=raw; hiddenVal=raw; }
        } else if (raw) { display=raw; hiddenVal=raw; }
      }catch(_){ }
      label.textContent = display || 'Ú©Ù„ Ø§ÛŒØ±Ø§Ù†';
      hidden.value = hiddenVal;
      window.addEventListener('storage', (e)=>{ if(e.key==='vinor_city'||e.key==='vinor_city_obj') location.reload(); });
    })();

    // Favorites paint
    (function(){
      const favs = JSON.parse(localStorage.getItem('favoriteLands')||'[]');
      document.querySelectorAll('.land-card').forEach(card=>{
        const code = card.dataset.code;
        const btn = card.querySelector('.favorite-btn');
        const icon = btn?.querySelector('i')||btn;
        if (!btn || !icon) return;
        const paint = ()=>{
          const on = favs.includes(code);
          icon.classList.toggle('text-red-500', on);
          icon.classList.toggle('text-white', !on);
        };
        paint();
        btn.addEventListener('click', (e)=>{
          e.preventDefault();
          const i = favs.indexOf(code);
          if (i>-1) favs.splice(i,1); else favs.push(code);
          localStorage.setItem('favoriteLands', JSON.stringify(favs));
          paint();
        });
      });
    })();

    // Persist lands for other pages
    try {
      const el = document.getElementById('lands-json');
      const txt = (el && el.textContent) ? el.textContent : '[]';
      localStorage.setItem('allLandsData', txt);
    } catch(_){ }
  });
</script>

{% endblock %}

{% block floating_action %}{% endblock %}
