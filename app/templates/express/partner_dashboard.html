{% extends 'base.html' %}
{% block title %}پنل همکاری وینور اکسپرس{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto py-5 px-3 sm:px-4">
  <!-- Compact KPI summary (header removed) -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
    <div class="rounded-xl bg-white border border-gray-200 p-3">
      <div class="text-[12px] text-gray-500">کل درآمد</div>
      <div class="text-lg font-extrabold">{{ total_commission }}</div>
    </div>
    <div class="rounded-xl bg-white border border-gray-200 p-3">
      <div class="text-[12px] text-gray-500">در انتظار</div>
      <div class="text-lg font-extrabold">{{ pending_commission }}</div>
    </div>
    <div class="rounded-xl bg-white border border-gray-200 p-3">
      <div class="text-[12px] text-gray-500">فروش‌های من</div>
      <div class="text-lg font-extrabold">{{ sold_count }}</div>
    </div>
    <div class="rounded-xl bg-white border border-gray-200 p-3">
      <div class="text-[12px] text-gray-500">فایل‌های فعال</div>
      <div class="text-lg font-extrabold">{{ assigned_lands|length }}</div>
    </div>
  </div>

  {% if not is_approved %}
    <div class="bg-yellow-50 border border-yellow-200 text-yellow-900 p-4 rounded-md mb-6">
      درخواست شما در صف بررسی است. پس از تأیید توسط ادمین، دسترسی کامل به پنل برای شما فعال می‌شود.
    </div>
  {% else %}
    <div class="bg-emerald-50 border border-emerald-200 text-emerald-900 p-4 rounded-md mb-6">
      شما به عنوان همکار اکسپرس تأیید شده‌اید. می‌توانید از خدمات ویژه استفاده کنید.
    </div>
  {% endif %}

  <!-- Assigned lands cards -->
  {% if assigned_lands|length == 0 %}
    <div class="mt-2 bg-white border rounded-2xl p-6 text-center text-gray-600">هنوز ملکی برای شما ارسال نشده است.</div>
  {% endif %}
  <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for land in assigned_lands %}
      <div class="group relative bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-shadow duration-200">
        {% set img = (land.images[0] if land.images and land.images[0] else None) %}
        <div class="relative aspect-video bg-gray-200 dark:bg-gray-700">
          {% if img %}
            <img src="{{ url_for('static', filename=img) if img.startswith('uploads/') else img }}" alt="{{ land.title }}" class="w-full h-full object-cover group-hover:scale-[1.02] transition-transform duration-200">
          {% endif %}
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent"></div>
          <div class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-md bg-white/90 text-gray-800">{{ land._assignment_status or 'active' }}</div>
          {% if land._commission_pct %}
            <div class="absolute top-2 right-2 text-[11px] px-2 py-1 rounded-md bg-purple-600 text-white">٪{{ land._commission_pct }}</div>
          {% endif %}
          <div class="absolute bottom-2 left-2 right-2 flex items-center justify-between text-white text-[13px]">
            <span class="font-bold drop-shadow">{{ land.price_total or '—' }}</span>
          </div>
        </div>
        <div class="p-3 space-y-1.5">
          <div class="text-sm font-bold line-clamp-1">{{ land.title }}</div>
          <div class="text-[12px] text-gray-500">{{ land.location or (land.city or '') }}</div>
          <div class="flex items-center gap-2 pt-1">
            <a href="{{ url_for('main.express_detail', code=land.code) }}" class="flex-1 px-3 py-1.5 rounded-md border text-[13px] text-center">جزئیات</a>
            <a href="{{ url_for('main.express_detail', code=land.code) }}" class="flex-1 px-3 py-1.5 rounded-md bg-[#7C3AED] hover:bg-[#6D28D9] transition text-white text-[13px] text-center">اشتراک لینک</a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="grid md:grid-cols-2 gap-6 mt-6">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
      <h2 class="font-semibold mb-3">پروفایل</h2>
      <dl class="text-sm text-gray-700 space-y-2">
        <div class="flex justify-between"><dt>نام</dt><dd>{{ (profile and profile.name) or '—' }}</dd></div>
        <div class="flex justify-between"><dt>شماره</dt><dd>{{ (profile and profile.phone) or session.get('user_phone') }}</dd></div>
        <div class="flex justify-between"><dt>شهر</dt><dd>{{ (profile and profile.city) or '—' }}</dd></div>
        <div class="flex justify-between"><dt>وضعیت</dt><dd>{{ (profile and profile.status) or 'در انتظار' }}</dd></div>
      </dl>
    </div>

    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
      <h2 class="font-semibold mb-3">درخواست‌های من</h2>
      <div class="text-sm text-gray-700">
        {% if my_apps %}
          <ul class="list-disc pr-5 space-y-1">
            {% for a in my_apps %}
              <li>
                <span class="font-medium">{{ a.created_at }}</span>
                — وضعیت: {{ a.status or 'new' }}
                {% if a.note %} — {{ a.note }}{% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>درخواستی ثبت نکرده‌اید. از لینک بالا درخواست خود را ثبت کنید.</p>
        {% endif %}
      </div>
    </div>

    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
      <h2 class="font-semibold mb-3">یادداشت‌های خصوصی</h2>
      <form method="post" action="{{ url_for('main.express_partner_add_note') }}" class="mb-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="flex gap-2">
          <input type="text" name="content" class="flex-1 border rounded-md px-3 py-2" placeholder="یک یادداشت بنویسید...">
          <button class="px-3 py-2 rounded-md bg-vinor-600 text-white">افزودن</button>
        </div>
      </form>
      <ul class="space-y-2 text-sm">
        {% for n in notes %}
          <li class="flex items-center justify-between p-2 border rounded-md">
            <span class="truncate">{{ n.content }}</span>
            <form method="post" action="{{ url_for('main.express_partner_delete_note', nid=n.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="text-rose-600 hover:underline">حذف</button>
            </form>
          </li>
        {% else %}
          <li class="text-gray-500">یادداشتی ثبت نشده است.</li>
        {% endfor %}
      </ul>
    </div>

    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
      <h2 class="font-semibold mb-3">فایل‌های اختصاصی</h2>
      <form method="post" action="{{ url_for('main.express_partner_upload_file') }}" enctype="multipart/form-data" class="mb-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="flex items-center gap-2">
          <input type="file" name="file" class="flex-1 text-sm">
          <button class="px-3 py-2 rounded-md bg-vinor-600 text-white">آپلود</button>
        </div>
      </form>
      <ul class="space-y-2 text-sm">
        {% for f in files %}
          <li class="p-2 border rounded-md">
            <span class="font-mono">{{ f.filename }}</span>
            <span class="text-gray-500"> — {{ f.stored_at }}</span>
          </li>
        {% else %}
          <li class="text-gray-500">فایلی ثبت نشده است.</li>
        {% endfor %}
      </ul>
    </div>

    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4 md:col-span-2">
      <h2 class="font-semibold mb-3">فروش‌ها / قراردادها</h2>
      <form method="post" action="{{ url_for('main.express_partner_add_sale') }}" class="grid md:grid-cols-4 gap-2 mb-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="title" class="border rounded-md px-3 py-2" placeholder="عنوان (مثلاً فروش زمین در ...)" required>
        <input type="text" name="amount" class="border rounded-md px-3 py-2" placeholder="مبلغ (تومان)">
        <input type="text" name="note" class="border rounded-md px-3 py-2" placeholder="یادداشت">
        <button class="px-3 py-2 rounded-md bg-vinor-600 text-white">ثبت</button>
      </form>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-right text-gray-600">
              <th class="p-2">#</th>
              <th class="p-2">عنوان</th>
              <th class="p-2">مبلغ</th>
              <th class="p-2">یادداشت</th>
              <th class="p-2">تاریخ</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sales %}
              <tr class="border-t">
                <td class="p-2">{{ s.id }}</td>
                <td class="p-2">{{ s.title }}</td>
                <td class="p-2">{{ s.amount }}</td>
                <td class="p-2">{{ s.note or '—' }}</td>
                <td class="p-2">{{ s.created_at }}</td>
              </tr>
            {% else %}
              <tr><td class="p-2 text-gray-500" colspan="5">فروشی ثبت نشده است.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}


