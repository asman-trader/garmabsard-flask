<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ (seo.title if seo else None) or (land.title or 'جزئیات فایل') }}</title>
  {% if seo %}
  <meta name="description" content="{{ seo.description }}">
  <meta name="keywords" content="{{ seo.keywords or 'فایل اکسپرس, خرید ملک, فروش ملک, وینور' }}">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <meta name="author" content="وینور اکسپرس | vinor.ir">
  <link rel="canonical" href="{{ seo.canonical or request.url }}">
  <!-- Open Graph -->
  <meta property="og:type" content="{{ seo.og_type or 'product' }}">
  <meta property="og:url" content="{{ seo.canonical or request.url }}">
  <meta property="og:title" content="{{ seo.title or (land.title or 'فایل اکسپرس') }}">
  <meta property="og:description" content="{{ seo.description or (land.title or 'فایل اکسپرس') }}">
  <meta property="og:image" content="{{ seo.og_image or (request.url_root + 'static/icons/icon-512.png') }}">
  {% if seo.price %}
  <meta property="product:price:amount" content="{{ seo.price }}">
  <meta property="product:price:currency" content="{{ seo.currency or 'IRR' }}">
  {% endif %}
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ seo.title or (land.title or 'فایل اکسپرس') }}">
  <meta name="twitter:description" content="{{ seo.description or (land.title or 'فایل اکسپرس') }}">
  <meta name="twitter:image" content="{{ seo.og_image or (request.url_root + 'static/icons/icon-512.png') }}">
  {% endif %}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjkM7yC4GdZ7+6puj8m0yP0A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    .progressive-img {
      filter: blur(12px);
      background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
      transition: filter 0.25s ease, opacity 0.2s ease;
    }
    .dark .progressive-img {
      background: linear-gradient(90deg, #1f2937 0%, #111827 50%, #1f2937 100%);
    }
    .progressive-img.is-loaded {
      filter: blur(0);
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen bg-white dark:bg-gray-950 pb-20">
    {% if is_partner_context %}
    <!-- Header (Partner context) -->
    <header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
      <div class="w-full px-3 sm:px-4 h-12 flex items-center justify-between gap-2">
        <a href="{{ url_for('express_partner.dashboard') }}"
           class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
           aria-label="بازگشت">
          <i class="fas fa-arrow-right text-gray-700 dark:text-gray-200 text-sm"></i>
        </a>
        <div class="flex-1 min-w-0 flex flex-col items-center">
          <h1 class="text-sm font-semibold text-gray-900 dark:text-white truncate max-w-full">
            {{ land.title or 'جزئیات فایل' }}
          </h1>
          {% if land.code %}
          <span class="text-[11px] text-gray-500 dark:text-gray-400 font-mono">
            کد {{ land.code }}
          </span>
          {% endif %}
        </div>
        <div class="w-9 h-9"></div>
      </div>
    </header>
    {% else %}
    <!-- Header (Public context) -->
    <header class="sticky top-0 z-30 bg-white/95 dark:bg-gray-900/95 border-b border-gray-200 dark:border-gray-800 backdrop-blur w-full">
      <div class="w-full px-2 sm:px-4 py-2 flex items-center justify-between gap-1 sm:gap-2">
        <button type="button"
                onclick="goToExplore()"
                class="w-9 h-9 flex-shrink-0 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 transition-colors"
                aria-label="بازگشت">
          <i class="fas fa-arrow-right text-sm"></i>
        </button>
        <nav aria-label="breadcrumb" class="flex-1 min-w-0 overflow-hidden">
          <ol class="flex items-center gap-1 sm:gap-2 text-[11px] sm:text-xs text-gray-600 dark:text-gray-400 overflow-hidden">
            <li class="flex-shrink-0">
              <a href="{{ url_for('main.index') }}" class="hover:text-gray-900 dark:hover:text-gray-100 whitespace-nowrap">خانه</a>
            </li>
            <li class="text-gray-400 flex-shrink-0">/</li>
            <li class="flex-shrink-0">
              <a href="{{ url_for('main.express_public_list') }}" class="hover:text-gray-900 dark:hover:text-gray-100 whitespace-nowrap">فایل‌ها</a>
            </li>
            <li class="text-gray-400 flex-shrink-0">/</li>
            <li class="text-gray-900 dark:text-gray-100 min-w-0 flex-1">
              <span class="block truncate">{{ land.title or 'جزئیات فایل' }}</span>
            </li>
          </ol>
        </nav>
        <button type="button"
                class="w-9 h-9 flex-shrink-0 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 copy-public-link transition-colors"
                data-url="{{ request.url }}"
                aria-label="کپی لینک">
          <i class="fas fa-share-nodes text-sm"></i>
        </button>
      </div>
    </header>
    {% endif %}

    <!-- Gallery -->
    <div class="max-w-6xl mx-auto px-3 sm:px-4">
      <!-- Desktop layout: main + sidebar -->
      <div class="lg:grid lg:grid-cols-12 lg:gap-6">
        <!-- Main Column -->
        <div class="lg:col-span-8">
          <div class="relative -mt-px mb-4 bg-black/5 dark:bg-black/20 w-full">
      {% set images = land.images or [] %}
      {% set video = land.video %}
      {% set has_video = video and video.strip() %}
      {% set total_items = (1 if has_video else 0) + images|length %}
      {% set primary_image = images[0] if images else None %}
      {% set images_v2 = land.images_v2 or [] %}
      {% set primary_image_v2 = images_v2[0] if images_v2 else None %}

      <div class="w-full pt-0 pb-2 lg:pb-4">
        {% if has_video or primary_image %}
          {% if video and ("://" in (video|string)) %}
            {% set video_src = video %}
          {% elif video and (video|string).startswith('/uploads/') %}
            {% set video_src = video %}
          {% elif video and (video|string).startswith('uploads/') %}
            {% set video_src = '/uploads/' + (video|string)[8:] %}
          {% elif video and not (video|string).startswith('/') %}
            {% set video_src = '/uploads/' + (video|string) %}
          {% else %}
            {% set video_src = video %}
          {% endif %}

          <div id="landGallery"
               class="aspect-[4/3] bg-gray-100 dark:bg-gray-900 relative overflow-hidden rounded-none sm:rounded-xl select-none"
               {% if not is_partner_context %}
               data-next-code="{{ next_land.code if next_land else '' }}"
               data-prev-code="{{ prev_land.code if prev_land else '' }}"
               {% endif %}>
            <style>
              #landGallery, #landGallery * { touch-action: pan-y; }
            </style>

            <div id="landMediaLoading"
                 class="absolute inset-0 z-40 flex items-center justify-center bg-black/35 backdrop-blur-[1px] text-white transition-opacity duration-200 opacity-0 pointer-events-none"
                 aria-hidden="true">
              <div class="flex flex-col items-center gap-2">
                <div class="w-10 h-10 rounded-full border-2 border-white/40 border-t-white animate-spin"></div>
                <div class="text-xs font-medium drop-shadow">در حال بارگذاری…</div>
              </div>
            </div>

            {% if has_video %}
            <video id="landVideo"
                   class="w-full h-full object-cover block"
                   controls
                   onclick="openLightbox('{{ video_src }}')">
              <source src="{{ video_src }}" type="video/mp4">
              مرورگر شما از پخش ویدیو پشتیبانی نمی‌کند.
            </video>
            {% endif %}

            {% if primary_image %}
              {% if images_v2 and primary_image_v2 %}
                {% set thumb_src = primary_image_v2.thumb or (primary_image_v2.full or primary_image) %}
                {% set full_src = primary_image_v2.full or (primary_image_v2.raw or primary_image) %}
              {% else %}
                {% if "://" in (primary_image|string) %}
                  {% set full_src = primary_image %}
                {% elif (primary_image|string).startswith('/uploads/') %}
                  {% set full_src = primary_image %}
                {% elif (primary_image|string).startswith('uploads/') %}
                  {% set full_src = '/uploads/' + (primary_image|string)[8:] %}
                {% elif not (primary_image|string).startswith('/') %}
                  {% set full_src = '/uploads/' + (primary_image|string) %}
                {% else %}
                  {% set full_src = primary_image %}
                {% endif %}
                {% set thumb_src = full_src %}
              {% endif %}
              <img id="landMainImage"
                   src="{{ thumb_src }}"
                   data-full="{{ full_src }}"
                   alt="{{ land.title }}"
                   class="w-full h-full object-cover cursor-pointer {% if has_video %}hidden{% else %}block{% endif %} {% if images_v2 %}progressive-img{% endif %}"
                   fetchpriority="high" decoding="async"
                   onclick="openLightbox(this.dataset.full || this.src)">
            {% endif %}

            {% if total_items > 1 %}
            {% if not is_partner_context %}
            <button type="button"
                    id="landPrev"
                    class="absolute inset-y-0 right-0 w-12 flex items-center justify-center bg-gradient-to-l from-black/35 to-transparent text-white text-lg focus:outline-none active:scale-95 z-30">
              <i class="fas fa-chevron-right drop-shadow"></i>
            </button>
            <button type="button"
                    id="landNext"
                    class="absolute inset-y-0 left-0 w-12 flex items-center justify-center bg-gradient-to-r from-black/35 to-transparent text-white text-lg focus:outline-none active:scale-95 z-30">
              <i class="fas fa-chevron-left drop-shadow"></i>
            </button>
            {% endif %}

            <div class="absolute bottom-2 inset-x-0 flex items-center justify-center gap-1.5 z-30">
              {% if has_video %}
              <span class="land-dot w-1.5 h-1.5 rounded-full bg-white/40 active"></span>
              {% endif %}
              {% for _ in images %}
              <span class="land-dot w-1.5 h-1.5 rounded-full bg-white/40 {% if not has_video and loop.first %}active{% endif %}"></span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        {% else %}
          <div class="aspect-[4/3] bg-gray-100 dark:bg-gray-900 flex items-center justify-center rounded-xl">
            <i class="fas fa-image text-4xl text-gray-300 dark:text-gray-700"></i>
          </div>
        {% endif %}
      </div>

      {% if land._assignment_status == 'in_transaction' %}
      <div class="absolute top-3 left-5">
        <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-[11px] font-semibold bg-orange-500 text-white shadow-sm">
          در حال معامله
        </span>
      </div>
      {% endif %}
    </div>

          <!-- Desktop thumbnail strip -->
          {% if total_items > 1 %}
          <div class="hidden lg:flex items-center gap-2 mt-2 overflow-x-auto">
            {% if has_video %}
            <button type="button" class="land-thumb w-20 h-16 rounded-md overflow-hidden bg-gray-200 dark:bg-gray-800 flex-shrink-0 ring-1 ring-transparent hover:ring-emerald-400 transition">
              <div class="w-full h-full grid place-items-center text-gray-600 dark:text-gray-300">
                <i class="fas fa-play"></i>
              </div>
            </button>
            {% endif %}
            {% for img in (images_v2 if images_v2 else images) %}
              {% if images_v2 %}
                {% set t = img.thumb %}
              {% else %}
                {% if "://" in (img|string) %}
                  {% set t = img %}
                {% elif (img|string).startswith('/uploads/') %}
                  {% set t = img %}
                {% elif (img|string).startswith('uploads/') %}
                  {% set t = '/uploads/' + (img|string)[8:] %}
                {% elif not (img|string).startswith('/') %}
                  {% set t = '/uploads/' + (img|string) %}
                {% else %}
                  {% set t = img %}
                {% endif %}
              {% endif %}
              <button type="button" class="land-thumb w-20 h-16 rounded-md overflow-hidden bg-gray-200 dark:bg-gray-800 flex-shrink-0 ring-1 ring-transparent hover:ring-emerald-400 transition">
                <img src="{{ t }}" alt="" class="w-full h-full object-cover">
              </button>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Sidebar (sticky on desktop) -->
        <aside class="hidden lg:block lg:col-span-4">
          <div class="sticky top-16 space-y-3">
            <!-- Price and commission (desktop) -->
            <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <div class="space-y-3">
                <div class="flex items-center justify-between pb-3 border-b border-gray-100 dark:border-gray-800">
                  <span class="text-sm text-gray-600 dark:text-gray-400">قیمت کل</span>
                  <span class="text-lg font-bold text-gray-900 dark:text-white">{{ (land.price_total or 0)|toman }}</span>
                </div>
                {% if land.price_per_meter %}
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 dark:text-gray-400">قیمت در متر</span>
                  <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.price_per_meter|toman }}</span>
                </div>
                {% endif %}
                {% if is_partner_context and is_approved and land._commission_amount %}
                <div class="flex items-center justify-between pt-3 border-t border-gray-100 dark:border-gray-800">
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">پورسانت شما</span>
                    {% if land._commission_pct %}
                    <span class="text-xs text-gray-500 dark:text-gray-400">({{ land._commission_pct }}%)</span>
                    {% endif %}
                  </div>
                  <span class="text-base font-bold text-gray-900 dark:text-white">{{ (land._commission_amount or 0)|toman }}</span>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Actions (desktop) -->
            {% if is_partner_context %}
              {% set _st = (land._assignment_status|default('active')) %}
              <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-2">
                {% set contact_phone = land.owner_phone or land.vinor_contact %}
                {% if contact_phone %}
                  {% if is_logged_in %}
                  <button type="button" onclick="openContactModal()"
                     class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-bold transition">
                    <i class="fas fa-phone"></i>
                    تماس
                  </button>
                  {% else %}
                  <a href="{{ url_for('express_partner.login', next=request.full_path) }}"
                     class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-bold transition">
                    <i class="fas fa-right-to-bracket"></i>
                    ورود برای تماس
                  </a>
                  {% endif %}
                {% else %}
                <div class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-gray-300 dark:bg-gray-800 text-gray-500">
                  <i class="fas fa-phone"></i>
                  تماس در دسترس نیست
                </div>
                {% endif %}

                {% if _st != 'sold' %}
                <form method="POST" action="{{ url_for('express_partner.mark_in_transaction', code=land.code) }}">
                  {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                  {% if _st == 'in_transaction' %}
                    <button type="submit" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800 hover:bg-emerald-100 transition">
                      <i class="fas fa-check-circle"></i>
                      رفع معامله
                    </button>
                  {% else %}
                    <button type="submit" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 border border-orange-200 dark:border-orange-800 hover:bg-orange-100 transition">
                      <i class="fas fa-handshake"></i>
                      معامله
                    </button>
                  {% endif %}
                </form>
                {% else %}
                <div class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800">
                  <i class="fas fa-check-double"></i>
                  فروخته شد
                </div>
                {% endif %}
              </div>

              {% if share_url %}
              <a href="{{ share_url }}" target="_blank" rel="noopener"
                 class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex items-center justify-between hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-800 grid place-items-center">
                    <i class="far fa-eye text-gray-600 dark:text-gray-300"></i>
                  </div>
                  <div class="text-right">
                    <div class="text-sm font-semibold text-gray-900 dark:text-white">صفحه عمومی فایل</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">نمایش لینک برای مشتری</div>
                  </div>
                </div>
                <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500"></i>
              </a>
              {% endif %}
            {% else %}
              <!-- Public: Consultant card (if any) -->
              {% if ref_partner %}
              <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-3">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-xl bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-300 grid place-items-center">
                    <i class="fas fa-user-tie text-sm"></i>
                  </div>
                  <div>
                    <p class="text-sm font-semibold text-gray-900 dark:text-gray-50">
                      {{ ref_partner.get('name') or 'مشاور' }}
                    </p>
                    <p class="text-[11px] text-gray-500 dark:text-gray-400">
                      {{ ref_partner.get('city') or 'مشاور منتخب' }}
                    </p>
                  </div>
                </div>
                {% if ref_partner.get('phone') %}
                <div class="grid grid-cols-2 gap-2 text-xs sm:text-sm">
                  <a href="tel:{{ ref_partner.get('phone') }}"
                     class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition">
                    <i class="fas fa-phone"></i>
                    تماس
                  </a>
                  <a href="sms:{{ ref_partner.get('phone') }}"
                     class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg border border-emerald-200 text-emerald-700 hover:bg-emerald-50 transition">
                    <i class="fas fa-sms"></i>
                    پیامک
                  </a>
                </div>
                {% endif %}
              </div>
              {% endif %}
            {% endif %}
          </div>
        </aside>
      </div>
    </div>

    <div class="max-w-4xl lg:max-w-6xl mx-auto px-3 sm:px-4 space-y-4">
      <!-- عنوان و اطلاعات اصلی -->
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">{{ land.title or '—' }}</h2>
        <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600 dark:text-gray-400">
          {% if land.location or land.city %}
          <span class="flex items-center gap-1.5">
            <i class="fas fa-map-marker-alt text-xs"></i>
            {{ land.location or land.city }}
          </span>
          {% endif %}
          {% if land.size %}
          <span class="flex items-center gap-1.5">
            <i class="fas fa-ruler-combined text-xs"></i>
            {{ land.size }} متر
          </span>
          {% endif %}
          {% if land.category %}
          <span class="flex items-center gap-1.5">
            <i class="fas fa-tag text-xs"></i>
            {{ land.category }}
          </span>
          {% endif %}
        </div>
      </div>

      <!-- قیمت و پورسانت (mobile-first; hidden on desktop in favor of sidebar) -->
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 lg:hidden">
        <div class="space-y-3">
          <div class="flex items-center justify-between pb-3 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">قیمت کل</span>
            <span class="text-lg font-bold text-gray-900 dark:text-white">{{ (land.price_total or 0)|toman }}</span>
          </div>
          {% if land.price_per_meter %}
          <div class="flex items-center justify-between pb-3 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">قیمت در متر</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.price_per_meter|toman }}</span>
          </div>
          {% endif %}
          {% if is_partner_context and is_approved and land._commission_amount %}
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-600 dark:text-gray-400">پورسانت شما</span>
              {% if land._commission_pct %}
              <span class="text-xs text-gray-500 dark:text-gray-400">({{ land._commission_pct }}%)</span>
              {% endif %}
            </div>
            <span class="text-lg font-bold text-gray-900 dark:text-white">{{ (land._commission_amount or 0)|toman }}</span>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- توضیحات -->
      {% if land.description %}
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">توضیحات</h3>
        <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line">{{ land.description }}</p>
      </div>
      {% endif %}

      <!-- جزئیات -->
      {% if land.payment_method or (land.payment_terms and land.payment_terms|length > 0) or land.rooms or land.floor or land.year_built or land.docs_status or land.features %}
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">جزئیات</h3>
        <div class="space-y-2">
          {% if land.payment_method %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">نحوه پرداخت</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.payment_method }}</span>
          </div>
          {% if land.payment_method == 'اقساطی' and land.payment_terms and land.payment_terms|length > 0 %}
          <div class="py-2">
            <span class="text-sm text-gray-600 dark:text-gray-400 block mb-2">جزئیات اقساط</span>
            <div class="space-y-2">
              {% for t in land.payment_terms %}
              <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">{{ (t.months or 0) }} ماهه</span>
                <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ (t.amount or 0)|toman }}</span>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% endif %}
          {% if land.rooms %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">اتاق</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.rooms }}</span>
          </div>
          {% endif %}
          {% if land.floor %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">طبقه</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.floor }}</span>
          </div>
          {% endif %}
          {% if land.year_built %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">سال ساخت</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.year_built }}</span>
          </div>
          {% endif %}
          {% if land.docs_status %}
          <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-sm text-gray-600 dark:text-gray-400">وضعیت سند</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.docs_status }}</span>
          </div>
          {% endif %}
          {% if land.features %}
          <div class="py-2">
            <span class="text-sm text-gray-600 dark:text-gray-400 block mb-1">امکانات</span>
            <span class="text-sm text-gray-900 dark:text-white whitespace-pre-line">{{ land.features }}</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- موقعیت دقیق -->
      {% if land.latitude and land.longitude %}
      <button type="button" onclick="openLocationModal()"
              class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex items-center justify-between hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
            <i class="fas fa-map-marker-alt text-gray-600 dark:text-gray-400"></i>
          </div>
          <div class="text-right">
            <div class="text-sm font-semibold text-gray-900 dark:text-white">موقعیت دقیق</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">باز کردن در نقشه</div>
          </div>
        </div>
        <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500"></i>
      </button>

      <!-- مودال موقعیت -->
      <div id="locationModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/60" onclick="closeLocationModal()"></div>
        <div class="absolute bottom-0 inset-x-0 bg-white dark:bg-gray-900 rounded-t-3xl p-6 space-y-4 animate-slide-up">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">باز کردن با</h3>
            <button onclick="closeLocationModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
              <i class="fas fa-times text-gray-500"></i>
            </button>
          </div>
          <a href="https://www.google.com/maps?q={{ land.latitude }},{{ land.longitude }}" target="_blank" rel="noopener"
             class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
            <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
              <i class="fab fa-google text-red-500 text-xl"></i>
            </div>
            <div class="font-semibold text-gray-900 dark:text-white">Google Maps</div>
          </a>
          <a href="https://waze.com/ul?ll={{ land.latitude }},{{ land.longitude }}&navigate=yes" target="_blank" rel="noopener"
             class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
            <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
              <i class="fas fa-route text-blue-500 text-xl"></i>
            </div>
            <div class="font-semibold text-gray-900 dark:text-white">Waze</div>
          </a>
          <a href="geo:{{ land.latitude }},{{ land.longitude }}"
             class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
            <div class="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
              <i class="fas fa-location-arrow text-purple-500 text-xl"></i>
            </div>
            <div class="font-semibold text-gray-900 dark:text-white">مسیریاب پیش‌فرض</div>
          </a>
        </div>
      </div>
      {% endif %}

      <!-- لینک صفحه عمومی -->
      {% if is_partner_context and share_url %}
      <a href="{{ share_url }}" target="_blank" rel="noopener"
         class="w-full mt-3 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex items-center justify-between hover:border-gray-300 dark:hover:border-gray-600 transition-colors lg:hidden">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
            <i class="far fa-eye text-gray-600 dark:text-gray-300"></i>
          </div>
          <div class="text-right">
            <div class="text-sm font-semibold text-gray-900 dark:text-white">صفحه عمومی فایل</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">نمایش لینک برای مشتری</div>
          </div>
        </div>
        <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500"></i>
      </a>
      {% endif %}

      {% if (not is_partner_context) and ref_partner %}
      <!-- اطلاعات مشاور برای عموم -->
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-300 grid place-items-center">
            <i class="fas fa-user-tie text-sm"></i>
          </div>
          <div>
            <p class="text-sm font-semibold text-gray-900 dark:text-gray-50">
              {{ ref_partner.get('name') or 'مشاور' }}
            </p>
            <p class="text-[11px] text-gray-500 dark:text-gray-400">
              {{ ref_partner.get('city') or 'مشاور منتخب' }}
            </p>
          </div>
        </div>
        {% if ref_partner.get('phone') %}
        <div class="grid grid-cols-2 gap-2 text-xs sm:text-sm mt-3">
          {% if is_logged_in %}
          <a href="tel:{{ ref_partner.get('phone') }}"
             class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition">
            <i class="fas fa-phone"></i>
            تماس مستقیم
          </a>
          <a href="sms:{{ ref_partner.get('phone') }}"
             class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg border border-emerald-200 text-emerald-700 hover:bg-emerald-50 transition">
            <i class="fas fa-sms"></i>
            پیامک
          </a>
          {% else %}
          <a href="{{ url_for('express_partner.login', next=request.full_path) }}"
             class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition col-span-2">
            <i class="fas fa-right-to-bracket"></i>
            ورود برای تماس
          </a>
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- تماس و معامله (دسکتاپ) - Partner context (moved to sidebar); keep here only for small screens -->
      {% if is_partner_context %}
      <div class="mt-3 hidden sm:block lg:hidden">
        {% set contact_phone = land.owner_phone or land.vinor_contact %}
        {% if contact_phone %}
        {% if is_logged_in %}
        <button type="button" onclick="openContactModal()"
           class="w-full flex items-center justify-between px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-emerald-50 dark:bg-emerald-900/30 flex items-center justify-center">
              <i class="fas fa-phone text-emerald-600 dark:text-emerald-300"></i>
            </div>
            <div class="text-right">
              <div class="text-sm font-semibold text-gray-900 dark:text-white">تماس با مالک/پشتیبان</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">انتخاب روش تماس</div>
            </div>
          </div>
          <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500"></i>
        </button>
        {% else %}
        <a href="{{ url_for('express_partner.login', next=request.full_path) }}"
           class="w-full flex items-center justify-between px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 hover:border-gray-300 dark:hover:bg-gray-600 transition-colors">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-emerald-50 dark:bg-emerald-900/30 flex items-center justify-center">
              <i class="fas fa-right-to-bracket text-emerald-600 dark:text-emerald-300"></i>
            </div>
            <div class="text-right">
              <div class="text-sm font-semibold text-gray-900 dark:text-white">ورود برای تماس</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">جهت مشاهده شماره تماس وارد شوید</div>
            </div>
          </div>
          <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500"></i>
        </a>
        {% endif %}
        {% else %}
        <div class="w-full flex items-center justify-between px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 opacity-60">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
              <i class="fas fa-phone text-gray-400"></i>
            </div>
            <div class="text-right">
              <div class="text-sm font-semibold text-gray-500 dark:text-gray-400">اطلاعات تماس ثبت نشده</div>
              <div class="text-xs text-gray-400">لطفاً با پشتیبانی وینور هماهنگ کنید</div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      {% set _st = (land._assignment_status|default('active')) %}
      {% if _st != 'sold' %}
      <form method="POST" action="{{ url_for('express_partner.mark_in_transaction', code=land.code) }}" class="hidden sm:block lg:hidden">
        {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        {% if _st == 'in_transaction' %}
          <button type="submit" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-emerald-200 dark:border-emerald-800 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 transition-colors mt-3">
            <i class="fas fa-check-circle"></i>
            <span class="text-sm font-medium">رفع معامله</span>
          </button>
        {% else %}
          <button type="submit" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-orange-200 dark:border-orange-800 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/30 transition-colors mt-3">
            <i class="fas fa-handshake"></i>
            <span class="text-sm font-medium">معامله</span>
          </button>
        {% endif %}
      </form>
      {% else %}
      <div class="hidden sm:flex lg:hidden items-center justify-center gap-2 px-4 py-3 rounded-lg border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 mt-3">
        <i class="fas fa-check-double"></i>
        <span class="text-sm font-medium">فروخته شد</span>
      </div>
      {% endif %}
      {% endif %}

      <!-- فضای خالی برای دکمه ثابت پایین در موبایل (Partner) -->
      {% if is_partner_context %}
      <div class="h-20 sm:hidden"></div>
      {% endif %}
    </div>
  </div>

  {% set contact_phone = (land.owner_phone or land.vinor_contact) if is_partner_context else (ref_partner.get('phone') if ref_partner else None) %}

  {% if is_partner_context %}
  <!-- دکمه‌های ثابت پایین (Partner - فقط موبایل) -->
  {% set _st = (land._assignment_status|default('active')) %}
  <div class="fixed bottom-0 inset-x-0 p-4 bg-white/80 dark:bg-gray-950/80 backdrop-blur-md border-t border-gray-200 dark:border-gray-800 sm:hidden z-50">
    <div class="grid grid-cols-2 gap-3">
      {% if contact_phone %}
      <button type="button" onclick="openContactModal()"
         class="flex items-center justify-center gap-2 py-3 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-bold transition-colors">
        <i class="fas fa-phone"></i>
        تماس
      </button>
      {% else %}
      <div class="flex items-center justify-center gap-2 py-3 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-500 opacity-50">
        <i class="fas fa-phone"></i>
        تماس
      </div>
      {% endif %}

      {% if _st != 'sold' %}
      <form method="POST" action="{{ url_for('express_partner.mark_in_transaction', code=land.code) }}" class="h-full">
        {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        {% if _st == 'in_transaction' %}
        <button type="submit" class="w-full h-full flex items-center justify-center gap-2 py-3 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-bold transition-colors">
          <i class="fas fa-check-circle"></i>
          رفع معامله
        </button>
        {% else %}
        <button type="submit" class="w-full h-full flex items-center justify-center gap-2 py-3 rounded-xl bg-orange-500 hover:bg-orange-600 text-white font-bold transition-colors">
          <i class="fas fa-handshake"></i>
          معامله
        </button>
        {% endif %}
      </form>
      {% else %}
      <div class="flex items-center justify-center gap-2 py-3 rounded-xl bg-green-500 text-white font-bold">
        <i class="fas fa-check-double"></i>
        فروخته شد
      </div>
      {% endif %}
    </div>
  </div>
  {% else %}
  <!-- نوار تماس ثابت پایین (Public) -->
  {% if contact_phone %}
  <div class="fixed inset-x-0 bottom-0 z-30 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 lg:hidden">
    <div class="max-w-4xl mx-auto px-4 py-3">
      {% if is_logged_in %}
        <button type="button"
                onclick="openContactModal()"
                class="w-full flex items-center justify-center gap-2 px-4 py-3.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white text-sm font-bold shadow-sm transition-colors">
          <i class="fas fa-phone text-base"></i>
          <span>تماس</span>
        </button>
      {% else %}
        <a href="{{ url_for('express_partner.login', next=request.full_path) }}"
           class="w-full flex items-center justify-center gap-2 px-4 py-3.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white text-sm font-bold shadow-sm transition-colors">
          <i class="fas fa-right-to-bracket text-base"></i>
          <span>ورود برای تماس</span>
        </a>
      {% endif %}
    </div>
  </div>
  {% endif %}
  {% endif %}

  <!-- مودال تماس -->
  <div id="contactModal" class="fixed inset-0 z-[200] hidden" style="display: none; flex-direction: column;">
    <div class="absolute inset-0 bg-black/60" onclick="closeContactModal()"></div>
    <div class="absolute bottom-0 inset-x-0 bg-white dark:bg-gray-900 rounded-t-3xl p-6 space-y-4 animate-slide-up max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white">انتخاب روش تماس</h3>
        <button onclick="closeContactModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
          <i class="fas fa-times text-gray-500"></i>
        </button>
      </div>
      {% if contact_phone %}
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <a href="tel:{{ contact_phone }}"
           class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold inline-flex items-center justify-center gap-2 transition">
          <i class="fas fa-phone"></i>
          تماس
        </a>
        <a href="sms:{{ contact_phone }}"
           class="w-full py-3 rounded-xl border-2 border-emerald-200 dark:border-emerald-700 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 font-semibold inline-flex items-center justify-center gap-2 transition">
          <i class="fas fa-sms text-lg"></i>
          پیامک
        </a>
      </div>
      {% else %}
      <div class="text-center py-6">
        <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-info-circle text-2xl text-gray-400 dark:text-gray-600"></i>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400">اطلاعات تماس برای این فایل در دسترس نیست.</p>
      </div>
      {% endif %}
    </div>
  </div>

  <style>
    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slide-up 0.3s ease-out; }
  </style>

  <script>
    // ذخیره referrer برای دکمه بازگشت (public)
    (function() {
      if (!{{ 'true' if not is_partner_context else 'false' }}) return;
      try {
        const referer = document.referrer || '';
        if (referer && referer.includes('/public')) {
          const saved = sessionStorage.getItem('express_detail_referer');
          if (!saved) sessionStorage.setItem('express_detail_referer', referer);
        }
      } catch (_) {}
    })();

    function goToExplore() {
      sessionStorage.removeItem('express_detail_referer');
      window.location.href = '{{ url_for("main.express_public_list") }}';
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Gallery logic (from partner version)
      (function(){
        const galleryEl = document.getElementById('landGallery');
        if (!galleryEl) return;
        const mainImg = document.getElementById('landMainImage');
        const mainVideo = document.getElementById('landVideo');
        const loadingEl = document.getElementById('landMediaLoading');
        const hasVideo = !!mainVideo;

        const images = [
          {% if images_v2 %}
            {% for i in images_v2 %}
              {"thumb": "{{ i.thumb }}", "full": "{{ i.full or i.raw }}"}{% if not loop.last %},{% endif %}
            {% endfor %}
          {% else %}
            {% for img in images %}
              {"thumb": "{% if '://' in (img|string) %}{{ img }}{% elif (img|string).startswith('/uploads/') %}{{ img }}{% elif (img|string).startswith('uploads/') %}/uploads/{{ (img|string)[8:] }}{% elif not (img|string).startswith('/') %}/uploads/{{ img }}{% else %}{{ img }}{% endif %}", "full": "{% if '://' in (img|string) %}{{ img }}{% elif (img|string).startswith('/uploads/') %}{{ img }}{% elif (img|string).startswith('uploads/') %}/uploads/{{ (img|string)[8:] }}{% elif not (img|string).startswith('/') %}/uploads/{{ img }}{% else %}{{ img }}{% endif %}"}{% if not loop.last %},{% endif %}
            {% endfor %}
          {% endif %}
        ];

        {% if video %}
        const videoSrc = "{% if '://' in (video|string) %}{{ video }}{% elif (video|string).startswith('/uploads/') %}{{ video }}{% elif (video|string).startswith('uploads/') %}/uploads/{{ (video|string)[8:] }}{% elif video and not (video|string).startswith('/') %}/uploads/{{ video }}{% else %}{{ video }}{% endif %}";
        {% else %}
        const videoSrc = null;
        {% endif %}

        const totalItems = (hasVideo ? 1 : 0) + images.length;
        if (totalItems <= 1) {
          // Progressive upgrade initial
          try {
            if (mainImg && mainImg.dataset.full && mainImg.dataset.full !== mainImg.src) {
              const hi0 = new Image();
              hi0.decoding = 'async';
              hi0.src = mainImg.dataset.full;
              hi0.addEventListener('load', () => {
                mainImg.src = mainImg.dataset.full;
                mainImg.classList.add('is-loaded');
              }, { once: true });
              hi0.addEventListener('error', () => mainImg.classList.add('is-loaded'), { once: true });
            }
          } catch(_){}
          return;
        }

        let currentIndex = 0;
        const dots = Array.from(document.querySelectorAll('.land-dot'));
        const prevBtn = document.getElementById('landPrev');
        const nextBtn = document.getElementById('landNext');
        let loadingFallbackTimer = null;

        function setLoading(isLoading) {
          if (!loadingEl) return;
          if (loadingFallbackTimer) {
            clearTimeout(loadingFallbackTimer);
            loadingFallbackTimer = null;
          }
          if (isLoading) {
            loadingEl.classList.remove('opacity-0', 'pointer-events-none');
            loadingEl.classList.add('opacity-100');
            loadingEl.setAttribute('aria-hidden', 'false');
            loadingFallbackTimer = setTimeout(() => {
              setLoading(false);
            }, 5000);
          } else {
            loadingEl.classList.add('opacity-0', 'pointer-events-none');
            loadingEl.classList.remove('opacity-100');
            loadingEl.setAttribute('aria-hidden', 'true');
          }
        }

        function waitForImageLoad() {
          if (!mainImg) return setLoading(false);
          if (mainImg.complete && mainImg.naturalWidth > 0) {
            return setLoading(false);
          }
          const done = () => setLoading(false);
          mainImg.addEventListener('load', done, { once: true });
          mainImg.addEventListener('error', done, { once: true });
        }

        function waitForVideoLoad() {
          if (!mainVideo) return setLoading(false);
          if (mainVideo.readyState >= 2) {
            return setLoading(false);
          }
          const done = () => setLoading(false);
          mainVideo.addEventListener('loadeddata', done, { once: true });
          mainVideo.addEventListener('canplay', done, { once: true });
          mainVideo.addEventListener('error', done, { once: true });
        }

        function updateDots() {
          if (!dots.length) return;
          dots.forEach((d, idx) => {
            if (idx === currentIndex) {
              d.classList.remove('bg-white/40');
              d.classList.add('bg-white');
              d.classList.add('active');
            } else {
              d.classList.remove('bg-white');
              d.classList.remove('active');
              d.classList.add('bg-white/40');
            }
          });
        }

        function showItem(idx) {
          currentIndex = (idx + totalItems) % totalItems;
          setLoading(true);
          if (hasVideo && currentIndex === 0) {
            if (mainVideo) {
              mainVideo.classList.remove('hidden');
              mainVideo.classList.add('block');
            }
            if (mainImg) {
              mainImg.classList.add('hidden');
              mainImg.classList.remove('block');
            }
            waitForVideoLoad();
          } else {
            const idx = hasVideo ? currentIndex - 1 : currentIndex;
            const imgObj = images[idx];
            if (mainImg && imgObj) {
              const thumb = imgObj.thumb || imgObj.full;
              const full = imgObj.full || thumb;
              if (thumb) {
                mainImg.classList.remove('is-loaded');
                mainImg.src = thumb;
                mainImg.dataset.full = full;
                if (full && full !== thumb) {
                  const hi = new Image();
                  hi.decoding = 'async';
                  hi.src = full;
                  hi.addEventListener('load', () => { mainImg.src = full; mainImg.classList.add('is-loaded'); }, { once: true });
                  hi.addEventListener('error', () => mainImg.classList.add('is-loaded'), { once: true });
                } else {
                  mainImg.addEventListener('load', () => mainImg.classList.add('is-loaded'), { once: true });
                }
              }
              mainImg.classList.remove('hidden');
              mainImg.classList.add('block');
            }
            if (mainVideo) {
              mainVideo.classList.add('hidden');
              mainVideo.classList.remove('block');
              mainVideo.pause();
            }
            waitForImageLoad();
          }
          updateDots();
        }

        prevBtn && prevBtn.addEventListener('click', function(e){
          e.preventDefault();
          showItem(currentIndex - 1);
        }, { passive: false });
        nextBtn && nextBtn.addEventListener('click', function(e){
          e.preventDefault();
          showItem(currentIndex + 1);
        }, { passive: false });

        function bindSwipeListeners(el) {
          if (!el) return;
          let touchStartX = null;
          let touchEndX = null;
          let isPointerDown = false;
          const SWIPE_THRESHOLD = 20;

          el.addEventListener('touchstart', function(e){
            const t = e.touches && e.touches[0];
            if (!t) return;
            touchStartX = t.clientX;
            touchEndX = null;
          }, { passive: true });
          el.addEventListener('touchmove', function(e){
            const t = e.touches && e.touches[0];
            if (!t || touchStartX === null) return;
            touchEndX = t.clientX;
          }, { passive: true });
          el.addEventListener('touchend', function(e){
            if (touchStartX === null) return;
            const t = (e.changedTouches && e.changedTouches[0]) || null;
            const endX = (touchEndX !== null) ? touchEndX : (t ? t.clientX : null);
            if (endX === null) return;
            const dx = endX - touchStartX;
            if (Math.abs(dx) > SWIPE_THRESHOLD) {
              if (dx < 0) showItem(currentIndex + 1);
              else showItem(currentIndex - 1);
            }
            touchStartX = null;
            touchEndX = null;
          }, { passive: true });

          el.addEventListener('pointerdown', function(e){
            if (e.pointerType === 'mouse' && e.button !== 0) return;
            isPointerDown = true;
            touchStartX = e.clientX;
            touchEndX = null;
            try { el.setPointerCapture(e.pointerId); } catch(_) {}
          });
          el.addEventListener('pointermove', function(e){
            if (!isPointerDown || touchStartX === null) return;
            touchEndX = e.clientX;
          });
          el.addEventListener('pointerup', function(e){
            if (!isPointerDown || touchStartX === null) return;
            isPointerDown = false;
            const endX = (touchEndX !== null) ? touchEndX : e.clientX;
            const dx = endX - touchStartX;
            if (Math.abs(dx) > SWIPE_THRESHOLD) {
              if (dx < 0) showItem(currentIndex + 1);
              else showItem(currentIndex - 1);
            }
            touchStartX = null;
            touchEndX = null;
            try { el.releasePointerCapture(e.pointerId); } catch(_) {}
          });
          el.addEventListener('pointercancel', function(){
            isPointerDown = false;
            touchStartX = null;
            touchEndX = null;
          });
        }

        bindSwipeListeners(galleryEl);
        bindSwipeListeners(mainImg);
        bindSwipeListeners(mainVideo);

        updateDots();
        setLoading(true);
        if (hasVideo && currentIndex === 0) {
          waitForVideoLoad();
        } else {
          waitForImageLoad();
        }

        // Progressive upgrade initial
        try {
          if (mainImg && mainImg.dataset.full && mainImg.dataset.full !== mainImg.src) {
            const hi = new Image();
            hi.decoding = 'async';
            hi.src = mainImg.dataset.full;
            hi.addEventListener('load', () => { mainImg.src = mainImg.dataset.full; mainImg.classList.add('is-loaded'); }, { once: true });
            hi.addEventListener('error', () => mainImg.classList.add('is-loaded'), { once: true });
          } else if (mainImg && mainImg.complete) {
            mainImg.classList.add('is-loaded');
          }
        } catch(_){}
      })();

      // Public-only: vertical swipe navigation between listings
      {% if not is_partner_context %}
      (function() {
        const galleryEl = document.getElementById('landGallery');
        const container = document.querySelector('.min-h-screen');
        if (!galleryEl || !container) return;
        const nextCode = galleryEl.getAttribute('data-next-code');
        const prevCode = galleryEl.getAttribute('data-prev-code');
        const allLands = {{ all_lands | tojson if all_lands else '[]' }};
        const currentIndex = {{ current_index if current_index is defined else -1 }};
        const SCROLL_THRESHOLD = 50;
        const VERTICAL_SWIPE_THRESHOLD = 100;

        function isAtBottom() {
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          const windowHeight = window.innerHeight;
          const documentHeight = document.documentElement.scrollHeight;
          return (scrollTop + windowHeight >= documentHeight - SCROLL_THRESHOLD);
        }
        function isAtTop() {
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          return scrollTop <= SCROLL_THRESHOLD;
        }
        function getNextCode() {
          if (nextCode) return nextCode;
          if (allLands.length === 0 || currentIndex < 0) return null;
          const nextIndex = (currentIndex + 1) % allLands.length;
          return allLands[nextIndex]?.code || null;
        }
        function getPrevCode() {
          if (prevCode) return prevCode;
          if (allLands.length === 0 || currentIndex < 0) return null;
          const prevIndex = (currentIndex - 1 + allLands.length) % allLands.length;
          return allLands[prevIndex]?.code || null;
        }
        function handleVerticalSwipe(dy, wasAtBottom, wasAtTop) {
          if (Math.abs(dy) < VERTICAL_SWIPE_THRESHOLD) return;
          if (dy < 0) {
            if (wasAtBottom) {
              const n = getNextCode();
              if (n) window.location.replace('/express/' + n);
            }
          } else if (dy > 0) {
            if (wasAtTop) {
              const p = getPrevCode();
              if (p) window.location.replace('/express/' + p);
            }
          }
        }
        let verticalTouchStartY = null, verticalTouchEndY = null, scrollPositionAtStart = null;
        container.addEventListener('touchstart', function(e) {
          verticalTouchStartY = e.touches[0].clientY;
          scrollPositionAtStart = { isAtBottom: isAtBottom(), isAtTop: isAtTop() };
        }, { passive: true });
        container.addEventListener('touchmove', function(e) {
          verticalTouchEndY = e.touches[0].clientY;
        }, { passive: true });
        container.addEventListener('touchend', function() {
          if (verticalTouchStartY !== null && verticalTouchEndY !== null && scrollPositionAtStart) {
            const dy = verticalTouchEndY - verticalTouchStartY;
            handleVerticalSwipe(dy, scrollPositionAtStart.isAtBottom, scrollPositionAtStart.isAtTop);
          }
          verticalTouchStartY = null; verticalTouchEndY = null; scrollPositionAtStart = null;
        }, { passive: true });
        document.addEventListener('keydown', function(e) {
          if (e.key === 'ArrowUp') {
            if (isAtBottom()) {
              const n = getNextCode();
              if (n) { e.preventDefault(); window.location.replace('/express/' + n); }
            }
          } else if (e.key === 'ArrowDown') {
            if (isAtTop()) {
              const p = getPrevCode();
              if (p) { e.preventDefault(); window.location.replace('/express/' + p); }
            }
          }
        });
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const n = getNextCode();
              if (n) {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = '/express/' + n;
                document.head.appendChild(link);
              }
            }
          });
        }, { rootMargin: '200px' });
        const footer = document.querySelector('.fixed.inset-x-0.bottom-0');
        if (footer) observer.observe(footer);
      })();
      {% endif %}
    });

    // Contact modal
    function openContactModal() {
      const modal = document.getElementById('contactModal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }
    function closeContactModal() {
      const modal = document.getElementById('contactModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
    }

    // Location modal
    function openLocationModal() {
      document.getElementById('locationModal')?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    function closeLocationModal() {
      document.getElementById('locationModal')?.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Lightbox image/video
    function openLightbox(src) {
      try {
        const lightbox = document.createElement('div');
        lightbox.className = 'fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4';
        lightbox.style.touchAction = 'pan-y';
        lightbox.onclick = () => lightbox.remove();
        const content = document.createElement('div');
        content.className = 'relative w-full h-full flex items-center justify-center';
        content.onclick = (e) => e.stopPropagation();
        const img = new Image();
        img.className = 'max-w-full max-h-full object-contain rounded-lg';
        img.onload = () => {};
        img.onerror = () => {};
        img.src = src;
        content.appendChild(img);
        const closeBtn = document.createElement('button');
        closeBtn.className = 'absolute top-4 right-4 w-10 h-10 rounded-full bg-white/10 text-white text-xl hover:bg-white/20 transition-colors';
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.onclick = (e) => { e.stopPropagation(); lightbox.remove(); };
        lightbox.appendChild(content);
        lightbox.appendChild(closeBtn);
        document.body.appendChild(lightbox);
      } catch(_) {}
    }

    // Copy link (public)
    document.querySelectorAll('.copy-public-link').forEach(function(btn) {
      btn.addEventListener('click', async function () {
        const url = btn.dataset.url || window.location.href;
        try {
          await navigator.clipboard.writeText(url);
          const icon = btn.querySelector('i');
          if (icon) {
            icon.className = 'fas fa-check text-emerald-600';
            setTimeout(() => { icon.className = 'fas fa-share-nodes text-sm'; }, 2000);
          }
        } catch (error) { console.error(error); alert('امکان کپی لینک وجود ندارد'); }
      }, { passive: true });
    });
  </script>

  {% if seo %}
  <!-- JSON-LD (optional) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": "{{ land.title or 'فایل اکسپرس' }}",
    "description": "{{ seo.description or (land.title or 'فایل اکسپرس') }}",
    "url": "{{ seo.canonical or request.url }}",
    {% if land.images and land.images|length > 0 %}
    "image": [
      {% for img in (land.images if land.images is iterable else [land.images]) %}
      {% if "://" in (img|string) %}
      "{{ img }}"{% if not loop.last %},{% endif %}
      {% elif (img|string).startswith('/uploads/') %}
      "{{ request.url_root.rstrip('/') }}{{ img }}"{% if not loop.last %},{% endif %}
      {% else %}
      "{{ request.url_root.rstrip('/') }}/uploads/{{ img }}"{% if not loop.last %},{% endif %}
      {% endif %}
      {% endfor %}
    ],
    {% endif %}
    {% if land.price_total %}
    "offers": {
      "@type": "Offer",
      "price": "{{ land.price_total }}",
      "priceCurrency": "IRR",
      "availability": "https://schema.org/InStock",
      "url": "{{ seo.canonical or request.url }}"
    },
    {% endif %}
    "brand": {
      "@type": "Organization",
      "name": "وینور اکسپرس",
      "url": "{{ request.url_root.rstrip('/') }}"
    },
    "category": "{{ land.category or 'املاک' }}"
  }
  </script>
  {% endif %}
</body>
</html>


