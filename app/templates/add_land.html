{% extends "base.html" %}
{% set hide_header = True %}
{% block title %}ุซุจุช ุขฺฏู ุฌุฏุฏ | ูููุฑ{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 shadow-sm sm:shadow rounded-none sm:rounded-2xl mt-0 sm:mt-6 overflow-hidden">

  <!-- ูุฏุฑ ูุฑู (Step 2 of 3) -->
  <header class="px-4 sm:px-6 py-4 bg-gradient-to-l from-green-50 to-white dark:from-gray-800 dark:to-gray-800 border-b dark:border-gray-700">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
          <i class="fas fa-file-signature text-green-600"></i>
        </div>
        <div>
          <h1 class="text-base sm:text-lg font-bold text-gray-800 dark:text-white">ุซุจุช ุขฺฏู ุฌุฏุฏ</h1>
          <p class="text-[11px] text-gray-500">ฺฏุงู ฒ ุงุฒ ณ โ ุงุทูุงุนุงุช ุขฺฏู</p>
        </div>
      </div>

      <!-- ุงฺฉุดูโูุง ูุฏุฑ: ุจุงุฒฺฏุดุช + ูพุงฺฉโฺฉุฑุฏู ูุฑู -->
      <div class="flex items-center gap-2">
        <a href="{{ url_for('main.index') }}" class="hidden sm:inline-flex items-center gap-2 text-sm px-3 py-2 rounded-xl border hover:bg-gray-50 dark:hover:bg-gray-700">
          <i class="fas fa-arrow-right"></i>
          ุจุงุฒฺฏุดุช
        </a>
        <button type="button" id="btnResetForm" class="inline-flex items-center gap-2 text-sm px-3 py-2 rounded-xl border text-red-600 border-red-300 hover:bg-red-50 dark:hover:bg-red-900/20 transition">
          <i class="fas fa-rotate-left"></i>
          ูพุงฺฉโฺฉุฑุฏู ูุฑู
        </button>
      </div>
    </div>
  </header>

  <!-- Stepper (1 โ 2 โ 3) -->
  <div class="px-4 sm:px-6 py-3 border-b dark:border-gray-700 bg-white/70 dark:bg-gray-900/70">
    <div class="flex items-center gap-3 text-xs text-gray-600 dark:text-gray-300">
      <div class="flex items-center gap-2">
        <span class="w-6 h-6 grid place-items-center rounded-full bg-emerald-600 text-white">1</span>
        <span class="hidden sm:inline">ุงูุชุฎุงุจ ุฏุณุชู</span>
      </div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center gap-2">
        <span class="w-6 h-6 grid place-items-center rounded-full bg-emerald-600 text-white">2</span>
        <span class="hidden sm:inline">ุงุทูุงุนุงุช ุขฺฏู</span>
      </div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center gap-2">
        <span class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">3</span>
        <span class="hidden sm:inline">ุจุฑุฑุณ ู ุงูุชุดุงุฑ</span>
      </div>
    </div>
    <div class="mt-3 h-1 bg-gray-200 dark:bg-gray-700 rounded">
      <div id="progressBarStep" class="h-1 bg-emerald-600 rounded" style="width:66%"></div>
    </div>
  </div>

  <!-- ูุฑู ุซุจุช/ูุฑุงุด ุขฺฏู -->
  <form method="POST" enctype="multipart/form-data" class="space-y-6 p-4 sm:p-6" id="adForm" novalidate
        action="{{ form_action if form_action else request.path }}">

    {# CSRF (ุงฺฏุฑ Flask-WTF ูุนุงู ุงุณุช) #}
    {% if csrf_token %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% endif %}
    {# ุฏุฑ ุญุงูุช ูุฑุงุด ูโุชูุงูุฏ ad_id ุฑุง ูพุงุณ ุจุฏูุฏ #}
    {% if ad_id %}
      <input type="hidden" name="ad_id" value="{{ ad_id }}">
    {% endif %}

    <!-- ุดูุฑ ุขฺฏู -->
    <section aria-label="ุดูุฑ ุขฺฏู" class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">ุดูุฑ ุขฺฏู*</label>
      <div class="flex items-center gap-2">
        <div class="flex-1">
          <div id="cityDisplay" class="px-3 py-2 border rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-white focus-within:ring-2 focus-within:ring-green-500"
               aria-live="polite">ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ุดูุฑ...</div>
          <input type="hidden" name="city" id="cityInput">
          <p class="text-[11px] text-gray-500 mt-1">ููุท ุงูุชุฎุงุจ ูููุนุช (ุดูุฑ) ฺฉุงู ุงุณุชุ ูุงุฒ ุจู ูุงุฑุฏ ฺฉุฑุฏู ุขุฏุฑุณ ุฏูู ูุณุช. (ุฏุฑ ุญุงูุธูู ุฏุณุชฺฏุงู ุฐุฎุฑู ูโุดูุฏ)</p>
        </div>
        <a href="{{ url_for('main.city_select') }}"
           class="px-3 py-2 rounded-xl border border-green-500 text-green-700 hover:bg-green-50 dark:hover:bg-green-900 transition whitespace-nowrap"
           aria-label="ุงูุชุฎุงุจ ุดูุฑ">
          <i class="fas fa-map-marker-alt ml-1"></i> ุงูุชุฎุงุจ ุดูุฑ
        </a>
      </div>
    </section>

    <!-- ุชุตุงูุฑ -->
    <section aria-label="ุชุตุงูุฑ" class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">ุชุตุงูุฑ</label>
      <div class="flex items-center gap-2">
        <!-- Dropzone -->
        <label id="dropzone" title="ุชุตุงูุฑ ุฑุง ุงูุชุฎุงุจ ุง ุงูุฌุง ุฑูุง ฺฉูุฏ"
               class="flex-1 cursor-pointer flex items-center justify-center border-2 border-dashed border-green-500 rounded-2xl p-4 text-green-700 hover:bg-green-50 dark:hover:bg-green-900 transition">
          <i class="fas fa-upload text-base ml-2"></i>
          ุงูุฒูุฏู ุชุตูุฑ
          <input type="file" name="images" id="imagesInput" accept="image/*" multiple class="hidden" aria-label="ุงูุชุฎุงุจ ุชุตุงูุฑ">
        </label>

        <!-- ููุท ุชุตุงูุฑ ุฑุง ุญุฐู ูโฺฉูุฏ -->
        <button type="button" id="clearImages"
                class="px-3 py-2 text-xs border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700"
                aria-label="ุญุฐู ููู ุชุตุงูุฑ">ุญุฐู ููู</button>
      </div>
      <p class="text-[11px] text-gray-500">ุญุฏุงฺฉุซุฑ ฑฐ ุชุตูุฑุ ุชุบุฑ ุชุฑุชุจ ุจุง ฺฉุดุฏู ู ุฑูุง ฺฉุฑุฏูุ ุจุง โญ ุชุตูุฑ ฺฉุงูุฑ ุฑุง ูุดุฎุต ฺฉูุฏ.</p>
      <div id="upload-status" class="text-sm text-green-600 mt-1 hidden" role="status" aria-live="polite">ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ ู ุขูพููุฏ ุชุตุงูุฑ...</div>
      <div id="progress-container" class="w-full h-2 bg-gray-200 rounded overflow-hidden hidden" aria-hidden="true">
        <div id="progress-bar" class="h-full bg-green-500" style="width:0%"></div>
      </div>
      <div id="preview-container" class="grid grid-cols-3 gap-2 mt-2" aria-live="polite" aria-label="ูพุดโููุงุด ุชุตุงูุฑ"></div>
      <!-- ููุฏูุง ูพููุงู ุจุฑุง ุจฺฉโุงูุฏ -->
      <input type="hidden" name="images_order" id="images_order">
      <input type="hidden" name="cover_index" id="cover_index">
      <input type="hidden" name="uploaded_ids" id="uploaded_ids">
    </section>

    <!-- ุนููุงู -->
    <section aria-label="ุนููุงู" class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="title">ุนููุงู ุขฺฏู*</label>
      <input type="text" name="title" id="title" required maxlength="120"
             placeholder="ูุซูุงู: ตฐฐ ูุชุฑ ุจุงุบ ุจุง ุฏุฑุฎุชุงู ููู"
             class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500"
             autocomplete="off" inputmode="text">
      <p class="text-[11px] text-gray-500">ุนููุงู ูุงุถุญ ู ูุฎุชุตุฑ ุงุนุชูุงุฏ ุงุฌุงุฏ ูโฺฉูุฏ.</p>
    </section>

    

    <!-- ุงุจุนุงุฏ ู ููุช -->
    <section class="grid grid-cols-1 sm:grid-cols-2 gap-4" aria-label="ุงุจุนุงุฏ ู ููุช">
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="size">ูุชุฑุงฺ (ูุชุฑ ูุฑุจุน)*</label>
        <input inputmode="numeric" type="text" id="size" name="size" required autocomplete="off"
               class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-green-500">
      </div>
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="price_total">ููุช ฺฉู (ุชููุงู)</label>
        <input inputmode="numeric" type="text" id="price_total" name="price_total" autocomplete="off"
               class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-green-500">
        <div id="price_words" class="text-[11px] text-gray-500"></div>
      </div>
      <div class="sm:col-span-2 space-y-2">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="price_per_meter">ููุช ูุชุฑ (ูุญุงุณุจูโุดุฏู)</label>
        <input type="text" id="price_per_meter" name="price_per_meter" readonly
               class="w-full border rounded-lg px-3 py-2 bg-gray-100 dark:bg-gray-600 dark:text-white">
      </div>
    </section>

    <!-- ูุดุฎุตุงุช ูุฒฺฉ ููฺฉ -->
    <section aria-label="ูุดุฎุตุงุช ููฺฉ" class="space-y-2">
      <h2 class="text-sm font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2">
        <i class="fas fa-ruler-combined"></i> ูุดุฎุตุงุช ููฺฉ
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="frontage">ุนุฑุถ ุจุฑ (ูุชุฑ)</label>
          <input inputmode="numeric" type="text" id="frontage" name="frontage" placeholder="ูุซูุงู ฑฒ"
                 class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white">
        </div>
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="length">ุทูู (ูุชุฑ)</label>
          <input inputmode="numeric" type="text" id="length" name="length" placeholder="ูุซูุงู ดฐ"
                 class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white">
        </div>
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="street_width">ุนุฑุถ ฺฏุฐุฑ (ูุชุฑ)</label>
          <input inputmode="numeric" type="text" id="street_width" name="street_width" placeholder="ูุซูุงู ธ"
                 class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white">
        </div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm mt-2">
        <label class="inline-flex items-center gap-2"><input type="checkbox" name="has_fence" value="1"> ุฏูุงุฑฺฉุด ฺฉุงูู</label>
        <label class="inline-flex items-center gap-2"><input type="checkbox" name="has_corner" value="1"> ูุจุด</label>
        <label class="inline-flex items-center gap-2"><input type="checkbox" name="has_well" value="1"> ฺุงู</label>
        <label class="inline-flex items-center gap-2"><input type="checkbox" name="has_guardroom" value="1"> ุณุฑุงุฏุงุฑ/ุงุชุงูฺฉ</label>
      </div>
    </section>

    <!-- ๐ ูฺฏุงุดุช ุจู ูุงูโูุง ููุฑุฏ ุงูุชุธุงุฑ ุจฺฉโุงูุฏ -->
    <input type="hidden" name="area" id="area_hidden">
    <input type="hidden" name="price" id="price_hidden">
    <input type="hidden" name="location" id="location_hidden">

    <!-- ุฏุณุชูโุจูุฏ (ุงุฒ ฺฏุงู ฑ) -->
    <section aria-label="ุฏุณุชูโุจูุฏ" class="space-y-2">
      {% if ad_category %}
        <div class="flex items-center gap-2 text-sm">
          <span class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">{{ 'ูุฑูุด' if ad_category.trade_type=='sale' else 'ุงุฌุงุฑู' }}</span>
          <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">{{ ad_category.property_type|default('ููฺฉ') }}</span>
          <a href="{{ url_for('main.add_land_step1') }}" class="ms-auto text-xs text-emerald-700 hover:underline">ูุฑุงุด ุฏุณุชู</a>
        </div>
      {% else %}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="category_main">ููุน ูุนุงููู (ฺฏุฑูู)*</label>
            <select id="category_main" name="category_main" required class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white">
              <option value="" disabled selected>ุงูุชุฎุงุจ ฺฉูุฏ...</option>
              <option value="ูุฑูุด ูุณฺฉูู">ูุฑูุด ูุณฺฉูู</option>
              <option value="ุงุฌุงุฑู ูุณฺฉูู">ุงุฌุงุฑู ูุณฺฉูู</option>
              <option value="ุงุฌุงุฑู ุงุฏุงุฑ ู ุชุฌุงุฑ">ุงุฌุงุฑู ุงุฏุงุฑ ู ุชุฌุงุฑ</option>
              <option value="ูุฑูุด ุงุฏุงุฑ ู ุชุฌุงุฑ">ูุฑูุด ุงุฏุงุฑ ู ุชุฌุงุฑ</option>
              <option value="ุงุฌุงุฑู ฺฉูุชุงูโูุฏุช">ุงุฌุงุฑู ฺฉูุชุงูโูุฏุช</option>
              <option value="ูพุฑูฺูโูุง ุณุงุฎุชโูุณุงุฒ">ูพุฑูฺูโูุง ุณุงุฎุชโูุณุงุฒ</option>
            </select>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="category_sub">ุฏุณุชูโุจูุฏ (ุฒุฑุดุงุฎู)*</label>
            <select id="category_sub" name="category_sub" required disabled class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white">
              <option value="" disabled selected>ุงุจุชุฏุง ฺฏุฑูู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ...</option>
            </select>
          </div>
        </div>
      {% endif %}
    </section>

    <!-- ููุฏูุง ุฎุงุต ุจุฑ ุงุณุงุณ ุฏุณุชู (ูุงููุฏ ุฏูุงุฑ) -->
    <section id="categorySpecific" class="space-y-2 hidden" aria-label="ููุฏูุง ุงุฎุชุตุงุต ุฏุณุชู">
      <div id="rentFields" class="grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="deposit">ุฑูู (ุชููุงู)</label>
          <input inputmode="numeric" type="text" id="deposit" name="deposit" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white" autocomplete="off">
        </div>
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="rent">ุงุฌุงุฑู ูุงูุงูู (ุชููุงู)</label>
          <input inputmode="numeric" type="text" id="rent" name="rent" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white" autocomplete="off">
        </div>
        <div class="space-y-2 sm:col-span-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">ูุฏุนู ู ุงุฌุงุฑู ูุงุจู ุชุจุฏู</label>
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" name="convertible" value="1"> ูุงุจู ุชุจุฏู</label>
        </div>
      </div>

      <div id="apartmentFields" class="grid grid-cols-2 sm:grid-cols-4 gap-4 hidden">
        <div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="year_built">ุณุงู ุณุงุฎุช</label><input inputmode="numeric" type="text" id="year_built" name="year_built" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white"></div>
        <div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="floor">ุทุจูู</label><input inputmode="numeric" type="text" id="floor" name="floor" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white"></div>
        <div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="rooms">ุชุนุฏุงุฏ ุงุชุงู</label><input inputmode="numeric" type="text" id="rooms" name="rooms" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white"></div>
        <div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="elevator">ุขุณุงูุณูุฑ</label><select id="elevator" name="elevator" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white"><option value="">-</option><option value="1">ุฏุงุฑุฏ</option><option value="0">ูุฏุงุฑุฏ</option></select></div>
        <div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="parking">ูพุงุฑฺฉูฺฏ</label><select id="parking" name="parking" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white"><option value="">-</option><option value="1">ุฏุงุฑุฏ</option><option value="0">ูุฏุงุฑุฏ</option></select></div>
        <div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="warehouse">ุงูุจุงุฑ</label><select id="warehouse" name="warehouse" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white"><option value="">-</option><option value="1">ุฏุงุฑุฏ</option><option value="0">ูุฏุงุฑุฏ</option></select></div>
      </div>
    </section>

    <!-- ููุน ุณูุฏ -->
    <section aria-label="ููุน ุณูุฏ" class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="document_type">ููุน ุณูุฏ</label>
      <select name="document_type" id="document_type" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white">
        <option value="" disabled selected>ุงูุชุฎุงุจ ููุน ุณูุฏ</option>
        <option value="ุณูุฏ ูุงุฏุฑ">ุณูุฏ ูุงุฏุฑ</option>
        <option value="ููููุงูู">ููููุงูู</option>
        <option value="ุจูฺุงู">ุจูฺุงู</option>
        <option value="ฺฉุฏ ุฑูฺฏุฑโุฏุงุฑ">ฺฉุฏ ุฑูฺฏุฑโุฏุงุฑ</option>
      </select>
    </section>

    <!-- ุงูฺฉุงูุงุช -->
    <section aria-label="ุงูฺฉุงูุงุช" class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">ุงูฺฉุงูุงุช</label>
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="features" value="ุขุจ"> ุขุจ</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="features" value="ุจุฑู"> ุจุฑู</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="features" value="ฺฏุงุฒ"> ฺฏุงุฒ</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="features" value="ูุงุถูุงุจ"> ูุงุถูุงุจ</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="features" value="ุชููู"> ุชููู</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="features" value="ุงูุชุฑูุช"> ุงูุชุฑูุช</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="features" value="ุฏุฑุฎุช"> ุฏุฑุฎุช</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="features" value="ุฏูุงุฑฺฉุด"> ุฏูุงุฑฺฉุด</label>
      </div>
    </section>

    <!-- ุดุฑุงุท ูุนุงููู -->
    <section aria-label="ุดุฑุงุท ูุนุงููู" class="space-y-2">
      <h2 class="text-sm font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2">
        <i class="fas fa-handshake"></i> ุดุฑุงุท ูุนุงููู
      </h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="is_negotiable" value="1"> ููุช ุชูุงูู</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="accept_exchange" value="1"> ูุนุงูุถู</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="installment" value="1"> ุงูุณุงุท</label>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><input type="checkbox" name="urgent" value="1"> ููุฑ</label>
      </div>
    </section>

    <!-- ุชูุถุญุงุช -->
    <section aria-label="ุชูุถุญุงุช" class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" for="description">ุชูุถุญุงุช</label>
      <textarea name="description" id="description" rows="5" placeholder="ุฌุฒุฆุงุช ุชฺฉูู ูุซู ุฏุณุชุฑุณโูุงุ ุงูฺฉุงูุงุชุ ุจุงูุชุ ฺฉุงุฑุจุฑ ู ..."
                class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-green-500"></textarea>
    </section>

    <!-- ุชุงุฏ ููุงูู ู ูพุดโููุงุด -->
    <section class="space-y-3">
      <label class="inline-flex items-start gap-2 text-sm">
        <input type="checkbox" name="agree_terms" required>
        <span class="text-gray-700 dark:text-gray-200">ูุณุฆููุช ุตุญุช ุงุทูุงุนุงุช ุขฺฏู ุจุง ูู ุงุณุช ู ููุงูู ุงูุชุดุงุฑ ูููุฑ ุฑุง ูโูพุฐุฑู.</span>
      </label>

      <details class="group bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-xl p-3">
        <summary class="cursor-pointer text-sm font-bold flex items-center gap-2">
          <i class="fas fa-eye"></i> ูพุดโููุงุด ุณุฑุน
        </summary>
        <div class="mt-2 text-sm text-gray-700 dark:text-gray-200" id="quickPreview"></div>
      </details>
    </section>

    <!-- ุงฺฉุดูโูุง (ููุชุฑ ุซุงุจุช ููุจุงูโูุญูุฑ) -->
    <div class="h-20 sm:h-0"></div>
    <div class="fixed bottom-0 inset-x-0 sm:static bg-white/95 dark:bg-gray-900/95 backdrop-blur supports-[backdrop-filter]:bg-white/80 border-t dark:border-gray-700 p-3 sm:p-4 flex items-center gap-3 sm:justify-between shadow-[0_-6px_20px_rgba(0,0,0,0.06)]"
         role="toolbar" aria-label="ุงูุฏุงูุงุช ุซุจุช ุขฺฏู" style="padding-bottom:calc(env(safe-area-inset-bottom,0px)+12px)">
      <!-- ุฏฺฉูู ูพุงฺฉโฺฉุฑุฏู ูุฑู ุงุฒ ููุชุฑ ุญุฐู ุดุฏูุ ููุท ุฏุฑ ูุฏุฑ ุงุณุช -->
      <div class="ms-auto flex items-center gap-2 sm:gap-3 sm:justify-end">
        <a href="{{ url_for('main.index') }}" class="px-4 py-2 rounded-xl border hover:bg-gray-50 dark:hover:bg-gray-700 transition flex items-center gap-2">
          <i class="fas fa-arrow-right"></i> ุจุงุฒฺฏุดุช
        </a>
        <button type="submit" id="btnSubmit" disabled
                class="px-5 py-2.5 rounded-2xl bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-700 text-white font-medium shadow-md active:scale-[.99] transition flex items-center gap-2">
          <i class="fas fa-check-circle"></i>
          ุชฺฉูู ู ุงุฏุงูู
        </button>
      </div>
    </div>
  </form>

  {# ูุฑู ุญุฐู ุขฺฏู (ููุท ุญุงูุช ูุฑุงุด) #}
  {% if ad or ad_id %}
  <form method="POST" action="{{ url_for('main.ad_delete', ad_id=(ad.id if ad else ad_id)) }}" class="p-4 sm:p-6 border-t dark:border-gray-700" onsubmit="return confirmDeleteAd(event)">
    {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
    <input type="hidden" name="_method" value="DELETE">
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-600 dark:text-gray-300">ุญุฐู ุขฺฏูุ ุบุฑูุงุจูโุจุฑฺฏุดุช ุงุณุช.</div>
      <button type="submit" class="px-3 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white">ุญุฐู ุขฺฏู</button>
    </div>
  </form>
  {% endif %}
</div>

<!-- ูุงู ูููโุงุณฺฉุฑู ยซุฏุฑ ุญุงู ุซุจุชยป -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-[1px] flex flex-col items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 w-64 text-center">
    <i class="fas fa-spinner fa-spin text-3xl text-green-600 mb-3"></i>
    <p class="text-sm text-gray-700 dark:text-gray-200">ุฏุฑ ุญุงู ุซุจุช ุขฺฏู...</p>
    <p class="text-[11px] text-gray-500 mt-1">ูุทูุงู ุตูุญู ุฑุง ูุจูุฏุฏ</p>
  </div>
</div>

<style>
  .thumb{position:relative}
  .thumb .cover{position:absolute;top:.25rem;left:.25rem;background:#111827;color:#fff;font-size:10px;border-radius:999px;padding:.15rem .4rem;opacity:.9}
  .thumb.dragging{opacity:.6;transform:scale(.98)}
  .thumb .remove{position:absolute;top:.25rem;right:.25rem;background:#ef4444;color:#fff;border-radius:999px;font-size:11px;padding:.1rem .35rem}
  .thumb .star{position:absolute;bottom:.25rem;left:.25rem;background:#f59e0b;color:#111;border-radius:999px;font-size:12px;padding:.05rem .35rem}
  .thumb .spinner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.25);color:#fff;font-size:12px}
  #dropzone.dragover{background:rgba(16,185,129,.08)}
</style>

<script>
// ุจุฏูู ุชุบุฑ ุฑูุช ู ููุทู ุจฺฉโุงูุฏ
(() => {
  /* =========================[ ุชูุธูุงุช ูพุงู ]========================= */
  const CONFIG = Object.freeze({
    UPLOAD_URL: '/api/uploads/images',
    DELETE_UPLOAD_URL: '/api/uploads/delete',
    MAX_FILES: 10,
    MAX_FILE_SIZE_MB: 12,
    SAVE_KEY: 'adFormDraftV2'
  });

  /* =========================[ ุงุฑุฌุงุนุงุช DOM ]========================== */
  const form                = document.getElementById('adForm');
  const cityDisplay         = document.getElementById('cityDisplay');
  const cityInput           = document.getElementById('cityInput');
  const sizeInput           = document.getElementById('size');
  const totalPriceInput     = document.getElementById('price_total');
  const pricePerMeterInput  = document.getElementById('price_per_meter');
  const priceWords          = document.getElementById('price_words');
  const mainSelect          = document.getElementById('category_main');
  const subSelect           = document.getElementById('category_sub');
  const imagesInput         = document.getElementById('imagesInput');
  const previewContainer    = document.getElementById('preview-container');
  const uploadStatus        = document.getElementById('upload-status');
  const progressContainer   = document.getElementById('progress-container');
  const progressBar         = document.getElementById('progress-bar');
  const imagesOrderInput    = document.getElementById('images_order');
  const coverIndexInput     = document.getElementById('cover_index');
  const uploadedIdsInput    = document.getElementById('uploaded_ids');
  const clearImagesBtn      = document.getElementById('clearImages');
  const submitBtn           = document.getElementById('btnSubmit');
  const dropzone            = document.getElementById('dropzone');
  const overlay             = document.getElementById('loadingOverlay');
  const resetBtn            = document.getElementById('btnResetForm'); // โ ุฏฺฉูู ูุฏุฑ
  const progressBarStep     = document.getElementById('progressBarStep');

  /* =========================[ ุงุจุฒุงุฑูุง ฺฉูฺฉ ]========================= */
  const categoriesMap = {
    "ูุฑูุด ูุณฺฉูู": ["ุขูพุงุฑุชูุงู","ุฎุงูู ู ููุง","ุฒูู ู ููฺฉ ฺฉููฺฏ"],
    "ุงุฌุงุฑู ูุณฺฉูู": ["ุขูพุงุฑุชูุงู","ุฎุงูู ู ููุง"],
    "ุงุฌุงุฑู ุงุฏุงุฑ ู ุชุฌุงุฑ": ["ุฏูุชุฑ ฺฉุงุฑุ ุงุชุงู ุงุฏุงุฑุ ูุทุจ","ูุบุงุฒู ู ุบุฑูู","ุตูุนุชุ ฺฉุดุงูุฑุฒุ ุชุฌุงุฑ"],
    "ูุฑูุด ุงุฏุงุฑ ู ุชุฌุงุฑ": ["ุฏูุชุฑ ฺฉุงุฑุ ุงุชุงู ุงุฏุงุฑุ ูุทุจ","ูุบุงุฒู ู ุบุฑูู","ุตูุนุชุ ฺฉุดุงูุฑุฒุ ุชุฌุงุฑ"],
    "ุงุฌุงุฑู ฺฉูุชุงูโูุฏุช": ["ุขูพุงุฑุชูุงู ู ุณูุฆุช","ููุง ู ุจุงุบ","ุฏูุชุฑ ฺฉุงุฑ ู ูุถุง ุขููุฒุด"],
    "ูพุฑูฺูโูุง ุณุงุฎุชโูุณุงุฒ": ["ูุดุงุฑฺฉุช ุฏุฑ ุณุงุฎุช","ูพุดโูุฑูุด"]
  };

  const numfmt = new Intl.NumberFormat('fa-IR');
  const formatNumber = (n) => n ? numfmt.format(n) : '';
  function parseNumber(str) {
    if (!str) return 0;
    const persian = 'ฐฑฒณดตถทธน';
    const en = String(str).replace(/[ฐ-น]/g, d => String(persian.indexOf(d))).replace(/[^\d]/g, '');
    return Number(en || 0);
  }
  function numberToWordsFa(n){
    if(!n) return '';
    const units=[,'ูุฒุงุฑ','ูููู','ููุงุฑุฏ','ูุฒุงุฑ ููุงุฑุฏ'];
    let i=0; while(n>=1000 && i<units.length-1){ n=Math.round(n/1000); i++; }
    return formatNumber(n)+' '+units[i]+' ุชููุงู';
  }
  function getCsrf(){
    const meta = document.querySelector('meta[name="csrf-token"]');
    if(meta?.content) return meta.content;
    const hidden = document.querySelector('input[name="csrf_token"]');
    return hidden ? hidden.value : null;
  }
  const debounce = (fn, t=300) => { let id=null; return (...args)=>{ clearTimeout(id); id=setTimeout(()=>fn(...args), t); }; };

  /* =========================[ ุดูุฑ ุงุฒ localStorage ]==================== */
  const CITY_KEY = 'vinor_city';
  const getCity = () => { try { return localStorage.getItem(CITY_KEY) || ''; } catch { return ''; } };
  const setCityUI = () => {
    const c = getCity();
    cityInput.value = c || '';
    if (c) { cityDisplay.textContent = c; cityDisplay.classList.remove('border-red-300'); }
    else   { cityDisplay.textContent = 'ุดูุฑ ุงูุชุฎุงุจ ูุดุฏู ุงุณุช'; cityDisplay.classList.add('border-red-300'); }
  };
  window.addEventListener('storage', (e) => { if (e.key === CITY_KEY) setCityUI(); });
  document.addEventListener('vinor:city-changed', setCityUI);

  /* =========================[ ููุทู ููุช ]============================= */
  function recalc(){
    const s = parseNumber(sizeInput.value);
    const t = parseNumber(totalPriceInput.value);
    sizeInput.value        = s ? formatNumber(s) : '';
    totalPriceInput.value  = t ? formatNumber(t) : '';
    pricePerMeterInput.value = (s>0 && t>0) ? formatNumber(Math.floor(t/s)) : '';
    priceWords.textContent   = t ? ('โ ' + numberToWordsFa(t)) : '';
    // ูพุดโููุงุด ุณุฑุน
    try{
      const pv = document.getElementById('quickPreview');
      if(pv){
        const title = (document.getElementById('title')?.value || '').trim();
        const city  = getCity();
        const sizeV = s ? (formatNumber(s)+' ูุชุฑ') : '';
        const price = t ? numberToWordsFa(t) : 'ููุช ุชูุงูู';
        pv.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-14 h-14 rounded-lg bg-gray-200 dark:bg-gray-700 grid place-items-center text-green-600"><i class="fas fa-image"></i></div>
            <div class="flex-1">
              <div class="font-bold text-gray-900 dark:text-white">${title || 'ุนููุงู ุขฺฏู'}</div>
              <div class="text-xs text-gray-600 dark:text-gray-300">${city || 'ุดูุฑ'} โข ${sizeV}</div>
            </div>
            <div class="text-sm font-extrabold text-emerald-700 dark:text-emerald-400 whitespace-nowrap">${price}</div>
          </div>`;
      }
    }catch(_){}

    // ูุนุงูโุณุงุฒ ุฏฺฉูู ุงุฏุงูู ููุช ุญุฏุงูู ููุฏูุง ุถุฑูุฑ ูพุฑ ุงุณุช
    try{
      const ok = Boolean((document.getElementById('title')?.value||'').trim()) && s > 0;
      if (submitBtn) submitBtn.disabled = !ok;
    }catch(_){}
  }
  sizeInput.addEventListener('input', recalc);
  totalPriceInput.addEventListener('input', recalc);

  /* =====================[ ููุทู ุฏุณุชูโุจูุฏ/ุฒุฑุดุงุฎู ]==================== */
  function fillSub(main, setValue=null){
    subSelect.innerHTML = '';
    const def = document.createElement('option');
    def.value=''; def.disabled=true; def.selected=true; def.textContent='ุฒุฑุดุงุฎู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ...';
    subSelect.appendChild(def);
    (categoriesMap[main] || []).forEach(item=>{
      const opt=document.createElement('option'); opt.value=item; opt.textContent=item; subSelect.appendChild(opt);
    });
    subSelect.disabled = !(categoriesMap[main]||[]).length;
    if(setValue && !subSelect.disabled){
      subSelect.value = setValue;
      if(!subSelect.value) subSelect.selectedIndex = 0;
    }
  }
  mainSelect.addEventListener('change', e=>fillSub(e.target.value));

  /* =====================[ ููุงุด ููุฏูุง ุงุฎุชุตุงุต ]==================== */
  const catWrap      = document.getElementById('categorySpecific');
  const rentFields   = document.getElementById('rentFields');
  const aptFields    = document.getElementById('apartmentFields');
  function updateCategorySpecific(){
    const mainVal = (mainSelect?.value||'');
    const subVal  = (subSelect?.value||'');
    const isRent  = /ุงุฌุงุฑู/.test(mainVal);
    const isApt   = /ุขูพุงุฑุชูุงู/.test(subVal);
    if (!catWrap) return;
    if (!mainVal){ catWrap.classList.add('hidden'); return; }
    catWrap.classList.remove('hidden');
    rentFields?.classList.toggle('hidden', !isRent);
    aptFields?.classList.toggle('hidden', !isApt);
  }
  mainSelect?.addEventListener('change', updateCategorySpecific);
  subSelect?.addEventListener('change', updateCategorySpecific);

  // ุงฺฏุฑ ุงุฒ ฺฏุงู ฑ ุขูุฏูโุงู ู ุฏุณุชู ูุนููู ุงุณุชุ ููุฏูุง ุงุฎุชุตุงุต ุฑุง ูุนุงู ฺฉู
  try{
    const hasAdCat = {{ 'true' if ad_category else 'false' }};
    if (hasAdCat){
      // ุดุจูโุณุงุฒ ููุฏุงุฑุฏู: ุงุฌุงุฑู/ูุฑูุด ุงุฒ ุณุดู โ ููุงุด ุจูุงฺฉ ูุฑุชุจุท
      const tradeType = '{{ ad_category.trade_type if ad_category else '' }}';
      const property  = '{{ ad_category.property_type if ad_category else '' }}';
      if (tradeType === 'rent') { catWrap?.classList.remove('hidden'); rentFields?.classList.remove('hidden'); }
      if (property === 'apartment') { catWrap?.classList.remove('hidden'); aptFields?.classList.remove('hidden'); }
    }
  }catch(_){}

  /* =======================[ ููุทู ุชุตุงูุฑ/ุขูพููุฏ ]======================= */
  let imageItems = []; // {id,url,file,isCover,serverId,uploading}
  let totalUploads = 0, doneUploads = 0;

  const cryptoRandom = () => (self.crypto || window.crypto).getRandomValues(new Uint32Array(1))[0].toString(16);
  const fileToDataURL = (file) =>
    new Promise(res => { const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); });

  function compressImage(file, maxW=1600, quality=0.82){
    return new Promise((res,rej)=>{
      const img = new Image();
      img.onload = ()=>{
        const scale = Math.min(1, maxW/img.width);
        const c=document.createElement('canvas');
        c.width = Math.round(img.width*scale);
        c.height= Math.round(img.height*scale);
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        c.toBlob(b => b ? res(new File([b],'img.jpg',{type:'image/jpeg'})) : rej(new Error('Compression failed')), 'image/jpeg', quality);
      };
      img.onerror = () => rej(new Error('Invalid image'));
      img.src = URL.createObjectURL(file);
    });
  }

  function renderThumbs(){
    previewContainer.innerHTML='';
    imageItems.forEach((it,idx)=>{
      const d=document.createElement('div'); d.className='thumb border rounded-xl overflow-hidden'; d.draggable=true; d.dataset.id=it.id; d.setAttribute('aria-label','ุชุตูุฑ '+(idx+1));
      const img=document.createElement('img'); img.src=it.url; img.className='w-full h-28 object-cover'; img.loading='lazy'; img.alt='ุชุตูุฑ ุขฺฏู';
      const rm=document.createElement('button'); rm.type='button'; rm.className='remove'; rm.title='ุญุฐู ุชุตูุฑ'; rm.innerHTML='<i class="fas fa-times"></i>';
      rm.addEventListener('click', ()=>{
        imageItems=imageItems.filter(x=>x.id!==it.id);
        if(it.isCover && imageItems[0]) imageItems[0].isCover=true;
        renderThumbs(); syncImageHiddenInputs();
      });
      const star=document.createElement('button'); star.type='button'; star.className='star'; star.title='ุงูุชุฎุงุจ ุจูโุนููุงู ฺฉุงูุฑ'; star.innerHTML = it.isCover ? 'โญ' : 'โ';
      star.addEventListener('click', ()=>{
        imageItems.forEach(x=>x.isCover=false); it.isCover=true;
        renderThumbs(); syncImageHiddenInputs();
      });
      d.addEventListener('dragstart', ev=>{ d.classList.add('dragging'); ev.dataTransfer.setData('text/plain', it.id); });
      d.addEventListener('dragend',   ()=> d.classList.remove('dragging'));
      d.addEventListener('dragover',  ev=>ev.preventDefault());
      d.addEventListener('drop', ev=>{
        ev.preventDefault();
        const fromId = ev.dataTransfer.getData('text/plain');
        if(fromId === it.id) return;
        const fromIdx=imageItems.findIndex(x=>x.id===fromId);
        const toIdx  =imageItems.findIndex(x=>x.id===it.id);
        const [moved]=imageItems.splice(fromIdx,1);
        imageItems.splice(toIdx,0,moved);
        renderThumbs(); syncImageHiddenInputs();
      });
      d.append(img, rm, star);
      if (it.uploading) { const sp=document.createElement('div'); sp.className='spinner'; sp.textContent='ุฏุฑ ุญุงู ุขูพููุฏ...'; d.appendChild(sp); }
      if(it.isCover){ const lab=document.createElement('span'); lab.className='cover'; lab.textContent='ฺฉุงูุฑ'; d.appendChild(lab); }
      previewContainer.appendChild(d);
    });
    syncImageHiddenInputs();
  }

  function syncImageHiddenInputs(){
    imagesOrderInput.value = imageItems.map(x=>x.id).join(',');
    coverIndexInput.value  = imageItems.findIndex(x=>x.isCover);
    uploadedIdsInput.value = imageItems.map(x=>x.serverId||'').join(',');
  }

  function validateFile(f){
    if(!f.type.startsWith('image/')){ toast('ููุท ูุงู ุชุตูุฑ ูุฌุงุฒ ุงุณุช'); return false; }
    if(f.size > CONFIG.MAX_FILE_SIZE_MB*1024*1024){ toast('ุญุฌู ูุฑ ุชุตูุฑ ุญุฏุงฺฉุซุฑ '+CONFIG.MAX_FILE_SIZE_MB+' ูฺฏุงุจุงุช'); return false; }
    return true;
  }

  // ููุท ุชุตุงูุฑ ุฑุง ูพุงฺฉ ูโฺฉูุฏ (ุจุฏูู ุฑุณุช ฺฉู ูุฑู)
  clearImagesBtn.addEventListener('click', ()=>{
    if(!imageItems.length){ toast('ุชุตูุฑ ุจุฑุง ุญุฐู ูุฌูุฏ ูุฏุงุฑุฏ'); return; }
    if(!confirm('ููู ุชุตุงูุฑ ุญุฐู ุดููุฏุ')) return;
    const uploadedIds = imageItems.map(x=>x.serverId).filter(Boolean);
    imageItems = []; renderThumbs();
    imagesInput.value=''; uploadedIdsInput.value='';
    updateGlobalProgress();
    if(uploadedIds.length){
      // ุงุฎุชุงุฑ: ุงุนูุงู ุญุฐู ุจู ุณุฑูุฑ ุงฺฏุฑ API ุฏุงุฑุฏ
      fetch(CONFIG.DELETE_UPLOAD_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ ids: uploadedIds })
      }).catch(()=>{});
    }
    toast('ููู ุชุตุงูุฑ ุญุฐู ุดุฏูุฏ');
  });

  async function handleFiles(files){
    const arr = Array.from(files||[]);
    if(!arr.length) return;

    if(arr.length + imageItems.length > CONFIG.MAX_FILES){
      toast('ุญุฏุงฺฉุซุฑ '+CONFIG.MAX_FILES+' ุชุตูุฑ ูุฌุงุฒ ุงุณุช'); return;
    }

    uploadStatus.classList.remove('hidden');
    progressContainer.classList.remove('hidden');

    totalUploads += arr.length;
    updateGlobalProgress();

    const tasks = arr.map(async (f) => {
      if(!validateFile(f)){ doneUploads++; updateGlobalProgress(); return; }
      try{
        const compressed = await compressImage(f, 1600, 0.82);
        const url = await fileToDataURL(compressed);
        const item = { id: cryptoRandom(), url, file: compressed, isCover:false, serverId:null, uploading:true };
        imageItems.push(item);
        if (!imageItems.some(x=>x.isCover)) item.isCover = true;
        renderThumbs();

        try{
          const serverId = await uploadOne(compressed);
          item.serverId = serverId;
        }catch(err){
          console.error('Upload failed:', err);
          toast('ุขูพููุฏ ฺฉ ุชุตูุฑ ูุงูููู ุจูุฏ');
        }finally{
          item.uploading = false;
          doneUploads++;
          renderThumbs();
          updateGlobalProgress();
        }
      }catch(err){
        console.error(err);
        doneUploads++;
        updateGlobalProgress();
        toast('ูพุฑุฏุงุฒุด ฺฉ ุชุตูุฑ ูุงูููู ุจูุฏ');
      }
    });

    await Promise.all(tasks);
    uploadStatus.textContent = imageItems.every(x=>x.serverId) ? 'ููู ุชุตุงูุฑ ุขูพููุฏ ุดุฏูุฏ' : 'ุจุฑุฎ ุชุตุงูุฑ ุขูพููุฏ ูุดุฏูุฏ';
  }

  imagesInput.addEventListener('change', (e)=>handleFiles(e.target.files));
  ['dragenter','dragover'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{ e.preventDefault(); dropzone.classList.add('dragover'); });
  });
  ['dragleave','drop'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{ e.preventDefault(); dropzone.classList.remove('dragover'); });
  });
  dropzone.addEventListener('drop', e=>{
    e.preventDefault();
    const dt = e.dataTransfer;
    if(dt?.files) handleFiles(dt.files);
  });

  async function uploadOne(file){
    const fd = new FormData();
    fd.append('file', file, 'image.jpg');
    const csrf = getCsrf();
    const headers = {};
    if(csrf){
      headers['X-CSRF-Token'] = csrf;
      headers['X-CSRFToken']  = csrf;
      headers['X-XSRF-TOKEN'] = csrf;
    }
    const resp = await fetch(CONFIG.UPLOAD_URL, { method:'POST', headers, body:fd, credentials:'same-origin' });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const data = await resp.json().catch(()=> ({}));
    return data.id || data.file_id || data.uuid || data.key || null;
  }

  function updateGlobalProgress(){
    const total = Math.max(totalUploads, 1);
    const percent = Math.round((doneUploads/total)*100);
    progressBar.style.width = percent+'%';
    if (doneUploads >= total){
      setTimeout(()=>{ progressContainer.classList.add('hidden'); uploadStatus.classList.add('hidden'); }, 600);
    } else {
      progressContainer.classList.remove('hidden');
      uploadStatus.classList.remove('hidden');
    }
  }

  /* =====================[ ูพุดโููุณ LocalStorage ]===================== */
  const saveDraft = () => {
    const fd = new FormData(form);
    const obj = {};
    fd.forEach((v,k)=>{ if(k !== 'images') obj[k]=v; });
    obj._images_meta = imageItems.map(x=>({id:x.id,url:x.url,isCover:x.isCover,serverId:x.serverId}));
    obj.city = getCity();
    try { localStorage.setItem(CONFIG.SAVE_KEY, JSON.stringify(obj)); } catch(_){}
  };

  const loadDraft = () => {
    const raw = localStorage.getItem(CONFIG.SAVE_KEY);
    if(raw){
      try{
        const obj = JSON.parse(raw);
        Object.entries(obj).forEach(([k,v])=>{
          if(k==='_images_meta') return;
          const el = form.elements[k]; if(el) el.value = v;
        });
        if(obj.category_main){ fillSub(obj.category_main, obj.category_sub || null); }
        if(obj._images_meta){
          imageItems = obj._images_meta.map(m=>({id:m.id,url:m.url,file:null,isCover:m.isCover,serverId:m.serverId||null,uploading:false}));
          renderThumbs();
        }
      }catch(_){}
    }
    setCityUI();
    recalc();
  };

  form.addEventListener('input', debounce(saveDraft, 800));

  /* =========================[ Toast ฺฉูฺฺฉ ]============================ */
  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    t.className='fixed bottom-20 right-3 bg-gray-900 text-white text-xs px-3 py-2 rounded-xl shadow z-[9999]';
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); },1800);
  }

  /* =========================[ ูพุงฺฉโฺฉุฑุฏู ูุฑู (ูุฏุฑ) ]==================== */
  async function deleteUploadedOnServer(ids){
    if(!ids || !ids.length || !CONFIG.DELETE_UPLOAD_URL) return;
    const csrf = getCsrf();
    try{
      await fetch(CONFIG.DELETE_UPLOAD_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', ...(csrf ? {'X-CSRF-Token': csrf} : {}) },
        body: JSON.stringify({ ids })
      });
    }catch(_){}
  }

  function hardResetFormUI(){
    form.reset();
    imageItems = []; totalUploads = 0; doneUploads = 0;
    renderThumbs(); updateGlobalProgress();
    try { localStorage.removeItem(CONFIG.SAVE_KEY); } catch(_){}
    setCityUI();
    pricePerMeterInput.value = '';
    priceWords.textContent = '';
    imagesInput.value = '';
  }

  resetBtn.addEventListener('click', async ()=>{
    const hasData = imageItems.length || (localStorage.getItem(CONFIG.SAVE_KEY) != null);
    const confirmMsg = hasData
      ? 'ฺฉู ูุฑู ู ูพุดโููุณ ู ุชุตุงูุฑ ูพุงฺฉ ุดููุฏุ ุงู ุนููุงุช ูุงุจู ุจุงุฒฺฏุดุช ูุณุช.'
      : 'ูุฑู ูพุงฺฉ ุดูุฏุ';
    if(!confirm(confirmMsg)) return;

    const uploadedIds = imageItems.map(x=>x.serverId).filter(Boolean);
    if(uploadedIds.length){ await deleteUploadedOnServer(uploadedIds); }

    hardResetFormUI();
    toast('ูุฑู ูพุงฺฉ ุดุฏ');
  });

  /* =========================[ ุงุฑุณุงู ูุฑู ]============================== */
  form.addEventListener('submit', (e)=>{
    // ุดูุฑ
    const city = getCity();
    if (!city) {
      cityDisplay.classList.add('border-red-300');
      toast('ุจูุชุฑ ุงุณุช ูุจู ุงุฒ ุงุฑุณุงูุ ุดูุฑ ุขฺฏู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.');
    }
    cityInput.value = city || '';

    // ุงุนุฏุงุฏ ุจู ุดฺฉู ุฎุงู
    const sizeRaw  = parseNumber(sizeInput.value);
    const totalRaw = parseNumber(totalPriceInput.value);
    sizeInput.value          = sizeRaw;
    totalPriceInput.value    = totalRaw;
    pricePerMeterInput.value = parseNumber(pricePerMeterInput.value);

    // ูฺฏุงุดุช ุจฺฉโุงูุฏ
    document.getElementById('area_hidden').value     = sizeRaw || '';
    document.getElementById('price_hidden').value    = totalRaw || '';
    document.getElementById('location_hidden').value = (city || '');

    // ุชุตุงูุฑ
    if(imageItems.length && imageItems.every(x=>!x.isCover)){ imageItems[0].isCover = true; }
    imagesOrderInput.value = imageItems.map(x=>x.id).join(',');
    coverIndexInput.value  = imageItems.findIndex(x=>x.isCover);
    uploadedIdsInput.value = imageItems.map(x=>x.serverId||'').join(',');

    // UI ุงุฑุณุงู
    overlay.classList.remove('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'ุฏุฑ ุญุงู ุงุฑุณุงู...';
  });

  /* =======================[ ุดุฑูุน: ุจุงุฑฺฏุฐุงุฑ ูพุดโููุณ ]================== */
  window.addEventListener('load', loadDraft);
  // ุชูุธู ุงุณุชูพโุจุงุฑ
  try{ if(progressBarStep) progressBarStep.style.width = '66%'; }catch(_){ }

  /* =======================[ ุญุฐู ุขฺฏู (ูุฑู ุฌุฏุง) ]====================== */
  window.confirmDeleteAd = function (ev){
    const ok = confirm('ุขฺฏู ุจูโุทูุฑ ฺฉุงูู ุญุฐู ุดูุฏุ ุงู ุนููุงุช ูุงุจู ุจุงุฒฺฏุดุช ูุณุช.');
    if(!ok){ ev.preventDefault(); return false; }
    return true;
  };
})();
</script>
{% endblock %}
