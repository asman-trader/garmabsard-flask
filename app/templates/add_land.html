{% extends "base.html" %}
{% set hide_header = True %}
{% block title %}Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø¬Ø¯ÛŒØ¯ | ÙˆÛŒÙ†ÙˆØ±{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-0 sm:p-8 shadow rounded-lg mt-0 sm:mt-6">

  <!-- ÙØ±Ù… Ø«Ø¨Øª/ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢Ú¯Ù‡ÛŒ -->
  <form method="POST" enctype="multipart/form-data" class="space-y-5 p-4 sm:p-0 sm:pt-6" id="adForm" novalidate
        action="{{ form_action if form_action else request.path }}">
    {# CSRF (Ø§Ú¯Ø± Flask-WTF ÙØ¹Ø§Ù„ Ø§Ø³Øª) #}
    {% if csrf_token %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% endif %}
    {# Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ad_id Ø±Ø§ Ù¾Ø§Ø³ Ø¨Ø¯Ù‡ÛŒØ¯ #}
    {% if ad_id %}
      <input type="hidden" name="ad_id" value="{{ ad_id }}">
    {% endif %}

    <!-- Ø´Ù‡Ø± Ø¢Ú¯Ù‡ÛŒ -->
    <section aria-label="Ø´Ù‡Ø± Ø¢Ú¯Ù‡ÛŒ">
      <label class="block text-gray-700 dark:text-gray-200 mb-1">Ø´Ù‡Ø± Ø¢Ú¯Ù‡ÛŒ*</label>
      <div class="flex items-center gap-2">
        <div class="flex-1">
          <div id="cityDisplay"
               class="px-3 py-2 border rounded text-sm dark:bg-gray-700 dark:text-white"
               aria-live="polite">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ù‡Ø±...</div>
          <input type="hidden" name="city" id="cityInput">
          <p class="text-[11px] text-gray-500 mt-1">
            Ø´Ù‡Ø± Ø±Ø§ Ø§Ø² ØµÙØ­Ù‡Ù” Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø± ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯. (Ø¯Ø± Ø­Ø§ÙØ¸Ù‡Ù” Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
          </p>
        </div>
        <a href="{{ url_for('main.city_select') }}"
           class="px-3 py-2 rounded-lg border border-green-500 text-green-700 hover:bg-green-50 dark:hover:bg-green-900 transition whitespace-nowrap"
           aria-label="Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±">
          <i class="fas fa-map-marker-alt ml-1"></i> Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±
        </a>
      </div>
    </section>

    <!-- ØªØµØ§ÙˆÛŒØ± -->
    <section aria-label="ØªØµØ§ÙˆÛŒØ±">
      <label class="block text-gray-700 dark:text-gray-200 mb-1">ØªØµØ§ÙˆÛŒØ±</label>

      <div class="flex items-center gap-2">
        <!-- Dropzone -->
        <label id="dropzone"
               class="flex-1 cursor-pointer flex items-center justify-center border-dashed border-2 border-green-500 rounded p-3 text-green-700 hover:bg-green-50 dark:hover:bg-green-900 transition"
               title="ØªØµØ§ÙˆÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯">
          <i class="fas fa-upload text-lg ml-2"></i>
          Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ±
          <input type="file" name="images" id="imagesInput" accept="image/*" multiple class="hidden" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§ÙˆÛŒØ±">
        </label>

        <button type="button" id="clearImages"
                class="px-3 py-2 text-xs border rounded hover:bg-gray-50 dark:hover:bg-gray-700"
                aria-label="Ø­Ø°Ù Ù‡Ù…Ù‡ ØªØµØ§ÙˆÛŒØ±">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
      </div>

      <p class="text-[11px] text-gray-500 mt-1">
        Ø­Ø¯Ø§Ú©Ø«Ø± Û±Û° ØªØµÙˆÛŒØ±Ø› ØªØºÛŒÛŒØ± ØªØ±ØªÛŒØ¨ Ø¨Ø§ Ú©Ø´ÛŒØ¯Ù† Ùˆ Ø±Ù‡Ø§ Ú©Ø±Ø¯Ù†Ø› Ø¨Ø§ â­ ØªØµÙˆÛŒØ± Ú©Ø§ÙˆØ± Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.
      </p>

      <div id="upload-status" class="text-sm text-green-600 mt-2 hidden" role="status" aria-live="polite">
        Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¢Ù¾Ù„ÙˆØ¯ ØªØµØ§ÙˆÛŒØ±...
      </div>

      <div id="progress-container" class="w-full h-2 bg-gray-200 rounded overflow-hidden hidden mt-2" aria-hidden="true">
        <div id="progress-bar" class="h-full bg-green-500" style="width:0%"></div>
      </div>

      <div id="preview-container" class="grid grid-cols-3 gap-2 mt-3" aria-live="polite" aria-label="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµØ§ÙˆÛŒØ±"></div>

      <!-- ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù¾Ù†Ù‡Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ú©â€ŒØ§Ù†Ø¯ -->
      <input type="hidden" name="images_order" id="images_order">
      <input type="hidden" name="cover_index" id="cover_index">
      <input type="hidden" name="uploaded_ids" id="uploaded_ids">
    </section>

    <!-- Ø¹Ù†ÙˆØ§Ù† -->
    <section aria-label="Ø¹Ù†ÙˆØ§Ù†">
      <label class="block text-gray-700 dark:text-gray-200 mb-1" for="title">Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ*</label>
      <input type="text" name="title" id="title" required maxlength="120"
             placeholder="Ù…Ø«Ù„Ø§Ù‹: ÛµÛ°Û° Ù…ØªØ± Ø¨Ø§Øº Ø¨Ø§ Ø¯Ø±Ø®ØªØ§Ù† Ù…ÛŒÙˆÙ‡"
             class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white"
             autocomplete="off" inputmode="text">
      <div class="text-[11px] text-gray-500 mt-1">Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø¶Ø­ Ùˆ Ù…Ø®ØªØµØ± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</div>
    </section>

    <!-- Ø§Ø¨Ø¹Ø§Ø¯ Ùˆ Ù‚ÛŒÙ…Øª -->
    <section class="grid grid-cols-1 sm:grid-cols-2 gap-4" aria-label="Ø§Ø¨Ø¹Ø§Ø¯ Ùˆ Ù‚ÛŒÙ…Øª">
      <div>
        <label class="block text-gray-700 dark:text-gray-200 mb-1" for="size">Ù…ØªØ±Ø§Ú˜ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)*</label>
        <input inputmode="numeric" type="text" id="size" name="size" required
               class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" autocomplete="off">
      </div>
      <div>
        <label class="block text-gray-700 dark:text-gray-200 mb-1" for="price_total">Ù‚ÛŒÙ…Øª Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)</label>
        <input inputmode="numeric" type="text" id="price_total" name="price_total"
               class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" autocomplete="off">
        <div id="price_words" class="text-[11px] text-gray-500 mt-1"></div>
      </div>
      <div class="sm:col-span-2">
        <label class="block text-gray-700 dark:text-gray-200 mb-1" for="price_per_meter">Ù‚ÛŒÙ…Øª Ù…ØªØ±ÛŒ (Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒØ´Ø¯Ù‡)</label>
        <input type="text" id="price_per_meter" name="price_per_meter" readonly
               class="w-full border rounded px-3 py-2 bg-gray-100 dark:bg-gray-600 dark:text-white">
      </div>
    </section>

    <!-- ğŸ” Ù†Ú¯Ø§Ø´Øª Ø¨Ù‡ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ú©â€ŒØ§Ù†Ø¯ -->
    <input type="hidden" name="area" id="area_hidden">
    <input type="hidden" name="price" id="price_hidden">
    <input type="hidden" name="location" id="location_hidden">

    <!-- Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬Ø²Ø¦ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) -->
    <section aria-label="Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬Ø²Ø¦ÛŒ">
      <label class="block text-gray-700 dark:text-gray-200 mb-1" for="location_detail">Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬Ø²Ø¦ÛŒ / ØªÙˆØ¶ÛŒØ­ Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
      <input type="text" name="location_detail" id="location_detail"
             placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¯Ø´Øª Ø§ÙˆÙ„ØŒ Ù†Ø²Ø¯ÛŒÚ© Ø¬Ø§Ø¯Ù‡ Ø§ØµÙ„ÛŒ"
             class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" autocomplete="off">
      <div class="text-[11px] text-gray-500 mt-1">Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª. Ø´Ù‡Ø± Ø§ØµÙ„ÛŒ Ø§Ø² Ø¨Ø®Ø´ Ø¨Ø§Ù„Ø§ ØªØ¹ÛŒÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    </section>

    <!-- Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ -->
    <section aria-label="Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700 dark:text-gray-200 mb-1" for="category_main">Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡ (Ú¯Ø±ÙˆÙ‡)*</label>
          <select id="category_main" name="category_main" required
                  class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white">
            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
            <option value="ÙØ±ÙˆØ´ Ù…Ø³Ú©ÙˆÙ†ÛŒ">ÙØ±ÙˆØ´ Ù…Ø³Ú©ÙˆÙ†ÛŒ</option>
            <option value="Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø³Ú©ÙˆÙ†ÛŒ">Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø³Ú©ÙˆÙ†ÛŒ</option>
            <option value="Ø§Ø¬Ø§Ø±Ù‡ Ø§Ø¯Ø§Ø±ÛŒ Ùˆ ØªØ¬Ø§Ø±ÛŒ">Ø§Ø¬Ø§Ø±Ù‡ Ø§Ø¯Ø§Ø±ÛŒ Ùˆ ØªØ¬Ø§Ø±ÛŒ</option>
            <option value="ÙØ±ÙˆØ´ Ø§Ø¯Ø§Ø±ÛŒ Ùˆ ØªØ¬Ø§Ø±ÛŒ">ÙØ±ÙˆØ´ Ø§Ø¯Ø§Ø±ÛŒ Ùˆ ØªØ¬Ø§Ø±ÛŒ</option>
            <option value="Ø§Ø¬Ø§Ø±Ù‡ Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª">Ø§Ø¬Ø§Ø±Ù‡ Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª</option>
            <option value="Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø®Øªâ€ŒÙˆØ³Ø§Ø²">Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø®Øªâ€ŒÙˆØ³Ø§Ø²</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 dark:text-gray-200 mb-1" for="category_sub">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ (Ø²ÛŒØ±Ø´Ø§Ø®Ù‡)*</label>
          <select id="category_sub" name="category_sub" required disabled
                  class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white">
            <option value="" disabled selected>Ø§Ø¨ØªØ¯Ø§ Ú¯Ø±ÙˆÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Ù†ÙˆØ¹ Ø³Ù†Ø¯ -->
    <section aria-label="Ù†ÙˆØ¹ Ø³Ù†Ø¯">
      <label class="block text-gray-700 dark:text-gray-200 mb-1" for="document_type">Ù†ÙˆØ¹ Ø³Ù†Ø¯</label>
      <select name="document_type" id="document_type"
              class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white">
        <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø³Ù†Ø¯</option>
        <option value="Ø³Ù†Ø¯ Ù…Ø§Ø¯Ø±">Ø³Ù†Ø¯ Ù…Ø§Ø¯Ø±</option>
        <option value="Ù‚ÙˆÙ„Ù†Ø§Ù…Ù‡">Ù‚ÙˆÙ„Ù†Ø§Ù…Ù‡</option>
        <option value="Ø¨Ù†Ú†Ø§Ù‚">Ø¨Ù†Ú†Ø§Ù‚</option>
        <option value="Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒâ€ŒØ¯Ø§Ø±">Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒâ€ŒØ¯Ø§Ø±</option>
      </select>
    </section>

    <!-- Ø§Ù…Ú©Ø§Ù†Ø§Øª -->
    <section aria-label="Ø§Ù…Ú©Ø§Ù†Ø§Øª">
      <label class="block text-gray-700 dark:text-gray-200 mb-1">Ø§Ù…Ú©Ø§Ù†Ø§Øª</label>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <label class="inline-flex items-center gap-2"><input type="checkbox" name="features" value="Ø¢Ø¨"> Ø¢Ø¨</label>
        <label class="inline-flex items-center gap-2"><input type="checkbox" name="features" value="Ø¨Ø±Ù‚"> Ø¨Ø±Ù‚</label>
        <label class="inline-flex items-center gap-2"><input type="checkbox" name="features" value="Ø¯Ø±Ø®Øª"> Ø¯Ø±Ø®Øª</label>
        <label class="inline-flex items-center gap-2"><input type="checkbox" name="features" value="Ø¯ÛŒÙˆØ§Ø±Ú©Ø´ÛŒ"> Ø¯ÛŒÙˆØ§Ø±Ú©Ø´ÛŒ</label>
      </div>
    </section>

    <!-- ØªÙˆØ¶ÛŒØ­Ø§Øª -->
    <section aria-label="ØªÙˆØ¶ÛŒØ­Ø§Øª">
      <label class="block text-gray-700 dark:text-gray-200 mb-1" for="description">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
      <textarea name="description" id="description" rows="4"
                placeholder="Ø¬Ø²Ø¦ÛŒØ§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…Ø«Ù„ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ØŒ Ø§Ù…Ú©Ø§Ù†Ø§ØªØŒ Ø¨Ø§ÙØªØŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ ..."
                class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white"></textarea>
    </section>

    <!-- Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§ (ÙÙˆØªØ± Ø«Ø§Ø¨Øª Ù…ÙˆØ¨Ø§ÛŒÙ„â€ŒÙ…Ø­ÙˆØ±) -->
    <div class="h-16 sm:h-0"></div>
    <div class="fixed bottom-0 inset-x-0 sm:static bg-white dark:bg-gray-900 border-t dark:border-gray-700 p-3 flex items-center gap-3 sm:justify-between">

      <!-- Ú¯Ø±ÙˆÙ‡ Ú†Ù¾: Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† ÙØ±Ù… (Ú©Ù„Ø§ÛŒÙ†ØªÛŒ) -->
      <button type="button" id="btnResetForm"
              class="px-3 py-2 rounded border text-red-600 border-red-300 hover:bg-red-50 dark:hover:bg-red-900/20">
        Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† ÙØ±Ù…
      </button>

      <div class="flex items-center gap-3 sm:justify-end">
        <a href="{{ url_for('main.index') }}" class="px-4 py-2 rounded border">Ø¨Ø§Ø²Ú¯Ø´Øª</a>
        <button type="submit" id="btnSubmit"
                class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white transition">
          ØªÚ©Ù…ÛŒÙ„ Ùˆ Ø§Ø¯Ø§Ù…Ù‡
        </button>
      </div>
    </div>
  </form>

  {# ÙØ±Ù… Ø­Ø°Ù Ø¢Ú¯Ù‡ÛŒ (ÙÙ‚Ø· Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´) #}
  {% if ad or ad_id %}
  <form method="POST"
        action="{{ url_for('main.ad_delete', ad_id=(ad.id if ad else ad_id)) }}"
        class="p-4 sm:pt-4 border-t dark:border-gray-700"
        onsubmit="return confirmDeleteAd(event)">
    {% if csrf_token %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% endif %}
    <input type="hidden" name="_method" value="DELETE">
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-600 dark:text-gray-300">
        Ø­Ø°Ù Ø¢Ú¯Ù‡ÛŒØŒ ØºÛŒØ±Ù‚Ø§Ø¨Ù„â€ŒØ¨Ø±Ú¯Ø´Øª Ø§Ø³Øª.
      </div>
      <button type="submit"
              class="px-3 py-2 rounded bg-red-600 hover:bg-red-700 text-white">
        Ø­Ø°Ù Ø¢Ú¯Ù‡ÛŒ
      </button>
    </div>
  </form>
  {% endif %}
</div>

<!-- Ù„Ø§ÛŒÙ‡ ÙÙˆÙ„â€ŒØ§Ø³Ú©Ø±ÛŒÙ† Â«Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨ØªÂ» -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-[1px] flex flex-col items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 w-64 text-center">
    <i class="fas fa-spinner fa-spin text-3xl text-green-600 mb-3"></i>
    <p class="text-sm text-gray-700 dark:text-gray-200">Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ...</p>
    <p class="text-[11px] text-gray-500 mt-1">Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ù†Ø¨Ù†Ø¯ÛŒØ¯</p>
  </div>
</div>

<style>
  .thumb{position:relative}
  .thumb .cover{position:absolute;top:.25rem;left:.25rem;background:#111827;color:#fff;font-size:10px;border-radius:999px;padding:.15rem .4rem;opacity:.9}
  .thumb.dragging{opacity:.6;transform:scale(.98)}
  .thumb .remove{position:absolute;top:.25rem;right:.25rem;background:#ef4444;color:#fff;border-radius:999px;font-size:11px;padding:.1rem .35rem}
  .thumb .star{position:absolute;bottom:.25rem;left:.25rem;background:#f59e0b;color:#111;border-radius:999px;font-size:12px;padding:.05rem .35rem}
  .thumb .spinner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.25);color:#fff;font-size:12px}
  #dropzone.dragover{background:rgba(16,185,129,.08)}
</style>

<script>
(() => {
  /* =========================[ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡ ]========================= */
  const CONFIG = Object.freeze({
    UPLOAD_URL: '/api/uploads/images',
    DELETE_UPLOAD_URL: '/api/uploads/delete',   // â† Ø¯Ø±ØµÙˆØ±Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø³Ø±ÙˆØ±
    MAX_FILES: 10,
    MAX_FILE_SIZE_MB: 12,
    SAVE_KEY: 'adFormDraftV2'
  });

  /* =========================[ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª DOM ]========================== */
  const form                = document.getElementById('adForm');
  const cityDisplay         = document.getElementById('cityDisplay');
  const cityInput           = document.getElementById('cityInput');
  const sizeInput           = document.getElementById('size');
  const totalPriceInput     = document.getElementById('price_total');
  const pricePerMeterInput  = document.getElementById('price_per_meter');
  const priceWords          = document.getElementById('price_words');
  const mainSelect          = document.getElementById('category_main');
  const subSelect           = document.getElementById('category_sub');
  const imagesInput         = document.getElementById('imagesInput');
  const previewContainer    = document.getElementById('preview-container');
  const uploadStatus        = document.getElementById('upload-status');
  const progressContainer   = document.getElementById('progress-container');
  const progressBar         = document.getElementById('progress-bar');
  const imagesOrderInput    = document.getElementById('images_order');
  const coverIndexInput     = document.getElementById('cover_index');
  const uploadedIdsInput    = document.getElementById('uploaded_ids');
  const clearImagesBtn      = document.getElementById('clearImages');
  const submitBtn           = document.getElementById('btnSubmit');
  const dropzone            = document.getElementById('dropzone');
  const overlay             = document.getElementById('loadingOverlay');
  const resetBtn            = document.getElementById('btnResetForm');
  const location_detail     = document.getElementById('location_detail');  // â† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯

  /* =========================[ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ]========================= */
  const categoriesMap = {
    "ÙØ±ÙˆØ´ Ù…Ø³Ú©ÙˆÙ†ÛŒ": ["Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†","Ø®Ø§Ù†Ù‡ Ùˆ ÙˆÛŒÙ„Ø§","Ø²Ù…ÛŒÙ† Ùˆ Ù…Ù„Ú© Ú©Ù„Ù†Ú¯ÛŒ"],
    "Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø³Ú©ÙˆÙ†ÛŒ": ["Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†","Ø®Ø§Ù†Ù‡ Ùˆ ÙˆÛŒÙ„Ø§"],
    "Ø§Ø¬Ø§Ø±Ù‡ Ø§Ø¯Ø§Ø±ÛŒ Ùˆ ØªØ¬Ø§Ø±ÛŒ": ["Ø¯ÙØªØ± Ú©Ø§Ø±ØŒ Ø§ØªØ§Ù‚ Ø§Ø¯Ø§Ø±ÛŒØŒ Ù…Ø·Ø¨","Ù…ØºØ§Ø²Ù‡ Ùˆ ØºØ±ÙÙ‡","ØµÙ†Ø¹ØªÛŒØŒ Ú©Ø´Ø§ÙˆØ±Ø²ÛŒØŒ ØªØ¬Ø§Ø±ÛŒ"],
    "ÙØ±ÙˆØ´ Ø§Ø¯Ø§Ø±ÛŒ Ùˆ ØªØ¬Ø§Ø±ÛŒ": ["Ø¯ÙØªØ± Ú©Ø§Ø±ØŒ Ø§ØªØ§Ù‚ Ø§Ø¯Ø§Ø±ÛŒØŒ Ù…Ø·Ø¨","Ù…ØºØ§Ø²Ù‡ Ùˆ ØºØ±ÙÙ‡","ØµÙ†Ø¹ØªÛŒØŒ Ú©Ø´Ø§ÙˆØ±Ø²ÛŒØŒ ØªØ¬Ø§Ø±ÛŒ"],
    "Ø§Ø¬Ø§Ø±Ù‡ Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª": ["Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ùˆ Ø³ÙˆØ¦ÛŒØª","ÙˆÛŒÙ„Ø§ Ùˆ Ø¨Ø§Øº","Ø¯ÙØªØ± Ú©Ø§Ø± Ùˆ ÙØ¶Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ"],
    "Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø®Øªâ€ŒÙˆØ³Ø§Ø²": ["Ù…Ø´Ø§Ø±Ú©Øª Ø¯Ø± Ø³Ø§Ø®Øª","Ù¾ÛŒØ´â€ŒÙØ±ÙˆØ´"]
  };

  const numfmt = new Intl.NumberFormat('fa-IR');
  const formatNumber = (n) => n ? numfmt.format(n) : '';
  function parseNumber(str) {
    if (!str) return 0;
    const persian = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
    const en = String(str).replace(/[Û°-Û¹]/g, d => String(persian.indexOf(d))).replace(/[^\d]/g, '');
    return Number(en || 0);
  }
  function numberToWordsFa(n){
    if(!n) return '';
    const units=[,'Ù‡Ø²Ø§Ø±','Ù…ÛŒÙ„ÛŒÙˆÙ†','Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯','Ù‡Ø²Ø§Ø± Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯'];
    let i=0; while(n>=1000 && i<units.length-1){ n=Math.round(n/1000); i++; }
    return formatNumber(n)+' '+units[i]+' ØªÙˆÙ…Ø§Ù†';
  }
  function getCsrf(){
    const meta = document.querySelector('meta[name="csrf-token"]');
    if(meta?.content) return meta.content;
    const hidden = document.querySelector('input[name="csrf_token"]');
    return hidden ? hidden.value : null;
  }
  const debounce = (fn, t=300) => { let id=null; return (...args)=>{ clearTimeout(id); id=setTimeout(()=>fn(...args), t); }; };

  /* =========================[ Ø´Ù‡Ø± Ø§Ø² localStorage ]==================== */
  const CITY_KEY = 'vinor_city';
  const getCity = () => { try { return localStorage.getItem(CITY_KEY) || ''; } catch { return ''; }
  };
  const setCityUI = () => {
    const c = getCity();
    cityInput.value = c || '';
    if (c) {
      cityDisplay.textContent = c;
      cityDisplay.classList.remove('border-red-300');
    } else {
      cityDisplay.textContent = 'Ø´Ù‡Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª';
      cityDisplay.classList.add('border-red-300');
    }
  };
  window.addEventListener('storage', (e) => { if (e.key === CITY_KEY) setCityUI(); });
  document.addEventListener('vinor:city-changed', setCityUI);

  /* =========================[ Ù…Ù†Ø·Ù‚ Ù‚ÛŒÙ…Øª ]============================= */
  function recalc(){
    const s = parseNumber(sizeInput.value);
    const t = parseNumber(totalPriceInput.value);
    sizeInput.value        = s ? formatNumber(s) : '';
    totalPriceInput.value  = t ? formatNumber(t) : '';
    pricePerMeterInput.value = (s>0 && t>0) ? formatNumber(Math.floor(t/s)) : '';
    priceWords.textContent   = t ? ('â‰ˆ ' + numberToWordsFa(t)) : '';
  }
  sizeInput.addEventListener('input', recalc);
  totalPriceInput.addEventListener('input', recalc);

  /* =====================[ Ù…Ù†Ø·Ù‚ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ/Ø²ÛŒØ±Ø´Ø§Ø®Ù‡ ]==================== */
  function fillSub(main, setValue=null){
    subSelect.innerHTML = '';
    const def = document.createElement('option');
    def.value=''; def.disabled=true; def.selected=true; def.textContent='Ø²ÛŒØ±Ø´Ø§Ø®Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...';
    subSelect.appendChild(def);

    (categoriesMap[main] || []).forEach(item=>{
      const opt=document.createElement('option');
      opt.value=item; opt.textContent=item;
      subSelect.appendChild(opt);
    });

    subSelect.disabled = !(categoriesMap[main]||[]).length;

    if(setValue && !subSelect.disabled){
      subSelect.value = setValue;
      if(!subSelect.value) subSelect.selectedIndex = 0;
    }
  }
  mainSelect.addEventListener('change', e=>fillSub(e.target.value));

  /* =======================[ Ù…Ù†Ø·Ù‚ ØªØµØ§ÙˆÛŒØ±/Ø¢Ù¾Ù„ÙˆØ¯ ]======================= */
  let imageItems = []; // {id,url,file,isCover,serverId,uploading}
  let totalUploads = 0, doneUploads = 0;

  const cryptoRandom = () =>
    (self.crypto || window.crypto).getRandomValues(new Uint32Array(1))[0].toString(16);

  const fileToDataURL = (file) =>
    new Promise(res => { const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); });

  function compressImage(file, maxW=1600, quality=0.82){
    return new Promise((res,rej)=>{
      const img = new Image();
      img.onload = ()=>{
        const scale = Math.min(1, maxW/img.width);
        const c=document.createElement('canvas');
        c.width = Math.round(img.width*scale);
        c.height= Math.round(img.height*scale);
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        c.toBlob(b => b ? res(new File([b],'img.jpg',{type:'image/jpeg'})) : rej(new Error('Compression failed')), 'image/jpeg', quality);
      };
      img.onerror = () => rej(new Error('Invalid image'));
      img.src = URL.createObjectURL(file);
    });
  }

  function renderThumbs(){
    previewContainer.innerHTML='';
    imageItems.forEach((it,idx)=>{
      const d=document.createElement('div');
      d.className='thumb border rounded overflow-hidden';
      d.draggable=true; d.dataset.id=it.id;
      d.setAttribute('aria-label','ØªØµÙˆÛŒØ± '+(idx+1));

      const img=document.createElement('img');
      img.src=it.url; img.className='w-full h-28 object-cover'; img.loading='lazy'; img.alt='ØªØµÙˆÛŒØ± Ø¢Ú¯Ù‡ÛŒ';

      const rm=document.createElement('button');
      rm.type='button'; rm.className='remove'; rm.title='Ø­Ø°Ù ØªØµÙˆÛŒØ±';
      rm.innerHTML='<i class="fas fa-times"></i>';
      rm.addEventListener('click', ()=>{
        imageItems=imageItems.filter(x=>x.id!==it.id);
        if(it.isCover && imageItems[0]) imageItems[0].isCover=true;
        renderThumbs(); syncImageHiddenInputs();
      });

      const star=document.createElement('button');
      star.type='button'; star.className='star'; star.title='Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ú©Ø§ÙˆØ±';
      star.innerHTML = it.isCover ? 'â­' : 'â˜†';
      star.addEventListener('click', ()=>{
        imageItems.forEach(x=>x.isCover=false); it.isCover=true;
        renderThumbs(); syncImageHiddenInputs();
      });

      d.addEventListener('dragstart', ev=>{ d.classList.add('dragging'); ev.dataTransfer.setData('text/plain', it.id); });
      d.addEventListener('dragend',   ()=> d.classList.remove('dragging'));
      d.addEventListener('dragover',  ev=>ev.preventDefault());
      d.addEventListener('drop', ev=>{
        ev.preventDefault();
        const fromId = ev.dataTransfer.getData('text/plain');
        if(fromId === it.id) return;
        const fromIdx=imageItems.findIndex(x=>x.id===fromId);
        const toIdx  =imageItems.findIndex(x=>x.id===it.id);
        const [moved]=imageItems.splice(fromIdx,1);
        imageItems.splice(toIdx,0,moved);
        renderThumbs(); syncImageHiddenInputs();
      });

      d.append(img, rm, star);

      if (it.uploading) {
        const sp=document.createElement('div');
        sp.className='spinner';
        sp.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯...';
        d.appendChild(sp);
      }
      if(it.isCover){
        const lab=document.createElement('span'); lab.className='cover'; lab.textContent='Ú©Ø§ÙˆØ±';
        d.appendChild(lab);
      }

      previewContainer.appendChild(d);
    });

    syncImageHiddenInputs();
  }

  function syncImageHiddenInputs(){
    imagesOrderInput.value = imageItems.map(x=>x.id).join(',');
    coverIndexInput.value  = imageItems.findIndex(x=>x.isCover);
    uploadedIdsInput.value = imageItems.map(x=>x.serverId||'').join(',');
  }

  function validateFile(f){
    if(!f.type.startsWith('image/')){ toast('ÙÙ‚Ø· ÙØ§ÛŒÙ„ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¬Ø§Ø² Ø§Ø³Øª'); return false; }
    if(f.size > CONFIG.MAX_FILE_SIZE_MB*1024*1024){ toast('Ø­Ø¬Ù… Ù‡Ø± ØªØµÙˆÛŒØ± Ø­Ø¯Ø§Ú©Ø«Ø± '+CONFIG.MAX_FILE_SIZE_MB+' Ù…Ú¯Ø§Ø¨Ø§ÛŒØª'); return false; }
    return true;
  }

  clearImagesBtn.addEventListener('click', ()=>{
    imageItems = []; totalUploads=0; doneUploads=0;
    renderThumbs(); updateGlobalProgress();
    imagesInput.value=''; uploadedIdsInput.value='';
  });

  async function handleFiles(files){
    const arr = Array.from(files||[]);
    if(!arr.length) return;

    if(arr.length + imageItems.length > CONFIG.MAX_FILES){
      toast('Ø­Ø¯Ø§Ú©Ø«Ø± '+CONFIG.MAX_FILES+' ØªØµÙˆÛŒØ± Ù…Ø¬Ø§Ø² Ø§Ø³Øª'); return;
    }

    uploadStatus.classList.remove('hidden');
    progressContainer.classList.remove('hidden');

    totalUploads += arr.length;
    updateGlobalProgress();

    const tasks = arr.map(async (f) => {
      if(!validateFile(f)){ doneUploads++; updateGlobalProgress(); return; }

      try{
        const compressed = await compressImage(f, 1600, 0.82);
        const url = await fileToDataURL(compressed);
        const item = { id: cryptoRandom(), url, file: compressed, isCover:false, serverId:null, uploading:true };
        imageItems.push(item);
        if (!imageItems.some(x=>x.isCover)) item.isCover = true;
        renderThumbs();

        try{
          const serverId = await uploadOne(compressed);
          item.serverId = serverId;
        }catch(err){
          console.error('Upload failed:', err);
          toast('Ø¢Ù¾Ù„ÙˆØ¯ ÛŒÚ© ØªØµÙˆÛŒØ± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
        }finally{
          item.uploading = false;
          doneUploads++;
          renderThumbs();
          updateGlobalProgress();
        }
      }catch(err){
        console.error(err);
        doneUploads++;
        updateGlobalProgress();
        toast('Ù¾Ø±Ø¯Ø§Ø²Ø´ ÛŒÚ© ØªØµÙˆÛŒØ± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
      }
    });

    await Promise.all(tasks);
    uploadStatus.textContent = imageItems.every(x=>x.serverId) ? 'Ù‡Ù…Ù‡ ØªØµØ§ÙˆÛŒØ± Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù†Ø¯' : 'Ø¨Ø±Ø®ÛŒ ØªØµØ§ÙˆÛŒØ± Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù†Ø¯';
  }

  imagesInput.addEventListener('change', (e)=>handleFiles(e.target.files));
  ['dragenter','dragover'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{ e.preventDefault(); dropzone.classList.add('dragover'); });
  });
  ['dragleave','drop'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{ e.preventDefault(); dropzone.classList.remove('dragover'); });
  });
  dropzone.addEventListener('drop', e=>{
    e.preventDefault();
    const dt = e.dataTransfer;
    if(dt?.files) handleFiles(dt.files);
  });

  async function uploadOne(file){
    const fd = new FormData();
    fd.append('file', file, 'image.jpg');
    const csrf = getCsrf();
    const headers = {};
    if(csrf){
      headers['X-CSRF-Token'] = csrf;
      headers['X-CSRFToken']  = csrf;
      headers['X-XSRF-TOKEN'] = csrf;
    }
    const resp = await fetch(CONFIG.UPLOAD_URL, { method:'POST', headers, body:fd, credentials:'same-origin' });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const data = await resp.json().catch(()=> ({}));
    return data.id || data.file_id || data.uuid || data.key || null;
  }

  function updateGlobalProgress(){
    const total = Math.max(totalUploads, 1);
    const percent = Math.round((doneUploads/total)*100);
    progressBar.style.width = percent+'%';
    if (doneUploads >= total){
      setTimeout(()=>{ progressContainer.classList.add('hidden'); uploadStatus.classList.add('hidden'); }, 600);
    } else {
      progressContainer.classList.remove('hidden');
      uploadStatus.classList.remove('hidden');
    }
  }

  /* =====================[ Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³ LocalStorage ]===================== */
  const saveDraft = () => {
    const fd = new FormData(form);
    const obj = {};
    fd.forEach((v,k)=>{ if(k !== 'images') obj[k]=v; });
    obj._images_meta = imageItems.map(x=>({id:x.id,url:x.url,isCover:x.isCover,serverId:x.serverId}));
    obj.city = getCity();
    try { localStorage.setItem(CONFIG.SAVE_KEY, JSON.stringify(obj)); } catch(_){}
  };

  const loadDraft = () => {
    const raw = localStorage.getItem(CONFIG.SAVE_KEY);
    if(raw){
      try{
        const obj = JSON.parse(raw);
        Object.entries(obj).forEach(([k,v])=>{
          if(k==='_images_meta') return;
          const el = form.elements[k]; if(el) el.value = v;
        });
        if(obj.category_main){ fillSub(obj.category_main, obj.category_sub || null); }
        if(obj._images_meta){
          imageItems = obj._images_meta.map(m=>({id:m.id,url:m.url,file:null,isCover:m.isCover,serverId:m.serverId||null,uploading:false}));
          renderThumbs();
        }
      }catch(_){}
    }
    setCityUI();
    recalc();
  };

  form.addEventListener('input', debounce(saveDraft, 800));

  /* =========================[ Toast Ú©ÙˆÚ†Ú© ]============================ */
  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    t.className='fixed bottom-20 right-3 bg-gray-900 text-white text-xs px-3 py-2 rounded shadow z-[9999]';
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); },1800);
  }

  /* =========================[ Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† ÙØ±Ù… ]========================== */
  async function deleteUploadedOnServer(ids){
    // Ø§Ø®ØªÛŒØ§Ø±ÛŒ: Ø§Ú¯Ø± API Ø­Ø°Ù ÙØ§ÛŒÙ„ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯
    if(!ids || !ids.length || !CONFIG.DELETE_UPLOAD_URL) return;
    const csrf = getCsrf();
    try{
      await fetch(CONFIG.DELETE_UPLOAD_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', ...(csrf ? {'X-CSRF-Token': csrf} : {}) },
        body: JSON.stringify({ ids })
      });
    }catch(_){}
  }

  function hardResetFormUI(){
    // Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§
    form.reset();
    // Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ù†Ù…Ø§ÛŒØ´â€ŒÙ‡Ø§
    imageItems = []; totalUploads = 0; doneUploads = 0;
    renderThumbs(); updateGlobalProgress();
    // Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ
    try { localStorage.removeItem(CONFIG.SAVE_KEY); } catch(_){}
    // Ø´Ù‡Ø± Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… ØªØ§ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ØªØ± Ø¨Ù…Ø§Ù†Ø¯
    setCityUI();
    // Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒØ´Ø¯Ù‡
    pricePerMeterInput.value = '';
    priceWords.textContent = '';
    // ÙˆØ±ÙˆØ¯ÛŒ ÙØ§ÛŒÙ„
    imagesInput.value = '';
  }

  resetBtn.addEventListener('click', async ()=>{
    const hasData = imageItems.length || (localStorage.getItem(CONFIG.SAVE_KEY) != null);
    const confirmMsg = hasData
      ? 'Ú©Ù„ ÙØ±Ù… Ùˆ Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³ Ùˆ ØªØµØ§ÙˆÛŒØ± Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.'
      : 'ÙØ±Ù… Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ';

    if(!confirm(confirmMsg)) return;

    // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯Ø´Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
    const uploadedIds = imageItems.map(x=>x.serverId).filter(Boolean);
    if(uploadedIds.length){
      await deleteUploadedOnServer(uploadedIds);
    }

    hardResetFormUI();
    toast('ÙØ±Ù… Ù¾Ø§Ú© Ø´Ø¯');
  });

  /* =========================[ Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… ]============================== */
  form.addEventListener('submit', (e)=>{
    // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„Ø› Ø§Ø±Ø³Ø§Ù„ ØªÙˆØ³Ø· Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø¨Ø¯ÙˆÙ† preventDefault)
    const city = getCity();
    if (!city) {
      cityDisplay.classList.add('border-red-300');
      toast('Ø¨Ù‡ØªØ± Ø§Ø³Øª Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ØŒ Ø´Ù‡Ø± Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
    }
    cityInput.value = city || '';

    // Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ù‡ Ø´Ú©Ù„ Ø®Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆØ±
    const sizeRaw  = parseNumber(sizeInput.value);
    const totalRaw = parseNumber(totalPriceInput.value);
    sizeInput.value          = sizeRaw;
    totalPriceInput.value    = totalRaw;
    pricePerMeterInput.value = parseNumber(pricePerMeterInput.value);

    // Ù†Ú¯Ø§Ø´Øª Ø¨Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ú©â€ŒØ§Ù†Ø¯
    document.getElementById('area_hidden').value     = sizeRaw || '';
    document.getElementById('price_hidden').value    = totalRaw || '';
    document.getElementById('location_hidden').value = (city || '') + (location_detail.value ? (' - ' + location_detail.value) : '');

    // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ØªØµØ§ÙˆÛŒØ±
    if(imageItems.length && imageItems.every(x=>!x.isCover)){ imageItems[0].isCover = true; }
    imagesOrderInput.value = imageItems.map(x=>x.id).join(',');
    coverIndexInput.value  = imageItems.findIndex(x=>x.isCover);
    uploadedIdsInput.value = imageItems.map(x=>x.serverId||'').join(',');

    // UI Ø§Ø±Ø³Ø§Ù„
    overlay.classList.remove('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';

    // Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø§Ø±Ø³Ø§Ù„ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø² Ø§ØªÙ…Ø§Ù… Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ø§Ø´Ø¯ØŒ Ø§ÛŒÙ† Ø¨Ù„Ø§Ú© Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†:
    // if (imageItems.some(x=>x.uploading)) {
    //   e.preventDefault();
    //   toast('Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø§ØªÙ…Ø§Ù… Ø¢Ù¾Ù„ÙˆØ¯ ØªØµØ§ÙˆÛŒØ± Ø¨Ù…Ø§Ù†ÛŒØ¯.');
    //   overlay.classList.add('hidden');
    //   submitBtn.disabled = false;
    //   submitBtn.textContent = 'ØªÚ©Ù…ÛŒÙ„ Ùˆ Ø§Ø¯Ø§Ù…Ù‡';
    // }
  });

  /* =======================[ Ø´Ø±ÙˆØ¹: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³ ]================== */
  window.addEventListener('load', loadDraft);

  /* =======================[ Ø­Ø°Ù Ø¢Ú¯Ù‡ÛŒ (ÙØ±Ù… Ø¬Ø¯Ø§) ]====================== */
  window.confirmDeleteAd = function (ev){
    const ok = confirm('Ø¢Ú¯Ù‡ÛŒ Ø¨Ù‡â€ŒØ·ÙˆØ± Ú©Ø§Ù…Ù„ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.');
    if(!ok){ ev.preventDefault(); return false; }
    return true;
  };
})();
</script>
{% endblock %}
