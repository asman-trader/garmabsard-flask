{% extends "base.html" %}
{% block title %}Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù† | Ø§Ù…Ù„Ø§Ú© Ø¢Ø³Ù…Ø§Ù† Ú¯Ø±Ù…Ø§Ø¨Ø³Ø±Ø¯{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">

  <!-- Header + actions -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-5">
    <div>
      <h2 class="text-xl font-bold text-green-700">ğŸ“‹ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
        Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒØªØ§Ù† Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯.
      </p>
    </div>

    <div class="flex items-center gap-2">
      <a href="{{ url_for('main.submit_ad') }}"
         class="inline-flex items-center gap-2 rounded-xl bg-green-600 hover:bg-green-700 text-white text-sm font-bold px-4 py-2">
        <i class="fas fa-plus-circle"></i> Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø¬Ø¯ÛŒØ¯
      </a>
      <a href="{{ url_for('main.city_select') }}"
         class="inline-flex items-center gap-2 rounded-xl border border-gray-200 dark:border-gray-700 px-3 py-2 text-sm hover:bg-green-50 dark:hover:bg-green-800">
        <i class="fas fa-map-marker-alt text-green-600"></i>
        <span id="myCityChip">Ø´Ù‡Ø± Ù…Ù†</span>
      </a>
    </div>
  </div>

  <!-- Toolbar: search + filters + sort (ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø¨Ù‡ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯) -->
  <form id="filterForm" method="get" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow-sm">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
      <!-- Search -->
      <div class="md:col-span-2">
        <label class="text-xs text-gray-600 dark:text-gray-300">Ø¬Ø³ØªØ¬Ùˆ</label>
        <div class="mt-1 relative">
          <input name="q" value="{{ request.args.get('q','') }}"
                 type="text" placeholder="Ø¹Ù†ÙˆØ§Ù†ØŒ Ú©Ø¯ Ù…Ù„Ú©ØŒ Ù…ÙˆÙ‚Ø¹ÛŒØª..."
                 class="w-full rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 pe-9
                        dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 outline-none">
          <i class="fas fa-search absolute top-1/2 -translate-y-1/2 left-3 text-gray-400"></i>
        </div>
      </div>

      <!-- Status -->
      <div>
        <label class="text-xs text-gray-600 dark:text-gray-300">ÙˆØ¶Ø¹ÛŒØª</label>
        <select name="status" class="mt-1 w-full rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 dark:bg-gray-800 dark:text-white">
          {% set st = request.args.get('status','') %}
          <option value="" {{ 'selected' if st=='' else '' }}>Ù‡Ù…Ù‡</option>
          <option value="approved" {{ 'selected' if st=='approved' else '' }}>ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</option>
          <option value="pending"  {{ 'selected' if st=='pending'  else '' }}>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</option>
          <option value="rejected" {{ 'selected' if st=='rejected' else '' }}>Ø±Ø¯ Ø´Ø¯Ù‡</option>
        </select>
      </div>

      <!-- Sort -->
      <div>
        <label class="text-xs text-gray-600 dark:text-gray-300">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ</label>
        <select name="sort" class="mt-1 w-full rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 dark:bg-gray-800 dark:text-white">
          {% set srt = request.args.get('sort','new') %}
          <option value="new"        {{ 'selected' if srt=='new' else '' }}>Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
          <option value="old"        {{ 'selected' if srt=='old' else '' }}>Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†</option>
          <option value="size_desc"  {{ 'selected' if srt=='size_desc' else '' }}>Ø¨Ø²Ø±Ú¯â€ŒØªØ±ÛŒÙ† Ù…ØªØ±Ø§Ú˜</option>
          <option value="size_asc"   {{ 'selected' if srt=='size_asc'  else '' }}>Ú©ÙˆÚ†Ú©â€ŒØªØ±ÛŒÙ† Ù…ØªØ±Ø§Ú˜</option>
        </select>
      </div>
    </div>

    <div class="flex items-center gap-2 mt-3">
      <button class="inline-flex items-center gap-2 rounded-xl bg-green-600 hover:bg-green-700 text-white text-sm font-bold px-4 py-2">
        <i class="fas fa-filter"></i> Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
      </button>
      <a href="{{ url_for('main.my_lands') }}"
         class="inline-flex items-center gap-2 rounded-xl border border-gray-300 dark:border-gray-700 px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700">
        Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
      </a>
    </div>
  </form>

  {% set has_items = lands and lands|length > 0 %}
  {% if has_items %}

    <!-- Count -->
    <div class="flex items-center justify-between mt-5 mb-3">
      <span class="text-sm text-gray-600 dark:text-gray-400">
        ØªØ¹Ø¯Ø§Ø¯ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§: <strong>{{ lands|length }}</strong>
      </span>
    </div>

    <!-- Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for land in lands %}
      <article class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-sm hover:shadow-lg transition overflow-hidden">
        <!-- Status badge -->
        {% if land.status == 'pending' %}
          <div class="absolute top-2 right-2 bg-yellow-500 text-white text-[11px] font-bold px-2 py-1 rounded">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</div>
        {% elif land.status == 'approved' %}
          <div class="absolute top-2 right-2 bg-green-600 text-white text-[11px] font-bold px-2 py-1 rounded">ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</div>
        {% elif land.status == 'rejected' %}
          <div class="absolute top-2 right-2 bg-red-500 text-white text-[11px] font-bold px-2 py-1 rounded">Ø±Ø¯ Ø´Ø¯Ù‡</div>
        {% endif %}

        <a href="{{ url_for('main.land_detail', code=land.code) }}" class="block">
          {% if land.images and land.images[0] %}
            <img src="{{ url_for('main.uploaded_file', filename=land.images[0]) }}"
                 alt="ØªØµÙˆÛŒØ± Ø²Ù…ÛŒÙ† {{ land.title }}" loading="lazy"
                 class="w-full h-48 object-cover">
          {% else %}
            <div class="w-full h-48 bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400">
              Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±
            </div>
          {% endif %}
        </a>

        <div class="p-4">
          <h3 class="text-base font-bold text-green-700 dark:text-green-400 truncate" title="{{ land.title }}">{{ land.title }}</h3>

          <!-- Meta -->
          <div class="mt-2 grid grid-cols-2 gap-2 text-xs text-gray-600 dark:text-gray-300">
            <div class="flex items-center gap-1">
              <i class="fas fa-vector-square text-gray-500"></i>
              <span>
                {% set _sz = (land.size|int if land.size is not none else 0) %}
                {{ "{:,}".format(_sz) if _sz else "?" }} Ù…ØªØ±
              </span>
            </div>
            <div class="flex items-center gap-1">
              <i class="fas fa-map-marker-alt text-gray-500"></i>
              <span class="truncate" title="{{ land.location or '' }}">{{ land.location or "?" }}</span>
            </div>
            <div class="flex items-center gap-1">
              <i class="fas fa-hashtag text-gray-500"></i>
              <span>Ú©Ø¯: {{ land.code }}</span>
            </div>
            <div class="flex items-center gap-1">
              <i class="fas fa-clock text-gray-500"></i>
              <span>
                {{ land.created_at | date_ymd }}
              </span>
            </div>
          </div>

          {% if land.price_total is not none %}
          <div class="mt-2 text-sm font-bold text-gray-800 dark:text-gray-100">
            ğŸ’° Ù‚ÛŒÙ…Øª:
            {% set _pt = land.price_total|int %}
            {{ "{:,}".format(_pt) }} ØªÙˆÙ…Ø§Ù†
          </div>
          {% endif %}

          <!-- Actions -->
          <div class="mt-4 flex items-center gap-2">
            <a href="{{ url_for('main.land_detail', code=land.code) }}"
               class="flex-1 text-center border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm px-3 py-2 rounded-lg">
              <i class="fas fa-eye"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡
            </a>
            <a href="{{ url_for('main.edit_land', code=land.code) }}"
               class="flex-1 text-center bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-2 rounded-lg">
              âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´
            </a>
            <form method="POST" action="{{ url_for('main.delete_land', code=land.code) }}"
                  onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¢Ú¯Ù‡ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')">
              {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
              <button type="submit"
                      class="flex-1 text-center bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-2 rounded-lg w-full">
                ğŸ—‘ï¸ Ø­Ø°Ù
              </button>
            </form>
          </div>

          <!-- Quick share/copy -->
          <div class="mt-3 flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
            <button type="button" class="inline-flex items-center gap-1 hover:text-green-700"
                    onclick="shareLand('{{ url_for('main.land_detail', code=land.code, _external=True) }}', '{{ land.title|e }}')">
              <i class="fas fa-share-alt"></i> Ø§Ø´ØªØ±Ø§Ú©
            </button>
            <button type="button" class="inline-flex items-center gap-1 hover:text-green-700"
                    onclick="copyLink('{{ url_for('main.land_detail', code=land.code, _external=True) }}')">
              <i class="fas fa-link"></i> Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©
            </button>
          </div>
        </div>
      </article>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if pagination and (pagination.pages > 1) %}
      <div class="mt-6 flex items-center justify-center gap-2">
        {% if pagination.has_prev %}
          <a href="{{ page_url(pagination.page - 1) }}"
             class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm">
            Ù‚Ø¨Ù„ÛŒ
          </a>
        {% else %}
          <span class="px-3 py-2 rounded-lg border border-transparent text-sm text-gray-400">Ù‚Ø¨Ù„ÛŒ</span>
        {% endif %}

        <span class="px-3 py-2 text-sm">
          ØµÙØ­Ù‡ {{ pagination.page }} Ø§Ø² {{ pagination.pages }}
        </span>

        {% if pagination.has_next %}
          <a href="{{ page_url(pagination.page + 1) }}"
             class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm">
            Ø¨Ø¹Ø¯ÛŒ
          </a>
        {% else %}
          <span class="px-3 py-2 rounded-lg border border-transparent text-sm text-gray-400">Ø¨Ø¹Ø¯ÛŒ</span>
        {% endif %}
      </div>
    {% endif %}

  {% else %}
    <!-- Empty state -->
    <div class="mt-6 rounded-2xl border border-dashed border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 text-center">
      <div class="text-4xl mb-2">ğŸ—‚ï¸</div>
      <h3 class="font-bold text-gray-800 dark:text-gray-100">Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Ø¨Ø§ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒØŒ Ø²Ù…ÛŒÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ø¨Ù‡ Ø®Ø±ÛŒØ¯Ø§Ø±Ø§Ù† Ù…Ø¹Ø±ÙÛŒ Ú©Ù†ÛŒØ¯.</p>
      <a href="{{ url_for('main.submit_ad') }}"
         class="inline-flex items-center gap-2 mt-4 rounded-xl bg-green-600 hover:bg-green-700 text-white text-sm font-bold px-4 py-2">
        <i class="fas fa-plus-circle"></i> Ø«Ø¨Øª Ø§ÙˆÙ„ÛŒÙ† Ø¢Ú¯Ù‡ÛŒ
      </a>
    </div>
  {% endif %}
</div>

<script>
  // City chip: read from localStorage if exists
  (function() {
    const CITY_KEY = 'gbs_city';
    const chip = document.getElementById('myCityChip');
    try {
      const c = localStorage.getItem(CITY_KEY) || '';
      if (c && chip) chip.textContent = 'Ø´Ù‡Ø± Ù…Ù†: ' + c;
    } catch (_) {}
  })();

  // Web Share + Clipboard fallbacks for item
  async function shareLand(url, title){
    const data = { title: title || document.title, text: 'Ø¢Ú¯Ù‡ÛŒ Ù…Ù„Ú© - Ø§Ù…Ù„Ø§Ú© Ø¢Ø³Ù…Ø§Ù† Ú¯Ø±Ù…Ø§Ø¨Ø³Ø±Ø¯', url };
    try {
      if (navigator.share) { await navigator.share(data); return; }
      await navigator.clipboard.writeText(url);
      toast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯ âœ…');
    } catch(_) { /* ignored */ }
  }
  async function copyLink(url){
    try { await navigator.clipboard.writeText(url); toast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯ âœ…'); } catch(_) {}
  }
  function toast(text){
    const t = document.createElement('div');
    t.textContent = text; t.dir='rtl';
    t.className = 'fixed bottom-16 inset-x-0 mx-auto w-fit px-3 py-2 rounded-lg text-sm bg-green-600 text-white shadow z-[60]';
    document.body.appendChild(t); setTimeout(()=>t.remove(),1800);
  }
</script>
{% endblock %}
