<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}وینور | خرید و فروش ملک{% endblock %}</title>

  {# --- Favicon & PWA --- #}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  {# مانیفست از روت اختصاصی با MIME صحیح #}
  <link rel="manifest" href="{{ url_for('main.pwa_manifest') }}">
  <meta name="theme-color" content="#16a34a">

  {# iOS PWA #}
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">

  {# --- CSS/Fonts --- #}
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <style>
    body{font-family:'Vazirmatn',sans-serif;scroll-behavior:smooth}
    /* FAB موبایلی */
    .fab{
      position:fixed;bottom:20px;left:20px;z-index:40;background:#16a34a;color:#fff;
      width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 6px rgba(0,0,0,.3);transition:background-color .3s
    }
    .fab:hover{background:#15803d}

    /* فیلترهای پیشرفته */
    #advancedFilters{position:absolute;top:110%;left:0;width:100%;z-index:30;display:none}
    #advancedFilters.active{display:block}
    #locationMenu.active{display:block!important}

    /* سایدبار */
    #sideMenu{
      position:fixed;top:0;right:0;height:100%;width:18rem;background:#fff;z-index:50;
      transform:translateX(100%);transition:transform .3s ease-in-out;
      box-shadow:-1px 0 5px rgba(0,0,0,.1);border-left:1px solid #e5e7eb
    }
    #sideMenu.open{transform:translateX(0)}
    .dark #sideMenu{background:#111827;border-color:#374151}
  </style>

  {% block head %}{% endblock %}
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col">

  {% if not hide_header %}
  <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <a href="{{ url_for('main.index') }}" class="flex items-center gap-3" aria-label="وینور | صفحه اصلی">
        <span class="bg-green-600 hover:bg-green-700 text-white w-10 h-10 flex items-center justify-center rounded-full text-xl shadow-lg font-bold">
          <i class="fas fa-seedling animate-pulse"></i>
        </span>
        <span class="text-xl sm:text-2xl font-extrabold text-gray-800 dark:text-white">وینور</span>
      </a>
      <div class="flex items-center gap-4">
        <a href="{{ url_for('main.submit_ad') }}" class="hidden sm:flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm shadow">
          <i class="fas fa-plus-circle"></i> ثبت آگهی رایگان
        </a>
        <a href="{{ url_for('main.search_page') }}" class="text-green-600 dark:text-green-400 text-xl sm:text-2xl hover:text-green-800" aria-label="جستجو">
          <i class="fas fa-search"></i>
        </a>
        <button id="menuToggle" class="text-2xl text-green-600 dark:text-green-400" aria-label="باز کردن منو">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
  </header>
  {% endif %}

  <main class="flex-1 py-6 px-4 transition-all duration-300">
    {% block content %}{% endblock %}
  </main>

  {# --- FAB: با شرط مخفی‌سازی در صفحه‌های خاص + بلوک قابل‌اورراید --- #}
  {% block floating_action %}
    {% if not hide_header and request.endpoint != 'main.my_lands' %}
      <a href="{{ url_for('main.submit_ad') }}" class="fab" title="ثبت آگهی" aria-label="ثبت آگهی">
        <i class="fas fa-plus text-xl"></i>
      </a>
    {% endif %}
  {% endblock %}

  {# سایدبار #}
  {% include 'side_menu.html' %}

  {# === آماده‌سازی امن متغیرها برای اسکریپت‌ها (بدون استفاده از globals()) === #}
  {% set __is_logged_in = (VINOR_IS_LOGGED_IN if VINOR_IS_LOGGED_IN is defined else (session.get('user_id') and True)) %}
  {% set __login_url    = (VINOR_LOGIN_URL    if VINOR_LOGIN_URL    is defined else url_for('main.login')) %}

  <script>
    (function(){
      const IS_LOGGED_IN = {{ 'true' if __is_logged_in else 'false' }};
      const LOGIN_URL    = "{{ __login_url }}";

      // گارد لاگین برای لینک‌هایی که ورود لازم دارند
      document.querySelectorAll('[data-require-login="1"], .require-login').forEach(el=>{
        el.addEventListener('click', (e)=>{
          if(!IS_LOGGED_IN){
            e.preventDefault();
            location.href = LOGIN_URL;
          }
        });
      });

      // سایدبار
      const sideMenu = document.getElementById("sideMenu");
      document.getElementById("menuToggle")?.addEventListener("click", ()=> sideMenu?.classList.add("open"));
      document.getElementById("closeMenu")?.addEventListener("click", ()=> sideMenu?.classList.remove("open"));
      window.addEventListener("click", (e)=>{
        if(!e.target.closest("#sideMenu") && !e.target.closest("#menuToggle")) sideMenu?.classList.remove("open");
      });

      // فیلترها
      const toggleBtn = document.getElementById("toggleFilters");
      const filters   = document.getElementById("advancedFilters");
      toggleBtn?.addEventListener("click", ()=> filters?.classList.toggle("active"));

      const locationToggle = document.getElementById("locationToggle");
      const locationMenu   = document.getElementById("locationMenu");
      locationToggle?.addEventListener("click", ()=> locationMenu?.classList.toggle("active"));
      window.addEventListener("click", (e)=>{
        if (!e.target.closest("#locationMenu")   && !e.target.closest("#locationToggle")) locationMenu?.classList.remove("active");
        if (!e.target.closest("#advancedFilters")&& !e.target.closest("#toggleFilters"))  filters?.classList.remove("active");
      });

      // ثبت Service Worker (PWA) از روت صحیح
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('{{ url_for("main.pwa_sw") }}', { scope: '/' }).catch(()=>{});
      }
    })();
  </script>

  {# ===== Push Helpers (بدون UI) — صفحه‌ها می‌توانند از این توابع استفاده کنند ===== #}
  <script>
    (function(){
      // VAPID Public Key از کانفیگ (تزریق‌شده در context processor)
      const VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY|default('', true) }}";

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
      }

      async function requestPermission() {
        if (!("Notification" in window)) throw new Error("مرورگر شما از اعلان پشتیبانی نمی‌کند.");
        const perm = await Notification.requestPermission();
        if (perm !== "granted") throw new Error("اجازه اعلان داده نشد.");
        return perm;
      }

      async function getRegistration() {
        if (!('serviceWorker' in navigator)) throw new Error("Service Worker پشتیبانی نمی‌شود.");
        const reg = await navigator.serviceWorker.getRegistration('/');
        if (reg) return reg;
        // تلاش برای رجیستر اگر هنوز انجام نشده
        return await navigator.serviceWorker.register('{{ url_for("main.pwa_sw") }}', { scope: '/' });
      }

      async function subscribePush() {
        await requestPermission();
        const reg = await getRegistration();
        const existing = await reg.pushManager.getSubscription();
        if (existing) return existing;
        if (!VAPID_PUBLIC_KEY) throw new Error("VAPID_PUBLIC_KEY تنظیم نشده است.");
        const appServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
        return await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
      }

      async function saveSubscription(sub) {
        const res = await fetch("/api/push/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify(sub),
        });
        if (!res.ok) throw new Error("ذخیره اشتراک ناموفق بود.");
        return await res.json();
      }

      async function testPush(payload = { title: "وینور", body: "اعلان تستی فعال شد ✅", url: "/app/notifications" }) {
        const res = await fetch("/api/push/test", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("ارسال تست ناموفق بود.");
        return await res.json();
      }

      // اکسپورت سراسری (بدون آلودگی زیاد)
      window.VinorPush = {
        subscribe: async () => {
          const sub = await subscribePush();
          await saveSubscription(sub);
          return sub;
        },
        test: testPush,
        permission: () => (Notification && Notification.permission) || "default",
        hasSW: () => 'serviceWorker' in navigator,
        vapid: () => VAPID_PUBLIC_KEY
      };

      // پشتیبانی از ایونت سفارشی برای صفحات
      window.addEventListener("vinor:enable-push", async (e) => {
        try {
          await window.VinorPush.subscribe();
          window.dispatchEvent(new CustomEvent("vinor:push-enabled", { detail: { ok: true }}));
        } catch (err) {
          window.dispatchEvent(new CustomEvent("vinor:push-enabled", { detail: { ok: false, error: String(err) }}));
        }
      });

      window.addEventListener("vinor:test-push", async (e) => {
        try {
          await window.VinorPush.test(e.detail || undefined);
          window.dispatchEvent(new CustomEvent("vinor:push-tested", { detail: { ok: true }}));
        } catch (err) {
          window.dispatchEvent(new CustomEvent("vinor:push-tested", { detail: { ok: false, error: String(err) }}));
        }
      });
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
