<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>{% block title %}وینور | خرید و فروش ملک{% endblock %}</title>

  {# --- Favicon & PWA --- #}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  {# مانیفست: روت سراسری که در app/__init__.py تعریف شده است #}
  <link rel="manifest" href="{{ url_for('serve_manifest') }}">
  <meta name="theme-color" content="#16a34a">

  <script>
    (function(){
      try {
        var root = document.documentElement;
        var saved = localStorage.getItem('theme');
        if (!saved) {
          // پیش‌فرض: مطابق سیستم
          var prefersDark = false;
          try { prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; } catch(_) {}
          saved = prefersDark ? 'dark' : 'light';
          try { localStorage.setItem('theme', saved); } catch(_) {}
        }
        if (saved === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
        var meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute('content', root.classList.contains('dark') ? '#111827' : '#16a34a');
      } catch(_) {}
    })();
  </script>

  {# iOS PWA #}
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">

  {# --- CSS/Fonts --- #}
  <script>
    // Tailwind CDN config: enable class-based dark mode
    window.tailwind = window.tailwind || {};
    window.tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <style>
    body{font-family:'Vazirmatn',sans-serif;scroll-behavior:smooth}
    /* Disable text selection and copy globally */
    *, *::before, *::after{
      -webkit-user-select:none; /* Safari */
      -moz-user-select:none;    /* Firefox */
      -ms-user-select:none;     /* IE10+/Edge */
      user-select:none;         /* Standard */
      -webkit-touch-callout:none; /* iOS long-press */
    }
    /* FAB موبایلی */
    .fab{
      position:fixed;bottom:20px;left:20px;z-index:40;background:#16a34a;color:#fff;
      width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 6px rgba(0,0,0,.3);transition:background-color .3s
    }
    .fab:hover{background:#15803d}

    /* فیلترهای پیشرفته */
    #advancedFilters{position:absolute;top:110%;left:0;width:100%;z-index:30;display:none}
    #advancedFilters.active{display:block}
    #locationMenu.active{display:block!important}

    /* سایدبار */
    #sideMenu{
      position:fixed;top:0;right:0;height:100%;width:18rem;background:#fff;z-index:50;
      transform:translateX(100%);transition:transform .2s cubic-bezier(.2,.8,.2,1);
      box-shadow:-1px 0 5px rgba(0,0,0,.1);border-left:1px solid #e5e7eb
    }
    #sideMenu.open{transform:translateX(0)}
    .dark #sideMenu{background:#111827;border-color:#374151}

    /* PWA Welcome (first-run on mobile) */
    .pwa-welcome{position:fixed;inset:0;z-index:70;display:flex;align-items:center;justify-content:center;background:rgba(17,24,39,.86)}
    .pwa-welcome.hidden{opacity:0;pointer-events:none;transition:opacity .35s ease}
    .pwa-card{display:flex;flex-direction:column;align-items:center;gap:10px;background:#0b1220;border:1px solid #1f2937;border-radius:20px;padding:22px 24px;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .sprout{display:grid;place-items:center;width:72px;height:72px;border-radius:50%;background:#16a34a;color:#fff;box-shadow:0 8px 20px rgba(22,163,74,.35);animation:sproutPop .9s cubic-bezier(.2,.8,.2,1)}
    @keyframes sproutPop{0%{transform:scale(.6);filter:blur(2px);opacity:.5}60%{transform:scale(1.06);filter:blur(0);opacity:1}100%{transform:scale(1)}}
    /* Offline status bar */
    #offlineBar{position:fixed;bottom:12px;right:12px;left:12px;z-index:60;display:none}
    .offline-bar{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;border-radius:14px;border:1px solid #374151;background:#111827;color:#e5e7eb;box-shadow:0 8px 22px rgba(0,0,0,.35)}
    .offline-btn{background:#16a34a;color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  </style>

  {% block head %}{% endblock %}
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col">

  {% if not hide_header %}
  <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <a href="{{ url_for('main.index') }}" class="flex items-center gap-3" aria-label="وینور | صفحه اصلی">
        <span class="bg-green-600 hover:bg-green-700 text-white w-10 h-10 flex items-center justify-center rounded-full text-xl shadow-lg font-bold">
          <i class="fas fa-seedling animate-pulse"></i>
        </span>
        <span class="text-xl sm:text-2xl font-extrabold text-gray-800 dark:text-white">وینور</span>
      </a>
      <div class="flex items-center gap-4">
        {% if SHOW_SUBMIT_BUTTON %}
        <a id="headerSubmitBtn" href="{{ url_for('main.submit_ad') }}" class="hidden sm:flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm shadow">
          <i class="fas fa-plus-circle"></i> ثبت آگهی رایگان
        </a>
        {% endif %}
        <a href="{{ url_for('main.search_page') }}" class="text-green-600 dark:text-green-400 text-xl sm:text-2xl hover:text-green-800" aria-label="جستجو">
          <i class="fas fa-search"></i>
        </a>
        <button id="menuToggle" class="text-2xl text-green-600 dark:text-green-400" aria-label="باز کردن منو">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
  </header>
  {% endif %}

  <main class="flex-1 py-6 px-4 transition-all duration-300">
    {% block content %}{% endblock %}
  </main>

  <!-- PWA First-run Welcome (mobile only; standalone only; once) -->
  <div id="pwaWelcome" class="pwa-welcome hidden" role="dialog" aria-modal="true" aria-label="خوش‌آمدید">
    <div class="pwa-card">
      <div class="sprout text-3xl"><i class="fas fa-seedling"></i></div>
      <div class="text-center">
        <div class="font-extrabold text-lg">به وینور خوش آمدید</div>
        <div class="text-sm text-gray-300 mt-1">اپ آماده است؛ تجربه‌ای سریع و روان داشته باشید.</div>
      </div>
      <button id="pwaWelcomeClose" class="mt-1 px-4 py-2 rounded-xl bg-green-600 hover:bg-green-700 text-white text-sm">شروع</button>
    </div>
  </div>

  {# --- FAB: با شرط مخفی‌سازی در صفحه‌های خاص + بلوک قابل‌اورراید --- #}
  {% block floating_action %}
    {% if not hide_header and request.endpoint != 'main.my_lands' and SHOW_SUBMIT_BUTTON %}
      <a id="fabSubmitBtn" href="{{ url_for('main.submit_ad') }}" class="fab {{ 'sm:hidden' if request.endpoint in ['main.index','main.app_home'] else '' }}" title="ثبت آگهی" aria-label="ثبت آگهی">
        <i class="fas fa-plus text-xl"></i>
      </a>
    {% endif %}
  {% endblock %}

  {# سایدبار #}
  {% include 'partials/side_menu.html' %}
  <!-- Backdrop for side menu (mobile only) -->
  <div id="menuBackdrop" class="fixed inset-0 sm:hidden bg-black/30 opacity-0 pointer-events-none transition-opacity z-40"></div>
  <!-- Offline status bar -->
  <div id="offlineBar">
    <div class="offline-bar">
      <div id="offlineText">شما آفلاین هستید. برخی محتوا از کش نمایش داده می‌شود.</div>
      <button id="offlineRefresh" class="offline-btn">بروزرسانی</button>
    </div>
  </div>

  {# === آماده‌سازی امن متغیرها برای اسکریپت‌ها (بدون استفاده از globals()) === #}
  {% set __is_logged_in = (VINOR_IS_LOGGED_IN if VINOR_IS_LOGGED_IN is defined else (session.get('user_id') and True)) %}
  {% set __login_url    = (VINOR_LOGIN_URL    if VINOR_LOGIN_URL    is defined else url_for('main.login')) %}

  <script>
    (function(){
      const IS_LOGGED_IN = {{ 'true' if __is_logged_in else 'false' }};
      const IS_HOME = {{ 'true' if request.endpoint in ['main.index','main.app_home'] else 'false' }};
      const LOGIN_URL    = "{{ __login_url }}";

      // گارد لاگین برای لینک‌هایی که ورود لازم دارند
      document.querySelectorAll('[data-require-login="1"], .require-login').forEach(el=>{
        el.addEventListener('click', (e)=>{
          if(!IS_LOGGED_IN){
            e.preventDefault();
            location.href = LOGIN_URL;
          }
        });
      });

      // سایدبار
      const sideMenu = document.getElementById("sideMenu");
      const menuBackdrop = document.getElementById('menuBackdrop');
      const menuOverlay  = document.getElementById('menuOverlay');

      function setOverlay(open){
        const overlays = [menuBackdrop, menuOverlay];
        overlays.forEach(ov => {
          if (!ov) return;
          if (open) {
            ov.classList.remove('opacity-0','pointer-events-none');
            ov.classList.add('opacity-100','pointer-events-auto');
          } else {
            ov.classList.add('opacity-0','pointer-events-none');
            ov.classList.remove('opacity-100','pointer-events-auto');
          }
        });
      }

      function openMenu(){
        try{ sideMenu?.classList.add('open'); }catch(_){ }
        setOverlay(true);
        try { document.body.style.overflow = 'hidden'; } catch(_){ }
      }
      function closeMenu(){
        try{ sideMenu?.classList.remove('open'); }catch(_){ }
        setOverlay(false);
        try { document.body.style.overflow = ''; } catch(_){ }
      }

      // کنترل نمایش/پنهان شدن دکمه منو بر اساس تنظیم کاربر
      (function(){
        const btn = document.getElementById('menuToggle');
        if (!btn) return;
        function apply(){
          let on = true;
          try{ const v = localStorage.getItem('vinor_show_sidebar'); on = v ? v==='1' : true; }catch{}
          btn.style.display = on ? '' : 'none';
        }
        apply();
        window.addEventListener('storage', (e)=>{ if(e.key==='vinor_show_sidebar') apply(); });
        window.addEventListener('vinor:sidebar-toggle', apply);
      })();

      document.getElementById("menuToggle")?.addEventListener("click", openMenu);

      // کنترل نمایش دکمه + ثبت آگهی (هدر و FAB) بر اساس تنظیم کاربر
      (function(){
        const headerBtn = document.getElementById('headerSubmitBtn');
        const fabBtn = document.getElementById('fabSubmitBtn');
        function apply(){
          let on = true;
          try{ const v = localStorage.getItem('vinor_show_submit_btn'); on = v ? v==='1' : true; }catch{}
          if (headerBtn) headerBtn.style.display = on ? '' : 'none';
          if (fabBtn) fabBtn.style.display = on ? '' : 'none';
        }
        apply();
        window.addEventListener('storage', (e)=>{ if(e.key==='vinor_show_submit_btn') apply(); });
        window.addEventListener('vinor:submit-btn-toggle', apply);
      })();
      // Offline/Online hybrid UX bar + warmup sync
      (function(){
        const bar = document.getElementById('offlineBar');
        const txt = document.getElementById('offlineText');
        const btn = document.getElementById('offlineRefresh');
        function show(on,msg){ if (!bar) return; if (msg && txt) txt.textContent = msg; bar.style.display = on ? '' : 'none'; }
        async function warmup(){
          try{
            const reg = await navigator.serviceWorker?.getRegistration('/');
            const sw = reg?.active || reg?.waiting || reg?.installing;
            sw?.postMessage({ type:'VINOR_WARMUP' });
            sw?.postMessage({ type:'VINOR_WARMUP_SYNC' });
          }catch(_){ }
        }
        function update(){
          if (navigator.onLine){
            show(true,'آنلاین شدید؛ در حال بروزرسانی کش...');
            warmup();
            setTimeout(()=>{ try { location.reload(); } catch(_){ show(false); } }, 1200);
          } else {
            show(true,'شما آفلاین هستید. برخی محتوا از کش نمایش داده می‌شود.');
          }
        }
        window.addEventListener('online', update);
        window.addEventListener('offline', update);
        btn?.addEventListener('click', update);
        if (!navigator.onLine) show(true,'شما آفلاین هستید. برخی محتوا از کش نمایش داده می‌شود.');
      })();
      document.getElementById("closeMenu")?.addEventListener("click", closeMenu);
      menuBackdrop?.addEventListener('click', (e)=>{ e.preventDefault(); closeMenu(); });
      menuOverlay?.addEventListener('click', (e)=>{ e.preventDefault(); closeMenu(); });
      // Fix BFCache/back navigation dimming
      window.addEventListener('pageshow', () => { closeMenu(); });
      // اول منو را ببند، سپس اجازه بده سایر کلیک‌ها اجرا شوند (capture)
      window.addEventListener("click", (e)=>{
        try {
          const isOpen = sideMenu?.classList.contains('open');
          const insideMenu = !!e.target.closest('#sideMenu');
          const onToggle = !!e.target.closest('#menuToggle');
          if (isOpen && !insideMenu && !onToggle) {
            closeMenu();
            // مانع رسیدن کلیک به عناصر زیرین شو
            if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
            else e.stopPropagation();
            try { e.preventDefault(); } catch(_) {}
            return;
          }
        } catch(_) {}
      }, true);

      // ژست کشیدنی همه‌پلتفرم (موبایل و دسکتاپ) برای باز/بستن منو (RTL)
      (function(){
        let startX = 0, startY = 0, dx = 0, dy = 0, tracking = false, mode = '';
        const EDGE = 24;        // ناحیه فعال کنار صفحه (px)
        const OPEN_THRESH = 48; // حداقل جابجایی افقی (px)

        function isInteractive(el){
          return el && (el.closest('#menuToggle') || el.closest('input,textarea,select,button,a'));
        }

        // نواحی که نباید ژست بازشدن منو با آن‌ها تداخل داشته باشد (گالری، نقشه، فول‌اسکرین)
        function isSwipeExcluded(el){
          if (!el) return false;
          return !!(
            el.closest('.swiper') ||
            el.closest('#land-swiper') ||
            el.closest('#fullscreenOverlay') ||
            el.closest('#mapModal') ||
            el.closest('#mapModalMap') ||
            el.closest('#landMap')
          );
        }

        function onStart(ev){
          const t = ev.touches ? ev.touches[0] : ev;
          const target = ev.target || null;
          const menuIsOpen = sideMenu?.classList.contains('open');
          // وقتی منو باز است، حتی روی المان‌های تعاملی هم ژست بستن فعال است
          // وقتی منو بسته است: در صفحه اصلی، از هرجا (به جز المان‌های تعاملی) شروع شود؛
          // در سایر صفحات، هم از لبه راست و هم خارج از نواحی حساس.
          if (!menuIsOpen) {
            if (IS_HOME) {
              // در صفحه اصلی: اجازه شروع ژست از هر جا (بدون استثنا)
            } else {
              if (isInteractive(target) || isSwipeExcluded(target)) return;
              const vw = (document.documentElement && document.documentElement.clientWidth) || window.innerWidth || 0;
              if (vw && t.clientX < (vw - EDGE)) return;
            }
          }
          // باز کردن/بستن از هر جای صفحه
          startX = t.clientX; startY = t.clientY; dx = 0; dy = 0; tracking = true;
          mode = menuIsOpen ? 'close' : 'open';
        }
        function onMove(ev){
          if (!tracking) return;
          const t = ev.touches ? ev.touches[0] : ev;
          dx = t.clientX - startX; dy = t.clientY - startY;
        }
        function onEnd(){
          if (!tracking) return; tracking = false;
          const absX = Math.abs(dx), absY = Math.abs(dy);
          if (absX < Math.max(absY, 8)) return; // حرکت افقی غالب
          if (mode === 'open'){
            // شروع از لبه راست و کشیدن به چپ (dx منفی)
            if (dx <= -OPEN_THRESH) openMenu();
          } else if (mode === 'close'){
            // وقتی باز است، چه روی منو و چه بیرون از آن به راست کشیده شود (dx مثبت)
            if (dx >= OPEN_THRESH) closeMenu();
          }
          mode = '';
        }
        // پشتیبانی از Touch و Mouse/Pointer
        document.addEventListener('touchstart', onStart, { passive: true });
        document.addEventListener('touchmove', onMove, { passive: true });
        document.addEventListener('touchend', onEnd, { passive: true });
        document.addEventListener('pointerdown', onStart, { passive: true });
        document.addEventListener('pointermove', onMove, { passive: true });
        document.addEventListener('pointerup', onEnd, { passive: true });
      })();

      // فیلترها
      const toggleBtn = document.getElementById("toggleFilters");
      const filters   = document.getElementById("advancedFilters");
      toggleBtn?.addEventListener("click", ()=> filters?.classList.toggle("active"));

      const locationToggle = document.getElementById("locationToggle");
      const locationMenu   = document.getElementById("locationMenu");
      locationToggle?.addEventListener("click", ()=> locationMenu?.classList.toggle("active"));
      window.addEventListener("click", (e)=>{
        if (!e.target.closest("#locationMenu")   && !e.target.closest("#locationToggle")) locationMenu?.classList.remove("active");
        if (!e.target.closest("#advancedFilters")&& !e.target.closest("#toggleFilters"))  filters?.classList.remove("active");
      });

      // ثبت Service Worker (PWA) از روت سراسری + Warmup شل
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('{{ url_for("service_worker") }}', { scope: '/' })
          .then(async (reg) => {
            try {
              await navigator.serviceWorker.ready;
              const sw = navigator.serviceWorker.controller || (await (async()=>{
                // اگر کنترلری نیست، تلاش برای ادعا کردن کنترل پس از فعال‌سازی
                try { await reg.update(); } catch {}
                return navigator.serviceWorker.controller;
              })());
              const urls = [];
              // شل مهمان
              urls.push('/','/start','/login','/search');
              // شل اپ در صورت ورود
              if (IS_LOGGED_IN) {
                urls.push('/app');
                urls.push('/api/lands/approved'); // warm API cache
                // شل کامل ثبت آگهی (۴ مرحله)
                urls.push('/lands/add/step1');
                urls.push('/lands/add');
                urls.push('/lands/add/details');
                urls.push('/lands/add/step3');
                // صفحات اصلی کاربر
                urls.push('/notifications');
                urls.push('/favorites');
                urls.push('/profile');
                urls.push('/my-lands');
                urls.push('/settings');
                urls.push('/search');
              } else {
                // صفحات مهم مهمان
                urls.push('/');
                urls.push('/start');
                urls.push('/login');
                urls.push('/search');
              }
              if (sw) sw.postMessage({ type: 'VINOR_WARMUP', urls });
            } catch {}
          })
          .catch(()=>{});
      }

      // PWA First-run Welcome (mobile, standalone, once)
      (function(){
        const WELCOME_KEY = 'vinor_pwa_welcome_shown_v1';
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        try {
          if (!isStandalone || !isMobile) return;
          if (localStorage.getItem(WELCOME_KEY) === '1') return;
          const el = document.getElementById('pwaWelcome');
          const btn = document.getElementById('pwaWelcomeClose');
          if (!el || !btn) return;
          el.classList.remove('hidden');
          const close = () => { el.classList.add('hidden'); localStorage.setItem(WELCOME_KEY, '1'); };
          btn.addEventListener('click', close, { passive: true });
          setTimeout(close, 3500); // auto-hide after a short delay
        } catch(e){}
      })();

      // Prevent copy, context menu and selection globally
      (function(){
        try{
          document.addEventListener('copy', function(e){ e.preventDefault(); }, true);
          document.addEventListener('cut', function(e){ e.preventDefault(); }, true);
          document.addEventListener('contextmenu', function(e){ e.preventDefault(); }, true);
          document.addEventListener('selectstart', function(e){ e.preventDefault(); }, true);
          document.addEventListener('dragstart', function(e){ e.preventDefault(); }, true);
        }catch(_){ }
      })();
    })();
  </script>

  {# ===== Push Helpers (بدون UI) — صفحه‌ها می‌توانند از این توابع استفاده کنند ===== #}
  <script>
    (function(){
      // VAPID Public Key از کانفیگ (تزریق‌شده در context processor)
      const VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY|default('', true) }}";

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
      }

      async function requestPermission() {
        if (!("Notification" in window)) throw new Error("مرورگر شما از اعلان پشتیبانی نمی‌کند.");
        const perm = await Notification.requestPermission();
        if (perm !== "granted") throw new Error("اجازه اعلان داده نشد.");
        return perm;
      }

      async function getRegistration() {
        if (!('serviceWorker' in navigator)) throw new Error("Service Worker پشتیبانی نمی‌شود.");
        const reg = await navigator.serviceWorker.getRegistration('/');
        if (reg) return reg;
        // تلاش برای رجیستر اگر هنوز انجام نشده
        return await navigator.serviceWorker.register('{{ url_for("service_worker") }}', { scope: '/' });
      }

      async function subscribePush() {
        await requestPermission();
        const reg = await getRegistration();
        const existing = await reg.pushManager.getSubscription();
        if (existing) return existing;
        if (!VAPID_PUBLIC_KEY) throw new Error("VAPID_PUBLIC_KEY تنظیم نشده است.");
        const appServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
        return await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
      }

      async function saveSubscription(sub) {
        const res = await fetch("/api/push/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify(sub),
        });
        if (!res.ok) throw new Error("ذخیره اشتراک ناموفق بود.");
        return await res.json();
      }

      async function testPush(payload = { title: "وینور", body: "اعلان تستی فعال شد ✅", url: "/app/notifications" }) {
        const res = await fetch("/api/push/test", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("ارسال تست ناموفق بود.");
        return await res.json();
      }

      // اکسپورت سراسری (بدون آلودگی زیاد)
      window.VinorPush = {
        subscribe: async () => {
          const sub = await subscribePush();
          await saveSubscription(sub);
          return sub;
        },
        test: testPush,
        permission: () => (Notification && Notification.permission) || "default",
        hasSW: () => 'serviceWorker' in navigator,
        vapid: () => VAPID_PUBLIC_KEY
      };

      // پشتیبانی از ایونت سفارشی برای صفحات
      window.addEventListener("vinor:enable-push", async (e) => {
        try {
          await window.VinorPush.subscribe();
          window.dispatchEvent(new CustomEvent("vinor:push-enabled", { detail: { ok: true }}));
        } catch (err) {
          window.dispatchEvent(new CustomEvent("vinor:push-enabled", { detail: { ok: false, error: String(err) }}));
        }
      });

      window.addEventListener("vinor:test-push", async (e) => {
        try {
          await window.VinorPush.test(e.detail || undefined);
          window.dispatchEvent(new CustomEvent("vinor:push-tested", { detail: { ok: true }}));
        } catch (err) {
          window.dispatchEvent(new CustomEvent("vinor:push-tested", { detail: { ok: false, error: String(err) }}));
        }
      });

      // تلاش خودکار برای ثبت پوش اگر قبلاً اجازه داده شده و سابسکرایب نداریم
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          if (!('serviceWorker' in navigator)) return;
          const perm = (Notification && Notification.permission) || 'default';
          if (perm === 'granted' && VAPID_PUBLIC_KEY) {
            const reg = await navigator.serviceWorker.getRegistration('/');
            if (reg) {
              const existing = await reg.pushManager.getSubscription();
              if (!existing) {
                try { const sub = await subscribePush(); await saveSubscription(sub); } catch(_){}
              }
            }
          }
        } catch(_){}
      });
    })();
  </script>

  <!-- نوار فعال‌سازی اعلان (فقط وقتی اجازه داده نشده/ثبت نشده) -->
  <div id="pushEnableBar" class="fixed bottom-4 right-4 z-40 hidden sm:flex items-center gap-2 px-3 py-2 rounded-xl border bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 shadow">
    <i class="fas fa-bell text-amber-500"></i>
    <span class="text-sm">اعلان‌ها را فعال کنید</span>
    <button id="pushEnableBtn" class="px-2 py-1 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">فعال‌سازی</button>
  </div>

  <script>
    (function(){
      async function shouldShowBar(){
        try{
          if (!('serviceWorker' in navigator) || !('Notification' in window)) return false;
          if (Notification.permission === 'denied') return false;
          const reg = await navigator.serviceWorker.getRegistration('/');
          if (!reg) return true;
          const sub = await reg.pushManager.getSubscription();
          return !sub;
        }catch(_) { return false; }
      }
      document.addEventListener('DOMContentLoaded', async ()=>{
        const bar = document.getElementById('pushEnableBar');
        const btn = document.getElementById('pushEnableBtn');
        if (!bar || !btn) return;
        if (await shouldShowBar()) bar.classList.remove('hidden');
        btn.addEventListener('click', async ()=>{
          try{
            const perm = await Notification.requestPermission();
            if (perm !== 'granted') { bar.classList.add('hidden'); return; }
            if (window.VinorPush) await window.VinorPush.subscribe();
          }catch(_){} finally { bar.classList.add('hidden'); }
        });
      });
    })();
  </script>

  <script>
    (function(){
      try {
        if (navigator.serviceWorker) {
          navigator.serviceWorker.addEventListener('message', (e) => {
            const data = e.data || {};
            if (data && data.type === 'PUSH_RECEIVED') {
              try {
                const el = document.getElementById('notifySound');
                if (el) {
                  el.play().catch(()=>{});
                }
              } catch (_) {}
            }
          });
        }
      } catch (_) {}
    })();
  </script>

  <!-- Hidden audio for notification sound (preloaded/unlocked on first gesture) -->
  <audio id="notifySound" src="{{ url_for('static', filename='sounds/notify.mp3') }}" preload="auto" style="display:none"></audio>

  <script>
    (function(){
      let unlocked = false;
      function markUnlocked(){
        try { localStorage.setItem('vinor_audio_unlocked','1'); } catch(_){}
        unlocked = true;
      }
      function unlockAudio(){
        if (unlocked) return;
        const el = document.getElementById('notifySound');
        if (!el) return;
        try {
          el.muted = true;
          const p = el.play();
          if (p && typeof p.then === 'function'){
            p.then(()=>{ try { el.pause(); el.currentTime = 0; el.muted = false; markUnlocked(); detach(); } catch(_){ markUnlocked(); detach(); } })
             .catch(()=>{});
          } else {
            // Older browsers
            markUnlocked();
            detach();
          }
        } catch(_){}
      }
      function detach(){
        window.removeEventListener('click', unlockAudio, true);
        window.removeEventListener('touchstart', unlockAudio, true);
        window.removeEventListener('keydown', unlockAudio, true);
      }
      // Try auto unlock if previously allowed
      try { if (localStorage.getItem('vinor_audio_unlocked') === '1') unlockAudio(); } catch(_){}
      // Ensure unlock on first user gesture
      window.addEventListener('click', unlockAudio, true);
      window.addEventListener('touchstart', unlockAudio, true);
      window.addEventListener('keydown', unlockAudio, true);
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
