{% extends "base.html" %}

{% block title %}âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢Ú¯Ù‡ÛŒ | Ø§Ù…Ù„Ø§Ú© Ø¢Ø³Ù…Ø§Ù† Ú¯Ø±Ù…Ø§Ø¨Ø³Ø±Ø¯{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8">
  <h2 class="text-2xl font-bold text-green-700 mb-6">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢Ú¯Ù‡ÛŒ</h2>

  <form method="POST" enctype="multipart/form-data" id="editForm" class="space-y-6 bg-white dark:bg-gray-800 p-6 rounded-xl shadow" novalidate>
    {% if csrf_token %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% endif %}

    <!-- Ø¹Ù†ÙˆØ§Ù† -->
    <div>
      <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ*</label>
      <input type="text" name="title" id="title" value="{{ land.title }}"
             class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:ring focus:ring-green-200 dark:bg-gray-700 dark:text-white"
             required maxlength="120" autocomplete="off" inputmode="text">
    </div>

    <!-- Ù…ÙˆÙ‚Ø¹ÛŒØª -->
    <div>
      <label for="location" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª*</label>
      <input type="text" name="location" id="location" value="{{ land.location }}"
             class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:ring focus:ring-green-200 dark:bg-gray-700 dark:text-white"
             required autocomplete="off">
    </div>

    <!-- Ù…ØªØ±Ø§Ú˜ -->
    <div>
      <label for="size" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">ğŸ“ Ù…ØªØ±Ø§Ú˜ (Ù…ØªØ±)*</label>
      <input type="number" name="size" id="size" value="{{ land.size }}"
             class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:ring focus:ring-green-200 dark:bg-gray-700 dark:text-white"
             required inputmode="numeric" min="1">
    </div>

    <!-- ØªØµØ§ÙˆÛŒØ±: Dropzone + Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ -->
    <section aria-label="ØªØµØ§ÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">ğŸ“· ØªØµØ§ÙˆÛŒØ±</label>

      <div class="flex items-center gap-2">
        <label id="dropzone"
               class="flex-1 cursor-pointer flex items-center justify-center border-dashed border-2 border-green-500 rounded-lg p-3 text-green-700 hover:bg-green-50 dark:hover:bg-green-900 transition"
               title="ØªØµØ§ÙˆÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯">
          <i class="fas fa-upload text-lg ml-2"></i>
          Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ±
          <input type="file" id="imagesInput" accept="image/*" multiple class="hidden" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§ÙˆÛŒØ±">
        </label>
        <button type="button" id="clearImages" class="px-3 py-2 text-xs border rounded hover:bg-gray-50 dark:hover:bg-gray-700">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
      </div>

      <p class="text-[11px] text-gray-500 mt-1">
        Ø­Ø¯Ø§Ú©Ø«Ø± Û±Û° ØªØµÙˆÛŒØ±Ø› Ù‚Ø§Ø¨Ù„ Ø¬Ø§Ø¨Ù‡â€ŒØ¬Ø§ÛŒÛŒ Ø¨Ø§ Drag & DropØ› Ø¨Ø§ â­ ØªØµÙˆÛŒØ± Ú©Ø§ÙˆØ± Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.
      </p>

      <div id="upload-status" class="text-sm text-green-600 mt-2 hidden" role="status" aria-live="polite">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¢Ù¾Ù„ÙˆØ¯ ØªØµØ§ÙˆÛŒØ±...</div>
      <div id="progress-container" class="w-full h-2 bg-gray-200 rounded overflow-hidden hidden mt-2" aria-hidden="true">
        <div id="progress-bar" class="h-full bg-green-500" style="width:0%"></div>
      </div>

      <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØ±Ú©ÛŒØ¨ÛŒ (Ù‚Ø¯ÛŒÙ…ÛŒ + Ø¬Ø¯ÛŒØ¯) -->
      <div id="preview-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-3" aria-live="polite" aria-label="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµØ§ÙˆÛŒØ±"></div>

      <!-- ÙˆØ¶Ø¹ÛŒØª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ -->
      <div class="mt-2 text-xs text-gray-600 dark:text-gray-300">
        Ø¯Ø± ØµÙˆØ±Øª Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯ØŒ ØªØµØ§ÙˆÛŒØ± Ù‚Ø¨Ù„ÛŒ Ù‚Ø§Ø¨Ù„ Ø­Ø°Ù/Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ùˆ ØªØ±ØªÛŒØ¨â€ŒØ¯Ù‡ÛŒ Ù…Ø¬Ø¯Ø¯ Ù‡Ø³ØªÙ†Ø¯.
      </div>

      <!-- ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù¾Ù†Ù‡Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ú©â€ŒØ§Ù†Ø¯ -->
      <input type="hidden" name="images_order"   id="images_order">   <!-- ØªØ±ØªÛŒØ¨ Ù†Ù‡Ø§ÛŒÛŒ (Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒØ§ÛŒØ¯Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ) -->
      <input type="hidden" name="cover_index"    id="cover_index">    <!-- Ø§ÛŒÙ†Ø¯Ú©Ø³ Ú©Ø§ÙˆØ± Ø¯Ø± Ø¢Ø±Ø§ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ -->
      <input type="hidden" name="uploaded_ids"   id="uploaded_ids">   <!-- Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±ÛŒ ØªØµØ§ÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯ -->
      <input type="hidden" name="existing_paths" id="existing_paths"> <!-- Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (Ù…Ø±ØªØ¨â€ŒØ´Ø¯Ù‡) -->
      <input type="hidden" name="deleted_paths"  id="deleted_paths">  <!-- Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø­Ø°Ùâ€ŒØ´Ø¯Ù‡ -->
    </section>

    <!-- ØªØµØ§ÙˆÛŒØ± Ù‚Ø¨Ù„ÛŒ (Server) - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø±ÙØ±Ù†Ø³ Ø§ÙˆÙ„ÛŒÙ‡Ø› Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØµÙ„ÛŒ Ø¨Ø§ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ -->
    {% if land.images %}
      <template id="tmpl-existing-images">
        {% for path in land.images %}
          <span data-existing-path="{{ path|e }}"></span>
        {% endfor %}
      </template>
    {% endif %}

    <!-- Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª -->
    <div>
      <button type="submit" id="btnSubmit"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition">
        ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
      </button>
    </div>
  </form>
</div>

<!-- Ù„Ø§ÛŒÙ‡ Ø§Ø±Ø³Ø§Ù„ -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-[1px] hidden z-50">
  <div class="min-h-full w-full flex items-center justify-center p-6">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 w-64 text-center">
      <i class="fas fa-spinner fa-spin text-3xl text-green-600 mb-3"></i>
      <p class="text-sm text-gray-700 dark:text-gray-200">Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...</p>
      <p class="text-[11px] text-gray-500 mt-1">Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ù†Ø¨Ù†Ø¯ÛŒØ¯</p>
    </div>
  </div>
</div>

<style>
  .thumb{position:relative}
  .thumb .cover{position:absolute;top:.25rem;left:.25rem;background:#111827;color:#fff;font-size:10px;border-radius:999px;padding:.15rem .4rem;opacity:.9}
  .thumb.dragging{opacity:.6;transform:scale(.98)}
  .thumb .remove{position:absolute;top:.25rem;right:.25rem;background:#ef4444;color:#fff;border-radius:999px;font-size:11px;padding:.1rem .35rem}
  .thumb .star{position:absolute;bottom:.25rem;left:.25rem;background:#f59e0b;color:#111;border-radius:999px;font-size:12px;padding:.05rem .35rem}
  .thumb .badge{position:absolute;bottom:.25rem;right:.25rem;background:#e5e7eb;color:#111;border-radius:999px;font-size:11px;padding:.05rem .4rem}
  .thumb .spinner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.25);color:#fff;font-size:12px}
  #dropzone.dragover{background:rgba(16,185,129,.08)}
</style>

<script>
(() => {
  /* =========================[ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ]========================= */
  const CONFIG = Object.freeze({
    UPLOAD_URL: '/api/uploads/images',
    MAX_FILES: 10,
    MAX_FILE_SIZE_MB: 12,
    SAVE_KEY: 'adEditDraft:{{ land.id or "unknown" }}'
  });

  /* =======================[ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª DOM ]====================== */
  const form              = document.getElementById('editForm');
  const titleInput        = document.getElementById('title');
  const locationInput     = document.getElementById('location');
  const sizeInput         = document.getElementById('size');

  const dropzone          = document.getElementById('dropzone');
  const imagesInput       = document.getElementById('imagesInput');
  const clearBtn          = document.getElementById('clearImages');

  const previewContainer  = document.getElementById('preview-container');
  const uploadStatus      = document.getElementById('upload-status');
  const progressContainer = document.getElementById('progress-container');
  const progressBar       = document.getElementById('progress-bar');

  const imagesOrderInput  = document.getElementById('images_order');
  const coverIndexInput   = document.getElementById('cover_index');
  const uploadedIdsInput  = document.getElementById('uploaded_ids');
  const existingPathsInput= document.getElementById('existing_paths');
  const deletedPathsInput = document.getElementById('deleted_paths');

  const overlay           = document.getElementById('loadingOverlay');
  const submitBtn         = document.getElementById('btnSubmit');

  /* =======================[ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ ]=========================== */
  const numfmt = new Intl.NumberFormat('fa-IR');
  const formatNumber = (n)=> n ? numfmt.format(n) : '';
  function parseNumber(str){
    if(!str) return 0;
    const persian='Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
    const en = String(str).replace(/[Û°-Û¹]/g,d=>String(persian.indexOf(d))).replace(/[^\d]/g,'');
    return Number(en || 0);
  }
  function getCsrf(){
    const meta = document.querySelector('meta[name="csrf-token"]');
    if(meta?.content) return meta.content;
    const hidden = document.querySelector('input[name="csrf_token"]');
    return hidden ? hidden.value : null;
  }
  const debounce = (fn,t=400)=>{ let id=null; return (...a)=>{ clearTimeout(id); id=setTimeout(()=>fn(...a),t);} };

  /* =======================[ ÙˆØ¶Ø¹ÛŒØª ØªØµØ§ÙˆÛŒØ± ]====================== */
  // unified list = existing + new
  // { id, url, isCover, serverId(null for existing), uploading(false), kind: 'existing'|'new', existingPath? }
  let items = [];
  let totalUploads = 0, doneUploads = 0;
  let deletedExisting = new Set();

  const cryptoRandom = () => (self.crypto||window.crypto).getRandomValues(new Uint32Array(1))[0].toString(16);
  const fileToDataURL = (file)=> new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); });
  function compressImage(file, maxW=1600, quality=0.82){
    return new Promise((res,rej)=>{
      const img = new Image();
      img.onload = ()=>{
        const scale=Math.min(1, maxW/img.width);
        const c=document.createElement('canvas');
        c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        c.toBlob(b=> b ? res(new File([b],'img.jpg',{type:'image/jpeg'})) : rej(new Error('Compression failed')),'image/jpeg',quality);
      };
      img.onerror=()=>rej(new Error('Invalid image'));
      img.src = URL.createObjectURL(file);
    });
  }

  function render(){
    previewContainer.innerHTML = '';
    items.forEach((it,idx)=>{
      const card = document.createElement('div');
      card.className='thumb border rounded overflow-hidden';
      card.draggable = true; card.dataset.id = it.id; card.setAttribute('aria-label','ØªØµÙˆÛŒØ± '+(idx+1));

      const img = document.createElement('img');
      img.src = it.url;
      img.className = 'w-full h-32 object-cover';
      img.alt = 'ØªØµÙˆÛŒØ± Ø¢Ú¯Ù‡ÛŒ';

      // remove
      const rm = document.createElement('button');
      rm.type='button'; rm.className='remove'; rm.title='Ø­Ø°Ù ØªØµÙˆÛŒØ±'; rm.innerHTML='<i class="fas fa-times"></i>';
      rm.addEventListener('click', ()=>{
        if(it.kind==='existing' && it.existingPath){ deletedExisting.add(it.existingPath); }
        items = items.filter(x=>x.id!==it.id);
        // Ø§Ú¯Ø± Ú©Ø§ÙˆØ± Ø­Ø°Ù Ø´Ø¯ØŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ú©Ø§ÙˆØ± Ø´ÙˆØ¯
        if(it.isCover && items[0]) items[0].isCover = true;
        render(); syncHidden();
      });

      // cover star
      const star = document.createElement('button');
      star.type='button'; star.className='star'; star.title='Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ú©Ø§ÙˆØ±';
      star.innerHTML = it.isCover ? 'â­' : 'â˜†';
      star.addEventListener('click', ()=>{
        items.forEach(x=>x.isCover=false); it.isCover=true;
        render(); syncHidden();
      });

      // drag
      card.addEventListener('dragstart', ev=>{ card.classList.add('dragging'); ev.dataTransfer.setData('text/plain', it.id); });
      card.addEventListener('dragend',   ()=> card.classList.remove('dragging'));
      card.addEventListener('dragover',  ev=>ev.preventDefault());
      card.addEventListener('drop', ev=>{
        ev.preventDefault();
        const fromId = ev.dataTransfer.getData('text/plain');
        if(fromId===it.id) return;
        const fromIdx = items.findIndex(x=>x.id===fromId);
        const toIdx   = items.findIndex(x=>x.id===it.id);
        const [moved] = items.splice(fromIdx,1);
        items.splice(toIdx,0,moved);
        render(); syncHidden();
      });

      // badges
      const badge = document.createElement('span');
      badge.className='badge';
      badge.textContent = it.kind==='existing' ? 'Ù‚Ø¯ÛŒÙ…ÛŒ' : 'Ø¬Ø¯ÛŒØ¯';

      card.append(img, rm, star, badge);

      if(it.uploading){
        const sp=document.createElement('div');
        sp.className='spinner';
        sp.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯...';
        card.appendChild(sp);
      }
      if(it.isCover){
        const lab=document.createElement('span');
        lab.className='cover'; lab.textContent='Ú©Ø§ÙˆØ±';
        card.appendChild(lab);
      }

      previewContainer.appendChild(card);
    });
  }

  function syncHidden(){
    imagesOrderInput.value   = items.map(x=>x.id).join(',');
    coverIndexInput.value    = items.findIndex(x=>x.isCover);
    uploadedIdsInput.value   = items.filter(x=>x.kind==='new').map(x=>x.serverId||'').join(',');
    const remainingExisting  = items.filter(x=>x.kind==='existing' && x.existingPath).map(x=>x.existingPath);
    existingPathsInput.value = remainingExisting.join(',');
    deletedPathsInput.value  = Array.from(deletedExisting).filter(p=>!remainingExisting.includes(p)).join(',');
  }

  function validateFile(f){
    if(!f.type.startsWith('image/')){ toast('ÙÙ‚Ø· ÙØ§ÛŒÙ„ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¬Ø§Ø² Ø§Ø³Øª'); return false; }
    if(f.size > CONFIG.MAX_FILE_SIZE_MB*1024*1024){ toast('Ø­Ø¬Ù… Ù‡Ø± ØªØµÙˆÛŒØ± Ø­Ø¯Ø§Ú©Ø«Ø± '+CONFIG.MAX_FILE_SIZE_MB+' Ù…Ú¯Ø§Ø¨Ø§ÛŒØª'); return false; }
    return true;
  }

  function updateGlobalProgress(){
    const total = Math.max(totalUploads, 1);
    const percent = Math.round((doneUploads/total)*100);
    progressBar.style.width = percent+'%';
    if (doneUploads >= total){
      setTimeout(()=>{ progressContainer.classList.add('hidden'); uploadStatus.classList.add('hidden'); }, 600);
    } else {
      progressContainer.classList.remove('hidden');
      uploadStatus.classList.remove('hidden');
    }
  }

  async function uploadOne(file){
    const fd = new FormData();
    fd.append('file', file, 'image.jpg');
    const csrf = getCsrf();
    const headers = {};
    if(csrf){
      headers['X-CSRF-Token'] = csrf;
      headers['X-CSRFToken']  = csrf;
      headers['X-XSRF-TOKEN'] = csrf;
    }
    const resp = await fetch(CONFIG.UPLOAD_URL, { method:'POST', headers, body:fd, credentials:'same-origin' });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const data = await resp.json();
    return data.id || data.file_id || data.uuid || null;
  }

  clearBtn.addEventListener('click', ()=>{
    // Ø­Ø°Ù Ù‡Ù…Ù‡ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ (Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒÙ‡Ø§ Ù‡Ù… Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)
    items.forEach(it=>{ if(it.kind==='existing' && it.existingPath) deletedExisting.add(it.existingPath); });
    items = []; totalUploads=0; doneUploads=0;
    render(); updateGlobalProgress(); syncHidden();
    imagesInput.value='';
  });

  async function handleFiles(files){
    const arr = Array.from(files||[]);
    if(!arr.length) return;

    if(arr.length + items.length > CONFIG.MAX_FILES){
      toast('Ø­Ø¯Ø§Ú©Ø«Ø± '+CONFIG.MAX_FILES+' ØªØµÙˆÛŒØ± Ù…Ø¬Ø§Ø² Ø§Ø³Øª'); return;
    }

    uploadStatus.classList.remove('hidden');
    progressContainer.classList.remove('hidden');

    totalUploads += arr.length;
    updateGlobalProgress();

    const tasks = arr.map(async (f)=>{
      if(!validateFile(f)){ doneUploads++; updateGlobalProgress(); return; }
      try{
        const compressed = await compressImage(f, 1600, 0.82);
        const url = await fileToDataURL(compressed);
        const it = { id: cryptoRandom(), url, isCover:false, serverId:null, uploading:true, kind:'new' };
        items.push(it);
        if(!items.some(x=>x.isCover)) it.isCover = true;
        render(); syncHidden();

        try{
          const serverId = await uploadOne(compressed);
          it.serverId = serverId;
        }catch(err){
          console.error(err); toast('Ø¢Ù¾Ù„ÙˆØ¯ ÛŒÚ© ØªØµÙˆÛŒØ± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
        }finally{
          it.uploading = false; doneUploads++;
          render(); updateGlobalProgress(); syncHidden();
        }
      }catch(e){
        console.error(e);
        doneUploads++; updateGlobalProgress();
        toast('Ù¾Ø±Ø¯Ø§Ø²Ø´ ÛŒÚ© ØªØµÙˆÛŒØ± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
      }
    });

    await Promise.all(tasks);
    uploadStatus.textContent = items.filter(x=>x.kind==='new').every(x=>x.serverId) ? 'Ù‡Ù…Ù‡ ØªØµØ§ÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù†Ø¯' : 'Ø¨Ø±Ø®ÛŒ ØªØµØ§ÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù†Ø¯';
  }

  imagesInput.addEventListener('change', (e)=>handleFiles(e.target.files));
  ['dragenter','dragover'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{ e.preventDefault(); dropzone.classList.add('dragover'); });
  });
  ['dragleave','drop'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{ e.preventDefault(); dropzone.classList.remove('dragover'); });
  });
  dropzone.addEventListener('drop', e=>{
    e.preventDefault();
    const dt=e.dataTransfer;
    if(dt?.files) handleFiles(dt.files);
  });

  /* ============ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµØ§ÙˆÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø² Ù‚Ø§Ù„Ø¨ (Ø§Ú¯Ø± Ù‡Ø³Øª) ============ */
  (function initExisting(){
    const tpl = document.getElementById('tmpl-existing-images');
    if(!tpl) return;
    const spans = tpl.content.querySelectorAll('span[data-existing-path]');
    spans.forEach((el, idx)=>{
      const p = el.getAttribute('data-existing-path');
      const url = "{{ url_for('static', filename='__PATH__') }}".replace('__PATH__', p);
      items.push({
        id: 'ex_'+idx+'_'+cryptoRandom(),
        url, isCover: idx===0, serverId: null, uploading:false, kind:'existing', existingPath: p
      });
    });
    render(); syncHidden();
  })();

  /* ===================== Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³ LocalStorage ===================== */
  function saveDraft(){
    const obj = {
      title: titleInput.value || '',
      location: locationInput.value || '',
      size: sizeInput.value || '',
      // ÙÙ‚Ø· Ù…ØªØ§Ø¯ÛŒØªØ§ÛŒ ØªØµØ§ÙˆÛŒØ± (Ù†Ù‡ ÙØ§ÛŒÙ„ Ø®Ø§Ù…)
      _images_meta: items.map(x=>({
        id:x.id, url:x.url, isCover:x.isCover, serverId:x.serverId,
        kind:x.kind, existingPath:x.existingPath || null, uploading: !!x.uploading
      })),
      _deleted_existing: Array.from(deletedExisting)
    };
    try { localStorage.setItem(CONFIG.SAVE_KEY, JSON.stringify(obj)); } catch(_){}
  }
  function loadDraft(){
    const raw = localStorage.getItem(CONFIG.SAVE_KEY); if(!raw) return;
    try{
      const obj = JSON.parse(raw);
      titleInput.value    = obj.title || titleInput.value;
      locationInput.value = obj.location || locationInput.value;
      sizeInput.value     = obj.size || sizeInput.value;

      if(Array.isArray(obj._images_meta) && obj._images_meta.length){
        items = obj._images_meta.map(m=>({
          id:m.id, url:m.url, isCover:!!m.isCover, serverId:m.serverId||null,
          uploading:false, kind:m.kind, existingPath:m.existingPath||null
        }));
      }
      if(Array.isArray(obj._deleted_existing)){
        deletedExisting = new Set(obj._deleted_existing);
      }
      render(); syncHidden();
    }catch(_){}
  }
  form.addEventListener('input', debounce(saveDraft, 600));
  window.addEventListener('load', loadDraft);

  /* ========================== ØªÙˆØ³Øª Ø³Ø§Ø¯Ù‡ ========================== */
  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    t.className='fixed bottom-20 right-3 bg-gray-900 text-white text-xs px-3 py-2 rounded shadow z-[9999]';
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 1800);
  }

  /* ========================= Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… ========================== */
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    // Ø§Ø¹ØªØ¨Ø§Ø± Ø­Ø¯Ø§Ù‚Ù„ÛŒ
    if(!titleInput.value.trim() || !locationInput.value.trim() || parseNumber(sizeInput.value)<=0){
      toast('Ø¨Ø±Ø®ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ù†Ø§Ù‚Øµ Ø§Ø³Øª'); return;
    }

    // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù†Ù‡Ø§ÛŒÛŒ
    syncHidden();

    // Ù†Ù…Ø§ÛŒØ´ Ù„Ø§ÛŒÙ‡
    overlay.classList.remove('hidden');
    submitBtn.disabled = true;

    try{
      const fd = new FormData(form);
      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ ØªØµØ§ÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø§Ø² input[type=file] Ù„Ø§Ø²Ù… Ù†ÛŒØ³ØªØ› Ù…Ø§ serverId Ù‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒÙØ±Ø³ØªÛŒÙ…
      const resp = await fetch(form.action || window.location.href, { method:'POST', body:fd, credentials:'same-origin' });

      if(resp.redirected){ localStorage.removeItem(CONFIG.SAVE_KEY); window.location.href = resp.url; return; }

      const ct = resp.headers.get('content-type') || '';
      if(ct.includes('application/json')){
        const data = await resp.json();
        if(data.redirect_url){ localStorage.removeItem(CONFIG.SAVE_KEY); window.location.href = data.redirect_url; return; }
        if(data.success && data.location){ localStorage.removeItem(CONFIG.SAVE_KEY); window.location.href = data.location; return; }
        if(data.success){ localStorage.removeItem(CONFIG.SAVE_KEY); toast('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'); setTimeout(()=>location.reload(), 900); return; }
      }

      const loc = resp.headers.get('Location') || resp.headers.get('location');
      if(loc){ localStorage.removeItem(CONFIG.SAVE_KEY); window.location.href = loc; return; }

      if(resp.ok){
        const html = await resp.text();
        if(html && html.trim().length){ localStorage.removeItem(CONFIG.SAVE_KEY); document.open(); document.write(html); document.close(); return; }
      }

      throw new Error('ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
    }catch(err){
      console.error(err);
      overlay.classList.add('hidden');
      submitBtn.disabled = false;
      toast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
    }
  });
})();
</script>
{% endblock %}
