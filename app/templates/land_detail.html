{% set first_img = land.images[0] if land.images else '' %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ land.title }} | Ø§Ù…Ù„Ø§Ú© Ø¢Ø³Ù…Ø§Ù† Ú¯Ø±Ù…Ø§Ø¨Ø³Ø±Ø¯</title>
  <meta name="description" content="Ø¬Ø²Ø¦ÛŒØ§Øª Ø¢Ú¯Ù‡ÛŒ Ø²Ù…ÛŒÙ† {{ land.title }} Ø¯Ø± Ø§Ù…Ù„Ø§Ú© Ø¢Ø³Ù…Ø§Ù† Ú¯Ø±Ù…Ø§Ø¨Ø³Ø±Ø¯" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    body { font-family: 'Vazirmatn', sans-serif; scroll-behavior: smooth; }
    @media (prefers-color-scheme: dark) {
      body { background-color: #1e293b; color: #e2e8f0; }
      header, main, footer { background-color: #0f172a; color: #e2e8f0; }
      a { color: #60a5fa; }
      input, textarea {
        background-color: #1e293b; color: #e2e8f0; border-color: #334155;
      }
      input:focus, textarea:focus {
        border-color: #38bdf8; outline: none;
      }
    }
    .fullscreen-overlay {
      position: fixed; inset: 0; background-color: rgba(0,0,0,0.95);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .fullscreen-overlay img {
      max-width: 100%; max-height: 100%; border-radius: 8px;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-slate-900 dark:text-slate-100">

<!-- Ù‡Ø¯Ø± -->
<header class="bg-white dark:bg-slate-800 shadow p-4 sticky top-0 z-30">
  <div class="max-w-6xl mx-auto flex items-center justify-between gap-4">
    <a href="{{ url_for('main.index') }}" class="sm:hidden text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 text-xl">
      <i class="fas fa-arrow-right"></i>
    </a>
    <div></div>
    <a href="{{ url_for('main.index') }}" class="text-sm text-blue-600 hover:underline hidden sm:inline dark:text-blue-400">
      â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø²Ù…ÛŒÙ†â€ŒÙ‡Ø§
    </a>
    <div class="relative group">
      <a href="{{ url_for('main.favorites') }}" aria-label="Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§">
        <i class="fas fa-heart text-xl text-red-500 hover:text-red-600 transition"></i>
        <span id="fav-count" class="absolute -top-2 -right-2 text-xs bg-red-600 text-white rounded-full px-1.5 py-0.5 hidden">0</span>
      </a>
    </div>
  </div>
</header>

<!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
<main class="max-w-4xl mx-auto mt-6 bg-white rounded-xl shadow p-6 pb-32 dark:bg-slate-800">
  {% if land.images %}
  <div class="mb-6">
    <div class="swiper w-full h-64 sm:h-96 rounded-lg overflow-hidden border shadow">
      <div class="swiper-wrapper">
        {% for img in land.images %}
        <div class="swiper-slide">
          <img
            src="{{ url_for('main.uploaded_file', filename=img.split('/')[-1]) }}"
            data-full="{{ url_for('main.uploaded_file', filename='full/' + img.split('/')[-1]) }}"
            alt="ØªØµÙˆÛŒØ± {{ loop.index }}"
            class="w-full h-64 sm:h-96 object-cover cursor-zoom-in"
            loading="lazy"
            onclick="openFullscreen(this.dataset.full)" />
        </div>
        {% endfor %}
      </div>
      <div class="swiper-button-next text-white"></div>
      <div class="swiper-button-prev text-white"></div>
      <div class="swiper-pagination text-white"></div>
    </div>
  </div>
  <div id="fullscreenOverlay" class="fullscreen-overlay" onclick="closeFullscreen()">
    <img id="fullscreenImage" src="" alt="ØªÙ…Ø§Ù… ØµÙØ­Ù‡">
  </div>
  {% endif %}

  <h2 class="text-xl sm:text-2xl font-bold text-green-700 mb-4 dark:text-green-400">{{ land.title }}</h2>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-700 mb-6 dark:text-gray-300">
    <p>ğŸ“ <strong>Ù…ØªØ±Ø§Ú˜:</strong> {{ "{:,}".format(land.size | int).replace(",", "Ù¬") if land.size else "Ù†Ø§Ù…Ø´Ø®Øµ" }} Ù…ØªØ±</p>
    <p>ğŸ“ <strong>Ù…ÙˆÙ‚Ø¹ÛŒØª:</strong> {{ land.location or "Ù†Ø§Ù…Ø´Ø®Øµ" }}</p>
    <p>ğŸ“„ <strong>Ù†ÙˆØ¹ Ø³Ù†Ø¯:</strong> {{ land.document_type or "Ù†Ø§Ù…Ø´Ø®Øµ" }}</p>
    <p>ğŸ·ï¸ <strong>Ú©Ø¯ Ø¢Ú¯Ù‡ÛŒ:</strong> {{ land.code }}</p>
    <p>ğŸ’° <strong>Ù‚ÛŒÙ…Øª Ú©Ù„:</strong> {{ "{:,}".format(land.price_total | int).replace(",", "Ù¬") if land.price_total else "Ù†Ø§Ù…Ø´Ø®Øµ" }} ØªÙˆÙ…Ø§Ù†</p>
    <p>ğŸ“ <strong>Ù‚ÛŒÙ…Øª Ù…ØªØ±ÛŒ:</strong> {{ "{:,}".format(land.price_per_meter | int).replace(",", "Ù¬") if land.price_per_meter else "Ù†Ø§Ù…Ø´Ø®Øµ" }} ØªÙˆÙ…Ø§Ù†</p>
  </div>

  {% if land.features %}
  <div class="mb-6">
    <p class="font-semibold text-gray-800 mb-2 dark:text-gray-100">Ø§Ù…Ú©Ø§Ù†Ø§Øª:</p>
    <div class="flex flex-wrap gap-2">
      {% for feature in land.features %}
      <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs shadow-sm dark:bg-green-900 dark:text-green-200">
        <i class="fas fa-check-circle ml-1"></i>{{ feature }}
      </span>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="mt-6 whitespace-pre-line text-gray-700 leading-relaxed border-t pt-4 dark:text-gray-300 dark:border-slate-600">
    {{ land.description or "ØªÙˆØ¶ÛŒØ­Ø§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª." }}
  </div>

  <div class="mt-10 hidden sm:flex gap-4">
    <a href="tel:{{ land.owner }}" class="bg-green-600 hover:bg-green-700 text-white text-sm px-6 py-2 rounded-full shadow transition">ğŸ“ ØªÙ…Ø§Ø³</a>
    <button onclick="openPopup()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-6 py-2 rounded-full shadow transition">ğŸ“© Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø´Ø§ÙˆØ±Ù‡</button>
  </div>
</main>

<!-- Ù†ÙˆØ§Ø± ØªÙ…Ø§Ø³ Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
<div class="fixed bottom-0 inset-x-0 z-50 sm:hidden">
  <div class="flex justify-between gap-2 p-3 bg-white dark:bg-slate-900 border-t dark:border-slate-700 shadow-md">
    <a href="tel:{{ land.owner }}" class="flex-1 text-center bg-green-600 hover:bg-green-700 text-white py-2 rounded-full text-sm font-medium">ğŸ“ ØªÙ…Ø§Ø³</a>
    <button onclick="openPopup()" class="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-full text-sm font-medium">ğŸ“© Ø¯Ø±ÛŒØ§ÙØª Ù…Ø´Ø§ÙˆØ±Ù‡</button>
  </div>
</div>

<!-- ÙØ±Ù… Ù…Ø´Ø§ÙˆØ±Ù‡ -->
<div id="popupForm" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
  <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-lg max-w-md w-full">
    <h3 class="text-lg font-semibold text-gray-800 mb-4 dark:text-white">ğŸ“© Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø´Ø§ÙˆØ±Ù‡ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø§ÛŒÙ† Ø²Ù…ÛŒÙ†</h3>
    <form method="post" action="{{ url_for('main.consult', code=land.code) }}" class="space-y-4">
      <div>
        <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Ù†Ø§Ù… Ø´Ù…Ø§</label>
        <input type="text" name="name" required class="w-full border rounded px-3 py-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
      </div>
      <div>
        <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label>
        <input type="tel" name="phone" required class="w-full border rounded px-3 py-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
      </div>
      <div>
        <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Ù¾ÛŒØ§Ù… Ø´Ù…Ø§</label>
        <textarea name="message" rows="3" class="w-full border rounded px-3 py-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></textarea>
      </div>
      <div class="flex justify-between">
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow text-sm">Ø§Ø±Ø³Ø§Ù„</button>
        <button type="button" onclick="closePopup()" class="text-gray-500 hover:text-red-500 text-sm">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </form>
  </div>
</div>

<!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  const swiper = new Swiper('.swiper', {
    loop: true,
    pagination: { el: '.swiper-pagination', clickable: true },
    navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
    spaceBetween: 10, centeredSlides: true,
  });

  function openFullscreen(src) {
    const img = document.getElementById('fullscreenImage');
    img.src = '';
    img.src = src;
    document.getElementById('fullscreenOverlay').style.display = 'flex';
  }
  function closeFullscreen() {
    document.getElementById('fullscreenOverlay').style.display = 'none';
  }
  function openPopup() {
    document.getElementById('popupForm').classList.remove('hidden');
    document.getElementById('popupForm').classList.add('flex');
  }
  function closePopup() {
    document.getElementById('popupForm').classList.add('hidden');
    document.getElementById('popupForm').classList.remove('flex');
  }
  function updateFavoriteCount() {
    const favs = JSON.parse(localStorage.getItem("favoriteLands") || "[]");
    const countEl = document.getElementById("fav-count");
    if (countEl) {
      if (favs.length > 0) {
        countEl.textContent = favs.length;
        countEl.classList.remove("hidden");
      } else {
        countEl.classList.add("hidden");
      }
    }
  }
  document.addEventListener("DOMContentLoaded", function () {
    updateFavoriteCount();
  });
</script>
</body>
</html>
