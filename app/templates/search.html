{# templates/search.html #}
{% extends "base.html" %}
{% set hide_header = False %}
{% block title %}Ø¬Ø³ØªØ¬ÙˆÛŒ Ø²Ù…ÛŒÙ† - Ø³Ø±ÛŒØ¹ Ùˆ Ù‡ÙˆØ´Ù…Ù†Ø¯{% endblock %}

{% block content %}

{# ====== Ù…Ø§Ú©Ø±Ùˆ Ú©Ø§Ø±Øª Ø¢Ú¯Ù‡ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø± ====== #}
{% macro LandCard(land) -%}
  {% set images = land.get('images') or [] %}
  {% set img = images[0] if images else None %}
  <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl shadow-sm overflow-hidden land-card group transition hover:shadow-md" data-code="{{ land.code }}">
    <div class="relative">
      <a href="{{ url_for('main.land_detail', code=land.code) }}">
        {% if img %}
        <img src="{{ url_for('main.uploaded_file', filename=img) }}"
             alt="Ø²Ù…ÛŒÙ† {{ land.title }}"
             class="w-full h-72 sm:h-60 object-cover transition duration-300 group-hover:scale-105" />
        {% else %}
        <div class="w-full h-72 sm:h-60 bg-gray-200 dark:bg-gray-800 flex items-center justify-center text-gray-500 text-base">
          <i class="fas fa-seedling text-2xl text-green-600/70"></i>
        </div>
        {% endif %}
      </a>

      <!-- Ø¯Ú©Ù…Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ -->
      <button type="button" class="absolute top-3 right-3 favorite-btn z-10" data-code="{{ land.code }}" title="Ø°Ø®ÛŒØ±Ù‡ Ø¢Ú¯Ù‡ÛŒ">
        <i class="fas fa-bookmark text-white text-2xl drop-shadow-md"></i>
      </button>
    </div>

    <!-- Ø¨Ø®Ø´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
    <div class="p-4">
      <a href="{{ url_for('main.land_detail', code=land.code) }}">
        <h3 class="text-base font-bold text-gray-900 dark:text-white truncate">{{ land.title }}</h3>
      </a>
      <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
        ğŸ“ {{ land.location or "?" }} | ğŸ“ {{ "{:,}".format(land.size | int) if land.size else "?" }} Ù…ØªØ±
      </p>
      <p class="text-base font-extrabold text-green-700 dark:text-green-400 mt-2">
        ğŸ’° {{ "{:,}".format(land.price_total | int) if land.price_total else "Ù†Ø§Ù…Ø´Ø®Øµ" }} ØªÙˆÙ…Ø§Ù†
      </p>
    </div>
  </div>
{%- endmacro %}

<!-- Ù†ÙˆØ§Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ØªØ§Ø³Ø±ÛŒ Ø²ÛŒØ± Ù‡Ø¯Ø± (Ú†Ø³Ø¨Ø§Ù†) -->
<section class="sticky top-0 z-30 bg-white/90 dark:bg-gray-900/90 backdrop-blur border-b border-gray-200 dark:border-gray-800">
  <div class="max-w-6xl mx-auto px-3 py-3">
    <form id="search-form" method="get" action="{{ url_for('main.search_results') }}" class="flex gap-2">
      <div class="relative flex-1">
        <input type="text" name="q" id="searchInput"
               class="w-full h-11 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-green-600"
               placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ø¯Ø´Øª Ø§ÙˆÙ„ØŒ Ø¬Ù†ÙˆØ¨ÛŒØŒ Ø¨Ø± Ø®ÛŒØ§Ø¨Ø§Ù†ØŒ Ú©Ø¯ Ø¢Ú¯Ù‡ÛŒ Ùˆ ..."
               value="{{ request.args.get('q','') }}"
               oninput="storeSearchQuery(this.value)">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
      </div>

      <details class="group relative">
        <summary class="h-11 cursor-pointer select-none flex items-center px-3 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm hover:bg-gray-50 dark:hover:bg-gray-700">
          <i class="fas fa-sliders-h mr-2"></i> ÙÛŒÙ„ØªØ±
        </summary>
        <div class="absolute left-0 mt-2 w-[92vw] sm:w-[520px] p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 shadow-xl">
          <div class="grid grid-cols-2 gap-3 text-sm">
            <input type="number" inputmode="numeric" name="min_price" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Ù‚ÛŒÙ…Øª"
                   value="{{ request.args.get('min_price','') }}"
                   class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white">
            <input type="number" inputmode="numeric" name="max_price" placeholder="Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚ÛŒÙ…Øª"
                   value="{{ request.args.get('max_price','') }}"
                   class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white">
            <input type="number" inputmode="numeric" name="min_size" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Ù…ØªØ±Ø§Ú˜"
                   value="{{ request.args.get('min_size','') }}"
                   class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white">
            <input type="number" inputmode="numeric" name="max_size" placeholder="Ø­Ø¯Ø§Ú©Ø«Ø± Ù…ØªØ±Ø§Ú˜"
                   value="{{ request.args.get('max_size','') }}"
                   class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white">
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2">
            <select name="sort" class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white text-sm">
              {# sort: newest (default), price_asc, size_desc #}
              {% set s = request.args.get('sort','newest') %}
              <option value="newest" {{ 'selected' if s=='newest' else '' }}>Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
              <option value="price_asc" {{ 'selected' if s=='price_asc' else '' }}>Ø§Ø±Ø²Ø§Ù†â€ŒØªØ±ÛŒÙ†</option>
              <option value="size_desc" {{ 'selected' if s=='size_desc' else '' }}>Ø¨Ø²Ø±Ú¯â€ŒØªØ±ÛŒÙ† Ù…ØªØ±Ø§Ú˜</option>
            </select>

            <button type="button" onclick="clearAllFilters()"
                    class="w-full px-3 py-2 rounded-lg border border-red-300/70 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm">
              Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§
            </button>
          </div>

          <div class="mt-3 flex gap-2">
            <button type="submit"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 rounded-lg text-sm">
              Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
            </button>
          </div>
        </div>
      </details>

      <button type="submit"
              class="h-11 px-4 rounded-xl bg-green-600 hover:bg-green-700 text-white text-sm font-bold">
        Ø¬Ø³ØªØ¬Ùˆ
      </button>
    </form>

    <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¬Ø³ØªØ¬Ùˆ -->
    <div class="mt-2">
      <div class="flex items-center justify-between">
        <span class="text-xs text-gray-500 dark:text-gray-400">ğŸ•“ Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</span>
        <button onclick="clearAllHistory()" class="text-[11px] text-red-500 hover:text-red-700">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
      </div>
      <div id="search-history" class="mt-1 flex flex-wrap gap-2"></div>
    </div>
  </div>
</section>

{# ========================= Ø¨Ø¯Ù†Ù‡ ØµÙØ­Ù‡ ========================= #}
<main class="max-w-6xl mx-auto px-3 py-4">

  {# -------- Ø¨Ø®Ø´ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ (Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø§Ø´ØªÙ† Ù¾Ø±Ø³â€ŒÙˆØ¬Ùˆ) -------- #}
  {% set has_query = request.args.get('q') or request.args.get('min_price') or request.args.get('max_price') or request.args.get('min_size') or request.args.get('max_size') or request.args.get('sort') %}
  {% set results = lands if lands is defined else [] %}
  {% set results_total = results|length %}

  {% if has_query %}
    <div class="mb-3 flex items-center justify-between">
      <h2 class="text-sm font-bold text-gray-800 dark:text-gray-100">
        Ù†ØªÛŒØ¬Ù‡ Ø¬Ø³ØªØ¬Ùˆ {% if results_total>0 %}({{ results_total }}){% endif %}
      </h2>
      {% if request.args.get('sort') %}
        <span class="text-[11px] text-gray-500 dark:text-gray-400">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ:
          {{ 'Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†' if request.args.get('sort')=='newest'
             else 'Ø§Ø±Ø²Ø§Ù†â€ŒØªØ±ÛŒÙ†' if request.args.get('sort')=='price_asc'
             else 'Ø¨Ø²Ø±Ú¯â€ŒØªØ±ÛŒÙ† Ù…ØªØ±Ø§Ú˜' if request.args.get('sort')=='size_desc'
             else 'Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†' }}
        </span>
      {% endif %}
    </div>

    {% if results_total == 0 %}
      <div class="mb-6 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4 text-sm text-yellow-800 dark:text-yellow-200">
        Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø±Ø§ Ø³Ø¨Ú©â€ŒØªØ± Ú©Ù† ÛŒØ§ Ú©Ù„Ù…Ù‡ Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.
      </div>
    {% else %}
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="searchResultsGrid">
        {% for land in results %}
          {{ LandCard(land) }}
        {% endfor %}
      </div>

      {# ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) #}
      {% if pagination %}
        <div class="mt-4 mb-10 flex items-center justify-center gap-2">
          {% if pagination.prev_url %}
            <a href="{{ pagination.prev_url }}" class="px-3 py-1 rounded-lg border dark:border-gray-700">Ù‚Ø¨Ù„ÛŒ</a>
          {% endif %}
          <span class="text-xs text-gray-500 dark:text-gray-400">ØµÙØ­Ù‡ {{ pagination.page }} Ø§Ø² {{ pagination.pages }}</span>
          {% if pagination.next_url %}
            <a href="{{ pagination.next_url }}" class="px-3 py-1 rounded-lg border dark:border-gray-700">Ø¨Ø¹Ø¯ÛŒ</a>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}

    <hr class="my-6 border-gray-200 dark:border-gray-800">
  {% endif %}

  {# --------- Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù…ÛŒ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ (Ù‡Ù…ÛŒØ´Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡) --------- #}
  {% set all_list = all_lands if all_lands is defined else (lands if not has_query else []) %}
  {% set all_total = all_list|length %}

  <div class="mb-2 flex items-center justify-between">
    <h2 class="text-sm font-bold text-gray-800 dark:text-gray-100">
      {% if has_query %}Ù‡Ù…Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§{% else %}Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§{% endif %}
      {% if all_total>0 %} ({{ all_total }}){% endif %}
    </h2>
  </div>

  {% if all_total == 0 and not has_query %}
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4 text-sm text-yellow-800 dark:text-yellow-200">
      Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
    </div>
  {% else %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="landListAll">
      {% for land in all_list %}
        {{ LandCard(land) }}
      {% endfor %}
    </div>

    {# ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ù…Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) #}
    {% if all_pagination %}
      <div class="mt-4 flex items-center justify-center gap-2">
        {% if all_pagination.prev_url %}
          <a href="{{ all_pagination.prev_url }}" class="px-3 py-1 rounded-lg border dark:border-gray-700">Ù‚Ø¨Ù„ÛŒ</a>
        {% endif %}
        <span class="text-xs text-gray-500 dark:text-gray-400">ØµÙØ­Ù‡ {{ all_pagination.page }} Ø§Ø² {{ all_pagination.pages }}</span>
        {% if all_pagination.next_url %}
          <a href="{{ all_pagination.next_url }}" class="px-3 py-1 rounded-lg border dark:border-gray-700">Ø¨Ø¹Ø¯ÛŒ</a>
        {% endif %}
      </div>
    {% endif %}
  {% endif %}

</main>

<script>
// Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ù…Ø´Ø§Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
document.addEventListener("DOMContentLoaded", () => {
  try { localStorage.setItem("allLandsData", JSON.stringify({{ (lands or []) | tojson }})); } catch (e) {}
  const favorites = JSON.parse(localStorage.getItem("favoriteLands") || "[]");
  document.querySelectorAll(".land-card").forEach(card => {
    const code = card.dataset.code;
    const btn = card.querySelector(".favorite-btn");
    if (!btn) return;
    const icon = btn.querySelector("i") || btn;
    const updateHeart = () => {
      const isFav = favorites.includes(code);
      icon.classList.toggle("text-red-500", isFav);
      icon.classList.toggle("text-white", !isFav);
    };
    updateHeart();
    btn.addEventListener("click", e => {
      e.preventDefault();
      const i = favorites.indexOf(code);
      if (i > -1) favorites.splice(i, 1); else favorites.push(code);
      localStorage.setItem("favoriteLands", JSON.stringify(favorites));
      updateHeart();
    });
  });
});

/* =============== ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¬Ø³ØªØ¬Ùˆ (LocalStorage) =============== */
function storeSearchQuery(q) {
  q = (q || "").trim();
  if (!q) return;
  let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  const idx = history.indexOf(q);
  if (idx > -1) { history.splice(idx, 1); }
  history.unshift(q);
  if (history.length > 6) history = history.slice(0, 6);
  localStorage.setItem('searchHistory', JSON.stringify(history));
  renderSearchHistory();
}

function deleteHistoryItem(index) {
  let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  history.splice(index, 1);
  localStorage.setItem('searchHistory', JSON.stringify(history));
  renderSearchHistory();
}

function clearAllHistory() {
  localStorage.removeItem('searchHistory');
  renderSearchHistory();
}

function selectHistoryItem(q) {
  const input = document.getElementById('searchInput');
  input.value = q;
  document.getElementById('search-form').submit();
}

function renderSearchHistory() {
  const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  const container = document.getElementById('search-history');
  container.innerHTML = '';
  if (history.length === 0) {
    container.innerHTML = '<span class="text-gray-400 text-xs">Ù‡ÛŒÚ† Ø¬Ø³ØªØ¬ÙˆÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</span>';
    return;
  }
  history.forEach((item, index) => {
    const chip = document.createElement('span');
    chip.className = "bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-100 px-2.5 py-1 rounded-full text-xs flex items-center gap-2";
    chip.innerHTML = `
      <button class="hover:underline" onclick="selectHistoryItem('${item.replace(/'/g,"\\'")}')">${item}</button>
      <button onclick="deleteHistoryItem(${index})" class="text-red-500 hover:text-red-700 text-xs">&times;</button>
    `;
    container.appendChild(chip);
  });
}
renderSearchHistory();

/* =============== Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§ =============== */
function clearAllFilters() {
  const form = document.getElementById('search-form');
  const keep = ['sort']; // Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø³ÙˆØ±Øª Ø­ÙØ¸ Ø¨Ø´Ù‡
  [...form.querySelectorAll('input[type="text"], input[type="number"]')].forEach(inp => inp.value = '');
  form.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);

  const url = new URL(form.action, window.location.origin);
  keep.forEach(k => {
    const val = (new URLSearchParams(new FormData(form))).get(k);
    if (val) url.searchParams.set(k, val);
  });
  window.location.href = url.toString();
}
</script>

{% endblock %}
