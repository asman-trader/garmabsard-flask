{# templates/search.html #}
{% extends "base.html" %}
{% set hide_header = True %}
{% block title %}Ø¬Ø³ØªØ¬ÙˆÛŒ Ø²Ù…ÛŒÙ† - Ø³Ø±ÛŒØ¹ Ùˆ Ù‡ÙˆØ´Ù…Ù†Ø¯{% endblock %}

{% block content %}

{# ====== Ù…Ø§Ú©Ø±Ùˆ Ú©Ø§Ø±Øª Ø¢Ú¯Ù‡ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø± ====== #}
{% macro LandCard(land) -%}
  {% set images = land.get('images') or [] %}
  {% set img = images[0] if images else None %}
  {% set _city = land.get('city') or (land.get('location') or '').split('-')[0].strip() %}
  <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl shadow-sm overflow-hidden land-card group transition hover:shadow-md"
       data-code="{{ land.code }}"
       data-city="{{ _city|lower }}"
       data-title="{{ (land.title or '')|lower }}"
       data-location="{{ (land.location or '')|lower }}"
       data-desc="{{ (land.description or '')|lower }}"
       data-size="{{ land.size or land.area or 0 }}"
       data-price="{{ land.price_total or land.price or 0 }}">
    <div class="relative">
      <a href="{{ url_for('main.land_detail', code=land.code) }}">
        {% if img %}
        <img src="{{ url_for('main.uploaded_file', filename=img) }}"
             alt="Ø²Ù…ÛŒÙ† {{ land.title }}"
             class="w-full h-72 sm:h-60 object-cover transition duration-300 group-hover:scale-105" />
        {% else %}
        <div class="w-full h-72 sm:h-60 bg-gray-200 dark:bg-gray-800 flex items-center justify-center text-gray-500 text-base">
          <i class="fas fa-seedling text-2xl text-green-600/70"></i>
        </div>
        {% endif %}
      </a>

      <!-- Ø¯Ú©Ù…Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ -->
      <button type="button" class="absolute top-3 right-3 favorite-btn z-10" data-code="{{ land.code }}" title="Ø°Ø®ÛŒØ±Ù‡ Ø¢Ú¯Ù‡ÛŒ">
        <i class="fas fa-bookmark text-white text-2xl drop-shadow-md"></i>
      </button>
    </div>

    <!-- Ø¨Ø®Ø´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
    <div class="p-4">
      <a href="{{ url_for('main.land_detail', code=land.code) }}">
        <h3 class="text-base font-bold text-gray-900 dark:text-white truncate">{{ land.title }}</h3>
      </a>
      <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
        ğŸ“ {{ land.location or "?" }} | ğŸ“ {{ "{:,}".format(land.size | int) if land.size else "?" }} Ù…ØªØ±
      </p>
      <p class="text-base font-extrabold text-green-700 dark:text-green-400 mt-2">
        ğŸ’° {{ "{:,}".format(land.price_total | int) if land.price_total else "Ù†Ø§Ù…Ø´Ø®Øµ" }} ØªÙˆÙ…Ø§Ù†
      </p>
    </div>
  </div>
{%- endmacro %}

<!-- Ù†ÙˆØ§Ø± Ø¬Ø³ØªØ¬Ùˆ Ø¨Ù‡ Ø³Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù… (Ù…ÙˆØ¨Ø§ÛŒÙ„â€ŒÙ…Ø­ÙˆØ±ØŒ Ú†Ø³Ø¨Ø§Ù†) -->
<header class="sticky top-0 z-30 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800">
  <div class="max-w-6xl mx-auto px-3 py-2">
    <form id="search-form" method="get" action="{{ url_for('main.search_results') }}" class="flex items-center gap-2">
      <input type="hidden" name="city" id="cityHidden" value="{{ request.args.get('city','') }}">
      <button type="button" onclick="history.back()" class="w-10 h-10 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª">
        <i class="fas fa-arrow-right"></i>
      </button>
      <button type="button" id="cityChip" class="h-10 px-3 rounded-full border border-gray-300 dark:border-gray-700 dark:bg-gray-800 text-gray-700 dark:text-gray-100 text-xs sm:text-sm flex items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-700">
        <i class="fas fa-map-marker-alt text-green-600"></i>
        <span id="cityChipLabel">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±</span>
      </button>
      <div class="relative flex-1">
        <input type="text" name="q" id="searchInput" class="w-full h-10 rounded-full border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white pl-9 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-green-600" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ø¯Ø´Øª Ø§ÙˆÙ„ØŒ Ø¬Ù†ÙˆØ¨ÛŒØŒ Ø¨Ø± Ø®ÛŒØ§Ø¨Ø§Ù†ØŒ Ú©Ø¯ Ø¢Ú¯Ù‡ÛŒ Ùˆ ..." value="{{ request.args.get('q','') }}" oninput="storeSearchQuery(this.value)">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
      </div>
      <details class="group relative">
        <summary class="w-10 h-10 grid place-items-center rounded-full border border-gray-300 dark:border-gray-700 dark:bg-gray-800 text-gray-700 dark:text-gray-100 cursor-pointer select-none hover:bg-gray-50 dark:hover:bg-gray-700" title="ÙÛŒÙ„ØªØ±">
          <i class="fas fa-sliders-h"></i>
        </summary>
        <div class="absolute right-0 mt-2 w-[92vw] sm:w-[520px] p-4 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 shadow-2xl">
          <div class="grid grid-cols-2 gap-3 text-sm">
            <input type="number" inputmode="numeric" name="min_price" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Ù‚ÛŒÙ…Øª" value="{{ request.args.get('min_price','') }}" class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white">
            <input type="number" inputmode="numeric" name="max_price" placeholder="Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚ÛŒÙ…Øª" value="{{ request.args.get('max_price','') }}" class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white">
            <input type="number" inputmode="numeric" name="min_size" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Ù…ØªØ±Ø§Ú˜" value="{{ request.args.get('min_size','') }}" class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white">
            <input type="number" inputmode="numeric" name="max_size" placeholder="Ø­Ø¯Ø§Ú©Ø«Ø± Ù…ØªØ±Ø§Ú˜" value="{{ request.args.get('max_size','') }}" class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white">
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2">
            <select name="sort" class="w-full px-3 py-2 rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white text-sm">
              {% set s = request.args.get('sort','newest') %}
              <option value="newest" {{ 'selected' if s=='newest' else '' }}>Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
              <option value="price_asc" {{ 'selected' if s=='price_asc' else '' }}>Ø§Ø±Ø²Ø§Ù†â€ŒØªØ±ÛŒÙ†</option>
              <option value="size_desc" {{ 'selected' if s=='size_desc' else '' }}>Ø¨Ø²Ø±Ú¯â€ŒØªØ±ÛŒÙ† Ù…ØªØ±Ø§Ú˜</option>
            </select>
            <button type="button" onclick="clearAllFilters()" class="w-full px-3 py-2 rounded-lg border border-red-300/70 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
          </div>
          <div class="mt-3 flex gap-2">
            <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 rounded-lg text-sm">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
          </div>
        </div>
      </details>
      
    </form>

    <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¬Ø³ØªØ¬Ùˆ (Ø§Ù„Ù‡Ø§Ù… Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù…) -->
    <div class="mt-2">
      <div class="flex items-center justify-between">
        <span class="text-xs text-gray-500 dark:text-gray-400">ğŸ•“ Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</span>
        <button onclick="clearAllHistory()" class="text-[11px] text-red-500 hover:text-red-700">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
      </div>
      <div id="search-history" class="mt-1 flex gap-2 overflow-x-auto no-scrollbar"></div>
    </div>
  </div>
</header>

{# ========================= Ø¨Ø¯Ù†Ù‡ ØµÙØ­Ù‡ ========================= #}
<main class="max-w-6xl mx-auto px-3 pb-24 pt-3">

  {# -------- Ø¨Ø®Ø´ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ (Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø§Ø´ØªÙ† Ù¾Ø±Ø³â€ŒÙˆØ¬Ùˆ) -------- #}
  {# Ù†ØªØ§ÛŒØ¬ Ø²Ù†Ø¯Ù‡: Ø¨Ù‡ ØµÙˆØ±Øª Ú©Ù„Ø§ÛŒÙ†ØªÛŒ Ù†Ù…Ø§ÛŒØ´ Ùˆ ÙÛŒÙ„ØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯ #}
  <div id="liveSummary" class="mb-3 text-xs text-gray-500 dark:text-gray-400"></div>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="searchResultsGrid"></div>

  {# --------- Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù…ÛŒ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ (Ù‡Ù…ÛŒØ´Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡) --------- #}
  {% set all_list = all_lands if all_lands is defined else (lands if not has_query else []) %}
  {% set all_total = all_list|length %}

  <div class="mb-2 flex items-center justify-between">
    <h2 class="text-sm font-bold text-gray-800 dark:text-gray-100">
      {% if has_query %}Ù‡Ù…Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§{% else %}Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§{% endif %}
      {% if all_total>0 %} ({{ all_total }}){% endif %}
    </h2>
  </div>

  {% if all_total == 0 and not has_query %}
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4 text-sm text-yellow-800 dark:text-yellow-200">
      Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
    </div>
  {% else %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="landListAll">
      {% for land in all_list %}
        {{ LandCard(land) }}
      {% endfor %}
    </div>

    {# ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ù…Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) #}
    {% if all_pagination %}
      <div class="mt-4 flex items-center justify-center gap-2">
        {% if all_pagination.prev_url %}
          <a href="{{ all_pagination.prev_url }}" class="px-3 py-1 rounded-lg border dark:border-gray-700">Ù‚Ø¨Ù„ÛŒ</a>
        {% endif %}
        <span class="text-xs text-gray-500 dark:text-gray-400">ØµÙØ­Ù‡ {{ all_pagination.page }} Ø§Ø² {{ all_pagination.pages }}</span>
        {% if all_pagination.next_url %}
          <a href="{{ all_pagination.next_url }}" class="px-3 py-1 rounded-lg border dark:border-gray-700">Ø¨Ø¹Ø¯ÛŒ</a>
        {% endif %}
      </div>
    {% endif %}
  {% endif %}

<!-- Ù†ÙˆØ§Ø± Ø§Ú©Ø´Ù† Ù¾Ø§ÛŒÛŒÙ† (Ù…ÙˆØ¨Ø§ÛŒÙ„â€ŒÙ…Ø­ÙˆØ±) -->
<div class="fixed bottom-0 inset-x-0 z-30 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-t border-gray-200 dark:border-gray-800 px-3 py-2 sm:hidden">
  <div class="max-w-6xl mx-auto flex items-center justify-between gap-2">
    <button class="px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-700 text-sm" onclick="clearAllFilters()">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
    <a href="{{ url_for('main.city_select') }}" class="px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-700 text-sm flex items-center gap-2">
      <i class="fas fa-map-marker-alt text-green-600"></i>
      ØªØºÛŒÛŒØ± Ø´Ù‡Ø±
    </a>
    <button class="px-4 py-2 rounded-xl bg-green-600 text-white text-sm font-bold" onclick="document.getElementById('search-form')?.submit()">Ø§Ø¹Ù…Ø§Ù„</button>
  </div>
</div>

<!-- JSON for lands (safe embed) -->
<script id="lands-json" type="application/json">{{ (lands or []) | tojson }}</script>

</main>

<script>
// Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ù…Ø´Ø§Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
document.addEventListener("DOMContentLoaded", () => {
  try {
    const el = document.getElementById('lands-json');
    const txt = (el && el.textContent) ? el.textContent : '[]';
    localStorage.setItem('allLandsData', txt);
  } catch (e) {}
  const favorites = JSON.parse(localStorage.getItem("favoriteLands") || "[]");
  document.querySelectorAll(".land-card").forEach(card => {
    const code = card.dataset.code;
    const btn = card.querySelector(".favorite-btn");
    if (!btn) return;
    const icon = btn.querySelector("i") || btn;
    const updateHeart = () => {
      const isFav = favorites.includes(code);
      icon.classList.toggle("text-red-500", isFav);
      icon.classList.toggle("text-white", !isFav);
    };
    updateHeart();
    btn.addEventListener("click", e => {
      e.preventDefault();
      const i = favorites.indexOf(code);
      if (i > -1) favorites.splice(i, 1); else favorites.push(code);
      localStorage.setItem("favoriteLands", JSON.stringify(favorites));
      updateHeart();
    });
  });
});

// Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø± Ø¨Ø§ Ø³ÙØ±Ú† Ùˆ Ø§Ø¹Ù…Ø§Ù„ Ø±ÙˆÛŒ ÙØ±Ù…
document.addEventListener('DOMContentLoaded', () => {
  const cityBtn = document.getElementById('cityChip');
  const cityLabel = document.getElementById('cityChipLabel');
  const cityHidden = document.getElementById('cityHidden');
  const form = document.getElementById('search-form');

  function gotoCityPicker() {
    try {
      const url = new URL("{{ url_for('main.city_select') }}", window.location.origin);
      url.searchParams.set('next', window.location.href);
      window.location.href = url.toString();
    } catch (_) {
      window.location.href = "{{ url_for('main.city_select') }}";
    }
  }

  function setCityUIFromStorage() {
    let display = '';
    let hiddenVal = '';
    try {
      const obj = JSON.parse(localStorage.getItem('vinor_city_obj') || 'null');
      if (obj && typeof obj === 'object') {
        if (Array.isArray(obj.cities) && obj.cities.length > 1) {
          display = `${obj.cities.length} Ø´Ù‡Ø±`;
          hiddenVal = obj.cities.join(',');
        } else if (Array.isArray(obj.cities) && obj.cities.length === 1) {
          display = obj.cities[0];
          hiddenVal = obj.cities[0];
        } else if (obj.province && obj.city) {
          display = obj.city;
          hiddenVal = obj.city;
        } else if (obj.province && obj.allProvince) {
          display = obj.province;
          // Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡ Ø§Ø³ØªØ§Ù†ØŒ cities Ø¯Ø± storage Ø´Ø§Ù…Ù„ Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ø¢Ù† Ø§Ø³ØªØ§Ù† Ø§Ø³Øª
          hiddenVal = (obj.cities || []).join(',');
        } else if (obj.province && !obj.city) {
          display = obj.province;
          hiddenVal = obj.province; // ÙØ§Ù„Ø¨Ú©
        }
      }
    } catch(_) {}

    if (!display) {
      // fallback Ø¨Ù‡ Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø¢Ø¯Ø±Ø³ ÛŒØ§ Ú©Ù„ÛŒØ¯ Ù‚Ø¯ÛŒÙ…ÛŒ
      const qsCity = "{{ (request.args.get('city') or '')|trim }}";
      if (qsCity) { display = qsCity; hiddenVal = qsCity; }
      else {
        const saved = (localStorage.getItem('vinor:selectedCity') || '').split(/[â€Œ,ØŒ]/).map(s=>s.trim()).filter(Boolean)[0] || '';
        if (saved) { display = saved; hiddenVal = saved; }
      }
    }

    if (display) {
      if (cityLabel) cityLabel.textContent = display;
      if (cityHidden) cityHidden.value = hiddenVal;
      cityBtn?.classList.add('border-green-500');
    } else {
      if (cityLabel) cityLabel.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±';
      if (cityHidden) cityHidden.value = '';
      cityBtn?.classList.remove('border-green-500');
    }
  }

  if (cityBtn) {
    cityBtn.addEventListener('click', (e) => { e.preventDefault(); gotoCityPicker(); });
  }

  setCityUIFromStorage();

  // Ø§Ú¯Ø± city Ø¯Ø± Ú©ÙˆØ¦Ø±ÛŒ Ù†Ø¨ÙˆØ¯ ÙˆÙ„ÛŒ Ø¯Ø± storage Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ¯ØŒ ÙØ±Ù… Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
  try {
    const qsHasCity = !!("{{ (request.args.get('city') or '')|trim }}");
    if (!qsHasCity && cityHidden && cityHidden.value) {
      form?.submit();
    }
  } catch(_) {}

  document.addEventListener('vinor:city-changed', () => {
    setCityUIFromStorage();
    form?.submit();
  });
});

/* =============== ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¬Ø³ØªØ¬Ùˆ (LocalStorage) =============== */
function storeSearchQuery(q) {
  q = (q || "").trim();
  if (!q) return;
  let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  const idx = history.indexOf(q);
  if (idx > -1) { history.splice(idx, 1); }
  history.unshift(q);
  if (history.length > 6) history = history.slice(0, 6);
  localStorage.setItem('searchHistory', JSON.stringify(history));
  renderSearchHistory();
}

function deleteHistoryItem(index) {
  let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  history.splice(index, 1);
  localStorage.setItem('searchHistory', JSON.stringify(history));
  renderSearchHistory();
}

function clearAllHistory() {
  localStorage.removeItem('searchHistory');
  renderSearchHistory();
}

function selectHistoryItem(q) {
  const input = document.getElementById('searchInput');
  if (!input) return;
  input.value = q;
  try { storeSearchQuery(q); } catch(_) {}
  if (typeof runLiveSearch === 'function') runLiveSearch();
  input.focus();
}

function renderSearchHistory() {
  const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  const container = document.getElementById('search-history');
  container.innerHTML = '';
  if (history.length === 0) {
    container.innerHTML = '<span class="text-gray-400 text-xs">Ù‡ÛŒÚ† Ø¬Ø³ØªØ¬ÙˆÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</span>';
    return;
  }
  history.forEach((item, index) => {
    const chip = document.createElement('span');
    chip.className = "bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-100 px-2.5 py-1 rounded-full text-xs flex items-center gap-2";
    chip.innerHTML = `
      <button class="hover:underline" onclick="selectHistoryItem('${item.replace(/'/g,"\\'")}')">${item}</button>
      <button onclick="deleteHistoryItem(${index})" class="text-red-500 hover:text-red-700 text-xs">&times;</button>
    `;
    container.appendChild(chip);
  });
}
renderSearchHistory();

// Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± ÙˆØ±ÙˆØ¯ÛŒ (Ø§Ú¯Ø± Ø§Ø² Ù„ÛŒÙ†Ú© Ø¢Ù…Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
try {
  const initQ = (document.getElementById('searchInput')?.value || '').trim();
  if (initQ) storeSearchQuery(initQ);
} catch(_) {}

/* =============== Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§ =============== */
function clearAllFilters() {
  const form = document.getElementById('search-form');
  const keep = ['sort','city']; // Ø´Ù‡Ø± Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø­ÙØ¸ Ø´ÙˆØ¯
  [...form.querySelectorAll('input[type="text"], input[type="number"]')].forEach(inp => inp.value = '');
  form.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);

  const url = new URL(form.action, window.location.origin);
  keep.forEach(k => {
    const val = (new URLSearchParams(new FormData(form))).get(k);
    if (val) url.searchParams.set(k, val);
  });
  window.location.href = url.toString();
}

/* =============== Ù†ØªØ§ÛŒØ¬ Ø²Ù†Ø¯Ù‡ =============== */
let liveTimer;
function runLiveSearch(){
  clearTimeout(liveTimer);
  liveTimer = setTimeout(()=>{
    try{
      const container = document.getElementById('searchResultsGrid');
      const summary = document.getElementById('liveSummary');
      const q = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
      const cityHidden = document.getElementById('cityHidden');
      const cityList = (cityHidden?.value || '').toLowerCase();
      const citySet = new Set(cityList.split(',').map(s=>s.trim()).filter(Boolean));
      const form = document.getElementById('search-form');
      const params = new URLSearchParams(new FormData(form));
      const minPrice = parseInt(params.get('min_price')||'')||0;
      const maxPrice = parseInt(params.get('max_price')||'')||0;
      const minSize  = parseInt(params.get('min_size')||'')||0;
      const maxSize  = parseInt(params.get('max_size')||'')||0;

      let cards = Array.from(document.querySelectorAll('.land-card'));
      if (cards.length === 0){
        const raw = document.getElementById('lands-json')?.textContent || localStorage.getItem('allLandsData') || '[]';
        const lands = JSON.parse(raw);
        const mount = document.getElementById('searchResultsGrid');
        mount.innerHTML = lands.map(l=>`
          <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl shadow-sm overflow-hidden land-card" data-code="${l.code}" data-city="${(l.city || (l.location||'').split('-')[0]).toLowerCase()}" data-title="${(l.title||'').toLowerCase()}" data-location="${(l.location||'').toLowerCase()}" data-desc="${(l.description||'').toLowerCase()}" data-size="${l.size||l.area||0}" data-price="${l.price_total||l.price||0}">
            <a href="/land/${l.code}">
              ${(l.images && l.images.length) ? `<img src="/uploads/${l.images[0]}" class="w-full h-60 object-cover" />` : `<div class=\"w-full h-60 bg-gray-200 dark:bg-gray-800 grid place-items-center\"><i class=\"fas fa-seedling text-2xl text-green-600/70\"></i></div>`}
            </a>
            <div class="p-4">
              <a href="/land/${l.code}"><h3 class="text-base font-bold truncate">${l.title||''}</h3></a>
              <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">ğŸ“ ${l.location||'?'} | ğŸ“ ${(l.size||l.area||'?')} Ù…ØªØ±</p>
              <p class="text-base font-extrabold text-green-700 dark:text-green-400 mt-2">ğŸ’° ${(l.price_total||l.price||'Ù†Ø§Ù…Ø´Ø®Øµ')}</p>
            </div>
          </div>
        `).join('');
        cards = Array.from(document.querySelectorAll('.land-card'));
      }

      const filtered = cards.filter(card=>{
        const title = card.dataset.title || '';
        const loc   = card.dataset.location || '';
        const desc  = card.dataset.desc || '';
        const city  = (card.dataset.city || '').trim();
        const size  = parseInt(card.dataset.size||'0')||0;
        const price = parseInt(card.dataset.price||'0')||0;

        if (q && !(title.includes(q) || loc.includes(q) || desc.includes(q))) return false;
        if (citySet.size>0 && !citySet.has(city)) return false;
        if (minPrice && (!price || price < minPrice)) return false;
        if (maxPrice && (!price || price > maxPrice)) return false;
        if (minSize && size < minSize) return false;
        if (maxSize && size > maxSize) return false;
        return true;
      });

      const total = cards.length;
      const shown = filtered.length;
      cards.forEach(c=>c.style.display='none');
      filtered.forEach(c=>c.style.display='');
      if (summary) summary.textContent = shown ? `${shown} Ù†ØªÛŒØ¬Ù‡ Ø§Ø² ${total}` : 'Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯';
    }catch(e){}
  }, 200);
}

document.getElementById('searchInput')?.addEventListener('input', runLiveSearch);
document.querySelectorAll('#search-form input, #search-form select').forEach(el=>{
  el.addEventListener('change', runLiveSearch);
});

runLiveSearch();
</script>

{% endblock %}

{% block floating_action %}{% endblock %}
