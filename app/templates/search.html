{% extends "base.html" %}
{% block title %}Ø¬Ø³ØªØ¬ÙˆÛŒ Ø²Ù…ÛŒÙ† - Ø³Ø±ÛŒØ¹ Ùˆ Ù‡ÙˆØ´Ù…Ù†Ø¯{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto px-4 mt-10">
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl p-5 space-y-6">

    <!-- Ø¹Ù†ÙˆØ§Ù† -->
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-bold text-gray-800 dark:text-white"><i class="fas fa-search-location text-green-600"></i> Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹</h2>
      <button onclick="clearAllFilters()" class="text-xs text-red-500 hover:text-red-700">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‡Ù…Ù‡ ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
    </div>

    <!-- ÙØ±Ù… -->
    <form id="search-form" method="get" action="{{ url_for('main.search_results') }}" class="space-y-4">
      <!-- ÙÛŒÙ„Ø¯ Ø¬Ø³ØªØ¬Ùˆ -->
      <div class="relative">
        <input type="text" name="q" id="searchInput"
               class="w-full py-3 px-4 text-sm rounded-xl border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
               placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø´Øª Ø§ÙˆÙ„ ÛŒØ§ Ø²Ù…ÛŒÙ† Ø¬Ù†ÙˆØ¨ÛŒ..." value="{{ request.args.get('q', '') }}" oninput="storeSearchQuery(this.value)">
        <i class="fas fa-search absolute right-4 top-3.5 text-gray-400 dark:text-gray-300"></i>
      </div>

      <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
      <details class="group">
        <summary class="cursor-pointer text-sm bg-gray-100 dark:bg-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600">
          âš™ï¸ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ± (Ù‚ÛŒÙ…Øª Ùˆ Ù…ØªØ±Ø§Ú˜)
        </summary>
        <div class="grid grid-cols-2 gap-3 mt-4 text-sm">
          <input type="number" name="min_price" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Ù‚ÛŒÙ…Øª" value="{{ request.args.get('min_price', '') }}"
                 class="w-full px-3 py-2 rounded-md border dark:border-gray-600 dark:bg-gray-600 dark:text-white">
          <input type="number" name="max_price" placeholder="Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚ÛŒÙ…Øª" value="{{ request.args.get('max_price', '') }}"
                 class="w-full px-3 py-2 rounded-md border dark:border-gray-600 dark:bg-gray-600 dark:text-white">
          <input type="number" name="min_size" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Ù…ØªØ±Ø§Ú˜" value="{{ request.args.get('min_size', '') }}"
                 class="w-full px-3 py-2 rounded-md border dark:border-gray-600 dark:bg-gray-600 dark:text-white">
          <input type="number" name="max_size" placeholder="Ø­Ø¯Ø§Ú©Ø«Ø± Ù…ØªØ±Ø§Ú˜" value="{{ request.args.get('max_size', '') }}"
                 class="w-full px-3 py-2 rounded-md border dark:border-gray-600 dark:bg-gray-600 dark:text-white">
        </div>
      </details>

      <!-- Ø¯Ú©Ù…Ù‡ Ø¬Ø³ØªØ¬Ùˆ -->
      <button type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition-all duration-200 hover:scale-[1.01] shadow-md">
        ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†
      </button>
    </form>

    <!-- Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± -->
    <div class="bg-gray-50 dark:bg-gray-900 p-3 rounded-lg mt-4">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-semibold text-gray-800 dark:text-white">ğŸ•“ Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</span>
        <button onclick="clearAllHistory()" class="text-xs text-red-500 hover:text-red-700">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
      </div>
      <div id="search-history" class="flex flex-wrap gap-2 text-sm"></div>
    </div>
  </div>
</div>

<script>
// Ø°Ø®ÛŒØ±Ù‡ Ø¬Ø³ØªØ¬Ùˆ
function storeSearchQuery(q) {
  q = q.trim();
  if (!q) return;
  let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  if (!history.includes(q)) {
    history.unshift(q);
    if (history.length > 5) history = history.slice(0, 5);
    localStorage.setItem('searchHistory', JSON.stringify(history));
    renderSearchHistory();
  }
}

// Ø­Ø°Ù ØªÚ©ÛŒ
function deleteHistoryItem(index) {
  let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  history.splice(index, 1);
  localStorage.setItem('searchHistory', JSON.stringify(history));
  renderSearchHistory();
}

// Ø­Ø°Ù Ù‡Ù…Ù‡
function clearAllHistory() {
  localStorage.removeItem('searchHistory');
  renderSearchHistory();
}

// Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø³Ø§Ø¨Ù‚Ù‡
function selectHistoryItem(q) {
  document.getElementById('searchInput').value = q;
  document.getElementById('search-form').submit();
}

// Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§
function clearAllFilters() {
  document.querySelectorAll('#search-form input').forEach(input => input.value = '');
}

// Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª
function renderSearchHistory() {
  const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  const container = document.getElementById('search-history');
  container.innerHTML = '';
  if (history.length === 0) {
    container.innerHTML = '<span class="text-gray-400 text-xs">Ù‡ÛŒÚ† Ø¬Ø³ØªØ¬ÙˆÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</span>';
    return;
  }
  history.forEach((item, index) => {
    container.innerHTML += `
      <span class="bg-green-100 dark:bg-green-700 text-green-800 dark:text-white px-3 py-1 rounded-full flex items-center gap-2">
        <span class="cursor-pointer hover:underline" onclick="selectHistoryItem('${item}')">${item}</span>
        <button onclick="deleteHistoryItem(${index})" class="text-red-500 hover:text-red-700 text-xs">&times;</button>
      </span>`;
  });
}
renderSearchHistory();
</script>
{% endblock %}
