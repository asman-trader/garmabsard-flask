{% extends "base.html" %}
{% block title %}انتخاب شهر{% endblock %}

{% set hide_header = true %}
{% block content %}
<!-- Fixed Header -->
<div class="fixed top-0 inset-x-0 z-30 bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
  <div class="px-3 sm:px-4 py-3 flex items-center justify-between">
    <button id="btnBack" class="w-10 h-10 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200" aria-label="بازگشت">
      <i class="fas fa-arrow-right"></i>
    </button>
    <h1 id="pageTitle" class="text-base font-bold text-gray-800 dark:text-gray-100">انتخاب موقعیت و شهر</h1>
    <div class="w-10"></div>
  </div>
</div>
<div class="h-14"></div>
<main class="max-w-md sm:max-w-2xl mx-auto px-3 sm:px-4 py-5">
  <!-- Intro for submit-ad flow -->
  <div class="mb-3 rounded-2xl border border-emerald-200 dark:border-emerald-700 bg-emerald-50 dark:bg-emerald-900/20 p-3">
    <div class="flex items-start gap-2">
      <i class="fas fa-location-dot text-emerald-600 mt-0.5"></i>
      <div>
        <div class="text-sm font-bold text-emerald-800 dark:text-emerald-300">قبل از ثبت آگهی</div>
        <div class="text-xs text-emerald-900/80 dark:text-emerald-200/90 mt-0.5">برای ادامه، موقعیت و شهر خود را انتخاب کنید.</div>
      </div>
    </div>
  </div>

  <!-- Quick: All Iran -->
  <div class="mb-3">
    <button id="btnAllIran"
      class="w-full flex items-center justify-center gap-2 py-2 rounded-xl border border-gray-300 dark:border-gray-700
             bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-800 text-green-700 dark:text-green-300 font-bold">
      <i class="fas fa-globe-asia"></i>
      انتخاب کل ایران
    </button>
  </div>

  <!-- Contextual Action: Select Whole Province (shown in city step) -->
  <div id="provAction" class="hidden mb-3">
    <button id="btnAllProvince"
      class="w-full flex items-center justify-center gap-2 py-2 rounded-xl border border-emerald-300 dark:border-emerald-700 bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-800 text-emerald-700 dark:text-emerald-300 font-bold">
      <i class="fas fa-layer-group"></i>
      انتخاب همه شهرهای این استان
    </button>
  </div>

  <!-- Unified Search -->
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow">
    <label id="searchLabel" class="block text-sm text-gray-600 dark:text-gray-300 mb-2">جستجوی استان</label>
    <input id="searchBox" type="text" placeholder="مثلاً تهران، البرز..."
           class="w-full rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 outline-none" />
  </div>

  <!-- List -->
  <section class="mt-3">
    <ul id="listContainer" class="divide-y divide-gray-200 dark:divide-gray-800 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl overflow-hidden">
      <!-- filled by JS -->
    </ul>
  </section>
</main>

<script>
(function() {
  // Keys and events
  const CITY_KEY = 'vinor_city';
  const CITY_OBJ_KEY = 'vinor_city_obj';
  const CITY_SYNC_KEY = 'vinor_city_sync';
  const EVT_NAME = 'vinor:city-changed';

  // UI refs
  const btnBack = document.getElementById('btnBack');
  const btnAllIran = document.getElementById('btnAllIran');
  const provAction = document.getElementById('provAction');
  const btnAllProvince = document.getElementById('btnAllProvince');
  const searchBox = document.getElementById('searchBox');
  const searchLabel = document.getElementById('searchLabel');
  const pageTitle = document.getElementById('pageTitle');
  const listContainer = document.getElementById('listContainer');

  // Data
  const FALLBACK = [
    {"province":"تهران","cities":["تهران","ری","اسلام‌شهر","ورامین","قرچک","شمیرانات","لواسان","میگون","پردیس","بومهن","رودهن","جاجرود","آبعلی","پاکدشت","دماوند","فیروزکوه","گرمابسرد","گیلاوند"]},
    {"province":"البرز","cities":["کرج","فردیس","ساوجبلاغ","نظرآباد","طالقان","اشتهارد","ماهدشت","محمدشهر"]},
    {"province":"اصفهان","cities":["اصفهان","کاشان","نجف‌آباد","شاهین‌شهر","فلاورجان","خمینی‌شهر","زرین‌شهر","مبارکه","کوهپایه"]},
    {"province":"خراسان رضوی","cities":["مشهد","نیشابور","سبزوار","تربت‌حیدریه","قوچان","کلات","گناباد","کاشمر"]},
    {"province":"فارس","cities":["شیراز","کازرون","مرودشت","داراب","فسا","لار","جهرم","نی‌ریز"]},
    {"province":"آذربایجان شرقی","cities":["تبریز","مراغه","مرند","اهر","شبستر","بناب","میانه","سراب"]},
    {"province":"خوزستان","cities":["اهواز","آبادان","خرمشهر","ماهشهر","دزفول","شوشتر","ایذه","بهبهان"]},
    {"province":"گیلان","cities":["رشت","لاهیجان","انزلی","آستانه","لنگرود","رودسر","تالش","فومن","صومعه‌سرا"]},
    {"province":"مازندران","cities":["ساری","آمل","بابلسر","بابل","تنکابن","چالوس","نوشهر","نور","قائم‌شهر"]},
    {"province":"کرمان","cities":["کرمان","رفسنجان","زرند","جیرفت","بم","سیرجان","بردسیر","انار"]}
  ];

  let DATA = [];
  let currentProvince = '';
  let currentCities = [];
  let view = 'province'; // or 'city'

  function goBackSafely(fallbackUrl) {
    try {
      const ref = document.referrer || '';
      const sameOrigin = ref && new URL(ref).origin === location.origin;
      if (sameOrigin) { history.back(); return; }
    } catch(_) {}
    window.location.href = fallbackUrl;
  }

  btnBack.addEventListener('click', (e) => {
    e.preventDefault();
    if (view === 'city') {
      showProvinces();
      return;
    }
    goBackSafely("{{ url_for('main.index') }}");
  });

  async function loadData() {
    try {
      const res = await fetch('/static/data/iran_provinces_cities.json', { cache: 'force-cache' });
      if (!res.ok) throw new Error('no json');
      const json = await res.json();
      if (!Array.isArray(json) || !json.length) throw new Error('bad json');
      DATA = json;
    } catch (e) {
      DATA = FALLBACK;
    }
    ensureDefaultAllIran();
    showProvinces();
  }

  function setCityStorageForAllIran() {
    try {
      localStorage.removeItem(CITY_KEY);
      localStorage.removeItem(CITY_OBJ_KEY);
      document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: 'کل ایران', province: '', cityName: '' } }));
      localStorage.setItem(CITY_SYNC_KEY, Date.now().toString());
    } catch(_) {}
  }

  function setCityStorageForProvince(province, cities) {
    try {
      const allProv = true;
      const citiesForStore = Array.isArray(cities) ? cities.slice() : [];
      localStorage.setItem(CITY_KEY, province);
      localStorage.setItem(CITY_OBJ_KEY, JSON.stringify({ province, city: '', cities: citiesForStore, allProvince: allProv }));
      localStorage.setItem(CITY_SYNC_KEY, Date.now().toString());
      document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: province, province, cityName: '', cities: citiesForStore, allProvince: allProv } }));
    } catch(_) {}
  }

  function setCityStorageForCity(province, city) {
    try {
      localStorage.setItem(CITY_KEY, city);
      localStorage.setItem(CITY_OBJ_KEY, JSON.stringify({ province, city, cities: [city], allProvince: false }));
      localStorage.setItem(CITY_SYNC_KEY, Date.now().toString());
      document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city, province, cityName: city, cities: [city], allProvince: false } }));
    } catch(_) {}
  }

  function ensureDefaultAllIran() {
    try {
      const hasObj = !!localStorage.getItem(CITY_OBJ_KEY);
      const hasLabel = !!localStorage.getItem(CITY_KEY);
      if (!hasObj && !hasLabel) {
        setCityStorageForAllIran();
      }
    } catch(_) {}
  }

  function showProvinces() {
    view = 'province';
    currentProvince = '';
    currentCities = [];
    pageTitle.textContent = 'انتخاب موقعیت و شهر';
    searchLabel.textContent = 'جستجوی استان';
    searchBox.placeholder = 'مثلاً تهران، البرز...';
    searchBox.value = '';
    provAction.classList.add('hidden');
    renderProvinceList('');
  }

  function showCities(province) {
    view = 'city';
    currentProvince = province;
    const row = DATA.find(d => d.province === province);
    currentCities = (row && Array.isArray(row.cities)) ? row.cities.slice().sort((a,b)=>a.localeCompare(b,'fa')) : [];
    pageTitle.textContent = `شهرهای ${province}`;
    searchLabel.textContent = 'جستجوی شهر';
    searchBox.placeholder = 'مثلاً دماوند، رودهن...';
    searchBox.value = '';
    provAction.classList.remove('hidden');
    renderCityList('');
  }

  function renderProvinceList(q) {
    const query = (q||'').trim().toLowerCase();
    const provinces = DATA.map(d => d.province).sort((a,b)=>a.localeCompare(b,'fa'))
      .filter(p => !query || p.toLowerCase().includes(query));
    listContainer.innerHTML = '';
    provinces.forEach(p => {
      const li = document.createElement('li');
      li.innerHTML = `
        <button class="w-full flex items-center justify-between px-3 py-3 hover:bg-green-50 dark:hover:bg-green-800">
          <span class="text-sm">${p}</span>
          <i class="fas fa-chevron-left text-gray-400"></i>
        </button>
      `;
      li.querySelector('button').addEventListener('click', ()=> showCities(p));
      listContainer.appendChild(li);
    });
  }

  function renderCityList(q) {
    const query = (q||'').trim().toLowerCase();
    const items = currentCities.filter(c => !query || c.toLowerCase().includes(query));
    listContainer.innerHTML = '';
    items.forEach(c => {
      const li = document.createElement('li');
      li.innerHTML = `
        <button class="w-full flex items-center justify-between px-3 py-3 hover:bg-green-50 dark:hover:bg-green-800">
          <div class="flex items-center gap-2">
            <i class="fas fa-map-marker-alt text-green-600"></i>
            <span class="text-sm">${c}</span>
          </div>
          <i class="fas fa-check text-transparent"></i>
        </button>
      `;
      li.querySelector('button').addEventListener('click', ()=> {
        setCityStorageForCity(currentProvince, c);
        const next = new URLSearchParams(location.search).get('next');
        if (next) { window.location.href = next; return; }
        goBackSafely("{{ url_for('main.add_land_step1') }}");
      });
      listContainer.appendChild(li);
    });
  }

  // Events
  searchBox.addEventListener('input', ()=>{
    if (view === 'province') renderProvinceList(searchBox.value);
    else renderCityList(searchBox.value);
  });

  btnAllIran.addEventListener('click', (e)=>{
    e.preventDefault();
    setCityStorageForAllIran();
    const next = new URLSearchParams(location.search).get('next');
    if (next) { window.location.href = next; return; }
    goBackSafely("{{ url_for('main.add_land_step1') }}");
  });

  btnAllProvince.addEventListener('click', (e)=>{
    e.preventDefault();
    if (!currentProvince) return;
    setCityStorageForProvince(currentProvince, currentCities);
    const next = new URLSearchParams(location.search).get('next');
    if (next) { window.location.href = next; return; }
    goBackSafely("{{ url_for('main.add_land_step1') }}");
  });

  // Init
  loadData();
})();
</script>
{% endblock %}
