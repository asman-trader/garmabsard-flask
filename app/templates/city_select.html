{% extends "base.html" %}
{% block title %}انتخاب شهر{% endblock %}

{% block content %}
<main class="max-w-md sm:max-w-2xl mx-auto px-3 sm:px-4 py-5">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <button id="btnBack"
            class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300 hover:underline">
      <i class="fas fa-arrow-right"></i> بازگشت
    </button>
    <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100">انتخاب شهر</h1>
    <div></div>
  </div>

  <!-- All Iran quick -->
  <div class="mb-3">
    <button id="btnAllIran"
      class="w-full flex items-center justify-center gap-2 py-2 rounded-xl border border-gray-300 dark:border-gray-700
             bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-800 text-green-700 dark:text-green-300 font-bold">
      <i class="fas fa-globe-asia"></i>
      انتخاب کل ایران
    </button>
  </div>

  <!-- Selected summary chips -->
  <section class="mb-3">
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow">
      <div class="flex items-center justify-between mb-2">
        <label class="block text-sm text-gray-600 dark:text-gray-300">مناطق انتخاب‌شده</label>
        <button id="clearSelections" class="text-xs text-red-600 hover:underline">حذف همه</button>
      </div>
      <div id="selectedChips" class="flex flex-wrap gap-2"></div>
    </div>
  </section>

  <!-- Province & City selectors (Divar-style) -->
  <section class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <!-- Provinces column -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-0 shadow overflow-hidden">
      <div class="px-3 py-2 border-b border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-300">استان‌ها</div>
      <ul id="provinceList" class="max-h-96 overflow-auto divide-y divide-gray-100 dark:divide-gray-700">
        <!-- با اسکریپت پر می‌شود -->
      </ul>
    </div>

    <!-- Cities column -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-0 shadow overflow-hidden">
      <div class="px-3 py-2 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between gap-2">
        <span class="text-sm text-gray-600 dark:text-gray-300">شهرها</span>
        <input id="citySearch" type="text" placeholder="جستجوی شهر در استان فعال"
               class="w-44 sm:w-56 rounded-lg border border-gray-300 dark:border-gray-700 px-2 py-1.5 text-sm dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 outline-none" />
      </div>
      <div class="p-2 border-b border-gray-100 dark:border-gray-700">
        <label class="inline-flex items-center gap-2 text-xs">
          <input id="toggleAllInProvince" type="checkbox" class="rounded border-gray-300 dark:border-gray-700">
          انتخاب همه شهرهای این استان
        </label>
      </div>
      <ul id="cityList" class="max-h-96 overflow-auto divide-y divide-gray-100 dark:divide-gray-700">
        <!-- با اسکریپت پر می‌شود -->
      </ul>
    </div>
  </section>

  

  <!-- Suggested chips -->
  <section class="mt-4">
    <div class="flex flex-wrap gap-2" id="quickChips">
      {% set quick = ['کل ایران','دماوند','گرمابسرد','تهران','پردیس','بومهن','رودهن','گیلاوند','لواسان','فیروزکوه'] %}
      {% for c in quick %}
      <button class="chip px-3 py-1.5 rounded-full border text-sm hover:bg-green-50 dark:hover:bg-green-800"
              data-chip="{{ c }}">{{ c }}</button>
      {% endfor %}
    </div>
  </section>

  

  <!-- Actions -->
  <div class="mt-4 flex items-center justify-between">
    <button id="clearCity" class="text-sm text-red-600 hover:underline">حذف شهر/استان انتخابی</button>
    <label class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
      <input id="rememberCheck" type="checkbox" class="rounded border-gray-300 dark:border-gray-700" checked>
      ذخیره به‌عنوان پیش‌فرض
    </label>
  </div>

  <div class="mt-3 grid grid-cols-2 gap-2">
    <button id="saveBtn"
            class="py-2 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 active:scale-[0.99]">
      ذخیره
    </button>
    <a id="cancelBtn"
       href="{{ url_for('main.index') }}"
       class="py-2 text-center rounded-xl border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800">
      انصراف
    </a>
  </div>
</main>

<script>
(function() {
  // 🔁 هماهنگ با کل پروژه:
  const CITY_KEY = 'vinor_city';               // لیبل قابل نمایش (single)
  const CITY_OBJ_KEY = 'vinor_city_obj';       // آبجکت {province, city} (single)
  const CITY_SYNC_KEY = 'vinor_city_sync';     // برای تریگر تغییرات بین تب‌ها (single)
  const EVT_NAME = 'vinor:city-changed';       // رویداد سفارشی پروژه (single)
  const CITY_MULTI_KEY = 'vinor_cities';       // آرایه‌ای از {province, city}
  const EVT_MULTI = 'vinor:city-multi-changed';

  const provinceList = document.getElementById('provinceList');
  const cityList = document.getElementById('cityList');
  const citySearch = document.getElementById('citySearch');
  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearCity');
  const rememberCheck = document.getElementById('rememberCheck');
  const btnAllIran = document.getElementById('btnAllIran');
  const btnBack = document.getElementById('btnBack');
  const cancelBtn = document.getElementById('cancelBtn');
  const selectedChips = document.getElementById('selectedChips');
  const clearSelections = document.getElementById('clearSelections');
  const toggleAllInProvince = document.getElementById('toggleAllInProvince');

  // برگشت امن به صفحه‌ی قبلی (اگر referrer معتبر باشد)
  function goBackSafely(fallbackUrl) {
    try {
      const ref = document.referrer || '';
      const sameOrigin = ref && new URL(ref).origin === location.origin;
      if (sameOrigin) { history.back(); return; }
    } catch(_) {}
    window.location.href = fallbackUrl;
  }
  btnBack.addEventListener('click', () => goBackSafely("{{ url_for('main.index') }}"));
  cancelBtn.addEventListener('click', (e) => { e.preventDefault(); goBackSafely("{{ url_for('main.index') }}"); });

  // --- بارگذاری دیتاست استان/شهر ---
  const FALLBACK = [
    {"province":"تهران","cities":["تهران","ری","اسلام‌شهر","ورامین","قرچک","شمیرانات","لواسان","میگون","پردیس","بومهن","رودهن","جاجرود","آبعلی","پاکدشت","دماوند","فیروزکوه","گرمابسرد","گیلاوند"]},
    {"province":"البرز","cities":["کرج","فردیس","ساوجبلاغ","نظرآباد","طالقان","اشتهارد","ماهدشت","محمدشهر"]},
    {"province":"اصفهان","cities":["اصفهان","کاشان","نجف‌آباد","شاهین‌شهر","فلاورجان","خمینی‌شهر","زرین‌شهر","مبارکه","کوهپایه"]},
    {"province":"خراسان رضوی","cities":["مشهد","نیشابور","سبزوار","تربت‌حیدریه","قوچان","کلات","گناباد","کاشمر"]},
    {"province":"فارس","cities":["شیراز","کازرون","مرودشت","داراب","فسا","لار","جهرم","نی‌ریز"]},
    {"province":"آذربایجان شرقی","cities":["تبریز","مراغه","مرند","اهر","شبستر","بناب","میانه","سراب"]},
    {"province":"خوزستان","cities":["اهواز","آبادان","خرمشهر","ماهشهر","دزفول","شوشتر","ایذه","بهبهان"]},
    {"province":"گیلان","cities":["رشت","لاهیجان","انزلی","آستانه","لنگرود","رودسر","تالش","فومن","صومعه‌سرا"]},
    {"province":"مازندران","cities":["ساری","آمل","بابلسر","بابل","تنکابن","چالوس","نوشهر","نور","قائم‌شهر"]},
    {"province":"کرمان","cities":["کرمان","رفسنجان","زرند","جیرفت","بم","سیرجان","بردسیر","انار"]}
  ];

  let DATA = [];
  let activeProvince = '';
  let currentCities = [];
  let selected = new Map(); // key: province -> Set of cities ('' means whole province)

  async function loadData() {
    try {
      const res = await fetch("/static/data/iran_provinces_cities.json", {cache: "force-cache"});
      if (!res.ok) throw new Error("no json");
      const json = await res.json();
      if (!Array.isArray(json) || !json.length) throw new Error("bad json");
      DATA = json;
    } catch (e) {
      DATA = FALLBACK;
    }
    populateProvinces();
    initFromStorage();
  }

  function populateProvinces() {
    provinceList.innerHTML = '';
    const provinces = DATA.map(d => d.province).sort((a,b)=>a.localeCompare(b,'fa'));
    for (const p of provinces) {
      const li = document.createElement('li');
      li.className = 'flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-green-50 dark:hover:bg-green-800';
      li.innerHTML = `
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" class="province-check rounded border-gray-300 dark:border-gray-700" data-province="${p}">
          <span>${p}</span>
        </label>
        <i class="fas fa-chevron-left text-gray-400"></i>
      `;
      li.addEventListener('click', (e) => {
        if (!(e.target instanceof HTMLInputElement)) {
          setActiveProvince(p);
        }
      });
      provinceList.appendChild(li);
    }
  }

  function setActiveProvince(province) {
    activeProvince = province;
    const row = DATA.find(d => d.province === province);
    currentCities = row ? (row.cities || []).slice().sort((a,b)=>a.localeCompare(b,'fa')) : [];
    renderCityList();
  }

  function renderCityList() {
    const q = (citySearch.value || '').trim().toLowerCase();
    const items = q ? currentCities.filter(x => x.toLowerCase().includes(q)) : currentCities.slice();
    const selSet = selected.get(activeProvince) || new Set();
    cityList.innerHTML = '';
    for (const name of items) {
      const li = document.createElement('li');
      li.className = 'px-3 py-2 hover:bg-green-50 dark:hover:bg-green-800';
      li.innerHTML = `
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" class="city-check rounded border-gray-300 dark:border-gray-700" data-city="${name}" ${selSet.has(name)?'checked':''}>
          <span>${name}</span>
        </label>
      `;
      const cb = li.querySelector('input');
      cb.addEventListener('change', (e) => {
        toggleCity(activeProvince, name, cb.checked);
      });
      cityList.appendChild(li);
    }
    updateToggleAllState();
  }

  function updateToggleAllState() {
    if (!toggleAllInProvince) return;
    const selSet = selected.get(activeProvince) || new Set();
    const allCount = currentCities.length;
    const checkedCount = [...selSet].filter(c => currentCities.includes(c)).length;
    toggleAllInProvince.checked = allCount > 0 && checkedCount === allCount;
    toggleAllInProvince.indeterminate = checkedCount > 0 && checkedCount < allCount;
  }

  // ذخیره‌سازی
  function setSingleStorageFromMulti() {
    // سازگاری: اگر فقط یکی انتخاب شده باشد، کلیدهای single را نیز بروز کن
    const list = getSelectedList();
    if (list.length === 1) {
      const only = list[0];
      const label = only.city || only.province || 'کل ایران';
      try {
        localStorage.setItem(CITY_KEY, label);
        localStorage.setItem(CITY_OBJ_KEY, JSON.stringify({ province: only.province || '', city: only.city || '' }));
        document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: label, province: only.province || '', cityName: only.city || '' } }));
        localStorage.setItem(CITY_SYNC_KEY, Date.now().toString());
      } catch(_) {}
    } else if (list.length === 0) {
      try {
        localStorage.removeItem(CITY_KEY);
        localStorage.removeItem(CITY_OBJ_KEY);
        document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: '', province: '', cityName: '' } }));
        localStorage.setItem(CITY_SYNC_KEY, Date.now().toString());
      } catch(_) {}
    }
  }

  function saveMultiToStorage() {
    const list = getSelectedList();
    try {
      localStorage.setItem(CITY_MULTI_KEY, JSON.stringify(list));
      document.dispatchEvent(new CustomEvent(EVT_MULTI, { detail: { items: list } }));
    } catch(_) {}
    setSingleStorageFromMulti();
  }

  function clearAllSelections() {
    selected.clear();
    saveMultiToStorage();
    renderCityList();
    renderSelectedChips();
    updateToggleAllState();
  }

  function initFromStorage() {
    // اولویت: چندگانه
    try {
      const arr = JSON.parse(localStorage.getItem(CITY_MULTI_KEY) || '[]');
      if (Array.isArray(arr)) {
        selected.clear();
        for (const it of arr) {
          if (!it || !it.province) continue;
          const set = selected.get(it.province) || new Set();
          if (it.city) set.add(it.city); else set.add('');
          selected.set(it.province, set);
        }
      }
    } catch(_) {}

    // اگر خالی بود، از single پر کن
    if (selected.size === 0) {
      try {
        const obj = JSON.parse(localStorage.getItem(CITY_OBJ_KEY) || 'null');
        if (obj && (obj.province || obj.city)) {
          const set = new Set();
          if (obj.city) set.add(obj.city); else set.add('');
          selected.set(obj.province || '', set);
        }
      } catch(_) {}
    }
    // پیش‌فرض: استان اول لیست را فعال کن
    const firstProvince = (DATA[0] && DATA[0].province) || '';
    setActiveProvince(firstProvince);
    renderSelectedChips();
  }

  // رویدادها
  citySearch.addEventListener('input', () => renderCityList());
  toggleAllInProvince.addEventListener('change', (e) => {
    if (!activeProvince) return;
    const all = new Set(currentCities);
    selected.set(activeProvince, e.target.checked ? all : new Set());
    renderCityList();
    renderSelectedChips();
    saveMultiToStorage();
  });

  // چیپ‌ها (از جمله «کل ایران»)
  document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const name = chip.getAttribute('data-chip') || chip.textContent.trim();
      if (name === 'کل ایران') {
        clearAllSelections();
        saveMultiToStorage();
        goBackSafely("{{ url_for('main.index') }}");
        return;
      }
      // جستجو در کل دیتا برای پیدا کردن استان/شهر
      for (const row of DATA) {
        if (row.cities && row.cities.includes(name)) {
          setActiveProvince(row.province);
          toggleCity(row.province, name, true);
          renderSelectedChips();
          saveMultiToStorage();
          return;
        }
      }
      const asProvince = DATA.find(d => d.province === name);
      if (asProvince) {
        setActiveProvince(asProvince.province);
        toggleProvince(asProvince.province, true);
        renderSelectedChips();
        saveMultiToStorage();
      }
    });
  });

  btnAllIran.addEventListener('click', (e) => {
    e.preventDefault();
    clearAllSelections();
    saveMultiToStorage();
    goBackSafely("{{ url_for('main.index') }}");
  });

  saveBtn.addEventListener('click', (e) => {
    e.preventDefault();
    saveMultiToStorage();
    goBackSafely("{{ url_for('main.index') }}");
  });

  clearBtn.addEventListener('click', (e) => {
    e.preventDefault();
    clearAllSelections();
    saveMultiToStorage();
  });

  // helpers: selection
  function toggleProvince(province, checked) {
    if (!province) return;
    if (checked) {
      selected.set(province, new Set()); // علامت‌گذاری استان (بدون شهر = کل استان)
    } else {
      selected.delete(province);
    }
    renderCityList();
  }

  function toggleCity(province, city, checked) {
    if (!province || !city) return;
    const set = selected.get(province) || new Set();
    if (checked) set.add(city); else set.delete(city);
    selected.set(province, set);
    renderSelectedChips();
    updateToggleAllState();
  }

  function getSelectedList() {
    const out = [];
    for (const [p, set] of selected.entries()) {
      if (set.size === 0 || set.has('')) {
        out.push({ province: p, city: '' });
        continue;
      }
      for (const c of set) out.push({ province: p, city: c });
    }
    return out;
  }

  function renderSelectedChips() {
    selectedChips.innerHTML = '';
    const list = getSelectedList();
    if (list.length === 0) {
      selectedChips.innerHTML = '<span class="text-xs text-gray-400">هیچ موردی انتخاب نشده.</span>';
      return;
    }
    for (const it of list) {
      const label = it.city || `استان ${it.province}`;
      const chip = document.createElement('span');
      chip.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs border border-gray-300 dark:border-gray-700';
      chip.innerHTML = `${label} <button class="text-red-500" title="حذف">&times;</button>`;
      chip.querySelector('button').addEventListener('click', () => {
        if (it.city) toggleCity(it.province, it.city, false); else selected.delete(it.province);
        renderSelectedChips();
        renderCityList();
        saveMultiToStorage();
      });
      selectedChips.appendChild(chip);
    }
  }

  clearSelections.addEventListener('click', (e) => { e.preventDefault(); clearAllSelections(); });

  // شروع
  loadData();
})();
</script>
{% endblock %}
