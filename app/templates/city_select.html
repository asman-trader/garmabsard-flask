{% extends "base.html" %}
{% block title %}Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±{% endblock %}

{% block content %}
<main class="max-w-md sm:max-w-2xl mx-auto px-3 sm:px-4 py-5">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <button id="btnBack"
            class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300 hover:underline">
      <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
    </button>
    <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±</h1>
    <div></div>
  </div>

  <!-- All Iran quick -->
  <div class="mb-3">
    <button id="btnAllIran"
      class="w-full flex items-center justify-center gap-2 py-2 rounded-xl border border-gray-300 dark:border-gray-700
             bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-800 text-green-700 dark:text-green-300 font-bold">
      <i class="fas fa-globe-asia"></i>
      Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„ Ø§ÛŒØ±Ø§Ù†
    </button>
  </div>

  <!-- Selected summary chips -->
  <section class="mb-3">
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow">
      <div class="flex items-center justify-between mb-2">
        <label class="block text-sm text-gray-600 dark:text-gray-300">Ù…Ù†Ø§Ø·Ù‚ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</label>
        <button id="clearSelections" class="text-xs text-red-600 hover:underline">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
      </div>
      <div id="selectedChips" class="flex flex-wrap gap-2"></div>
    </div>
  </section>

  <!-- Province & City selectors (Divar-style) -->
  <section class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <!-- Provinces column -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-0 shadow overflow-hidden">
      <div class="px-3 py-2 border-b border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-300">Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</div>
      <ul id="provinceList" class="max-h-96 overflow-auto divide-y divide-gray-100 dark:divide-gray-700">
        <!-- Ø¨Ø§ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      </ul>
    </div>

    <!-- Cities column -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-0 shadow overflow-hidden">
      <div class="px-3 py-2 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between gap-2">
        <span class="text-sm text-gray-600 dark:text-gray-300">Ø´Ù‡Ø±Ù‡Ø§</span>
        <input id="citySearch" type="text" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù‡Ø± Ø¯Ø± Ø§Ø³ØªØ§Ù† ÙØ¹Ø§Ù„"
               class="w-44 sm:w-56 rounded-lg border border-gray-300 dark:border-gray-700 px-2 py-1.5 text-sm dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 outline-none" />
      </div>
      <div class="p-2 border-b border-gray-100 dark:border-gray-700">
        <label class="inline-flex items-center gap-2 text-xs">
          <input id="toggleAllInProvince" type="checkbox" class="rounded border-gray-300 dark:border-gray-700">
          Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ø§ÛŒÙ† Ø§Ø³ØªØ§Ù†
        </label>
      </div>
      <ul id="cityList" class="max-h-96 overflow-auto divide-y divide-gray-100 dark:divide-gray-700">
        <!-- Ø¨Ø§ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      </ul>
    </div>
  </section>

  

  <!-- Suggested chips -->
  <section class="mt-4">
    <div class="flex flex-wrap gap-2" id="quickChips">
      {% set quick = ['Ú©Ù„ Ø§ÛŒØ±Ø§Ù†','Ø¯Ù…Ø§ÙˆÙ†Ø¯','Ú¯Ø±Ù…Ø§Ø¨Ø³Ø±Ø¯','ØªÙ‡Ø±Ø§Ù†','Ù¾Ø±Ø¯ÛŒØ³','Ø¨ÙˆÙ…Ù‡Ù†','Ø±ÙˆØ¯Ù‡Ù†','Ú¯ÛŒÙ„Ø§ÙˆÙ†Ø¯','Ù„ÙˆØ§Ø³Ø§Ù†','ÙÛŒØ±ÙˆØ²Ú©ÙˆÙ‡'] %}
      {% for c in quick %}
      <button class="chip px-3 py-1.5 rounded-full border text-sm hover:bg-green-50 dark:hover:bg-green-800"
              data-chip="{{ c }}">{{ c }}</button>
      {% endfor %}
    </div>
  </section>

  

  <!-- Actions -->
  <div class="mt-4 flex items-center justify-between">
    <button id="clearCity" class="text-sm text-red-600 hover:underline">Ø­Ø°Ù Ø´Ù‡Ø±/Ø§Ø³ØªØ§Ù† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ</button>
    <label class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
      <input id="rememberCheck" type="checkbox" class="rounded border-gray-300 dark:border-gray-700" checked>
      Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    </label>
  </div>

  <div class="mt-3 grid grid-cols-2 gap-2">
    <button id="saveBtn"
            class="py-2 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 active:scale-[0.99]">
      Ø°Ø®ÛŒØ±Ù‡
    </button>
    <a id="cancelBtn"
       href="{{ url_for('main.index') }}"
       class="py-2 text-center rounded-xl border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800">
      Ø§Ù†ØµØ±Ø§Ù
    </a>
  </div>
</main>

<script>
(function() {
  // ğŸ” Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø¨Ø§ Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡:
  const CITY_KEY = 'vinor_city';               // Ù„ÛŒØ¨Ù„ Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ (single)
  const CITY_OBJ_KEY = 'vinor_city_obj';       // Ø¢Ø¨Ø¬Ú©Øª {province, city} (single)
  const CITY_SYNC_KEY = 'vinor_city_sync';     // Ø¨Ø±Ø§ÛŒ ØªØ±ÛŒÚ¯Ø± ØªØºÛŒÛŒØ±Ø§Øª Ø¨ÛŒÙ† ØªØ¨â€ŒÙ‡Ø§ (single)
  const EVT_NAME = 'vinor:city-changed';       // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ (single)
  const CITY_MULTI_KEY = 'vinor_cities';       // Ø¢Ø±Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² {province, city}
  const EVT_MULTI = 'vinor:city-multi-changed';

  const provinceList = document.getElementById('provinceList');
  const cityList = document.getElementById('cityList');
  const citySearch = document.getElementById('citySearch');
  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearCity');
  const rememberCheck = document.getElementById('rememberCheck');
  const btnAllIran = document.getElementById('btnAllIran');
  const btnBack = document.getElementById('btnBack');
  const cancelBtn = document.getElementById('cancelBtn');
  const selectedChips = document.getElementById('selectedChips');
  const clearSelections = document.getElementById('clearSelections');
  const toggleAllInProvince = document.getElementById('toggleAllInProvince');

  // Ø¨Ø±Ú¯Ø´Øª Ø§Ù…Ù† Ø¨Ù‡ ØµÙØ­Ù‡â€ŒÛŒ Ù‚Ø¨Ù„ÛŒ (Ø§Ú¯Ø± referrer Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯)
  function goBackSafely(fallbackUrl) {
    try {
      const ref = document.referrer || '';
      const sameOrigin = ref && new URL(ref).origin === location.origin;
      if (sameOrigin) { history.back(); return; }
    } catch(_) {}
    window.location.href = fallbackUrl;
  }
  btnBack.addEventListener('click', () => goBackSafely("{{ url_for('main.index') }}"));
  cancelBtn.addEventListener('click', (e) => { e.preventDefault(); goBackSafely("{{ url_for('main.index') }}"); });

  // --- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÛŒØªØ§Ø³Øª Ø§Ø³ØªØ§Ù†/Ø´Ù‡Ø± ---
  const FALLBACK = [
    {"province":"ØªÙ‡Ø±Ø§Ù†","cities":["ØªÙ‡Ø±Ø§Ù†","Ø±ÛŒ","Ø§Ø³Ù„Ø§Ù…â€ŒØ´Ù‡Ø±","ÙˆØ±Ø§Ù…ÛŒÙ†","Ù‚Ø±Ú†Ú©","Ø´Ù…ÛŒØ±Ø§Ù†Ø§Øª","Ù„ÙˆØ§Ø³Ø§Ù†","Ù…ÛŒÚ¯ÙˆÙ†","Ù¾Ø±Ø¯ÛŒØ³","Ø¨ÙˆÙ…Ù‡Ù†","Ø±ÙˆØ¯Ù‡Ù†","Ø¬Ø§Ø¬Ø±ÙˆØ¯","Ø¢Ø¨Ø¹Ù„ÛŒ","Ù¾Ø§Ú©Ø¯Ø´Øª","Ø¯Ù…Ø§ÙˆÙ†Ø¯","ÙÛŒØ±ÙˆØ²Ú©ÙˆÙ‡","Ú¯Ø±Ù…Ø§Ø¨Ø³Ø±Ø¯","Ú¯ÛŒÙ„Ø§ÙˆÙ†Ø¯"]},
    {"province":"Ø§Ù„Ø¨Ø±Ø²","cities":["Ú©Ø±Ø¬","ÙØ±Ø¯ÛŒØ³","Ø³Ø§ÙˆØ¬Ø¨Ù„Ø§Øº","Ù†Ø¸Ø±Ø¢Ø¨Ø§Ø¯","Ø·Ø§Ù„Ù‚Ø§Ù†","Ø§Ø´ØªÙ‡Ø§Ø±Ø¯","Ù…Ø§Ù‡Ø¯Ø´Øª","Ù…Ø­Ù…Ø¯Ø´Ù‡Ø±"]},
    {"province":"Ø§ØµÙÙ‡Ø§Ù†","cities":["Ø§ØµÙÙ‡Ø§Ù†","Ú©Ø§Ø´Ø§Ù†","Ù†Ø¬Ùâ€ŒØ¢Ø¨Ø§Ø¯","Ø´Ø§Ù‡ÛŒÙ†â€ŒØ´Ù‡Ø±","ÙÙ„Ø§ÙˆØ±Ø¬Ø§Ù†","Ø®Ù…ÛŒÙ†ÛŒâ€ŒØ´Ù‡Ø±","Ø²Ø±ÛŒÙ†â€ŒØ´Ù‡Ø±","Ù…Ø¨Ø§Ø±Ú©Ù‡","Ú©ÙˆÙ‡Ù¾Ø§ÛŒÙ‡"]},
    {"province":"Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ","cities":["Ù…Ø´Ù‡Ø¯","Ù†ÛŒØ´Ø§Ø¨ÙˆØ±","Ø³Ø¨Ø²ÙˆØ§Ø±","ØªØ±Ø¨Øªâ€ŒØ­ÛŒØ¯Ø±ÛŒÙ‡","Ù‚ÙˆÚ†Ø§Ù†","Ú©Ù„Ø§Øª","Ú¯Ù†Ø§Ø¨Ø§Ø¯","Ú©Ø§Ø´Ù…Ø±"]},
    {"province":"ÙØ§Ø±Ø³","cities":["Ø´ÛŒØ±Ø§Ø²","Ú©Ø§Ø²Ø±ÙˆÙ†","Ù…Ø±ÙˆØ¯Ø´Øª","Ø¯Ø§Ø±Ø§Ø¨","ÙØ³Ø§","Ù„Ø§Ø±","Ø¬Ù‡Ø±Ù…","Ù†ÛŒâ€ŒØ±ÛŒØ²"]},
    {"province":"Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ","cities":["ØªØ¨Ø±ÛŒØ²","Ù…Ø±Ø§ØºÙ‡","Ù…Ø±Ù†Ø¯","Ø§Ù‡Ø±","Ø´Ø¨Ø³ØªØ±","Ø¨Ù†Ø§Ø¨","Ù…ÛŒØ§Ù†Ù‡","Ø³Ø±Ø§Ø¨"]},
    {"province":"Ø®ÙˆØ²Ø³ØªØ§Ù†","cities":["Ø§Ù‡ÙˆØ§Ø²","Ø¢Ø¨Ø§Ø¯Ø§Ù†","Ø®Ø±Ù…Ø´Ù‡Ø±","Ù…Ø§Ù‡Ø´Ù‡Ø±","Ø¯Ø²ÙÙˆÙ„","Ø´ÙˆØ´ØªØ±","Ø§ÛŒØ°Ù‡","Ø¨Ù‡Ø¨Ù‡Ø§Ù†"]},
    {"province":"Ú¯ÛŒÙ„Ø§Ù†","cities":["Ø±Ø´Øª","Ù„Ø§Ù‡ÛŒØ¬Ø§Ù†","Ø§Ù†Ø²Ù„ÛŒ","Ø¢Ø³ØªØ§Ù†Ù‡","Ù„Ù†Ú¯Ø±ÙˆØ¯","Ø±ÙˆØ¯Ø³Ø±","ØªØ§Ù„Ø´","ÙÙˆÙ…Ù†","ØµÙˆÙ…Ø¹Ù‡â€ŒØ³Ø±Ø§"]},
    {"province":"Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†","cities":["Ø³Ø§Ø±ÛŒ","Ø¢Ù…Ù„","Ø¨Ø§Ø¨Ù„Ø³Ø±","Ø¨Ø§Ø¨Ù„","ØªÙ†Ú©Ø§Ø¨Ù†","Ú†Ø§Ù„ÙˆØ³","Ù†ÙˆØ´Ù‡Ø±","Ù†ÙˆØ±","Ù‚Ø§Ø¦Ù…â€ŒØ´Ù‡Ø±"]},
    {"province":"Ú©Ø±Ù…Ø§Ù†","cities":["Ú©Ø±Ù…Ø§Ù†","Ø±ÙØ³Ù†Ø¬Ø§Ù†","Ø²Ø±Ù†Ø¯","Ø¬ÛŒØ±ÙØª","Ø¨Ù…","Ø³ÛŒØ±Ø¬Ø§Ù†","Ø¨Ø±Ø¯Ø³ÛŒØ±","Ø§Ù†Ø§Ø±"]}
  ];

  let DATA = [];
  let activeProvince = '';
  let currentCities = [];
  let selected = new Map(); // key: province -> Set of cities ('' means whole province)

  async function loadData() {
    try {
      const res = await fetch("/static/data/iran_provinces_cities.json", {cache: "force-cache"});
      if (!res.ok) throw new Error("no json");
      const json = await res.json();
      if (!Array.isArray(json) || !json.length) throw new Error("bad json");
      DATA = json;
    } catch (e) {
      DATA = FALLBACK;
    }
    populateProvinces();
    initFromStorage();
  }

  function populateProvinces() {
    provinceList.innerHTML = '';
    const provinces = DATA.map(d => d.province).sort((a,b)=>a.localeCompare(b,'fa'));
    for (const p of provinces) {
      const li = document.createElement('li');
      li.className = 'flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-green-50 dark:hover:bg-green-800';
      li.innerHTML = `
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" class="province-check rounded border-gray-300 dark:border-gray-700" data-province="${p}">
          <span>${p}</span>
        </label>
        <i class="fas fa-chevron-left text-gray-400"></i>
      `;
      li.addEventListener('click', (e) => {
        if (!(e.target instanceof HTMLInputElement)) {
          setActiveProvince(p);
        }
      });
      provinceList.appendChild(li);
    }
  }

  function setActiveProvince(province) {
    activeProvince = province;
    const row = DATA.find(d => d.province === province);
    currentCities = row ? (row.cities || []).slice().sort((a,b)=>a.localeCompare(b,'fa')) : [];
    renderCityList();
  }

  function renderCityList() {
    const q = (citySearch.value || '').trim().toLowerCase();
    const items = q ? currentCities.filter(x => x.toLowerCase().includes(q)) : currentCities.slice();
    const selSet = selected.get(activeProvince) || new Set();
    cityList.innerHTML = '';
    for (const name of items) {
      const li = document.createElement('li');
      li.className = 'px-3 py-2 hover:bg-green-50 dark:hover:bg-green-800';
      li.innerHTML = `
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" class="city-check rounded border-gray-300 dark:border-gray-700" data-city="${name}" ${selSet.has(name)?'checked':''}>
          <span>${name}</span>
        </label>
      `;
      const cb = li.querySelector('input');
      cb.addEventListener('change', (e) => {
        toggleCity(activeProvince, name, cb.checked);
      });
      cityList.appendChild(li);
    }
    updateToggleAllState();
  }

  function updateToggleAllState() {
    if (!toggleAllInProvince) return;
    const selSet = selected.get(activeProvince) || new Set();
    const allCount = currentCities.length;
    const checkedCount = [...selSet].filter(c => currentCities.includes(c)).length;
    toggleAllInProvince.checked = allCount > 0 && checkedCount === allCount;
    toggleAllInProvince.indeterminate = checkedCount > 0 && checkedCount < allCount;
  }

  // Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ
  function setSingleStorageFromMulti() {
    // Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ: Ø§Ú¯Ø± ÙÙ‚Ø· ÛŒÚ©ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ single Ø±Ø§ Ù†ÛŒØ² Ø¨Ø±ÙˆØ² Ú©Ù†
    const list = getSelectedList();
    if (list.length === 1) {
      const only = list[0];
      const label = only.city || only.province || 'Ú©Ù„ Ø§ÛŒØ±Ø§Ù†';
      try {
        localStorage.setItem(CITY_KEY, label);
        localStorage.setItem(CITY_OBJ_KEY, JSON.stringify({ province: only.province || '', city: only.city || '' }));
        document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: label, province: only.province || '', cityName: only.city || '' } }));
        localStorage.setItem(CITY_SYNC_KEY, Date.now().toString());
      } catch(_) {}
    } else if (list.length === 0) {
      try {
        localStorage.removeItem(CITY_KEY);
        localStorage.removeItem(CITY_OBJ_KEY);
        document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: '', province: '', cityName: '' } }));
        localStorage.setItem(CITY_SYNC_KEY, Date.now().toString());
      } catch(_) {}
    }
  }

  function saveMultiToStorage() {
    const list = getSelectedList();
    try {
      localStorage.setItem(CITY_MULTI_KEY, JSON.stringify(list));
      document.dispatchEvent(new CustomEvent(EVT_MULTI, { detail: { items: list } }));
    } catch(_) {}
    setSingleStorageFromMulti();
  }

  function clearAllSelections() {
    selected.clear();
    saveMultiToStorage();
    renderCityList();
    renderSelectedChips();
    updateToggleAllState();
  }

  function initFromStorage() {
    // Ø§ÙˆÙ„ÙˆÛŒØª: Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡
    try {
      const arr = JSON.parse(localStorage.getItem(CITY_MULTI_KEY) || '[]');
      if (Array.isArray(arr)) {
        selected.clear();
        for (const it of arr) {
          if (!it || !it.province) continue;
          const set = selected.get(it.province) || new Set();
          if (it.city) set.add(it.city); else set.add('');
          selected.set(it.province, set);
        }
      }
    } catch(_) {}

    // Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ø§Ø² single Ù¾Ø± Ú©Ù†
    if (selected.size === 0) {
      try {
        const obj = JSON.parse(localStorage.getItem(CITY_OBJ_KEY) || 'null');
        if (obj && (obj.province || obj.city)) {
          const set = new Set();
          if (obj.city) set.add(obj.city); else set.add('');
          selected.set(obj.province || '', set);
        }
      } catch(_) {}
    }
    // Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø§Ø³ØªØ§Ù† Ø§ÙˆÙ„ Ù„ÛŒØ³Øª Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†
    const firstProvince = (DATA[0] && DATA[0].province) || '';
    setActiveProvince(firstProvince);
    renderSelectedChips();
  }

  // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
  citySearch.addEventListener('input', () => renderCityList());
  toggleAllInProvince.addEventListener('change', (e) => {
    if (!activeProvince) return;
    const all = new Set(currentCities);
    selected.set(activeProvince, e.target.checked ? all : new Set());
    renderCityList();
    renderSelectedChips();
    saveMultiToStorage();
  });

  // Ú†ÛŒÙ¾â€ŒÙ‡Ø§ (Ø§Ø² Ø¬Ù…Ù„Ù‡ Â«Ú©Ù„ Ø§ÛŒØ±Ø§Ù†Â»)
  document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const name = chip.getAttribute('data-chip') || chip.textContent.trim();
      if (name === 'Ú©Ù„ Ø§ÛŒØ±Ø§Ù†') {
        clearAllSelections();
        saveMultiToStorage();
        goBackSafely("{{ url_for('main.index') }}");
        return;
      }
      // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ù„ Ø¯ÛŒØªØ§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ø³ØªØ§Ù†/Ø´Ù‡Ø±
      for (const row of DATA) {
        if (row.cities && row.cities.includes(name)) {
          setActiveProvince(row.province);
          toggleCity(row.province, name, true);
          renderSelectedChips();
          saveMultiToStorage();
          return;
        }
      }
      const asProvince = DATA.find(d => d.province === name);
      if (asProvince) {
        setActiveProvince(asProvince.province);
        toggleProvince(asProvince.province, true);
        renderSelectedChips();
        saveMultiToStorage();
      }
    });
  });

  btnAllIran.addEventListener('click', (e) => {
    e.preventDefault();
    clearAllSelections();
    saveMultiToStorage();
    goBackSafely("{{ url_for('main.index') }}");
  });

  saveBtn.addEventListener('click', (e) => {
    e.preventDefault();
    saveMultiToStorage();
    goBackSafely("{{ url_for('main.index') }}");
  });

  clearBtn.addEventListener('click', (e) => {
    e.preventDefault();
    clearAllSelections();
    saveMultiToStorage();
  });

  // helpers: selection
  function toggleProvince(province, checked) {
    if (!province) return;
    if (checked) {
      selected.set(province, new Set()); // Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ø³ØªØ§Ù† (Ø¨Ø¯ÙˆÙ† Ø´Ù‡Ø± = Ú©Ù„ Ø§Ø³ØªØ§Ù†)
    } else {
      selected.delete(province);
    }
    renderCityList();
  }

  function toggleCity(province, city, checked) {
    if (!province || !city) return;
    const set = selected.get(province) || new Set();
    if (checked) set.add(city); else set.delete(city);
    selected.set(province, set);
    renderSelectedChips();
    updateToggleAllState();
  }

  function getSelectedList() {
    const out = [];
    for (const [p, set] of selected.entries()) {
      if (set.size === 0 || set.has('')) {
        out.push({ province: p, city: '' });
        continue;
      }
      for (const c of set) out.push({ province: p, city: c });
    }
    return out;
  }

  function renderSelectedChips() {
    selectedChips.innerHTML = '';
    const list = getSelectedList();
    if (list.length === 0) {
      selectedChips.innerHTML = '<span class="text-xs text-gray-400">Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡.</span>';
      return;
    }
    for (const it of list) {
      const label = it.city || `Ø§Ø³ØªØ§Ù† ${it.province}`;
      const chip = document.createElement('span');
      chip.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs border border-gray-300 dark:border-gray-700';
      chip.innerHTML = `${label} <button class="text-red-500" title="Ø­Ø°Ù">&times;</button>`;
      chip.querySelector('button').addEventListener('click', () => {
        if (it.city) toggleCity(it.province, it.city, false); else selected.delete(it.province);
        renderSelectedChips();
        renderCityList();
        saveMultiToStorage();
      });
      selectedChips.appendChild(chip);
    }
  }

  clearSelections.addEventListener('click', (e) => { e.preventDefault(); clearAllSelections(); });

  // Ø´Ø±ÙˆØ¹
  loadData();
})();
</script>
{% endblock %}
