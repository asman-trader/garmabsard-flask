{% extends "base.html" %}
{% block title %}ุงูุชุฎุงุจ ุดูุฑ{% endblock %}

{% set hide_header = true %}
{% block content %}
<main class="max-w-md sm:max-w-2xl mx-auto px-3 sm:px-4 py-5">
  <!-- Mobile Page Bar -->
  <div class="sticky top-0 z-20 -mx-3 sm:mx-0 px-3 py-3 mb-3 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
    <button id="btnBack" class="w-10 h-10 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200" aria-label="ุจุงุฒฺฏุดุช">
      <i class="fas fa-arrow-right"></i>
    </button>
    <h1 class="text-base font-bold text-gray-800 dark:text-gray-100">ุงูุชุฎุงุจ ุดูุฑ</h1>
    <div class="w-10"></div>
  </div>

  <!-- All Iran quick -->
  <div class="mb-3">
    <button id="btnAllIran"
      class="w-full flex items-center justify-center gap-2 py-2 rounded-xl border border-gray-300 dark:border-gray-700
             bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-800 text-green-700 dark:text-green-300 font-bold">
      <i class="fas fa-globe-asia"></i>
      ุงูุชุฎุงุจ ฺฉู ุงุฑุงู
    </button>
  </div>

  <!-- Province & City selectors -->
  <section class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow">
      <label class="block text-sm text-gray-600 dark:text-gray-300 mb-2">ุงุณุชุงู</label>
      <select id="provinceSelect"
              class="w-full rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2
                     dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 outline-none">
        <option value="">โ ุงูุชุฎุงุจ ุงุณุชุงู โ</option>
      </select>
    </div>

    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow">
      <label class="block text-sm text-gray-600 dark:text-gray-300 mb-2">ุดูุฑ</label>
      <select id="citySelect" disabled
              class="w-full rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2
                     dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 outline-none">
        <option value="">โ ุงุจุชุฏุง ุงุณุชุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ โ</option>
      </select>
    </div>
  </section>

  <!-- Search in cities of selected province -->
  <div class="mt-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow">
    <label class="block text-sm text-gray-600 dark:text-gray-300 mb-2">ุฌุณุชุฌู ุดูุฑ ุฏุฑ ุงุณุชุงู ุงูุชุฎุงุจโุดุฏู</label>
    <input id="citySearch" type="text" placeholder="ูุซูุงู ุฏูุงููุฏุ ุฑูุฏููุ ููุงุณุงู..."
           class="w-full rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2
                  dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 outline-none" />
  </div>

  <!-- Suggested chips -->
  <section class="mt-3">
    <div class="flex gap-2 overflow-x-auto no-scrollbar whitespace-nowrap" id="quickChips">
      {% set quick = ['ฺฉู ุงุฑุงู','ุฏูุงููุฏ','ฺฏุฑูุงุจุณุฑุฏ','ุชูุฑุงู','ูพุฑุฏุณ','ุจูููู','ุฑูุฏูู','ฺฏูุงููุฏ','ููุงุณุงู','ูุฑูุฒฺฉูู'] %}
      {% for c in quick %}
      <button class="chip px-3 py-2 rounded-full border text-sm bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-800"
              data-chip="{{ c }}">{{ c }}</button>
      {% endfor %}
    </div>
  </section>

  <!-- Results -->
  <section class="mt-4">
    <div class="flex items-center justify-between mb-2">
      <div id="selCount" class="text-xs text-gray-600 dark:text-gray-300">ฐ ุดูุฑ ุงูุชุฎุงุจ ุดุฏู</div>
      <div class="flex items-center gap-2">
        <button id="selectAllInProvince" class="text-sm text-emerald-700 dark:text-emerald-300 hover:underline">ุงูุชุฎุงุจ ููู ุดูุฑูุง ุงุณุชุงู</button>
        <button id="clearSelectedCities" class="text-sm text-gray-600 dark:text-gray-300 hover:underline">ูุบู ุงูุชุฎุงุจ</button>
      </div>
    </div>
    <ul id="cityResults"
        class="divide-y divide-gray-200 dark:divide-gray-800 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl overflow-hidden">
      <!-- ุจุง ุงุณฺฉุฑูพุช ูพุฑ ูโุดูุฏ -->
    </ul>
  </section>

  <!-- Actions -->
  <div class="mt-4 flex items-center justify-between">
    <button id="clearCity" class="text-sm text-red-600 hover:underline">ุญุฐู ุดูุฑ/ุงุณุชุงู ุงูุชุฎุงุจ</button>
    <label class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
      <input id="rememberCheck" type="checkbox" class="rounded border-gray-300 dark:border-gray-700" checked>
      ุฐุฎุฑู ุจูโุนููุงู ูพุดโูุฑุถ
    </label>
  </div>

  <!-- Spacer for bottom bar -->
  <div class="h-20"></div>

  <!-- Bottom Action Bar (mobile) -->
  <div class="fixed bottom-0 inset-x-0 z-30 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-t border-gray-200 dark:border-gray-800 px-3 py-2">
    <div class="max-w-md sm:max-w-2xl mx-auto grid grid-cols-2 gap-2">
      <a id="cancelBtn" href="{{ url_for('main.index') }}" class="py-3 text-center rounded-xl border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800">ุงูุตุฑุงู</a>
      <button id="saveBtn" class="py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 active:scale-[0.99]">ุฐุฎุฑู</button>
    </div>
  </div>
</main>

<script>
(function() {
  // ๐ ููุงููฺฏ ุจุง ฺฉู ูพุฑูฺู:
  const CITY_KEY = 'vinor_city';               // ูุจู ูุงุจู ููุงุด (ูุซูุงู ยซุฏูุงููุฏุ ุชูุฑุงูยป ุง ยซฺฉู ุงุฑุงูยป)
  const CITY_OBJ_KEY = 'vinor_city_obj';       // ุขุจุฌฺฉุช {province, city}
  const CITY_SYNC_KEY = 'vinor_city_sync';     // ุจุฑุง ุชุฑฺฏุฑ ุชุบุฑุงุช ุจู ุชุจโูุง
  const EVT_NAME = 'vinor:city-changed';       // ุฑูุฏุงุฏ ุณูุงุฑุด ูพุฑูฺู

  const provinceSelect = document.getElementById('provinceSelect');
  const citySelect = document.getElementById('citySelect');
  const citySearch = document.getElementById('citySearch');
  const cityResults = document.getElementById('cityResults');
  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearCity');
  const rememberCheck = document.getElementById('rememberCheck');
  const btnAllIran = document.getElementById('btnAllIran');
  const btnBack = document.getElementById('btnBack');
  const cancelBtn = document.getElementById('cancelBtn');
  const btnSelectAll = document.getElementById('selectAllInProvince');
  const btnClearSelected = document.getElementById('clearSelectedCities');
  const selCount = document.getElementById('selCount');

  // ุจุฑฺฏุดุช ุงูู ุจู ุตูุญูโ ูุจู (ุงฺฏุฑ referrer ูุนุชุจุฑ ุจุงุดุฏ)
  function goBackSafely(fallbackUrl) {
    try {
      const ref = document.referrer || '';
      const sameOrigin = ref && new URL(ref).origin === location.origin;
      if (sameOrigin) { history.back(); return; }
    } catch(_) {}
    window.location.href = fallbackUrl;
  }
  btnBack.addEventListener('click', () => goBackSafely("{{ url_for('main.index') }}"));
  cancelBtn.addEventListener('click', (e) => { e.preventDefault(); goBackSafely("{{ url_for('main.index') }}"); });

  // --- ุจุงุฑฺฏุฐุงุฑ ุฏุชุงุณุช ุงุณุชุงู/ุดูุฑ ---
  const FALLBACK = [
    {"province":"ุชูุฑุงู","cities":["ุชูุฑุงู","ุฑ","ุงุณูุงูโุดูุฑ","ูุฑุงูู","ูุฑฺฺฉ","ุดูุฑุงูุงุช","ููุงุณุงู","ูฺฏูู","ูพุฑุฏุณ","ุจูููู","ุฑูุฏูู","ุฌุงุฌุฑูุฏ","ุขุจุนู","ูพุงฺฉุฏุดุช","ุฏูุงููุฏ","ูุฑูุฒฺฉูู","ฺฏุฑูุงุจุณุฑุฏ","ฺฏูุงููุฏ"]},
    {"province":"ุงูุจุฑุฒ","cities":["ฺฉุฑุฌ","ูุฑุฏุณ","ุณุงูุฌุจูุงุบ","ูุธุฑุขุจุงุฏ","ุทุงููุงู","ุงุดุชูุงุฑุฏ","ูุงูุฏุดุช","ูุญูุฏุดูุฑ"]},
    {"province":"ุงุตููุงู","cities":["ุงุตููุงู","ฺฉุงุดุงู","ูุฌูโุขุจุงุฏ","ุดุงููโุดูุฑ","ููุงูุฑุฌุงู","ุฎููโุดูุฑ","ุฒุฑูโุดูุฑ","ูุจุงุฑฺฉู","ฺฉูููพุงู"]},
    {"province":"ุฎุฑุงุณุงู ุฑุถู","cities":["ูุดูุฏ","ูุดุงุจูุฑ","ุณุจุฒูุงุฑ","ุชุฑุจุชโุญุฏุฑู","ููฺุงู","ฺฉูุงุช","ฺฏูุงุจุงุฏ","ฺฉุงุดูุฑ"]},
    {"province":"ูุงุฑุณ","cities":["ุดุฑุงุฒ","ฺฉุงุฒุฑูู","ูุฑูุฏุดุช","ุฏุงุฑุงุจ","ูุณุง","ูุงุฑ","ุฌูุฑู","ูโุฑุฒ"]},
    {"province":"ุขุฐุฑุจุงุฌุงู ุดุฑู","cities":["ุชุจุฑุฒ","ูุฑุงุบู","ูุฑูุฏ","ุงูุฑ","ุดุจุณุชุฑ","ุจูุงุจ","ูุงูู","ุณุฑุงุจ"]},
    {"province":"ุฎูุฒุณุชุงู","cities":["ุงููุงุฒ","ุขุจุงุฏุงู","ุฎุฑูุดูุฑ","ูุงูุดูุฑ","ุฏุฒููู","ุดูุดุชุฑ","ุงุฐู","ุจูุจูุงู"]},
    {"province":"ฺฏูุงู","cities":["ุฑุดุช","ูุงูุฌุงู","ุงูุฒู","ุขุณุชุงูู","ููฺฏุฑูุฏ","ุฑูุฏุณุฑ","ุชุงูุด","ูููู","ุตููุนูโุณุฑุง"]},
    {"province":"ูุงุฒูุฏุฑุงู","cities":["ุณุงุฑ","ุขูู","ุจุงุจูุณุฑ","ุจุงุจู","ุชูฺฉุงุจู","ฺุงููุณ","ููุดูุฑ","ููุฑ","ูุงุฆูโุดูุฑ"]},
    {"province":"ฺฉุฑูุงู","cities":["ฺฉุฑูุงู","ุฑูุณูุฌุงู","ุฒุฑูุฏ","ุฌุฑูุช","ุจู","ุณุฑุฌุงู","ุจุฑุฏุณุฑ","ุงูุงุฑ"]}
  ];

  let DATA = [];
  let currentCities = [];
  let selectedCities = [];

  async function loadData() {
    try {
      const res = await fetch("/static/data/iran_provinces_cities.json", {cache: "force-cache"});
      if (!res.ok) throw new Error("no json");
      const json = await res.json();
      if (!Array.isArray(json) || !json.length) throw new Error("bad json");
      DATA = json;
    } catch (e) {
      DATA = FALLBACK;
    }
    populateProvinces();
    initFromStorage();
  }

  function populateProvinces() {
    provinceSelect.innerHTML = '<option value="">โ ุงูุชุฎุงุจ ุงุณุชุงู โ</option>';
    const provinces = DATA.map(d => d.province).sort((a,b)=>a.localeCompare(b,'fa'));
    for (const p of provinces) {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      provinceSelect.appendChild(opt);
    }
  }

  function populateCities(province) {
    citySelect.disabled = true;
    citySelect.innerHTML = '<option value="">โ ุงุจุชุฏุง ุงุณุชุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ โ</option>';
    currentCities = [];
    selectedCities = [];
    if (!province) { renderResults(citySearch.value); return; }

    const row = DATA.find(d => d.province === province);
    if (!row) { renderResults(citySearch.value); return; }
    currentCities = (row.cities || []).slice().sort((a,b)=>a.localeCompare(b,'fa'));

    citySelect.disabled = false;
    citySelect.innerHTML = '<option value="">โ ุงูุชุฎุงุจ ุดูุฑ โ</option>';
    for (const c of currentCities) {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      citySelect.appendChild(opt);
    }
    // ุจุงุฒุงุจ ุงูุชุฎุงุจโูุง ูุจู
    try {
      const raw = localStorage.getItem(CITY_OBJ_KEY);
      if (raw) {
        const obj = JSON.parse(raw);
        if (obj && obj.province === province && Array.isArray(obj.cities)) {
          selectedCities = obj.cities.filter(x => currentCities.includes(x));
        }
      }
    } catch(_) {}
    renderResults(citySearch.value);
  }

  function renderResults(query) {
    const q = (query || '').trim().toLowerCase();
    let items = currentCities.slice();
    if (q) items = items.filter(x => x.toLowerCase().includes(q));
    if (!provinceSelect.value) items = [];

    cityResults.innerHTML = '';
    items.slice(0, 200).forEach(name => {
      const li = document.createElement('li');
      li.className = 'flex items-center justify-between px-3 py-2 hover:bg-green-50 dark:hover:bg-green-800';
      const checked = selectedCities.includes(name) ? 'checked' : '';
      li.innerHTML = `
        <label class="flex items-center gap-2 w-full cursor-pointer">
          <input type="checkbox" class="city-check rounded border-gray-300 dark:border-gray-600" data-name="${name}" ${checked} />
          <i class="fas fa-map-marker-alt text-green-600"></i>
          <span class="text-sm flex-1">${name}</span>
        </label>
      `;
      li.querySelector('.city-check').addEventListener('change', (e) => {
        const n = e.target.getAttribute('data-name');
        if (e.target.checked) {
          if (!selectedCities.includes(n)) selectedCities.push(n);
        } else {
          selectedCities = selectedCities.filter(x => x !== n);
        }
        updateSelCount();
      });
      cityResults.appendChild(li);
    });
    updateSelCount();
  }

  function updateSelCount(){
    try{
      const n = selectedCities.length || 0;
      const faDigits = n.toString().replace(/[0-9]/g, d => 'ฐฑฒณดตถทธน'[parseInt(d,10)]);
      selCount.textContent = `${faDigits} ุดูุฑ ุงูุชุฎุงุจ ุดุฏู`;
    }catch(_){}
  }

  // ุฐุฎุฑูโุณุงุฒ
  function setCityStorage(province, city) {
    let label = 'ฺฉู ุงุฑุงู';
    if (province && city) label = `${city}`; // ููุท ุดูุฑ ููุงุด ุฏุงุฏู ุดูุฏ
    else if (province && !city) label = `${province}`; // ููุท ูุงู ุงุณุชุงู

    try {
      localStorage.setItem(CITY_KEY, label);
      localStorage.setItem(CITY_OBJ_KEY, JSON.stringify({ province: province || '', city: city || '' }));
      document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: label, province, cityName: city || '' } }));
      localStorage.setItem(CITY_SYNC_KEY, Date.now().toString()); // sync ping
    } catch (_) {}
  }

  function clearCityStorage() {
    try {
      localStorage.removeItem(CITY_KEY);
      localStorage.removeItem(CITY_OBJ_KEY);
      document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: '', province: '', cityName: '' } }));
      localStorage.setItem(CITY_SYNC_KEY, Date.now().toString());
    } catch (_) {}
  }

  function initFromStorage() {
    try {
      const raw = localStorage.getItem(CITY_OBJ_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (obj && obj.province) {
        provinceSelect.value = obj.province;
        populateCities(obj.province);
        if (obj.city) citySelect.value = obj.city;
      }
    } catch (_) {}
  }

  // ุฑูุฏุงุฏูุง
  provinceSelect.addEventListener('change', () => {
    citySearch.value = '';
    populateCities(provinceSelect.value);
  });
  citySearch.addEventListener('input', () => renderResults(citySearch.value));

  // ฺูพโูุง (ุงุฒ ุฌููู ยซฺฉู ุงุฑุงูยป)
  document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const name = chip.getAttribute('data-chip') || chip.textContent.trim();
      if (name === 'ฺฉู ุงุฑุงู') {
        provinceSelect.value = '';
        citySelect.innerHTML = '<option value="">โ ุงุจุชุฏุง ุงุณุชุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ โ</option>';
        citySelect.disabled = true;
        citySearch.value = '';
        cityResults.innerHTML = '';
        if (rememberCheck.checked) setCityStorage('', '');
        else document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: 'ฺฉู ุงุฑุงู' } }));
        goBackSafely("{{ url_for('main.index') }}");
        return;
      }
      // ุฌุณุชุฌู ุฏุฑ ฺฉู ุฏุชุง ุจุฑุง ูพุฏุง ฺฉุฑุฏู ุงุณุชุงู/ุดูุฑ
      if (provinceSelect.value && currentCities.includes(name)) {
        citySelect.value = name; renderResults(name); return;
      }
      for (const row of DATA) {
        if (row.cities && row.cities.includes(name)) {
          provinceSelect.value = row.province;
          populateCities(row.province);
          citySelect.value = name;
          renderResults(name);
          return;
        }
      }
      const asProvince = DATA.find(d => d.province === name);
      if (asProvince) {
        provinceSelect.value = asProvince.province;
        populateCities(asProvince.province);
      }
    });
  });

  btnAllIran.addEventListener('click', (e) => {
    e.preventDefault();
    provinceSelect.value = '';
    citySelect.innerHTML = '<option value="">โ ุงุจุชุฏุง ุงุณุชุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ โ</option>';
    citySelect.disabled = true;
    citySearch.value = '';
    cityResults.innerHTML = '';
    selectedCities = [];
    if (rememberCheck.checked) setCityStorage('', '', [], false);
    else document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: 'ฺฉู ุงุฑุงู' } }));
    goBackSafely("{{ url_for('main.index') }}");
  });

  btnSelectAll.addEventListener('click', (e)=>{
    e.preventDefault();
    if (!provinceSelect.value){ return; }
    selectedCities = currentCities.slice();
    renderResults(citySearch.value);
  });

  btnClearSelected.addEventListener('click', (e)=>{
    e.preventDefault();
    selectedCities = [];
    renderResults(citySearch.value);
  });

  saveBtn.addEventListener('click', (e) => {
    e.preventDefault();
    const p = provinceSelect.value || '';
    const c = citySelect.value || '';
    if (!p && selectedCities.length === 0 && !c) {
      if (rememberCheck.checked) setCityStorage('', '', [], false);
      else document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: 'ฺฉู ุงุฑุงู' } }));
      goBackSafely("{{ url_for('main.index') }}");
      return;
    }
    const effective = selectedCities.length ? selectedCities.slice() : (c ? [c] : []);
    const allProv = (p && ((effective.length === 0) || (currentCities.length>0 && effective.length === currentCities.length)));
    const citiesForStore = allProv ? currentCities.slice() : effective;
    try { localStorage.setItem(CITY_KEY, allProv ? p : (citiesForStore.length>1 ? `${citiesForStore.length} ุดูุฑ` : (citiesForStore[0]||'ฺฉู ุงุฑุงู'))); } catch(_){ }
    try { localStorage.setItem(CITY_OBJ_KEY, JSON.stringify({ province:p, city:c, cities:citiesForStore, allProvince: allProv })); localStorage.setItem(CITY_SYNC_KEY, Date.now().toString()); } catch(_){ }
    document.dispatchEvent(new CustomEvent(EVT_NAME, { detail: { city: allProv ? p : (citiesForStore.length>1 ? `${citiesForStore.length} ุดูุฑ` : (citiesForStore[0]||'ฺฉู ุงุฑุงู')), province: p, cityName: c, cities: citiesForStore, allProvince: allProv } }));
    goBackSafely("{{ url_for('main.index') }}");
  });

  clearBtn.addEventListener('click', (e) => {
    e.preventDefault();
    clearCityStorage();
    provinceSelect.value = '';
    citySelect.innerHTML = '<option value="">โ ุงุจุชุฏุง ุงุณุชุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ โ</option>';
    citySelect.disabled = true;
    citySearch.value = '';
    cityResults.innerHTML = '';
  });

  // ุดุฑูุน
  loadData();
})();
</script>
{% endblock %}
