{% extends "base.html" %}
{% set hide_header = True %}
{% block title %}گام ۲ از ۴: تصاویر و عنوان{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 shadow-sm sm:shadow rounded-none sm:rounded-2xl mt-0 sm:mt-6 overflow-hidden">
  <header class="px-4 sm:px-6 py-4 border-b dark:border-gray-700">
    <div class="flex items-center gap-3">
      <span class="w-10 h-10 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 grid place-items-center text-emerald-700 dark:text-emerald-300"><i class="fas fa-seedling"></i></span>
      <div>
        <div class="font-bold">ثبت آگهی جدید</div>
        <div class="text-xs text-gray-500">گام ۲ از ۴ — تصاویر و عنوان</div>
      </div>
      <a href="{{ url_for('main.add_land_step1') }}" class="ms-auto text-xs text-emerald-700 hover:underline">ویرایش دسته</a>
    </div>
  </header>

  <div class="px-4 sm:px-6 py-3 border-b dark:border-gray-700 bg-white/70 dark:bg-gray-900/70">
    <div class="flex items-center gap-3 text-xs text-gray-600 dark:text-gray-300">
      <div class="flex items-center gap-2"><span class="w-6 h-6 grid place-items-center rounded-full bg-emerald-600 text-white">1</span><span class="hidden sm:inline">انتخاب دسته</span></div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center gap-2"><span class="w-6 h-6 grid place-items-center rounded-full bg-emerald-600 text-white">2</span><span class="hidden sm:inline">تصاویر و عنوان</span></div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center gap-2"><span class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">3</span><span class="hidden sm:inline">جزئیات</span></div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center gap-2"><span class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">4</span><span class="hidden sm:inline">بررسی و انتشار</span></div>
    </div>
    <div class="mt-3 h-1 bg-gray-200 dark:bg-gray-700 rounded"><div class="h-1 bg-emerald-600 rounded" style="width:50%"></div></div>
  </div>

  <form method="POST" enctype="multipart/form-data" class="space-y-6 p-4 sm:p-6" id="adForm" novalidate action="{{ url_for('main.add_land') }}">
    {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

    <section aria-label="تصاویر" class="space-y-3">
      <div class="flex items-center justify-between">
        <label class="block text-sm font-bold text-gray-700 dark:text-gray-200">تصاویر</label>
        <div class="text-[11px] text-gray-500">حداکثر ۱۰ تصویر • هرکدام تا ۱۲MB</div>
      </div>

      <div id="dropzone" role="button"
           class="rounded-2xl border-2 border-dashed border-emerald-400/70 bg-emerald-50/30 dark:bg-gray-900/30 p-4 sm:p-5 text-center hover:bg-emerald-50/50 transition">
        <div class="flex items-center justify-center gap-3 text-emerald-700 dark:text-emerald-300">
          <span class="w-10 h-10 rounded-xl bg-emerald-100 dark:bg-emerald-900/40 grid place-items-center"><i class="fas fa-upload"></i></span>
          <div class="text-sm">
            <div class="font-bold">تصویر اضافه کنید</div>
            <div class="text-[11px] text-emerald-700/80 dark:text-emerald-300/80">کلیک کنید یا بکشید و رها کنید</div>
          </div>
        </div>
        <input type="file" name="images" id="imagesInput" accept="image/*" multiple
               style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;">
      </div>

      <div id="preview" class="grid grid-cols-3 gap-2"></div>
      <input type="hidden" name="uploaded_ids" id="uploaded_ids" />
      <div id="uploadMsg" class="text-xs text-gray-600 dark:text-gray-300"></div>
    </section>

    <section aria-label="عنوان" class="space-y-2">
      <label class="block text-sm font-bold text-gray-700 dark:text-gray-200" for="title">عنوان*</label>
      <input type="text" name="title" id="title" required maxlength="120" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white" placeholder="مثلاً: آپارتمان ۸۵ متری خوش نقشه" />
    </section>

    <section aria-label="توضیحات" class="space-y-2">
      <label class="block text-sm font-bold text-gray-700 dark:text-gray-200" for="description">توضیحات (اختیاری)</label>
      <textarea name="description" id="description" rows="4" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white" placeholder="ویژگی‌های کلیدی، دسترسی‌ها، وضعیت ملک..."></textarea>
    </section>

    <div class="h-16 sm:h-0"></div>
    <div class="fixed bottom-0 inset-x-0 sm:static bg-white/95 dark:bg-gray-900/95 border-t dark:border-gray-700 px-4 py-3 flex items-center gap-3 justify-between"
         style="padding-bottom:calc(env(safe-area-inset-bottom,0px)+12px)">
      <a href="{{ url_for('main.add_land_step1') }}" class="px-4 py-2 rounded-xl border hover:bg-gray-50 dark:hover:bg-gray-700 transition text-sm">بازگشت</a>
      <div class="text-xs text-gray-500" id="continueHint">افزودن حداقل یک تصویر توصیه می‌شود</div>
      <button type="submit" id="btnSubmit" class="px-5 py-2.5 rounded-2xl bg-green-600 hover:bg-green-700 text-white">ادامه</button>
    </div>
  </form>
</div>

<style>
  .thumb{position:relative;border:1px solid rgba(0,0,0,.08);border-radius:12px;overflow:hidden}
  .thumb img{width:100%;height:120px;object-fit:cover;display:block}
  .thumb .rm{position:absolute;top:6px;right:6px;background:#ef4444;color:#fff;border-radius:999px;font-size:11px;padding:.2rem .45rem}
  .thumb .bar{position:absolute;left:0;right:0;bottom:0;height:4px;background:rgba(0,0,0,.1)}
  .thumb .bar>span{display:block;height:100%;background:#10b981;width:0}
  #dropzone.dragover{background:rgba(16,185,129,.08)}
</style>

<script>
(function(){
  const input   = document.getElementById('imagesInput');
  const preview = document.getElementById('preview');
  const msg     = document.getElementById('uploadMsg');
  const hidden  = document.getElementById('uploaded_ids');
  const btn     = document.getElementById('btnSubmit');
  const hint    = document.getElementById('continueHint');
  const dz      = document.getElementById('dropzone');

  const MAX = 10; const MAX_MB = 12;
  function toast(t){ try{ msg.textContent = t; }catch(_){}}
  function fileToDataURL(f){ return new Promise(r=>{ const rd=new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(f);}); }
  function enableContinue(){ const hasTitle = Boolean((document.getElementById('title')?.value||'').trim()); if(btn) btn.disabled = !hasTitle; }
  document.getElementById('title')?.addEventListener('input', enableContinue);

  async function onFiles(files){
    const arr = Array.from(files||[]);
    if(!arr.length) return;
    let ids = (hidden.value||'').split(',').filter(Boolean);
    for (const f of arr.slice(0,MAX - ids.length)){
      if (!f.type.startsWith('image/')){ toast('فقط تصویر مجاز است'); continue; }
      if (f.size > MAX_MB*1024*1024){ toast('حداکثر '+MAX_MB+'MB'); continue; }
      // کارت پیش‌نمایش با نوار پیشرفت
      const card = document.createElement('div'); card.className='thumb';
      const bar  = document.createElement('div'); bar.className='bar'; const barIn=document.createElement('span'); bar.appendChild(barIn);
      const rm   = document.createElement('button'); rm.type='button'; rm.className='rm'; rm.textContent='حذف';
      const img  = document.createElement('img');
      try{ img.src = await fileToDataURL(f);}catch(_){ }
      card.appendChild(img); card.appendChild(rm); card.appendChild(bar); preview.appendChild(card);
      rm.addEventListener('click', ()=>{ preview.removeChild(card); ids = ids.filter(x=>x!==card.dataset.id); hidden.value = ids.join(','); enableContinue(); });
      // آپلود
      try{
        const id = await upload(f, (p)=>{ barIn.style.width = p+'%'; });
        if (id) { ids.push(id); hidden.value = ids.join(','); card.dataset.id = id; barIn.style.width='100%'; }
      }catch(e){ toast('آپلود ناموفق: '+(e&&e.message||'')); try{ preview.removeChild(card);}catch(_){ } }
    }
    enableContinue();
  }

  function upload(f, onprog){
    return new Promise((resolve,reject)=>{
      const fd = new FormData(); fd.append('file', f, 'image.jpg');
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/uploads/images', true);
      xhr.responseType='json'; xhr.withCredentials=true; xhr.setRequestHeader('Accept','application/json');
      try{ xhr.upload.onprogress = (ev)=>{ if (!ev.lengthComputable) return; const p = Math.round((ev.loaded/ev.total)*100); if(onprog) onprog(p); }; }catch(_){ }
      xhr.onload = ()=>{ try{ if(xhr.status>=200&&xhr.status<300){ const d=xhr.response||{}; return resolve(d.id||null);} reject(new Error('HTTP '+xhr.status)); }catch(e){ reject(e);} };
      xhr.onerror=()=>reject(new Error('NETWORK_ERROR'));
      xhr.send(fd);
    });
  }

  input.addEventListener('change', (e)=> onFiles(e.target.files));
  dz.addEventListener('click', ()=> input.click());
  ;['dragenter','dragover'].forEach(evt=> dz.addEventListener(evt, (e)=>{ e.preventDefault(); dz.classList.add('dragover'); }));
  ;['dragleave','drop'].forEach(evt=> dz.addEventListener(evt, (e)=>{ e.preventDefault(); dz.classList.remove('dragover'); }));
  dz.addEventListener('drop', (e)=>{ const dt=e.dataTransfer; if(dt?.files) onFiles(dt.files); });
  enableContinue();
})();
</script>
{% endblock %}


