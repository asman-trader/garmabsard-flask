{% extends "base.html" %}
{% set hide_header = True %}
{% block title %}گام ۲ از ۴: تصاویر و عنوان{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 shadow-sm sm:shadow rounded-none sm:rounded-2xl mt-0 sm:mt-6 overflow-hidden">
  <header class="px-4 sm:px-6 py-4 border-b dark:border-gray-700">
    <div class="flex items-center gap-3">
      <span class="w-10 h-10 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 grid place-items-center text-emerald-700 dark:text-emerald-300"><i class="fas fa-seedling"></i></span>
      <div>
        <div class="font-bold">ثبت آگهی جدید</div>
        <div class="text-xs text-gray-500">گام ۲ از ۴ — تصاویر و عنوان</div>
      </div>
      <a href="{{ url_for('main.add_land_step1') }}" class="ms-auto text-xs text-emerald-700 hover:underline">ویرایش دسته</a>
    </div>
  </header>

  <div class="px-4 sm:px-6 py-3 border-b dark:border-gray-700 bg-white/70 dark:bg-gray-900/70">
    <div class="flex items-center gap-3 text-xs text-gray-600 dark:text-gray-300">
      <div class="flex items-center gap-2"><span class="w-6 h-6 grid place-items-center rounded-full bg-emerald-600 text-white">1</span><span class="hidden sm:inline">انتخاب دسته</span></div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center gap-2"><span class="w-6 h-6 grid place-items-center rounded-full bg-emerald-600 text-white">2</span><span class="hidden sm:inline">تصاویر و عنوان</span></div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center gap-2"><span class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">3</span><span class="hidden sm:inline">جزئیات</span></div>
      <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center gap-2"><span class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">4</span><span class="hidden sm:inline">بررسی و انتشار</span></div>
    </div>
    <div class="mt-3 h-1 bg-gray-200 dark:bg-gray-700 rounded"><div class="h-1 bg-emerald-600 rounded" style="width:50%"></div></div>
  </div>

  <form method="POST" enctype="multipart/form-data" class="space-y-6 p-4 sm:p-6" id="adForm" novalidate action="{{ url_for('main.add_land') }}">
    {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

    <section aria-label="تصاویر" class="space-y-2">
      <label class="block text-sm font-bold text-gray-700 dark:text-gray-200">تصاویر</label>
      <input type="file" name="images" id="imagesInput" accept="image/*" multiple class="block w-full" />
      <div id="preview" class="grid grid-cols-3 gap-2"></div>
      <input type="hidden" name="uploaded_ids" id="uploaded_ids" />
      <div id="uploadMsg" class="text-xs text-gray-500"></div>
    </section>

    <section aria-label="عنوان" class="space-y-2">
      <label class="block text-sm font-bold text-gray-700 dark:text-gray-200" for="title">عنوان*</label>
      <input type="text" name="title" id="title" required maxlength="120" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white" placeholder="مثلاً: آپارتمان ۸۵ متری خوش نقشه" />
    </section>

    <section aria-label="توضیحات" class="space-y-2">
      <label class="block text-sm font-bold text-gray-700 dark:text-gray-200" for="description">توضیحات (اختیاری)</label>
      <textarea name="description" id="description" rows="4" class="w-full border rounded-lg px-3 py-2 dark:bg-gray-700 dark:text-white" placeholder="ویژگی‌های کلیدی، دسترسی‌ها، وضعیت ملک..."></textarea>
    </section>

    <div class="flex items-center justify-end gap-2 pt-2">
      <a href="{{ url_for('main.add_land_step1') }}" class="px-4 py-2 rounded-xl border hover:bg-gray-50 dark:hover:bg-gray-700 transition">بازگشت</a>
      <button type="submit" id="btnSubmit" class="px-5 py-2.5 rounded-2xl bg-green-600 hover:bg-green-700 text-white">ادامه</button>
    </div>
  </form>
</div>

<script>
(function(){
  const input = document.getElementById('imagesInput');
  const preview = document.getElementById('preview');
  const msg = document.getElementById('uploadMsg');
  const hidden = document.getElementById('uploaded_ids');
  const btn = document.getElementById('btnSubmit');

  const MAX = 10; const MAX_MB = 12;
  function toast(t){ try{ msg.textContent = t; }catch(_){}}
  function fileToDataURL(f){ return new Promise(r=>{ const rd=new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(f);}); }

  async function onFiles(files){
    const arr = Array.from(files||[]);
    if(!arr.length) return;
    const ids = [];
    for (const f of arr.slice(0,MAX)){
      if (!f.type.startsWith('image/')){ toast('فقط تصویر مجاز است'); continue; }
      if (f.size > MAX_MB*1024*1024){ toast('حداکثر '+MAX_MB+'MB'); continue; }
      // پیش‌نمایش فوری
      try{ const url = await fileToDataURL(f); const img = document.createElement('img'); img.src=url; img.className='w-full h-28 object-cover rounded-lg border'; preview.appendChild(img);}catch(_){ }
      // آپلود
      try{
        const id = await upload(f);
        if (id) ids.push(id);
      }catch(e){ toast('آپلود ناموفق: '+(e&&e.message||'')); }
    }
    hidden.value = ids.join(',');
  }

  function upload(f){
    return new Promise((resolve,reject)=>{
      const fd = new FormData(); fd.append('file', f, 'image.jpg');
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/uploads/images', true);
      xhr.responseType='json'; xhr.withCredentials=true; xhr.setRequestHeader('Accept','application/json');
      xhr.onload = ()=>{ try{ if(xhr.status>=200&&xhr.status<300){ const d=xhr.response||{}; return resolve(d.id||null);} reject(new Error('HTTP '+xhr.status)); }catch(e){ reject(e);} };
      xhr.onerror=()=>reject(new Error('NETWORK_ERROR'));
      xhr.send(fd);
    });
  }

  input.addEventListener('change', (e)=> onFiles(e.target.files));
})();
</script>
{% endblock %}


