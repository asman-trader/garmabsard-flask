{% extends "base.html" %}
{% set hide_header = True %}

{% block title %}ثبت آگهی - مرحله ۲{% endblock %}

{% block content %}
{% block floating_action %}{% endblock %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 pb-20 sm:pb-0">
  <!-- Header -->
  <div class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700 fixed top-0 inset-x-0 z-20 px-4 sm:px-6 lg:px-8">
    <div class="py-3 flex items-center justify-between">
      <a href="{{ url_for('main.add_land_step1') }}" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
        <i class="fas fa-arrow-right text-lg"></i>
      </a>
      <h1 class="text-lg font-bold text-gray-900 dark:text-white">مرحله ۲ از ۴</h1>
      <div class="w-6"></div>
    </div>
    
    <!-- Progress Bar -->
    <div class="pb-3">
      <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-2">
        <span>تصاویر و توضیحات</span>
        <span>۵۰٪</span>
      </div>
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
        <div class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 50%"></div>
      </div>
    </div>
  </div>

  <!-- Spacer for fixed header height -->
  <div class="h-24"></div>

  <!-- Main Content -->
  <div class="px-4 py-6 space-y-6">
    <!-- Step 2: Images and Description -->
    <form id="step2Form" method="POST" enctype="multipart/form-data" class="space-y-6" action="{{ url_for('main.add_land') }}">
      {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      
      <!-- Images Section -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-4">
          <i class="fas fa-images text-emerald-500"></i>
          <h2 class="text-lg font-bold text-gray-900 dark:text-white">تصاویر ملک</h2>
        </div>
        
        <!-- Upload Area -->
        <div class="mb-4">
          <div id="dropzone" role="button" tabindex="0" aria-controls="imagesInput" aria-label="انتخاب تصاویر"
               class="w-full h-32 border-2 border-dashed border-emerald-300 dark:border-emerald-600 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 flex flex-col items-center justify-center cursor-pointer hover:bg-emerald-100 dark:hover:bg-emerald-900/30 transition-colors">
            <i class="fas fa-cloud-upload-alt text-3xl text-emerald-500 mb-2"></i>
            <p class="text-sm font-medium text-gray-700 dark:text-gray-300">تصاویر را انتخاب کنید</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">حداکثر ۱۰ تصویر</p>
          </div>
          <input type="file" id="imagesInput" name="images" accept="image/*" multiple class="hidden">
        </div>
        
        <!-- Image Preview Grid -->
        <div id="imagePreview" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
      </div>

      <!-- Title Section -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-4">
          <i class="fas fa-heading text-emerald-500"></i>
          <h2 class="text-lg font-bold text-gray-900 dark:text-white">عنوان آگهی</h2>
        </div>
        
        <div class="space-y-3">
          <label class="sr-only" for="title">عنوان آگهی</label>
          <input type="text" name="title" id="title" required maxlength="60" minlength="11" aria-describedby="titleError titleCount"
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-colors" 
                 placeholder="مثال: آپارتمان ۲ خوابه در مرکز شهر">
          <div id="titleError" class="mt-1 text-[11px] text-red-600 hidden">عنوان باید بیش از ۱۰ و حداکثر ۶۰ کاراکتر باشد.</div>
          <div class="mt-1 text-[11px] text-gray-500" id="titleCount">کاراکتر: 0/60</div>
        </div>
      </div>

      <!-- Description Section -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-4">
          <i class="fas fa-align-right text-emerald-500"></i>
          <h2 class="text-lg font-bold text-gray-900 dark:text-white">توضیحات</h2>
        </div>
        
        <div class="space-y-3">
          <label class="sr-only" for="description">توضیحات</label>
          <textarea name="description" id="description" rows="4" maxlength="950" minlength="51" required aria-describedby="descError descCount"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-colors resize-none" 
                    placeholder="توضیحات کامل ملک را بنویسید..."></textarea>
          <div id="descError" class="mt-1 text-[11px] text-red-600 hidden">توضیحات باید بیش از ۵۰ و حداکثر ۹۵۰ کاراکتر باشد.</div>
          <div class="mt-1 text-[11px] text-gray-500" id="descCount">کاراکتر: 0/950</div>
        </div>
      </div>

      <!-- Hidden field for uploaded image IDs -->
      <input type="hidden" id="uploadedImageIds" name="uploaded_image_ids" value="">
    </form>
  </div>

  <!-- Bottom Action Bar -->
  <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 px-4 py-3 sm:static sm:border-t-0 sm:bg-transparent sm:dark:bg-transparent">
    <div class="flex items-center gap-3">
      <a href="{{ url_for('main.add_land_step1') }}" class="flex-1 px-4 py-3 text-center text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
        قبلی
      </a>
      <button type="submit" form="step2Form" id="continueBtn" class="flex-1 px-4 py-3 text-center text-white bg-emerald-500 rounded-xl font-medium hover:bg-emerald-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
        ادامه
      </button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<style>
  .image-preview {
    position: relative;
    aspect-ratio: 1;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
  }
  .image-preview.dragging { opacity: .6; transform: scale(.98); }
  
  .image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .image-preview .remove-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
  }
  .image-preview .cover-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(16,185,129,.6);
    background: rgba(255,255,255,.9);
    color: #065f46;
    font-size: 11px;
    cursor: pointer;
  }
  .image-preview .cover-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    padding: 2px 6px;
    border-radius: 999px;
    background: #065f46;
    color: #fff;
    font-size: 10px;
    opacity: .95;
  }
  
  .upload-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(0, 0, 0, 0.1);
  }
  
  .upload-progress .progress-bar {
    height: 100%;
    background: #10b981;
    width: 0%;
    transition: width 0.3s ease;
  }
  /* Auto-grow textarea */
  #description { overflow: hidden; }
  
  .toast {
    padding: 12px 16px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: slideIn 0.3s ease-out;
  }
  
  .toast.success {
    background: #10b981;
  }
  
  .toast.error {
    background: #ef4444;
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* Mobile optimizations */
  @media (max-width: 640px) {
    .image-preview {
      aspect-ratio: 1.2;
    }
  }
  
  /* Keyboard handling */
  @media (max-width: 640px) {
    .fixed.bottom-0 { padding-bottom: env(safe-area-inset-bottom, 12px); }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('step2Form');
  const imagesInput = document.getElementById('imagesInput');
  const dropzone = document.getElementById('dropzone');
  const imagePreview = document.getElementById('imagePreview');
  const uploadedImageIds = document.getElementById('uploadedImageIds');
  const continueBtn = document.getElementById('continueBtn');
  const toastContainer = document.getElementById('toastContainer');
  
  let uploadedImages = [];
  let uploadingCount = 0;
  const LS_KEY = 'adStep2Draft';
  
  // Show toast message
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 4000);
  }
  
  // Update continue button state
  function updateContinueButton() {
    const titleInput = document.querySelector('input[name="title"]');
    const descriptionInput = document.querySelector('textarea[name="description"]');
    const titleLen = titleInput ? titleInput.value.trim().length : 0;
    const descLen  = descriptionInput ? descriptionInput.value.trim().length : 0;
    const titleOk = titleLen >= 11 && titleLen <= 60;
    const descOk  = descLen >= 51 && descLen <= 950;

    const titleErr = document.getElementById('titleError');
    const descErr  = document.getElementById('descError');
    if (titleErr) titleErr.classList.toggle('hidden', titleOk || titleLen === 0);
    if (descErr)  descErr.classList.toggle('hidden',  descOk  || descLen  === 0);

    continueBtn.disabled = !(titleOk && descOk) || uploadingCount > 0;

    // Counters
    try{
      const tC = document.getElementById('titleCount');
      const dC = document.getElementById('descCount');
      if (tC) tC.textContent = `کاراکتر: ${titleLen}/60`;
      if (dC) dC.textContent = `کاراکتر: ${descLen}/950`;
    }catch(_){ }

    if (uploadingCount > 0) {
      continueBtn.textContent = `در حال آپلود... (${uploadingCount})`;
    } else {
      continueBtn.textContent = 'ادامه';
    }
  }
  
  // Create image preview element
  function createImagePreview(file, id = null) {
    const preview = document.createElement('div');
    preview.className = 'image-preview';
    preview.dataset.fileId = id || Date.now();
    preview.draggable = true;
    
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.innerHTML = '×';
    removeBtn.onclick = () => removeImage(preview.dataset.fileId);
    const coverBtn = document.createElement('button');
    coverBtn.className = 'cover-btn';
    coverBtn.textContent = 'انتخاب کاور';
    coverBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      setAsCover(preview.dataset.fileId);
    });
    
    const progressContainer = document.createElement('div');
    progressContainer.className = 'upload-progress';
    const progressBar = document.createElement('div');
    progressBar.className = 'progress-bar';
    progressContainer.appendChild(progressBar);
    
    preview.appendChild(img);
    preview.appendChild(removeBtn);
    preview.appendChild(progressContainer);
    preview.appendChild(coverBtn);

    // Drag & Drop handlers
    preview.addEventListener('dragstart', (ev)=>{
      preview.classList.add('dragging');
      ev.dataTransfer.setData('text/plain', preview.dataset.fileId);
    });
    preview.addEventListener('dragend', ()=>{
      preview.classList.remove('dragging');
    });
    preview.addEventListener('dragover', (ev)=>{ ev.preventDefault(); });
    preview.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      const srcId = ev.dataTransfer.getData('text/plain');
      const dstId = preview.dataset.fileId;
      if (!srcId || !dstId || srcId === dstId) return;
      reorderPreviews(srcId, dstId);
    });
    
    return { preview, progressBar };
  }

  // Create preview from server URL (for restored state)
  function createImagePreviewFromUrl(serverId, id = null) {
    const preview = document.createElement('div');
    preview.className = 'image-preview';
    const localId = id || (Date.now() + Math.random());
    preview.dataset.fileId = localId;
    preview.draggable = true;

    const img = document.createElement('img');
    img.src = `/uploads/${serverId}`;

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.innerHTML = '×';
    removeBtn.onclick = () => removeImage(preview.dataset.fileId);

    preview.appendChild(img);
    preview.appendChild(removeBtn);
    imagePreview.appendChild(preview);
    // Drag & Drop handlers
    preview.addEventListener('dragstart', (ev)=>{
      preview.classList.add('dragging');
      ev.dataTransfer.setData('text/plain', preview.dataset.fileId);
    });
    preview.addEventListener('dragend', ()=>{
      preview.classList.remove('dragging');
    });
    preview.addEventListener('dragover', (ev)=>{ ev.preventDefault(); });
    preview.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      const srcId = ev.dataTransfer.getData('text/plain');
      const dstId = preview.dataset.fileId;
      if (!srcId || !dstId || srcId === dstId) return;
      reorderPreviews(srcId, dstId);
    });

    const isFirst = uploadedImages.length === 0;
    uploadedImages.push({ id: localId, file: null, serverId, isCover: isFirst });
    if (isFirst) renderCoverBadges();
  }
  
  // Remove image
  function removeImage(fileId) {
    const preview = document.querySelector(`[data-file-id="${fileId}"]`);
    if (preview) {
      preview.remove();
    }
    
    uploadedImages = uploadedImages.filter(img => img.id !== fileId);
    updateUploadedIds();
    updateContinueButton();
    renderCoverBadges();
    saveDraft();
    // Ensure we always have a cover if any image exists
    if (uploadedImages.length) {
      if (!uploadedImages.some(x=>x.isCover)) {
        uploadedImages[0].isCover = true;
        renderCoverBadges();
        saveDraft();
      }
    }
  }
  
  // Update uploaded IDs hidden field
  function updateUploadedIds() {
    const ids = uploadedImages.filter(img => img.serverId).map(img => img.serverId);
    uploadedImageIds.value = ids.join(',');
    // Persist immediately to avoid ghost previews on refresh
    saveDraft();
  }

  function setAsCover(fileId) {
    uploadedImages = uploadedImages.map(x => ({ ...x, isCover: x.id == fileId }));
    renderCoverBadges();
    saveDraft();
  }

  function renderCoverBadges() {
    // remove old badges
    document.querySelectorAll('.image-preview .cover-badge').forEach(el => el.remove());
    // add badge for current cover
    const cover = uploadedImages.find(x => x.isCover);
    if (!cover) return;
    const preview = document.querySelector(`.image-preview[data-file-id="${cover.id}"]`);
    if (!preview) return;
    const badge = document.createElement('span');
    badge.className = 'cover-badge';
    badge.textContent = 'کاور';
    preview.appendChild(badge);
  }

  function reorderPreviews(srcId, dstId) {
    const fromIdx = uploadedImages.findIndex(x => String(x.id) === String(srcId));
    const toIdx = uploadedImages.findIndex(x => String(x.id) === String(dstId));
    if (fromIdx === -1 || toIdx === -1 || fromIdx === toIdx) return;
    const [moved] = uploadedImages.splice(fromIdx, 1);
    uploadedImages.splice(toIdx, 0, moved);
    // Reorder DOM
    const srcEl = document.querySelector(`.image-preview[data-file-id="${srcId}"]`);
    const dstEl = document.querySelector(`.image-preview[data-file-id="${dstId}"]`);
    if (srcEl && dstEl && srcEl !== dstEl) imagePreview.insertBefore(srcEl, dstEl);
    // Make first item cover per UX
    uploadedImages.forEach(x => x.isCover = false);
    if (uploadedImages.length) uploadedImages[0].isCover = true;
    renderCoverBadges();
    updateUploadedIds();
    saveDraft();
  }

  // Draft persistence
  function saveDraft() {
    const titleEl = document.querySelector('input[name="title"]');
    const descEl = document.querySelector('textarea[name="description"]');
    const ids = uploadedImages.filter(x=>x.serverId).map(x=>x.serverId);
    const payload = {
      title: titleEl ? titleEl.value : '',
      description: descEl ? descEl.value : '',
      uploadedIds: ids
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch(_) {}
  }

  function loadDraft() {
    let data = null;
    try { data = JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch(_) { data = null; }
    if (!data) return;
    try {
      const titleEl = document.querySelector('input[name="title"]');
      const descEl = document.querySelector('textarea[name="description"]');
      if (titleEl && typeof data.title === 'string') titleEl.value = data.title;
      if (descEl && typeof data.description === 'string') descEl.value = data.description;
      (Array.isArray(data.uploadedIds) ? data.uploadedIds : []).forEach(sid=>{
        if (sid && typeof sid === 'string') createImagePreviewFromUrl(sid);
      });
      updateUploadedIds();
      updateContinueButton();
    } catch(_) {}
  }
  
  // Upload single image
  function uploadImage(file, progressBar) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      const formData = new FormData();
      formData.append('file', file);
      
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percentComplete = (e.loaded / e.total) * 100;
          progressBar.style.width = percentComplete + '%';
        }
      });
      
      xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            const isOk = (response && (response.ok === true || response.success === true));
            const id = response && (response.id || response.filename || response.file_id || response.uuid);
            if (isOk && id) {
              resolve(id);
            } else {
              reject(new Error((response && response.error) || 'آپلود ناموفق'));
            }
          } catch (e) {
            reject(new Error('خطا در پردازش پاسخ سرور'));
          }
        } else {
          reject(new Error(`خطا: ${xhr.status}`));
        }
      });
      
      xhr.addEventListener('error', () => {
        reject(new Error('خطا در اتصال به سرور'));
      });
      
      xhr.open('POST', '/api/uploads/images');
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.withCredentials = true;
      xhr.send(formData);
    });
  }
  
  // Handle file selection
  function handleFiles(files) {
    const fileArray = Array.from(files);
    const validFiles = fileArray.filter(file => file.type.startsWith('image/'));
    
    if (validFiles.length === 0) {
      // تصویر اختیاری است؛ اگر هیچ فایل معتبری نبود، صرفاً پیام نشان نده
      return;
    }
    
    if (uploadedImages.length + validFiles.length > 10) {
      showToast('حداکثر ۱۰ تصویر می‌توانید آپلود کنید', 'error');
      return;
    }
    
    validFiles.forEach(file => {
      const fileId = Date.now() + Math.random();
      const { preview, progressBar } = createImagePreview(file, fileId);
      
      // اگر کاور نداریم، اولی را کاور کن
      const isFirst = uploadedImages.length === 0;
      uploadedImages.push({ id: fileId, file, serverId: null, isCover: isFirst });
      imagePreview.appendChild(preview);
      
      uploadingCount++;
      updateContinueButton();
      
      uploadImage(file, progressBar)
        .then(serverId => {
          const imageIndex = uploadedImages.findIndex(img => img.id === fileId);
          if (imageIndex !== -1) {
            uploadedImages[imageIndex].serverId = serverId;
            updateUploadedIds();
          }
          showToast('تصویر با موفقیت آپلود شد');
          saveDraft();
          renderCoverBadges();
        })
        .catch(error => {
          showToast(error.message, 'error');
          removeImage(fileId);
        })
        .finally(() => {
          uploadingCount--;
          updateContinueButton();
        });
    });
  }
  
  // Event listeners
  if (imagesInput) {
    imagesInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFiles(e.target.files);
        saveDraft();
      }
    });
  }
  
  if (dropzone) {
    const openPicker = (e) => {
      e.preventDefault();
      if (!imagesInput) return;
      // Clear value to ensure same-file re-selection triggers change
      imagesInput.value = '';
      imagesInput.click();
    };
    dropzone.addEventListener('click', openPicker);
    dropzone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') openPicker(e);
    });
  }
  
  // Drag and drop (desktop only)
  if (!('ontouchstart' in window) && dropzone) {
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-emerald-500', 'bg-emerald-100');
    });
    
    dropzone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-emerald-500', 'bg-emerald-100');
    });
    
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-emerald-500', 'bg-emerald-100');
      if (e.dataTransfer.files.length > 0) {
        handleFiles(e.dataTransfer.files);
      }
    });
  }
  
  // Form validation
  if (form) {
    form.addEventListener('submit', (e) => {
      const titleInput = document.querySelector('input[name="title"]');
      const descriptionInput = document.querySelector('textarea[name="description"]');
      const titleLen = titleInput ? titleInput.value.trim().length : 0;
      const descLen  = descriptionInput ? descriptionInput.value.trim().length : 0;
      if (titleLen < 11 || titleLen > 60) {
        e.preventDefault();
        showToast('عنوان باید بیش از ۱۰ و حداکثر ۶۰ کاراکتر باشد.', 'error');
        return;
      }
      if (descLen < 51 || descLen > 950) {
        e.preventDefault();
        showToast('توضیحات باید بیش از ۵۰ و حداکثر ۹۵۰ کاراکتر باشد.', 'error');
        return;
      }

      if (uploadingCount > 0) {
        e.preventDefault();
        showToast('لطفاً صبر کنید تا آپلود تصاویر تمام شود', 'error');
        return;
      }
      // On successful submit, clear draft (server will carry state)
      try { localStorage.removeItem(LS_KEY); } catch(_) {}
    });
  }
  
  // Real-time validation
  const titleInput = document.querySelector('input[name="title"]');
  const descriptionInput = document.querySelector('textarea[name="description"]');
  
  if (titleInput) {
    titleInput.addEventListener('input', () => { updateContinueButton(); saveDraft(); });
  }
  
  if (descriptionInput) {
    const autoResizeDescription = () => {
      try {
        descriptionInput.style.height = 'auto';
        const maxH = 800; // px cap to avoid excessive growth
        const next = Math.min(descriptionInput.scrollHeight, maxH);
        descriptionInput.style.height = next + 'px';
      } catch(_) {}
    };
    descriptionInput.addEventListener('input', () => { updateContinueButton(); autoResizeDescription(); saveDraft(); });
    // Initialize height
    autoResizeDescription();
  }
  
  // Initial state
  loadDraft();
  updateContinueButton();
});
</script>
{% endblock %}