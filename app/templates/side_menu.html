{# side_menu.html - Vinor | Mobile-first, final #}
{% macro MenuItem(href, icon, text, require_login=False, badge=None) -%}
  <a href="{{ href }}"
     class="group flex items-center gap-3 p-3 rounded-xl transition
            hover:bg-green-100 dark:hover:bg-green-800 active:scale-[0.98]
            {{ 'require-login' if require_login else '' }}"
     data-require-login="{{ '1' if require_login else '0' }}">
    <i class="fas {{ icon }} text-lg text-green-600 dark:text-green-400"></i>
    <span class="text-[15px] font-medium text-gray-800 dark:text-gray-100">{{ text }}</span>
    {% if badge is not none and badge|int > 0 %}
      <span class="ms-auto inline-flex items-center justify-center min-w-5 h-5 px-2 text-[11px] rounded-full
                   bg-red-500 text-white">{{ badge }}</span>
    {% endif %}
  </a>
{%- endmacro %}

<!-- Overlay (فقط موبایل) -->
<div id="menuOverlay"
     class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-200 sm:hidden"></div>

<aside id="sideMenu"
       class="fixed top-0 right-0 z-50 h-full w-[88vw] max-w-80 sm:w-72
              bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-700
              shadow-2xl transition-transform duration-300 ease-out
              flex flex-col">
  <!-- Header -->
  <header class="shrink-0 sticky top-0 px-3 py-3 bg-white/90 dark:bg-gray-900/90 backdrop-blur
                 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <!-- فقط آیکن پروفایل (لینک‌دار) -->
      <a href="{{ url_for('main.profile') if session.get('user_id') else url_for('main.login') }}"
         class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition"
         title="{{ 'پروفایل من' if session.get('user_id') else 'ورود / ثبت‌نام' }}"
         aria-label="{{ 'پروفایل من' if session.get('user_id') else 'ورود / ثبت‌نام' }}">
        <i class="fas fa-user-circle text-green-600 dark:text-green-400 text-2xl"></i>
      </a>

      <div class="flex items-center gap-2">
        <!-- City Chip -->
        <a id="cityChip"
           href="{{ url_for('main.city_select') }}"
           class="flex items-center gap-1 px-2 py-1 rounded-lg border text-xs
                  border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200
                  hover:bg-green-50 dark:hover:bg-green-800"
           title="انتخاب شهر" aria-label="انتخاب شهر">
          <i class="fas fa-map-marker-alt text-green-600 dark:text-green-400"></i>
          <span id="cityChipText">انتخاب شهر</span>
        </a>

        <!-- Notifications icon with badge -->
        <a href="{{ url_for('main.notifications') if session.get('user_id') else url_for('main.login') }}"
           class="relative p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition"
           title="اعلان‌ها" aria-label="اعلان‌ها">
          <i class="fas fa-bell text-[18px] text-gray-700 dark:text-gray-200"></i>
          {% if notif_count is defined and notif_count|int > 0 %}
            <span class="absolute -top-1 -left-1 min-w-5 h-5 px-1 rounded-full bg-red-500 text-white text-[10px] flex items-center justify-center">
              {{ notif_count }}
            </span>
          {% endif %}
        </a>

        <!-- Close (mobile) -->
        <button id="closeMenu"
                class="sm:hidden ms-1 p-2 rounded-lg text-xl text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800"
                aria-label="بستن منو">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Body -->
  <div class="flex-1 overflow-y-auto p-3 space-y-2">

    <!-- Primary actions -->
    <div class="space-y-2">
      {{ MenuItem(url_for('main.app_home'),   'fa-home',         'خانه') }}
      {{ MenuItem(url_for('main.search_page'),'fa-search',       'جستجو') }}
      {{ MenuItem(url_for('main.submit_ad'),  'fa-plus-circle',  'ثبت آگهی رایگان', True) }}
      {# اعلان‌ها به هدر منتقل شد و از این لیست حذف گردید #}
    </div>

    <hr class="border-gray-200 dark:border-gray-700 my-2">

    <!-- User bundle -->
    <div class="space-y-2">
      {{ MenuItem(url_for('main.my_lands'),   'fa-list',         'آگهی‌های من', True) }}
      {{ MenuItem(url_for('main.favorites'),  'fa-heart',        'علاقه‌مندی‌ها', True) }}
      {{ MenuItem(url_for('main.settings'),   'fa-cog',          'تنظیمات', True) }}
      {{ MenuItem(url_for('main.city_select'),'fa-city',         'انتخاب شهر') }}
    </div>

    <!-- Auth -->
    <div class="pt-2">
      {% if session.get('user_id') %}
        <a href="{{ url_for('main.logout') }}"
           class="flex items-center gap-3 p-3 rounded-xl text-red-600 hover:bg-red-100 dark:hover:bg-red-800">
          <i class="fas fa-sign-out-alt"></i>
          <span class="text-[15px] font-medium">خروج</span>
        </a>
      {% else %}
        <a href="{{ url_for('main.login') }}"
           class="flex items-center gap-3 p-3 rounded-xl text-green-700 hover:bg-green-100 dark:hover:bg-green-800">
          <i class="fas fa-sign-in-alt"></i>
          <span class="text-[15px] font-medium">ورود / ثبت‌نام</span>
        </a>
      {% endif %}
    </div>

  </div>

  <!-- Bottom quick actions -->
  <footer
    class="shrink-0 sticky bottom-0 p-3 bg-white/95 dark:bg-gray-900/95 backdrop-blur
           border-t border-gray-200 dark:border-gray-700"
    style="padding-bottom: calc(env(safe-area-inset-bottom, 0) + 12px);"
    role="toolbar" aria-label="اقدامات سریع">

    {% set PHONE = (contact_phone if contact_phone is defined and contact_phone) or '+989121234567' %}
    {% set WA    = (contact_whatsapp if contact_whatsapp is defined and contact_whatsapp) or PHONE %}
    {% set WA_INT = WA|replace('+','')|replace(' ','')|replace('-','') %}
    {% set SHARE_TEXT = (share_text if share_text is defined and share_text) or 'وینور | خرید و فروش ملک' %}

    <div class="grid grid-cols-3 gap-2 text-center">
      <a id="qaCall" href="tel:{{ PHONE }}"
         class="p-2 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-green-100 dark:hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-500"
         aria-label="تماس تلفنی" rel="nofollow">
        <i class="fas fa-phone" aria-hidden="true"></i>
        <span class="block text-xs mt-1">تماس</span>
      </a>

      <a id="qaWhatsapp" href="https://wa.me/{{ WA_INT }}"
         class="p-2 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-green-100 dark:hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-500"
         aria-label="گفتگو در واتساپ" target="_blank" rel="noopener noreferrer"
         data-wa="{{ WA_INT }}" data-wa-text="{{ SHARE_TEXT }}">
        <i class="fab fa-whatsapp" aria-hidden="true"></i>
        <span class="block text-xs mt-1">واتساپ</span>
      </a>

      <button id="qaShare" type="button"
              class="p-2 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-green-100 dark:hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-500 w-full"
              aria-label="اشتراک‌گذاری">
        <i class="fas fa-share-alt" aria-hidden="true"></i>
        <span class="block text-xs mt-1">اشتراک</span>
      </button>
    </div>
  </footer>
</aside>

<script>
  (function () {
    const sideMenu     = document.getElementById('sideMenu');
    const overlay      = document.getElementById('menuOverlay');
    const closeBtn     = document.getElementById('closeMenu');
    const cityChipText = document.getElementById('cityChipText');
    const cityMenuText = document.getElementById('cityMenuText');

    // Open/Close (هماهنگ با base.html که کلاس open را کنترل می‌کند)
    const openMenu = () => {
      sideMenu?.classList.add('open');
      overlay?.classList.remove('pointer-events-none');
      overlay?.classList.add('opacity-100');
      document.body.style.overflow = 'hidden';
    };
    const closeMenu = () => {
      sideMenu?.classList.remove('open');
      overlay?.classList.add('pointer-events-none');
      overlay?.classList.remove('opacity-100');
      document.body.style.overflow = '';
    };
    window.openSideMenu = openMenu;
    overlay?.addEventListener('click', closeMenu);
    closeBtn?.addEventListener('click', closeMenu);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });

    // بستن منو بعد از کلیک روی هر لینک
    document.querySelectorAll('#sideMenu a').forEach(a => {
      a.addEventListener('click', () => setTimeout(closeMenu, 0));
    });

    // Require-login guard
    document.querySelectorAll('#sideMenu a.require-login, #sideMenu a[data-require-login="1"]').forEach(a => {
      a.addEventListener('click', (e) => {
        const loggedIn = {{ 'true' if session.get('user_id') else 'false' }};
        if (!loggedIn) {
          e.preventDefault();
          window.location.href = "{{ url_for('main.login') }}";
        }
      });
    });

    // Web Share + WhatsApp text
    const btnShare   = document.getElementById('qaShare');
    const aWhatsapp  = document.getElementById('qaWhatsapp');
    const shareTitle = document.title || 'وینور | خرید و فروش ملک';
    const shareUrl   = window.location.href;
    const shareText  = (aWhatsapp?.dataset.waText) || 'وینور | خرید و فروش ملک';

    if (aWhatsapp) {
      const wa = aWhatsapp.dataset.wa || '';
      const url = new URL(`https://wa.me/${wa}`);
      url.searchParams.set('text', `${shareText} — ${shareTitle}\n${shareUrl}`);
      aWhatsapp.href = url.toString();
    }

    btnShare?.addEventListener('click', async () => {
      const data = { title: shareTitle, text: shareText, url: shareUrl };
      try {
        if (navigator.share) {
          await navigator.share(data);
        } else {
          await navigator.clipboard.writeText(shareUrl);
          const t = document.createElement('div');
          t.textContent = 'لینک کپی شد ✅';
          t.dir = 'rtl';
          t.className = 'fixed bottom-16 inset-x-0 mx-auto w-fit px-3 py-2 rounded-lg text-sm bg-green-600 text-white shadow z-[60]';
          document.body.appendChild(t);
          setTimeout(() => t.remove(), 1800);
        }
      } catch (_) {}
    }, { passive: true });

    // City UI via localStorage
    const CITY_KEY = 'vinor_city';
    const getCity = () => { try { return localStorage.getItem(CITY_KEY) || ''; } catch { return ''; } };
    const updateCityUI = () => {
      const c = getCity();
      if (cityChipText) cityChipText.textContent = c || 'انتخاب شهر';
      if (cityMenuText) cityMenuText.textContent = c ? ('شهر من: ' + c) : 'انتخاب شهر';
    };
    updateCityUI();
    window.addEventListener('storage', (e) => { if (e.key === CITY_KEY) updateCityUI(); });
    document.addEventListener('vinor:city-changed', updateCityUI);
  })();
</script>
