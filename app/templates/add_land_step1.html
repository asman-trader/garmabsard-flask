{% extends "base.html" %}
{% set hide_header = True %}

{% block title %}ثبت آگهی - مرحله ۱{% endblock %}

{% block content %}
{% block floating_action %}{% endblock %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 pb-20 sm:pb-0">
  <!-- Header -->
  <div class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700 fixed top-0 inset-x-0 z-20 px-4 sm:px-6 lg:px-8">
    <div class="py-3 flex items-center justify-between">
      <a href="{{ url_for('main.index') }}" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
        <i class="fas fa-arrow-right text-lg"></i>
      </a>
      <h1 class="text-lg font-bold text-gray-900 dark:text-white">مرحله ۱ از ۴</h1>
      <div class="w-6"></div>
    </div>
    
    <!-- Progress Bar -->
    <div class="pb-3">
      <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-2">
        <span>انتخاب دسته</span>
        <span>۲۵٪</span>
      </div>
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
        <div class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
      </div>
    </div>
  </div>

  <!-- Removed spacer: content sticks to header -->

  <!-- Main Content -->
  <div class="px-4 py-6 space-y-6">
    <!-- Step 1: Simplified Selection -->
    <form id="step1Form" method="POST" class="space-y-6" action="{{ url_for('main.add_land_step1') }}">
      {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      <input type="hidden" name="city" id="cityInput" value="">

      <!-- Location (Single City) -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-4">
          <i class="fas fa-map-marker-alt text-emerald-500"></i>
          <h2 class="text-lg font-bold text-gray-900 dark:text-white">موقعیت</h2>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">لطفاً فقط یک شهر را انتخاب کنید.</p>

        <div class="flex items-center gap-2">
          <button type="button" id="cityChip" class="px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-800 text-gray-700 dark:text-gray-100 text-sm flex items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-700">
            <i class="fas fa-map-marker-alt text-green-600"></i>
            <span id="cityChipLabel">انتخاب شهر</span>
          </button>
          <button type="button" id="cityClear" class="text-xs text-red-500 hover:underline">حذف انتخاب</button>
        </div>

        <div id="cityWarn" class="mt-3 hidden text-xs text-red-600">یک شهر معتبر انتخاب کنید (استان/چندین شهر مجاز نیست).</div>
      </div>

      <!-- Trade Type Section (simplified + exchange) -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-3">
          <i class="fas fa-handshake text-emerald-500"></i>
          <h2 class="text-base font-bold text-gray-900 dark:text-white">نوع معامله</h2>
        </div>
        <div class="grid grid-cols-3 gap-2 text-sm">
          <label class="relative cursor-pointer">
            <input type="radio" name="trade_type" value="sale" required class="sr-only peer">
            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-emerald-900/20 text-center transition-all">
              <i class="fas fa-tag text-emerald-500 mb-1"></i>
              <div class="font-bold">فروش</div>
            </div>
          </label>
          <label class="relative cursor-pointer">
            <input type="radio" name="trade_type" value="rent" required class="sr-only peer">
            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-emerald-900/20 text-center transition-all">
              <i class="fas fa-key text-emerald-500 mb-1"></i>
              <div class="font-bold">اجاره</div>
            </div>
          </label>
          <label class="relative cursor-pointer">
            <input type="radio" name="trade_type" value="exchange" required class="sr-only peer">
            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-emerald-900/20 text-center transition-all">
              <i class="fas fa-arrows-rotate text-emerald-500 mb-1"></i>
              <div class="font-bold">معاوضه</div>
            </div>
          </label>
        </div>
      </div>

      <!-- Property Type Section (simplified) -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-3">
          <i class="fas fa-home text-emerald-500"></i>
          <h2 class="text-base font-bold text-gray-900 dark:text-white">نوع ملک</h2>
        </div>
        
        <div class="grid grid-cols-3 gap-2 text-sm">
          <label class="relative cursor-pointer">
            <input type="radio" name="property_type" value="apartment" required class="sr-only peer">
            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-emerald-900/20 text-center transition-all"><i class="fas fa-building text-emerald-500 mb-1"></i><div class="font-bold">آپارتمان</div></div>
          </label>
          
          <label class="relative cursor-pointer">
            <input type="radio" name="property_type" value="villa" required class="sr-only peer">
            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-emerald-900/20 text-center transition-all"><i class="fas fa-home text-emerald-500 mb-1"></i><div class="font-bold">ویلا</div></div>
          </label>
          
          <label class="relative cursor-pointer">
            <input type="radio" name="property_type" value="land" required class="sr-only peer">
            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-emerald-900/20 text-center transition-all"><i class="fas fa-mountain text-emerald-500 mb-1"></i><div class="font-bold">زمین</div></div>
          </label>
          
          <label class="relative cursor-pointer">
            <input type="radio" name="property_type" value="garden" required class="sr-only peer">
            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-emerald-900/20 text-center transition-all"><i class="fas fa-seedling text-emerald-500 mb-1"></i><div class="font-bold">باغ</div></div>
          </label>
          
          <label class="relative cursor-pointer">
            <input type="radio" name="property_type" value="shop" required class="sr-only peer">
            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-emerald-900/20 text-center transition-all"><i class="fas fa-store text-emerald-500 mb-1"></i><div class="font-bold">مغازه</div></div>
          </label>
          
          <label class="relative cursor-pointer">
            <input type="radio" name="property_type" value="office" required class="sr-only peer">
            <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-emerald-900/20 text-center transition-all"><i class="fas fa-briefcase text-emerald-500 mb-1"></i><div class="font-bold">اداری</div></div>
          </label>
        </div>
      </div>
    </form>
  </div>

  <!-- Bottom Action Bar -->
  <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 px-4 py-3 sm:static sm:border-t-0 sm:bg-transparent sm:dark:bg-transparent">
    <div class="flex items-center gap-3">
      <a href="{{ url_for('main.index') }}" class="flex-1 px-4 py-3 text-center text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
        انصراف
      </a>
      <button type="submit" form="step1Form" id="continueBtn" class="flex-1 px-4 py-3 text-center text-white bg-emerald-500 rounded-xl font-medium hover:bg-emerald-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
        ادامه
      </button>
    </div>
  </div>
</div>

<style>
  /* Mobile optimizations */
  @media (max-width: 640px) {
    .fixed.bottom-0 {
      padding-bottom: env(safe-area-inset-bottom, 12px);
    }
  }
  
  /* Keyboard handling */
  @media (max-width: 640px) {
    /* Footer remains sticky even when keyboard opens on mobile */
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('step1Form');
  const continueBtn = document.getElementById('continueBtn');
  
  // Update continue button state
  function updateContinueButton() {
    const tradeType = document.querySelector('input[name="trade_type"]:checked');
    const propertyType = document.querySelector('input[name="property_type"]:checked');
    const cityVal = (document.getElementById('cityInput')?.value || '').trim();
    continueBtn.disabled = !tradeType || !propertyType || !cityVal;
  }
  
  // Event listeners
  document.querySelectorAll('input[name="trade_type"], input[name="property_type"]').forEach(input => {
    input.addEventListener('change', updateContinueButton);
  });
  
  // Keyboard handling for mobile
  ['focusin', 'focusout'].forEach(ev => {
    document.addEventListener(ev, (e) => {
      const t = e.target;
      const isInput = t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA');
      if (isInput && ev === 'focusin') document.body.classList.add('kb-open');
      if (isInput && ev === 'focusout') document.body.classList.remove('kb-open');
    });
  });
  
  // Initial state
  updateContinueButton();
  // City single-select integration
  (function(){
    const CITY_OBJ_KEY = 'vinor_city_obj';
    const EVT_NAME = 'vinor:city-changed';
    const chip = document.getElementById('cityChip');
    const label = document.getElementById('cityChipLabel');
    const input = document.getElementById('cityInput');
    const warn = document.getElementById('cityWarn');
    const clearBtn = document.getElementById('cityClear');

    function setState(display, value, valid){
      if (label) label.textContent = display || 'انتخاب شهر';
      if (input) input.value = value || '';
      if (warn) warn.classList.toggle('hidden', !!valid);
      updateContinueButton();
    }

    function applyFromStorage(){
      try{
        const obj = JSON.parse(localStorage.getItem(CITY_OBJ_KEY) || 'null');
        if (obj && obj.city) { setState(obj.city, obj.city, true); return; }
        if (obj && Array.isArray(obj.cities)){
          if (obj.cities.length === 1){ setState(obj.cities[0], obj.cities[0], true); return; }
          if (obj.cities.length > 1){ setState('انتخاب شهر', '', false); return; }
        }
        if (obj && obj.province && obj.allProvince){ setState('انتخاب شهر', '', false); return; }
      }catch(_){ }
      setState('انتخاب شهر', '', false);
    }

    function gotoPicker(){
      try{
        const url = new URL("{{ url_for('main.city_select') }}", window.location.origin);
        url.searchParams.set('next', window.location.href);
        window.location.href = url.toString();
      }catch(_){ window.location.href = "{{ url_for('main.city_select') }}"; }
    }

    chip?.addEventListener('click', (e)=>{ e.preventDefault(); gotoPicker(); });
    clearBtn?.addEventListener('click', (e)=>{ e.preventDefault(); setState('انتخاب شهر','',false); });
    document.addEventListener(EVT_NAME, applyFromStorage);
    window.addEventListener('storage', (e)=>{ if (e.key === 'vinor_city_obj') applyFromStorage(); });
    applyFromStorage();
  })();
});
</script>
{% endblock %}