{% extends "base.html" %}
{% set hide_header = True %}

{% block title %}ثبت آگهی - مرحله ۱{% endblock %}

{% block content %}
{% block floating_action %}{% endblock %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 pb-20 sm:pb-0">
  <!-- Header (consistent with other steps) -->
  <div class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700 fixed top-0 inset-x-0 z-20 px-4 sm:px-6 lg:px-8">
    <div class="py-3 flex items-center justify-between">
      <a href="{{ url_for('main.index') }}" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white" aria-label="بازگشت">
        <i class="fas fa-arrow-right text-lg"></i>
      </a>
      <h1 class="text-lg font-bold text-gray-900 dark:text-white">مرحله ۱ از ۴</h1>
      <div class="w-6"></div>
    </div>
    <!-- Progress Bar -->
    <div class="pb-3">
      <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-2">
        <span>انتخاب دسته و موقعیت</span>
        <span>۲۵٪</span>
      </div>
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
        <div class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
      </div>
    </div>
  </div>

  <!-- Spacer for fixed header height -->
  <div class="h-24"></div>

  <!-- Main Content -->
  <div class="px-4 py-6">
    <form id="step1Form" method="POST" action="{{ url_for('main.add_land_step1') }}">
      {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      <input type="hidden" name="trade_type" id="trade_type" value="">
      <input type="hidden" name="property_type" id="property_type" value="">
      <input type="hidden" name="_has_locations" value="{% if locations %}1{% else %}0{% endif %}">

      <!-- Category grid -->
      <section class="mt-2">
        <div class="mb-2 text-sm text-gray-600 dark:text-gray-300">ابتدا دسته اصلی را انتخاب کنید</div>
        <div id="catButtonsWrap" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
          <button type="button" data-cat="rent_residential" class="flex items-center justify-between gap-2 px-3 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
            <div class="flex items-center gap-2">
              <i class="fas fa-key text-emerald-600"></i>
              <span class="text-[14px]">اجارهٔ مسکونی</span>
            </div>
          <i class="fas fa-angle-left text-gray-400"></i>
        </button>
          <button type="button" data-cat="sale_residential" class="flex items-center justify-between gap-2 px-3 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
            <div class="flex items-center gap-2">
              <i class="fas fa-sign-hanging text-emerald-600"></i>
              <span class="text-[14px]">فروش مسکونی</span>
            </div>
          <i class="fas fa-angle-left text-gray-400"></i>
        </button>
          <button type="button" data-cat="sale_office" class="flex items-center justify-between gap-2 px-3 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
            <div class="flex items-center gap-2">
              <i class="fas fa-briefcase text-emerald-600"></i>
              <span class="text-[14px]">فروش اداری/تجاری</span>
            </div>
          <i class="fas fa-angle-left text-gray-400"></i>
        </button>
          <button type="button" data-cat="rent_office" class="flex items-center justify-between gap-2 px-3 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
            <div class="flex items-center gap-2">
              <i class="fas fa-building text-emerald-600"></i>
              <span class="text-[14px]">اجاره اداری/تجاری</span>
            </div>
          <i class="fas fa-angle-left text-gray-400"></i>
        </button>
          <button type="button" data-cat="project" class="flex items-center justify-between gap-2 px-3 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
            <div class="flex items-center gap-2">
              <i class="fas fa-mountain text-emerald-600"></i>
              <span class="text-[14px]">پروژه‌های ساخت‌وساز</span>
            </div>
          <i class="fas fa-angle-left text-gray-400"></i>
        </button>
          <button type="button" data-cat="short_rent" class="flex items-center justify-between gap-2 px-3 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
            <div class="flex items-center gap-2">
              <i class="fas fa-clock text-emerald-600"></i>
              <span class="text-[14px]">اجارهٔ کوتاه‌مدت</span>
            </div>
          <i class="fas fa-angle-left text-gray-400"></i>
          </button>
        </div>
      </section>

      <!-- Selection summary and city (from city_select) -->
      <div id="selectorsWrap" class="mt-3 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-4 space-y-3">
          <!-- Category/Subcategory summary -->
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-xs text-gray-500 mb-1">انتخاب شما</div>
              <div class="text-sm font-bold text-gray-900 dark:text-white" id="summaryCat">—</div>
              <div class="text-sm text-gray-700 dark:text-gray-300" id="summarySubcat">زیر‌دسته انتخاب نشده</div>
            </div>
            <button id="btnChangeSubcat" type="button" class="px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-600 text-xs hover:bg-gray-50 dark:hover:bg-gray-700 whitespace-nowrap">تغییر زیر‌دسته</button>
          </div>

          <!-- City hint (picked before this step) -->
          <div class="flex items-center justify-between gap-3 p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
            <div class="text-xs text-gray-600 dark:text-gray-300">شهر در گام قبل انتخاب می‌شود.</div>
            <a href="{{ url_for('main.city_select', next=url_for('main.add_land_step1')) }}" class="px-3 py-2 rounded-xl border text-xs hover:bg-gray-50 dark:hover:bg-gray-700">تغییر شهر</a>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Bottom sheet for sub-category (light, accessible) -->
  <div id="sheet" class="fixed inset-0 z-30 hidden">
    <div id="sheetBg" class="absolute inset-0 bg-black/40"></div>
    <div role="dialog" aria-modal="true" aria-labelledby="sheetTitle" class="absolute bottom-0 inset-x-0 bg-white dark:bg-gray-800 rounded-t-2xl border-t border-gray-200 dark:border-gray-700 p-3 shadow-2xl">
      <div class="flex items-center justify-between px-1 py-1">
        <div id="sheetTitle" class="text-sm font-bold"></div>
        <button id="sheetClose" class="p-2 text-gray-500 hover:text-gray-700" aria-label="بستن"><i class="fas fa-times"></i></button>
      </div>
      <div id="sheetItems" class="mt-1 grid grid-cols-2 gap-2"></div>
    </div>
  </div>
</div>

<style>
  /* Mobile optimizations */
  @media (max-width: 640px) {
    .fixed.bottom-0 {
      padding-bottom: env(safe-area-inset-bottom, 12px);
    }
  }
  
  /* Keyboard handling */
  @media (max-width: 640px) {
    /* Footer remains sticky even when keyboard opens on mobile */
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const trade = document.getElementById('trade_type');
  const prop  = document.getElementById('property_type');
  const form  = document.getElementById('step1Form');
  const sheet = document.getElementById('sheet');
  const sheetBg = document.getElementById('sheetBg');
  const sheetClose = document.getElementById('sheetClose');
  const sheetItems = document.getElementById('sheetItems');
  const sheetTitle = document.getElementById('sheetTitle');

  // New dropdown elements
  const selectorsWrap = document.getElementById('selectorsWrap');
  const subcatSelect = document.getElementById('subcatSelect');
  const continueBtn = document.getElementById('continueBtn');
  const locationSelect = null;
  const locationInput = null;
  const locationHidden = null;
  const cityLabel = null;
  const btnChangeSubcat = document.getElementById('btnChangeSubcat');
  const summaryCat = document.getElementById('summaryCat');
  const summarySubcat = document.getElementById('summarySubcat');

  const CATS = {
    rent_residential: {
      title: 'اجارهٔ مسکونی',
      trade: 'rent',
      items: [
        { value: 'apartment', label: 'آپارتمان', icon: 'fa-building' },
        { value: 'apartment', label: 'سوئیت', icon: 'fa-bed' },
        { value: 'apartment', label: 'پنت‌هاوس', icon: 'fa-city' },
        { value: 'apartment', label: 'نوساز', icon: 'fa-star' },
        { value: 'apartment', label: 'قدیمی‌ساز', icon: 'fa-house' },
        { value: 'villa',     label: 'خانه ویلایی', icon: 'fa-home' },
        { value: 'villa',     label: 'باغ‌ویلا', icon: 'fa-tree' }
      ]
    },
    sale_residential: {
      title: 'فروش مسکونی',
      trade: 'sale',
      items: [
        { value: 'apartment', label: 'آپارتمان', icon: 'fa-building' },
        { value: 'apartment', label: 'پنت‌هاوس', icon: 'fa-city' },
        { value: 'villa',     label: 'خانه و ویلا', icon: 'fa-house' },
        { value: 'land',      label: 'زمین مسکونی', icon: 'fa-mountain' }
      ]
    },
    sale_office: {
      title: 'فروش اداری و تجاری',
      trade: 'sale',
      items: [
        { value: 'office', label: 'دفتر اداری', icon: 'fa-briefcase' },
        { value: 'office', label: 'مطب/پزشکی', icon: 'fa-stethoscope' },
        { value: 'office', label: 'فضای آموزشی', icon: 'fa-chalkboard-user' },
        { value: 'shop',   label: 'مغازه و غرفه', icon: 'fa-store' },
        { value: 'shop',   label: 'فروشگاه/کافی‌شاپ', icon: 'fa-mug-hot' }
      ]
    },
    rent_office: {
      title: 'اجارهٔ اداری و تجاری',
      trade: 'rent',
      items: [
        { value: 'office', label: 'دفتر اداری', icon: 'fa-briefcase' },
        { value: 'office', label: 'مطب/پزشکی', icon: 'fa-stethoscope' },
        { value: 'office', label: 'فضای آموزشی', icon: 'fa-chalkboard-user' },
        { value: 'shop',   label: 'مغازه و غرفه', icon: 'fa-store' },
        { value: 'shop',   label: 'کارگاه/انبار سبک', icon: 'fa-warehouse' }
      ]
    },
    project: {
      title: 'پروژه‌های ساخت‌وساز',
      trade: 'sale',
      items: [
        { value: 'land',   label: 'زمین/قطعه', icon: 'fa-mountain' },
        { value: 'garden', label: 'باغ', icon: 'fa-seedling' },
        { value: 'land',   label: 'پیش‌فروش', icon: 'fa-calendar-days' },
        { value: 'land',   label: 'مشارکت در ساخت', icon: 'fa-people-carry' }
      ]
    },
    short_rent: {
      title: 'اجارهٔ کوتاه‌مدت',
      trade: 'rent',
      items: [
        { value: 'apartment', label: 'آپارتمان و سوئیت', icon: 'fa-building' },
        { value: 'villa',     label: 'ویلا و باغ',     icon: 'fa-home' },
        { value: 'office',    label: 'دفتر/فضای آموزشی', icon: 'fa-chalkboard-user' }
      ]
    }
  };

  function openSheet(catKey){
    const cfg = CATS[catKey]; if (!cfg) return;
    // Update summary and show bottom sheet for subcat choices
    summaryCat.textContent = cfg.title;
    summarySubcat.textContent = 'زیر‌دسته انتخاب نشده';
    trade.value = cfg.trade;
    selectorsWrap.classList.remove('hidden');
    sheetTitle.textContent = 'انتخاب زیر‌دسته';
    sheetItems.innerHTML = '';
    cfg.items.forEach(it => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'flex items-center justify-between gap-2 px-3 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600';
      btn.innerHTML = `<div class="flex items-center gap-2"><i class=\"fas ${it.icon} text-emerald-600\"></i><span class=\"text-sm\">${it.label}</span></div><i class=\"fas fa-check text-transparent\"></i>`;
      btn.addEventListener('click', ()=>{
        summarySubcat.textContent = it.label;
        prop.value = it.value;
        sheet.classList.add('hidden');
        updateContinueState();
      });
      sheetItems.appendChild(btn);
    });
    sheet.classList.remove('hidden');
    continueBtn.disabled = true;
  }

  // Change subcategory again
  btnChangeSubcat?.addEventListener('click', ()=>{
    sheet.classList.remove('hidden');
  });

  document.querySelectorAll('[data-cat]').forEach(el => {
    el.addEventListener('click', ()=> openSheet(el.getAttribute('data-cat')));
  });
  // Highlight selected category button
  const catButtonsWrap = document.getElementById('catButtonsWrap');
  catButtonsWrap?.querySelectorAll('[data-cat]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      catButtonsWrap.querySelectorAll('[data-cat]').forEach(b=> b.classList.remove('ring-2','ring-emerald-500'));
      btn.classList.add('ring-2','ring-emerald-500');
    });
  });
  function closeSheet(){ sheet.classList.add('hidden'); }
  sheetBg.addEventListener('click', closeSheet);
  sheetClose.addEventListener('click', closeSheet);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeSheet(); });

  // Enable continue when selections are valid
  // City comes from localStorage set in city_select
  const CITY_KEY = 'vinor_city';
  const CITY_OBJ_KEY = 'vinor_city_obj';
  function getCityFromStorage(){
    try{
      const obj = JSON.parse(localStorage.getItem(CITY_OBJ_KEY) || 'null');
      const label = localStorage.getItem(CITY_KEY) || '';
      return { label: label || (obj && (obj.city || obj.province)) || '', obj };
    }catch(_){ return { label:'', obj:null }; }
  }
  function applyCityLabel(){ /* city is chosen pre-step; no UI binding needed */ }
  function hasValidLocation(){
    const { label } = getCityFromStorage();
    return Boolean(label && label.trim());
  }

  function updateContinueState(){
    const hasSubcat = Boolean(prop && prop.value);
    continueBtn.disabled = !(hasSubcat && hasValidLocation());
  }

  if (subcatSelect) subcatSelect.addEventListener('change', updateContinueState);
  window.addEventListener('storage', (e)=>{ if (e.key === CITY_KEY || e.key === CITY_OBJ_KEY) { updateContinueState(); } });
  document.addEventListener('vinor:city-changed', ()=>{ updateContinueState(); });

  // Submit handler
  continueBtn.addEventListener('click', function(){
    if (!prop.value || !hasValidLocation()) return;
    form.submit();
  });

  // Initial city label
  // city already selected on prior page
});
</script>
  <!-- Bottom Action Bar -->
  <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 px-4 py-3 sm:static sm:border-t-0 sm:bg-transparent sm:dark:bg-transparent">
    <div class="flex items-center gap-3">
      <a href="{{ url_for('main.index') }}" class="flex-1 px-4 py-3 text-center text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
        بازگشت
      </a>
      <button id="continueBtn" type="button" class="flex-1 px-4 py-3 text-center text-white bg-emerald-500 rounded-xl font-medium hover:bg-emerald-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors" disabled>
        ادامه
      </button>
    </div>
  </div>
</div>
{% endblock %}