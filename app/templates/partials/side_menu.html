{# side_menu.html - Vinor | Mobile-first, final (بدون خانه و جستجو) #}
{% macro MenuItem(href, icon, text, require_login=False, badge=None) -%}
  <a href="{{ href }}"
     class="group flex items-center gap-3 p-3 rounded-xl transition
            hover:bg-green-100 dark:hover:bg-green-800 active:scale-[0.98]
            {{ 'require-login' if require_login else '' }}"
     data-require-login="{{ '1' if require_login else '0' }}">
    <i class="fas {{ icon }} text-lg text-green-600 dark:text-green-400"></i>
    <span class="text-[15px] font-medium text-gray-800 dark:text-gray-100">{{ text }}</span>
    {% if badge is not none and badge|int > 0 %}
      <span class="ms-auto inline-flex items-center justify-center min-w-5 h-5 px-2 text-[11px] rounded-full
                   bg-red-500 text-white">{{ badge }}</span>
    {% endif %}
  </a>
{%- endmacro %}

<!-- Overlay (فقط موبایل) -->
<div id="menuOverlay"
     class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-200 sm:hidden"></div>

<aside id="sideMenu"
       class="fixed top-0 right-0 z-50 h-full w-[88vw] max-w-80 sm:w-72
              bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-700
              shadow-2xl transition-transform duration-300 ease-out
              flex flex-col">
  <!-- Header -->
  <header class="shrink-0 sticky top-0 px-3 py-3 bg-white/90 dark:bg-gray-900/90 backdrop-blur
                 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <!-- فقط آیکن پروفایل (لینک‌دار) -->
      <a href="{{ url_for('main.profile') if session.get('user_phone') else url_for('main.login') }}"
         class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition"
         title="{{ 'پروفایل من' if session.get('user_phone') else 'ورود / ثبت‌نام' }}"
         aria-label="{{ 'پروفایل من' if session.get('user_phone') else 'ورود / ثبت‌نام' }}">
        <i class="fas fa-user-circle text-green-600 dark:text-green-400 text-2xl"></i>
      </a>

      <div class="flex items-center gap-2">
        <!-- Notifications icon with badge (زنده) -->
        <a id="notifLink"
           href="{{ url_for('main.notifications') if session.get('user_phone') else url_for('main.login') }}"
           class="relative p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition
                  {{ '' if session.get('user_phone') else 'require-login' }}"
           title="اعلان‌ها" aria-label="اعلان‌ها"
           data-require-login="{{ '0' if session.get('user_phone') else '1' }}">
          <i class="fas fa-bell text-[18px] text-gray-700 dark:text-gray-200"></i>
          <!-- Badge همیشه رندر می‌شود، با JS مقدار می‌گیرد -->
          <span id="notif-badge"
                class="hidden absolute -top-1 -left-1 min-w-5 h-5 px-1 rounded-full bg-red-500 text-white text-[10px] flex items-center justify-center">
            0
          </span>
        </a>

        {% if VINOR_IS_EXPRESS_PARTNER %}
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-green-100 text-green-700 text-[11px]">
          <i class="fas fa-star"></i>
          همکار اکسپرس
        </span>
        {% endif %}
      </div>
    </div>
  </header>

  <!-- Body -->
  <div class="flex-1 overflow-y-auto p-3 space-y-2">

    <!-- Primary actions (Express Partner unified) -->
    <div class="space-y-2">
      {% set __logged_in = session.get('user_phone') %}
      {% if VINOR_IS_EXPRESS_PARTNER %}
        <a href="{{ url_for('express_partner.dashboard') }}"
           class="group flex items-center gap-3 p-3 rounded-xl transition hover:bg-violet-100 dark:hover:bg-violet-900/40 active:scale-[0.98] require-login"
           data-require-login="1">
          <i class="fas fa-rocket text-lg text-violet-600 dark:text-violet-400"></i>
          <span class="text-[15px] font-semibold text-violet-700 dark:text-violet-300">ورود به پنل همکار اکسپرس</span>
        </a>
      {% elif __logged_in %}
        {{ MenuItem(url_for('express_partner.apply_step1'),  'fa-star',  'درخواست همکاری وینور اکسپرس', True) }}
      {% else %}
        {{ MenuItem(url_for('express_partner.login'),  'fa-right-to-bracket',  'ورود همکار اکسپرس', False) }}
      {% endif %}
    </div>

    <hr class="border-gray-200 dark:border-gray-700 my-2">

    <!-- User bundle -->
    <div class="space-y-2">
      {{ MenuItem(url_for('main.my_lands'),   'fa-list',      'آگهی‌های من', True) }}
      {{ MenuItem(url_for('main.favorites'),  'fa-bookmark',  'آگهی‌های ذخیره‌شده', True) }}
      {# Express Partner item در بالا در بخش Primary قرار گرفت #}
      {{ MenuItem(url_for('main.help'),   'fa-life-ring',    'راهنما', False) }}
      {{ MenuItem(url_for('main.settings'),   'fa-cog',    'تنظیمات', True) }}
      <button id="updateAppBtn" 
              class="group flex items-center gap-3 p-3 rounded-xl transition
                     hover:bg-blue-100 dark:hover:bg-blue-800 active:scale-[0.98]
                     w-full text-right"
              title="بروزرسانی اپلیکیشن">
        <i class="fas fa-sync-alt text-lg text-blue-600 dark:text-blue-400"></i>
        <span class="text-[15px] font-medium text-gray-800 dark:text-gray-100">بروزرسانی</span>
        <span id="updateBadge" class="hidden ms-auto inline-flex items-center justify-center min-w-5 h-5 px-1.5 text-[10px] rounded-full bg-red-500 text-white">جدید</span>
      </button>
    </div>

    <!-- Auth: فقط دکمه ورود برای مهمان؛ خروج از منو حذف شد (در پروفایل موجود است) -->
    <div class="pt-2">
      {% if not session.get('user_phone') %}
        <a href="{{ url_for('main.login') }}"
           class="flex items-center gap-3 p-3 rounded-xl text-green-700 hover:bg-green-100 dark:hover:bg-green-800">
          <i class="fas fa-sign-in-alt"></i>
          <span class="text-[15px] font-medium">ورود / ثبت‌نام</span>
        </a>
      {% endif %}
    </div>

  </div>

  
</aside>

<script>
  (function () {
    const sideMenu     = document.getElementById('sideMenu');
    const overlay      = document.getElementById('menuOverlay');
    const closeBtn     = document.getElementById('closeMenu');
    const notifBadge   = document.getElementById('notif-badge');

    // Open/Close
    const openMenu = () => {
      sideMenu?.classList.add('open');
      overlay?.classList.remove('pointer-events-none');
      overlay?.classList.add('opacity-100');
      document.body.style.overflow = 'hidden';
    };
    const closeMenu = () => {
      sideMenu?.classList.remove('open');
      overlay?.classList.add('pointer-events-none');
      overlay?.classList.remove('opacity-100');
      document.body.style.overflow = '';
    };
    window.openSideMenu = openMenu;
    overlay?.addEventListener('click', closeMenu);
    closeBtn?.addEventListener('click', closeMenu);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });

    // بستن منو بعد از کلیک روی هر لینک (برای UX بهتر در موبایل)
    document.querySelectorAll('#sideMenu a').forEach(a => {
      a.addEventListener('click', () => setTimeout(closeMenu, 0));
    });

    // Require-login guard (برای لینک‌های حساس از جمله اعلان‌ها)
    document.querySelectorAll('#sideMenu a.require-login, #sideMenu a[data-require-login="1"]').forEach(a => {
      a.addEventListener('click', (e) => {
        const loggedIn = {{ 'true' if session.get('user_phone') else 'false' }};
        if (!loggedIn) {
          e.preventDefault();
          window.location.href = "{{ url_for('main.login') }}";
        }
      });
    });

    // Web Share + WhatsApp text
    const btnShare   = document.getElementById('qaShare');
    const aWhatsapp  = document.getElementById('qaWhatsapp');
    const shareTitle = document.title || 'وینور | خرید و فروش ملک';
    const shareUrl   = window.location.href;
    const shareText  = (aWhatsapp?.dataset.waText) || 'وینور | خرید و فروش ملک';

    if (aWhatsapp) {
      const wa = aWhatsapp.dataset.wa || '';
      const url = new URL(`https://wa.me/${wa}`);
      url.searchParams.set('text', `${shareText} — ${shareTitle}\n${shareUrl}`);
      aWhatsapp.href = url.toString();
    }

    btnShare?.addEventListener('click', async () => {
      const data = { title: shareTitle, text: shareText, url: shareUrl };
      try {
        if (navigator.share) {
          await navigator.share(data);
        } else {
          await navigator.clipboard.writeText(shareUrl);
          const t = document.createElement('div');
          t.textContent = 'لینک کپی شد ✅';
          t.dir = 'rtl';
          t.className = 'fixed bottom-16 inset-x-0 mx-auto w-fit px-3 py-2 rounded-lg text-sm bg-green-600 text-white shadow z-[60]';
          document.body.appendChild(t);
          setTimeout(() => t.remove(), 1800);
        }
      } catch (_) {}
    }, { passive: true });

    // (City chip removed)

    // Help accordion toggle
    const helpToggle = document.getElementById('helpToggle');
    const helpPanel  = document.getElementById('helpPanel');
    const helpCaret  = document.getElementById('helpCaret');
    const setHelpOpen = (open) => {
      helpPanel.style.maxHeight = open ? helpPanel.scrollHeight + 'px' : '0px';
      helpToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      if (helpCaret) {
        helpCaret.classList.toggle('fa-rotate-180', open);
      }
    };
    let helpOpen = true;
    setHelpOpen(true);
    helpToggle?.addEventListener('click', () => {
      helpOpen = true;
      setHelpOpen(true);
    });

    // ===== Notifications Badge (زنده) =====
    async function refreshNotifBadge(){
      try{
        const r = await fetch("{{ url_for('main.api_notifications_unread_count') }}", { credentials: 'same-origin' });
        const j = await r.json();
        if(!notifBadge) return;
        const c = parseInt(j.count || 0, 10);
        if(c > 0){
          notifBadge.textContent = c > 99 ? '99+' : String(c);
          notifBadge.classList.remove('hidden');
        } else {
          notifBadge.classList.add('hidden');
        }
      } catch(e){
        // سکوت: خطای شبکه‌ای نادیده گرفته می‌شود
      }
    }
    const loggedIn = {{ 'true' if session.get('user_phone') else 'false' }};
    if (loggedIn) {
      window.addEventListener('load', refreshNotifBadge);
      document.addEventListener('visibilitychange', () => { if (!document.hidden) refreshNotifBadge(); });
      setInterval(refreshNotifBadge, 60000); // هر ۶۰ ثانیه
    }
    // ================================

    // ===== Service Worker Update Check =====
    const updateAppBtn = document.getElementById('updateAppBtn');
    const updateBadge = document.getElementById('updateBadge');
    let updateAvailable = false;
    let updateWaitingSW = null;

    async function checkForUpdate(){
      if (!('serviceWorker' in navigator)) return;
      try {
        const reg = await navigator.serviceWorker.getRegistration('/');
        if (!reg) return;
        await reg.update();
        // If a waiting worker exists, show badge
        if (reg.waiting) {
          updateAvailable = true;
          updateWaitingSW = reg.waiting;
          if (updateBadge) updateBadge.classList.remove('hidden');
          return;
        }
        // If an installing worker is present, wait for it to reach installed
        if (reg.installing){
          const w = reg.installing;
          w.addEventListener('statechange', () => {
            if (w.state === 'installed' && reg.waiting){
              updateAvailable = true;
              updateWaitingSW = reg.waiting;
              if (updateBadge) updateBadge.classList.remove('hidden');
            }
          });
          return;
        }
        // Otherwise hide badge
        {
          updateAvailable = false;
          updateWaitingSW = null;
          if (updateBadge) updateBadge.classList.add('hidden');
        }
      } catch(_) {}
    }

    async function applyUpdate(){
      try {
        updateAppBtn.disabled = true;
        const span = updateAppBtn.querySelector('span');
        if (span) span.textContent = 'در حال بررسی بروزرسانی...';

        const reg = await navigator.serviceWorker.getRegistration('/');
        if (!reg) throw new Error('no-registration');
        await reg.update();

        // If we already have a waiting worker, activate it
        if (reg.waiting) {
          updateWaitingSW = reg.waiting;
        } else if (reg.installing) {
          // Wait briefly for installing to become installed
          await new Promise((resolve) => {
            const w = reg.installing;
            const onState = () => {
              if (w.state === 'installed') resolve(undefined);
            };
            w.addEventListener('statechange', onState);
            setTimeout(resolve, 2500);
          });
          if (reg.waiting) updateWaitingSW = reg.waiting;
        }

        if (updateWaitingSW) {
          if (span) span.textContent = 'در حال بروزرسانی...';
          updateWaitingSW.postMessage({ type: 'SKIP_WAITING' });
          setTimeout(() => { window.location.reload(); }, 600);
          return;
        }

        // No update available – show a small toast
        if (span) span.textContent = 'بروزرسانی';
        updateAppBtn.disabled = false;
        try {
          const t = document.createElement('div');
          t.textContent = 'اپ شما بهروز است';
          t.dir = 'rtl';
          t.className = 'fixed bottom-16 inset-x-0 mx-auto w-fit px-3 py-2 rounded-lg text-sm bg-gray-800 text-white shadow z-[60]';
          document.body.appendChild(t);
          setTimeout(() => t.remove(), 1700);
        } catch(_) {}
      } catch(e) {
        console.error('Update failed:', e);
        updateAppBtn.disabled = false;
        try {
          const t = document.createElement('div');
          t.textContent = 'خطا در بروزرسانی. صفحه را رفرش کنید';
          t.dir = 'rtl';
          t.className = 'fixed bottom-16 inset-x-0 mx-auto w-fit px-3 py-2 rounded-lg text-sm bg-rose-600 text-white shadow z-[60]';
          document.body.appendChild(t);
          setTimeout(() => t.remove(), 2000);
        } catch(_) { alert('خطا در بروزرسانی. لطفاً صفحه را رفرش کنید.'); }
      }
    }

    updateAppBtn?.addEventListener('click', applyUpdate);

    // Check for updates on load and periodically
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', checkForUpdate);
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && navigator.onLine) checkForUpdate();
      });
      setInterval(checkForUpdate, 300000); // هر ۵ دقیقه
      
      // Listen for update available event from base.html
      window.addEventListener('vinor:sw-update-available', checkForUpdate);
      // Listen for update completed event
      window.addEventListener('vinor:sw-updated', () => {
        if (updateBadge) updateBadge.classList.add('hidden');
        updateAvailable = false;
        updateWaitingSW = null;
      });
    }
    // ================================

  })();
</script>
