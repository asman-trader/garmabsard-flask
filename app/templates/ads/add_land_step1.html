{% extends "base.html" %}
{% set hide_header = True %}

{% block title %}ثبت آگهی - مرحله ۱{% endblock %}

{% block content %}
{% block floating_action %}{% endblock %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 pb-20 sm:pb-0">
  <!-- Header (consistent with other steps) -->
  <div class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700 fixed top-0 inset-x-0 z-20 px-4 sm:px-6 lg:px-8">
    <div class="py-3 flex items-center justify-between">
      <a href="{{ url_for('main.index') }}" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white" aria-label="بازگشت">
        <i class="fas fa-arrow-right text-lg"></i>
      </a>
      <h1 class="text-lg font-bold text-gray-900 dark:text-white">مرحله ۱ از ۵</h1>
      <div class="w-6"></div>
    </div>
    <!-- Progress Bar -->
    <div class="pb-3">
      <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-2">
        <span>انتخاب دسته</span>
        <span>۲۰٪</span>
      </div>
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
        <div class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 20%"></div>
      </div>
    </div>
  </div>

  <!-- Spacer for fixed header height -->
  <div class="h-24"></div>

  <!-- Main Content -->
  <div class="px-4 py-6">
    <form id="step1Form" method="POST" action="{{ url_for('main.add_land_step1') }}">
      {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      <input type="hidden" name="trade_type" id="trade_type" value="">
      <input type="hidden" name="property_type" id="property_type" value="">
      <input type="hidden" name="_has_locations" value="{% if locations %}1{% else %}0{% endif %}">

      <!-- Category grid -->
      <section class="mt-2">
        <div class="mb-3 text-sm text-gray-600 dark:text-gray-300">ابتدا دسته اصلی را انتخاب کنید</div>
        <div id="catButtonsWrap" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2">
          {% for cat_id, cat_data in categories.items() %}
          <button type="button" data-cat="{{ cat_id }}" class="flex flex-col items-center justify-center gap-2 px-3 py-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-emerald-500 transition-all">
            <i class="fas {{ cat_data.icon }} text-emerald-600 text-xl"></i>
            <span class="text-[13px] font-medium text-center">{{ cat_data.title }}</span>
            <span class="text-[10px] text-gray-400 dark:text-gray-500 text-center hidden sm:block">{{ cat_data.description[:20] }}...</span>
          </button>
          {% endfor %}
        </div>
      </section>

      <!-- Selection summary and city (from city_select) -->
      <div id="selectorsWrap" class="mt-3 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-4 space-y-3">
          <!-- Category/Subcategory summary -->
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-xs text-gray-500 mb-1">انتخاب شما</div>
              <div class="text-sm font-bold text-gray-900 dark:text-white" id="summaryCat">—</div>
              <div class="text-sm text-gray-700 dark:text-gray-300" id="summarySubcat">زیر‌دسته انتخاب نشده</div>
            </div>
            <button id="btnChangeSubcat" type="button" class="px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-600 text-xs hover:bg-gray-50 dark:hover:bg-gray-700 whitespace-nowrap">تغییر زیر‌دسته</button>
          </div>

          
        </div>
      </div>
    </form>
  </div>

  <!-- Bottom sheet for sub-category (light, accessible) -->
  <div id="sheet" class="fixed inset-0 z-30 hidden">
    <div id="sheetBg" class="absolute inset-0 bg-black/40"></div>
    <div role="dialog" aria-modal="true" aria-labelledby="sheetTitle" class="absolute bottom-0 inset-x-0 bg-white dark:bg-gray-800 rounded-t-2xl border-t border-gray-200 dark:border-gray-700 p-3 shadow-2xl">
      <div class="flex items-center justify-between px-1 py-1">
        <div id="sheetTitle" class="text-sm font-bold"></div>
        <button id="sheetClose" class="p-2 text-gray-500 hover:text-gray-700" aria-label="بستن"><i class="fas fa-times"></i></button>
      </div>
      <div id="sheetItems" class="mt-1 grid grid-cols-2 gap-2 max-h-[60vh] overflow-y-auto"></div>
    </div>
  </div>
</div>

<style>
  /* Mobile optimizations */
  @media (max-width: 640px) {
    .fixed.bottom-0 {
      padding-bottom: env(safe-area-inset-bottom, 12px);
    }
  }
  
  /* Keyboard handling */
  @media (max-width: 640px) {
    /* Footer remains sticky even when keyboard opens on mobile */
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const trade = document.getElementById('trade_type');
  const prop  = document.getElementById('property_type');
  const form  = document.getElementById('step1Form');
  const sheet = document.getElementById('sheet');
  const sheetBg = document.getElementById('sheetBg');
  const sheetClose = document.getElementById('sheetClose');
  const sheetItems = document.getElementById('sheetItems');
  const sheetTitle = document.getElementById('sheetTitle');

  // New dropdown elements
  const selectorsWrap = document.getElementById('selectorsWrap');
  const subcatSelect = document.getElementById('subcatSelect');
  const continueBtn = document.getElementById('continueBtn');
  const locationSelect = null;
  const locationInput = null;
  const locationHidden = null;
  const cityLabel = null;
  const btnChangeSubcat = document.getElementById('btnChangeSubcat');
  const summaryCat = document.getElementById('summaryCat');
  const summarySubcat = document.getElementById('summarySubcat');

  // ساختار دسته‌بندی از سرور
  const CATEGORIES = {{ categories | tojson }};
  
  let currentCategoryId = null;
  let currentSubcategoryId = null;
  let currentItem = null;

  function openSheet(catId){
    const cat = CATEGORIES[catId];
    if (!cat) return;
    
    currentCategoryId = catId;
    currentSubcategoryId = null;
    currentItem = null;
    
    summaryCat.textContent = cat.title;
    summarySubcat.textContent = 'زیر‌دسته انتخاب نشده';
    selectorsWrap.classList.remove('hidden');
    sheetTitle.textContent = `انتخاب زیر‌دسته - ${cat.title}`;
    sheetItems.innerHTML = '';
    
    const subcats = cat.subcategories || {};
    const subcatKeys = Object.keys(subcats);
    
    if (subcatKeys.length === 0) {
      // اگر زیردسته‌ای نیست، مستقیماً ادامه بده
      prop.value = catId;
      sheet.classList.add('hidden');
      updateContinueState();
      return;
    }
    
    // نمایش زیردسته‌ها
    subcatKeys.forEach(subcatKey => {
      const subcat = subcats[subcatKey];
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'flex items-center justify-between gap-2 px-3 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600';
      btn.innerHTML = `<div class="flex items-center gap-2"><i class="fas ${subcat.icon || 'fa-circle'} text-emerald-600"></i><span class="text-sm">${subcat.title}</span></div><i class="fas fa-angle-left text-gray-400"></i>`;
      btn.addEventListener('click', ()=>{
        currentSubcategoryId = subcatKey;
        handleSubcategorySelect(catId, subcatKey, subcat);
      });
      sheetItems.appendChild(btn);
    });
    
    sheet.classList.remove('hidden');
    continueBtn.disabled = true;
  }
  
  function handleSubcategorySelect(catId, subcatId, subcat){
    summarySubcat.textContent = subcat.title;
    
    const items = subcat.items || [];
    if (items.length === 0) {
      // اگر آیتمی ندارد، مستقیماً انتخاب کن
      prop.value = `${catId}_${subcatId}`;
      sheet.classList.add('hidden');
      updateContinueState();
      return;
    }
    
    // نمایش آیتم‌های زیردسته
    sheetTitle.textContent = `انتخاب ${subcat.title}`;
    sheetItems.innerHTML = '';
    
    items.forEach((item, index) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'flex items-center justify-between gap-2 px-3 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600';
      btn.innerHTML = `<div class="flex items-center gap-2"><span class="text-sm">${item}</span></div><i class="fas fa-check text-transparent"></i>`;
      btn.addEventListener('click', ()=>{
        currentItem = item;
        summarySubcat.textContent = `${subcat.title} - ${item}`;
        // استفاده از index برای جلوگیری از مشکل با فاصله و کاراکترهای خاص
        prop.value = `${catId}_${subcatId}_${index}`;
        // همچنین یک data attribute برای ذخیره متن واقعی آیتم
        prop.setAttribute('data-item-text', item);
        sheet.classList.add('hidden');
        updateContinueState();
      });
      sheetItems.appendChild(btn);
    });
  }

  // Change subcategory again
  btnChangeSubcat?.addEventListener('click', ()=>{
    if (currentCategoryId) {
      openSheet(currentCategoryId);
    }
  });

  document.querySelectorAll('[data-cat]').forEach(el => {
    el.addEventListener('click', ()=> openSheet(el.getAttribute('data-cat')));
  });
  // Highlight selected category button
  const catButtonsWrap = document.getElementById('catButtonsWrap');
  catButtonsWrap?.querySelectorAll('[data-cat]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      catButtonsWrap.querySelectorAll('[data-cat]').forEach(b=> b.classList.remove('ring-2','ring-emerald-500'));
      btn.classList.add('ring-2','ring-emerald-500');
    });
  });
  function closeSheet(){ sheet.classList.add('hidden'); }
  sheetBg.addEventListener('click', closeSheet);
  sheetClose.addEventListener('click', closeSheet);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeSheet(); });

  // Enable continue when selections are valid
  // City comes from localStorage set in city_select
  const CITY_KEY = 'vinor_city';
  const CITY_OBJ_KEY = 'vinor_city_obj';
  function getCityFromStorage(){
    try{
      const obj = JSON.parse(localStorage.getItem(CITY_OBJ_KEY) || 'null');
      const label = localStorage.getItem(CITY_KEY) || '';
      return { label: label || (obj && (obj.city || obj.province)) || '', obj };
    }catch(_){ return { label:'', obj:null }; }
  }
  function applyCityLabel(){ /* city is chosen pre-step; no UI binding needed */ }
  function hasValidLocation(){ return true; }

  function updateContinueState(){
    const hasSubcat = Boolean(prop && prop.value);
    continueBtn.disabled = !hasSubcat;
  }

  if (subcatSelect) subcatSelect.addEventListener('change', updateContinueState);
  window.addEventListener('storage', (e)=>{ if (e.key === CITY_KEY || e.key === CITY_OBJ_KEY) { updateContinueState(); } });
  document.addEventListener('vinor:city-changed', ()=>{ updateContinueState(); });

  // Persist draft v2 (category + city)
  function saveDraftV2(){
    try{
      const city = (localStorage.getItem('vinor_city')||'');
      const draft = JSON.parse(localStorage.getItem('adFormDraftV2')||'{}');
      draft.trade_type = trade.value || draft.trade_type || '';
      draft.property_type = prop.value || draft.property_type || '';
      draft.city = draft.city || city;
      localStorage.setItem('adFormDraftV2', JSON.stringify(draft));
    }catch(_){ }
  }

  // Submit handler
  continueBtn.addEventListener('click', function(){
    if (!prop.value) return;
    saveDraftV2();
    form.submit();
  });

  // Initial store
  saveDraftV2();
});
</script>
  <!-- Bottom Action Bar -->
  <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 px-4 py-3 sm:static sm:border-t-0 sm:bg-transparent sm:dark:bg-transparent">
    <div class="flex items-center gap-3">
      <button id="continueBtn" type="button" class="flex-1 px-4 py-3 text-center text-white bg-emerald-500 rounded-xl font-medium hover:bg-emerald-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors" disabled>
        ادامه
      </button>
    </div>
  </div>
</div>
{% endblock %}