{% extends 'express_partner/base.html' %}
{% block title %}ویرایش پروفایل{% endblock %}
{% block content %}

<header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
  <div class="w-full px-4 h-14 flex items-center justify-between">
    <a href="{{ url_for('express_partner.profile') }}" class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="بازگشت">
      <i class="fas fa-arrow-right text-gray-600 dark:text-gray-400"></i>
    </a>
    <h1 class="text-sm font-bold text-gray-900 dark:text-white">ویرایش پروفایل</h1>
    <div class="w-9"></div>
  </div>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="px-4 py-2">
    {% for category, message in messages %}
      <div class="text-xs rounded-lg px-3 py-2
                  {% if category == 'success' %}bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800
                  {% elif category == 'error' or category == 'danger' %}bg-rose-50 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300 border border-rose-200 dark:border-rose-800
                  {% else %}bg-gray-50 text-gray-700 dark:bg-gray-800 dark:text-gray-300 border border-gray-200 dark:border-gray-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}
</header>

<div class="max-w-3xl mx-auto pt-0 px-4 pb-16">
  <!-- Avatar change (Divar-style minimal) -->
  <form id="avatarEditForm" method="post" action="{{ url_for('express_partner.profile_avatar_upload') }}" enctype="multipart/form-data" class="mt-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="next" value="{{ url_for('express_partner.profile_edit') }}">
    <input id="avatarEditInput" name="avatar" type="file" accept="image/*" class="hidden" />
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <button type="button" id="avatarEditTrigger"
                class="w-14 h-14 rounded-full bg-gray-100 dark:bg-gray-800 overflow-hidden flex items-center justify-center ring-1 ring-inset ring-gray-200 dark:ring-gray-700 hover:ring-gray-300 dark:hover:ring-gray-600 transition"
                title="تغییر عکس پروفایل">
          {% if profile and profile.get('avatar') %}
            <img src="/uploads/{{ profile.get('avatar') }}?v={{ profile.get('avatar_updated_at', 0) }}"
                 alt="عکس پروفایل"
                 class="w-full h-full object-cover" referrerpolicy="no-referrer" />
          {% else %}
            <span class="text-gray-600 dark:text-gray-400 text-lg font-semibold">
              {{ (me_name or (me_phone or '')[-4:])[:2] }}
            </span>
          {% endif %}
        </button>
        <div>
          <div class="text-sm font-semibold text-gray-900 dark:text-white">عکس پروفایل</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">برای تغییر، روی عکس ضربه بزنید</div>
        </div>
      </div>
      <button type="button" id="avatarEditBtn"
              class="px-3 py-2 rounded-lg text-xs font-semibold border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
        انتخاب تصویر
      </button>
    </div>
  </form>

  <form method="post" action="{{ url_for('express_partner.profile_edit') }}" class="mt-3 space-y-3 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div>
      <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">نام و نام خانوادگی</label>
      <input type="text" name="name" value="{{ me_name }}"
             class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
             placeholder="مثال: علی رضایی" maxlength="60" />
    </div>

    <div>
      <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">شهر</label>
      <input type="text" name="city" value="{{ me_city }}"
             class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
             placeholder="مثال: تهران" maxlength="40" />
    </div>

    <div>
      <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">درباره من</label>
      <textarea name="bio" rows="4"
                class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                placeholder="توضیحات کوتاه درباره‌ی شما (اختیاری)">{{ me_bio }}</textarea>
    </div>

    <div class="pt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
      <a href="{{ url_for('express_partner.profile') }}"
         class="w-full py-3 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 font-semibold hover:bg-gray-50 dark:hover:bg-gray-800 transition text-center">
        انصراف
      </a>
      <button type="submit"
              class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition">
        ذخیره تغییرات
      </button>
    </div>
  </form>

  {% set bottom_nav_active = 'profile' %}
  {% include 'express_partner/partials/bottom_nav.html' %}
</div>

{% endblock %}

{% block scripts %}
<script>
  (function() {
    const trigger = document.getElementById('avatarEditTrigger');
    const chooseBtn = document.getElementById('avatarEditBtn');
    const input = document.getElementById('avatarEditInput');
    const form = document.getElementById('avatarEditForm');
    function openPicker() { if (input) input.click(); }
    if (trigger) trigger.addEventListener('click', openPicker);
    if (chooseBtn) chooseBtn.addEventListener('click', openPicker);
    if (input && form) {
      input.addEventListener('change', function() {
        if (!input.files || input.files.length === 0) return;
        form.submit();
      });
    }
  })();
</script>
{% endblock %}


