{% extends 'express_partner/base.html' %}
{% block title %}ویرایش پروفایل{% endblock %}
{% block content %}

<header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
  <div class="w-full px-4 h-14 flex items-center justify-between">
    <a href="{{ url_for('express_partner.profile') }}" class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="بازگشت">
      <i class="fas fa-arrow-right text-gray-600 dark:text-gray-400"></i>
    </a>
    <h1 class="text-sm font-bold text-gray-900 dark:text-white">ویرایش پروفایل</h1>
    <div class="w-9"></div>
  </div>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="px-4 py-2">
    {% for category, message in messages %}
      <div class="text-xs rounded-lg px-3 py-2
                  {% if category == 'success' %}bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800
                  {% elif category == 'error' or category == 'danger' %}bg-rose-50 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300 border border-rose-200 dark:border-rose-800
                  {% else %}bg-gray-50 text-gray-700 dark:bg-gray-800 dark:text-gray-300 border border-gray-200 dark:border-gray-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}
</header>

<div class="max-w-3xl mx-auto pt-0 px-4 pb-16">
  <!-- Intro - Divar style -->
  <section class="mt-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <div class="flex items-start gap-3">
      <div class="w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 grid place-items-center flex-shrink-0">
        <i class="fas fa-user-cog"></i>
      </div>
      <div class="flex-1">
        <h2 class="text-sm font-bold text-gray-900 dark:text-white">تنظیمات پروفایل</h2>
        <p class="mt-1 text-xs leading-5 text-gray-600 dark:text-gray-400">
          لطفاً اطلاعات خود را دقیق و خوانا وارد کنید. این اطلاعات در کارت معرفی شما نمایش داده می‌شود.
        </p>
      </div>
    </div>
  </section>

  <!-- Avatar change (Divar-style minimal) -->
  <form id="avatarEditForm" method="post" action="{{ url_for('express_partner.profile_avatar_upload') }}" enctype="multipart/form-data" class="mt-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="next" value="{{ url_for('express_partner.profile_edit') }}">
    <!-- دو ورودی برای موبایل: دوربین و گالری -->
    <input id="avatarInputCamera" name="avatar" type="file" accept="image/*" capture="environment" class="hidden" />
    <input id="avatarInputLibrary" name="avatar" type="file" accept="image/*" class="hidden" />
    <div class="flex items-center sm:items-start gap-4 flex-col sm:flex-row">
      <button type="button" id="avatarEditTrigger"
              class="relative w-24 h-24 sm:w-20 sm:h-20 rounded-full bg-gray-100 dark:bg-gray-800 overflow-hidden flex items-center justify-center mx-auto sm:mx-0 ring-1 ring-inset ring-gray-200 dark:ring-gray-700 hover:ring-gray-300 dark:hover:ring-gray-600 transition"
              title="تغییر عکس پروفایل">
        {% if profile and profile.get('avatar') %}
          <img id="avatarPreviewImg" src="/uploads/{{ profile.get('avatar') }}?v={{ profile.get('avatar_updated_at', 0) }}"
               alt="عکس پروفایل"
               class="w-full h-full object-cover" referrerpolicy="no-referrer" />
        {% else %}
          <span id="avatarPreviewFallback" class="text-gray-600 dark:text-gray-400 text-xl font-semibold">
            {{ (me_name or (me_phone or '')[-4:])[:2] }}
          </span>
        {% endif %}
        <!-- لودر کوچک هنگام آپلود -->
        <div id="avatarUploading" class="hidden absolute inset-0 bg-black/40 flex items-center justify-center">
          <div class="w-7 h-7 rounded-full border-2 border-white/50 border-t-white animate-spin"></div>
        </div>
      </button>
      <div class="flex-1 text-center sm:text-right w-full">
        <div class="text-sm font-semibold text-gray-900 dark:text-white mb-1">عکس پروفایل</div>
        <p class="text-[11px] text-gray-500 dark:text-gray-400 mb-2">تصویر واضح از صورت یا لوگو. اندازه پیشنهادی مربعی (۱:۱).</p>
        
      </div>
    </div>
  </form>

  <form method="post" action="{{ url_for('express_partner.profile_edit') }}" class="mt-3 space-y-3 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div>
      <label class="block text-xs font-medium text-gray-600 dark:text-gray-300">نام و نام خانوادگی</label>
      <p class="mt-1 text-[11px] text-gray-500 dark:text-gray-400">نامی که کاربران می‌بینند. بهتر است واقعی و کامل باشد.</p>
      <input type="text" name="name" value="{{ me_name }}"
             class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
             placeholder="مثال: علی رضایی" maxlength="60" />
    </div>

    <div>
      <label class="block text-xs font-medium text-gray-600 dark:text-gray-300">شهر</label>
      <p class="mt-1 text-[11px] text-gray-500 dark:text-gray-400">شهر فعالیت اصلی شما برای پیشنهادهای دقیق‌تر.</p>
      <select name="city"
              class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
        <option value="">انتخاب شهر</option>
        {% for c in (cities or []) %}
          <option value="{{ c }}" {% if me_city == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="block text-xs font-medium text-gray-600 dark:text-gray-300">درباره من</label>
      <div class="mt-1 text-[11px] text-gray-500 dark:text-gray-400 flex items-center justify-between">
        <span>توضیح کوتاه و حرفه‌ای درباره‌ی شما (حداکثر ۲۰۰ کاراکتر).</span>
        <span id="bioCounter" class="text-gray-400">0/200</span>
      </div>
      <textarea name="bio" id="bioInput" rows="4" maxlength="200"
                class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                placeholder="توضیحات کوتاه درباره‌ی شما (اختیاری)">{{ me_bio }}</textarea>
    </div>

    <div class="pt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
      <a href="{{ url_for('express_partner.profile') }}"
         class="w-full py-3 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 font-semibold hover:bg-gray-50 dark:hover:bg-gray-800 transition text-center">
        انصراف
      </a>
      <button type="submit"
              class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition">
        ذخیره تغییرات
      </button>
    </div>
  </form>

  {% set bottom_nav_active = 'profile' %}
  {% include 'express_partner/partials/bottom_nav.html' %}
</div>

{% endblock %}

{% block scripts %}
<script>
  (function() {
    const trigger = document.getElementById('avatarEditTrigger');
    const openCameraBtn = document.getElementById('openCameraBtn');
    const openLibraryBtn = document.getElementById('openLibraryBtn');
    const inputCamera = document.getElementById('avatarInputCamera');
    const inputLibrary = document.getElementById('avatarInputLibrary');
    const form = document.getElementById('avatarEditForm');
    const uploading = document.getElementById('avatarUploading');
    const previewImg = document.getElementById('avatarPreviewImg');
    const previewFallback = document.getElementById('avatarPreviewFallback');
    const csrfInput = form?.querySelector('input[name="csrf_token"]');
    const nextInput = form?.querySelector('input[name="next"]');

    function openCamera() { inputCamera?.click(); }
    function openLibrary() { inputLibrary?.click(); }
    if (trigger) trigger.addEventListener('click', openLibrary);
    if (openCameraBtn) openCameraBtn.addEventListener('click', openCamera);
    if (openLibraryBtn) openLibraryBtn.addEventListener('click', openLibrary);

    function showUploading(isOn) {
      if (!uploading) return;
      if (isOn) uploading.classList.remove('hidden');
      else uploading.classList.add('hidden');
    }

    function previewFile(file) {
      try {
        const url = URL.createObjectURL(file);
        if (previewImg) {
          previewImg.src = url;
          previewImg.classList.add('object-cover');
        }
        if (previewFallback) previewFallback.style.display = 'none';
      } catch(_) {}
    }

    async function compressImage(file, maxSide = 1200, quality = 0.82) {
      return new Promise((resolve) => {
        try {
          const img = new Image();
          img.onload = function() {
            let w = img.naturalWidth, h = img.naturalHeight;
            if (!w || !h) return resolve(file);
            const scale = Math.min(1, maxSide / Math.max(w, h));
            const cw = Math.round(w * scale);
            const ch = Math.round(h * scale);
            const canvas = document.createElement('canvas');
            canvas.width = cw;
            canvas.height = ch;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, cw, ch);
            canvas.toBlob((blob) => {
              if (blob && blob.size > 0) {
                const out = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });
                resolve(out);
              } else {
                resolve(file);
              }
            }, 'image/jpeg', quality);
          };
          img.onerror = function() { resolve(file); };
          const fr = new FileReader();
          fr.onload = function(e) { img.src = e.target.result; };
          fr.onerror = function() { resolve(file); };
          fr.readAsDataURL(file);
        } catch(_) {
          resolve(file);
        }
      });
    }

    async function uploadFile(file) {
      if (!form) return;
      showUploading(true);
      previewFile(file);
      try {
        const compressed = await compressImage(file);
        const fd = new FormData();
        fd.append('avatar', compressed);
        if (csrfInput) fd.append('csrf_token', csrfInput.value || '');
        if (nextInput) fd.append('next', nextInput.value || '');
        const res = await fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' });
        if (res.ok) {
          window.location.replace(nextInput?.value || window.location.href);
        } else {
          form.submit();
        }
      } catch(_) {
        form.submit();
      } finally {
        showUploading(false);
      }
    }

    function handleFileInput(e) {
      const files = e.target?.files;
      if (!files || !files[0]) return;
      const file = files[0];
      uploadFile(file);
    }
    if (inputCamera) inputCamera.addEventListener('change', handleFileInput);
    if (inputLibrary) inputLibrary.addEventListener('change', handleFileInput);
  })();

  // Bio live counter (Divar style minimal helper)
  (function() {
    const input = document.getElementById('bioInput');
    const counter = document.getElementById('bioCounter');
    if (!input || !counter) return;
    function update() {
      const len = (input.value || '').length;
      counter.textContent = len + '/200';
      // رنگ هشدار نزدیک سقف
      if (len > 180) {
        counter.classList.remove('text-gray-400');
        counter.classList.add('text-rose-500');
      } else {
        counter.classList.add('text-gray-400');
        counter.classList.remove('text-rose-500');
      }
    }
    input.addEventListener('input', update);
    update();
  })();
</script>
{% endblock %}


