{% extends 'express_partner/base.html' %}
{% block title %}پنل همکاری وینور اکسپرس{% endblock %}
{% block content %}

  <!-- Header - سبک دیوار (تمام‌عرض) -->
  <header data-tour="dashboard-header" class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
    <div class="w-full px-4 h-14 flex items-center justify-center">
      <h1 class="text-base sm:text-lg font-extrabold text-gray-900 dark:text-white">
        <span class="text-green-600 dark:text-green-400">وینور</span>
      </h1>
    </div>
  </header>

<div class="max-w-6xl mx-auto pt-0 px-3 sm:px-4 pb-16">

  <!-- کارت آموزش - سرتاسر و با ارتفاع کمتر -->
  <a href="{{ url_for('express_partner.training') }}" 
     data-tour="training-bar"
     class="block mt-2 mb-3 -mx-3 sm:mx-0 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-none sm:rounded-lg py-3 px-4 hover:border-emerald-400 dark:hover:border-emerald-600 hover:shadow-md transition-all duration-200 group">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 flex-1 min-w-0">
        <div class="w-9 h-9 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-graduation-cap text-emerald-600 dark:text-emerald-400 text-base"></i>
        </div>
        <p class="text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate">
          آموزش ۳ مرحله‌ای موفقیت در همکاری
        </p>
      </div>
      <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500 text-xs flex-shrink-0 group-hover:translate-x-[-2px] transition-transform"></i>
    </div>
  </a>

  <style>
    #cardsTrack{
      min-height:calc(100vh - 150px);
    }
    @media (max-width:640px){
      #cardsTrack{
        min-height:calc(100vh - 130px);
      }
    }
    .express-card{
      transition:box-shadow .2s ease, border-color .2s ease;
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .express-card:hover{
      transform:translateY(-1px);
    }
  </style>

  <!-- اعلان‌های سیستم -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="fixed top-20 inset-x-0 z-50 flex flex-col items-center gap-3 px-4 pointer-events-none">
        {% for category, msg in messages %}
          {% set _icon = 'fa-info-circle text-blue-500' %}
          {% if category in ['success', 'ok'] %}
            {% set _icon = 'fa-check-circle text-emerald-500' %}
          {% elif category == 'warning' %}
            {% set _icon = 'fa-exclamation-triangle text-amber-500' %}
          {% elif category in ['danger', 'error', 'alert'] %}
            {% set _icon = 'fa-times-circle text-rose-500' %}
          {% endif %}
          <div x-data="{ show: true }" x-init="setTimeout(() => show = false, 3000)" x-show="show"
               x-transition.opacity.duration.300ms
               class="pointer-events-auto inline-flex items-center gap-3 px-4 py-3 rounded-2xl shadow-lg border backdrop-blur bg-white/90 dark:bg-gray-900/90 text-sm font-medium text-gray-800 dark:text-gray-100 border-gray-200/70 dark:border-gray-700/70">
            <i class="fas {{ _icon }} text-xs"></i>
            <span class="whitespace-nowrap">{{ msg|safe }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if not is_approved %}
    <div class="bg-amber-50 border border-amber-200 text-amber-800 dark:bg-amber-900/20 dark:text-amber-200 dark:border-amber-800/50 p-4 rounded-xl mb-4">
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-5 h-5 rounded-full bg-amber-200 dark:bg-amber-800 flex items-center justify-center mt-0.5">
          <i class="fas fa-clock text-xs text-amber-700 dark:text-amber-300"></i>
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium text-amber-900 dark:text-amber-100 mb-1">در حال بررسی درخواست</p>
          <p class="text-xs text-amber-700 dark:text-amber-300">درخواست همکاری شما در حال بررسی است. پس از تأیید، دسترسی کامل به پنل فعال می‌شود.</p>
        </div>
      </div>
    </div>
  {% endif %}

  {% if expired_count and expired_count > 0 %}
    <div class="bg-red-50 border border-red-200 text-red-800 dark:bg-red-900/20 dark:text-red-200 dark:border-red-800/50 p-4 rounded-xl mb-4">
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-5 h-5 rounded-full bg-red-200 dark:bg-red-800 flex items-center justify-center mt-0.5">
          <i class="fas fa-exclamation-circle text-xs text-red-700 dark:text-red-300"></i>
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium text-red-900 dark:text-red-100 mb-1">اعتبار {{ expired_count }} فایل به پایان رسیده</p>
          <p class="text-xs text-red-700 dark:text-red-300">برخی از فایل‌های ارسالی منقضی شده‌اند. لطفاً با پشتیبانی تماس بگیرید.</p>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Loading skeleton -->
  {% if loading %}
    <div class="space-y-4">
      <div class="h-40 rounded-2xl bg-gray-100 animate-pulse"></div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for i in range(6) %}
          <div class="h-56 rounded-2xl bg-gray-100 animate-pulse"></div>
        {% endfor %}
      </div>
    </div>
  {% else %}

  <!-- Assigned lands -->
  {% if assigned_lands|length == 0 %}
    <div class="mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-8 text-center">
      <div class="flex flex-col items-center gap-3">
        <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
          <i class="fas fa-inbox text-2xl text-gray-400 dark:text-gray-500"></i>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">هنوز فایلی برای شما ارسال نشده</p>
          <p class="text-xs text-gray-500 dark:text-gray-400">پس از ارسال فایل‌ها توسط ادمین، در اینجا نمایش داده می‌شوند.</p>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="mt-2 -mx-3 relative">
    <button type="button" id="cardsPrev" class="hidden sm:flex absolute right-1 top-1/2 -translate-y-1/2 z-10 w-9 h-9 rounded-full bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 shadow items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700">
      <i class="fas fa-chevron-right"></i>
    </button>
    <button type="button" id="cardsNext" class="hidden sm:flex absolute left-1 top-1/2 -translate-y-1/2 z-10 w-9 h-9 rounded-full bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 shadow items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700">
      <i class="fas fa-chevron-left"></i>
    </button>

    <div id="cardsTrack" class="px-3 flex flex-col sm:flex-row sm:flex-nowrap items-stretch gap-4 pb-4 sm:overflow-x-auto sm:snap-x sm:snap-mandatory no-scrollbar">
    {% for land in assigned_lands %}
      <article {% if loop.first %}data-tour="land-card"{% endif %} class="snap-start shrink-0 w-full sm:w-[320px] group express-card relative bg-white dark:bg-gray-900 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md" data-href="{{ url_for('express_partner.land_detail', code=land.code) }}" role="link" tabindex="0">
        {% set img = (land.images[0] if land.images and land.images[0] else None) %}
        {% set _st = (land._assignment_status|default('active')) %}
        
        <!-- Image/Video Section - دیوار استایل -->
        <div class="relative aspect-[4/3] bg-gray-100 dark:bg-gray-800 overflow-hidden">
          {% set video = land.video %}
          {% if video %}
            {% if "://" in (video|string) %}
              {% set video_src = video %}
            {% elif (video|string).startswith('/uploads/') %}
              {% set video_src = video %}
            {% elif (video|string).startswith('uploads/') %}
              {% set video_src = '/uploads/' + (video|string)[8:] %}
            {% elif not (video|string).startswith('/') %}
              {% set video_src = '/uploads/' + (video|string) %}
            {% else %}
              {% set video_src = video %}
            {% endif %}
            <video class="w-full h-full object-cover" autoplay muted loop playsinline>
              <source src="{{ video_src }}" type="video/mp4">
              {% if img %}
                {% if "://" in (img|string) %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('/uploads/') %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('uploads/') %}
                  {% set img_src = '/uploads/' + (img|string)[8:] %}
                {% elif not (img|string).startswith('/') %}
                  {% set img_src = '/uploads/' + (img|string) %}
                {% else %}
                  {% set img_src = img %}
                {% endif %}
                <img src="{{ img_src }}" alt="{{ land.title }}" class="w-full h-full object-cover">
              {% endif %}
            </video>
          {% elif img %}
            {% if "://" in (img|string) %}
              {% set img_src = img %}
            {% elif (img|string).startswith('/uploads/') %}
              {% set img_src = img %}
            {% elif (img|string).startswith('uploads/') %}
              {% set img_src = '/uploads/' + (img|string)[8:] %}
            {% elif not (img|string).startswith('/') %}
              {% set img_src = '/uploads/' + (img|string) %}
            {% else %}
              {% set img_src = img %}
            {% endif %}
            <img src="{{ img_src }}" alt="{{ land.title }}" class="w-full h-full object-cover">
          {% else %}
            <div class="w-full h-full grid place-items-center text-gray-300 dark:text-gray-600">
              <i class="fas fa-image text-3xl"></i>
            </div>
          {% endif %}
          
          <!-- Status Badge - ساده و تمیز -->
          <div class="absolute top-2 left-2 flex flex-col gap-1">
            {% if land._is_expired %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-red-600 text-white">
                <i class="fas fa-exclamation-circle text-[9px] ml-1"></i>
                منقضی شده
              </span>
            {% endif %}
            {% if _st == 'sold' %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-green-600 text-white">
                فروخته شد
              </span>
            {% elif _st == 'in_transaction' %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-orange-500 text-white">
                در حال معامله
              </span>
            {% elif _st == 'closed' %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-gray-700 text-white">
                بسته
              </span>
            {% elif _st == 'pending' %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-yellow-500 text-white">
                در انتظار
              </span>
            {% endif %}
          </div>
        </div>

        <!-- Content Section - سبک دیوار -->
        <div class="p-3">
          <!-- Title -->
          <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-2 leading-snug min-h-[2.5rem]">
            {{ land.title or '—' }}
          </h3>

          <!-- Price - بزرگ و برجسته -->
          <div class="mb-2">
            <div class="text-lg font-bold text-gray-900 dark:text-white">
              {{ (land.price_total or 0)|toman }}
            </div>
            {% if land._commission_amount %}
            <div class="text-xs text-emerald-600 dark:text-emerald-400 mt-0.5">
              پورسانت شما: {{ (land._commission_amount or 0)|toman }}
              {% if land._commission_pct %}
                <span class="text-gray-500 dark:text-gray-400">({{ land._commission_pct }}%)</span>
              {% endif %}
            </div>
            {% endif %}
          </div>

          <!-- Details - ساده و تمیز -->
          <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-600 dark:text-gray-400 mb-2">
            {% if land.size %}
              <span class="flex items-center gap-1">
                <i class="fas fa-ruler-combined text-[10px]"></i>
                {{ land.size }} متر
              </span>
            {% endif %}
            {% if land.location or land.city %}
              <span class="flex items-center gap-1">
                <i class="fas fa-map-marker-alt text-[10px]"></i>
                {{ land.location or (land.city or '') }}
              </span>
            {% endif %}
            {% if land.category %}
              <span class="flex items-center gap-1">
                <i class="fas fa-tag text-[10px]"></i>
                {{ land.category }}
              </span>
            {% endif %}
          </div>

          <!-- Footer - تاریخ و برچسب -->
          <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-800">
            {% if land.created_at %}
              <span class="text-[11px] text-gray-500 dark:text-gray-500">
                <span class="jalali-dt" data-dt="{{ land.created_at }}"></span>
              </span>
            {% else %}
              <span></span>
            {% endif %}
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
              <i class="fas fa-bolt text-[9px]"></i>
              Express
            </span>
          </div>
        </div>
      </article>
    {% endfor %}
    </div>
  </div>

  
  {% endif %} <!-- end loading check -->

  {% set bottom_nav_active = 'dashboard' %}
  {% include 'express_partner/partials/bottom_nav.html' %}

</div>

<!-- Small script for accessibility enhancements + share/copy -->
<script>
  // add focus outline for keyboard users
  document.addEventListener('keyup', (e) => {
    if (e.key === 'Tab') document.documentElement.classList.add('user-is-tabbing');
  });
  // Make entire cards clickable with keyboard support
  document.querySelectorAll('.express-card[data-href]').forEach((card) => {
    card.addEventListener('click', () => {
      const href = card.getAttribute('data-href');
      if (href) window.location.assign(href);
    });
    card.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        const href = card.getAttribute('data-href');
        if (href) window.location.assign(href);
      }
    });
  });
  
  // Share and copy buttons
  (function(){
    function toast(msg){
      try{
        const t = document.createElement('div');
        t.textContent = msg;
        t.dir = 'rtl';
        t.className = 'fixed bottom-16 inset-x-0 mx-auto w-fit px-3 py-2 rounded-lg text-sm bg-emerald-600 text-white shadow z-[60]';
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), 1500);
      }catch(_){ }
    }
    document.querySelectorAll('.share-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const url = btn.getAttribute('data-url')||location.href;
        const title = document.title || 'وینور اکسپرس';
        try{
          if (navigator.share) { await navigator.share({ title, url }); }
          else { await navigator.clipboard.writeText(url); toast('لینک کپی شد'); }
        }catch(_){ }
      }, { passive: true });
    });
  })();

  // Horizontal scroll controls for cards
  (function(){
    const track = document.getElementById('cardsTrack');
    const prev = document.getElementById('cardsPrev');
    const next = document.getElementById('cardsNext');
    if (!track || !prev || !next) return;
    function scrollByAmount(dir){
      const delta = Math.round((track.clientWidth || 300) * 0.9);
      const rtl = document.dir === 'rtl' || document.documentElement.getAttribute('dir') === 'rtl';
      const sign = (dir === 'next') ? (rtl ? -1 : 1) : (rtl ? 1 : -1);
      track.scrollBy({ left: sign * delta, behavior: 'smooth' });
    }
    prev.addEventListener('click', ()=>scrollByAmount('prev'));
    next.addEventListener('click', ()=>scrollByAmount('next'));
  })();

  // Convert dates to Persian (Jalali) format
  (function(){
    function fmt(dt){
      try{
        const d = new Date(String(dt||'').replace(' ','T'));
        if (isNaN(d.getTime())) return '';
        return d.toLocaleDateString('fa-IR', {
          timeZone: 'Asia/Tehran',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      }catch(_){ return ''; }
    }
    document.querySelectorAll('.jalali-dt[data-dt]').forEach(el=>{
      const raw = el.getAttribute('data-dt')||'';
      const formatted = fmt(raw);
      el.textContent = formatted || '—';
    });
  })();

  // Pull-to-refresh functionality
  (function(){
    let startY = 0;
    let currentY = 0;
    let isPulling = false;
    let pullThreshold = 80; // Minimum distance to trigger refresh
    let refreshElement = null;

    function createRefreshElement() {
      const el = document.createElement('div');
      el.id = 'pull-refresh-indicator';
      el.className = 'fixed top-0 left-0 right-0 z-[100] bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 transform -translate-y-full transition-transform duration-300';
      el.innerHTML = `
        <div class="flex items-center justify-center py-4">
          <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400">
            <div class="w-6 h-6 border-2 border-gray-300 dark:border-gray-600 border-t-emerald-500 rounded-full animate-spin"></div>
            <span class="text-sm font-medium">در حال بروزرسانی...</span>
          </div>
        </div>
      `;
      document.body.appendChild(el);
      return el;
    }

    function showRefreshIndicator(progress) {
      if (!refreshElement) {
        refreshElement = createRefreshElement();
      }
      const translateY = Math.min(progress * 0.5, pullThreshold);
      refreshElement.style.transform = `translateY(${translateY - pullThreshold}px)`;

      // Change icon based on progress
      if (progress >= pullThreshold) {
        refreshElement.querySelector('.text-gray-600').className = 'flex items-center gap-3 text-emerald-600 dark:text-emerald-400';
        refreshElement.querySelector('span').textContent = 'رها کنید برای بروزرسانی';
      } else {
        refreshElement.querySelector('.text-gray-600').className = 'flex items-center gap-3 text-gray-600 dark:text-gray-400';
        refreshElement.querySelector('span').textContent = 'کشیده و رها کنید';
      }
    }

    function hideRefreshIndicator() {
      if (refreshElement) {
        refreshElement.style.transform = 'translateY(-100%)';
        setTimeout(() => {
          if (refreshElement) {
            refreshElement.remove();
            refreshElement = null;
          }
        }, 300);
      }
    }

    function triggerRefresh() {
      if (refreshElement) {
        refreshElement.querySelector('.text-emerald-600').className = 'flex items-center gap-3 text-emerald-600 dark:text-emerald-400';
        refreshElement.querySelector('span').textContent = 'در حال بروزرسانی...';
        refreshElement.style.transform = 'translateY(0)';
      }

      // Reload the page after a short delay
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    }

    document.addEventListener('touchstart', function(e) {
      if (window.scrollY === 0) { // Only when at top of page
        startY = e.touches[0].clientY;
        isPulling = true;
      }
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
      if (isPulling && startY > 0) {
        currentY = e.touches[0].clientY;
        const pullDistance = currentY - startY;

        if (pullDistance > 0) { // Only downward pulls
          e.preventDefault(); // Prevent default scrolling
          showRefreshIndicator(pullDistance);
        }
      }
    }, { passive: false });

    document.addEventListener('touchend', function(e) {
      if (isPulling) {
        const pullDistance = currentY - startY;

        if (pullDistance >= pullThreshold) {
          triggerRefresh();
        } else {
          hideRefreshIndicator();
        }

        startY = 0;
        currentY = 0;
        isPulling = false;
      }
    });
  })();
</script>
{% endblock %}


