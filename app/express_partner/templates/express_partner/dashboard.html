{% extends 'base.html' %}
{% block title %}پنل همکاری وینور اکسپرس{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto py-4 px-3 sm:px-4 font-iranyekan">

  <!-- Simple fixed header (like Help) -->
  <header class="fixed top-0 inset-x-0 z-30 bg-white dark:bg-gray-800 border-b dark:border-gray-700">
    <div class="max-w-6xl mx-auto px-3 sm:px-4 py-3 flex items-center justify-between">
      <button type="button" onclick="history.back()" class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="بازگشت">
        <i class="fas fa-arrow-right"></i>
      </button>
      <h1 class="text-base sm:text-lg font-bold text-gray-900 dark:text-white">پنل همکار اکسپرس</h1>
      <a href="{{ url_for('main.help') }}" class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="راهنما">
        <i class="fas fa-life-ring"></i>
      </a>
    </div>
  </header>
  <div class="h-20"></div>

  <style>
    /* کارت‌های جدید همکاران اکسپرس: مینیمال و خوانا */
    .express-card { transition: box-shadow .2s ease, transform .2s ease; }
    .express-card:hover { transform: translateY(-2px); }
  </style>

  <!-- Pull-to-Refresh (purple themed) -->
  <div id="ptrMsg" class="max-w-6xl mx-auto px-2" style="display:none">
    <div id="ptrWrap" class="sticky top-0 z-30">
      <div id="ptrBox" class="mx-auto w-9 h-9 flex items-center justify-center rounded-full border shadow bg-white/90 backdrop-blur-md text-gray-700 ring-1 ring-gray-300 border-gray-200 opacity-0 -translate-y-2 transition duration-200">
        <i id="ptrIcon" class="fas fa-arrow-down text-gray-500"></i>
      </div>
    </div>
  </div>

  <!-- Approval Notice -->
  {% if not is_approved %}
    <div class="bg-yellow-50 border border-yellow-200 text-yellow-900 p-4 rounded-md mb-6">درخواست شما در صف بررسی است. پس از تأیید توسط ادمین، دسترسی کامل به پنل فعال می‌شود.</div>
  {% endif %}

  {% if is_approved %}
    <!-- One-time Express partner approval modal (shown once per user) -->
    <div id="expressApprovedModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
      <div class="bg-white rounded-2xl p-5 mx-4 max-w-sm w-full text-center shadow-lg">
        <div class="text-emerald-600 text-2xl font-extrabold mb-1">تبریک!</div>
        <div class="text-gray-700 text-sm">شما به‌عنوان همکار اکسپرس تأیید شده‌اید. می‌توانید از خدمات ویژه استفاده کنید.</div>
        <button id="expressApprovedClose" class="mt-3 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">باشه</button>
      </div>
    </div>
    <script>
      (function(){
        try {
          var userKey = "{{ session.get('user_id') or session.get('user_phone') or 'anon' }}";
          var KEY = "vinor_express_approved_shown_v1_" + userKey;
          var modal = document.getElementById('expressApprovedModal');
          var btn = document.getElementById('expressApprovedClose');
          if (!localStorage.getItem(KEY)) {
            if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
            try { localStorage.setItem(KEY, '1'); } catch(_){ }
          }
          function close(){
            if (!modal) return;
            modal.classList.add('hidden');
            modal.classList.remove('flex');
          }
          if (btn) btn.addEventListener('click', close, { passive: true });
          if (modal) modal.addEventListener('click', function(e){ if (e.target === modal) close(); }, { passive: true });
        } catch(_){ }
      })();
    </script>
  {% endif %}

  <!-- Loading skeleton -->
  {% if loading %}
    <div class="space-y-4">
      <div class="h-40 rounded-2xl bg-gray-100 animate-pulse"></div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for i in range(6) %}
          <div class="h-56 rounded-2xl bg-gray-100 animate-pulse"></div>
        {% endfor %}
      </div>
    </div>
  {% else %}

  <!-- Assigned lands -->
  {% if assigned_lands|length == 0 %}
    <div class="mt-2 bg-white border rounded-2xl p-6 text-center text-gray-600">هنوز ملکی برای شما ارسال نشده است.</div>
  {% endif %}

  <section class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for land in assigned_lands %}
      <article class="group express-card relative bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl overflow-hidden shadow-sm hover:shadow-lg">
        {% set img = (land.images[0] if land.images and land.images[0] else None) %}
        <div class="relative aspect-video bg-gray-100 dark:bg-gray-800">
          {% if img %}
            <img src="{{ url_for('static', filename=img) if img.startswith('uploads/') else img }}" alt="{{ land.title }}" class="w-full h-full object-cover group-hover:scale-[1.02] transition-transform duration-200">
          {% else %}
            <div class="w-full h-full grid place-items-center text-gray-400">تصویر ندارد</div>
          {% endif %}
          <div class="absolute inset-0 bg-gradient-to-t from-black/30 via-black/5 to-transparent"></div>

          {% set _st = (land._assignment_status|default('active')) %}
          <div class="absolute top-3 left-3 text-[11px] px-2 py-1 rounded-md bg-white/95 text-gray-800 shadow">{% if _st == 'closed' %}بسته{% elif _st == 'pending' %}در انتظار{% else %}فعال{% endif %}</div>

          {% if land._commission_pct %}
            <div class="absolute top-3 right-3 text-[11px] px-2 py-1 rounded-md bg-[#7C3AED] text-white shadow">٪{{ land._commission_pct }}</div>
          {% endif %}
        </div>

        <div class="p-4">
          <div class="flex items-start justify-between gap-2">
            <h3 class="text-[16px] font-bold text-gray-900 dark:text-gray-100 line-clamp-2">{{ land.title or '—' }}</h3>
            {% if land.code %}
              <span class="shrink-0 inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[11px] bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200"><i class="fas fa-hashtag"></i>{{ land.code }}</span>
            {% endif %}
          </div>

          <div class="mt-2 flex flex-wrap items-center gap-1.5 text-[12px]">
            {% if land.size %}
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"><i class="fas fa-ruler-combined"></i>{{ land.size }} متر</span>
            {% endif %}
            {% if land.category %}
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"><i class="fas fa-tag"></i>{{ land.category }}</span>
            {% endif %}
            {% if land.location or land.city %}
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200"><i class="fas fa-location-dot"></i>{{ land.location or (land.city or '') }}</span>
            {% endif %}
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2 text-[13px]">
            <div class="rounded-md bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 px-2 py-1.5">
              <div class="text-[11px] text-gray-500 dark:text-gray-400">قیمت کل</div>
              <div class="font-extrabold text-emerald-700 dark:text-emerald-400 leading-tight">{{ (land.price_total or 0)|toman }}</div>
            </div>
            <div class="rounded-md bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 px-2 py-1.5">
              <div class="text-[11px] text-gray-500 dark:text-gray-400">پورسانت همکار</div>
              <div class="font-extrabold text-violet-700 dark:text-violet-300 leading-tight">{{ (land._commission_amount or 0)|toman }}</div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2">
            <a href="{{ url_for('main.express_detail', code=land.code) }}" class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-md border border-gray-200 dark:border-gray-700 text-[13px] text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
              <i class="far fa-eye"></i>
              مشاهده
            </a>
            {% set _link = url_for('main.express_detail', code=land.code, _external=True) %}
            <button type="button" class="share-btn inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-md bg-[#7C3AED] hover:bg-[#6D28D9] text-white text-[13px] transition" data-url="{{ _link }}">
              <i class="fas fa-share-nodes"></i>
              اشتراک
            </button>
            <button type="button" class="copy-btn inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-md border border-gray-200 dark:border-gray-700 text-[13px] text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition" data-url="{{ _link }}">
              <i class="fas fa-link"></i>
              کپی لینک
            </button>
            <a target="_blank" rel="noopener" href="https://wa.me/?text={{ (_link ~ ' - ' ~ (land.title or ''))|urlencode }}" class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-md border border-green-200 text-green-700 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 transition text-[13px]">
              <i class="fab fa-whatsapp"></i>
              واتساپ
            </a>
          </div>
        </div>
      </article>
    {% endfor %}
  </section>

  
  {% endif %} <!-- end loading check -->

  <!-- Mobile bottom nav -->
  <nav class="fixed bottom-2 left-2 right-2 z-50 sm:hidden">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-lg flex justify-between items-center px-3 py-2">
      <a href="{{ url_for('express_partner.dashboard') }}" class="flex flex-col items-center text-xs text-[#7C3AED]">
        <svg class="w-5 h-5 mb-1" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M12 3v18" stroke="#7C3AED" stroke-width="1.5"/></svg>
        فایل‌ها
      </a>
      <a href="{{ url_for('express_partner.commissions') }}" class="flex flex-col items-center text-xs text-gray-600">
        <svg class="w-5 h-5 mb-1" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="#6B7280" stroke-width="1.5"/></svg>
        پورسانت
      </a>
      <a href="{{ url_for('main.help') }}" class="flex flex-col items-center text-xs text-gray-600">
        <svg class="w-5 h-5 mb-1" viewBox="0 0 24 24" fill="none"><path d="M12 2l2 6h6l-5 4 2 6-5-4-5 4 2-6-5-4h6z" stroke="#6B7280" stroke-width="1.2"/></svg>
        پشتیبانی
      </a>
      <a href="{{ url_for('main.profile') }}" class="flex flex-col items-center text-xs text-gray-600">
        <svg class="w-5 h-5 mb-1" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3" stroke="#6B7280" stroke-width="1.5"/><path d="M6 20c1.5-4 9-4 12 0" stroke="#6B7280" stroke-width="1.5"/></svg>
        من
      </a>
    </div>
  </nav>

</div>

<!-- PTR + small script for accessibility enhancements + share/copy -->
<script>
  // add focus outline for keyboard users
  document.addEventListener('keyup', (e) => {
    if (e.key === 'Tab') document.documentElement.classList.add('user-is-tabbing');
  });
  // Pull-to-refresh (purple)
  (function(){
    const msg = document.getElementById('ptrMsg');
    const box = document.getElementById('ptrBox');
    const icon = document.getElementById('ptrIcon');
    const THRESH = 60; // px
    let startY = 0, eligible = false, active = false, isRefreshing = false;
    function atTop(){ return (window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0) <= 0; }
    function setState(state){
      if (!box || !icon) return;
      icon.style.transform = '';
      icon.className = '';
      box.classList.remove('ring-purple-300','border-purple-200','ring-red-300','border-red-200','ring-gray-300','border-gray-200');
      box.classList.add('ring-gray-300','border-gray-200');
      if (state === 'pull'){
        icon.className = 'fas fa-arrow-down ' + (active ? 'text-purple-600' : 'text-gray-500');
      } else if (state === 'loading'){
        icon.className = 'fas fa-rotate-right fa-spin text-purple-600';
        box.classList.remove('ring-gray-300','border-gray-200');
        box.classList.add('ring-purple-300','border-purple-200');
      } else if (state === 'success'){
        icon.className = 'fas fa-check text-purple-600';
        box.classList.remove('ring-gray-300','border-gray-200');
        box.classList.add('ring-purple-300','border-purple-200');
      } else if (state === 'error'){
        icon.className = 'fas fa-exclamation text-red-600';
        box.classList.remove('ring-gray-300','border-gray-200');
        box.classList.add('ring-red-300','border-red-200');
      }
    }
    function show(){ if (msg) msg.style.display = ''; try { box.classList.remove('opacity-0','-translate-y-2'); box.classList.add('opacity-100','translate-y-0'); } catch(_){ } }
    function hide(){ try { box.classList.add('opacity-0','-translate-y-2'); box.classList.remove('opacity-100','translate-y-0'); } catch(_){ } if (msg) msg.style.display = 'none'; }

    document.addEventListener('touchstart', (e)=>{
      if (!atTop()) { eligible = false; return; }
      const t = e.touches && e.touches[0];
      if (!t) { eligible = false; return; }
      startY = t.clientY; eligible = true; active = false;
    }, { passive: true });
    document.addEventListener('touchmove', (e)=>{
      if (!eligible) return;
      const t = e.touches && e.touches[0]; if (!t) return;
      const dy = t.clientY - startY; if (dy > 0){
        try { e.preventDefault(); } catch(_){ }
        active = dy >= THRESH; icon.style.transform = 'rotate(' + Math.min(180, Math.round((dy / THRESH) * 180)) + 'deg)';
        show(); setState('pull');
      }
    }, { passive: false });
    document.addEventListener('touchend', async ()=>{
      if (!eligible) return; eligible = false; if (!active) return; if (isRefreshing) return;
      isRefreshing = true; show(); setState('loading');
      try { location.reload(); setState('success'); } catch(_) { setState('error'); }
      finally { setTimeout(()=>{ isRefreshing = false; hide(); }, 900); }
    }, { passive: true });
  })();

  // Share and copy buttons
  (function(){
    function toast(msg){
      try{
        const t = document.createElement('div');
        t.textContent = msg;
        t.dir = 'rtl';
        t.className = 'fixed bottom-16 inset-x-0 mx-auto w-fit px-3 py-2 rounded-lg text-sm bg-emerald-600 text-white shadow z-[60]';
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), 1500);
      }catch(_){ }
    }
    document.querySelectorAll('.share-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const url = btn.getAttribute('data-url')||location.href;
        const title = document.title || 'وینور اکسپرس';
        try{
          if (navigator.share) { await navigator.share({ title, url }); }
          else { await navigator.clipboard.writeText(url); toast('لینک کپی شد'); }
        }catch(_){ }
      }, { passive: true });
    });
    document.querySelectorAll('.copy-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const url = btn.getAttribute('data-url')||location.href;
        try{ await navigator.clipboard.writeText(url); toast('کپی شد'); }catch(_){ }
      }, { passive: true });
    });
  })();
</script>
{% endblock %}


