{% extends 'express_partner/base.html' %}
{% block title %}پنل همکاری وینور اکسپرس{% endblock %}
{% block content %}

  <!-- Header - باکس جستجو (منتقل‌شده از اکسپلور) -->
  <header data-tour="dashboard-header" class="fixed top-0 left-0 right-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
    <div class="w-full px-4 py-2.5 flex items-center gap-2">
      <form method="GET" action="{{ url_for('main.express_public_list') }}" class="flex-1 min-w-0" id="searchForm">
        <div class="relative w-full">
          <div class="flex items-center bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 focus-within:border-blue-500 dark:focus-within:border-blue-400 focus-within:shadow-sm transition-all">
            <input type="text"
                   name="q"
                   id="searchInput"
                   value="{{ request.args.get('q', '') }}"
                   placeholder="جستجو در فایل‌ها..."
                   autocomplete="off"
                   class="flex-1 bg-transparent border-0 outline-none text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 py-2.5 px-4 min-w-0">
            <div class="flex items-center gap-2 pr-2">
              {% if cities %}
              <select name="city"
                      class="h-8 px-2 rounded-md bg-gray-100 dark:bg-gray-700 text-[11px] sm:text-xs text-gray-700 dark:text-gray-200 border-0 focus:outline-none focus:ring-0">
                <option value="">همه شهرها</option>
                {% for c in cities %}
                <option value="{{ c }}" {% if (request.args.get('city') or (profile.city if profile else '')) == c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
              {% endif %}
              <button type="submit"
                      class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                      aria-label="جستجو">
                <i class="fas fa-magnifying-glass text-sm"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </header>

<div class="max-w-6xl mx-auto pt-14 px-3 sm:px-4 pb-16">

  <!-- کارت آموزش - سرتاسر و با ارتفاع کمتر -->
  <a href="{{ url_for('express_partner.training') }}" 
     data-tour="training-bar"
     class="block mt-2 mb-3 -mx-3 sm:mx-0 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-none sm:rounded-lg py-3 px-4 hover:border-emerald-400 dark:hover:border-emerald-600 hover:shadow-md transition-all duration-200 group">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 flex-1 min-w-0">
        <div class="w-9 h-9 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-graduation-cap text-emerald-600 dark:text-emerald-400 text-base"></i>
        </div>
        <p class="text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate">
          آموزش ۳ مرحله‌ای موفقیت در همکاری
        </p>
      </div>
      <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500 text-xs flex-shrink-0 group-hover:translate-x-[-2px] transition-transform"></i>
    </div>
  </a>

  <style>
    #cardsTrack{
      min-height:calc(100vh - 150px);
    }
    @media (max-width:640px){
      #cardsTrack{
        min-height:calc(100vh - 130px);
      }
    }
    .express-card{
      transition:box-shadow .2s ease, border-color .2s ease;
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .express-card:hover{
      transform:translateY(-1px);
    }
  </style>

  {# Flash messages removed by request #}

{% if (not is_approved) and has_pending_app %}
    <div class="bg-amber-50 border border-amber-200 text-amber-800 dark:bg-amber-900/20 dark:text-amber-200 dark:border-amber-800/50 p-4 rounded-xl mb-4">
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-5 h-5 rounded-full bg-amber-200 dark:bg-amber-800 flex items-center justify-center mt-0.5">
          <i class="fas fa-clock text-xs text-amber-700 dark:text-amber-300"></i>
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium text-amber-900 dark:text-amber-100 mb-1">در حال بررسی درخواست</p>
          <p class="text-xs text-amber-700 dark:text-amber-300">درخواست همکاری شما در حال بررسی است. پس از تأیید، دسترسی کامل به پنل فعال می‌شود.</p>
        </div>
      </div>
    </div>
  {% endif %}

  {% if expired_count and expired_count > 0 %}
    <div class="bg-red-50 border border-red-200 text-red-800 dark:bg-red-900/20 dark:text-red-200 dark:border-red-800/50 p-4 rounded-xl mb-4">
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-5 h-5 rounded-full bg-red-200 dark:bg-red-800 flex items-center justify-center mt-0.5">
          <i class="fas fa-exclamation-circle text-xs text-red-700 dark:text-red-300"></i>
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium text-red-900 dark:text-red-100 mb-1">اعتبار {{ expired_count }} فایل به پایان رسیده</p>
          <p class="text-xs text-red-700 dark:text-red-300">برخی از فایل‌های ارسالی منقضی شده‌اند. لطفاً با پشتیبانی تماس بگیرید.</p>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Loading skeleton -->
  {% if loading %}
    <div class="space-y-4">
      <div class="h-40 rounded-2xl bg-gray-100 animate-pulse"></div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for i in range(6) %}
          <div class="h-56 rounded-2xl bg-gray-100 animate-pulse"></div>
        {% endfor %}
      </div>
    </div>
  {% else %}

  <!-- Assigned lands -->
  {% if assigned_lands|length == 0 %}
    <div class="mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-8 text-center">
      <div class="flex flex-col items-center gap-3">
        <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
          <i class="fas fa-inbox text-2xl text-gray-400 dark:text-gray-500"></i>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">هنوز فایلی برای شما ارسال نشده</p>
          <p class="text-xs text-gray-500 dark:text-gray-400">پس از ارسال فایل‌ها توسط ادمین، در اینجا نمایش داده می‌شوند.</p>

          <div class="mt-4 flex flex-wrap items-center justify-center gap-2">
            {% if not profile %}
              <a href="{{ url_for('express_partner.login', next=url_for('express_partner.dashboard')) }}"
                 class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 transition">
                <i class="fas fa-right-to-bracket text-xs"></i>
                ورود
              </a>
              <a href="{{ url_for('express_partner.apply') }}"
                 class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 text-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                <i class="fas fa-user-plus text-xs"></i>
                درخواست همکاری
              </a>
            {% else %}
              {% if not is_approved %}
                {% if has_pending_app %}
                  <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-amber-50 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200 text-xs border border-amber-100 dark:border-amber-800/40">
                    <i class="fas fa-clock text-[11px]"></i>
                    درخواست شما در حال بررسی است
                  </span>
                {% else %}
                  <a href="{{ url_for('express_partner.apply') }}"
                     class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 transition">
                    <i class="fas fa-user-plus text-xs"></i>
                    درخواست همکاری
                  </a>
                {% endif %}
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Desktop layout: grid + sticky sidebar (Divar style) -->
  <div class="hidden lg:grid lg:grid-cols-12 gap-6 mt-2">
    <!-- Main grid -->
    <div class="lg:col-span-8">
      {% if assigned_lands|length == 0 %}
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-8 text-center">
          <div class="flex flex-col items-center gap-3">
            <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
              <i class="fas fa-inbox text-2xl text-gray-400 dark:text-gray-500"></i>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">هنوز فایلی برای شما ارسال نشده</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">پس از ارسال فایل‌ها توسط ادمین، در اینجا نمایش داده می‌شوند.</p>

              <div class="mt-4 flex flex-wrap items-center justify-center gap-2">
                {% if not profile %}
                  <a href="{{ url_for('express_partner.login', next=url_for('express_partner.dashboard')) }}"
                     class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 transition">
                    <i class="fas fa-right-to-bracket text-xs"></i>
                    ورود
                  </a>
                  <a href="{{ url_for('express_partner.apply') }}"
                     class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 text-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                    <i class="fas fa-user-plus text-xs"></i>
                    درخواست همکاری
                  </a>
                {% else %}
                  {% if not is_approved %}
                    {% if has_pending_app %}
                      <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-amber-50 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200 text-xs border border-amber-100 dark:border-amber-800/40">
                        <i class="fas fa-clock text-[11px]"></i>
                        درخواست شما در حال بررسی است
                      </span>
                    {% else %}
                      <a href="{{ url_for('express_partner.apply') }}"
                         class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 transition">
                        <i class="fas fa-user-plus text-xs"></i>
                        درخواست همکاری
                      </a>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <div id="cardsGrid" class="grid grid-cols-2 xl:grid-cols-3 gap-4">
          {% for land in assigned_lands %}
          {% set img = (land.images[0] if land.images and land.images[0] else None) %}
          {% set _st = (land._assignment_status|default('active')) %}
          <article class="group express-card relative bg-white dark:bg-gray-900 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md"
                   data-href="{{ url_for('express_partner.land_detail', code=land.code) }}" role="link" tabindex="0">
            <div class="relative aspect-[4/3] bg-gray-100 dark:bg-gray-800 overflow-hidden" data-img-wrap>
              <div class="card-img-loading absolute inset-0 z-10 flex items-center justify-center bg-black/10 dark:bg-black/30 transition-opacity">
                <div class="w-8 h-8 rounded-full border-2 border-white/50 border-t-transparent animate-spin"></div>
              </div>
              {% set video = land.video %}
              {% if video %}
                {% if "://" in (video|string) %}
                  {% set video_src = video %}
                {% elif (video|string).startswith('/uploads/') %}
                  {% set video_src = video %}
                {% elif (video|string).startswith('uploads/') %}
                  {% set video_src = '/uploads/' + (video|string)[8:] %}
                {% elif not (video|string).startswith('/') %}
                  {% set video_src = '/uploads/' + (video|string) %}
                {% else %}
                  {% set video_src = video %}
                {% endif %}
                <video class="w-full h-full object-cover" autoplay muted loop playsinline>
                  <source src="{{ video_src }}" type="video/mp4">
                  {% if img %}
                    {% if "://" in (img|string) %}
                      {% set img_src = img %}
                    {% elif (img|string).startswith('/uploads/') %}
                      {% set img_src = img %}
                    {% elif (img|string).startswith('uploads/') %}
                      {% set img_src = '/uploads/' + (img|string)[8:] %}
                    {% elif not (img|string).startswith('/') %}
                      {% set img_src = '/uploads/' + (img|string) %}
                    {% else %}
                      {% set img_src = img %}
                    {% endif %}
                    <img src="{{ img_src }}" alt="{{ land.title }}" class="w-full h-full object-cover">
                  {% endif %}
                </video>
              {% elif img %}
                {% if "://" in (img|string) %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('/uploads/') %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('uploads/') %}
                  {% set img_src = '/uploads/' + (img|string)[8:] %}
                {% elif not (img|string).startswith('/') %}
                  {% set img_src = '/uploads/' + (img|string) %}
                {% else %}
                  {% set img_src = img %}
                {% endif %}
                <img src="{{ img_src }}" alt="{{ land.title }}" loading="lazy" class="w-full h-full object-cover opacity-0 transition-opacity duration-200" data-card-img>
              {% else %}
                <div class="w-full h-full grid place-items-center text-gray-300 dark:text-gray-600">
                  <i class="fas fa-image text-3xl"></i>
                </div>
              {% endif %}
              <div class="absolute top-2 left-2 flex flex-col gap-1">
                {% if land._is_expired %}
                  <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-red-600 text-white">
                    <i class="fas fa-exclamation-circle text-[9px] ml-1"></i>
                    منقضی شده
                  </span>
                {% endif %}
                {% if _st == 'sold' %}
                  <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-green-600 text-white">فروخته شد</span>
                {% elif _st == 'in_transaction' %}
                  <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-orange-500 text-white">در حال معامله</span>
                {% elif _st == 'closed' %}
                  <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-gray-700 text-white">بسته</span>
                {% elif _st == 'pending' %}
                  <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-yellow-500 text-white">در انتظار</span>
                {% endif %}
              </div>
            </div>
            <div class="p-3">
              <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-2 leading-snug min-h-[2.5rem]">{{ land.title or '—' }}</h3>
              <div class="mb-2">
                <div class="text-lg font-bold text-gray-900 dark:text-white">{{ (land.price_total or 0)|toman }}</div>
                {% if is_approved and land._commission_amount %}
                <div class="text-xs text-emerald-600 dark:text-emerald-400 mt-0.5">
                  پورسانت شما: {{ (land._commission_amount or 0)|toman }}
                  {% if land._commission_pct %}
                    <span class="text-gray-500 dark:text-gray-400">({{ land._commission_pct }}%)</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-600 dark:text-gray-400 mb-2">
                {% if land.size %}
                  <span class="flex items-center gap-1"><i class="fas fa-ruler-combined text-[10px]"></i>{{ land.size }} متر</span>
                {% endif %}
                {% if land.location or land.city %}
                  <span class="flex items-center gap-1"><i class="fas fa-map-marker-alt text-[10px]"></i>{{ land.location or (land.city or '') }}</span>
                {% endif %}
                {% if land.category %}
                  <span class="flex items-center gap-1"><i class="fas fa-tag text-[10px]"></i>{{ land.category }}</span>
                {% endif %}
              </div>
              <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-800">
                {% if land.created_at %}
                  <span class="text-[11px] text-gray-500 dark:text-gray-500"><span class="jalali-dt" data-dt="{{ land.created_at }}"></span></span>
                {% else %}
                  <span></span>
                {% endif %}
                <div class="inline-flex items-center gap-2">
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
                    <i class="fas fa-check text-[9px]"></i> تایید شده
                  </span>
                </div>
              </div>
            </div>
          </article>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    <!-- Sidebar -->
    <aside class="lg:col-span-4">
      <div class="sticky top-16 space-y-3">
        <!-- Stats -->
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-bold text-gray-900 dark:text-white">آمار شما</h3>
            <i class="fas fa-chart-line text-gray-400"></i>
          </div>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="rounded-xl bg-gray-50 dark:bg-gray-800 p-3">
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mb-1">کل درآمد</div>
              <div class="text-sm font-extrabold text-emerald-600 dark:text-emerald-400">{{ (total_commission or 0)|toman }}</div>
            </div>
            <div class="rounded-xl bg-gray-50 dark:bg-gray-800 p-3">
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mb-1">در انتظار</div>
              <div class="text-sm font-extrabold text-amber-600 dark:text-amber-400">{{ (pending_commission or 0)|toman }}</div>
            </div>
            <div class="rounded-xl bg-gray-50 dark:bg-gray-800 p-3">
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mb-1">فروش تاییدشده</div>
              <div class="text-sm font-extrabold text-blue-600 dark:text-blue-400">{{ (sold_count or 0) }}</div>
            </div>
          </div>
          {% if expired_count and expired_count > 0 %}
          <div class="mt-3 text-xs text-red-600 dark:text-red-400">اعتبار {{ expired_count }} فایل به پایان رسیده</div>
          {% endif %}
        </div>
        <!-- Quick actions -->
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-4">
          <h3 class="text-sm font-bold text-gray-900 dark:text-white mb-3">میانبرها</h3>
          <div class="grid grid-cols-2 gap-2">
            <a href="{{ url_for('express_partner.commissions') }}" class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-emerald-300 dark:hover:border-emerald-700 transition">
              <i class="fas fa-receipt text-gray-600 dark:text-gray-300"></i>
              <span class="text-sm">پورسانت‌ها</span>
            </a>
            <a href="{{ url_for('express_partner.notes') }}" class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-emerald-300 dark:hover:border-emerald-700 transition">
              <i class="fas fa-note-sticky text-gray-600 dark:text-gray-300"></i>
              <span class="text-sm">یادداشت‌ها</span>
            </a>
            <a href="{{ url_for('express_partner.profile') }}" class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-emerald-300 dark:hover:border-emerald-700 transition">
              <i class="fas fa-user text-gray-600 dark:text-gray-300"></i>
              <span class="text-sm">پروفایل</span>
            </a>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Current horizontal carousel preserved for mobile/tablet -->
  <div class="mt-2 -mx-3 relative lg:hidden">
    <button type="button" id="cardsPrev" class="hidden sm:flex absolute right-1 top-1/2 -translate-y-1/2 z-10 w-9 h-9 rounded-full bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 shadow items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700">
      <i class="fas fa-chevron-right"></i>
    </button>
    <button type="button" id="cardsNext" class="hidden sm:flex absolute left-1 top-1/2 -translate-y-1/2 z-10 w-9 h-9 rounded-full bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 shadow items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700">
      <i class="fas fa-chevron-left"></i>
    </button>

    <div id="cardsTrack" class="px-3 flex flex-col sm:flex-row sm:flex-nowrap items-stretch gap-4 pb-4 sm:overflow-x-auto sm:snap-x sm:snap-mandatory no-scrollbar">
    {% for land in assigned_lands %}
      <article {% if loop.first %}data-tour="land-card"{% endif %} class="snap-start shrink-0 w-full sm:w-[320px] group express-card relative bg-white dark:bg-gray-900 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md" data-href="{{ url_for('express_partner.land_detail', code=land.code) }}" role="link" tabindex="0">
        {% set img = (land.images[0] if land.images and land.images[0] else None) %}
        {% set _st = (land._assignment_status|default('active')) %}
        
        <!-- Image/Video Section - دیوار استایل -->
        <div class="relative aspect-[4/3] bg-gray-100 dark:bg-gray-800 overflow-hidden" data-img-wrap>
          <div class="card-img-loading absolute inset-0 z-10 flex items-center justify-center bg-black/10 dark:bg-black/30 transition-opacity">
            <div class="w-8 h-8 rounded-full border-2 border-white/50 border-t-transparent animate-spin"></div>
          </div>
          {% set video = land.video %}
          {% if video %}
            {% if "://" in (video|string) %}
              {% set video_src = video %}
            {% elif (video|string).startswith('/uploads/') %}
              {% set video_src = video %}
            {% elif (video|string).startswith('uploads/') %}
              {% set video_src = '/uploads/' + (video|string)[8:] %}
            {% elif not (video|string).startswith('/') %}
              {% set video_src = '/uploads/' + (video|string) %}
            {% else %}
              {% set video_src = video %}
            {% endif %}
            <video class="w-full h-full object-cover" autoplay muted loop playsinline>
              <source src="{{ video_src }}" type="video/mp4">
              {% if img %}
                {% if "://" in (img|string) %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('/uploads/') %}
                  {% set img_src = img %}
                {% elif (img|string).startswith('uploads/') %}
                  {% set img_src = '/uploads/' + (img|string)[8:] %}
                {% elif not (img|string).startswith('/') %}
                  {% set img_src = '/uploads/' + (img|string) %}
                {% else %}
                  {% set img_src = img %}
                {% endif %}
                <img src="{{ img_src }}" alt="{{ land.title }}" class="w-full h-full object-cover">
              {% endif %}
            </video>
          {% elif img %}
            {% if "://" in (img|string) %}
              {% set img_src = img %}
            {% elif (img|string).startswith('/uploads/') %}
              {% set img_src = img %}
            {% elif (img|string).startswith('uploads/') %}
              {% set img_src = '/uploads/' + (img|string)[8:] %}
            {% elif not (img|string).startswith('/') %}
              {% set img_src = '/uploads/' + (img|string) %}
            {% else %}
              {% set img_src = img %}
            {% endif %}
            <img src="{{ img_src }}" alt="{{ land.title }}" loading="lazy" class="w-full h-full object-cover opacity-0 transition-opacity duration-200" data-card-img>
          {% else %}
            <div class="w-full h-full grid place-items-center text-gray-300 dark:text-gray-600">
              <i class="fas fa-image text-3xl"></i>
            </div>
          {% endif %}
          
          <!-- Status Badge - ساده و تمیز -->
          <div class="absolute top-2 left-2 flex flex-col gap-1">
            {% if land._is_expired %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-red-600 text-white">
                <i class="fas fa-exclamation-circle text-[9px] ml-1"></i>
                منقضی شده
              </span>
            {% endif %}
            {% if _st == 'sold' %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-green-600 text-white">
                فروخته شد
              </span>
            {% elif _st == 'in_transaction' %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-orange-500 text-white">
                در حال معامله
              </span>
            {% elif _st == 'closed' %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-gray-700 text-white">
                بسته
              </span>
            {% elif _st == 'pending' %}
              <span class="inline-flex items-center px-2 py-1 rounded text-[11px] font-medium bg-yellow-500 text-white">
                در انتظار
              </span>
            {% endif %}
          </div>
        </div>

        <!-- Content Section - سبک دیوار -->
        <div class="p-3">
          <!-- Title -->
          <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-2 leading-snug min-h-[2.5rem]">
            {{ land.title or '—' }}
          </h3>

          <!-- Price - بزرگ و برجسته -->
          <div class="mb-2">
            <div class="text-lg font-bold text-gray-900 dark:text-white">
              {{ (land.price_total or 0)|toman }}
            </div>
            {% if is_approved and land._commission_amount %}
            <div class="text-xs text-emerald-600 dark:text-emerald-400 mt-0.5">
              پورسانت شما: {{ (land._commission_amount or 0)|toman }}
              {% if land._commission_pct %}
                <span class="text-gray-500 dark:text-gray-400">({{ land._commission_pct }}%)</span>
              {% endif %}
            </div>
            {% endif %}
          </div>

          <!-- Details - ساده و تمیز -->
          <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-600 dark:text-gray-400 mb-2">
            {% if land.size %}
              <span class="flex items-center gap-1">
                <i class="fas fa-ruler-combined text-[10px]"></i>
                {{ land.size }} متر
              </span>
            {% endif %}
            {% if land.location or land.city %}
              <span class="flex items-center gap-1">
                <i class="fas fa-map-marker-alt text-[10px]"></i>
                {{ land.location or (land.city or '') }}
              </span>
            {% endif %}
            {% if land.category %}
              <span class="flex items-center gap-1">
                <i class="fas fa-tag text-[10px]"></i>
                {{ land.category }}
              </span>
            {% endif %}
          </div>

          <!-- Footer - تاریخ و برچسب -->
          <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-800">
            {% if land.created_at %}
              <span class="text-[11px] text-gray-500 dark:text-gray-500">
                <span class="jalali-dt" data-dt="{{ land.created_at }}"></span>
              </span>
            {% else %}
              <span></span>
            {% endif %}
            <div class="inline-flex items-center gap-2">
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
                <i class="fas fa-check text-[9px]"></i>
                تایید شده
              </span>
            </div>
          </div>
        </div>
      </article>
    {% endfor %}
    </div>
  </div>

  
  {% endif %} <!-- end loading check -->

  {% set bottom_nav_active = 'dashboard' %}
  {% include 'express_partner/partials/bottom_nav.html' %}

</div>

<!-- Small script for accessibility enhancements + share/copy -->
<script>
  // Helper: read cookie value by name
  function __getCookie(name){
    try{
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }catch(_){}
    return '';
  }
  // add focus outline for keyboard users
  document.addEventListener('keyup', (e) => {
    if (e.key === 'Tab') document.documentElement.classList.add('user-is-tabbing');
  });
  // Make entire cards clickable with keyboard support
  document.querySelectorAll('.express-card[data-href]').forEach((card) => {
    card.addEventListener('click', () => {
      const href = card.getAttribute('data-href');
      if (href) window.location.assign(href);
    });
    card.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        const href = card.getAttribute('data-href');
        if (href) window.location.assign(href);
      }
    });
  });
  
  // Image/video loading for cards (show loader only while loading)
  (function(){
    document.querySelectorAll('[data-img-wrap]').forEach((wrap) => {
      const img = wrap.querySelector('[data-card-img]');
      const vid = wrap.querySelector('video');
      const loader = wrap.querySelector('.card-img-loading');
      function hideLoader(){
        if (loader){
          loader.classList.add('opacity-0','pointer-events-none');
          setTimeout(()=>loader.remove(),250);
        }
      }
      function showMedia(el){
        if (el) el.classList.remove('opacity-0');
        hideLoader();
      }

      if (img){
        if (img.complete && img.naturalWidth > 0) showMedia(img);
        else {
          img.addEventListener('load', ()=>showMedia(img), { once:true });
          img.addEventListener('error', hideLoader, { once:true });
        }
      }
      if (vid){
        const ready = () => showMedia(vid);
        if (vid.readyState >= 2) ready();
        else {
          vid.addEventListener('loadeddata', ready, { once:true });
          vid.addEventListener('error', hideLoader, { once:true });
        }
      }
      // fail-safe to avoid stuck loader
      setTimeout(hideLoader, 3000);
    });
  })();
  
  // Share and copy buttons
  (function(){
    function toast(msg){
      try{
        const t = document.createElement('div');
        t.textContent = msg;
        t.dir = 'rtl';
        t.className = 'fixed bottom-16 inset-x-0 mx-auto w-fit px-3 py-2 rounded-lg text-sm bg-emerald-600 text-white shadow z-[60]';
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), 1500);
      }catch(_){ }
    }
    document.querySelectorAll('.share-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const url = btn.getAttribute('data-url')||location.href;
        const title = document.title || 'وینور اکسپرس';
        try{
          if (navigator.share) { await navigator.share({ title, url }); }
          else { await navigator.clipboard.writeText(url); toast('لینک کپی شد'); }
        }catch(_){ }
      }, { passive: true });
    });
  })();

  // Horizontal scroll controls for cards
  (function(){
    const track = document.getElementById('cardsTrack');
    const prev = document.getElementById('cardsPrev');
    const next = document.getElementById('cardsNext');
    if (!track || !prev || !next) return;
    function scrollByAmount(dir){
      const delta = Math.round((track.clientWidth || 300) * 0.9);
      const rtl = document.dir === 'rtl' || document.documentElement.getAttribute('dir') === 'rtl';
      const sign = (dir === 'next') ? (rtl ? -1 : 1) : (rtl ? 1 : -1);
      track.scrollBy({ left: sign * delta, behavior: 'smooth' });
    }
    prev.addEventListener('click', ()=>scrollByAmount('prev'));
    next.addEventListener('click', ()=>scrollByAmount('next'));
  })();

  // Convert dates to Persian (Jalali) format
  (function(){
    function fmt(dt){
      try{
        const d = new Date(String(dt||'').replace(' ','T'));
        if (isNaN(d.getTime())) return '';
        return d.toLocaleDateString('fa-IR', {
          timeZone: 'Asia/Tehran',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      }catch(_){ return ''; }
    }
    document.querySelectorAll('.jalali-dt[data-dt]').forEach(el=>{
      const raw = el.getAttribute('data-dt')||'';
      const formatted = fmt(raw);
      el.textContent = formatted || '—';
    });
  })();

  // Pull to Refresh - مینیمال و سریع (بدون آیکون، فقط اسکرول کارت‌ها)
  (function() {
    const container = document.getElementById('cardsTrack');
    if (!container) return;

    let startY = 0;
    let currentY = 0;
    let isPulling = false;
    let isRefreshing = false;
    const PULL_THRESHOLD = 60; // حداقل فاصله برای رفرش
    const MAX_PULL = 80; // حداکثر فاصله کشیدن

    function handleTouchStart(e) {
      // فقط اگر در بالای صفحه هستیم
      if (window.scrollY > 5 || isRefreshing) return;
      
      startY = e.touches[0].clientY;
      isPulling = false;
    }

    function handleTouchMove(e) {
      if (window.scrollY > 5 || isRefreshing) return;
      
      currentY = e.touches[0].clientY;
      const pullDistance = currentY - startY;

      if (pullDistance > 0 && pullDistance < MAX_PULL) {
        isPulling = true;
        e.preventDefault();
        
        // اسکرول کارت‌ها به پایین
        container.style.transform = `translateY(${Math.min(pullDistance * 0.3, 30)}px)`;
        container.style.transition = 'none';
      }
    }

    function handleTouchEnd(e) {
      if (!isPulling || isRefreshing) return;
      
      const pullDistance = currentY - startY;
      
      if (pullDistance >= PULL_THRESHOLD) {
        // شروع رفرش بدون reload صفحه
        isRefreshing = true;
        
        // انیمیشن smooth برای کارت‌ها
        container.style.transition = 'transform 0.3s ease-out';
        container.style.transform = 'translateY(0)';
        
        // رفرش محتوا بدون reload صفحه - استفاده از تابع performRefresh
        if (window.performRefresh) {
          window.performRefresh().then(() => {
            isRefreshing = false;
          }).catch(() => {
            isRefreshing = false;
          });
        } else {
          // Fallback: reload صفحه
          setTimeout(() => {
            window.location.reload();
          }, 200);
        }
      } else {
        // بازگشت به حالت اولیه با انیمیشن
        container.style.transition = 'transform 0.3s ease-out';
        container.style.transform = 'translateY(0)';
      }
      
      isPulling = false;
      startY = 0;
      currentY = 0;
    }

    // Event listeners
    document.addEventListener('touchstart', handleTouchStart, { passive: true });
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleTouchEnd, { passive: true });
  })();

  // تابع رفرش محتوا بدون reload صفحه
  async function performRefresh() {
    try {
      // رفرش صفحه با no-cache و timestamp برای جلوگیری از cache
      const url = new URL(window.location.href);
      url.searchParams.set('_refresh', Date.now().toString());
      
      const response = await fetch(url.toString(), {
        method: 'GET',
        headers: {
          'Accept': 'text/html',
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'X-Requested-With': 'XMLHttpRequest'
        },
        cache: 'no-store',
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // به‌روزرسانی کارت‌ها
        const newCardsTrack = doc.getElementById('cardsTrack');
        const currentCardsTrack = document.getElementById('cardsTrack');
        
        if (newCardsTrack && currentCardsTrack) {
          // به‌روزرسانی با fade effect
          currentCardsTrack.style.opacity = '0.7';
          requestAnimationFrame(() => {
            currentCardsTrack.innerHTML = newCardsTrack.innerHTML;
            currentCardsTrack.style.opacity = '1';
            currentCardsTrack.style.transition = 'opacity 0.3s ease';
            
            // دوباره attach کردن event listenerها و منطق‌ها
            reinitializeCards();
          });
        }
      }
    } catch (error) {
      console.error('Error refreshing content:', error);
      // در صورت خطا، reload کامل صفحه
      window.location.reload();
    }
  }
  
  // تابع برای re-initialize کردن کارت‌ها بعد از refresh
  function reinitializeCards() {
    // 1. Image/video loading logic
    document.querySelectorAll('[data-img-wrap]').forEach((wrap) => {
      const img = wrap.querySelector('[data-card-img]');
      const vid = wrap.querySelector('video');
      const loader = wrap.querySelector('.card-img-loading');
      
      function hideLoader(){
        if (loader){
          loader.classList.add('opacity-0','pointer-events-none');
          setTimeout(()=>loader.remove(),250);
        }
      }
      
      function showMedia(el){
        if (el) el.classList.remove('opacity-0');
        hideLoader();
      }

      if (img){
        if (img.complete && img.naturalWidth > 0) showMedia(img);
        else {
          img.addEventListener('load', ()=>showMedia(img), { once:true });
          img.addEventListener('error', hideLoader, { once:true });
        }
      }
      if (vid){
        const ready = () => showMedia(vid);
        if (vid.readyState >= 2) ready();
        else {
          vid.addEventListener('loadeddata', ready, { once:true });
          vid.addEventListener('error', hideLoader, { once:true });
        }
      }
      // fail-safe to avoid stuck loader
      setTimeout(hideLoader, 3000);
    });
    
    // 2. Card click handlers
    document.querySelectorAll('.express-card[data-href]').forEach((card) => {
      // حذف event listenerهای قبلی (clone node)
      const newCard = card.cloneNode(true);
      card.parentNode.replaceChild(newCard, card);
      
      newCard.addEventListener('click', () => {
        const href = newCard.getAttribute('data-href');
        if (href) window.location.assign(href);
      });
      newCard.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          const href = newCard.getAttribute('data-href');
          if (href) window.location.assign(href);
        }
      });
    });
    
    // 3. Jalali date conversion
    document.querySelectorAll('.jalali-dt[data-dt]').forEach(el=>{
      const raw = el.getAttribute('data-dt')||'';
      const formatted = fmt(raw);
      el.textContent = formatted || '—';
    });
    
    function fmt(dt){
      try{
        const d = new Date(String(dt||'').replace(' ','T'));
        if (isNaN(d.getTime())) return '';
        return d.toLocaleDateString('fa-IR', {
          timeZone: 'Asia/Tehran',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      }catch(_){ return ''; }
    }
  }
  
  window.performRefresh = performRefresh;
</script>
{% endblock %}


