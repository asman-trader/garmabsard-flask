{% extends 'express_partner/base.html' %}
{% block title %}یادداشت‌های خصوصی | وینور اکسپرس{% endblock %}
{% block content %}

<header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
  <div class="w-full px-4 h-14 flex items-center justify-between">
    <a href="{{ url_for('express_partner.dashboard') }}" class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="بازگشت">
      <i class="fas fa-arrow-right text-gray-600 dark:text-gray-400"></i>
    </a>
    <h1 class="text-sm font-bold text-gray-900 dark:text-white" data-tour="notes-header">یادداشت‌های خصوصی</h1>
    <button type="button" 
            data-tour="notes-add-button"
            onclick="document.getElementById('addNoteForm').classList.toggle('hidden')"
            class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400"
            aria-label="افزودن یادداشت">
      <i class="fas fa-plus text-sm"></i>
    </button>
  </div>
</header>

<div class="max-w-5xl mx-auto pt-4 px-4 pb-16">
  <!-- فرم افزودن یادداشت جدید -->
  <div id="addNoteForm" class="hidden mb-4">
    <form method="POST" action="{{ url_for('express_partner.add_note') }}" class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="next" value="{{ request.path }}">
      <div class="flex gap-2">
        <textarea 
          name="content" 
          rows="3" 
          placeholder="یادداشت خود را بنویسید..."
          data-tour="notes-input"
          class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
          required></textarea>
        <div class="flex flex-col gap-2">
          <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
            <i class="fas fa-check"></i>
          </button>
          <button type="button" 
                  onclick="document.getElementById('addNoteForm').classList.add('hidden'); document.querySelector('textarea[name=content]').value = '';"
                  class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-lg transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </form>
  </div>

  {% if notes and notes|length > 0 %}
    <div class="space-y-3" data-tour="notes-grid">
      {% for note in notes %}
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-gray-300 dark:hover:border-gray-600 transition-colors group">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
              <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap break-words">{{ note.get('content', note.get('text', '')) }}</p>
              {% if note.get('created_at') %}
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 jalali-dt" data-dt="{{ note.created_at }}"></p>
              {% endif %}
            </div>
            <button type="button"
                    onclick="showDeleteConfirm('deleteNoteForm{{ note.get('id') }}')"
                    class="opacity-0 group-hover:opacity-100 transition-opacity w-8 h-8 grid place-items-center rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-colors"
                    aria-label="حذف یادداشت">
              <i class="fas fa-trash text-xs"></i>
            </button>
            <form id="deleteNoteForm{{ note.get('id') }}" 
                  method="POST" 
                  action="{{ url_for('express_partner.delete_note', nid=note.get('id')) }}" 
                  class="hidden">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-12 text-center">
      <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-400 dark:text-gray-500">
        <i class="fas fa-sticky-note text-2xl"></i>
      </div>
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">یادداشتی وجود ندارد.</p>
      <button type="button" 
              onclick="document.getElementById('addNoteForm').classList.remove('hidden'); document.querySelector('textarea[name=content]')?.focus();"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
        <i class="fas fa-plus ml-1"></i>
        افزودن یادداشت جدید
      </button>
    </div>
  {% endif %}
</div>

<!-- مودال تایید حذف یادداشت -->
<div id="deleteNoteModal"
     class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="hideDeleteConfirm()"></div>
  <div class="relative w-full sm:max-w-md mx-auto bg-white dark:bg-gray-900 rounded-t-2xl sm:rounded-2xl shadow-xl overflow-hidden transform transition-all">
    <div class="p-4 sm:p-5">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-300 grid place-items-center flex-shrink-0">
          <i class="fas fa-trash text-lg"></i>
        </div>
        <div class="flex-1">
          <p class="text-base sm:text-lg font-bold text-gray-900 dark:text-white">حذف یادداشت</p>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">آیا مطمئن هستید که می‌خواهید این یادداشت را حذف کنید؟</p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">این عمل قابل بازگشت نیست.</p>
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button type="button"
                class="w-full py-3 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 font-semibold hover:bg-gray-50 dark:hover:bg-gray-800 transition"
                onclick="hideDeleteConfirm()">
          انصراف
        </button>
        <button type="button"
                class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-semibold transition"
                onclick="confirmDelete()">
          حذف
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // تبدیل تاریخ به شمسی
  (function(){
    function fmt(dt){
      try{
        const d = new Date(String(dt||'').replace(' ','T'));
        if (isNaN(d.getTime())) return '';
        return d.toLocaleDateString('fa-IR', { 
          timeZone: 'Asia/Tehran', 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }catch(_){ return ''; }
    }
    document.querySelectorAll('.jalali-dt[data-dt]').forEach(el=>{
      const raw = el.getAttribute('data-dt')||'';
      const formatted = fmt(raw);
      el.textContent = formatted || '—';
    });
  })();

  // مدیریت مودال حذف یادداشت
  (function() {
    const modal = document.getElementById('deleteNoteModal');
    
    function disableScroll() { 
      document.documentElement.classList.add('overflow-hidden'); 
      document.body.classList.add('overflow-hidden'); 
    }
    
    function enableScroll() { 
      document.documentElement.classList.remove('overflow-hidden'); 
      document.body.classList.remove('overflow-hidden'); 
    }
    
    window.showDeleteConfirm = function(formId) {
      if (!modal) return;
      modal.dataset.targetForm = formId || '';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      disableScroll();
    };
    
    window.hideDeleteConfirm = function() {
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      enableScroll();
    };
    
    window.confirmDelete = function() {
      if (!modal) return;
      const formId = modal.dataset.targetForm;
      const form = formId ? document.getElementById(formId) : null;
      if (form) {
        form.submit();
      }
      hideDeleteConfirm();
    };

    // بستن مودال با کلید Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
        hideDeleteConfirm();
      }
    });
  })();
</script>
{% endblock %}
