{% extends 'express_partner/base.html' %}
{% block title %}درخواست ثبت شد | وینور اکسپرس{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-950">
  
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800">
    <div class="px-4 h-14 flex items-center justify-center">
      <span class="text-sm font-bold text-gray-900 dark:text-white">وینور اکسپرس</span>
    </div>
  </header>

  <main class="px-4 py-8 max-w-lg mx-auto">
    
    <!-- Success Icon -->
    <div class="text-center mb-8">
      <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center animate-bounce-once">
        <i class="fas fa-check text-3xl text-emerald-600 dark:text-emerald-400"></i>
      </div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">درخواست ثبت شد</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
        {{ name or 'کاربر عزیز' }}، درخواست شما در صف بررسی قرار گرفت
      </p>
    </div>

    <!-- Status Card -->
    <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden mb-6">
      
      <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
          <i class="fas fa-clock text-amber-600 dark:text-amber-400"></i>
        </div>
        <div>
          <p class="font-semibold text-gray-900 dark:text-white text-sm">در انتظار بررسی</p>
          <p class="text-xs text-gray-500 dark:text-gray-400">حداکثر ۲۴ ساعت</p>
        </div>
      </div>

      <div class="p-4 space-y-3">
        <div class="flex items-start gap-3">
          <div class="w-6 h-6 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center flex-shrink-0 mt-0.5">
            <i class="fas fa-check text-xs text-emerald-600 dark:text-emerald-400"></i>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400">پیامک تأیید ارسال شد</p>
        </div>
        <div class="flex items-start gap-3">
          <div class="w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center flex-shrink-0 mt-0.5">
            <i class="fas fa-phone text-xs text-gray-400"></i>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400">تماس کارشناس جذب</p>
        </div>
        <div class="flex items-start gap-3">
          <div class="w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center flex-shrink-0 mt-0.5">
            <i class="fas fa-unlock text-xs text-gray-400"></i>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400">فعال‌سازی پنل همکار</p>
        </div>
      </div>

    </div>

    <!-- Info -->
    <div class="p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 mb-6">
      <p class="text-sm text-blue-700 dark:text-blue-300 text-center">
        <i class="fas fa-info-circle ml-2"></i>
        لطفاً پاسخگوی تماس باشید
      </p>
    </div>

    <!-- Actions -->
    <div class="space-y-3">
      <form method="post" action="{{ url_for('express_partner.apply_cancel') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                onclick="return confirm('آیا از لغو درخواست مطمئن هستید؟')"
                class="w-full py-3 rounded-xl border border-rose-200 dark:border-rose-800 text-rose-600 dark:text-rose-400 font-medium text-sm hover:bg-rose-50 dark:hover:bg-rose-900/20 transition">
          لغو درخواست
        </button>
      </form>
    </div>

  </main>
</div>

<style>
  @keyframes bounce-once {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  .animate-bounce-once {
    animation: bounce-once 0.5s ease-out;
  }
</style>

<script>
  // Pull-to-refresh functionality
  (function(){
    let startY = 0;
    let currentY = 0;
    let isPulling = false;
    let pullThreshold = 80; // Minimum distance to trigger refresh
    let refreshElement = null;
    let isRefreshing = false;

    function createRefreshElement() {
      const el = document.createElement('div');
      el.id = 'pull-refresh-indicator';
      el.className = 'fixed top-0 left-0 right-0 z-[100] bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 transform -translate-y-full transition-transform duration-300';
      el.innerHTML = `
        <div class="flex items-center justify-center py-4">
          <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400">
            <div class="w-6 h-6 border-2 border-gray-300 dark:border-gray-600 border-t-emerald-500 rounded-full animate-spin"></div>
            <span class="text-sm font-medium">در حال بررسی وضعیت...</span>
          </div>
        </div>
      `;
      document.body.appendChild(el);
      return el;
    }

    function showRefreshIndicator(progress) {
      if (!refreshElement) {
        refreshElement = createRefreshElement();
      }
      const translateY = Math.min(progress * 0.5, pullThreshold);
      refreshElement.style.transform = `translateY(${translateY - pullThreshold}px)`;

      // Change icon based on progress
      if (progress >= pullThreshold) {
        refreshElement.querySelector('.text-gray-600').className = 'flex items-center gap-3 text-emerald-600 dark:text-emerald-400';
        refreshElement.querySelector('span').textContent = 'رها کنید برای بررسی';
      } else {
        refreshElement.querySelector('.text-gray-600').className = 'flex items-center gap-3 text-gray-600 dark:text-gray-400';
        refreshElement.querySelector('span').textContent = 'کشیده و رها کنید';
      }
    }

    function hideRefreshIndicator() {
      if (refreshElement) {
        refreshElement.style.transform = 'translateY(-100%)';
        setTimeout(() => {
          if (refreshElement) {
            refreshElement.remove();
            refreshElement = null;
          }
        }, 300);
      }
    }

    async function checkPartnerStatus() {
      if (isRefreshing) return;
      isRefreshing = true;
      
      if (refreshElement) {
        refreshElement.querySelector('span').textContent = 'در حال بررسی وضعیت...';
        refreshElement.style.transform = 'translateY(0)';
      }

      try {
        const response = await fetch('{{ url_for("express_partner.check_status") }}', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success && data.approved) {
          // همکار تایید شده - هدایت به dashboard
          if (refreshElement) {
            refreshElement.querySelector('span').textContent = '✅ تایید شد! در حال انتقال...';
            refreshElement.querySelector('.text-gray-600').className = 'flex items-center gap-3 text-emerald-600 dark:text-emerald-400';
          }
          setTimeout(() => {
            window.location.href = data.redirect_url;
          }, 500);
        } else {
          // هنوز تایید نشده
          if (refreshElement) {
            refreshElement.querySelector('span').textContent = 'هنوز در انتظار بررسی';
            refreshElement.querySelector('.text-gray-600').className = 'flex items-center gap-3 text-gray-600 dark:text-gray-400';
          }
          setTimeout(() => {
            hideRefreshIndicator();
            isRefreshing = false;
          }, 1500);
        }
      } catch (error) {
        console.error('Error checking status:', error);
        if (refreshElement) {
          refreshElement.querySelector('span').textContent = 'خطا در بررسی وضعیت';
          refreshElement.querySelector('.text-gray-600').className = 'flex items-center gap-3 text-red-600 dark:text-red-400';
        }
        setTimeout(() => {
          hideRefreshIndicator();
          isRefreshing = false;
        }, 1500);
      }
    }

    document.addEventListener('touchstart', function(e) {
      if (window.scrollY === 0 && !isRefreshing) { // Only when at top of page
        startY = e.touches[0].clientY;
        isPulling = true;
      }
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
      if (isPulling && startY > 0 && !isRefreshing) {
        currentY = e.touches[0].clientY;
        const pullDistance = currentY - startY;

        if (pullDistance > 0) { // Only downward pulls
          e.preventDefault(); // Prevent default scrolling
          showRefreshIndicator(pullDistance);
        }
      }
    }, { passive: false });

    document.addEventListener('touchend', function(e) {
      if (isPulling && !isRefreshing) {
        const pullDistance = currentY - startY;

        if (pullDistance >= pullThreshold) {
          checkPartnerStatus();
        } else {
          hideRefreshIndicator();
        }

        startY = 0;
        currentY = 0;
        isPulling = false;
      }
    });
  })();
</script>
{% endblock %}
