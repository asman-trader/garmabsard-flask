{% extends 'express_partner/base.html' %}
{% block title %}اکسپلور | وینور اکسپرس{% endblock %}
{% block content %}

  <header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
    <div class="w-full px-4 py-2.5 flex items-center gap-2">
      <!-- دکمه برگشت -->
      <a href="{{ url_for('express_partner.dashboard') }}" class="w-9 h-9 flex-shrink-0 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="بازگشت">
        <i class="fas fa-arrow-right text-gray-600 dark:text-gray-400"></i>
      </a>
      <!-- باکس جستجو -->
      <form method="GET" action="{{ url_for('main.express_public_list') }}" class="flex-1 min-w-0" id="searchForm">
        <div class="relative w-full">
          <div class="flex items-center bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 focus-within:border-blue-500 dark:focus-within:border-blue-400 focus-within:shadow-sm transition-all">
            <input type="text"
                   name="q"
                   id="searchInput"
                   value="{{ search_query or '' }}"
                   placeholder="جستجو در فایل‌ها..."
                   autocomplete="off"
                   class="flex-1 bg-transparent border-0 outline-none text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 py-2.5 px-4 min-w-0">
            <div class="flex items-center gap-1 pr-2">
              {% if search_query %}
              <a href="{{ url_for('main.express_public_list') }}"
                 class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                 aria-label="پاک کردن جستجو">
                <i class="fas fa-times text-xs"></i>
              </a>
              {% endif %}
              <button type="submit"
                      class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                      aria-label="جستجو">
                <i class="fas fa-magnifying-glass text-sm"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </header>

<div class="max-w-5xl mx-auto pt-0 px-4 pb-16" id="exploreContainer">

  <!-- Pull to Refresh Indicator - مینیمال (زیر هدر) -->
  <div id="pullToRefreshIndicator" class="fixed left-1/2 transform -translate-x-1/2 z-30 pointer-events-none opacity-0 transition-all duration-200" style="top: 70px;">
    <div id="refreshIcon" class="w-8 h-8 rounded-full bg-white dark:bg-gray-800 shadow-lg flex items-center justify-center border border-gray-200 dark:border-gray-700">
      <i class="fas fa-sync-alt text-blue-600 dark:text-blue-400 text-sm"></i>
    </div>
  </div>

  <!-- Grid اینستاگرام - 3 ستون -->
  <div id="instagramGrid" class="instagram-grid mb-4">
    {% for land in lands %}
      {% set img = (land.images[0] if land.images and land.images[0] else None) %}
      {% set video = land.video %}
      <a href="{{ url_for('main.express_detail', code=land.code) }}" 
         class="instagram-item"
         data-code="{{ land.code }}">
        {% if video %}
          {% if "://" in (video|string) %}
            {% set video_src = video %}
          {% elif (video|string).startswith('/uploads/') %}
            {% set video_src = video %}
          {% elif (video|string).startswith('uploads/') %}
            {% set video_src = '/uploads/' + (video|string)[8:] %}
          {% elif not (video|string).startswith('/') %}
            {% set video_src = '/uploads/' + (video|string) %}
          {% else %}
            {% set video_src = video %}
          {% endif %}
          <video class="w-full h-full object-cover" autoplay muted loop playsinline>
            <source src="{{ video_src }}" type="video/mp4">
            {% if img %}
              {% if "://" in (img|string) %}
                {% set img_src = img %}
              {% elif (img|string).startswith('/uploads/') %}
                {% set img_src = img %}
              {% elif (img|string).startswith('uploads/') %}
                {% set img_src = '/uploads/' + (img|string)[8:] %}
              {% elif not (img|string).startswith('/') %}
                {% set img_src = '/uploads/' + (img|string) %}
              {% else %}
                {% set img_src = img %}
              {% endif %}
              <img src="{{ img_src }}" alt="{{ land.title or '' }}" loading="lazy">
            {% endif %}
          </video>
        {% elif img %}
          {% if "://" in (img|string) %}
            {% set img_src = img %}
          {% elif (img|string).startswith('/uploads/') %}
            {% set img_src = img %}
          {% elif (img|string).startswith('uploads/') %}
            {% set img_src = '/uploads/' + (img|string)[8:] %}
          {% elif not (img|string).startswith('/') %}
            {% set img_src = '/uploads/' + (img|string) %}
          {% else %}
            {% set img_src = img %}
          {% endif %}
          <img src="{{ img_src }}" alt="{{ land.title or '' }}" loading="lazy">
        {% else %}
          <div class="w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-image text-2xl text-gray-400 dark:text-gray-500"></i>
          </div>
        {% endif %}
      </a>
    {% endfor %}
  </div>

  <!-- Loading indicator برای infinite scroll -->
  <div id="loadingIndicator" class="loading-spinner hidden">
    <div></div>
  </div>

  <!-- Empty state -->
  <div id="emptyState" class="{% if lands and lands|length > 0 %}hidden{% endif %} bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-12 text-center mt-4">
    <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center mx-auto mb-4">
      <i class="fa-solid fa-star text-2xl text-gray-400 dark:text-gray-600"></i>
    </div>
    <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-2">هنوز فایل اکسپرس ثبت نشده</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400">به زودی فایل‌های جدید اضافه می‌شوند</p>
  </div>

  {% set bottom_nav_active = 'express' %}
  {% include 'express_partner/partials/bottom_nav.html' %}
</div>

<style>
  /* Instagram-style grid (بهینه شده برای رندر سریع) */
  .instagram-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    contain: layout style paint; /* بهینه‌سازی رندر */
    will-change: contents; /* بهینه‌سازی برای تغییرات آینده */
  }
  @media (max-width: 640px) {
    .instagram-grid {
      gap: 1px;
    }
  }
  .instagram-item {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    background: #000;
    cursor: pointer;
    contain: layout style paint; /* بهینه‌سازی رندر */
  }
  .instagram-item img,
  .instagram-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease; /* کاهش زمان transition */
    will-change: transform; /* بهینه‌سازی انیمیشن */
  }
  .instagram-item:hover img,
  .instagram-item:hover video {
    transform: scale(1.05);
  }
  .instagram-item::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0);
    transition: background 0.15s ease; /* کاهش زمان transition */
  }
  .instagram-item:hover::after {
    background: rgba(0, 0, 0, 0.1);
  }
  .loading-spinner {
    display: none !important; /* مخفی کردن loading indicator - لودینگ در پس‌زمینه */
    justify-content: center;
    align-items: center;
    padding: 2rem;
    contain: layout style; /* بهینه‌سازی رندر */
  }
  .loading-spinner div {
    width: 2rem;
    height: 2rem;
    border: 3px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    will-change: transform; /* بهینه‌سازی انیمیشن */
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Pull to Refresh Indicator - مینیمال */
  #pullToRefreshIndicator {
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  #refreshIcon {
    transition: transform 0.2s ease;
  }
  #refreshIcon.spinning {
    animation: spin 0.6s linear infinite;
  }
  
  /* بهینه‌سازی برای تصاویر */
  .instagram-item img {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
</style>

<script>
  // Pull to Refresh - مینیمال و سریع (سبک اینستاگرام)
  (function() {
    const container = document.getElementById('exploreContainer');
    const grid = document.getElementById('instagramGrid');
    const pullIndicator = document.getElementById('pullToRefreshIndicator');
    const refreshIcon = document.getElementById('refreshIcon');
    
    if (!container || !pullIndicator || !grid) return;

    let startY = 0;
    let currentY = 0;
    let isPulling = false;
    let isRefreshing = false;
    const PULL_THRESHOLD = 60; // کاهش threshold برای رفرش سریع‌تر
    const MAX_PULL = 80; // کاهش max pull برای مینیمال بودن

    function handleTouchStart(e) {
      // فقط اگر در بالای صفحه هستیم
      if (window.scrollY > 5 || isRefreshing) return;
      
      startY = e.touches[0].clientY;
      isPulling = false;
    }

    function handleTouchMove(e) {
      if (window.scrollY > 5 || isRefreshing) return;
      
      currentY = e.touches[0].clientY;
      const pullDistance = currentY - startY;

      if (pullDistance > 0 && pullDistance < MAX_PULL) {
        isPulling = true;
        e.preventDefault();
        
        // نمایش indicator با انیمیشن smooth
        const progress = Math.min(pullDistance / PULL_THRESHOLD, 1);
        const opacity = progress;
        const scale = 0.8 + (progress * 0.2); // از 0.8 تا 1.0
        const rotation = progress * 180; // چرخش آیکون
        
        pullIndicator.style.opacity = opacity.toString();
        pullIndicator.style.transform = `translate(-50%, ${70 + Math.min(pullDistance * 0.5, 40)}px)`;
        refreshIcon.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
        
        // اسکرول grid به پایین
        grid.style.transform = `translateY(${Math.min(pullDistance * 0.3, 30)}px)`;
        grid.style.transition = 'none';
        
        // شروع چرخش آیکون وقتی به threshold رسید
        if (pullDistance >= PULL_THRESHOLD) {
          refreshIcon.classList.add('spinning');
        } else {
          refreshIcon.classList.remove('spinning');
        }
      }
    }

    function handleTouchEnd(e) {
      if (!isPulling || isRefreshing) return;
      
      const pullDistance = currentY - startY;
      
      if (pullDistance >= PULL_THRESHOLD) {
        // شروع رفرش
        isRefreshing = true;
        refreshIcon.classList.add('spinning');
        
        // انیمیشن smooth برای grid
        grid.style.transition = 'transform 0.3s ease-out';
        grid.style.transform = 'translateY(0)';
        
        // رفرش سریع صفحه
        setTimeout(() => {
          window.location.reload();
        }, 200);
      } else {
        // بازگشت به حالت اولیه با انیمیشن
        resetPullIndicator();
      }
      
      isPulling = false;
      startY = 0;
      currentY = 0;
    }

    function resetPullIndicator() {
      pullIndicator.style.opacity = '0';
      pullIndicator.style.transform = 'translate(-50%, 70px)';
      refreshIcon.style.transform = 'scale(0.8) rotate(0deg)';
      refreshIcon.classList.remove('spinning');
      grid.style.transition = 'transform 0.3s ease-out';
      grid.style.transform = 'translateY(0)';
    }

    // Event listeners
    document.addEventListener('touchstart', handleTouchStart, { passive: true });
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleTouchEnd, { passive: true });
  })();

  // Infinite Scroll - سبک اینستاگرام
  (function() {
    const grid = document.getElementById('instagramGrid');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const searchInput = document.getElementById('searchInput');
    const emptyState = document.getElementById('emptyState');
    
    if (!grid) return;

    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    let searchQuery = '{{ search_query or '' }}';

    // تابع برای ساخت URL تصویر/ویدئو
    function getMediaUrl(media) {
      if (!media) return '';
      const mediaStr = String(media);
      if (mediaStr.includes('://')) return mediaStr;
      if (mediaStr.startsWith('/uploads/')) return mediaStr;
      if (mediaStr.startsWith('uploads/')) return '/uploads/' + mediaStr.substring(8);
      return '/uploads/' + mediaStr;
    }

    // تابع برای render کردن یک آیتم
    function renderItem(land) {
      const images = Array.isArray(land.images) ? land.images : (land.images ? [land.images] : []);
      const cover = images[0] || null;
      const video = land.video;
      const coverUrl = cover ? getMediaUrl(cover) : '';
      const videoUrl = video ? getMediaUrl(video) : '';
      const detailUrl = '/express/' + (land.code || '');
      const title = land.title || '';

      let mediaHtml = '';
      if (videoUrl) {
        mediaHtml = `
          <video class="w-full h-full object-cover" autoplay muted loop playsinline>
            <source src="${videoUrl}" type="video/mp4">
            ${coverUrl ? `<img src="${coverUrl}" alt="${title}" loading="lazy">` : ''}
          </video>
        `;
      } else if (coverUrl) {
        mediaHtml = `<img src="${coverUrl}" alt="${title}" loading="lazy">`;
      } else {
        mediaHtml = `
          <div class="w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-image text-2xl text-gray-400 dark:text-gray-500"></i>
          </div>
        `;
      }

      return `
        <a href="/express/${land.code || ''}" 
           class="instagram-item"
           data-code="${land.code || ''}">
          ${mediaHtml}
        </a>
      `;
    }

    // تابع برای بارگذاری صفحه بعد (بهینه شده)
    async function loadNextPage() {
      if (isLoading || !hasMore) return;

      isLoading = true;
      // loadingIndicator.classList.remove('hidden'); // مخفی نگه داشتن loading indicator
      currentPage++;

      try {
        const url = `/api/express-list?page=${currentPage}&per_page=30${searchQuery ? '&q=' + encodeURIComponent(searchQuery) : ''}`;
        const response = await fetch(url, {
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          }
        });
        const data = await response.json();

        if (data.success && data.lands && data.lands.length > 0) {
          // استفاده از requestAnimationFrame برای رندر نرم
          requestAnimationFrame(() => {
            const gridItemsHtml = data.lands.map(renderItem).join('');
            grid.insertAdjacentHTML('beforeend', gridItemsHtml);
            
            // Lazy load images بعد از اضافه شدن به DOM
            const newImages = grid.querySelectorAll('img[loading="lazy"]');
            if ('loading' in HTMLImageElement.prototype) {
              newImages.forEach(img => {
                if (img.dataset.src) {
                  img.src = img.dataset.src;
                  delete img.dataset.src;
                }
              });
            }
          });
          
          hasMore = data.pagination.has_next;
          // loadingIndicator.classList.add('hidden'); // loading indicator همیشه مخفی است
        } else {
          hasMore = false;
          // loadingIndicator.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error loading next page:', error);
        hasMore = false;
        // loadingIndicator.classList.add('hidden');
      } finally {
        isLoading = false;
      }
    }

    // Intersection Observer برای infinite scroll (بهینه شده)
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && hasMore && !isLoading) {
          // استفاده از requestIdleCallback برای بارگذاری در زمان بیکاری
          if ('requestIdleCallback' in window) {
            requestIdleCallback(() => loadNextPage(), { timeout: 1000 });
          } else {
            setTimeout(() => loadNextPage(), 0);
          }
        }
      });
    }, {
      rootMargin: '300px'  // افزایش برای prefetch زودتر
    });

    // مشاهده loading indicator
    if (loadingIndicator) {
      observer.observe(loadingIndicator);
    }

    // جستجوی زنده
    if (searchInput) {
      let searchTimeout = null;

      function debounce(func, wait) {
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(searchTimeout);
            func(...args);
          };
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(later, wait);
        };
      }

      async function performSearch(query) {
        searchQuery = query;
        currentPage = 1;
        hasMore = true;
        isLoading = true;
        
        // استفاده از requestAnimationFrame برای رندر نرم
        requestAnimationFrame(() => {
          grid.innerHTML = '';
        });
        // loadingIndicator.classList.remove('hidden'); // loading indicator همیشه مخفی است
        emptyState.classList.add('hidden');

        try {
          const url = `/api/express-list?page=1&per_page=30${query ? '&q=' + encodeURIComponent(query) : ''}`;
          const response = await fetch(url, {
            headers: {
              'Accept': 'application/json',
              'Cache-Control': 'no-cache'
            }
          });
          const data = await response.json();

          if (data.success && data.lands && data.lands.length > 0) {
            requestAnimationFrame(() => {
              const gridItemsHtml = data.lands.map(renderItem).join('');
              grid.innerHTML = gridItemsHtml;
              
              // Lazy load images
              const images = grid.querySelectorAll('img[loading="lazy"]');
              if ('loading' in HTMLImageElement.prototype) {
                images.forEach(img => {
                  if (img.dataset.src) {
                    img.src = img.dataset.src;
                    delete img.dataset.src;
                  }
                });
              }
            });
            emptyState.classList.add('hidden');
            hasMore = data.pagination.has_next;
            // loadingIndicator.classList.add('hidden'); // loading indicator همیشه مخفی است
          } else {
            requestAnimationFrame(() => {
              grid.innerHTML = '';
            });
            emptyState.classList.remove('hidden');
            // loadingIndicator.classList.add('hidden');
            hasMore = false;
          }
        } catch (error) {
          console.error('Search error:', error);
          requestAnimationFrame(() => {
            grid.innerHTML = '';
          });
          emptyState.classList.remove('hidden');
          // loadingIndicator.classList.add('hidden');
          hasMore = false;
        } finally {
          isLoading = false;
        }
      }

      searchInput.addEventListener('input', debounce(function(e) {
        const query = e.target.value.trim();
        if (query.length >= 2) {
          performSearch(query);
        } else if (query.length === 0) {
          // استفاده از replace برای جلوگیری از اضافه شدن به history
          window.location.replace('{{ url_for("main.express_public_list") }}');
        }
      }, 250));  // کاهش delay برای پاسخ سریع‌تر

      document.getElementById('searchForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (query.length >= 2) {
          performSearch(query);
        }
      });
    }

    // Initialize - بررسی اینکه آیا صفحه بعدی وجود دارد
    {% if pagination and pagination.pages > pagination.page %}
      hasMore = true;
      // Prefetch صفحه بعدی برای سرعت بیشتر
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
          const searchParam = '{{ search_query or '' }}';
          const nextPageUrl = `/api/express-list?page=2&per_page=30${searchParam ? '&q=' + encodeURIComponent(searchParam) : ''}`;
          fetch(nextPageUrl, { method: 'GET', headers: { 'Accept': 'application/json' } })
            .then(r => r.json())
            .catch(() => {}); // نادیده گرفتن خطا در prefetch
        }, { timeout: 2000 });
      }
    {% else %}
      hasMore = false;
      // loadingIndicator.classList.add('hidden'); // loading indicator همیشه مخفی است
    {% endif %}
  })();
</script>

{% endblock %}

