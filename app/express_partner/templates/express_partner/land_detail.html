{% extends 'express_partner/base.html' %}
{% block title %}جزئیات فایل اکسپرس{% endblock %}
{% block content %}
<div class="min-h-screen bg-white dark:bg-gray-950 pb-16">
  
  <!-- Header مینیمال به سبک دیوار -->
  <header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
    <div class="w-full px-3 sm:px-4 h-12 flex items-center justify-between gap-2">
      <!-- Back button -->
      <a href="{{ url_for('express_partner.dashboard') }}" 
         class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" 
         aria-label="بازگشت">
        <i class="fas fa-arrow-right text-gray-700 dark:text-gray-200 text-sm"></i>
      </a>

      <!-- Center title + optional code -->
      <div class="flex-1 min-w-0 flex flex-col items-center">
        <h1 class="text-sm font-semibold text-gray-900 dark:text-white truncate max-w-full">
          {{ land.title or 'جزئیات فایل اکسپرس' }}
        </h1>
        {% if land.code %}
        <span class="text-[11px] text-gray-500 dark:text-gray-400 font-mono">
          کد {{ land.code }}
        </span>
        {% endif %}
      </div>

      <!-- right spacer -->
      <div class="w-9 h-9"></div>
    </div>
  </header>

  <!-- گالری بالای صفحه - سبک دیوار (تمام‌عرض) -->
  <div data-tour="land-image" class="relative mb-4 bg-black/5 dark:bg-black/20 w-full">
    {% set images = land.images or [] %}
    {% set video = land.video %}
    {% set has_video = video and video.strip() %}
    {% set total_items = (1 if has_video else 0) + images|length %}
    {% set primary_image = images[0] if images else None %}

    <div class="w-full pt-0 pb-4">
      {% if has_video or primary_image %}
        {# uploads/* باید از /uploads/ سرو شود (نه /static/) #}
        {% if video and ("://" in (video|string)) %}
          {% set video_src = video %}
        {% elif video and (video|string).startswith('/uploads/') %}
          {% set video_src = video %}
        {% elif video and (video|string).startswith('uploads/') %}
          {% set video_src = '/uploads/' + (video|string)[8:] %}
        {% elif video and not (video|string).startswith('/') %}
          {# مسیرهای تاریخ‌محور مثل 2025/08/... هم از /uploads/ سرو می‌شوند #}
          {% set video_src = '/uploads/' + (video|string) %}
        {% else %}
          {% set video_src = video %}
        {% endif %}
        <div id="landGallery"
             class="aspect-[4/3] bg-gray-100 dark:bg-gray-900 relative overflow-hidden rounded-none sm:rounded-xl select-none">

          <!-- Loading overlay -->
          <div id="landMediaLoading"
               class="absolute inset-0 z-40 flex items-center justify-center bg-black/35 backdrop-blur-[1px] text-white transition-opacity duration-200 opacity-0 pointer-events-none"
               aria-hidden="true">
            <div class="flex flex-col items-center gap-2">
              <div class="w-10 h-10 rounded-full border-2 border-white/40 border-t-white animate-spin"></div>
              <div class="text-xs font-medium drop-shadow">در حال بارگذاری…</div>
            </div>
          </div>
          
          {# اگر ویدیو وجود دارد، اولین اسلاید ویدیو است #}
          {% if has_video %}
          <video id="landVideo"
                 class="w-full h-full object-cover block"
                 controls
                 onclick="event.stopPropagation()">
            <source src="{{ video_src }}" type="video/mp4">
            مرورگر شما از پخش ویدیو پشتیبانی نمی‌کند.
          </video>
          {% endif %}

          {# تصویر اصلی (اگر ویدیو وجود دارد، دومین اسلاید است) #}
          {% if primary_image %}
            {% if "://" in (primary_image|string) %}
              {% set image_src = primary_image %}
            {% elif (primary_image|string).startswith('/uploads/') %}
              {% set image_src = primary_image %}
            {% elif (primary_image|string).startswith('uploads/') %}
              {% set image_src = '/uploads/' + (primary_image|string)[8:] %}
            {% elif not (primary_image|string).startswith('/') %}
              {% set image_src = '/uploads/' + (primary_image|string) %}
            {% else %}
              {% set image_src = primary_image %}
            {% endif %}
            <img id="landMainImage"
                 src="{{ image_src }}"
                 alt="{{ land.title }}"
                 class="w-full h-full object-cover cursor-pointer {% if has_video %}hidden{% else %}block{% endif %}"
                 onclick="openLightbox(this.src)">
          {% endif %}

          {# دکمه‌های قبلی/بعدی فقط اگر بیش از یک آیتم وجود داشته باشد #}
          {% if total_items > 1 %}
          <button type="button"
                  id="landPrev"
                  class="absolute inset-y-0 right-0 w-12 flex items-center justify-center bg-gradient-to-l from-black/35 to-transparent text-white text-lg focus:outline-none active:scale-95 z-30">
            <i class="fas fa-chevron-right drop-shadow"></i>
          </button>
          <button type="button"
                  id="landNext"
                  class="absolute inset-y-0 left-0 w-12 flex items-center justify-center bg-gradient-to-r from-black/35 to-transparent text-white text-lg focus:outline-none active:scale-95 z-30">
            <i class="fas fa-chevron-left drop-shadow"></i>
          </button>

          <!-- نقطه‌های وضعیت اسلاید -->
          <div class="absolute bottom-2 inset-x-0 flex items-center justify-center gap-1.5 z-30">
            {% if has_video %}
            <span class="land-dot w-1.5 h-1.5 rounded-full bg-white/40 active"></span>
            {% endif %}
            {% for _ in images %}
            <span class="land-dot w-1.5 h-1.5 rounded-full bg-white/40 {% if not has_video and loop.first %}active{% endif %}"></span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      {% else %}
        <div class="aspect-[4/3] bg-gray-100 dark:bg-gray-900 flex items-center justify-center rounded-xl">
          <i class="fas fa-image text-4xl text-gray-300 dark:text-gray-700"></i>
        </div>
      {% endif %}
    </div>
    
    {% if land._assignment_status == 'in_transaction' %}
    <div class="absolute top-3 left-5">
      <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-[11px] font-semibold bg-orange-500 text-white shadow-sm">
        در حال معامله
      </span>
    </div>
    {% endif %}
  </div>

  <div class="max-w-4xl mx-auto px-4 space-y-4">
    
    <!-- عنوان و اطلاعات اصلی - سبک دیوار -->
    <div data-tour="land-info" class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">{{ land.title or '—' }}</h2>
      <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600 dark:text-gray-400">
        {% if land.location or land.city %}
        <span class="flex items-center gap-1.5">
          <i class="fas fa-map-marker-alt text-xs"></i>
          {{ land.location or land.city }}
        </span>
        {% endif %}
        {% if land.size %}
        <span class="flex items-center gap-1.5">
          <i class="fas fa-ruler-combined text-xs"></i>
          {{ land.size }} متر
        </span>
        {% endif %}
        {% if land.category %}
        <span class="flex items-center gap-1.5">
          <i class="fas fa-tag text-xs"></i>
          {{ land.category }}
        </span>
        {% endif %}
      </div>
    </div>

    <!-- قیمت و پورسانت - سبک دیوار -->
    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
      <div class="space-y-3">
        <div class="flex items-center justify-between pb-3 border-b border-gray-100 dark:border-gray-800">
          <span class="text-sm text-gray-600 dark:text-gray-400">قیمت کل</span>
          <span class="text-lg font-bold text-gray-900 dark:text-white">{{ (land.price_total or 0)|toman }}</span>
        </div>
        {% if land.price_per_meter %}
        <div class="flex items-center justify-between pb-3 border-b border-gray-100 dark:border-gray-800">
          <span class="text-sm text-gray-600 dark:text-gray-400">قیمت در متر</span>
          <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.price_per_meter|toman }}</span>
        </div>
        {% endif %}
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600 dark:text-gray-400">پورسانت شما</span>
            {% if land._commission_pct %}
            <span class="text-xs text-gray-500 dark:text-gray-400">({{ land._commission_pct }}%)</span>
            {% endif %}
          </div>
          <span class="text-lg font-bold text-gray-900 dark:text-white">{{ (land._commission_amount or 0)|toman }}</span>
        </div>
      </div>
    </div>

    <!-- توضیحات - سبک دیوار -->
    {% if land.description %}
    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
      <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">توضیحات</h3>
      <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line">{{ land.description }}</p>
    </div>
    {% endif %}

    <!-- جزئیات فایل - سبک دیوار -->
    {% if land.rooms or land.floor or land.year_built or land.docs_status or land.features %}
    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
      <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">جزئیات</h3>
      <div class="space-y-2">
        {% if land.payment_method %}
        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
          <span class="text-sm text-gray-600 dark:text-gray-400">نحوه پرداخت</span>
          <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.payment_method }}</span>
        </div>
        {% if land.payment_method == 'اقساطی' and land.payment_terms and land.payment_terms|length > 0 %}
        <div class="py-2">
          <span class="text-sm text-gray-600 dark:text-gray-400 block mb-2">جزئیات اقساط</span>
          <div class="space-y-2">
            {% for t in land.payment_terms %}
              <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">{{ (t.months or 0) }} ماهه</span>
                <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ (t.amount or 0)|toman }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        {% endif %}
        {% if land.rooms %}
        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
          <span class="text-sm text-gray-600 dark:text-gray-400">اتاق</span>
          <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.rooms }}</span>
        </div>
        {% endif %}
        {% if land.floor %}
        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
          <span class="text-sm text-gray-600 dark:text-gray-400">طبقه</span>
          <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.floor }}</span>
        </div>
        {% endif %}
        {% if land.year_built %}
        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
          <span class="text-sm text-gray-600 dark:text-gray-400">سال ساخت</span>
          <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.year_built }}</span>
        </div>
        {% endif %}
        {% if land.docs_status %}
        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-800">
          <span class="text-sm text-gray-600 dark:text-gray-400">وضعیت سند</span>
          <span class="text-sm font-medium text-gray-900 dark:text-white">{{ land.docs_status }}</span>
        </div>
        {% endif %}
        {% if land.features %}
        <div class="py-2">
          <span class="text-sm text-gray-600 dark:text-gray-400 block mb-1">امکانات</span>
          <span class="text-sm text-gray-900 dark:text-white">{{ land.features }}</span>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- موقعیت دقیق - سبک دیوار -->
    {% if land.latitude and land.longitude %}
    <button type="button" onclick="openLocationModal()"
            class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex items-center justify-between hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
          <i class="fas fa-map-marker-alt text-gray-600 dark:text-gray-400"></i>
        </div>
        <div class="text-right">
          <div class="text-sm font-semibold text-gray-900 dark:text-white">موقعیت دقیق</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">باز کردن در نقشه</div>
        </div>
      </div>
      <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500"></i>
    </button>

    <!-- مودال موقعیت -->
    <div id="locationModal" class="fixed inset-0 z-[100] hidden">
      <div class="absolute inset-0 bg-black/60" onclick="closeLocationModal()"></div>
      <div class="absolute bottom-0 inset-x-0 bg-white dark:bg-gray-900 rounded-t-3xl p-6 space-y-4 animate-slide-up">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white">باز کردن با</h3>
          <button onclick="closeLocationModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
            <i class="fas fa-times text-gray-500"></i>
          </button>
        </div>
        <a href="https://www.google.com/maps?q={{ land.latitude }},{{ land.longitude }}" target="_blank" rel="noopener"
           class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
          <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
            <i class="fab fa-google text-red-500 text-xl"></i>
        </div>
          <div class="font-semibold text-gray-900 dark:text-white">Google Maps</div>
          </a>
        <a href="https://waze.com/ul?ll={{ land.latitude }},{{ land.longitude }}&navigate=yes" target="_blank" rel="noopener"
           class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
          <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
            <i class="fas fa-route text-blue-500 text-xl"></i>
          </div>
          <div class="font-semibold text-gray-900 dark:text-white">Waze</div>
          </a>
          <a href="geo:{{ land.latitude }},{{ land.longitude }}" 
           class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
          <div class="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
            <i class="fas fa-location-arrow text-purple-500 text-xl"></i>
          </div>
          <div class="font-semibold text-gray-900 dark:text-white">مسیریاب پیش‌فرض</div>
          </a>
      </div>
    </div>
    {% endif %}

    <!-- مشاهده عمومی و تماس - به سبک بلوک موقعیت -->
    {% set public_link = share_url %}
    {% if public_link %}
    <a href="{{ public_link }}"
       target="_blank" rel="noopener"
       class="w-full mt-3 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex items-center justify-between hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
          <i class="far fa-eye text-gray-600 dark:text-gray-300"></i>
        </div>
        <div class="text-right">
          <div class="text-sm font-semibold text-gray-900 dark:text-white">صفحه عمومی فایل</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">نمایش لینک برای مشتری</div>
        </div>
      </div>
      <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500"></i>
    </a>
    {% endif %}

    <!-- تماس - فقط دسکتاپ -->
    <div class="mt-3 hidden sm:block">
      {% if land.owner_phone or land.vinor_contact %}
      <a href="tel:{{ land.owner_phone or land.vinor_contact }}" 
         data-tour="contact-btn"
         class="w-full flex items-center justify-between px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-emerald-50 dark:bg-emerald-900/30 flex items-center justify-center">
            <i class="fas fa-phone text-emerald-600 dark:text-emerald-300"></i>
          </div>
          <div class="text-right">
            <div class="text-sm font-semibold text-gray-900 dark:text-white">تماس با مالک/پشتیبان</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">فقط برای استفاده شما</div>
          </div>
        </div>
      </a>
      {% else %}
      <div class="w-full flex items-center justify-between px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 opacity-60">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
            <i class="fas fa-phone text-gray-400"></i>
          </div>
          <div class="text-right">
            <div class="text-sm font-semibold text-gray-500 dark:text-gray-400">اطلاعات تماس ثبت نشده</div>
            <div class="text-xs text-gray-400">لطفاً با پشتیبانی وینور هماهنگ کنید</div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- دکمه معامله - جداگانه -->
    {% set _st = (land._assignment_status|default('active')) %}
    {% if _st != 'sold' %}
    <form data-tour="transaction-btn" method="POST" action="{{ url_for('express_partner.mark_in_transaction', code=land.code) }}" class="hidden sm:block">
      {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      {% if _st == 'in_transaction' %}
        <button type="submit" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-emerald-200 dark:border-emerald-800 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 transition-colors">
          <i class="fas fa-check-circle"></i>
          <span class="text-sm font-medium">رفع معامله</span>
        </button>
      {% else %}
        <button type="submit" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-orange-200 dark:border-orange-800 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/30 transition-colors">
          <i class="fas fa-handshake"></i>
          <span class="text-sm font-medium">معامله</span>
        </button>
      {% endif %}
    </form>
    {% else %}
    <div class="hidden sm:flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400">
      <i class="fas fa-check-double"></i>
      <span class="text-sm font-medium">فروخته شد</span>
    </div>
    {% endif %}

    <!-- فضای خالی برای دکمه ثابت پایین در موبایل -->
    <div class="h-20 sm:hidden"></div>

  </div>
</div>

<!-- دکمه‌های ثابت پایین (فقط موبایل) -->
{% set contact_phone = land.owner_phone or land.vinor_contact %}
{% set _st = (land._assignment_status|default('active')) %}
<div class="fixed bottom-0 inset-x-0 p-4 bg-white/80 dark:bg-gray-950/80 backdrop-blur-md border-t border-gray-200 dark:border-gray-800 sm:hidden z-50">
  <div class="grid grid-cols-2 gap-3">
    {% if contact_phone %}
    <button type="button" onclick="openContactModal()"
       class="flex items-center justify-center gap-2 py-3 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-bold transition-colors">
      <i class="fas fa-phone"></i>
      تماس
    </button>
    {% else %}
    <div class="flex items-center justify-center gap-2 py-3 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-500 opacity-50">
      <i class="fas fa-phone"></i>
      تماس
    </div>
    {% endif %}
    
    <!-- دکمه معامله در موبایل -->
    {% if _st != 'sold' %}
    <form method="POST" action="{{ url_for('express_partner.mark_in_transaction', code=land.code) }}" class="h-full">
      {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      {% if _st == 'in_transaction' %}
        <button type="submit" class="w-full h-full flex items-center justify-center gap-2 py-3 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-bold transition-colors">
          <i class="fas fa-check-circle"></i>
          رفع معامله
        </button>
      {% else %}
        <button type="submit" class="w-full h-full flex items-center justify-center gap-2 py-3 rounded-xl bg-orange-500 hover:bg-orange-600 text-white font-bold transition-colors">
          <i class="fas fa-handshake"></i>
          معامله
        </button>
      {% endif %}
    </form>
    {% else %}
    <div class="flex items-center justify-center gap-2 py-3 rounded-xl bg-green-500 text-white font-bold">
      <i class="fas fa-check-double"></i>
      فروخته شد
    </div>
    {% endif %}
  </div>
</div>

<!-- مودال تماس -->
<div id="contactModal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 bg-black/60" onclick="closeContactModal()"></div>
  <div class="absolute bottom-0 inset-x-0 bg-white dark:bg-gray-900 rounded-t-3xl p-6 space-y-4 animate-slide-up">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white">انتخاب روش تماس</h3>
      <button onclick="closeContactModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
        <i class="fas fa-times text-gray-500"></i>
      </button>
    </div>
    <a href="tel:{{ contact_phone }}" 
       class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
      <div class="w-12 h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
        <i class="fas fa-phone text-emerald-600 dark:text-emerald-400 text-lg"></i>
      </div>
      <div>
        <div class="font-semibold text-gray-900 dark:text-white">تماس مستقیم</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">{{ contact_phone }}</div>
      </div>
    </a>
    <a href="https://wa.me/98{{ contact_phone[1:] if contact_phone.startswith('0') else contact_phone }}?text={{ 'سلام، در مورد آگهی ' ~ (land.title or land.code) ~ ' سوال داشتم.' | urlencode }}" 
       target="_blank" rel="noopener"
       class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
      <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
        <i class="fab fa-whatsapp text-green-600 dark:text-green-400 text-xl"></i>
      </div>
      <div>
        <div class="font-semibold text-gray-900 dark:text-white">واتس‌اپ</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">ارسال پیام در واتس‌اپ</div>
      </div>
    </a>
  </div>
</div>

<style>
  @keyframes slide-up {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }
  .animate-slide-up { animation: slide-up 0.3s ease-out; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // کپی لینک
    document.querySelectorAll('.copy-btn, .copy-btn-secondary').forEach(function(btn) {
      btn.addEventListener('click', async function () {
        const url = btn.getAttribute('data-url') || btn.dataset.url || window.location.href;
        try {
          await navigator.clipboard.writeText(url);
          const icon = btn.querySelector('i');
          if (icon) {
            const originalClass = icon.className;
            icon.className = 'fas fa-check text-green-500';
            setTimeout(() => {
              icon.className = originalClass;
            }, 1500);
          }
        } catch (err) {
          console.error(err);
        }
      });
    });
    
    // کپی متن (عنوان و توضیحات)
    document.querySelectorAll('.copy-text-btn').forEach(function(btn) {
      btn.addEventListener('click', async function () {
        const text = btn.getAttribute('data-text') || '';
        try {
          await navigator.clipboard.writeText(text);
          const icon = btn.querySelector('i');
          if (icon) {
            const originalClass = icon.className;
            icon.className = 'fas fa-check text-green-500';
            setTimeout(() => {
              icon.className = originalClass;
            }, 1500);
          }
        } catch (err) {
          console.error(err);
        }
      });
    });
    
    // اشتراک
    document.querySelectorAll('.share-btn').forEach(function(btn) {
      btn.addEventListener('click', async function () {
        const url = btn.dataset.url || window.location.href;
        try {
          if (navigator.share) {
            await navigator.share({ 
              title: document.title, 
              url: url
            });
          } else {
            await navigator.clipboard.writeText(url);
            const icon = btn.querySelector('i');
            if (icon) {
              const originalClass = icon.className;
              icon.className = 'fas fa-check text-green-500';
              setTimeout(() => {
                icon.className = originalClass;
              }, 1500);
            }
          }
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error(err);
          }
        }
    });

    // اسلایدر تصاویر بالای صفحه به سبک دیوار
    (function(){
      const galleryEl = document.getElementById('landGallery');
      if (!galleryEl) return;
      const mainImg = document.getElementById('landMainImage');
      const mainVideo = document.getElementById('landVideo');
      const loadingEl = document.getElementById('landMediaLoading');
      const hasVideo = !!mainVideo;
      
      const images = [
        {% for img in images %}
          "{% if '://' in (img|string) %}{{ img }}{% elif (img|string).startswith('/uploads/') %}{{ img }}{% elif (img|string).startswith('uploads/') %}/uploads/{{ (img|string)[8:] }}{% elif not (img|string).startswith('/') %}/uploads/{{ img }}{% else %}{{ img }}{% endif %}"{% if not loop.last %},{% endif %}
        {% endfor %}
      ];
      
      {% if video %}
      const videoSrc = "{% if '://' in (video|string) %}{{ video }}{% elif (video|string).startswith('/uploads/') %}{{ video }}{% elif (video|string).startswith('uploads/') %}/uploads/{{ (video|string)[8:] }}{% elif video and not (video|string).startswith('/') %}/uploads/{{ video }}{% else %}{{ video }}{% endif %}";
      {% else %}
      const videoSrc = null;
      {% endif %}
      
      const totalItems = (hasVideo ? 1 : 0) + images.length;
      if (totalItems <= 1) return;

      let currentIndex = 0;
      const dots = Array.from(document.querySelectorAll('.land-dot'));
      const prevBtn = document.getElementById('landPrev');
      const nextBtn = document.getElementById('landNext');
      let loadingFallbackTimer = null;

      function setLoading(isLoading) {
        if (!loadingEl) return;
        if (loadingFallbackTimer) {
          clearTimeout(loadingFallbackTimer);
          loadingFallbackTimer = null;
        }
        if (isLoading) {
          loadingEl.classList.remove('opacity-0', 'pointer-events-none');
          loadingEl.classList.add('opacity-100');
          loadingEl.setAttribute('aria-hidden', 'false');
          // Fail-safe: اگر load/canplay به هر دلیل نیامد، لودینگ گیر نکند
          loadingFallbackTimer = setTimeout(() => {
            setLoading(false);
          }, 5000);
        } else {
          loadingEl.classList.add('opacity-0', 'pointer-events-none');
          loadingEl.classList.remove('opacity-100');
          loadingEl.setAttribute('aria-hidden', 'true');
        }
      }

      function waitForImageLoad() {
        if (!mainImg) return setLoading(false);
        // اگر از کش لود شده بود
        if (mainImg.complete && mainImg.naturalWidth > 0) {
          return setLoading(false);
        }
        const done = () => setLoading(false);
        mainImg.addEventListener('load', done, { once: true });
        mainImg.addEventListener('error', done, { once: true });
      }

      function waitForVideoLoad() {
        if (!mainVideo) return setLoading(false);
        // readyState >= 2 یعنی اطلاعات کافی برای پخش وجود دارد
        if (mainVideo.readyState >= 2) {
          return setLoading(false);
        }
        const done = () => setLoading(false);
        mainVideo.addEventListener('loadeddata', done, { once: true });
        mainVideo.addEventListener('canplay', done, { once: true });
        mainVideo.addEventListener('error', done, { once: true });
      }

      function updateDots() {
        if (!dots.length) return;
        dots.forEach((d, idx) => {
          if (idx === currentIndex) {
            d.classList.remove('bg-white/40');
            d.classList.add('bg-white');
            d.classList.add('active');
          } else {
            d.classList.remove('bg-white');
            d.classList.remove('active');
            d.classList.add('bg-white/40');
          }
        });
      }

      function showItem(idx) {
        currentIndex = (idx + totalItems) % totalItems;
        setLoading(true);
        
        if (hasVideo && currentIndex === 0) {
          // نمایش ویدیو
          if (mainVideo) {
            mainVideo.classList.remove('hidden');
            mainVideo.classList.add('block');
          }
          if (mainImg) {
            mainImg.classList.add('hidden');
            mainImg.classList.remove('block');
          }
          waitForVideoLoad();
        } else {
          // نمایش تصویر
          const imgIndex = hasVideo ? currentIndex - 1 : currentIndex;
          if (mainImg && images[imgIndex]) {
            mainImg.src = images[imgIndex];
            mainImg.classList.remove('hidden');
            mainImg.classList.add('block');
          }
          if (mainVideo) {
            mainVideo.classList.add('hidden');
            mainVideo.classList.remove('block');
            mainVideo.pause();
          }
          waitForImageLoad();
        }
        updateDots();
      }

      prevBtn && prevBtn.addEventListener('click', function(e){
        e.preventDefault();
        showItem(currentIndex - 1);
      }, { passive: false });
      nextBtn && nextBtn.addEventListener('click', function(e){
        e.preventDefault();
        showItem(currentIndex + 1);
      }, { passive: false });

      // لمس/درگ برای اسلاید (موبایل + دسکتاپ)
      // نکته: روی بعضی مرورگرها touchmove همیشه fire نمی‌شود؛ بنابراین در touchend هم changedTouches را می‌خوانیم.
      let touchStartX = null;
      let touchEndX = null;
      let isPointerDown = false;
      const SWIPE_THRESHOLD = 40;

      function handleSwipe(dx) {
        if (Math.abs(dx) <= SWIPE_THRESHOLD) return;
        if (dx < 0) {
          // کشیدن به چپ → بعدی
          showItem(currentIndex + 1);
        } else {
          // کشیدن به راست → قبلی
          showItem(currentIndex - 1);
        }
      }

      function bindSwipeListeners(el) {
        if (!el) return;

        // Touch (mobile)
        el.addEventListener('touchstart', function(e){
          const t = e.touches && e.touches[0];
          if (!t) return;
          touchStartX = t.clientX;
          touchEndX = null;
        }, { passive: true });

        el.addEventListener('touchmove', function(e){
          const t = e.touches && e.touches[0];
          if (!t || touchStartX === null) return;
          touchEndX = t.clientX;
        }, { passive: true });

        el.addEventListener('touchend', function(e){
          if (touchStartX === null) return;
          const t = (e.changedTouches && e.changedTouches[0]) || null;
          const endX = (touchEndX !== null) ? touchEndX : (t ? t.clientX : null);
          if (endX === null) return;
          const dx = endX - touchStartX;
          handleSwipe(dx);
          touchStartX = null;
          touchEndX = null;
        }, { passive: true });

        // Pointer (desktop drag)
        el.addEventListener('pointerdown', function(e){
          // فقط دکمه چپ موس
          if (e.pointerType === 'mouse' && e.button !== 0) return;
          isPointerDown = true;
          touchStartX = e.clientX;
          touchEndX = null;
          try { el.setPointerCapture(e.pointerId); } catch(_) {}
        });
        el.addEventListener('pointermove', function(e){
          if (!isPointerDown || touchStartX === null) return;
          touchEndX = e.clientX;
        });
        el.addEventListener('pointerup', function(e){
          if (!isPointerDown || touchStartX === null) return;
          isPointerDown = false;
          const endX = (touchEndX !== null) ? touchEndX : e.clientX;
          const dx = endX - touchStartX;
          handleSwipe(dx);
          touchStartX = null;
          touchEndX = null;
          try { el.releasePointerCapture(e.pointerId); } catch(_) {}
        });
        el.addEventListener('pointercancel', function(){
          isPointerDown = false;
          touchStartX = null;
          touchEndX = null;
        });
      }

      // روی کانتینر + خود مدیا هم bind کن (برای مرورگرهایی که event را bubble نمی‌کنند)
      bindSwipeListeners(galleryEl);
      bindSwipeListeners(mainImg);
      bindSwipeListeners(mainVideo);

      // وضعیت اولیه نقطه‌ها
      updateDots();

      // لودینگ اولیه (آیتم اول)
      setLoading(true);
      if (hasVideo && currentIndex === 0) {
        waitForVideoLoad();
      } else {
        waitForImageLoad();
      }
    })();
    });

  });
  
  // مودال تماس
  function openContactModal() {
    document.getElementById('contactModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  function closeContactModal() {
    document.getElementById('contactModal').classList.add('hidden');
    document.body.style.overflow = '';
  }
  
  // مودال موقعیت
  function openLocationModal() {
    document.getElementById('locationModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  function closeLocationModal() {
    document.getElementById('locationModal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  // لایت‌باکس تصویر
  function openLightbox(src) {
    const lightbox = document.createElement('div');
    lightbox.className = 'fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4';
    lightbox.onclick = () => lightbox.remove();
    lightbox.innerHTML = `
      <button class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/10 text-white text-xl hover:bg-white/20 transition-colors" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
      <img src="${src}" class="max-w-full max-h-full object-contain rounded-lg" onclick="event.stopPropagation()">
      <a href="${src}" download class="absolute bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20 transition-colors flex items-center gap-2" onclick="event.stopPropagation()">
        <i class="fas fa-download"></i>
        دانلود تصویر
      </a>
    `;
    document.body.appendChild(lightbox);
  }
</script>
{% endblock %}

