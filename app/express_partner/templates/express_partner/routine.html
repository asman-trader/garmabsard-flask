{% extends 'express_partner/base.html' %}
{% block title %}روتین روزانه | ثبت پیشرفت{% endblock %}
{% block content %}

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-b border-gray-200 dark:border-gray-800 w-full">
    <div class="w-full px-4 h-14 flex items-center justify-between">
      <a href="{{ url_for('express_partner.dashboard') }}" class="w-9 h-9 grid place-items-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="بازگشت">
        <i class="fas fa-arrow-right text-gray-600 dark:text-gray-400"></i>
      </a>
      <h1 class="text-sm font-bold text-gray-900 dark:text-white">روتین و آمار فعالیت</h1>
      <div class="w-9"></div>
    </div>
  </header>

<div class="max-w-4xl mx-auto pt-0 px-3 sm:px-4 pb-16">

  <!-- Intro badge -->
  <div class="mt-4">
    <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-200 text-xs font-semibold border border-blue-100 dark:border-blue-800">
      <i class="fa-solid fa-chart-line"></i>
      روتین ثبت و پایش فعالیت (آمار محلی)
    </div>
  </div>

  <!-- Progress / Checkable steps -->
  <div class="mt-4">
    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-4 sm:p-5 shadow-sm space-y-3">
      <div class="flex items-center justify-between text-xs font-semibold text-gray-700 dark:text-gray-300">
        <span>پیشرفت امروز</span>
        <span id="routineProgressText">۰ / ۳</span>
      </div>
      <div class="h-2 w-full bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
        <div id="routineProgressBar" class="h-2 bg-emerald-500 rounded-full w-0 transition-[width] duration-200"></div>
      </div>
      <div class="pt-2 space-y-2">
        <label class="flex items-center gap-3 text-sm text-gray-800 dark:text-gray-100">
          <input type="checkbox" class="routine-step accent-emerald-500 w-4 h-4" data-step="1">
          <span class="flex-1">بازاریابی</span>
        </label>
        <label class="flex items-center gap-3 text-sm text-gray-800 dark:text-gray-100">
          <input type="checkbox" class="routine-step accent-amber-500 w-4 h-4" data-step="2">
          <span class="flex-1">بازدید</span>
        </label>
        <label class="flex items-center gap-3 text-sm text-gray-800 dark:text-gray-100">
          <input type="checkbox" class="routine-step accent-indigo-500 w-4 h-4" data-step="3">
          <span class="flex-1">معامله</span>
        </label>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400">
        تیک‌ها محلی‌اند؛ اما انجام امروز در سرور ذخیره می‌شود تا تقویم ماه کامل نمایش داده شود.
      </p>
      <div class="flex items-center justify-end gap-2 text-xs">
        <a href="{{ url_for('express_partner.training') }}" class="text-blue-600 dark:text-blue-300 hover:underline">مشاهده آموزش ۳ مرحله‌ای</a>
      </div>
    </div>
  </div>

  <!-- Monthly calendar -->
  <div class="mt-4">
    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl p-4 sm:p-5 shadow-sm space-y-3">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center gap-2">
          <button id="routinePrev" type="button" class="w-8 h-8 grid place-items-center rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
            <i class="fas fa-chevron-right text-gray-600 dark:text-gray-300 text-sm"></i>
          </button>
          <div>
            <div class="text-sm font-semibold text-gray-900 dark:text-white">تقویم انجام روتین</div>
            <div id="routineMonthLabel" class="text-xs text-gray-500 dark:text-gray-400 mt-1"></div>
          </div>
          <button id="routineNext" type="button" class="w-8 h-8 grid place-items-center rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
            <i class="fas fa-chevron-left text-gray-600 dark:text-gray-300 text-sm"></i>
          </button>
        </div>
      </div>
      <div class="grid grid-cols-7 gap-1 text-[11px] sm:text-xs text-center text-gray-600 dark:text-gray-300">
        <div class="py-1 font-semibold">ش</div>
        <div class="py-1 font-semibold">ی</div>
        <div class="py-1 font-semibold">د</div>
        <div class="py-1 font-semibold">س</div>
        <div class="py-1 font-semibold">چ</div>
        <div class="py-1 font-semibold">پ</div>
        <div class="py-1 font-semibold">ج</div>
      </div>
      <div id="routineCalendar" class="grid grid-cols-7 gap-1 sm:gap-1.5"></div>
      <p id="routineStatus" class="text-xs text-gray-500 dark:text-gray-400"></p>
    </div>
  </div>

  <!-- Note about stats -->
  <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
    برای ثبت آمار رسمی و گزارش‌گیری، بخش‌های داشبورد و بازدید/معامله را تکمیل کنید. این روتین صرفاً چک‌لیست شخصی و تقویم حضور شماست.
  </div>

  {% set bottom_nav_active = 'routine' %}
  {% include 'express_partner/partials/bottom_nav.html' %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const steps = Array.from(document.querySelectorAll('.routine-step'));
    const progressBar = document.getElementById('routineProgressBar');
    const progressText = document.getElementById('routineProgressText');
    const resetBtn = document.getElementById('routineReset');
    const calendarEl = document.getElementById('routineCalendar');
    const statusEl = document.getElementById('routineStatus');
    const monthLabelEl = document.getElementById('routineMonthLabel');
    const storageKey = 'vinor_routine_steps_v1';
    const csrfToken = "{{ csrf_token() }}";

    const today = new Date();
    function toLocalISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    const todayISO = toLocalISODate(today);
    let viewDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    let monthDaysDone = [];
    let monthSteps = {};
    let autoMarkedToday = false;

    function loadState() {
      try {
        const saved = JSON.parse(localStorage.getItem(storageKey) || '[]');
        if (Array.isArray(saved) && saved.length) {
          steps.forEach(cb => { cb.checked = saved.includes(cb.dataset.step); });
        } else {
          fetch(`/express/partner/routine/steps/detail?date=${todayISO}`, { credentials: 'same-origin' })
            .then(r => r.json()).then(d => {
              if (d?.success && Array.isArray(d.detail)) {
                steps.forEach(cb => { cb.checked = d.detail.includes(cb.dataset.step); });
                saveState();
                syncProgress();
              }
            }).catch(()=>{});
        }
      } catch (_) {}
    }

    function saveState() {
      const checked = steps.filter(cb => cb.checked).map(cb => cb.dataset.step);
      try { localStorage.setItem(storageKey, JSON.stringify(checked)); } catch (_) {}
    }

    function syncProgress() {
      const total = steps.length || 1;
      const done = steps.filter(cb => cb.checked).length;
      const percent = Math.round((done / total) * 100);
      if (progressBar) progressBar.style.width = percent + '%';
      if (progressText) progressText.textContent = `${done} / ${total}`;
      maybeAutoMark(done, total);
    }

    function resetAll(){
      steps.forEach(cb => cb.checked = false);
      saveState();
      syncProgress();
    }

    // --- Jalali (Persian) helpers ---
    const faPersian = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { year: 'numeric', month: 'long', day: 'numeric' });
    const faPersianYM = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { year: 'numeric', month: 'long' });
    const faPersianDay = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { day: 'numeric' });
    const faPersianYMParts = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { year: 'numeric', month: 'numeric' });

    function toLatinDigits(s){
      return String(s).replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
    }
    function getPersianParts(date){
      // returns { y, m, d } as numbers for the Persian calendar for given Gregorian Date
      const y = Number(toLatinDigits(faPersianYMParts.formatToParts(date).find(p=>p.type==='year')?.value || '0'));
      const m = Number(toLatinDigits(faPersianYMParts.formatToParts(date).find(p=>p.type==='month')?.value || '0'));
      const d = Number(toLatinDigits(faPersianDay.format(date)));
      return { y, m, d };
    }
    function getCurrentPersianMonthRange(baseDate){
      // Find first and last Gregorian Date that belong to current Persian month of baseDate
      const base = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
      const { y:py, m:pm } = getPersianParts(base);
      // find first day
      let first = new Date(base);
      for (let i=0; i<40; i++){
        const parts = getPersianParts(first);
        if (parts.y === py && parts.m === pm && parts.d === 1) break;
        first.setDate(first.getDate()-1);
      }
      // collect days until month changes
      const dates = [];
      let cursor = new Date(first);
      for (let i=0; i<40; i++){
        const parts = getPersianParts(cursor);
        if (parts.y !== py || parts.m !== pm) break;
        dates.push(new Date(cursor));
        cursor.setDate(cursor.getDate()+1);
      }
      return dates;
    }

    function renderCalendar(daysList){
      if (!calendarEl) return;
      calendarEl.innerHTML = '';

      const monthDates = getCurrentPersianMonthRange(viewDate);
      if (monthDates.length === 0) return;
      const firstDay = monthDates[0].getDay(); // 0=Sun ... 6=Sat
      const startOffset = (firstDay === 6) ? 0 : (firstDay + 1); // Saturday-first grid

      for (let i = 0; i < startOffset; i++) {
        const placeholder = document.createElement('div');
        placeholder.className = 'aspect-square rounded-xl';
        calendarEl.appendChild(placeholder);
      }

      const doneSet = new Set(daysList || []);
      for (const gd of monthDates) {
        const iso = toLocalISODate(gd);
        const parts = getPersianParts(gd);
        const isDone = doneSet.has(iso);
        const isToday = iso === todayISO;
        const stepCount = monthSteps[iso] || 0;
        const div = document.createElement('div');
        div.className = [
          'aspect-square rounded-xl border text-center flex flex-col items-center justify-center text-xs sm:text-sm transition',
          isDone ? 'bg-emerald-100 dark:bg-emerald-900/40 border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-200 font-semibold' : 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200',
          isToday ? 'ring-2 ring-blue-400 dark:ring-blue-500' : ''
        ].join(' ');
        const dayLabel = document.createElement('div');
        dayLabel.textContent = faPersianDay.format(gd); // Persian day number
        div.appendChild(dayLabel);
        if (stepCount > 0) {
          const dots = document.createElement('div');
          dots.className = 'flex items-center justify-center gap-[3px] mt-1';
          const maxDots = Math.min(stepCount, 3);
          for (let i = 0; i < maxDots; i++) {
            const dot = document.createElement('span');
            dot.className = 'w-1.5 h-1.5 rounded-full bg-emerald-500 dark:bg-emerald-300';
            dots.appendChild(dot);
          }
          div.appendChild(dots);
        }
        calendarEl.appendChild(div);
      }

      if (monthLabelEl) {
        monthLabelEl.textContent = faPersianYM.format(monthDates[0]);
      }
    }

    function setStatus(msg, tone = 'muted') {
      if (!statusEl) return;
      const toneClass = tone === 'success'
        ? 'text-emerald-600 dark:text-emerald-300'
        : tone === 'error'
          ? 'text-rose-600 dark:text-rose-300'
          : 'text-gray-500 dark:text-gray-400';
      statusEl.className = `text-xs ${toneClass}`;
      statusEl.textContent = msg || '';
    }

    async function fetchMonthDays(){
      try {
        // Determine Gregorian month(s) covering current Persian month of the viewDate
        const monthDates = getCurrentPersianMonthRange(viewDate);
        if (monthDates.length === 0) { renderCalendar([]); return; }
        const startISO = toLocalISODate(monthDates[0]).slice(0,7);
        const endISO = toLocalISODate(monthDates[monthDates.length-1]).slice(0,7);
        const months = startISO === endISO ? [startISO] : [startISO, endISO];

        // Fetch data for required month(s) and merge
        const results = await Promise.all(months.map(m => fetch(`/express/partner/routine/data?month=${m}`, { credentials: 'same-origin' }).then(r=>r.json()).catch(()=>null)));
        monthDaysDone = [];
        monthSteps = {};
        for (const d of results) {
          if (d && d.success) {
            if (Array.isArray(d.days)) monthDaysDone.push(...d.days);
            if (d.steps && typeof d.steps === 'object') {
              Object.entries(d.steps).forEach(([k,v]) => { monthSteps[k] = v; });
            }
          }
        }
        // Keep only days that fall within the current Persian month
        const monthISOSet = new Set(monthDates.map(d => toLocalISODate(d)));
        monthDaysDone = monthDaysDone.filter(x => monthISOSet.has(x));

        autoMarkedToday = monthDaysDone.includes(todayISO);
        renderCalendar(monthDaysDone);
        setStatus('روزهای انجام‌شده از سرور بارگذاری شد.', 'muted');
        if (autoMarkedToday) {
          steps.forEach(cb => cb.checked = true);
          saveState();
          syncProgress();
          setStatus('امروز قبلاً ثبت شده و تیک‌ها همگام شد.', 'success');
        }
      } catch (err) {
        renderCalendar([]);
        setStatus('خطا در ارتباط با سرور برای دریافت تقویم.', 'error');
      }
    }

    // Month navigation (Persian month prev/next approximated by stepping to first/last then ±1 day)
    function gotoPrevMonth(){
      const dates = getCurrentPersianMonthRange(viewDate);
      if (!dates.length) return;
      const prevAnchor = new Date(dates[0]); // first day of current Persian month
      prevAnchor.setDate(prevAnchor.getDate() - 1); // go to previous month
      viewDate = prevAnchor;
      fetchMonthDays();
    }
    function gotoNextMonth(){
      const dates = getCurrentPersianMonthRange(viewDate);
      if (!dates.length) return;
      const nextAnchor = new Date(dates[dates.length - 1]); // last day of current Persian month
      nextAnchor.setDate(nextAnchor.getDate() + 1); // go to next month
      viewDate = nextAnchor;
      fetchMonthDays();
    }
    document.getElementById('routinePrev')?.addEventListener('click', gotoPrevMonth, { passive: true });
    document.getElementById('routineNext')?.addEventListener('click', gotoNextMonth, { passive: true });

    async function sendStepCount(count){
      try{
        const res = await fetch('/express/partner/routine/steps', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          credentials: 'same-origin',
          body: JSON.stringify({ count, detail: steps.filter(cb => cb.checked).map(cb => cb.dataset.step) })
        });
        const data = await res.json().catch(()=>null);
        if (data?.success && data.date) {
          monthSteps = data.steps || monthSteps;
          monthDaysDone = Array.isArray(data.days) ? data.days : monthDaysDone;
          renderCalendar(monthDaysDone);
          setStatus('پیشرفت ثبت شد.', 'success');
        }
      }catch(_){}
    }

    function maybeAutoMark(done, total){
      if (done === total && !autoMarkedToday) {
        autoMarkedToday = true;
        setStatus('امروز ثبت شد (خودکار).', 'success');
      }
      if (done < total && !monthDaysDone.includes(toLocalISODate(today))) {
        autoMarkedToday = false;
      }
      // به‌روزرسانی فوری UI تقویم بر اساس تعداد تیک‌ها
      if (done > 0) {
        if (!monthDaysDone.includes(todayISO)) {
          monthDaysDone.push(todayISO);
        }
      } else {
        monthDaysDone = monthDaysDone.filter(d => d !== todayISO);
      }

      // همواره تعداد تیک‌ها را به سرور بفرست تا روی تقویم نقطه بگیرد (بلادرنگ)
      const todayKey = toLocalISODate(today);
      monthSteps[todayKey] = done;
      renderCalendar(monthDaysDone);
      sendStepCount(done);
    }

    loadState();
    syncProgress();
    fetchMonthDays();

    steps.forEach(cb => {
      cb.addEventListener('change', () => {
        saveState();
        syncProgress();
      });
    });

    resetBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      resetAll();
    });

  });
</script>
{% endblock %}

