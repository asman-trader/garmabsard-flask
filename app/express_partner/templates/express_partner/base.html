<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>{% block title %}وینور اکسپرس | پنل همکاران{% endblock %}</title>

  {# --- Favicon & PWA (Separate from main VINOR) --- #}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  {# مانیفست جداگانه برای Express Partner #}
  <link rel="manifest" href="{{ url_for('express_partner.manifest') }}">
  <meta name="theme-color" content="#7c3aed">

  <script>
    (function(){
      try {
        var root = document.documentElement;
        var saved = localStorage.getItem('theme');
        if (!saved) {
          var prefersDark = false;
          try { prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; } catch(_) {}
          saved = prefersDark ? 'dark' : 'light';
          try { localStorage.setItem('theme', saved); } catch(_) {}
        }
        if (saved === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
        var meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute('content', root.classList.contains('dark') ? '#7c3aed' : '#7c3aed');
      } catch(_) {}
    })();
  </script>

  {# iOS PWA #}
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">

  {# --- CSS/Fonts --- #}
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = { darkMode: 'class' };
  </script>
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="font" href="{{ url_for('static', filename='vendor/fontawesome/webfonts/fa-solid-900.woff2') }}" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="{{ url_for('static', filename='vendor/fontawesome/webfonts/fa-regular-400.woff2') }}" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="{{ url_for('static', filename='vendor/fontawesome/webfonts/fa-brands-400.woff2') }}" type="font/woff2" crossorigin>
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome/css/all.min.css') }}" onerror="this.parentNode.removeChild(this)">
  <link rel="stylesheet" href="{{ url_for('static', filename='fonts/vazirmatn.css') }}" onerror="this.parentNode.removeChild(this)">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <style>
    html,body{overscroll-behavior-y:contain;overscroll-behavior-x:auto}
    body{font-family:'Vazirmatn',sans-serif;scroll-behavior:smooth}
    *, *::before, *::after{
      -webkit-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
    }
    {% block styles %}{% endblock %}
  </style>

  {% block head %}{% endblock %}
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-100">

  {% block content %}{% endblock %}

  <script>
    (function(){
      // ثبت Service Worker جداگانه برای Express Partner
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('{{ url_for("express_partner.service_worker") }}', { scope: '/express/partner/' })
          .then(async (reg) => {
            try {
              await navigator.serviceWorker.ready;
              const sw = navigator.serviceWorker.controller || (await (async()=>{
                try { await reg.update(); } catch {} 
                return navigator.serviceWorker.controller;
              })());
              
              // Warmup Express Partner routes
              const urls = [
                '/express/partner/login',
                '/express/partner/dashboard',
                '/express/partner/profile',
                '/express/partner/commissions',
                '/express/partner/notes',
                '/express/partner/apply'
              ];
              
              if (sw) sw.postMessage({ type: 'VINOR_WARMUP', urls });
            } catch {} 
          })
          .catch(()=>{});
      }

      // --- PWA Install Hooks (Express Partner) ---
      let expressPartnerDeferredPrompt;

      // Handle PWA install prompt
      window.addEventListener('beforeinstallprompt', (e) => {
        // Only handle if it's for Express Partner scope
        const url = new URL(window.location.href);
        if (url.pathname.startsWith('/express/partner/')) {
          e.preventDefault();
          expressPartnerDeferredPrompt = e;

          // Show install button containers when PWA is available
          const installContainer = document.getElementById('expressPartnerInstall');
          const installMobileContainer = document.getElementById('expressPartnerInstallMobile');
          
          if (installContainer) installContainer.classList.remove('hidden');
          if (installMobileContainer) installMobileContainer.classList.remove('hidden');
        }
      });

      // Handle successful installation
      window.addEventListener('appinstalled', (evt) => {
        console.log('Express Partner PWA was installed successfully');
        expressPartnerDeferredPrompt = null;

        // Update install buttons after successful install
        const installBtn = document.getElementById('expressPartnerInstallBtn');
        const installMobileBtn = document.getElementById('expressPartnerInstallMobileBtn');
        
        if (installBtn) {
          installBtn.textContent = 'نصب شد';
          installBtn.disabled = true;
          installBtn.classList.add('opacity-50');
        }
        if (installMobileBtn) {
          installMobileBtn.textContent = 'نصب شد';
          installMobileBtn.disabled = true;
          installMobileBtn.classList.add('opacity-50');
        }
      });

      // PWA Install Button Handler
      document.addEventListener('DOMContentLoaded', function() {
        const installBtn = document.getElementById('expressPartnerInstallBtn');
        const installMobileBtn = document.getElementById('expressPartnerInstallMobileBtn');
        
        function handleInstall() {
          if (expressPartnerDeferredPrompt) {
            expressPartnerDeferredPrompt.prompt();
            expressPartnerDeferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === 'accepted') {
                console.log('User accepted Express Partner PWA install');
              } else {
                console.log('User dismissed Express Partner PWA install');
              }
              expressPartnerDeferredPrompt = null;
            }).catch((error) => {
              console.error('Error during Express Partner PWA install:', error);
            });
          } else {
            // Fallback for browsers that don't support beforeinstallprompt
            alert('برای نصب اپلیکیشن وینور اکسپرس، از مرورگر کروم، اج یا فایرفاکس استفاده کنید.');
          }
        }

        if (installBtn) {
          installBtn.addEventListener('click', handleInstall);
        }
        if (installMobileBtn) {
          installMobileBtn.addEventListener('click', handleInstall);
        }
      });

      // Dark mode toggle
      document.addEventListener('DOMContentLoaded', function() {
        const darkToggle = document.getElementById('darkToggle');
        if (darkToggle) {
          darkToggle.addEventListener('click', function() {
            const root = document.documentElement;
            root.classList.toggle('dark');
            const isDark = root.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            const meta = document.querySelector('meta[name="theme-color"]');
            if (meta) meta.setAttribute('content', isDark ? '#7c3aed' : '#7c3aed');
          });
        }
      });
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>

